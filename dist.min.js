(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.authenticate=authenticate;var _app=_interopRequireDefault(require("firebase/app"));require("firebase/auth");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function authenticate(){var provider=new _app["default"].auth.GoogleAuthProvider;_app["default"].auth().signInWithPopup(provider).then(function(result){console.log("Authenticated user")})["catch"](function(error){var errorCode=error.code;var errorMessage=error.message;console.error("Could not authenticate user. "+errorCode+": "+errorMessage)})}},{"firebase/app":163,"firebase/auth":164}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Database=void 0;var firebase=_interopRequireWildcard(require("firebase/app"));require("firebase/firestore");function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):{};if(desc.get||desc.set){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}}newObj["default"]=obj;return newObj}}var Database=function(){var FIREBASE_CONFIG={apiKey:"AIzaSyA2UDNIbN1dQ_RS_Pc2Y0LfZa7_l8i3-Rc",authDomain:"nan-tech-displacement-database.firebaseapp.com",databaseURL:"https://nan-tech-displacement-database.firebaseio.com",projectId:"nan-tech-displacement-database",storageBucket:"nan-tech-displacement-database.appspot.com",messagingSenderId:"126845761108"};firebase.initializeApp(FIREBASE_CONFIG);var instance;function createInstance(){instance=firebase.firestore()}return{getInstance:function getInstance(){if(instance===undefined)createInstance();return instance}}}();exports.Database=Database},{"firebase/app":163,"firebase/firestore":165}],3:[function(require,module,exports){"use strict";var _instance=require("../database/instance");var Resources=_interopRequireWildcard(require("../resource/resource"));var Authenticate=_interopRequireWildcard(require("../auth/auth"));function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):{};if(desc.get||desc.set){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}}newObj["default"]=obj;return newObj}}window.DLib={Database:_instance.Database,Resources:Resources,Authenticate:Authenticate.authenticate}},{"../auth/auth":1,"../database/instance":2,"../resource/resource":4}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.get=get;exports.getResourceByID=getResourceByID;exports.submitResource=submitResource;exports.deleteResourceByID=deleteResourceByID;exports.Resource=exports.AreaSpecifier=void 0;var _instance=require("../database/instance");var _geodesy=_interopRequireDefault(require("geodesy"));var _algoliasearch=_interopRequireDefault(require("algoliasearch"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}var algoliaClient=(0,_algoliasearch["default"])("ZNAVVMB14R","fb6bae007584585719e79b195fc57ab2");var algoliaResourceIndex=algoliaClient.initIndex("name");var AreaSpecifier=function(){function AreaSpecifier(latitude,longitude,distance){_classCallCheck(this,AreaSpecifier);this.latitude=latitude;this.longitude=longitude;this.distance=distance}_createClass(AreaSpecifier,null,[{key:"fromGeopoint",value:function fromGeopoint(location,distance){return new this(location.latitude,location.longitude,distance)}}]);return AreaSpecifier}();exports.AreaSpecifier=AreaSpecifier;var Resource=function(){_createClass(Resource,[{key:"searilize",value:function searilize(){var searilization={};Object.assign(searilization,{name:this.name,tags:this.tags});if(location!==undefined){Object.assign(searilization,{location:this.location})}return searilization}}]);function Resource(name,tags,location,detailsRef){_classCallCheck(this,Resource);this.name=name;this.tags=tags;this.detailsRef=detailsRef;if(!location||location.hasOwnProperty("geopoint")||location.hasOwnProperty("address")){this.location=location}else{if(location!=undefined){throw new Error("Cannot create a resource with an invalid location. Location object lacks either a geopoint or address property")}}}_createClass(Resource,[{key:"details",value:function details(){var _this=this;if(this.__details!==undefined){return new Promise(function(resolve){resolve(_this.__details)})}if(this.detailsRef===undefined)return new Promise(function(resolve){resolve(undefined)});return this.detailsRef.get().then(function(detailsSnapshot){return new Promise(function(resolve,reject){if(detailsSnapshot==undefined){reject("Could not retrieve details document.")}else{_this.__details=detailsSnapshot.data();return _this.__details}})})}},{key:"clearDetailsCache",value:function clearDetailsCache(){this.__details=undefined}},{key:"setDetails",value:function setDetails(details){if(this.__details!=undefined&&this.__details.hasOwnProperty("listing-reference")&&!details.hasOwnProperty("listing-reference")){Object.assign(details,{"listing-reference":this.__details["listing-reference"]})}this.__details=details}},{key:"isWithin",value:function isWithin(areaSpecifier){if(!location||!location.hasOwnProperty("latitude")||!location.hasOwnProperty("longitude")){throw"Resource is missing lat/lon!"}var areaCenterPoint=new _geodesy["default"].LatLonSpherical(areaSpecifier.latitude,areaSpecifier.longitude);var resourceLocation=new _geodesy["default"].LatLonSpherical(location["latitude"],location["longitude"]);return areaSpecifier.distance<=areaCenterPoint.distanceTo(resourceLocation)}}]);return Resource}();exports.Resource=Resource;function get(query){if(query==undefined){query={}}if(query.text!=undefined){return algoliaResourceIndex.search(query.text).then(function(content){var list={};content.hits.forEach(function(hit){var detailsRef=_instance.Database.getInstance().doc(hit["details-reference"]._path.segments.join("/"));var resource=new Resource(hit["name"],hit["tags"],hit["location"],detailsRef);if(query.tags!=undefined){if(!query.tags.every(function(queryTag){return resource.tags.includes(queryTag)}))return}if(query.area!=undefined){if(!resource.isWithin(query.area))return}list[hit.objectID]=resource});return list})}else if(query.area!=undefined){var areaCenterPoint=new _geodesy["default"].LatLonSpherical(query.area.latitude,query.area.longitude);var northmostLatitude=areaCenterPoint.destinationPoint(query.area.distance,0).lat;var southmostLatitude=areaCenterPoint.destinationPoint(query.area.distance,180).lat;var eastmostLongitude=areaCenterPoint.destinationPoint(query.area.distance,90).lon;var westmostLongitude=areaCenterPoint.destinationPoint(query.area.distance,270).lon;return _instance.Database.getInstance().collection("resource").where("location.latitude",">=",southmostLatitude).where("location.latitude","<=",northmostLatitude).get().then(function(snapshot){var list={};snapshot.forEach(function(document){var documentData=document.data();if(documentData["location"]["longitude"]>=westmostLongitude&&documentData["location"]["longitude"]<=eastmostLongitude){if(list){var resource=new Resource(documentData["name"],documentData["tags"],documentData["location"],documentData["details-reference"]);if(query.tags&&!query.tags.every(function(tag){return list[document.id].tags.includes(tag)})){return}list[document.id]=resource;var resourceLatLon=new _geodesy["default"].LatLonSpherical(documentData["location"]["latitude"],documentData["location"]["longitude"]);var distance=areaCenterPoint.distanceTo(resourceLatLon);if(list[document.id].location)Object.assign(list[document.id].location,{distance:distance})}}});return list})}else{return _instance.Database.getInstance().collection("resource").get().then(function(snapshot){var list={};snapshot.forEach(function(document){if(list){var documentData=document.data();var resource=new Resource(documentData["name"],documentData["tags"],documentData["location"],documentData["details-reference"]);if(query.tags&&!query.tags.every(function(tag){return resource.tags.includes(tag)})){return}list[document.id]=resource}});return list})}}function getResourceByID(id){return _instance.Database.getInstance().collection("resource").doc(id).get().then(function(doc){return new Promise(function(resolve,reject){var documentData=doc.data();if(documentData===undefined){reject()}else{resolve(new Resource(documentData["name"],[],documentData["location"],documentData["details-reference"]))}})})}function submitResource(resource){var documentID;return resource.details().then(function(details){if(details!==undefined&&details.hasOwnProperty("listing-reference")){documentID=details["listing-reference"].id}else{documentID=_instance.Database.getInstance().collection("resource").doc().id}if(details===undefined){details={}}Object.assign(details,{"listing-reference":_instance.Database.getInstance().collection("resource").doc(documentID)});resource.setDetails(details);var detailsRef;if(resource.detailsRef===undefined){detailsRef=_instance.Database.getInstance().collection("resource-details").doc();resource.detailsRef=detailsRef}else{detailsRef=resource.detailsRef}return resource.detailsRef.set(details).then(function(){return detailsRef})}).then(function(documentReference){var searilization=resource.searilize();Object.assign(searilization,{"details-reference":documentReference});return _instance.Database.getInstance().collection("resource").doc(documentID).set(searilization)})}function deleteResourceByID(id){var documentRef=_instance.Database.getInstance().collection("resource").doc(id);return documentRef.get().then(function(snap){if(!snap){return new Promise(function(resolve,reject){reject("Specified resource does not exist.")})}var detailsRef=snap.get("details-reference");return detailsRef["delete"]()}).then(function(){return documentRef["delete"]()})}},{"../database/instance":2,algoliasearch:22,geodesy:173}],5:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var util=require("@firebase/util");var contains=function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)};var DEFAULT_ENTRY_NAME="[DEFAULT]";var tokenListeners=[];var FirebaseAppImpl=function(){function FirebaseAppImpl(options,config,firebase_){this.firebase_=firebase_;this.isDeleted_=false;this.services_={};this.name_=config.name;this._automaticDataCollectionEnabled=config.automaticDataCollectionEnabled||false;this.options_=util.deepCopy(options);this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(callback){tokenListeners.push(callback);setTimeout(function(){return callback(null)},0)},removeAuthTokenListener:function(callback){tokenListeners=tokenListeners.filter(function(listener){return listener!==callback})}}}Object.defineProperty(FirebaseAppImpl.prototype,"automaticDataCollectionEnabled",{get:function(){this.checkDestroyed_();return this._automaticDataCollectionEnabled},set:function(val){this.checkDestroyed_();this._automaticDataCollectionEnabled=val},enumerable:true,configurable:true});Object.defineProperty(FirebaseAppImpl.prototype,"name",{get:function(){this.checkDestroyed_();return this.name_},enumerable:true,configurable:true});Object.defineProperty(FirebaseAppImpl.prototype,"options",{get:function(){this.checkDestroyed_();return this.options_},enumerable:true,configurable:true});FirebaseAppImpl.prototype.delete=function(){var _this=this;return new Promise(function(resolve){_this.checkDestroyed_();resolve()}).then(function(){_this.firebase_.INTERNAL.removeApp(_this.name_);var services=[];Object.keys(_this.services_).forEach(function(serviceKey){Object.keys(_this.services_[serviceKey]).forEach(function(instanceKey){services.push(_this.services_[serviceKey][instanceKey])})});return Promise.all(services.map(function(service){return service.INTERNAL.delete()}))}).then(function(){_this.isDeleted_=true;_this.services_={}})};FirebaseAppImpl.prototype._getService=function(name,instanceIdentifier){if(instanceIdentifier===void 0){instanceIdentifier=DEFAULT_ENTRY_NAME}this.checkDestroyed_();if(!this.services_[name]){this.services_[name]={}}if(!this.services_[name][instanceIdentifier]){var instanceSpecifier=instanceIdentifier!==DEFAULT_ENTRY_NAME?instanceIdentifier:undefined;var service=this.firebase_.INTERNAL.factories[name](this,this.extendApp.bind(this),instanceSpecifier);this.services_[name][instanceIdentifier]=service}return this.services_[name][instanceIdentifier]};FirebaseAppImpl.prototype.extendApp=function(props){var _this=this;util.deepExtend(this,props);if(props.INTERNAL&&props.INTERNAL.addAuthTokenListener){tokenListeners.forEach(function(listener){_this.INTERNAL.addAuthTokenListener(listener)});tokenListeners=[]}};FirebaseAppImpl.prototype.checkDestroyed_=function(){if(this.isDeleted_){error("app-deleted",{name:this.name_})}};return FirebaseAppImpl}();FirebaseAppImpl.prototype.name&&FirebaseAppImpl.prototype.options||FirebaseAppImpl.prototype.delete||console.log("dc");function createFirebaseNamespace(){var apps_={};var factories={};var appHooks={};var namespace={__esModule:true,initializeApp:initializeApp,app:app,apps:null,Promise:Promise,SDK_VERSION:"5.9.3",INTERNAL:{registerService:registerService,createFirebaseNamespace:createFirebaseNamespace,extendNamespace:extendNamespace,createSubscribe:util.createSubscribe,ErrorFactory:util.ErrorFactory,removeApp:removeApp,factories:factories,useAsService:useAsService,Promise:Promise,deepExtend:util.deepExtend}};util.patchProperty(namespace,"default",namespace);Object.defineProperty(namespace,"apps",{get:getApps});function removeApp(name){var app=apps_[name];callAppHooks(app,"delete");delete apps_[name]}function app(name){name=name||DEFAULT_ENTRY_NAME;if(!contains(apps_,name)){error("no-app",{name:name})}return apps_[name]}util.patchProperty(app,"App",FirebaseAppImpl);function initializeApp(options,rawConfig){if(rawConfig===void 0){rawConfig={}}if(typeof rawConfig!=="object"||rawConfig===null){var name_1=rawConfig;rawConfig={name:name_1}}var config=rawConfig;if(config.name===undefined){config.name=DEFAULT_ENTRY_NAME}var name=config.name;if(typeof name!=="string"||!name){error("bad-app-name",{name:name+""})}if(contains(apps_,name)){error("duplicate-app",{name:name})}var app=new FirebaseAppImpl(options,config,namespace);apps_[name]=app;callAppHooks(app,"create");return app}function getApps(){return Object.keys(apps_).map(function(name){return apps_[name]})}function registerService(name,createService,serviceProperties,appHook,allowMultipleInstances){if(factories[name]){error("duplicate-service",{name:name})}factories[name]=createService;if(appHook){appHooks[name]=appHook;getApps().forEach(function(app){appHook("create",app)})}var serviceNamespace=function(appArg){if(appArg===void 0){appArg=app()}if(typeof appArg[name]!=="function"){error("invalid-app-argument",{name:name})}return appArg[name]()};if(serviceProperties!==undefined){util.deepExtend(serviceNamespace,serviceProperties)}namespace[name]=serviceNamespace;FirebaseAppImpl.prototype[name]=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}var serviceFxn=this._getService.bind(this,name);return serviceFxn.apply(this,allowMultipleInstances?args:[])};return serviceNamespace}function extendNamespace(props){util.deepExtend(namespace,props)}function callAppHooks(app,eventName){Object.keys(factories).forEach(function(serviceName){var factoryName=useAsService(app,serviceName);if(factoryName===null){return}if(appHooks[factoryName]){appHooks[factoryName](eventName,app)}})}function useAsService(app,name){if(name==="serverAuth"){return null}var useService=name;var options=app.options;return useService}return namespace}function error(code,args){throw appErrors.create(code,args)}var errors={"no-app":"No Firebase App '{$name}' has been created - "+"call Firebase App.initializeApp()","bad-app-name":"Illegal App name: '{$name}","duplicate-app":"Firebase App named '{$name}' already exists","app-deleted":"Firebase App named '{$name}' already deleted","duplicate-service":"Firebase service named '{$name}' already registered","sa-not-supported":"Initializing the Firebase SDK with a service "+"account is only allowed in a Node.js environment. On client "+"devices, you should instead initialize the SDK with an api key and "+"auth domain","invalid-app-argument":"firebase.{$name}() takes either no argument or a "+"Firebase App instance."};var appErrors=new util.ErrorFactory("app","Firebase",errors);var isNode=false;try{isNode=Object.prototype.toString.call(global.process)==="[object process]"}catch(e){}isNode&&console.warn('\nWarning: This is a browser-targeted Firebase bundle but it appears it is being\nrun in a Node environment.  If running in a Node environment, make sure you\nare using the bundle specified by the "main" field in package.json.\n\nIf you are using Webpack, you can specify "main" as the first item in\n"resolve.mainFields":\nhttps://webpack.js.org/configuration/resolve/#resolvemainfields\n\nIf using Rollup, use the rollup-plugin-node-resolve plugin and set "module"\nto false and "main" to true:\nhttps://github.com/rollup/rollup-plugin-node-resolve\n');var firebase=createFirebaseNamespace();exports.firebase=firebase;exports.default=firebase}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"@firebase/util":11}],6:[function(require,module,exports){(function(global){(function(){var firebase=require("@firebase/app").default;var g,aa=aa||{},k=this;function l(a){return"string"==typeof a}function ba(a){return"boolean"==typeof a}var ca=/^[\w+/_-]+[=]{0,2}$/,da=null;function ea(){}function fa(a){var b=typeof a;if("object"==b)if(a){if(a instanceof Array)return"array";if(a instanceof Object)return b;var c=Object.prototype.toString.call(a);if("[object Window]"==c)return"object";if("[object Array]"==c||"number"==typeof a.length&&"undefined"!=typeof a.splice&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("splice"))return"array";if("[object Function]"==c||"undefined"!=typeof a.call&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("call"))return"function"}else return"null";else if("function"==b&&"undefined"==typeof a.call)return"object";return b}function ha(a){return null===a}function ia(a){return"array"==fa(a)}function ja(a){var b=fa(a);return"array"==b||"object"==b&&"number"==typeof a.length}function n(a){return"function"==fa(a)}function q(a){var b=typeof a;return"object"==b&&null!=a||"function"==b}var ka="closure_uid_"+(1e9*Math.random()>>>0),ma=0;function na(a,b,c){return a.call.apply(a.bind,arguments)}function oa(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c)}}return function(){return a.apply(b,arguments)}}function r(a,b,c){Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?r=na:r=oa;return r.apply(null,arguments)}function pa(a,b){var c=Array.prototype.slice.call(arguments,1);return function(){var b=c.slice();b.push.apply(b,arguments);return a.apply(this,b)}}var qa=Date.now||function(){return+new Date};function t(a,b){function c(){}c.prototype=b.prototype;a.pb=b.prototype;a.prototype=new c;a.prototype.constructor=a;a.gd=function(a,c,f){for(var d=Array(arguments.length-2),e=2;e<arguments.length;e++)d[e-2]=arguments[e];return b.prototype[c].apply(a,d)}}function ra(a){if(!a)return!1;try{return!!a.$goog_Thenable}catch(b){return!1}}function u(a){if(Error.captureStackTrace)Error.captureStackTrace(this,u);else{var b=Error().stack;b&&(this.stack=b)}a&&(this.message=String(a))}t(u,Error);u.prototype.name="CustomError";function sa(a,b){a=a.split("%s");for(var c="",d=a.length-1,e=0;e<d;e++)c+=a[e]+(e<b.length?b[e]:"%s");u.call(this,c+a[d])}t(sa,u);sa.prototype.name="AssertionError";function ta(a,b){throw new sa("Failure"+(a?": "+a:""),Array.prototype.slice.call(arguments,1))}function ua(a,b){this.c=a;this.f=b;this.b=0;this.a=null}ua.prototype.get=function(){if(0<this.b){this.b--;var a=this.a;this.a=a.next;a.next=null}else a=this.c();return a};function va(a,b){a.f(b);100>a.b&&(a.b++,b.next=a.a,a.a=b)}function wa(){this.b=this.a=null}var ya=new ua(function(){return new xa},function(a){a.reset()});wa.prototype.add=function(a,b){var c=ya.get();c.set(a,b);this.b?this.b.next=c:this.a=c;this.b=c};function za(){var a=Aa,b=null;a.a&&(b=a.a,a.a=a.a.next,a.a||(a.b=null),b.next=null);return b}function xa(){this.next=this.b=this.a=null}xa.prototype.set=function(a,b){this.a=a;this.b=b;this.next=null};xa.prototype.reset=function(){this.next=this.b=this.a=null};var Ba=Array.prototype.indexOf?function(a,b){return Array.prototype.indexOf.call(a,b,void 0)}:function(a,b){if(l(a))return l(b)&&1==b.length?a.indexOf(b,0):-1;for(var c=0;c<a.length;c++)if(c in a&&a[c]===b)return c;return-1},v=Array.prototype.forEach?function(a,b,c){Array.prototype.forEach.call(a,b,c)}:function(a,b,c){for(var d=a.length,e=l(a)?a.split(""):a,f=0;f<d;f++)f in e&&b.call(c,e[f],f,a)};function Ca(a,b){var c=a.length,d=l(a)?a.split(""):a;for(--c;0<=c;--c)c in d&&b.call(void 0,d[c],c,a)}var Da=Array.prototype.map?function(a,b){return Array.prototype.map.call(a,b,void 0)}:function(a,b){for(var c=a.length,d=Array(c),e=l(a)?a.split(""):a,f=0;f<c;f++)f in e&&(d[f]=b.call(void 0,e[f],f,a));return d},Ea=Array.prototype.some?function(a,b){return Array.prototype.some.call(a,b,void 0)}:function(a,b){for(var c=a.length,d=l(a)?a.split(""):a,e=0;e<c;e++)if(e in d&&b.call(void 0,d[e],e,a))return!0;return!1};function Fa(a){a:{var b=Ga;for(var c=a.length,d=l(a)?a.split(""):a,e=0;e<c;e++)if(e in d&&b.call(void 0,d[e],e,a)){b=e;break a}b=-1}return 0>b?null:l(a)?a.charAt(b):a[b]}function Ha(a,b){return 0<=Ba(a,b)}function Ia(a,b){b=Ba(a,b);var c;(c=0<=b)&&Array.prototype.splice.call(a,b,1);return c}function w(a,b){var c=0;Ca(a,function(d,e){b.call(void 0,d,e,a)&&1==Array.prototype.splice.call(a,e,1).length&&c++})}function Ja(a){return Array.prototype.concat.apply([],arguments)}function Ka(a){var b=a.length;if(0<b){for(var c=Array(b),d=0;d<b;d++)c[d]=a[d];return c}return[]}var La=String.prototype.trim?function(a){return a.trim()}:function(a){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(a)[1]},Ma=/&/g,Na=/</g,Oa=/>/g,Pa=/"/g,Qa=/'/g,Ra=/\x00/g,Sa=/[\x00&<>"']/;function y(a,b){return-1!=a.indexOf(b)}function Ta(a,b){return a<b?-1:a>b?1:0}var Ua;a:{var Va=k.navigator;if(Va){var Wa=Va.userAgent;if(Wa){Ua=Wa;break a}}Ua=""}function z(a){return y(Ua,a)}function Xa(a,b){for(var c in a)b.call(void 0,a[c],c,a)}function Ya(a){for(var b in a)return!1;return!0}function Za(a){var b={},c;for(c in a)b[c]=a[c];return b}var $a="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ab(a,b){for(var c,d,e=1;e<arguments.length;e++){d=arguments[e];for(c in d)a[c]=d[c];for(var f=0;f<$a.length;f++)c=$a[f],Object.prototype.hasOwnProperty.call(d,c)&&(a[c]=d[c])}}function bb(a,b){for(var c=a.split("%s"),d="",e=Array.prototype.slice.call(arguments,1);e.length&&1<c.length;)d+=c.shift()+e.shift();return d+c.join("%s")}function cb(a){Sa.test(a)&&(-1!=a.indexOf("&")&&(a=a.replace(Ma,"&amp;")),-1!=a.indexOf("<")&&(a=a.replace(Na,"&lt;")),-1!=a.indexOf(">")&&(a=a.replace(Oa,"&gt;")),-1!=a.indexOf('"')&&(a=a.replace(Pa,"&quot;")),-1!=a.indexOf("'")&&(a=a.replace(Qa,"&#39;")),-1!=a.indexOf("\0")&&(a=a.replace(Ra,"&#0;")));return a}function db(a){k.setTimeout(function(){throw a},0)}var eb;function fb(){var a=k.MessageChannel;"undefined"===typeof a&&"undefined"!==typeof window&&window.postMessage&&window.addEventListener&&!z("Presto")&&(a=function(){var a=document.createElement("IFRAME");a.style.display="none";a.src="";document.documentElement.appendChild(a);var b=a.contentWindow;a=b.document;a.open();a.write("");a.close();var c="callImmediate"+Math.random(),d="file:"==b.location.protocol?"*":b.location.protocol+"//"+b.location.host;a=r(function(a){if(("*"==d||a.origin==d)&&a.data==c)this.port1.onmessage()},this);b.addEventListener("message",a,!1);this.port1={};this.port2={postMessage:function(){b.postMessage(c,d)}}});if("undefined"!==typeof a&&!z("Trident")&&!z("MSIE")){var b=new a,c={},d=c;b.port1.onmessage=function(){if(void 0!==c.next){c=c.next;var a=c.xb;c.xb=null;a()}};return function(a){d.next={xb:a};d=d.next;b.port2.postMessage(0)}}return"undefined"!==typeof document&&"onreadystatechange"in document.createElement("SCRIPT")?function(a){var b=document.createElement("SCRIPT");b.onreadystatechange=function(){b.onreadystatechange=null;b.parentNode.removeChild(b);b=null;a();a=null};document.documentElement.appendChild(b)}:function(a){k.setTimeout(a,0)}}function hb(a,b){ib||jb();kb||(ib(),kb=!0);Aa.add(a,b)}var ib;function jb(){if(k.Promise&&k.Promise.resolve){var a=k.Promise.resolve(void 0);ib=function(){a.then(lb)}}else ib=function(){var a=lb;!n(k.setImmediate)||k.Window&&k.Window.prototype&&!z("Edge")&&k.Window.prototype.setImmediate==k.setImmediate?(eb||(eb=fb()),eb(a)):k.setImmediate(a)}}var kb=!1,Aa=new wa;function lb(){for(var a;a=za();){try{a.a.call(a.b)}catch(b){db(b)}va(ya,a)}kb=!1}function A(a,b){this.a=mb;this.i=void 0;this.f=this.b=this.c=null;this.g=this.h=!1;if(a!=ea)try{var c=this;a.call(b,function(a){nb(c,ob,a)},function(a){if(!(a instanceof pb))try{if(a instanceof Error)throw a;throw Error("Promise rejected.")}catch(e){}nb(c,qb,a)})}catch(d){nb(this,qb,d)}}var mb=0,ob=2,qb=3;function rb(){this.next=this.f=this.b=this.g=this.a=null;this.c=!1}rb.prototype.reset=function(){this.f=this.b=this.g=this.a=null;this.c=!1};var sb=new ua(function(){return new rb},function(a){a.reset()});function tb(a,b,c){var d=sb.get();d.g=a;d.b=b;d.f=c;return d}function B(a){if(a instanceof A)return a;var b=new A(ea);nb(b,ob,a);return b}function C(a){return new A(function(b,c){c(a)})}function ub(a,b,c){vb(a,b,c,null)||hb(pa(b,a))}function wb(a){return new A(function(b,c){var d=a.length,e=[];if(d)for(var f=function(a,c){d--;e[a]=c;0==d&&b(e)},h=function(a){c(a)},m=0,p;m<a.length;m++)p=a[m],ub(p,pa(f,m),h);else b(e)})}function xb(a){return new A(function(b){var c=a.length,d=[];if(c)for(var e=function(a,e,f){c--;d[a]=e?{Eb:!0,value:f}:{Eb:!1,reason:f};0==c&&b(d)},f=0,h;f<a.length;f++)h=a[f],ub(h,pa(e,f,!0),pa(e,f,!1));else b(d)})}A.prototype.then=function(a,b,c){return yb(this,n(a)?a:null,n(b)?b:null,c)};A.prototype.$goog_Thenable=!0;g=A.prototype;g.ia=function(a,b){a=tb(a,a,b);a.c=!0;zb(this,a);return this};g.s=function(a,b){return yb(this,null,a,b)};g.cancel=function(a){this.a==mb&&hb(function(){var b=new pb(a);Ab(this,b)},this)};function Ab(a,b){if(a.a==mb)if(a.c){var c=a.c;if(c.b){for(var d=0,e=null,f=null,h=c.b;h&&(h.c||(d++,h.a==a&&(e=h),!(e&&1<d)));h=h.next)e||(f=h);e&&(c.a==mb&&1==d?Ab(c,b):(f?(d=f,d.next==c.f&&(c.f=d),d.next=d.next.next):Bb(c),Cb(c,e,qb,b)))}a.c=null}else nb(a,qb,b)}function zb(a,b){a.b||a.a!=ob&&a.a!=qb||Db(a);a.f?a.f.next=b:a.b=b;a.f=b}function yb(a,b,c,d){var e=tb(null,null,null);e.a=new A(function(a,h){e.g=b?function(c){try{var e=b.call(d,c);a(e)}catch(x){h(x)}}:a;e.b=c?function(b){try{var e=c.call(d,b);void 0===e&&b instanceof pb?h(b):a(e)}catch(x){h(x)}}:h});e.a.c=a;zb(a,e);return e.a}g.Pc=function(a){this.a=mb;nb(this,ob,a)};g.Qc=function(a){this.a=mb;nb(this,qb,a)};function nb(a,b,c){a.a==mb&&(a===c&&(b=qb,c=new TypeError("Promise cannot resolve to itself")),a.a=1,vb(c,a.Pc,a.Qc,a)||(a.i=c,a.a=b,a.c=null,Db(a),b!=qb||c instanceof pb||Eb(a,c)))}function vb(a,b,c,d){if(a instanceof A)return zb(a,tb(b||ea,c||null,d)),!0;if(ra(a))return a.then(b,c,d),!0;if(q(a))try{var e=a.then;if(n(e))return Fb(a,e,b,c,d),!0}catch(f){return c.call(d,f),!0}return!1}function Fb(a,b,c,d,e){function f(a){m||(m=!0,d.call(e,a))}function h(a){m||(m=!0,c.call(e,a))}var m=!1;try{b.call(a,h,f)}catch(p){f(p)}}function Db(a){a.h||(a.h=!0,hb(a.Yb,a))}function Bb(a){var b=null;a.b&&(b=a.b,a.b=b.next,b.next=null);a.b||(a.f=null);return b}g.Yb=function(){for(var a;a=Bb(this);)Cb(this,a,this.a,this.i);this.h=!1};function Cb(a,b,c,d){if(c==qb&&b.b&&!b.c)for(;a&&a.g;a=a.c)a.g=!1;if(b.a)b.a.c=null,Gb(b,c,d);else try{b.c?b.g.call(b.f):Gb(b,c,d)}catch(e){Hb.call(null,e)}va(sb,b)}function Gb(a,b,c){b==ob?a.g.call(a.f,c):a.b&&a.b.call(a.f,c)}function Eb(a,b){a.g=!0;hb(function(){a.g&&Hb.call(null,b)})}var Hb=db;function pb(a){u.call(this,a)}t(pb,u);pb.prototype.name="cancel";function Ib(){0!=Jb&&(Kb[this[ka]||(this[ka]=++ma)]=this);this.qa=this.qa;this.ja=this.ja}var Jb=0,Kb={};Ib.prototype.qa=!1;function Lb(a){if(!a.qa&&(a.qa=!0,a.va(),0!=Jb)){var b=a[ka]||(a[ka]=++ma);if(0!=Jb&&a.ja&&0<a.ja.length)throw Error(a+" did not empty its onDisposeCallbacks queue. This probably means it overrode dispose() or disposeInternal() without calling the superclass' method.");delete Kb[b]}}Ib.prototype.va=function(){if(this.ja)for(;this.ja.length;)this.ja.shift()()};function Mb(a){Mb[" "](a);return a}Mb[" "]=ea;function Nb(a,b){var c=Ob;return Object.prototype.hasOwnProperty.call(c,a)?c[a]:c[a]=b(a)}var Pb=z("Opera"),Qb=z("Trident")||z("MSIE"),Rb=z("Edge"),Sb=Rb||Qb,Tb=z("Gecko")&&!(y(Ua.toLowerCase(),"webkit")&&!z("Edge"))&&!(z("Trident")||z("MSIE"))&&!z("Edge"),Ub=y(Ua.toLowerCase(),"webkit")&&!z("Edge");function Vb(){var a=k.document;return a?a.documentMode:void 0}var Wb;a:{var Xb="",Yb=function(){var a=Ua;if(Tb)return/rv:([^\);]+)(\)|;)/.exec(a);if(Rb)return/Edge\/([\d\.]+)/.exec(a);if(Qb)return/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(a);if(Ub)return/WebKit\/(\S+)/.exec(a);if(Pb)return/(?:Version)[ \/]?(\S+)/.exec(a)}();Yb&&(Xb=Yb?Yb[1]:"");if(Qb){var Zb=Vb();if(null!=Zb&&Zb>parseFloat(Xb)){Wb=String(Zb);break a}}Wb=Xb}var Ob={};function $b(a){return Nb(a,function(){for(var b=0,c=La(String(Wb)).split("."),d=La(String(a)).split("."),e=Math.max(c.length,d.length),f=0;0==b&&f<e;f++){var h=c[f]||"",m=d[f]||"";do{h=/(\d*)(\D*)(.*)/.exec(h)||["","","",""];m=/(\d*)(\D*)(.*)/.exec(m)||["","","",""];if(0==h[0].length&&0==m[0].length)break;b=Ta(0==h[1].length?0:parseInt(h[1],10),0==m[1].length?0:parseInt(m[1],10))||Ta(0==h[2].length,0==m[2].length)||Ta(h[2],m[2]);h=h[3];m=m[3]}while(0==b)}return 0<=b})}var ac;var bc=k.document;ac=bc&&Qb?Vb()||("CSS1Compat"==bc.compatMode?parseInt(Wb,10):5):void 0;var cc=Object.freeze||function(a){return a};var dc=!Qb||9<=Number(ac),ec=Qb&&!$b("9"),fc=function(){if(!k.addEventListener||!Object.defineProperty)return!1;var a=!1,b=Object.defineProperty({},"passive",{get:function(){a=!0}});try{k.addEventListener("test",ea,b),k.removeEventListener("test",ea,b)}catch(c){}return a}();function D(a,b){this.type=a;this.b=this.target=b;this.Kb=!0}D.prototype.preventDefault=function(){this.Kb=!1};function gc(a,b){D.call(this,a?a.type:"");this.relatedTarget=this.b=this.target=null;this.button=this.screenY=this.screenX=this.clientY=this.clientX=0;this.key="";this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1;this.pointerId=0;this.pointerType="";this.a=null;if(a){var c=this.type=a.type,d=a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:null;this.target=a.target||a.srcElement;this.b=b;if(b=a.relatedTarget){if(Tb){a:{try{Mb(b.nodeName);var e=!0;break a}catch(f){}e=!1}e||(b=null)}}else"mouseover"==c?b=a.fromElement:"mouseout"==c&&(b=a.toElement);this.relatedTarget=b;d?(this.clientX=void 0!==d.clientX?d.clientX:d.pageX,this.clientY=void 0!==d.clientY?d.clientY:d.pageY,this.screenX=d.screenX||0,this.screenY=d.screenY||0):(this.clientX=void 0!==a.clientX?a.clientX:a.pageX,this.clientY=void 0!==a.clientY?a.clientY:a.pageY,this.screenX=a.screenX||0,this.screenY=a.screenY||0);this.button=a.button;this.key=a.key||"";this.ctrlKey=a.ctrlKey;this.altKey=a.altKey;this.shiftKey=a.shiftKey;this.metaKey=a.metaKey;this.pointerId=a.pointerId||0;this.pointerType=l(a.pointerType)?a.pointerType:hc[a.pointerType]||"";this.a=a;a.defaultPrevented&&this.preventDefault()}}t(gc,D);var hc=cc({2:"touch",3:"pen",4:"mouse"});gc.prototype.preventDefault=function(){gc.pb.preventDefault.call(this);var a=this.a;if(a.preventDefault)a.preventDefault();else if(a.returnValue=!1,ec)try{if(a.ctrlKey||112<=a.keyCode&&123>=a.keyCode)a.keyCode=-1}catch(b){}};gc.prototype.f=function(){return this.a};var ic="closure_listenable_"+(1e6*Math.random()|0),jc=0;function kc(a,b,c,d,e){this.listener=a;this.proxy=null;this.src=b;this.type=c;this.capture=!!d;this.Ma=e;this.key=++jc;this.oa=this.Ia=!1}function lc(a){a.oa=!0;a.listener=null;a.proxy=null;a.src=null;a.Ma=null}function mc(a){this.src=a;this.a={};this.b=0}mc.prototype.add=function(a,b,c,d,e){var f=a.toString();a=this.a[f];a||(a=this.a[f]=[],this.b++);var h=nc(a,b,d,e);-1<h?(b=a[h],c||(b.Ia=!1)):(b=new kc(b,this.src,f,!!d,e),b.Ia=c,a.push(b));return b};function oc(a,b){var c=b.type;c in a.a&&Ia(a.a[c],b)&&(lc(b),0==a.a[c].length&&(delete a.a[c],a.b--))}function nc(a,b,c,d){for(var e=0;e<a.length;++e){var f=a[e];if(!f.oa&&f.listener==b&&f.capture==!!c&&f.Ma==d)return e}return-1}var pc="closure_lm_"+(1e6*Math.random()|0),qc={},rc=0;function sc(a,b,c,d,e){if(d&&d.once)tc(a,b,c,d,e);else if(ia(b))for(var f=0;f<b.length;f++)sc(a,b[f],c,d,e);else c=uc(c),a&&a[ic]?vc(a,b,c,q(d)?!!d.capture:!!d,e):wc(a,b,c,!1,d,e)}function wc(a,b,c,d,e,f){if(!b)throw Error("Invalid event type");var h=q(e)?!!e.capture:!!e,m=xc(a);m||(a[pc]=m=new mc(a));c=m.add(b,c,d,h,f);if(!c.proxy){d=yc();c.proxy=d;d.src=a;d.listener=c;if(a.addEventListener)fc||(e=h),void 0===e&&(e=!1),a.addEventListener(b.toString(),d,e);else if(a.attachEvent)a.attachEvent(zc(b.toString()),d);else if(a.addListener&&a.removeListener)a.addListener(d);else throw Error("addEventListener and attachEvent are unavailable.");rc++}}function yc(){var a=Ac,b=dc?function(c){return a.call(b.src,b.listener,c)}:function(c){c=a.call(b.src,b.listener,c);if(!c)return c};return b}function tc(a,b,c,d,e){if(ia(b))for(var f=0;f<b.length;f++)tc(a,b[f],c,d,e);else c=uc(c),a&&a[ic]?Bc(a,b,c,q(d)?!!d.capture:!!d,e):wc(a,b,c,!0,d,e)}function E(a,b,c,d,e){if(ia(b))for(var f=0;f<b.length;f++)E(a,b[f],c,d,e);else(d=q(d)?!!d.capture:!!d,c=uc(c),a&&a[ic])?(a=a.o,b=String(b).toString(),b in a.a&&(f=a.a[b],c=nc(f,c,d,e),-1<c&&(lc(f[c]),Array.prototype.splice.call(f,c,1),0==f.length&&(delete a.a[b],a.b--)))):a&&(a=xc(a))&&(b=a.a[b.toString()],a=-1,b&&(a=nc(b,c,d,e)),(c=-1<a?b[a]:null)&&Cc(c))}function Cc(a){if("number"!=typeof a&&a&&!a.oa){var b=a.src;if(b&&b[ic])oc(b.o,a);else{var c=a.type,d=a.proxy;b.removeEventListener?b.removeEventListener(c,d,a.capture):b.detachEvent?b.detachEvent(zc(c),d):b.addListener&&b.removeListener&&b.removeListener(d);rc--;(c=xc(b))?(oc(c,a),0==c.b&&(c.src=null,b[pc]=null)):lc(a)}}}function zc(a){return a in qc?qc[a]:qc[a]="on"+a}function Dc(a,b,c,d){var e=!0;if(a=xc(a))if(b=a.a[b.toString()])for(b=b.concat(),a=0;a<b.length;a++){var f=b[a];f&&f.capture==c&&!f.oa&&(f=Ec(f,d),e=e&&!1!==f)}return e}function Ec(a,b){var c=a.listener,d=a.Ma||a.src;a.Ia&&Cc(a);return c.call(d,b)}function Ac(a,b){if(a.oa)return!0;if(!dc){if(!b)a:{b=["window","event"];for(var c=k,d=0;d<b.length;d++)if(c=c[b[d]],null==c){b=null;break a}b=c}d=b;b=new gc(d,this);c=!0;if(!(0>d.keyCode||void 0!=d.returnValue)){a:{var e=!1;if(0==d.keyCode)try{d.keyCode=-1;break a}catch(h){e=!0}if(e||void 0==d.returnValue)d.returnValue=!0}d=[];for(e=b.b;e;e=e.parentNode)d.push(e);a=a.type;for(e=d.length-1;0<=e;e--){b.b=d[e];var f=Dc(d[e],a,!0,b);c=c&&f}for(e=0;e<d.length;e++)b.b=d[e],f=Dc(d[e],a,!1,b),c=c&&f}return c}return Ec(a,new gc(b,this))}function xc(a){a=a[pc];return a instanceof mc?a:null}var Fc="__closure_events_fn_"+(1e9*Math.random()>>>0);function uc(a){if(n(a))return a;a[Fc]||(a[Fc]=function(b){return a.handleEvent(b)});return a[Fc]}function F(){Ib.call(this);this.o=new mc(this);this.Rb=this;this.Wa=null}t(F,Ib);F.prototype[ic]=!0;F.prototype.addEventListener=function(a,b,c,d){sc(this,a,b,c,d)};F.prototype.removeEventListener=function(a,b,c,d){E(this,a,b,c,d)};F.prototype.dispatchEvent=function(a){var b,c=this.Wa;if(c)for(b=[];c;c=c.Wa)b.push(c);c=this.Rb;var d=a.type||a;if(l(a))a=new D(a,c);else if(a instanceof D)a.target=a.target||c;else{var e=a;a=new D(d,c);ab(a,e)}e=!0;if(b)for(var f=b.length-1;0<=f;f--){var h=a.b=b[f];e=Gc(h,d,!0,a)&&e}h=a.b=c;e=Gc(h,d,!0,a)&&e;e=Gc(h,d,!1,a)&&e;if(b)for(f=0;f<b.length;f++)h=a.b=b[f],e=Gc(h,d,!1,a)&&e;return e};F.prototype.va=function(){F.pb.va.call(this);if(this.o){var a=this.o,b=0,c;for(c in a.a){for(var d=a.a[c],e=0;e<d.length;e++)++b,lc(d[e]);delete a.a[c];a.b--}}this.Wa=null};function vc(a,b,c,d,e){a.o.add(String(b),c,!1,d,e)}function Bc(a,b,c,d,e){a.o.add(String(b),c,!0,d,e)}function Gc(a,b,c,d){b=a.o.a[String(b)];if(!b)return!0;b=b.concat();for(var e=!0,f=0;f<b.length;++f){var h=b[f];if(h&&!h.oa&&h.capture==c){var m=h.listener,p=h.Ma||h.src;h.Ia&&oc(a.o,h);e=!1!==m.call(p,d)&&e}}return e&&0!=d.Kb}function Hc(a,b,c){if(n(a))c&&(a=r(a,c));else if(a&&"function"==typeof a.handleEvent)a=r(a.handleEvent,a);else throw Error("Invalid listener argument");return 2147483647<Number(b)?-1:k.setTimeout(a,b||0)}function Ic(a){var b=null;return new A(function(c,d){b=Hc(function(){c(void 0)},a);-1==b&&d(Error("Failed to schedule timer."))}).s(function(a){k.clearTimeout(b);throw a})}function Jc(a){if(a.S&&"function"==typeof a.S)return a.S();if(l(a))return a.split("");if(ja(a)){for(var b=[],c=a.length,d=0;d<c;d++)b.push(a[d]);return b}b=[];c=0;for(d in a)b[c++]=a[d];return b}function Kc(a){if(a.U&&"function"==typeof a.U)return a.U();if(!a.S||"function"!=typeof a.S){if(ja(a)||l(a)){var b=[];a=a.length;for(var c=0;c<a;c++)b.push(c);return b}b=[];c=0;for(var d in a)b[c++]=d;return b}}function Lc(a,b){if(a.forEach&&"function"==typeof a.forEach)a.forEach(b,void 0);else if(ja(a)||l(a))v(a,b,void 0);else for(var c=Kc(a),d=Jc(a),e=d.length,f=0;f<e;f++)b.call(void 0,d[f],c&&c[f],a)}function Mc(a,b){this.b={};this.a=[];this.c=0;var c=arguments.length;if(1<c){if(c%2)throw Error("Uneven number of arguments");for(var d=0;d<c;d+=2)this.set(arguments[d],arguments[d+1])}else if(a)if(a instanceof Mc)for(c=a.U(),d=0;d<c.length;d++)this.set(c[d],a.get(c[d]));else for(d in a)this.set(d,a[d])}g=Mc.prototype;g.S=function(){Nc(this);for(var a=[],b=0;b<this.a.length;b++)a.push(this.b[this.a[b]]);return a};g.U=function(){Nc(this);return this.a.concat()};g.clear=function(){this.b={};this.c=this.a.length=0};function Nc(a){if(a.c!=a.a.length){for(var b=0,c=0;b<a.a.length;){var d=a.a[b];Oc(a.b,d)&&(a.a[c++]=d);b++}a.a.length=c}if(a.c!=a.a.length){var e={};for(c=b=0;b<a.a.length;)d=a.a[b],Oc(e,d)||(a.a[c++]=d,e[d]=1),b++;a.a.length=c}}g.get=function(a,b){return Oc(this.b,a)?this.b[a]:b};g.set=function(a,b){Oc(this.b,a)||(this.c++,this.a.push(a));this.b[a]=b};g.forEach=function(a,b){for(var c=this.U(),d=0;d<c.length;d++){var e=c[d],f=this.get(e);a.call(b,f,e,this)}};function Oc(a,b){return Object.prototype.hasOwnProperty.call(a,b)}var Pc=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Qc(a,b){if(a){a=a.split("&");for(var c=0;c<a.length;c++){var d=a[c].indexOf("="),e=null;if(0<=d){var f=a[c].substring(0,d);e=a[c].substring(d+1)}else f=a[c];b(f,e?decodeURIComponent(e.replace(/\+/g," ")):"")}}}function Rc(a,b){this.b=this.o=this.c="";this.i=null;this.h=this.g="";this.f=!1;if(a instanceof Rc){this.f=void 0!==b?b:a.f;Sc(this,a.c);this.o=a.o;this.b=a.b;Tc(this,a.i);this.g=a.g;b=a.a;var c=new Uc;c.c=b.c;b.a&&(c.a=new Mc(b.a),c.b=b.b);Vc(this,c);this.h=a.h}else a&&(c=String(a).match(Pc))?(this.f=!!b,Sc(this,c[1]||"",!0),this.o=Wc(c[2]||""),this.b=Wc(c[3]||"",!0),Tc(this,c[4]),this.g=Wc(c[5]||"",!0),Vc(this,c[6]||"",!0),this.h=Wc(c[7]||"")):(this.f=!!b,this.a=new Uc(null,this.f))}Rc.prototype.toString=function(){var a=[],b=this.c;b&&a.push(Xc(b,Yc,!0),":");var c=this.b;if(c||"file"==b)a.push("//"),(b=this.o)&&a.push(Xc(b,Yc,!0),"@"),a.push(encodeURIComponent(String(c)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),c=this.i,null!=c&&a.push(":",String(c));if(c=this.g)this.b&&"/"!=c.charAt(0)&&a.push("/"),a.push(Xc(c,"/"==c.charAt(0)?Zc:$c,!0));(c=this.a.toString())&&a.push("?",c);(c=this.h)&&a.push("#",Xc(c,ad));return a.join("")};function Sc(a,b,c){a.c=c?Wc(b,!0):b;a.c&&(a.c=a.c.replace(/:$/,""))}function Tc(a,b){if(b){b=Number(b);if(isNaN(b)||0>b)throw Error("Bad port number "+b);a.i=b}else a.i=null}function Vc(a,b,c){b instanceof Uc?(a.a=b,bd(a.a,a.f)):(c||(b=Xc(b,cd)),a.a=new Uc(b,a.f))}function G(a,b,c){a.a.set(b,c)}function dd(a,b){return a.a.get(b)}function ed(a){return a instanceof Rc?new Rc(a):new Rc(a,void 0)}function fd(a,b){var c=new Rc(null,void 0);Sc(c,"https");a&&(c.b=a);b&&(c.g=b);return c}function Wc(a,b){return a?b?decodeURI(a.replace(/%25/g,"%2525")):decodeURIComponent(a):""}function Xc(a,b,c){return l(a)?(a=encodeURI(a).replace(b,gd),c&&(a=a.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),a):null}function gd(a){a=a.charCodeAt(0);return"%"+(a>>4&15).toString(16)+(a&15).toString(16)}var Yc=/[#\/\?@]/g,$c=/[#\?:]/g,Zc=/[#\?]/g,cd=/[#\?@]/g,ad=/#/g;function Uc(a,b){this.b=this.a=null;this.c=a||null;this.f=!!b}function hd(a){a.a||(a.a=new Mc,a.b=0,a.c&&Qc(a.c,function(b,c){a.add(decodeURIComponent(b.replace(/\+/g," ")),c)}))}function id(a){var b=Kc(a);if("undefined"==typeof b)throw Error("Keys are undefined");var c=new Uc(null,void 0);a=Jc(a);for(var d=0;d<b.length;d++){var e=b[d],f=a[d];ia(f)?jd(c,e,f):c.add(e,f)}return c}g=Uc.prototype;g.add=function(a,b){hd(this);this.c=null;a=kd(this,a);var c=this.a.get(a);c||this.a.set(a,c=[]);c.push(b);this.b+=1;return this};function ld(a,b){hd(a);b=kd(a,b);Oc(a.a.b,b)&&(a.c=null,a.b-=a.a.get(b).length,a=a.a,Oc(a.b,b)&&(delete a.b[b],a.c--,a.a.length>2*a.c&&Nc(a)))}g.clear=function(){this.a=this.c=null;this.b=0};function md(a,b){hd(a);b=kd(a,b);return Oc(a.a.b,b)}g.forEach=function(a,b){hd(this);this.a.forEach(function(c,d){v(c,function(c){a.call(b,c,d,this)},this)},this)};g.U=function(){hd(this);for(var a=this.a.S(),b=this.a.U(),c=[],d=0;d<b.length;d++)for(var e=a[d],f=0;f<e.length;f++)c.push(b[d]);return c};g.S=function(a){hd(this);var b=[];if(l(a))md(this,a)&&(b=Ja(b,this.a.get(kd(this,a))));else{a=this.a.S();for(var c=0;c<a.length;c++)b=Ja(b,a[c])}return b};g.set=function(a,b){hd(this);this.c=null;a=kd(this,a);md(this,a)&&(this.b-=this.a.get(a).length);this.a.set(a,[b]);this.b+=1;return this};g.get=function(a,b){if(!a)return b;a=this.S(a);return 0<a.length?String(a[0]):b};function jd(a,b,c){ld(a,b);0<c.length&&(a.c=null,a.a.set(kd(a,b),Ka(c)),a.b+=c.length)}g.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var a=[],b=this.a.U(),c=0;c<b.length;c++){var d=b[c],e=encodeURIComponent(String(d));d=this.S(d);for(var f=0;f<d.length;f++){var h=e;""!==d[f]&&(h+="="+encodeURIComponent(String(d[f])));a.push(h)}}return this.c=a.join("&")};function kd(a,b){b=String(b);a.f&&(b=b.toLowerCase());return b}function bd(a,b){b&&!a.f&&(hd(a),a.c=null,a.a.forEach(function(a,b){var c=b.toLowerCase();b!=c&&(ld(this,b),jd(this,c,a))},a));a.f=b}var nd=!Qb||9<=Number(ac);function od(a,b){this.a=a===pd&&b||"";this.b=qd}od.prototype.na=!0;od.prototype.ma=function(){return this.a};od.prototype.toString=function(){return"Const{"+this.a+"}"};function rd(a){if(a instanceof od&&a.constructor===od&&a.b===qd)return a.a;ta("expected object of type Const, got '"+a+"'");return"type_error:Const"}var qd={},pd={};function sd(){this.a="";this.b=td}sd.prototype.na=!0;sd.prototype.ma=function(){return this.a};sd.prototype.toString=function(){return"TrustedResourceUrl{"+this.a+"}"};function ud(a){if(a instanceof sd&&a.constructor===sd&&a.b===td)return a.a;ta("expected object of type TrustedResourceUrl, got '"+a+"' of type "+fa(a));return"type_error:TrustedResourceUrl"}function vd(a,b){var c=rd(a);if(!wd.test(c))throw Error("Invalid TrustedResourceUrl format: "+c);a=c.replace(xd,function(a,e){if(!Object.prototype.hasOwnProperty.call(b,e))throw Error('Found marker, "'+e+'", in format string, "'+c+'", but no valid label mapping found in args: '+JSON.stringify(b));a=b[e];return a instanceof od?rd(a):encodeURIComponent(String(a))});return yd(a)}var xd=/%{(\w+)}/g,wd=/^((https:)?\/\/[0-9a-z.:[\]-]+\/|\/[^/\\]|[^:/\\%]+\/|[^:/\\%]*[?#]|about:blank#)/i,td={};function yd(a){var b=new sd;b.a=a;return b}function zd(){this.a="";this.b=Ad}zd.prototype.na=!0;zd.prototype.ma=function(){return this.a};zd.prototype.toString=function(){return"SafeUrl{"+this.a+"}"};function Bd(a){if(a instanceof zd&&a.constructor===zd&&a.b===Ad)return a.a;ta("expected object of type SafeUrl, got '"+a+"' of type "+fa(a));return"type_error:SafeUrl"}var Cd=/^(?:(?:https?|mailto|ftp):|[^:/?#]*(?:[/?#]|$))/i;function Dd(a){if(a instanceof zd)return a;a="object"==typeof a&&a.na?a.ma():String(a);Cd.test(a)||(a="about:invalid#zClosurez");return Ed(a)}var Ad={};function Ed(a){var b=new zd;b.a=a;return b}Ed("about:blank");function Fd(){this.a="";this.b=Gd}Fd.prototype.na=!0;Fd.prototype.ma=function(){return this.a};Fd.prototype.toString=function(){return"SafeHtml{"+this.a+"}"};function Hd(a){if(a instanceof Fd&&a.constructor===Fd&&a.b===Gd)return a.a;ta("expected object of type SafeHtml, got '"+a+"' of type "+fa(a));return"type_error:SafeHtml"}var Gd={};function Id(a){var b=new Fd;b.a=a;return b}Id("<!DOCTYPE html>");Id("");Id("<br>");function Jd(a,b){a.src=ud(b);if(null===da)b:{b=k.document;if((b=b.querySelector&&b.querySelector("script[nonce]"))&&(b=b.nonce||b.getAttribute("nonce"))&&ca.test(b)){da=b;break b}da=""}b=da;b&&a.setAttribute("nonce",b)}function Kd(a){var b=document;return l(a)?b.getElementById(a):a}function Ld(a,b){Xa(b,function(b,d){b&&"object"==typeof b&&b.na&&(b=b.ma());"style"==d?a.style.cssText=b:"class"==d?a.className=b:"for"==d?a.htmlFor=b:Md.hasOwnProperty(d)?a.setAttribute(Md[d],b):0==d.lastIndexOf("aria-",0)||0==d.lastIndexOf("data-",0)?a.setAttribute(d,b):a[d]=b})}var Md={cellpadding:"cellPadding",cellspacing:"cellSpacing",colspan:"colSpan",frameborder:"frameBorder",height:"height",maxlength:"maxLength",nonce:"nonce",role:"role",rowspan:"rowSpan",type:"type",usemap:"useMap",valign:"vAlign",width:"width"};function Nd(a,b,c){var d=arguments,e=document,f=String(d[0]),h=d[1];if(!nd&&h&&(h.name||h.type)){f=["<",f];h.name&&f.push(' name="',cb(h.name),'"');if(h.type){f.push(' type="',cb(h.type),'"');var m={};ab(m,h);delete m.type;h=m}f.push(">");f=f.join("")}f=e.createElement(f);h&&(l(h)?f.className=h:ia(h)?f.className=h.join(" "):Ld(f,h));2<d.length&&Od(e,f,d);return f}function Od(a,b,c){function d(c){c&&b.appendChild(l(c)?a.createTextNode(c):c)}for(var e=2;e<c.length;e++){var f=c[e];!ja(f)||q(f)&&0<f.nodeType?d(f):v(Pd(f)?Ka(f):f,d)}}function Pd(a){if(a&&"number"==typeof a.length){if(q(a))return"function"==typeof a.item||"string"==typeof a.item;if(n(a))return"function"==typeof a.item}return!1}function Qd(a){var b=[];Rd(new Sd,a,b);return b.join("")}function Sd(){}function Rd(a,b,c){if(null==b)c.push("null");else{if("object"==typeof b){if(ia(b)){var d=b;b=d.length;c.push("[");for(var e="",f=0;f<b;f++)c.push(e),Rd(a,d[f],c),e=",";c.push("]");return}if(b instanceof String||b instanceof Number||b instanceof Boolean)b=b.valueOf();else{c.push("{");e="";for(d in b)Object.prototype.hasOwnProperty.call(b,d)&&(f=b[d],"function"!=typeof f&&(c.push(e),Td(d,c),c.push(":"),Rd(a,f,c),e=","));c.push("}");return}}switch(typeof b){case"string":Td(b,c);break;case"number":c.push(isFinite(b)&&!isNaN(b)?String(b):"null");break;case"boolean":c.push(String(b));break;case"function":c.push("null");break;default:throw Error("Unknown type: "+typeof b)}}}var Ud={'"':'\\"',"\\":"\\\\","/":"\\/","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\v":"\\u000b"},Vd=/\uffff/.test("￿")?/[\\"\x00-\x1f\x7f-\uffff]/g:/[\\"\x00-\x1f\x7f-\xff]/g;function Td(a,b){b.push('"',a.replace(Vd,function(a){var b=Ud[a];b||(b="\\u"+(a.charCodeAt(0)|65536).toString(16).substr(1),Ud[a]=b);return b}),'"')}function Wd(){var a=H();return Qb&&!!ac&&11==ac||/Edge\/\d+/.test(a)}function Xd(){return k.window&&k.window.location.href||self&&self.location&&self.location.href||""}function Yd(a,b){b=b||k.window;var c="about:blank";a&&(c=Bd(Dd(a)));b.location.href=c}function Zd(a,b){var c=[],d;for(d in a)d in b?typeof a[d]!=typeof b[d]?c.push(d):"object"==typeof a[d]&&null!=a[d]&&null!=b[d]?0<Zd(a[d],b[d]).length&&c.push(d):a[d]!==b[d]&&c.push(d):c.push(d);for(d in b)d in a||c.push(d);return c}function $d(){var a=H();a=ae(a)!=be?null:(a=a.match(/\sChrome\/(\d+)/i))&&2==a.length?parseInt(a[1],10):null;return a&&30>a?!1:!Qb||!ac||9<ac}function ce(a){a=(a||H()).toLowerCase();return a.match(/android/)||a.match(/webos/)||a.match(/iphone|ipad|ipod/)||a.match(/blackberry/)||a.match(/windows phone/)||a.match(/iemobile/)?!0:!1}function de(a){a=a||k.window;try{a.close()}catch(b){}}function ee(a,b,c){var d=Math.floor(1e9*Math.random()).toString();b=b||500;c=c||600;var e=(window.screen.availHeight-c)/2,f=(window.screen.availWidth-b)/2;b={width:b,height:c,top:0<e?e:0,left:0<f?f:0,location:!0,resizable:!0,statusbar:!0,toolbar:!1};c=H().toLowerCase();d&&(b.target=d,y(c,"crios/")&&(b.target="_blank"));ae(H())==fe&&(a=a||"http://localhost",b.scrollbars=!0);c=a||"";(a=b)||(a={});d=window;b=c instanceof zd?c:Dd("undefined"!=typeof c.href?c.href:String(c));c=a.target||c.target;e=[];for(h in a)switch(h){case"width":case"height":case"top":case"left":e.push(h+"="+a[h]);break;case"target":case"noopener":case"noreferrer":break;default:e.push(h+"="+(a[h]?1:0))}var h=e.join(",");(z("iPhone")&&!z("iPod")&&!z("iPad")||z("iPad")||z("iPod"))&&d.navigator&&d.navigator.standalone&&c&&"_self"!=c?(h=d.document.createElement("A"),b instanceof zd||b instanceof zd||(b="object"==typeof b&&b.na?b.ma():String(b),Cd.test(b)||(b="about:invalid#zClosurez"),b=Ed(b)),h.href=Bd(b),h.setAttribute("target",c),a.noreferrer&&h.setAttribute("rel","noreferrer"),a=document.createEvent("MouseEvent"),a.initMouseEvent("click",!0,!0,d,1),h.dispatchEvent(a),h={}):a.noreferrer?(h=d.open("",c,h),a=Bd(b),h&&(Sb&&y(a,";")&&(a="'"+a.replace(/'/g,"%27")+"'"),h.opener=null,a=Id('<meta name="referrer" content="no-referrer"><meta http-equiv="refresh" content="0; url='+cb(a)+'">'),h.document.write(Hd(a)),h.document.close())):(h=d.open(Bd(b),c,h))&&a.noopener&&(h.opener=null);if(h)try{h.focus()}catch(m){}return h}function ge(a){return new A(function(b){function c(){Ic(2e3).then(function(){if(!a||a.closed)b();else return c()})}return c()})}var he=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,ie=/^[^@]+@[^@]+$/;function je(){var a=null;return new A(function(b){"complete"==k.document.readyState?b():(a=function(){b()},tc(window,"load",a))}).s(function(b){E(window,"load",a);throw b})}function ke(){return le(void 0)?je().then(function(){return new A(function(a,b){var c=k.document,d=setTimeout(function(){b(Error("Cordova framework is not ready."))},1e3);c.addEventListener("deviceready",function(){clearTimeout(d);a()},!1)})}):C(Error("Cordova must run in an Android or iOS file scheme."))}function le(a){a=a||H();return!("file:"!==me()||!a.toLowerCase().match(/iphone|ipad|ipod|android/))}function ne(){var a=k.window;try{return!(!a||a==a.top)}catch(b){return!1}}function oe(){return"object"!==typeof k.window&&"function"===typeof k.importScripts}function pe(){return firebase.INTERNAL.hasOwnProperty("reactNative")?"ReactNative":firebase.INTERNAL.hasOwnProperty("node")?"Node":oe()?"Worker":"Browser"}function qe(){var a=pe();return"ReactNative"===a||"Node"===a}function re(){for(var a=50,b=[];0<a;)b.push("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(62*Math.random()))),a--;return b.join("")}var fe="Firefox",be="Chrome";function ae(a){var b=a.toLowerCase();if(y(b,"opera/")||y(b,"opr/")||y(b,"opios/"))return"Opera";if(y(b,"iemobile"))return"IEMobile";if(y(b,"msie")||y(b,"trident/"))return"IE";if(y(b,"edge/"))return"Edge";if(y(b,"firefox/"))return fe;if(y(b,"silk/"))return"Silk";if(y(b,"blackberry"))return"Blackberry";if(y(b,"webos"))return"Webos";if(!y(b,"safari/")||y(b,"chrome/")||y(b,"crios/")||y(b,"android"))if(!y(b,"chrome/")&&!y(b,"crios/")||y(b,"edge/")){if(y(b,"android"))return"Android";if((a=a.match(/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/))&&2==a.length)return a[1]}else return be;else return"Safari";return"Other"}var se={Wc:"FirebaseCore-web",Yc:"FirebaseUI-web"};function te(a,b){b=b||[];var c=[],d={},e;for(e in se)d[se[e]]=!0;for(e=0;e<b.length;e++)"undefined"!==typeof d[b[e]]&&(delete d[b[e]],c.push(b[e]));c.sort();b=c;b.length||(b=["FirebaseCore-web"]);c=pe();"Browser"===c?(d=H(),c=ae(d)):"Worker"===c&&(d=H(),c=ae(d)+"-"+c);return c+"/JsCore/"+a+"/"+b.join(",")}function H(){return k.navigator&&k.navigator.userAgent||""}function I(a,b){a=a.split(".");b=b||k;for(var c=0;c<a.length&&"object"==typeof b&&null!=b;c++)b=b[a[c]];c!=a.length&&(b=void 0);return b}function ue(){try{var a=k.localStorage,b=ve();if(a)return a.setItem(b,"1"),a.removeItem(b),Wd()?!!k.indexedDB:!0}catch(c){return oe()&&!!k.indexedDB}return!1}function we(){return(xe()||"chrome-extension:"===me()||le())&&!qe()&&ue()&&!oe()}function xe(){return"http:"===me()||"https:"===me()}function me(){return k.location&&k.location.protocol||null}function ye(a){a=a||H();return ce(a)||ae(a)==fe?!1:!0}function ze(a){return"undefined"===typeof a?null:Qd(a)}function Ae(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&null!==a[c]&&void 0!==a[c]&&(b[c]=a[c]);return b}function Be(a){if(null!==a)return JSON.parse(a)}function ve(a){return a?a:Math.floor(1e9*Math.random()).toString()}function Ce(a){a=a||H();return"Safari"==ae(a)||a.toLowerCase().match(/iphone|ipad|ipod/)?!1:!0}function De(){var a=k.___jsl;if(a&&a.H)for(var b in a.H)if(a.H[b].r=a.H[b].r||[],a.H[b].L=a.H[b].L||[],a.H[b].r=a.H[b].L.concat(),a.CP)for(var c=0;c<a.CP.length;c++)a.CP[c]=null}function Ee(a,b){if(a>b)throw Error("Short delay should be less than long delay!");this.a=a;this.c=b;a=H();b=pe();this.b=ce(a)||"ReactNative"===b}Ee.prototype.get=function(){var a=k.navigator;return(a&&"boolean"===typeof a.onLine&&(xe()||"chrome-extension:"===me()||"undefined"!==typeof a.connection)?a.onLine:1)?this.b?this.c:this.a:Math.min(5e3,this.a)};function Fe(){var a=k.document;return a&&"undefined"!==typeof a.visibilityState?"visible"==a.visibilityState:!0}function Ge(){var a=k.document,b=null;return Fe()||!a?B():new A(function(c){b=function(){Fe()&&(a.removeEventListener("visibilitychange",b,!1),c())};a.addEventListener("visibilitychange",b,!1)}).s(function(c){a.removeEventListener("visibilitychange",b,!1);throw c})}function He(a){try{var b=new Date(parseInt(a,10));if(!isNaN(b.getTime())&&!/[^0-9]/.test(a))return b.toUTCString()}catch(c){}return null}function Ie(){return!(!I("fireauth.oauthhelper",k)&&!I("fireauth.iframe",k))}function Je(){var a=k.navigator;return a&&a.serviceWorker&&a.serviceWorker.controller||null}function Ke(){var a=k.navigator;return a&&a.serviceWorker?B().then(function(){return a.serviceWorker.ready}).then(function(a){return a.active||null}).s(function(){return null}):B(null)}var Le={};function Me(a){Le[a]||(Le[a]=!0,"undefined"!==typeof console&&"function"===typeof console.warn&&console.warn(a))}var Ne;try{var Oe={};Object.defineProperty(Oe,"abcd",{configurable:!0,enumerable:!0,value:1});Object.defineProperty(Oe,"abcd",{configurable:!0,enumerable:!0,value:2});Ne=2==Oe.abcd}catch(a){Ne=!1}function J(a,b,c){Ne?Object.defineProperty(a,b,{configurable:!0,enumerable:!0,value:c}):a[b]=c}function K(a,b){if(b)for(var c in b)b.hasOwnProperty(c)&&J(a,c,b[c])}function Pe(a){var b={};K(b,a);return b}function Qe(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function Re(a,b){if(!b||!b.length)return!0;if(!a)return!1;for(var c=0;c<b.length;c++){var d=a[b[c]];if(void 0===d||null===d||""===d)return!1}return!0}function Se(a){var b=a;if("object"==typeof a&&null!=a){b="length"in a?[]:{};for(var c in a)J(b,c,Se(a[c]))}return b}function Te(a){var b={},c=a[Ue],d=a[Ve];a=a[We];if(!a||a!=Xe&&!c)throw Error("Invalid provider user info!");b[Ye]=d||null;b[Ze]=c||null;J(this,$e,a);J(this,af,Se(b))}var Xe="EMAIL_SIGNIN",Ue="email",Ve="newEmail",We="requestType",Ze="email",Ye="fromEmail",af="data",$e="operation";function L(a,b){this.code=bf+a;this.message=b||cf[a]||""}t(L,Error);L.prototype.C=function(){return{code:this.code,message:this.message}};L.prototype.toJSON=function(){return this.C()};function df(a){var b=a&&a.code;return b?new L(b.substring(bf.length),a.message):null}var bf="auth/",cf={"argument-error":"","app-not-authorized":"This app, identified by the domain where it's hosted, is not authorized to use Firebase Authentication with the provided API key. Review your key configuration in the Google API console.","app-not-installed":"The requested mobile application corresponding to the identifier (Android package name or iOS bundle ID) provided is not installed on this device.","captcha-check-failed":"The reCAPTCHA response token provided is either invalid, expired, already used or the domain associated with it does not match the list of whitelisted domains.","code-expired":"The SMS code has expired. Please re-send the verification code to try again.","cordova-not-ready":"Cordova framework is not ready.","cors-unsupported":"This browser is not supported.","credential-already-in-use":"This credential is already associated with a different user account.","custom-token-mismatch":"The custom token corresponds to a different audience.","requires-recent-login":"This operation is sensitive and requires recent authentication. Log in again before retrying this request.","dynamic-link-not-activated":"Please activate Dynamic Links in the Firebase Console and agree to the terms and conditions.","email-already-in-use":"The email address is already in use by another account.","expired-action-code":"The action code has expired. ","cancelled-popup-request":"This operation has been cancelled due to another conflicting popup being opened.","internal-error":"An internal error has occurred.","invalid-app-credential":"The phone verification request contains an invalid application verifier. The reCAPTCHA token response is either invalid or expired.","invalid-app-id":"The mobile app identifier is not registed for the current project.","invalid-user-token":"This user's credential isn't valid for this project. This can happen if the user's token has been tampered with, or if the user isn't for the project associated with this API key.","invalid-auth-event":"An internal error has occurred.","invalid-verification-code":"The SMS verification code used to create the phone auth credential is invalid. Please resend the verification code sms and be sure use the verification code provided by the user.","invalid-continue-uri":"The continue URL provided in the request is invalid.","invalid-cordova-configuration":"The following Cordova plugins must be installed to enable OAuth sign-in: cordova-plugin-buildinfo, cordova-universal-links-plugin, cordova-plugin-browsertab, cordova-plugin-inappbrowser and cordova-plugin-customurlscheme.","invalid-custom-token":"The custom token format is incorrect. Please check the documentation.","invalid-dynamic-link-domain":"The provided dynamic link domain is not configured or authorized for the current project.","invalid-email":"The email address is badly formatted.","invalid-api-key":"Your API key is invalid, please check you have copied it correctly.","invalid-cert-hash":"The SHA-1 certificate hash provided is invalid.","invalid-credential":"The supplied auth credential is malformed or has expired.","invalid-persistence-type":"The specified persistence type is invalid. It can only be local, session or none.","invalid-message-payload":"The email template corresponding to this action contains invalid characters in its message. Please fix by going to the Auth email templates section in the Firebase Console.","invalid-oauth-provider":"EmailAuthProvider is not supported for this operation. This operation only supports OAuth providers.","invalid-oauth-client-id":"The OAuth client ID provided is either invalid or does not match the specified API key.","unauthorized-domain":"This domain is not authorized for OAuth operations for your Firebase project. Edit the list of authorized domains from the Firebase console.","invalid-action-code":"The action code is invalid. This can happen if the code is malformed, expired, or has already been used.","wrong-password":"The password is invalid or the user does not have a password.","invalid-phone-number":"The format of the phone number provided is incorrect. Please enter the phone number in a format that can be parsed into E.164 format. E.164 phone numbers are written in the format [+][country code][subscriber number including area code].","invalid-provider-id":"The specified provider ID is invalid.","invalid-recipient-email":"The email corresponding to this action failed to send as the provided recipient email address is invalid.","invalid-sender":"The email template corresponding to this action contains an invalid sender email or name. Please fix by going to the Auth email templates section in the Firebase Console.","invalid-verification-id":"The verification ID used to create the phone auth credential is invalid.","missing-android-pkg-name":"An Android Package Name must be provided if the Android App is required to be installed.","auth-domain-config-required":"Be sure to include authDomain when calling firebase.initializeApp(), by following the instructions in the Firebase console.","missing-app-credential":"The phone verification request is missing an application verifier assertion. A reCAPTCHA response token needs to be provided.","missing-verification-code":"The phone auth credential was created with an empty SMS verification code.","missing-continue-uri":"A continue URL must be provided in the request.","missing-iframe-start":"An internal error has occurred.","missing-ios-bundle-id":"An iOS Bundle ID must be provided if an App Store ID is provided.","missing-or-invalid-nonce":"The OIDC ID token requires a valid unhashed nonce.","missing-phone-number":"To send verification codes, provide a phone number for the recipient.","missing-verification-id":"The phone auth credential was created with an empty verification ID.","app-deleted":"This instance of FirebaseApp has been deleted.","account-exists-with-different-credential":"An account already exists with the same email address but different sign-in credentials. Sign in using a provider associated with this email address.","network-request-failed":"A network error (such as timeout, interrupted connection or unreachable host) has occurred.","no-auth-event":"An internal error has occurred.","no-such-provider":"User was not linked to an account with the given provider.","null-user":"A null user object was provided as the argument for an operation which requires a non-null user object.","operation-not-allowed":"The given sign-in provider is disabled for this Firebase project. Enable it in the Firebase console, under the sign-in method tab of the Auth section.","operation-not-supported-in-this-environment":'This operation is not supported in the environment this application is running on. "location.protocol" must be http, https or chrome-extension and web storage must be enabled.',"popup-blocked":"Unable to establish a connection with the popup. It may have been blocked by the browser.","popup-closed-by-user":"The popup has been closed by the user before finalizing the operation.","provider-already-linked":"User can only be linked to one identity for the given provider.","quota-exceeded":"The project's quota for this operation has been exceeded.","redirect-cancelled-by-user":"The redirect operation has been cancelled by the user before finalizing.","redirect-operation-pending":"A redirect sign-in operation is already pending.","rejected-credential":"The request contains malformed or mismatching credentials.",timeout:"The operation has timed out.","user-token-expired":"The user's credential is no longer valid. The user must sign in again.","too-many-requests":"We have blocked all requests from this device due to unusual activity. Try again later.","unauthorized-continue-uri":"The domain of the continue URL is not whitelisted.  Please whitelist the domain in the Firebase console.","unsupported-persistence-type":"The current environment does not support the specified persistence type.","user-cancelled":"User did not grant your application the permissions it requested.","user-not-found":"There is no user record corresponding to this identifier. The user may have been deleted.","user-disabled":"The user account has been disabled by an administrator.","user-mismatch":"The supplied credentials do not correspond to the previously signed in user.","user-signed-out":"","weak-password":"The password must be 6 characters long or more.","web-storage-unsupported":"This browser is not supported or 3rd party cookies and data may be disabled."};function ef(a){var b=a[ff];if("undefined"===typeof b)throw new L("missing-continue-uri");if("string"!==typeof b||"string"===typeof b&&!b.length)throw new L("invalid-continue-uri");this.h=b;this.b=this.a=null;this.g=!1;var c=a[gf];if(c&&"object"===typeof c){b=c[hf];var d=c[jf];c=c[kf];if("string"===typeof b&&b.length){this.a=b;if("undefined"!==typeof d&&"boolean"!==typeof d)throw new L("argument-error",jf+" property must be a boolean when specified.");this.g=!!d;if("undefined"!==typeof c&&("string"!==typeof c||"string"===typeof c&&!c.length))throw new L("argument-error",kf+" property must be a non empty string when specified.");this.b=c||null}else{if("undefined"!==typeof b)throw new L("argument-error",hf+" property must be a non empty string when specified.");if("undefined"!==typeof d||"undefined"!==typeof c)throw new L("missing-android-pkg-name")}}else if("undefined"!==typeof c)throw new L("argument-error",gf+" property must be a non null object when specified.");this.f=null;if((b=a[lf])&&"object"===typeof b)if(b=b[mf],"string"===typeof b&&b.length)this.f=b;else{if("undefined"!==typeof b)throw new L("argument-error",mf+" property must be a non empty string when specified.")}else if("undefined"!==typeof b)throw new L("argument-error",lf+" property must be a non null object when specified.");b=a[nf];if("undefined"!==typeof b&&"boolean"!==typeof b)throw new L("argument-error",nf+" property must be a boolean when specified.");this.c=!!b;a=a[of];if("undefined"!==typeof a&&("string"!==typeof a||"string"===typeof a&&!a.length))throw new L("argument-error",of+" property must be a non empty string when specified.");this.i=a||null}var gf="android",of="dynamicLinkDomain",nf="handleCodeInApp",lf="iOS",ff="url",jf="installApp",kf="minimumVersion",hf="packageName",mf="bundleId";function pf(a){var b={};b.continueUrl=a.h;b.canHandleCodeInApp=a.c;if(b.androidPackageName=a.a)b.androidMinimumVersion=a.b,b.androidInstallApp=a.g;b.iOSBundleId=a.f;b.dynamicLinkDomain=a.i;for(var c in b)null===b[c]&&delete b[c];return b}function qf(a){return Da(a,function(a){a=a.toString(16);return 1<a.length?a:"0"+a}).join("")}var rf=null,sf=null;function tf(a){var b="";uf(a,function(a){b+=String.fromCharCode(a)});return b}function uf(a,b){function c(b){for(;d<a.length;){var c=a.charAt(d++),e=sf[c];if(null!=e)return e;if(!/^[\s\xa0]*$/.test(c))throw Error("Unknown base64 encoding at char: "+c)}return b}vf();for(var d=0;;){var e=c(-1),f=c(0),h=c(64),m=c(64);if(64===m&&-1===e)break;b(e<<2|f>>4);64!=h&&(b(f<<4&240|h>>2),64!=m&&b(h<<6&192|m))}}function vf(){if(!rf){rf={};sf={};for(var a=0;65>a;a++)rf[a]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(a),sf[rf[a]]=a,62<=a&&(sf["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_.".charAt(a)]=a)}}function wf(a){this.c=a.sub;qa();this.a=a.provider_id||a.firebase&&a.firebase.sign_in_provider||null;this.b=!!a.is_anonymous||"anonymous"==this.a}wf.prototype.f=function(){return this.b};function xf(a){return(a=yf(a))&&a.sub&&a.iss&&a.aud&&a.exp?new wf(a):null}function yf(a){if(!a)return null;a=a.split(".");if(3!=a.length)return null;a=a[1];for(var b=(4-a.length%4)%4,c=0;c<b;c++)a+=".";try{return JSON.parse(tf(a))}catch(d){}return null}var zf={bd:{bb:"https://www.googleapis.com/identitytoolkit/v3/relyingparty/",jb:"https://securetoken.googleapis.com/v1/token",id:"p"},dd:{bb:"https://staging-www.sandbox.googleapis.com/identitytoolkit/v3/relyingparty/",jb:"https://staging-securetoken.sandbox.googleapis.com/v1/token",id:"s"},ed:{bb:"https://www-googleapis-test.sandbox.google.com/identitytoolkit/v3/relyingparty/",jb:"https://test-securetoken.sandbox.googleapis.com/v1/token",id:"t"}};function Af(a){for(var b in zf)if(zf[b].id===a)return a=zf[b],{firebaseEndpoint:a.bb,secureTokenEndpoint:a.jb};return null}var Bf;Bf=Af("__EID__")?"__EID__":void 0;var Cf="oauth_consumer_key oauth_nonce oauth_signature oauth_signature_method oauth_timestamp oauth_token oauth_version".split(" "),Df=["client_id","response_type","scope","redirect_uri","state"],Ef={Xc:{Na:"locale",Ba:500,Aa:600,Oa:"facebook.com",ib:Df},Zc:{Na:null,Ba:500,Aa:620,Oa:"github.com",ib:Df},$c:{Na:"hl",Ba:515,Aa:680,Oa:"google.com",ib:Df},fd:{Na:"lang",Ba:485,Aa:705,Oa:"twitter.com",ib:Cf}};function Ff(a){for(var b in Ef)if(Ef[b].Oa==a)return Ef[b];return null}function Gf(a){var b={};b["facebook.com"]=Hf;b["google.com"]=If;b["github.com"]=Jf;b["twitter.com"]=Kf;var c=a&&a[Lf];try{if(c)return b[c]?new b[c](a):new Mf(a);if("undefined"!==typeof a[Nf])return new Of(a)}catch(d){}return null}var Nf="idToken",Lf="providerId";function Of(a){var b=a[Lf];if(!b&&a[Nf]){var c=xf(a[Nf]);c&&c.a&&(b=c.a)}if(!b)throw Error("Invalid additional user info!");if("anonymous"==b||"custom"==b)b=null;c=!1;"undefined"!==typeof a.isNewUser?c=!!a.isNewUser:"identitytoolkit#SignupNewUserResponse"===a.kind&&(c=!0);J(this,"providerId",b);J(this,"isNewUser",c)}function Mf(a){Of.call(this,a);a=Be(a.rawUserInfo||"{}");J(this,"profile",Se(a||{}))}t(Mf,Of);function Hf(a){Mf.call(this,a);if("facebook.com"!=this.providerId)throw Error("Invalid provider ID!")}t(Hf,Mf);function Jf(a){Mf.call(this,a);if("github.com"!=this.providerId)throw Error("Invalid provider ID!");J(this,"username",this.profile&&this.profile.login||null)}t(Jf,Mf);function If(a){Mf.call(this,a);if("google.com"!=this.providerId)throw Error("Invalid provider ID!")}t(If,Mf);function Kf(a){Mf.call(this,a);if("twitter.com"!=this.providerId)throw Error("Invalid provider ID!");J(this,"username",a.screenName||null)}t(Kf,Mf);function Pf(a){this.a=ed(a)}function Qf(a){var b=ed(a),c=dd(b,"link"),d=dd(ed(c),"link");b=dd(b,"deep_link_id");return dd(ed(b),"link")||b||d||c||a}function Rf(a,b){return a.then(function(a){if(a[M]){var c=xf(a[M]);if(!c||b!=c.c)throw new L("user-mismatch");return a}throw new L("user-mismatch")}).s(function(a){throw a&&a.code&&a.code==bf+"user-not-found"?new L("user-mismatch"):a})}function Sf(a,b){if(b)this.a=b;else throw new L("internal-error","failed to construct a credential");J(this,"providerId",a);J(this,"signInMethod",a)}Sf.prototype.la=function(a){return Tf(a,Uf(this))};Sf.prototype.b=function(a,b){var c=Uf(this);c.idToken=b;return Vf(a,c)};Sf.prototype.f=function(a,b){return Rf(Wf(a,Uf(this)),b)};function Uf(a){return{pendingToken:a.a,requestUri:"http://localhost"}}Sf.prototype.C=function(){return{providerId:this.providerId,signInMethod:this.signInMethod,pendingToken:this.a}};function Xf(a,b,c){this.a=null;if(b.idToken||b.accessToken)b.idToken&&J(this,"idToken",b.idToken),b.accessToken&&J(this,"accessToken",b.accessToken),b.nonce&&!b.pendingToken&&J(this,"nonce",b.nonce),b.pendingToken&&(this.a=b.pendingToken);else if(b.oauthToken&&b.oauthTokenSecret)J(this,"accessToken",b.oauthToken),J(this,"secret",b.oauthTokenSecret);else throw new L("internal-error","failed to construct a credential");J(this,"providerId",a);J(this,"signInMethod",c)}Xf.prototype.la=function(a){return Tf(a,Yf(this))};Xf.prototype.b=function(a,b){var c=Yf(this);c.idToken=b;return Vf(a,c)};Xf.prototype.f=function(a,b){var c=Yf(this);return Rf(Wf(a,c),b)};function Yf(a){var b={};a.idToken&&(b.id_token=a.idToken);a.accessToken&&(b.access_token=a.accessToken);a.secret&&(b.oauth_token_secret=a.secret);b.providerId=a.providerId;a.nonce&&!a.a&&(b.nonce=a.nonce);b={postBody:id(b).toString(),requestUri:"http://localhost"};a.a&&(delete b.postBody,b.pendingToken=a.a);return b}Xf.prototype.C=function(){var a={providerId:this.providerId,signInMethod:this.signInMethod};this.idToken&&(a.oauthIdToken=this.idToken);this.accessToken&&(a.oauthAccessToken=this.accessToken);this.secret&&(a.oauthTokenSecret=this.secret);this.nonce&&(a.nonce=this.nonce);this.a&&(a.pendingToken=this.a);return a};function Zf(a,b){this.Fc=b||[];K(this,{providerId:a,isOAuthProvider:!0});this.zb={};this.eb=(Ff(a)||{}).Na||null;this.ab=null}Zf.prototype.Da=function(a){this.zb=Za(a);return this};function $f(a){if("string"!==typeof a||0!=a.indexOf("saml."))throw new L("argument-error",'SAML provider IDs must be prefixed with "saml."');Zf.call(this,a,[])}t($f,Zf);function N(a){Zf.call(this,a,Df);this.a=[]}t(N,Zf);N.prototype.ua=function(a){Ha(this.a,a)||this.a.push(a);return this};N.prototype.Fb=function(){return Ka(this.a)};N.prototype.credential=function(a,b,c){if(!a&&!b)throw new L("argument-error","credential failed: must provide the ID token and/or the access token.");return new Xf(this.providerId,{idToken:a||null,accessToken:b||null,nonce:c||null},this.providerId)};function ag(){N.call(this,"facebook.com")}t(ag,N);J(ag,"PROVIDER_ID","facebook.com");J(ag,"FACEBOOK_SIGN_IN_METHOD","facebook.com");function bg(a){if(!a)throw new L("argument-error","credential failed: expected 1 argument (the OAuth access token).");var b=a;q(a)&&(b=a.accessToken);return(new ag).credential(null,b)}function cg(){N.call(this,"github.com")}t(cg,N);J(cg,"PROVIDER_ID","github.com");J(cg,"GITHUB_SIGN_IN_METHOD","github.com");function dg(a){if(!a)throw new L("argument-error","credential failed: expected 1 argument (the OAuth access token).");var b=a;q(a)&&(b=a.accessToken);return(new cg).credential(null,b)}function eg(){N.call(this,"google.com");this.ua("profile")}t(eg,N);J(eg,"PROVIDER_ID","google.com");J(eg,"GOOGLE_SIGN_IN_METHOD","google.com");function fg(a,b){var c=a;q(a)&&(c=a.idToken,b=a.accessToken);return(new eg).credential(c,b)}function gg(){Zf.call(this,"twitter.com",Cf)}t(gg,Zf);J(gg,"PROVIDER_ID","twitter.com");J(gg,"TWITTER_SIGN_IN_METHOD","twitter.com");function hg(a,b){var c=a;q(c)||(c={oauthToken:a,oauthTokenSecret:b});if(!c.oauthToken||!c.oauthTokenSecret)throw new L("argument-error","credential failed: expected 2 arguments (the OAuth access token and secret).");return new Xf("twitter.com",c,"twitter.com")}function ig(a,b,c){this.a=a;this.c=b;J(this,"providerId","password");J(this,"signInMethod",c===O.EMAIL_LINK_SIGN_IN_METHOD?O.EMAIL_LINK_SIGN_IN_METHOD:O.EMAIL_PASSWORD_SIGN_IN_METHOD)}ig.prototype.la=function(a){return this.signInMethod==O.EMAIL_LINK_SIGN_IN_METHOD?P(a,jg,{email:this.a,oobCode:this.c}):P(a,kg,{email:this.a,password:this.c})};ig.prototype.b=function(a,b){return this.signInMethod==O.EMAIL_LINK_SIGN_IN_METHOD?P(a,lg,{idToken:b,email:this.a,oobCode:this.c}):P(a,mg,{idToken:b,email:this.a,password:this.c})};ig.prototype.f=function(a,b){return Rf(this.la(a),b)};ig.prototype.C=function(){return{email:this.a,password:this.c,signInMethod:this.signInMethod}};function O(){K(this,{providerId:"password",isOAuthProvider:!1})}function ng(a,b){b=og(b);if(!b)throw new L("argument-error","Invalid email link!");return new ig(a,b,O.EMAIL_LINK_SIGN_IN_METHOD)}function og(a){a=Qf(a);a=new Pf(a);var b=dd(a.a,"oobCode")||null;return"signIn"===(dd(a.a,"mode")||null)&&b?b:null}K(O,{PROVIDER_ID:"password"});K(O,{EMAIL_LINK_SIGN_IN_METHOD:"emailLink"});K(O,{EMAIL_PASSWORD_SIGN_IN_METHOD:"password"});function pg(a){if(!(a.Ua&&a.Ta||a.Fa&&a.$))throw new L("internal-error");this.a=a;J(this,"providerId","phone");J(this,"signInMethod","phone")}pg.prototype.la=function(a){return a.Va(qg(this))};pg.prototype.b=function(a,b){var c=qg(this);c.idToken=b;return P(a,rg,c)};pg.prototype.f=function(a,b){var c=qg(this);c.operation="REAUTH";a=P(a,sg,c);return Rf(a,b)};pg.prototype.C=function(){var a={providerId:"phone"};this.a.Ua&&(a.verificationId=this.a.Ua);this.a.Ta&&(a.verificationCode=this.a.Ta);this.a.Fa&&(a.temporaryProof=this.a.Fa);this.a.$&&(a.phoneNumber=this.a.$);return a};function qg(a){return a.a.Fa&&a.a.$?{temporaryProof:a.a.Fa,phoneNumber:a.a.$}:{sessionInfo:a.a.Ua,code:a.a.Ta}}function tg(a){try{this.a=a||firebase.auth()}catch(b){throw new L("argument-error","Either an instance of firebase.auth.Auth must be passed as an argument to the firebase.auth.PhoneAuthProvider constructor, or the default firebase App instance must be initialized via firebase.initializeApp().")}K(this,{providerId:"phone",isOAuthProvider:!1})}tg.prototype.Va=function(a,b){var c=this.a.b;return B(b.verify()).then(function(d){if(!l(d))throw new L("argument-error","An implementation of firebase.auth.ApplicationVerifier.prototype.verify() must return a firebase.Promise that resolves with a string.");switch(b.type){case"recaptcha":return ug(c,{phoneNumber:a,recaptchaToken:d}).then(function(a){"function"===typeof b.reset&&b.reset();return a},function(a){"function"===typeof b.reset&&b.reset();throw a});default:throw new L("argument-error",'Only firebase.auth.ApplicationVerifiers with type="recaptcha" are currently supported.')}})};function vg(a,b){if(!a)throw new L("missing-verification-id");if(!b)throw new L("missing-verification-code");return new pg({Ua:a,Ta:b})}K(tg,{PROVIDER_ID:"phone"});K(tg,{PHONE_SIGN_IN_METHOD:"phone"});function wg(a){if(a.temporaryProof&&a.phoneNumber)return new pg({Fa:a.temporaryProof,$:a.phoneNumber});var b=a&&a.providerId;if(!b||"password"===b)return null;var c=a&&a.oauthAccessToken,d=a&&a.oauthTokenSecret,e=a&&a.nonce,f=a&&a.oauthIdToken,h=a&&a.pendingToken;try{switch(b){case"google.com":return fg(f,c);case"facebook.com":return bg(c);case"github.com":return dg(c);case"twitter.com":return hg(c,d);default:return c||d||f||h?h?0==b.indexOf("saml.")?new Sf(b,h):new Xf(b,{pendingToken:h,idToken:a.oauthIdToken,accessToken:a.oauthAccessToken},b):new N(b).credential(f,c,e):null}}catch(m){return null}}function xg(a){if(!a.isOAuthProvider)throw new L("invalid-oauth-provider")}function yg(a,b,c,d,e,f){this.b=a;this.c=b||null;this.f=c||null;this.g=d||null;this.h=f||null;this.a=e||null;if(this.f||this.a){if(this.f&&this.a)throw new L("invalid-auth-event");if(this.f&&!this.g)throw new L("invalid-auth-event")}else throw new L("invalid-auth-event")}yg.prototype.C=function(){return{type:this.b,eventId:this.c,urlResponse:this.f,sessionId:this.g,postBody:this.h,error:this.a&&this.a.C()}};function zg(a){a=a||{};return a.type?new yg(a.type,a.eventId,a.urlResponse,a.sessionId,a.error&&df(a.error),a.postBody):null}function Ag(){this.b=null;this.a=[]}var Bg=null;Ag.prototype.subscribe=function(a){var b=this;this.a.push(a);this.b||(this.b=function(a){for(var c=0;c<b.a.length;c++)b.a[c](a)},a=I("universalLinks.subscribe",k),"function"===typeof a&&a(null,this.b))};Ag.prototype.unsubscribe=function(a){w(this.a,function(b){return b==a})};function Cg(a){var b="unauthorized-domain",c=void 0,d=ed(a);a=d.b;d=d.c;"chrome-extension"==d?c=bb("This chrome extension ID (chrome-extension://%s) is not authorized to run this operation. Add it to the OAuth redirect domains list in the Firebase console -> Auth section -> Sign in method tab.",a):"http"==d||"https"==d?c=bb("This domain (%s) is not authorized to run this operation. Add it to the OAuth redirect domains list in the Firebase console -> Auth section -> Sign in method tab.",a):b="operation-not-supported-in-this-environment";L.call(this,b,c)}t(Cg,L);function Dg(a,b,c){L.call(this,a,c);a=b||{};a.Ab&&J(this,"email",a.Ab);a.$&&J(this,"phoneNumber",a.$);a.credential&&J(this,"credential",a.credential)}t(Dg,L);Dg.prototype.C=function(){var a={code:this.code,message:this.message};this.email&&(a.email=this.email);this.phoneNumber&&(a.phoneNumber=this.phoneNumber);var b=this.credential&&this.credential.C();b&&ab(a,b);return a};Dg.prototype.toJSON=function(){return this.C()};function Eg(a){if(a.code){var b=a.code||"";0==b.indexOf(bf)&&(b=b.substring(bf.length));var c={credential:wg(a)};if(a.email)c.Ab=a.email;else if(a.phoneNumber)c.$=a.phoneNumber;else if(!c.credential)return new L(b,a.message||void 0);return new Dg(b,c,a.message)}return null}function Fg(){}Fg.prototype.c=null;function Gg(a){return a.c||(a.c=a.b())}var Hg;function Ig(){}t(Ig,Fg);Ig.prototype.a=function(){var a=Jg(this);return a?new ActiveXObject(a):new XMLHttpRequest};Ig.prototype.b=function(){var a={};Jg(this)&&(a[0]=!0,a[1]=!0);return a};function Jg(a){if(!a.f&&"undefined"==typeof XMLHttpRequest&&"undefined"!=typeof ActiveXObject){for(var b=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"],c=0;c<b.length;c++){var d=b[c];try{return new ActiveXObject(d),a.f=d}catch(e){}}throw Error("Could not create ActiveXObject. ActiveX might be disabled, or MSXML might not be installed")}return a.f}Hg=new Ig;function Kg(){}t(Kg,Fg);Kg.prototype.a=function(){var a=new XMLHttpRequest;if("withCredentials"in a)return a;if("undefined"!=typeof XDomainRequest)return new Lg;throw Error("Unsupported browser")};Kg.prototype.b=function(){return{}};function Lg(){this.a=new XDomainRequest;this.readyState=0;this.onreadystatechange=null;this.responseType=this.responseText=this.response="";this.status=-1;this.statusText="";this.a.onload=r(this.fc,this);this.a.onerror=r(this.Gb,this);this.a.onprogress=r(this.gc,this);this.a.ontimeout=r(this.kc,this)}g=Lg.prototype;g.open=function(a,b,c){if(null!=c&&!c)throw Error("Only async requests are supported.");this.a.open(a,b)};g.send=function(a){if(a)if("string"==typeof a)this.a.send(a);else throw Error("Only string data is supported");else this.a.send()};g.abort=function(){this.a.abort()};g.setRequestHeader=function(){};g.getResponseHeader=function(a){return"content-type"==a.toLowerCase()?this.a.contentType:""};g.fc=function(){this.status=200;this.response=this.responseText=this.a.responseText;Mg(this,4)};g.Gb=function(){this.status=500;this.response=this.responseText="";Mg(this,4)};g.kc=function(){this.Gb()};g.gc=function(){this.status=200;Mg(this,1)};function Mg(a,b){a.readyState=b;if(a.onreadystatechange)a.onreadystatechange()}g.getAllResponseHeaders=function(){return"content-type: "+this.a.contentType};function Ng(a,b,c){this.reset(a,b,c,void 0,void 0)}Ng.prototype.a=null;var Og=0;Ng.prototype.reset=function(a,b,c,d,e){"number"==typeof e||Og++;d||qa();delete this.a};function Pg(a){this.f=a;this.b=this.c=this.a=null}function Qg(a,b){this.name=a;this.value=b}Qg.prototype.toString=function(){return this.name};var Rg=new Qg("SEVERE",1e3),Sg=new Qg("WARNING",900),Tg=new Qg("CONFIG",700),Ug=new Qg("FINE",500);function Vg(a){if(a.c)return a.c;if(a.a)return Vg(a.a);ta("Root logger has no level set.");return null}Pg.prototype.log=function(a,b,c){if(a.value>=Vg(this).value)for(n(b)&&(b=b()),a=new Ng(a,String(b),this.f),c&&(a.a=c),c=this;c;)c=c.a};var Wg={},Xg=null;function Yg(a){Xg||(Xg=new Pg(""),Wg[""]=Xg,Xg.c=Tg);var b;if(!(b=Wg[a])){b=new Pg(a);var c=a.lastIndexOf("."),d=a.substr(c+1);c=Yg(a.substr(0,c));c.b||(c.b={});c.b[d]=b;b.a=c;Wg[a]=b}return b}function Zg(a,b){a&&a.log(Ug,b,void 0)}function $g(a){this.f=a}t($g,Fg);$g.prototype.a=function(){return new ah(this.f)};$g.prototype.b=function(a){return function(){return a}}({});function ah(a){F.call(this);this.u=a;this.readyState=bh;this.status=0;this.responseType=this.responseText=this.response=this.statusText="";this.onreadystatechange=null;this.i=new Headers;this.b=null;this.m="GET";this.g="";this.a=!1;this.h=Yg("goog.net.FetchXmlHttp");this.l=this.c=this.f=null}t(ah,F);var bh=0;g=ah.prototype;g.open=function(a,b){if(this.readyState!=bh)throw this.abort(),Error("Error reopening a connection");this.m=a;this.g=b;this.readyState=1;ch(this)};g.send=function(a){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.a=!0;var b={headers:this.i,method:this.m,credentials:void 0,cache:void 0};a&&(b.body=a);this.u.fetch(new Request(this.g,b)).then(this.jc.bind(this),this.La.bind(this))};g.abort=function(){this.response=this.responseText="";this.i=new Headers;this.status=0;this.c&&this.c.cancel("Request was aborted.");1<=this.readyState&&this.a&&4!=this.readyState&&(this.a=!1,dh(this,!1));this.readyState=bh};g.jc=function(a){this.a&&(this.f=a,this.b||(this.b=a.headers,this.readyState=2,ch(this)),this.a&&(this.readyState=3,ch(this),this.a&&("arraybuffer"===this.responseType?a.arrayBuffer().then(this.hc.bind(this),this.La.bind(this)):"undefined"!==typeof k.ReadableStream&&"body"in a?(this.response=this.responseText="",this.c=a.body.getReader(),this.l=new TextDecoder,eh(this)):a.text().then(this.ic.bind(this),this.La.bind(this)))))};function eh(a){a.c.read().then(a.ec.bind(a)).catch(a.La.bind(a))}g.ec=function(a){if(this.a){var b=this.l.decode(a.value?a.value:new Uint8Array(0),{stream:!a.done});b&&(this.response=this.responseText+=b);a.done?dh(this,!0):ch(this);3==this.readyState&&eh(this)}};g.ic=function(a){this.a&&(this.response=this.responseText=a,dh(this,!0))};g.hc=function(a){this.a&&(this.response=a,dh(this,!0))};g.La=function(a){var b=this.h;b&&b.log(Sg,"Failed to fetch url "+this.g,a instanceof Error?a:Error(a));this.a&&dh(this,!0)};function dh(a,b){b&&a.f&&(a.status=a.f.status,a.statusText=a.f.statusText);a.readyState=4;a.f=null;a.c=null;a.l=null;ch(a)}g.setRequestHeader=function(a,b){this.i.append(a,b)};g.getResponseHeader=function(a){return this.b?this.b.get(a.toLowerCase())||"":((a=this.h)&&a.log(Sg,"Attempting to get response header but no headers have been received for url: "+this.g,void 0),"")};g.getAllResponseHeaders=function(){if(!this.b){var a=this.h;a&&a.log(Sg,"Attempting to get all response headers but no headers have been received for url: "+this.g,void 0);return""}a=[];for(var b=this.b.entries(),c=b.next();!c.done;)c=c.value,a.push(c[0]+": "+c[1]),c=b.next();return a.join("\r\n")};function ch(a){a.onreadystatechange&&a.onreadystatechange.call(a)}function fh(a){F.call(this);this.headers=new Mc;this.D=a||null;this.c=!1;this.w=this.a=null;this.h=this.N=this.l="";this.f=this.I=this.i=this.G=!1;this.g=0;this.u=null;this.m=gh;this.v=this.O=!1}t(fh,F);var gh="";fh.prototype.b=Yg("goog.net.XhrIo");var hh=/^https?$/i,ih=["POST","PUT"];function jh(a,b,c,d,e){if(a.a)throw Error("[goog.net.XhrIo] Object is active with another request="+a.l+"; newUri="+b);c=c?c.toUpperCase():"GET";a.l=b;a.h="";a.N=c;a.G=!1;a.c=!0;a.a=a.D?a.D.a():Hg.a();a.w=a.D?Gg(a.D):Gg(Hg);a.a.onreadystatechange=r(a.Jb,a);try{Zg(a.b,kh(a,"Opening Xhr")),a.I=!0,a.a.open(c,String(b),!0),a.I=!1}catch(h){Zg(a.b,kh(a,"Error opening Xhr: "+h.message));lh(a,h);return}b=d||"";var f=new Mc(a.headers);e&&Lc(e,function(a,b){f.set(b,a)});e=Fa(f.U());d=k.FormData&&b instanceof k.FormData;!Ha(ih,c)||e||d||f.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");f.forEach(function(a,b){this.a.setRequestHeader(b,a)},a);a.m&&(a.a.responseType=a.m);"withCredentials"in a.a&&a.a.withCredentials!==a.O&&(a.a.withCredentials=a.O);try{mh(a),0<a.g&&(a.v=nh(a.a),Zg(a.b,kh(a,"Will abort after "+a.g+"ms if incomplete, xhr2 "+a.v)),a.v?(a.a.timeout=a.g,a.a.ontimeout=r(a.Ga,a)):a.u=Hc(a.Ga,a.g,a)),Zg(a.b,kh(a,"Sending request")),a.i=!0,a.a.send(b),a.i=!1}catch(h){Zg(a.b,kh(a,"Send error: "+h.message)),lh(a,h)}}function nh(a){return Qb&&$b(9)&&"number"==typeof a.timeout&&void 0!==a.ontimeout}function Ga(a){return"content-type"==a.toLowerCase()}g=fh.prototype;g.Ga=function(){"undefined"!=typeof aa&&this.a&&(this.h="Timed out after "+this.g+"ms, aborting",Zg(this.b,kh(this,this.h)),this.dispatchEvent("timeout"),this.abort(8))};function lh(a,b){a.c=!1;a.a&&(a.f=!0,a.a.abort(),a.f=!1);a.h=b;oh(a);ph(a)}function oh(a){a.G||(a.G=!0,a.dispatchEvent("complete"),a.dispatchEvent("error"))}g.abort=function(){this.a&&this.c&&(Zg(this.b,kh(this,"Aborting")),this.c=!1,this.f=!0,this.a.abort(),this.f=!1,this.dispatchEvent("complete"),this.dispatchEvent("abort"),ph(this))};g.va=function(){this.a&&(this.c&&(this.c=!1,this.f=!0,this.a.abort(),this.f=!1),ph(this,!0));fh.pb.va.call(this)};g.Jb=function(){this.qa||(this.I||this.i||this.f?qh(this):this.yc())};g.yc=function(){qh(this)};function qh(a){if(a.c&&"undefined"!=typeof aa)if(a.w[1]&&4==rh(a)&&2==sh(a))Zg(a.b,kh(a,"Local request error detected and ignored"));else if(a.i&&4==rh(a))Hc(a.Jb,0,a);else if(a.dispatchEvent("readystatechange"),4==rh(a)){Zg(a.b,kh(a,"Request complete"));a.c=!1;try{var b=sh(a);a:switch(b){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var c=!0;break a;default:c=!1}var d;if(!(d=c)){var e;if(e=0===b){var f=String(a.l).match(Pc)[1]||null;if(!f&&k.self&&k.self.location){var h=k.self.location.protocol;f=h.substr(0,h.length-1)}e=!hh.test(f?f.toLowerCase():"")}d=e}if(d)a.dispatchEvent("complete"),a.dispatchEvent("success");else{try{var m=2<rh(a)?a.a.statusText:""}catch(p){Zg(a.b,"Can not get status: "+p.message),m=""}a.h=m+" ["+sh(a)+"]";oh(a)}}finally{ph(a)}}}function ph(a,b){if(a.a){mh(a);var c=a.a,d=a.w[0]?ea:null;a.a=null;a.w=null;b||a.dispatchEvent("ready");try{c.onreadystatechange=d}catch(e){(a=a.b)&&a.log(Rg,"Problem encountered resetting onreadystatechange: "+e.message,void 0)}}}function mh(a){a.a&&a.v&&(a.a.ontimeout=null);a.u&&(k.clearTimeout(a.u),a.u=null)}function rh(a){return a.a?a.a.readyState:0}function sh(a){try{return 2<rh(a)?a.a.status:-1}catch(b){return-1}}function th(a){try{return a.a?a.a.responseText:""}catch(b){return Zg(a.b,"Can not get responseText: "+b.message),""}}g.getResponse=function(){try{if(!this.a)return null;if("response"in this.a)return this.a.response;switch(this.m){case gh:case"text":return this.a.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in this.a)return this.a.mozResponseArrayBuffer}var a=this.b;a&&a.log(Rg,"Response type "+this.m+" is not supported on this browser",void 0);return null}catch(b){return Zg(this.b,"Can not get response: "+b.message),null}};function kh(a,b){return b+" ["+a.N+" "+a.l+" "+sh(a)+"]"}function uh(a){var b=vh;this.g=[];this.v=b;this.u=a||null;this.f=this.a=!1;this.c=void 0;this.l=this.w=this.i=!1;this.h=0;this.b=null;this.o=0}uh.prototype.cancel=function(a){if(this.a)this.c instanceof uh&&this.c.cancel();else{if(this.b){var b=this.b;delete this.b;a?b.cancel(a):(b.o--,0>=b.o&&b.cancel())}this.v?this.v.call(this.u,this):this.l=!0;this.a||(a=new wh(this),xh(this),yh(this,!1,a))}};uh.prototype.m=function(a,b){this.i=!1;yh(this,a,b)};function yh(a,b,c){a.a=!0;a.c=c;a.f=!b;zh(a)}function xh(a){if(a.a){if(!a.l)throw new Ah(a);a.l=!1}}function Bh(a,b){Ch(a,null,b,void 0)}function Ch(a,b,c,d){a.g.push([b,c,d]);a.a&&zh(a)}uh.prototype.then=function(a,b,c){var d,e,f=new A(function(a,b){d=a;e=b});Ch(this,d,function(a){a instanceof wh?f.cancel():e(a)});return f.then(a,b,c)};uh.prototype.$goog_Thenable=!0;function Dh(a){return Ea(a.g,function(a){return n(a[1])})}function zh(a){if(a.h&&a.a&&Dh(a)){var b=a.h,c=Eh[b];c&&(k.clearTimeout(c.a),delete Eh[b]);a.h=0}a.b&&(a.b.o--,delete a.b);b=a.c;for(var d=c=!1;a.g.length&&!a.i;){var e=a.g.shift(),f=e[0],h=e[1];e=e[2];if(f=a.f?h:f)try{var m=f.call(e||a.u,b);void 0!==m&&(a.f=a.f&&(m==b||m instanceof Error),a.c=b=m);if(ra(b)||"function"===typeof k.Promise&&b instanceof k.Promise)d=!0,a.i=!0}catch(p){b=p,a.f=!0,Dh(a)||(c=!0)}}a.c=b;d&&(m=r(a.m,a,!0),d=r(a.m,a,!1),b instanceof uh?(Ch(b,m,d),b.w=!0):b.then(m,d));c&&(b=new Fh(b),Eh[b.a]=b,a.h=b.a)}function Ah(){u.call(this)}t(Ah,u);Ah.prototype.message="Deferred has already fired";Ah.prototype.name="AlreadyCalledError";function wh(){u.call(this)}t(wh,u);wh.prototype.message="Deferred was canceled";wh.prototype.name="CanceledError";function Fh(a){this.a=k.setTimeout(r(this.c,this),0);this.b=a}Fh.prototype.c=function(){delete Eh[this.a];throw this.b};var Eh={};function Gh(a){var b={},c=b.document||document,d=ud(a),e=document.createElement("SCRIPT"),f={Lb:e,Ga:void 0},h=new uh(f),m=null,p=null!=b.timeout?b.timeout:5e3;0<p&&(m=window.setTimeout(function(){Hh(e,!0);var a=new Ih(Jh,"Timeout reached for loading script "+d);xh(h);yh(h,!1,a)},p),f.Ga=m);e.onload=e.onreadystatechange=function(){e.readyState&&"loaded"!=e.readyState&&"complete"!=e.readyState||(Hh(e,b.hd||!1,m),xh(h),yh(h,!0,null))};e.onerror=function(){Hh(e,!0,m);var a=new Ih(Kh,"Error while loading script "+d);xh(h);yh(h,!1,a)};f=b.attributes||{};ab(f,{type:"text/javascript",charset:"UTF-8"});Ld(e,f);Jd(e,a);Lh(c).appendChild(e);return h}function Lh(a){var b;return(b=(a||document).getElementsByTagName("HEAD"))&&0!=b.length?b[0]:a.documentElement}function vh(){if(this&&this.Lb){var a=this.Lb;a&&"SCRIPT"==a.tagName&&Hh(a,!0,this.Ga)}}function Hh(a,b,c){null!=c&&k.clearTimeout(c);a.onload=ea;a.onerror=ea;a.onreadystatechange=ea;b&&window.setTimeout(function(){a&&a.parentNode&&a.parentNode.removeChild(a)},0)}var Kh=0,Jh=1;function Ih(a,b){var c="Jsloader error (code #"+a+")";b&&(c+=": "+b);u.call(this,c);this.code=a}t(Ih,u);function Mh(a){this.f=a}t(Mh,Fg);Mh.prototype.a=function(){return new this.f};Mh.prototype.b=function(){return{}};function Nh(a,b,c){this.b=a;a=b||{};this.i=a.secureTokenEndpoint||"https://securetoken.googleapis.com/v1/token";this.o=a.secureTokenTimeout||Oh;this.f=Za(a.secureTokenHeaders||Ph);this.g=a.firebaseEndpoint||"https://www.googleapis.com/identitytoolkit/v3/relyingparty/";this.h=a.firebaseTimeout||Qh;this.a=Za(a.firebaseHeaders||Rh);c&&(this.a["X-Client-Version"]=c,this.f["X-Client-Version"]=c);c="Node"==pe();c=k.XMLHttpRequest||c&&firebase.INTERNAL.node&&firebase.INTERNAL.node.XMLHttpRequest;if(!c&&!oe())throw new L("internal-error","The XMLHttpRequest compatibility library was not found.");this.c=void 0;oe()?this.c=new $g(self):qe()?this.c=new Mh(c):this.c=new Kg}var Sh,M="idToken",Oh=new Ee(3e4,6e4),Ph={"Content-Type":"application/x-www-form-urlencoded"},Qh=new Ee(3e4,6e4),Rh={"Content-Type":"application/json"};function Th(a,b){b?a.a["X-Firebase-Locale"]=b:delete a.a["X-Firebase-Locale"]}function Uh(a,b){b?(a.a["X-Client-Version"]=b,a.f["X-Client-Version"]=b):(delete a.a["X-Client-Version"],delete a.f["X-Client-Version"])}function Vh(a,b,c,d,e,f,h){$d()||oe()?a=r(a.m,a):(Sh||(Sh=new A(function(a,b){Wh(a,b)})),a=r(a.l,a));a(b,c,d,e,f,h)}Nh.prototype.m=function(a,b,c,d,e,f){if(oe()&&("undefined"===typeof k.fetch||"undefined"===typeof k.Headers||"undefined"===typeof k.Request))throw new L("operation-not-supported-in-this-environment","fetch, Headers and Request native APIs or equivalent Polyfills must be available to support HTTP requests from a Worker environment.");var h=new fh(this.c);if(f){h.g=Math.max(0,f);var m=setTimeout(function(){h.dispatchEvent("timeout")},f)}vc(h,"complete",function(){m&&clearTimeout(m);var a=null;try{a=JSON.parse(th(this))||null}catch(x){a=null}b&&b(a)});Bc(h,"ready",function(){m&&clearTimeout(m);Lb(this)});Bc(h,"timeout",function(){m&&clearTimeout(m);Lb(this);b&&b(null)});jh(h,a,c,d,e)};var Xh=new od(pd,"https://apis.google.com/js/client.js?onload=%{onload}"),Yh="__fcb"+Math.floor(1e6*Math.random()).toString();function Wh(a,b){if(((window.gapi||{}).client||{}).request)a();else{k[Yh]=function(){((window.gapi||{}).client||{}).request?a():b(Error("CORS_UNSUPPORTED"))};var c=vd(Xh,{onload:Yh});Bh(Gh(c),function(){b(Error("CORS_UNSUPPORTED"))})}}Nh.prototype.l=function(a,b,c,d,e){var f=this;Sh.then(function(){window.gapi.client.setApiKey(f.b);var h=window.gapi.auth.getToken();window.gapi.auth.setToken(null);window.gapi.client.request({path:a,method:c,body:d,headers:e,authType:"none",callback:function(a){window.gapi.auth.setToken(h);b&&b(a)}})}).s(function(a){b&&b({error:{message:a&&a.message||"CORS_UNSUPPORTED"}})})};function Zh(a,b){return new A(function(c,d){"refresh_token"==b.grant_type&&b.refresh_token||"authorization_code"==b.grant_type&&b.code?Vh(a,a.i+"?key="+encodeURIComponent(a.b),function(a){a?a.error?d($h(a)):a.access_token&&a.refresh_token?c(a):d(new L("internal-error")):d(new L("network-request-failed"))},"POST",id(b).toString(),a.f,a.o.get()):d(new L("internal-error"))})}function ai(a,b,c,d,e,f){var h=ed(a.g+b);G(h,"key",a.b);f&&G(h,"cb",qa().toString());var m="GET"==c;if(m)for(var p in d)d.hasOwnProperty(p)&&G(h,p,d[p]);return new A(function(b,f){Vh(a,h.toString(),function(a){a?a.error?f($h(a,e||{})):b(a):f(new L("network-request-failed"))},c,m?void 0:Qd(Ae(d)),a.a,a.h.get())})}function bi(a){a=a.email;if(!l(a)||!ie.test(a))throw new L("invalid-email")}function ci(a){"email"in a&&bi(a)}function di(a,b){return P(a,ei,{identifier:b,continueUri:xe()?Xd():"http://localhost"}).then(function(a){return a.allProviders||[]})}function fi(a,b){return P(a,ei,{identifier:b,continueUri:xe()?Xd():"http://localhost"}).then(function(a){return a.signinMethods||[]})}function gi(a){return P(a,hi,{}).then(function(a){return a.authorizedDomains||[]})}function ii(a){if(!a[M])throw new L("internal-error")}function ji(a){if(a.phoneNumber||a.temporaryProof){if(!a.phoneNumber||!a.temporaryProof)throw new L("internal-error")}else{if(!a.sessionInfo)throw new L("missing-verification-id");if(!a.code)throw new L("missing-verification-code")}}Nh.prototype.Ra=function(){return P(this,ki,{})};Nh.prototype.qb=function(a,b){return P(this,li,{idToken:a,email:b})};Nh.prototype.rb=function(a,b){return P(this,mg,{idToken:a,password:b})};var mi={displayName:"DISPLAY_NAME",photoUrl:"PHOTO_URL"};g=Nh.prototype;g.sb=function(a,b){var c={idToken:a},d=[];Xa(mi,function(a,f){var e=b[f];null===e?d.push(a):f in b&&(c[f]=e)});d.length&&(c.deleteAttribute=d);return P(this,li,c)};g.lb=function(a,b){a={requestType:"PASSWORD_RESET",email:a};ab(a,b);return P(this,ni,a)};g.mb=function(a,b){a={requestType:"EMAIL_SIGNIN",email:a};ab(a,b);return P(this,oi,a)};g.kb=function(a,b){a={requestType:"VERIFY_EMAIL",idToken:a};ab(a,b);return P(this,pi,a)};function ug(a,b){return P(a,qi,b)}g.Va=function(a){return P(this,ri,a)};function si(a,b,c){return P(a,ti,{idToken:b,deleteProvider:c})}function ui(a){if(!a.requestUri||!a.sessionId&&!a.postBody&&!a.pendingToken)throw new L("internal-error")}function vi(a,b){b.oauthIdToken&&b.providerId&&0==b.providerId.indexOf("oidc.")&&!b.pendingToken&&(a.sessionId?b.nonce=a.sessionId:a.postBody&&(a=new Uc(a.postBody),md(a,"nonce")&&(b.nonce=a.get("nonce"))));return b}function wi(a){var b=null;a.needConfirmation?(a.code="account-exists-with-different-credential",b=Eg(a)):"FEDERATED_USER_ID_ALREADY_LINKED"==a.errorMessage?(a.code="credential-already-in-use",b=Eg(a)):"EMAIL_EXISTS"==a.errorMessage?(a.code="email-already-in-use",b=Eg(a)):a.errorMessage&&(b=xi(a.errorMessage));if(b)throw b;if(!a[M])throw new L("internal-error")}function Tf(a,b){b.returnIdpCredential=!0;return P(a,yi,b)}function Vf(a,b){b.returnIdpCredential=!0;return P(a,zi,b)}function Wf(a,b){b.returnIdpCredential=!0;b.autoCreate=!1;return P(a,Ai,b)}function Bi(a){if(!a.oobCode)throw new L("invalid-action-code")}g.$a=function(a,b){return P(this,Ci,{oobCode:a,newPassword:b})};g.Ja=function(a){return P(this,Di,{oobCode:a})};g.Xa=function(a){return P(this,Ei,{oobCode:a})};var Ei={endpoint:"setAccountInfo",B:Bi,da:"email"},Di={endpoint:"resetPassword",B:Bi,J:function(a){var b=a.requestType;if(!b||!a.email&&"EMAIL_SIGNIN"!=b)throw new L("internal-error")}},Fi={endpoint:"signupNewUser",B:function(a){bi(a);if(!a.password)throw new L("weak-password")},J:ii,R:!0},ei={endpoint:"createAuthUri"},Gi={endpoint:"deleteAccount",T:["idToken"]},ti={endpoint:"setAccountInfo",T:["idToken","deleteProvider"],B:function(a){if(!ia(a.deleteProvider))throw new L("internal-error")}},jg={endpoint:"emailLinkSignin",T:["email","oobCode"],B:bi,J:ii,R:!0},lg={endpoint:"emailLinkSignin",T:["idToken","email","oobCode"],B:bi,J:ii,R:!0},Hi={endpoint:"getAccountInfo"},oi={endpoint:"getOobConfirmationCode",T:["requestType"],B:function(a){if("EMAIL_SIGNIN"!=a.requestType)throw new L("internal-error");bi(a)},da:"email"},pi={endpoint:"getOobConfirmationCode",T:["idToken","requestType"],B:function(a){if("VERIFY_EMAIL"!=a.requestType)throw new L("internal-error")},da:"email"},ni={endpoint:"getOobConfirmationCode",T:["requestType"],B:function(a){if("PASSWORD_RESET"!=a.requestType)throw new L("internal-error");bi(a)},da:"email"},hi={vb:!0,endpoint:"getProjectConfig",Ib:"GET"},Ii={vb:!0,endpoint:"getRecaptchaParam",Ib:"GET",J:function(a){if(!a.recaptchaSiteKey)throw new L("internal-error")}},Ci={endpoint:"resetPassword",B:Bi,da:"email"},qi={endpoint:"sendVerificationCode",T:["phoneNumber","recaptchaToken"],da:"sessionInfo"},li={endpoint:"setAccountInfo",T:["idToken"],B:ci,R:!0},mg={endpoint:"setAccountInfo",T:["idToken"],B:function(a){ci(a);if(!a.password)throw new L("weak-password")},J:ii,R:!0},ki={endpoint:"signupNewUser",J:ii,R:!0},yi={endpoint:"verifyAssertion",B:ui,Pa:vi,J:wi,R:!0},Ai={endpoint:"verifyAssertion",B:ui,Pa:vi,J:function(a){if(a.errorMessage&&"USER_NOT_FOUND"==a.errorMessage)throw new L("user-not-found");if(a.errorMessage)throw xi(a.errorMessage);if(!a[M])throw new L("internal-error")},R:!0},zi={endpoint:"verifyAssertion",B:function(a){ui(a);if(!a.idToken)throw new L("internal-error")},Pa:vi,J:wi,R:!0},Ji={endpoint:"verifyCustomToken",B:function(a){if(!a.token)throw new L("invalid-custom-token")},J:ii,R:!0},kg={endpoint:"verifyPassword",B:function(a){bi(a);if(!a.password)throw new L("wrong-password")},J:ii,R:!0},ri={endpoint:"verifyPhoneNumber",B:ji,J:ii},rg={endpoint:"verifyPhoneNumber",B:function(a){if(!a.idToken)throw new L("internal-error");ji(a)},J:function(a){if(a.temporaryProof)throw a.code="credential-already-in-use",Eg(a);ii(a)}},sg={Xb:{USER_NOT_FOUND:"user-not-found"},endpoint:"verifyPhoneNumber",B:ji,J:ii};function P(a,b,c){if(!Re(c,b.T))return C(new L("internal-error"));var d=b.Ib||"POST",e;return B(c).then(b.B).then(function(){b.R&&(c.returnSecureToken=!0);return ai(a,b.endpoint,d,c,b.Xb,b.vb||!1)}).then(function(a){e=a;return b.Pa?b.Pa(c,e):e}).then(b.J).then(function(){if(!b.da)return e;if(!(b.da in e))throw new L("internal-error");return e[b.da]})}function xi(a){return $h({error:{errors:[{message:a}],code:400,message:a}})}function $h(a,b){var c=(a.error&&a.error.errors&&a.error.errors[0]||{}).reason||"";var d={keyInvalid:"invalid-api-key",ipRefererBlocked:"app-not-authorized"};if(c=d[c]?new L(d[c]):null)return c;c=a.error&&a.error.message||"";d={INVALID_CUSTOM_TOKEN:"invalid-custom-token",CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_EMAIL:"invalid-email",INVALID_PASSWORD:"wrong-password",USER_DISABLED:"user-disabled",MISSING_PASSWORD:"internal-error",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_OR_INVALID_NONCE:"missing-or-invalid-nonce",INVALID_MESSAGE_PAYLOAD:"invalid-message-payload",INVALID_RECIPIENT_EMAIL:"invalid-recipient-email",INVALID_SENDER:"invalid-sender",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",INVALID_PROVIDER_ID:"invalid-provider-id",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",CORS_UNSUPPORTED:"cors-unsupported",DYNAMIC_LINK_NOT_ACTIVATED:"dynamic-link-not-activated",INVALID_APP_ID:"invalid-app-id",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",WEAK_PASSWORD:"weak-password",OPERATION_NOT_ALLOWED:"operation-not-allowed",USER_CANCELLED:"user-cancelled",CAPTCHA_CHECK_FAILED:"captcha-check-failed",INVALID_APP_CREDENTIAL:"invalid-app-credential",INVALID_CODE:"invalid-verification-code",INVALID_PHONE_NUMBER:"invalid-phone-number",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_APP_CREDENTIAL:"missing-app-credential",MISSING_CODE:"missing-verification-code",MISSING_PHONE_NUMBER:"missing-phone-number",MISSING_SESSION_INFO:"missing-verification-id",QUOTA_EXCEEDED:"quota-exceeded",SESSION_EXPIRED:"code-expired",REJECTED_CREDENTIAL:"rejected-credential",INVALID_CONTINUE_URI:"invalid-continue-uri",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",MISSING_IOS_BUNDLE_ID:"missing-ios-bundle-id",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_DYNAMIC_LINK_DOMAIN:"invalid-dynamic-link-domain",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",INVALID_CERT_HASH:"invalid-cert-hash"};ab(d,b||{});b=(b=c.match(/^[^\s]+\s*:\s*(.*)$/))&&1<b.length?b[1]:void 0;for(var e in d)if(0===c.indexOf(e))return new L(d[e],b);!b&&a&&(b=ze(a));return new L("internal-error",b)}function Ki(a){this.b=a;this.a=null;this.gb=Li(this)}function Li(a){return Mi().then(function(){return new A(function(b,c){I("gapi.iframes.getContext")().open({where:document.body,url:a.b,messageHandlersFilter:I("gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER"),attributes:{style:{position:"absolute",top:"-100px",width:"1px",height:"1px"}},dontclear:!0},function(d){function e(){clearTimeout(f);b()}a.a=d;a.a.restyle({setHideOnLeave:!1});var f=setTimeout(function(){c(Error("Network Error"))},Ni.get());d.ping(e).then(e,function(){c(Error("Network Error"))})})})})}function Oi(a,b){return a.gb.then(function(){return new A(function(c){a.a.send(b.type,b,c,I("gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER"))})})}function Pi(a,b){a.gb.then(function(){a.a.register("authEvent",b,I("gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER"))})}var Qi=new od(pd,"https://apis.google.com/js/api.js?onload=%{onload}"),Ri=new Ee(3e4,6e4),Ni=new Ee(5e3,15e3),Si=null;function Mi(){return Si?Si:Si=new A(function(a,b){function c(){De();I("gapi.load")("gapi.iframes",{callback:a,ontimeout:function(){De();b(Error("Network Error"))},timeout:Ri.get()})}if(I("gapi.iframes.Iframe"))a();else if(I("gapi.load"))c();else{var d="__iframefcb"+Math.floor(1e6*Math.random()).toString();k[d]=function(){I("gapi.load")?c():b(Error("Network Error"))};d=vd(Qi,{onload:d});B(Gh(d)).s(function(){b(Error("Network Error"))})}}).s(function(a){Si=null;throw a})}function Ti(a,b,c){this.i=a;this.g=b;this.h=c;this.f=null;this.a=fd(this.i,"/__/auth/iframe");G(this.a,"apiKey",this.g);G(this.a,"appName",this.h);this.b=null;this.c=[]}Ti.prototype.toString=function(){this.f?G(this.a,"v",this.f):ld(this.a.a,"v");this.b?G(this.a,"eid",this.b):ld(this.a.a,"eid");this.c.length?G(this.a,"fw",this.c.join(",")):ld(this.a.a,"fw");return this.a.toString()};function Ui(a,b,c,d,e){this.m=a;this.l=b;this.c=c;this.o=d;this.h=this.g=this.i=null;this.a=e;this.f=null}Ui.prototype.toString=function(){var a=fd(this.m,"/__/auth/handler");G(a,"apiKey",this.l);G(a,"appName",this.c);G(a,"authType",this.o);if(this.a.isOAuthProvider){var b=this.a;try{var c=firebase.app(this.c).auth().ea()}catch(m){c=null}b.ab=c;G(a,"providerId",this.a.providerId);b=this.a;c=Ae(b.zb);for(var d in c)c[d]=c[d].toString();d=b.Fc;c=Za(c);for(var e=0;e<d.length;e++){var f=d[e];f in c&&delete c[f]}b.eb&&b.ab&&!c[b.eb]&&(c[b.eb]=b.ab);Ya(c)||G(a,"customParameters",ze(c))}"function"===typeof this.a.Fb&&(b=this.a.Fb(),b.length&&G(a,"scopes",b.join(",")));this.i?G(a,"redirectUrl",this.i):ld(a.a,"redirectUrl");this.g?G(a,"eventId",this.g):ld(a.a,"eventId");this.h?G(a,"v",this.h):ld(a.a,"v");if(this.b)for(var h in this.b)this.b.hasOwnProperty(h)&&!dd(a,h)&&G(a,h,this.b[h]);this.f?G(a,"eid",this.f):ld(a.a,"eid");h=Vi(this.c);h.length&&G(a,"fw",h.join(","));return a.toString()};function Vi(a){try{return firebase.app(a).auth().ya()}catch(b){return[]}}function Wi(a,b,c,d,e){this.l=a;this.f=b;this.b=c;this.c=d||null;this.h=e||null;this.m=this.u=this.v=null;this.g=[];this.o=this.a=null}function Xi(a){var b=Xd();return gi(a).then(function(a){a:{var c=ed(b),e=c.c;c=c.b;for(var f=0;f<a.length;f++){var h=a[f];var m=c;var p=e;0==h.indexOf("chrome-extension://")?m=ed(h).b==m&&"chrome-extension"==p:"http"!=p&&"https"!=p?m=!1:he.test(h)?m=m==h:(h=h.split(".").join("\\."),m=new RegExp("^(.+\\."+h+"|"+h+")$","i").test(m));if(m){a=!0;break a}}a=!1}if(!a)throw new Cg(Xd())})}function Yi(a){if(a.o)return a.o;a.o=je().then(function(){if(!a.u){var b=a.c,c=a.h,d=Vi(a.b),e=new Ti(a.l,a.f,a.b);e.f=b;e.b=c;e.c=Ka(d||[]);a.u=e.toString()}a.i=new Ki(a.u);Zi(a)});return a.o}g=Wi.prototype;g.Ea=function(a,b,c){var d=new L("popup-closed-by-user"),e=new L("web-storage-unsupported"),f=this,h=!1;return this.ga().then(function(){$i(f).then(function(c){c||(a&&de(a),b(e),h=!0)})}).s(function(){}).then(function(){if(!h)return ge(a)}).then(function(){if(!h)return Ic(c).then(function(){b(d)})})};g.Mb=function(){var a=H();return!ye(a)&&!Ce(a)};g.Hb=function(){return!1};g.Db=function(a,b,c,d,e,f,h){if(!a)return C(new L("popup-blocked"));if(h&&!ye())return this.ga().s(function(b){de(a);e(b)}),d(),B();this.a||(this.a=Xi(aj(this)));var m=this;return this.a.then(function(){var b=m.ga().s(function(b){de(a);e(b);throw b});d();return b}).then(function(){xg(c);if(!h){var d=bj(m.l,m.f,m.b,b,c,null,f,m.c,void 0,m.h);Yd(d,a)}}).s(function(a){"auth/network-request-failed"==a.code&&(m.a=null);throw a})};function aj(a){a.m||(a.v=a.c?te(a.c,Vi(a.b)):null,a.m=new Nh(a.f,Af(a.h),a.v));return a.m}g.Ca=function(a,b,c){this.a||(this.a=Xi(aj(this)));var d=this;return this.a.then(function(){xg(b);var e=bj(d.l,d.f,d.b,a,b,Xd(),c,d.c,void 0,d.h);Yd(e)}).s(function(a){"auth/network-request-failed"==a.code&&(d.a=null);throw a})};g.ga=function(){var a=this;return Yi(this).then(function(){return a.i.gb}).s(function(){a.a=null;throw new L("network-request-failed")})};g.Qb=function(){return!0};function bj(a,b,c,d,e,f,h,m,p,x){a=new Ui(a,b,c,d,e);a.i=f;a.g=h;a.h=m;a.b=Za(p||null);a.f=x;return a.toString()}function Zi(a){if(!a.i)throw Error("IfcHandler must be initialized!");Pi(a.i,function(b){var c={};if(b&&b.authEvent){var d=!1;b=zg(b.authEvent);for(c=0;c<a.g.length;c++)d=a.g[c](b)||d;c={};c.status=d?"ACK":"ERROR";return B(c)}c.status="ERROR";return B(c)})}function $i(a){var b={type:"webStorageSupport"};return Yi(a).then(function(){return Oi(a.i,b)}).then(function(a){if(a&&a.length&&"undefined"!==typeof a[0].webStorageSupport)return a[0].webStorageSupport;throw Error()})}g.wa=function(a){this.g.push(a)};g.Ka=function(a){w(this.g,function(b){return b==a})};function cj(a){this.a=a||firebase.INTERNAL.reactNative&&firebase.INTERNAL.reactNative.AsyncStorage;if(!this.a)throw new L("internal-error","The React Native compatibility library was not found.");this.type="asyncStorage"}g=cj.prototype;g.get=function(a){return B(this.a.getItem(a)).then(function(a){return a&&Be(a)})};g.set=function(a,b){return B(this.a.setItem(a,ze(b)))};g.P=function(a){return B(this.a.removeItem(a))};g.Y=function(){};g.ca=function(){};function dj(a){this.b=a;this.a={};this.c=r(this.f,this)}var ej=[];function fj(){var a=oe()?self:null;v(ej,function(c){c.b==a&&(b=c)});if(!b){var b=new dj(a);ej.push(b)}return b}dj.prototype.f=function(a){var b=a.data.eventType,c=a.data.eventId,d=this.a[b];if(d&&0<d.length){a.ports[0].postMessage({status:"ack",eventId:c,eventType:b,response:null});var e=[];v(d,function(b){e.push(B().then(function(){return b(a.origin,a.data.data)}))});xb(e).then(function(d){var e=[];v(d,function(a){e.push({fulfilled:a.Eb,value:a.value,reason:a.reason?a.reason.message:void 0})});v(e,function(a){for(var b in a)"undefined"===typeof a[b]&&delete a[b]});a.ports[0].postMessage({status:"done",eventId:c,eventType:b,response:e})})}};dj.prototype.subscribe=function(a,b){Ya(this.a)&&this.b.addEventListener("message",this.c);"undefined"===typeof this.a[a]&&(this.a[a]=[]);this.a[a].push(b)};dj.prototype.unsubscribe=function(a,b){"undefined"!==typeof this.a[a]&&b?(w(this.a[a],function(a){return a==b}),0==this.a[a].length&&delete this.a[a]):b||delete this.a[a];Ya(this.a)&&this.b.removeEventListener("message",this.c)};function gj(a){this.a=a}gj.prototype.postMessage=function(a,b){this.a.postMessage(a,b)};function hj(a){this.c=a;this.b=!1;this.a=[]}function ij(a,b,c,d){var e,f=c||{},h,m,p,x=null;if(a.b)return C(Error("connection_unavailable"));var gb=d?800:50,la="undefined"!==typeof MessageChannel?new MessageChannel:null;return new A(function(c,d){la?(e=Math.floor(Math.random()*Math.pow(10,20)).toString(),la.port1.start(),m=setTimeout(function(){d(Error("unsupported_event"))},gb),h=function(a){a.data.eventId===e&&("ack"===a.data.status?(clearTimeout(m),p=setTimeout(function(){d(Error("timeout"))},3e3)):"done"===a.data.status?(clearTimeout(p),"undefined"!==typeof a.data.response?c(a.data.response):d(Error("unknown_error"))):(clearTimeout(m),clearTimeout(p),d(Error("invalid_response"))))},x={messageChannel:la,onMessage:h},a.a.push(x),la.port1.addEventListener("message",h),a.c.postMessage({eventType:b,eventId:e,data:f},[la.port2])):d(Error("connection_unavailable"))}).then(function(b){jj(a,x);return b}).s(function(b){jj(a,x);throw b})}function jj(a,b){if(b){var c=b.messageChannel,d=b.onMessage;c&&(c.port1.removeEventListener("message",d),c.port1.close());w(a.a,function(a){return a==b})}}hj.prototype.close=function(){for(;0<this.a.length;)jj(this,this.a[0]);this.b=!0};function kj(){if(!lj())throw new L("web-storage-unsupported");this.c={};this.a=[];this.b=0;this.l=k.indexedDB;this.type="indexedDB";this.g=this.o=this.f=this.i=null;this.u=!1;this.h=null;var a=this;oe()&&self?(this.o=fj(),this.o.subscribe("keyChanged",function(b,c){return mj(a).then(function(b){0<b.length&&v(a.a,function(a){a(b)});return{keyProcessed:Ha(b,c.key)}})}),this.o.subscribe("ping",function(){return B(["keyChanged"])})):Ke().then(function(b){if(a.h=b)a.g=new hj(new gj(b)),ij(a.g,"ping",null,!0).then(function(b){b[0].fulfilled&&Ha(b[0].value,"keyChanged")&&(a.u=!0)}).s(function(){})})}var nj;function oj(a){return new A(function(b,c){var d=a.l.deleteDatabase("firebaseLocalStorageDb");d.onsuccess=function(){b()};d.onerror=function(a){c(Error(a.target.error))}})}function pj(a){return new A(function(b,c){var d=a.l.open("firebaseLocalStorageDb",1);d.onerror=function(a){try{a.preventDefault()}catch(f){}c(Error(a.target.error))};d.onupgradeneeded=function(a){a=a.target.result;try{a.createObjectStore("firebaseLocalStorage",{keyPath:"fbase_key"})}catch(f){c(f)}};d.onsuccess=function(d){d=d.target.result;d.objectStoreNames.contains("firebaseLocalStorage")?b(d):oj(a).then(function(){return pj(a)}).then(function(a){b(a)}).s(function(a){c(a)})}})}function qj(a){a.m||(a.m=pj(a));return a.m}function lj(){try{return!!k.indexedDB}catch(a){return!1}}function rj(a){return a.objectStore("firebaseLocalStorage")}function sj(a,b){return a.transaction(["firebaseLocalStorage"],b?"readwrite":"readonly")}function tj(a){return new A(function(b,c){a.onsuccess=function(a){a&&a.target?b(a.target.result):b()};a.onerror=function(a){c(a.target.error)}})}g=kj.prototype;g.set=function(a,b){var c=!1,d,e=this;return qj(this).then(function(b){d=b;b=rj(sj(d,!0));return tj(b.get(a))}).then(function(f){var h=rj(sj(d,!0));if(f)return f.value=b,tj(h.put(f));e.b++;c=!0;f={};f.fbase_key=a;f.value=b;return tj(h.add(f))}).then(function(){e.c[a]=b;return uj(e,a)}).ia(function(){c&&e.b--})};function uj(a,b){return a.g&&a.h&&Je()===a.h?ij(a.g,"keyChanged",{key:b},a.u).then(function(){}).s(function(){}):B()}g.get=function(a){return qj(this).then(function(b){return tj(rj(sj(b,!1)).get(a))}).then(function(a){return a&&a.value})};g.P=function(a){var b=!1,c=this;return qj(this).then(function(d){b=!0;c.b++;return tj(rj(sj(d,!0))["delete"](a))}).then(function(){delete c.c[a];return uj(c,a)}).ia(function(){b&&c.b--})};function mj(a){return qj(a).then(function(a){var b=rj(sj(a,!1));return b.getAll?tj(b.getAll()):new A(function(a,c){var d=[],e=b.openCursor();e.onsuccess=function(b){(b=b.target.result)?(d.push(b.value),b["continue"]()):a(d)};e.onerror=function(a){c(a.target.error)}})}).then(function(b){var c={},d=[];if(0==a.b){for(d=0;d<b.length;d++)c[b[d].fbase_key]=b[d].value;d=Zd(a.c,c);a.c=c}return d})}g.Y=function(a){0==this.a.length&&vj(this);this.a.push(a)};g.ca=function(a){w(this.a,function(b){return b==a});0==this.a.length&&wj(this)};function vj(a){function b(){a.f=setTimeout(function(){a.i=mj(a).then(function(b){0<b.length&&v(a.a,function(a){a(b)})}).then(function(){b()}).s(function(a){"STOP_EVENT"!=a.message&&b()})},800)}wj(a);b()}function wj(a){a.i&&a.i.cancel("STOP_EVENT");a.f&&(clearTimeout(a.f),a.f=null)}function xj(a){var b=this,c=null;this.a=[];this.type="indexedDB";this.c=a;this.b=B().then(function(){if(lj()){var a=ve(),e="__sak"+a;nj||(nj=new kj);c=nj;return c.set(e,a).then(function(){return c.get(e)}).then(function(b){if(b!==a)throw Error("indexedDB not supported!");return c.P(e)}).then(function(){return c}).s(function(){return b.c})}return b.c}).then(function(a){b.type=a.type;a.Y(function(a){v(b.a,function(b){b(a)})});return a})}g=xj.prototype;g.get=function(a){return this.b.then(function(b){return b.get(a)})};g.set=function(a,b){return this.b.then(function(c){return c.set(a,b)})};g.P=function(a){return this.b.then(function(b){return b.P(a)})};g.Y=function(a){this.a.push(a)};g.ca=function(a){w(this.a,function(b){return b==a})};function yj(){this.a={};this.type="inMemory"}g=yj.prototype;g.get=function(a){return B(this.a[a])};g.set=function(a,b){this.a[a]=b;return B()};g.P=function(a){delete this.a[a];return B()};g.Y=function(){};g.ca=function(){};function zj(){if(!Aj()){if("Node"==pe())throw new L("internal-error","The LocalStorage compatibility library was not found.");throw new L("web-storage-unsupported")}this.a=Bj()||firebase.INTERNAL.node.localStorage;this.type="localStorage"}function Bj(){try{var a=k.localStorage,b=ve();a&&(a.setItem(b,"1"),a.removeItem(b));return a}catch(c){return null}}function Aj(){var a="Node"==pe();a=Bj()||a&&firebase.INTERNAL.node&&firebase.INTERNAL.node.localStorage;if(!a)return!1;try{return a.setItem("__sak","1"),a.removeItem("__sak"),!0}catch(b){return!1}}g=zj.prototype;g.get=function(a){var b=this;return B().then(function(){var c=b.a.getItem(a);return Be(c)})};g.set=function(a,b){var c=this;return B().then(function(){var d=ze(b);null===d?c.P(a):c.a.setItem(a,d)})};g.P=function(a){var b=this;return B().then(function(){b.a.removeItem(a)})};g.Y=function(a){k.window&&sc(k.window,"storage",a)};g.ca=function(a){k.window&&E(k.window,"storage",a)};function Cj(){this.type="nullStorage"}g=Cj.prototype;g.get=function(){return B(null)};g.set=function(){return B()};g.P=function(){return B()};g.Y=function(){};g.ca=function(){};function Dj(){if(!Ej()){if("Node"==pe())throw new L("internal-error","The SessionStorage compatibility library was not found.");throw new L("web-storage-unsupported")}this.a=Fj()||firebase.INTERNAL.node.sessionStorage;this.type="sessionStorage"}function Fj(){try{var a=k.sessionStorage,b=ve();a&&(a.setItem(b,"1"),a.removeItem(b));return a}catch(c){return null}}function Ej(){var a="Node"==pe();a=Fj()||a&&firebase.INTERNAL.node&&firebase.INTERNAL.node.sessionStorage;if(!a)return!1;try{return a.setItem("__sak","1"),a.removeItem("__sak"),!0}catch(b){return!1}}g=Dj.prototype;g.get=function(a){var b=this;return B().then(function(){var c=b.a.getItem(a);return Be(c)})};g.set=function(a,b){var c=this;return B().then(function(){var d=ze(b);null===d?c.P(a):c.a.setItem(a,d)})};g.P=function(a){var b=this;return B().then(function(){b.a.removeItem(a)})};g.Y=function(){};g.ca=function(){};function Gj(){var a={};a.Browser=Hj;a.Node=Ij;a.ReactNative=Jj;a.Worker=Kj;this.a=a[pe()]}var Lj,Hj={A:zj,Sa:Dj},Ij={A:zj,Sa:Dj},Jj={A:cj,Sa:Cj},Kj={A:zj,Sa:Cj};var Mj={ad:"local",NONE:"none",cd:"session"};function Nj(a){var b=new L("invalid-persistence-type"),c=new L("unsupported-persistence-type");a:{for(d in Mj)if(Mj[d]==a){var d=!0;break a}d=!1}if(!d||"string"!==typeof a)throw b;switch(pe()){case"ReactNative":if("session"===a)throw c;break;case"Node":if("none"!==a)throw c;break;default:if(!ue()&&"none"!==a)throw c}}function Oj(){var a=!Ce(H())&&ne()?!0:!1,b=ye(),c=ue();this.m=a;this.h=b;this.o=c;this.a={};Lj||(Lj=new Gj);a=Lj;try{this.g=!Wd()&&Ie()||!k.indexedDB?new a.a.A:new xj(oe()?new yj:new a.a.A)}catch(d){this.g=new yj,this.h=!0}try{this.i=new a.a.Sa}catch(d){this.i=new yj}this.l=new yj;this.f=r(this.Pb,this);this.b={}}var Pj;function Qj(){Pj||(Pj=new Oj);return Pj}function Rj(a,b){switch(b){case"session":return a.i;case"none":return a.l;default:return a.g}}function Sj(a,b){return"firebase:"+a.name+(b?":"+b:"")}function Tj(a,b,c){var d=Sj(b,c),e=Rj(a,b.A);return a.get(b,c).then(function(f){var h=null;try{h=Be(k.localStorage.getItem(d))}catch(m){}if(h&&!f)return k.localStorage.removeItem(d),a.set(b,h,c);h&&f&&"localStorage"!=e.type&&k.localStorage.removeItem(d)})}g=Oj.prototype;g.get=function(a,b){return Rj(this,a.A).get(Sj(a,b))};function Uj(a,b,c){c=Sj(b,c);"local"==b.A&&(a.b[c]=null);return Rj(a,b.A).P(c)}g.set=function(a,b,c){var d=Sj(a,c),e=this,f=Rj(this,a.A);return f.set(d,b).then(function(){return f.get(d)}).then(function(b){"local"==a.A&&(e.b[d]=b)})};g.addListener=function(a,b,c){a=Sj(a,b);this.o&&(this.b[a]=k.localStorage.getItem(a));Ya(this.a)&&(Rj(this,"local").Y(this.f),this.h||(Wd()||!Ie())&&k.indexedDB||!this.o||Vj(this));this.a[a]||(this.a[a]=[]);this.a[a].push(c)};g.removeListener=function(a,b,c){a=Sj(a,b);this.a[a]&&(w(this.a[a],function(a){return a==c}),0==this.a[a].length&&delete this.a[a]);Ya(this.a)&&(Rj(this,"local").ca(this.f),Wj(this))};function Vj(a){Wj(a);a.c=setInterval(function(){for(var b in a.a){var c=k.localStorage.getItem(b),d=a.b[b];c!=d&&(a.b[b]=c,c=new gc({type:"storage",key:b,target:window,oldValue:d,newValue:c,a:!0}),a.Pb(c))}},1e3)}function Wj(a){a.c&&(clearInterval(a.c),a.c=null)}g.Pb=function(a){if(a&&a.f){var b=a.a.key;if(null==b)for(var c in this.a){var d=this.b[c];"undefined"===typeof d&&(d=null);var e=k.localStorage.getItem(c);e!==d&&(this.b[c]=e,this.Ya(c))}else if(0==b.indexOf("firebase:")&&this.a[b]){"undefined"!==typeof a.a.a?Rj(this,"local").ca(this.f):Wj(this);if(this.m)if(c=k.localStorage.getItem(b),d=a.a.newValue,d!==c)null!==d?k.localStorage.setItem(b,d):k.localStorage.removeItem(b);else if(this.b[b]===d&&"undefined"===typeof a.a.a)return;var f=this;c=function(){if("undefined"!==typeof a.a.a||f.b[b]!==k.localStorage.getItem(b))f.b[b]=k.localStorage.getItem(b),f.Ya(b)};Qb&&ac&&10==ac&&k.localStorage.getItem(b)!==a.a.newValue&&a.a.newValue!==a.a.oldValue?setTimeout(c,10):c()}}else v(a,r(this.Ya,this))};g.Ya=function(a){this.a[a]&&v(this.a[a],function(a){a()})};function Xj(a){this.a=a;this.b=Qj()}var Yj={name:"authEvent",A:"local"};function Zj(a){return a.b.get(Yj,a.a).then(function(a){return zg(a)})}function ak(){this.a=Qj()}function bk(){this.b=-1}function ck(a,b){this.b=dk;this.f=k.Uint8Array?new Uint8Array(this.b):Array(this.b);this.g=this.c=0;this.a=[];this.i=a;this.h=b;this.o=k.Int32Array?new Int32Array(64):Array(64);void 0!==ek||(k.Int32Array?ek=new Int32Array(fk):ek=fk);this.reset()}var ek;t(ck,bk);for(var dk=64,gk=dk-1,hk=[],ik=0;ik<gk;ik++)hk[ik]=0;var jk=Ja(128,hk);ck.prototype.reset=function(){this.g=this.c=0;this.a=k.Int32Array?new Int32Array(this.h):Ka(this.h)};function kk(a){for(var b=a.f,c=a.o,d=0,e=0;e<b.length;)c[d++]=b[e]<<24|b[e+1]<<16|b[e+2]<<8|b[e+3],e=4*d;for(b=16;64>b;b++){e=c[b-15]|0;d=c[b-2]|0;var f=(c[b-16]|0)+((e>>>7|e<<25)^(e>>>18|e<<14)^e>>>3)|0,h=(c[b-7]|0)+((d>>>17|d<<15)^(d>>>19|d<<13)^d>>>10)|0;c[b]=f+h|0}d=a.a[0]|0;e=a.a[1]|0;var m=a.a[2]|0,p=a.a[3]|0,x=a.a[4]|0,gb=a.a[5]|0,la=a.a[6]|0;f=a.a[7]|0;for(b=0;64>b;b++){var Vl=((d>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10))+(d&e^d&m^e&m)|0;h=x&gb^~x&la;f=f+((x>>>6|x<<26)^(x>>>11|x<<21)^(x>>>25|x<<7))|0;h=h+(ek[b]|0)|0;h=f+(h+(c[b]|0)|0)|0;f=la;la=gb;gb=x;x=p+h|0;p=m;m=e;e=d;d=h+Vl|0}a.a[0]=a.a[0]+d|0;a.a[1]=a.a[1]+e|0;a.a[2]=a.a[2]+m|0;a.a[3]=a.a[3]+p|0;a.a[4]=a.a[4]+x|0;a.a[5]=a.a[5]+gb|0;a.a[6]=a.a[6]+la|0;a.a[7]=a.a[7]+f|0}function lk(a,b,c){void 0===c&&(c=b.length);var d=0,e=a.c;if(l(b))for(;d<c;)a.f[e++]=b.charCodeAt(d++),e==a.b&&(kk(a),e=0);else if(ja(b))for(;d<c;){var f=b[d++];if(!("number"==typeof f&&0<=f&&255>=f&&f==(f|0)))throw Error("message must be a byte array");a.f[e++]=f;e==a.b&&(kk(a),e=0)}else throw Error("message must be string or array");a.c=e;a.g+=c}var fk=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function mk(){ck.call(this,8,nk)}t(mk,ck);var nk=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];function ok(a,b,c,d,e){this.l=a;this.i=b;this.o=c;this.m=d||null;this.u=e||null;this.h=b+":"+c;this.v=new ak;this.g=new Xj(this.h);this.f=null;this.b=[];this.a=this.c=null}function pk(a){return new L("invalid-cordova-configuration",a)}g=ok.prototype;g.ga=function(){return this.za?this.za:this.za=ke().then(function(){if("function"!==typeof I("universalLinks.subscribe",k))throw pk("cordova-universal-links-plugin-fix is not installed");if("undefined"===typeof I("BuildInfo.packageName",k))throw pk("cordova-plugin-buildinfo is not installed");if("function"!==typeof I("cordova.plugins.browsertab.openUrl",k))throw pk("cordova-plugin-browsertab is not installed");if("function"!==typeof I("cordova.InAppBrowser.open",k))throw pk("cordova-plugin-inappbrowser is not installed")},function(){throw new L("cordova-not-ready")})};function qk(){for(var a=20,b=[];0<a;)b.push("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(62*Math.random()))),a--;return b.join("")}function rk(a){var b=new mk;lk(b,a);a=[];var c=8*b.g;56>b.c?lk(b,jk,56-b.c):lk(b,jk,b.b-(b.c-56));for(var d=63;56<=d;d--)b.f[d]=c&255,c/=256;kk(b);for(d=c=0;d<b.i;d++)for(var e=24;0<=e;e-=8)a[c++]=b.a[d]>>e&255;return qf(a)}g.Ea=function(a,b){b(new L("operation-not-supported-in-this-environment"));return B()};g.Db=function(){return C(new L("operation-not-supported-in-this-environment"))};g.Qb=function(){return!1};g.Mb=function(){return!0};g.Hb=function(){return!0};g.Ca=function(a,b,c){if(this.c)return C(new L("redirect-operation-pending"));var d=this,e=k.document,f=null,h=null,m=null,p=null;return this.c=B().then(function(){xg(b);return sk(d)}).then(function(){return tk(d,a,b,c)}).then(function(){return new A(function(a,b){h=function(){var b=I("cordova.plugins.browsertab.close",k);a();"function"===typeof b&&b();d.a&&"function"===typeof d.a.close&&(d.a.close(),d.a=null);return!1};d.wa(h);m=function(){f||(f=Ic(2e3).then(function(){b(new L("redirect-cancelled-by-user"))}))};p=function(){Fe()&&m()};e.addEventListener("resume",m,!1);H().toLowerCase().match(/android/)||e.addEventListener("visibilitychange",p,!1)}).s(function(a){return uk(d).then(function(){throw a})})}).ia(function(){m&&e.removeEventListener("resume",m,!1);p&&e.removeEventListener("visibilitychange",p,!1);f&&f.cancel();h&&d.Ka(h);d.c=null})};function tk(a,b,c,d){var e=qk(),f=new yg(b,d,null,e,new L("no-auth-event")),h=I("BuildInfo.packageName",k);if("string"!==typeof h)throw new L("invalid-cordova-configuration");var m=I("BuildInfo.displayName",k),p={};if(H().toLowerCase().match(/iphone|ipad|ipod/))p.ibi=h;else if(H().toLowerCase().match(/android/))p.apn=h;else return C(new L("operation-not-supported-in-this-environment"));m&&(p.appDisplayName=m);e=rk(e);p.sessionId=e;var x=bj(a.l,a.i,a.o,b,c,null,d,a.m,p,a.u);return a.ga().then(function(){var b=a.h;return a.v.a.set(Yj,f.C(),b)}).then(function(){var b=I("cordova.plugins.browsertab.isAvailable",k);if("function"!==typeof b)throw new L("invalid-cordova-configuration");var c=null;b(function(b){if(b){c=I("cordova.plugins.browsertab.openUrl",k);if("function"!==typeof c)throw new L("invalid-cordova-configuration");c(x)}else{c=I("cordova.InAppBrowser.open",k);if("function"!==typeof c)throw new L("invalid-cordova-configuration");b=H();b=!(!b.match(/(iPad|iPhone|iPod).*OS 7_\d/i)&&!b.match(/(iPad|iPhone|iPod).*OS 8_\d/i));a.a=c(x,b?"_blank":"_system","location=yes")}})})}function vk(a,b){for(var c=0;c<a.b.length;c++)try{a.b[c](b)}catch(d){}}function sk(a){a.f||(a.f=a.ga().then(function(){return new A(function(b){function c(d){b(d);a.Ka(c);return!1}a.wa(c);wk(a)})}));return a.f}function uk(a){var b=null;return Zj(a.g).then(function(c){b=c;c=a.g;return Uj(c.b,Yj,c.a)}).then(function(){return b})}function wk(a){function b(b){d=!0;e&&e.cancel();uk(a).then(function(d){var e=c;if(d&&b&&b.url){var f=null;e=Qf(b.url);-1!=e.indexOf("/__/auth/callback")&&(f=ed(e),f=Be(dd(f,"firebaseError")||null),f=(f="object"===typeof f?df(f):null)?new yg(d.b,d.c,null,null,f):new yg(d.b,d.c,e,d.g));e=f||c}vk(a,e)})}var c=new yg("unknown",null,null,null,new L("no-auth-event")),d=!1,e=Ic(500).then(function(){return uk(a).then(function(){d||vk(a,c)})}),f=k.handleOpenURL;k.handleOpenURL=function(a){0==a.toLowerCase().indexOf(I("BuildInfo.packageName",k).toLowerCase()+"://")&&b({url:a});if("function"===typeof f)try{f(a)}catch(m){console.error(m)}};Bg||(Bg=new Ag);Bg.subscribe(b)}g.wa=function(a){this.b.push(a);sk(this).s(function(b){"auth/invalid-cordova-configuration"===b.code&&(b=new yg("unknown",null,null,null,new L("no-auth-event")),a(b))})};g.Ka=function(a){w(this.b,function(b){return b==a})};function xk(a){this.a=a;this.b=Qj()}var yk={name:"pendingRedirect",A:"session"};function zk(a){return a.b.set(yk,"pending",a.a)}function Ak(a){return Uj(a.b,yk,a.a)}function Bk(a){return a.b.get(yk,a.a).then(function(a){return"pending"==a})}function Ck(a,b,c){this.u=a;this.o=b;this.l=c;this.h=[];this.f=!1;this.i=r(this.cb,this);this.b=new Dk;this.m=new Ek;this.g=new xk(this.o+":"+this.l);this.c={};this.c.unknown=this.b;this.c.signInViaRedirect=this.b;this.c.linkViaRedirect=this.b;this.c.reauthViaRedirect=this.b;this.c.signInViaPopup=this.m;this.c.linkViaPopup=this.m;this.c.reauthViaPopup=this.m;this.a=Fk(this.u,this.o,this.l,Bf)}function Fk(a,b,c,d){var e=firebase.SDK_VERSION||null;return le()?new ok(a,b,c,e,d):new Wi(a,b,c,e,d)}g=Ck.prototype;g.reset=function(){this.f=!1;this.a.Ka(this.i);this.a=Fk(this.u,this.o,this.l)};g.Za=function(){this.b.Za()};function Gk(a){a.f||(a.f=!0,a.a.wa(a.i));var b=a.a;return a.a.ga().s(function(c){a.a==b&&a.reset();throw c})}function Hk(a){a.a.Mb()&&Gk(a).s(function(b){var c=new yg("unknown",null,null,null,new L("operation-not-supported-in-this-environment"));Ik(b)&&a.cb(c)});a.a.Hb()||Jk(a.b)}g.subscribe=function(a){Ha(this.h,a)||this.h.push(a);if(!this.f){var b=this;Bk(this.g).then(function(a){a?Ak(b.g).then(function(){Gk(b).s(function(a){var c=new yg("unknown",null,null,null,new L("operation-not-supported-in-this-environment"));Ik(a)&&b.cb(c)})}):Hk(b)}).s(function(){Hk(b)})}};g.unsubscribe=function(a){w(this.h,function(b){return b==a})};g.cb=function(a){if(!a)throw new L("invalid-auth-event");for(var b=!1,c=0;c<this.h.length;c++){var d=this.h[c];if(d.wb(a.b,a.c)){(b=this.c[a.b])&&b.h(a,d);b=!0;break}}Jk(this.b);return b};var Kk=new Ee(2e3,1e4),Lk=new Ee(3e4,6e4);Ck.prototype.fa=function(){return this.b.fa()};function Mk(a,b,c,d,e,f){return a.a.Db(b,c,d,function(){a.f||(a.f=!0,a.a.wa(a.i))},function(){a.reset()},e,f)}function Ik(a){return a&&"auth/cordova-not-ready"==a.code?!0:!1}Ck.prototype.Ca=function(a,b,c){var d=this,e;return zk(this.g).then(function(){return d.a.Ca(a,b,c).s(function(a){if(Ik(a))throw new L("operation-not-supported-in-this-environment");e=a;return Ak(d.g).then(function(){throw e})}).then(function(){return d.a.Qb()?new A(function(){}):Ak(d.g).then(function(){return d.fa()}).then(function(){}).s(function(){})})})};Ck.prototype.Ea=function(a,b,c,d){return this.a.Ea(c,function(c){a.ha(b,null,c,d)},Kk.get())};var Nk={};function Ok(a,b,c){var d=b+":"+c;Nk[d]||(Nk[d]=new Ck(a,b,c));return Nk[d]}function Dk(){this.b=null;this.f=[];this.c=[];this.a=null;this.i=this.g=!1}Dk.prototype.reset=function(){this.b=null;this.a&&(this.a.cancel(),this.a=null)};Dk.prototype.h=function(a,b){if(a){this.reset();this.g=!0;var c=a.b,d=a.c,e=a.a&&"auth/web-storage-unsupported"==a.a.code,f=a.a&&"auth/operation-not-supported-in-this-environment"==a.a.code;this.i=!(!e&&!f);"unknown"!=c||e||f?a.a?(Pk(this,!0,null,a.a),B()):b.xa(c,d)?Qk(this,a,b):C(new L("invalid-auth-event")):(Pk(this,!1,null,null),B())}else C(new L("invalid-auth-event"))};function Jk(a){a.g||(a.g=!0,Pk(a,!1,null,null))}Dk.prototype.Za=function(){this.g&&!this.i&&Pk(this,!1,null,null)};function Qk(a,b,c){c=c.xa(b.b,b.c);var d=b.f,e=b.g,f=b.h,h=!!b.b.match(/Redirect$/);c(d,e,f).then(function(b){Pk(a,h,b,null)}).s(function(b){Pk(a,h,null,b)})}function Rk(a,b){a.b=function(){return C(b)};if(a.c.length)for(var c=0;c<a.c.length;c++)a.c[c](b)}function Sk(a,b){a.b=function(){return B(b)};if(a.f.length)for(var c=0;c<a.f.length;c++)a.f[c](b)}function Pk(a,b,c,d){b?d?Rk(a,d):Sk(a,c):Sk(a,{user:null});a.f=[];a.c=[]}Dk.prototype.fa=function(){var a=this;return new A(function(b,c){a.b?a.b().then(b,c):(a.f.push(b),a.c.push(c),Tk(a))})};function Tk(a){var b=new L("timeout");a.a&&a.a.cancel();a.a=Ic(Lk.get()).then(function(){a.b||(a.g=!0,Pk(a,!0,null,b))})}function Ek(){}Ek.prototype.h=function(a,b){if(a){var c=a.b,d=a.c;a.a?(b.ha(a.b,null,a.a,a.c),B()):b.xa(c,d)?Uk(a,b):C(new L("invalid-auth-event"))}else C(new L("invalid-auth-event"))};function Uk(a,b){var c=a.c,d=a.b;b.xa(d,c)(a.f,a.g,a.h).then(function(a){b.ha(d,a,null,c)}).s(function(a){b.ha(d,null,a,c)})}function Vk(){this.tb=!1;Object.defineProperty(this,"appVerificationDisabled",{get:function(){return this.tb},set:function(a){this.tb=a},enumerable:!1})}function Wk(a,b){this.a=b;J(this,"verificationId",a)}Wk.prototype.confirm=function(a){a=vg(this.verificationId,a);return this.a(a)};function Xk(a,b,c,d){return new tg(a).Va(b,c).then(function(a){return new Wk(a,d)})}function Yk(a){var b=yf(a);if(!(b&&b.exp&&b.auth_time&&b.iat))throw new L("internal-error","An internal error occurred. The token obtained by Firebase appears to be malformed. Please retry the operation.");K(this,{token:a,expirationTime:He(1e3*b.exp),authTime:He(1e3*b.auth_time),issuedAtTime:He(1e3*b.iat),signInProvider:b.firebase&&b.firebase.sign_in_provider?b.firebase.sign_in_provider:null,claims:b})}function Zk(a,b,c){this.h=a;this.i=b;this.g=c;this.c=3e4;this.f=96e4;this.b=null;this.a=this.c;if(this.f<this.c)throw Error("Proactive refresh lower bound greater than upper bound!")}Zk.prototype.start=function(){this.a=this.c;$k(this,!0)};function al(a,b){if(b)return a.a=a.c,a.g();b=a.a;a.a*=2;a.a>a.f&&(a.a=a.f);return b}function $k(a,b){a.stop();a.b=Ic(al(a,b)).then(function(){return Ge()}).then(function(){return a.h()}).then(function(){$k(a,!0)}).s(function(b){a.i(b)&&$k(a,!1)})}Zk.prototype.stop=function(){this.b&&(this.b.cancel(),this.b=null)};function bl(a){this.f=a;this.b=this.a=null;this.c=0}bl.prototype.C=function(){return{apiKey:this.f.b,refreshToken:this.a,accessToken:this.b,expirationTime:this.c}};function cl(a,b){var c=b[M],d=b.refreshToken;b=dl(b.expiresIn);a.b=c;a.c=b;a.a=d}function el(a,b){a.b=b.b;a.a=b.a;a.c=b.c}function dl(a){return qa()+1e3*parseInt(a,10)}function fl(a,b){return Zh(a.f,b).then(function(b){a.b=b.access_token;a.c=dl(b.expires_in);a.a=b.refresh_token;return{accessToken:a.b,expirationTime:a.c,refreshToken:a.a}}).s(function(b){"auth/user-token-expired"==b.code&&(a.a=null);throw b})}bl.prototype.getToken=function(a){a=!!a;return this.b&&!this.a?C(new L("user-token-expired")):a||!this.b||qa()>this.c-3e4?this.a?fl(this,{grant_type:"refresh_token",refresh_token:this.a}):B(null):B({accessToken:this.b,expirationTime:this.c,refreshToken:this.a})};function gl(a,b){this.a=a||null;this.b=b||null;K(this,{lastSignInTime:He(b||null),creationTime:He(a||null)})}function hl(a){return new gl(a.a,a.b)}gl.prototype.C=function(){return{lastLoginAt:this.b,createdAt:this.a}};function il(a,b,c,d,e,f){K(this,{uid:a,displayName:d||null,photoURL:e||null,email:c||null,phoneNumber:f||null,providerId:b})}function jl(a,b){D.call(this,a);for(var c in b)this[c]=b[c]}t(jl,D);function Q(a,b,c){this.G=[];this.l=a.apiKey;this.m=a.appName;this.u=a.authDomain||null;a=firebase.SDK_VERSION?te(firebase.SDK_VERSION):null;this.b=new Nh(this.l,Af(Bf),a);this.h=new bl(this.b);kl(this,b[M]);cl(this.h,b);J(this,"refreshToken",this.h.a);ll(this,c||{});F.call(this);this.I=!1;this.u&&we()&&(this.a=Ok(this.u,this.l,this.m));this.N=[];this.i=null;this.w=ml(this);this.V=r(this.Ha,this);var d=this;this.ka=null;this.ta=function(a){d.pa(a.g)};this.X=null;this.O=[];this.sa=function(a){nl(d,a.c)};this.W=null}t(Q,F);Q.prototype.pa=function(a){this.ka=a;Th(this.b,a)};Q.prototype.ea=function(){return this.ka};function ol(a,b){a.X&&E(a.X,"languageCodeChanged",a.ta);(a.X=b)&&sc(b,"languageCodeChanged",a.ta)}function nl(a,b){a.O=b;Uh(a.b,firebase.SDK_VERSION?te(firebase.SDK_VERSION,a.O):null)}Q.prototype.ya=function(){return Ka(this.O)};function pl(a,b){a.W&&E(a.W,"frameworkChanged",a.sa);(a.W=b)&&sc(b,"frameworkChanged",a.sa)}Q.prototype.Ha=function(){this.w.b&&(this.w.stop(),this.w.start())};function ql(a){try{return firebase.app(a.m).auth()}catch(b){throw new L("internal-error","No firebase.auth.Auth instance is available for the Firebase App '"+a.m+"'!")}}function ml(a){return new Zk(function(){return a.F(!0)},function(a){return a&&"auth/network-request-failed"==a.code?!0:!1},function(){var b=a.h.c-qa()-3e5;return 0<b?b:0})}function rl(a){a.D||a.w.b||(a.w.start(),E(a,"tokenChanged",a.V),sc(a,"tokenChanged",a.V))}function sl(a){E(a,"tokenChanged",a.V);a.w.stop()}function kl(a,b){a.ra=b;J(a,"_lat",b)}function tl(a,b){w(a.N,function(a){return a==b})}function ul(a){for(var b=[],c=0;c<a.N.length;c++)b.push(a.N[c](a));return xb(b).then(function(){return a})}function vl(a){a.a&&!a.I&&(a.I=!0,a.a.subscribe(a))}function ll(a,b){K(a,{uid:b.uid,displayName:b.displayName||null,photoURL:b.photoURL||null,email:b.email||null,emailVerified:b.emailVerified||!1,phoneNumber:b.phoneNumber||null,isAnonymous:b.isAnonymous||!1,metadata:new gl(b.createdAt,b.lastLoginAt),providerData:[]})}J(Q.prototype,"providerId","firebase");function wl(){}function xl(a){return B().then(function(){if(a.D)throw new L("app-deleted")})}function yl(a){return Da(a.providerData,function(a){return a.providerId})}function zl(a,b){b&&(Al(a,b.providerId),a.providerData.push(b))}function Al(a,b){w(a.providerData,function(a){return a.providerId==b})}function Bl(a,b,c){("uid"!=b||c)&&a.hasOwnProperty(b)&&J(a,b,c)}function Cl(a,b){a!=b&&(K(a,{uid:b.uid,displayName:b.displayName,photoURL:b.photoURL,email:b.email,emailVerified:b.emailVerified,phoneNumber:b.phoneNumber,isAnonymous:b.isAnonymous,providerData:[]}),b.metadata?J(a,"metadata",hl(b.metadata)):J(a,"metadata",new gl),v(b.providerData,function(b){zl(a,b)}),el(a.h,b.h),J(a,"refreshToken",a.h.a))}g=Q.prototype;g.reload=function(){var a=this;return R(this,xl(this).then(function(){return Dl(a).then(function(){return ul(a)}).then(wl)}))};function Dl(a){return a.F().then(function(b){var c=a.isAnonymous;return El(a,b).then(function(){c||Bl(a,"isAnonymous",!1);return b})})}g.dc=function(a){return this.F(a).then(function(a){return new Yk(a)})};g.F=function(a){var b=this;return R(this,xl(this).then(function(){return b.h.getToken(a)}).then(function(a){if(!a)throw new L("internal-error");a.accessToken!=b.ra&&(kl(b,a.accessToken),b.dispatchEvent(new jl("tokenChanged")));Bl(b,"refreshToken",a.refreshToken);return a.accessToken}))};function Fl(a,b){b[M]&&a.ra!=b[M]&&(cl(a.h,b),a.dispatchEvent(new jl("tokenChanged")),kl(a,b[M]),Bl(a,"refreshToken",a.h.a))}function El(a,b){return P(a.b,Hi,{idToken:b}).then(r(a.zc,a))}g.zc=function(a){a=a.users;if(!a||!a.length)throw new L("internal-error");a=a[0];ll(this,{uid:a.localId,displayName:a.displayName,photoURL:a.photoUrl,email:a.email,emailVerified:!!a.emailVerified,phoneNumber:a.phoneNumber,lastLoginAt:a.lastLoginAt,createdAt:a.createdAt});for(var b=Gl(a),c=0;c<b.length;c++)zl(this,b[c]);Bl(this,"isAnonymous",!(this.email&&a.passwordHash)&&!(this.providerData&&this.providerData.length))};function Gl(a){return(a=a.providerUserInfo)&&a.length?Da(a,function(a){return new il(a.rawId,a.providerId,a.email,a.displayName,a.photoUrl,a.phoneNumber)}):[]}g.hb=function(a){var b=this,c=null;return R(this,a.f(this.b,this.uid).then(function(a){Fl(b,a);c=Hl(b,a,"reauthenticate");b.i=null;return b.reload()}).then(function(){return c}),!0)};g.Ac=function(a){Me("firebase.User.prototype.reauthenticateWithCredential is deprecated. Please use firebase.User.prototype.reauthenticateAndRetrieveDataWithCredential instead.");return this.hb(a).then(function(){})};function Il(a,b){return Dl(a).then(function(){if(Ha(yl(a),b))return ul(a).then(function(){throw new L("provider-already-linked")})})}g.fb=function(a){var b=this,c=null;return R(this,Il(this,a.providerId).then(function(){return b.F()}).then(function(c){return a.b(b.b,c)}).then(function(a){c=Hl(b,a,"link");return Jl(b,a)}).then(function(){return c}))};g.rc=function(a){Me("firebase.User.prototype.linkWithCredential is deprecated. Please use firebase.User.prototype.linkAndRetrieveDataWithCredential instead.");return this.fb(a).then(function(a){return a.user})};g.sc=function(a,b){var c=this;return R(this,Il(this,"phone").then(function(){return Xk(ql(c),a,b,r(c.fb,c))}))};g.Bc=function(a,b){var c=this;return R(this,B().then(function(){return Xk(ql(c),a,b,r(c.hb,c))}),!0)};function Hl(a,b,c){var d=wg(b);b=Gf(b);return Pe({user:a,credential:d,additionalUserInfo:b,operationType:c})}function Jl(a,b){Fl(a,b);return a.reload().then(function(){return a})}g.qb=function(a){var b=this;return R(this,this.F().then(function(c){return b.b.qb(c,a)}).then(function(a){Fl(b,a);return b.reload()}))};g.Tc=function(a){var b=this;return R(this,this.F().then(function(c){return a.b(b.b,c)}).then(function(a){Fl(b,a);return b.reload()}))};g.rb=function(a){var b=this;return R(this,this.F().then(function(c){return b.b.rb(c,a)}).then(function(a){Fl(b,a);return b.reload()}))};g.sb=function(a){if(void 0===a.displayName&&void 0===a.photoURL)return xl(this);var b=this;return R(this,this.F().then(function(c){return b.b.sb(c,{displayName:a.displayName,photoUrl:a.photoURL})}).then(function(a){Fl(b,a);Bl(b,"displayName",a.displayName||null);Bl(b,"photoURL",a.photoUrl||null);v(b.providerData,function(a){"password"===a.providerId&&(J(a,"displayName",b.displayName),J(a,"photoURL",b.photoURL))});return ul(b)}).then(wl))};g.Rc=function(a){var b=this;return R(this,Dl(this).then(function(c){return Ha(yl(b),a)?si(b.b,c,[a]).then(function(a){var c={};v(a.providerUserInfo||[],function(a){c[a.providerId]=!0});v(yl(b),function(a){c[a]||Al(b,a)});c[tg.PROVIDER_ID]||J(b,"phoneNumber",null);return ul(b)}):ul(b).then(function(){throw new L("no-such-provider")})}))};g.delete=function(){var a=this;return R(this,this.F().then(function(b){return P(a.b,Gi,{idToken:b})}).then(function(){a.dispatchEvent(new jl("userDeleted"))})).then(function(){for(var b=0;b<a.G.length;b++)a.G[b].cancel("app-deleted");ol(a,null);pl(a,null);a.G=[];a.D=!0;sl(a);J(a,"refreshToken",null);a.a&&a.a.unsubscribe(a)})};g.wb=function(a,b){return"linkViaPopup"==a&&(this.g||null)==b&&this.f||"reauthViaPopup"==a&&(this.g||null)==b&&this.f||"linkViaRedirect"==a&&(this.aa||null)==b||"reauthViaRedirect"==a&&(this.aa||null)==b?!0:!1};g.ha=function(a,b,c,d){"linkViaPopup"!=a&&"reauthViaPopup"!=a||d!=(this.g||null)||(c&&this.v?this.v(c):b&&!c&&this.f&&this.f(b),this.c&&(this.c.cancel(),this.c=null),delete this.f,delete this.v)};g.xa=function(a,b){return"linkViaPopup"==a&&b==(this.g||null)?r(this.Bb,this):"reauthViaPopup"==a&&b==(this.g||null)?r(this.Cb,this):"linkViaRedirect"==a&&(this.aa||null)==b?r(this.Bb,this):"reauthViaRedirect"==a&&(this.aa||null)==b?r(this.Cb,this):null};g.tc=function(a){var b=this;return Kl(this,"linkViaPopup",a,function(){return Il(b,a.providerId).then(function(){return ul(b)})},!1)};g.Cc=function(a){return Kl(this,"reauthViaPopup",a,function(){return B()},!0)};function Kl(a,b,c,d,e){if(!we())return C(new L("operation-not-supported-in-this-environment"));if(a.i&&!e)return C(a.i);var f=Ff(c.providerId),h=ve(a.uid+":::"),m=null;(!ye()||ne())&&a.u&&c.isOAuthProvider&&(m=bj(a.u,a.l,a.m,b,c,null,h,firebase.SDK_VERSION||null));var p=ee(m,f&&f.Ba,f&&f.Aa);d=d().then(function(){Ll(a);if(!e)return a.F().then(function(){})}).then(function(){return Mk(a.a,p,b,c,h,!!m)}).then(function(){return new A(function(c,d){a.ha(b,null,new L("cancelled-popup-request"),a.g||null);a.f=c;a.v=d;a.g=h;a.c=a.a.Ea(a,b,p,h)})}).then(function(a){p&&de(p);return a?Pe(a):null}).s(function(a){p&&de(p);throw a});return R(a,d,e)}g.uc=function(a){var b=this;return Ml(this,"linkViaRedirect",a,function(){return Il(b,a.providerId)},!1)};g.Dc=function(a){return Ml(this,"reauthViaRedirect",a,function(){return B()},!0)};function Ml(a,b,c,d,e){if(!we())return C(new L("operation-not-supported-in-this-environment"));if(a.i&&!e)return C(a.i);var f=null,h=ve(a.uid+":::");d=d().then(function(){Ll(a);if(!e)return a.F().then(function(){})}).then(function(){a.aa=h;return ul(a)}).then(function(b){a.ba&&(b=a.ba,b=b.b.set(Nl,a.C(),b.a));return b}).then(function(){return a.a.Ca(b,c,h)}).s(function(b){f=b;if(a.ba)return Ol(a.ba);throw f}).then(function(){if(f)throw f});return R(a,d,e)}function Ll(a){if(!a.a||!a.I){if(a.a&&!a.I)throw new L("internal-error");throw new L("auth-domain-config-required")}}g.Bb=function(a,b,c){var d=this;this.c&&(this.c.cancel(),this.c=null);var e=null,f=this.F().then(function(e){return Vf(d.b,{requestUri:a,postBody:c,sessionId:b,idToken:e})}).then(function(a){e=Hl(d,a,"link");return Jl(d,a)}).then(function(){return e});return R(this,f)};g.Cb=function(a,b,c){var d=this;this.c&&(this.c.cancel(),this.c=null);var e=null,f=B().then(function(){return Rf(Wf(d.b,{requestUri:a,sessionId:b,postBody:c}),d.uid)}).then(function(a){e=Hl(d,a,"reauthenticate");Fl(d,a);d.i=null;return d.reload()}).then(function(){return e});return R(this,f,!0)};g.kb=function(a){var b=this,c=null;return R(this,this.F().then(function(b){c=b;return"undefined"===typeof a||Ya(a)?{}:pf(new ef(a))}).then(function(a){return b.b.kb(c,a)}).then(function(a){if(b.email!=a)return b.reload()}).then(function(){}))};function R(a,b,c){var d=Pl(a,b,c);a.G.push(d);d.ia(function(){Ia(a.G,d)});return d}function Pl(a,b,c){return a.i&&!c?(b.cancel(),C(a.i)):b.s(function(b){!b||"auth/user-disabled"!=b.code&&"auth/user-token-expired"!=b.code||(a.i||a.dispatchEvent(new jl("userInvalidated")),a.i=b);throw b})}g.toJSON=function(){return this.C()};g.C=function(){var a={uid:this.uid,displayName:this.displayName,photoURL:this.photoURL,email:this.email,emailVerified:this.emailVerified,phoneNumber:this.phoneNumber,isAnonymous:this.isAnonymous,providerData:[],apiKey:this.l,appName:this.m,authDomain:this.u,stsTokenManager:this.h.C(),redirectEventId:this.aa||null};this.metadata&&ab(a,this.metadata.C());v(this.providerData,function(b){a.providerData.push(Qe(b))});return a};function Ql(a){if(!a.apiKey)return null;var b={apiKey:a.apiKey,authDomain:a.authDomain,appName:a.appName},c={};if(a.stsTokenManager&&a.stsTokenManager.accessToken&&a.stsTokenManager.expirationTime)c[M]=a.stsTokenManager.accessToken,c.refreshToken=a.stsTokenManager.refreshToken||null,c.expiresIn=(a.stsTokenManager.expirationTime-qa())/1e3;else return null;var d=new Q(b,c,a);a.providerData&&v(a.providerData,function(a){a&&zl(d,Pe(a))});a.redirectEventId&&(d.aa=a.redirectEventId);return d}function Rl(a,b,c,d){var e=new Q(a,b);c&&(e.ba=c);d&&nl(e,d);return e.reload().then(function(){return e})}function Sl(a,b,c,d){b=b||{apiKey:a.l,authDomain:a.u,appName:a.m};var e=a.h,f={};f[M]=e.b;f.refreshToken=e.a;f.expiresIn=(e.c-qa())/1e3;b=new Q(b,f);c&&(b.ba=c);d&&nl(b,d);Cl(b,a);return b}function Tl(a){this.a=a;this.b=Qj()}var Nl={name:"redirectUser",A:"session"};function Ol(a){return Uj(a.b,Nl,a.a)}function Ul(a,b){return a.b.get(Nl,a.a).then(function(a){a&&b&&(a.authDomain=b);return Ql(a||{})})}function Wl(a){this.a=a;this.b=Qj();this.c=null;this.f=Xl(this);this.b.addListener(Yl("local"),this.a,r(this.g,this))}Wl.prototype.g=function(){var a=this,b=Yl("local");Zl(this,function(){return B().then(function(){return a.c&&"local"!=a.c.A?a.b.get(b,a.a):null}).then(function(c){if(c)return $l(a,"local").then(function(){a.c=b})})})};function $l(a,b){var c=[],d;for(d in Mj)Mj[d]!==b&&c.push(Uj(a.b,Yl(Mj[d]),a.a));c.push(Uj(a.b,am,a.a));return wb(c)}function Xl(a){var b=Yl("local"),c=Yl("session"),d=Yl("none");return Tj(a.b,b,a.a).then(function(){return a.b.get(c,a.a)}).then(function(e){return e?c:a.b.get(d,a.a).then(function(c){return c?d:a.b.get(b,a.a).then(function(c){return c?b:a.b.get(am,a.a).then(function(a){return a?Yl(a):b})})})}).then(function(b){a.c=b;return $l(a,b.A)}).s(function(){a.c||(a.c=b)})}var am={name:"persistence",A:"session"};function Yl(a){return{name:"authUser",A:a}}Wl.prototype.nb=function(a){var b=null,c=this;Nj(a);return Zl(this,function(){return a!=c.c.A?c.b.get(c.c,c.a).then(function(d){b=d;return $l(c,a)}).then(function(){c.c=Yl(a);if(b)return c.b.set(c.c,b,c.a)}):B()})};function bm(a){return Zl(a,function(){return a.b.set(am,a.c.A,a.a)})}function cm(a,b){return Zl(a,function(){return a.b.set(a.c,b.C(),a.a)})}function dm(a){return Zl(a,function(){return Uj(a.b,a.c,a.a)})}function em(a,b){return Zl(a,function(){return a.b.get(a.c,a.a).then(function(a){a&&b&&(a.authDomain=b);return Ql(a||{})})})}function Zl(a,b){a.f=a.f.then(b,b);return a.f}function fm(a){this.l=!1;J(this,"settings",new Vk);J(this,"app",a);if(S(this).options&&S(this).options.apiKey)a=firebase.SDK_VERSION?te(firebase.SDK_VERSION):null,this.b=new Nh(S(this).options&&S(this).options.apiKey,Af(Bf),a);else throw new L("invalid-api-key");this.N=[];this.m=[];this.I=[];this.Tb=firebase.INTERNAL.createSubscribe(r(this.oc,this));this.O=void 0;this.Ub=firebase.INTERNAL.createSubscribe(r(this.pc,this));gm(this,null);this.h=new Wl(S(this).options.apiKey+":"+S(this).name);this.w=new Tl(S(this).options.apiKey+":"+S(this).name);this.V=T(this,hm(this));this.i=T(this,im(this));this.X=!1;this.ka=r(this.Oc,this);this.Ha=r(this.Z,this);this.ra=r(this.bc,this);this.sa=r(this.mc,this);this.ta=r(this.nc,this);jm(this);this.INTERNAL={};this.INTERNAL["delete"]=r(this.delete,this);this.INTERNAL.logFramework=r(this.vc,this);this.u=0;F.call(this);km(this);this.G=[]}t(fm,F);function lm(a){D.call(this,"languageCodeChanged");this.g=a}t(lm,D);function mm(a){D.call(this,"frameworkChanged");this.c=a}t(mm,D);g=fm.prototype;g.nb=function(a){a=this.h.nb(a);return T(this,a)};g.pa=function(a){this.W===a||this.l||(this.W=a,Th(this.b,this.W),this.dispatchEvent(new lm(this.ea())))};g.ea=function(){return this.W};g.Uc=function(){var a=k.navigator;this.pa(a?a.languages&&a.languages[0]||a.language||a.userLanguage||null:null)};g.vc=function(a){this.G.push(a);Uh(this.b,firebase.SDK_VERSION?te(firebase.SDK_VERSION,this.G):null);this.dispatchEvent(new mm(this.G))};g.ya=function(){return Ka(this.G)};function km(a){Object.defineProperty(a,"lc",{get:function(){return this.ea()},set:function(a){this.pa(a)},enumerable:!1});a.W=null}g.toJSON=function(){return{apiKey:S(this).options.apiKey,authDomain:S(this).options.authDomain,appName:S(this).name,currentUser:U(this)&&U(this).C()}};function nm(a){return a.Sb||C(new L("auth-domain-config-required"))}function jm(a){var b=S(a).options.authDomain,c=S(a).options.apiKey;b&&we()&&(a.Sb=a.V.then(function(){if(!a.l){a.a=Ok(b,c,S(a).name);a.a.subscribe(a);U(a)&&vl(U(a));if(a.D){vl(a.D);var d=a.D;d.pa(a.ea());ol(d,a);d=a.D;nl(d,a.G);pl(d,a);a.D=null}return a.a}}))}g.wb=function(a,b){switch(a){case"unknown":case"signInViaRedirect":return!0;case"signInViaPopup":return this.g==b&&!!this.f;default:return!1}};g.ha=function(a,b,c,d){"signInViaPopup"==a&&this.g==d&&(c&&this.v?this.v(c):b&&!c&&this.f&&this.f(b),this.c&&(this.c.cancel(),this.c=null),delete this.f,delete this.v)};g.xa=function(a,b){return"signInViaRedirect"==a||"signInViaPopup"==a&&this.g==b&&this.f?r(this.ac,this):null};g.ac=function(a,b,c){var d=this;a={requestUri:a,postBody:c,sessionId:b};this.c&&(this.c.cancel(),this.c=null);var e=null,f=null,h=Tf(d.b,a).then(function(a){e=wg(a);f=Gf(a);return a});a=d.V.then(function(){return h}).then(function(a){return om(d,a)}).then(function(){return Pe({user:U(d),credential:e,additionalUserInfo:f,operationType:"signIn"})});return T(this,a)};g.Mc=function(a){if(!we())return C(new L("operation-not-supported-in-this-environment"));var b=this,c=Ff(a.providerId),d=ve(),e=null;(!ye()||ne())&&S(this).options.authDomain&&a.isOAuthProvider&&(e=bj(S(this).options.authDomain,S(this).options.apiKey,S(this).name,"signInViaPopup",a,null,d,firebase.SDK_VERSION||null));var f=ee(e,c&&c.Ba,c&&c.Aa);c=nm(this).then(function(b){return Mk(b,f,"signInViaPopup",a,d,!!e)}).then(function(){return new A(function(a,c){b.ha("signInViaPopup",null,new L("cancelled-popup-request"),b.g);b.f=a;b.v=c;b.g=d;b.c=b.a.Ea(b,"signInViaPopup",f,d)})}).then(function(a){f&&de(f);return a?Pe(a):null}).s(function(a){f&&de(f);throw a});return T(this,c)};g.Nc=function(a){if(!we())return C(new L("operation-not-supported-in-this-environment"));var b=this,c=nm(this).then(function(){return bm(b.h)}).then(function(){return b.a.Ca("signInViaRedirect",a)});return T(this,c)};g.fa=function(){if(!we())return C(new L("operation-not-supported-in-this-environment"));var a=this,b=nm(this).then(function(){return a.a.fa()}).then(function(a){return a?Pe(a):null});return T(this,b)};g.Sc=function(a){if(!a)return C(new L("null-user"));var b=this,c={};c.apiKey=S(this).options.apiKey;c.authDomain=S(this).options.authDomain;c.appName=S(this).name;var d=Sl(a,c,b.w,b.ya());return T(this,this.i.then(function(){if(S(b).options.apiKey!=a.l)return d.reload()}).then(function(){if(U(b)&&a.uid==U(b).uid)return Cl(U(b),a),b.Z(a);gm(b,d);vl(d);return b.Z(d)}).then(function(){pm(b)}))};function om(a,b){var c={};c.apiKey=S(a).options.apiKey;c.authDomain=S(a).options.authDomain;c.appName=S(a).name;return a.V.then(function(){return Rl(c,b,a.w,a.ya())}).then(function(b){if(U(a)&&b.uid==U(a).uid)return Cl(U(a),b),a.Z(b);gm(a,b);vl(b);return a.Z(b)}).then(function(){pm(a)})}function gm(a,b){U(a)&&(tl(U(a),a.Ha),E(U(a),"tokenChanged",a.ra),E(U(a),"userDeleted",a.sa),E(U(a),"userInvalidated",a.ta),sl(U(a)));b&&(b.N.push(a.Ha),sc(b,"tokenChanged",a.ra),sc(b,"userDeleted",a.sa),sc(b,"userInvalidated",a.ta),0<a.u&&rl(b));J(a,"currentUser",b);b&&(b.pa(a.ea()),ol(b,a),nl(b,a.G),pl(b,a))}g.ob=function(){var a=this,b=this.i.then(function(){if(!U(a))return B();gm(a,null);return dm(a.h).then(function(){pm(a)})});return T(this,b)};function qm(a){var b=Ul(a.w,S(a).options.authDomain).then(function(b){if(a.D=b)b.ba=a.w;return Ol(a.w)});return T(a,b)}function hm(a){var b=S(a).options.authDomain,c=qm(a).then(function(){return em(a.h,b)}).then(function(b){return b?(b.ba=a.w,a.D&&(a.D.aa||null)==(b.aa||null)?b:b.reload().then(function(){return cm(a.h,b).then(function(){return b})}).s(function(c){return"auth/network-request-failed"==c.code?b:dm(a.h)})):null}).then(function(b){gm(a,b||null)});return T(a,c)}function im(a){return a.V.then(function(){return a.fa()}).s(function(){}).then(function(){if(!a.l)return a.ka()}).s(function(){}).then(function(){if(!a.l){a.X=!0;var b=a.h;b.b.addListener(Yl("local"),b.a,a.ka)}})}g.Oc=function(){var a=this;return em(this.h,S(this).options.authDomain).then(function(b){if(!a.l){var c;if(c=U(a)&&b){c=U(a).uid;var d=b.uid;c=void 0===c||null===c||""===c||void 0===d||null===d||""===d?!1:c==d}if(c)return Cl(U(a),b),U(a).F();if(U(a)||b)gm(a,b),b&&(vl(b),b.ba=a.w),a.a&&a.a.subscribe(a),pm(a)}})};g.Z=function(a){return cm(this.h,a)};g.bc=function(){pm(this);this.Z(U(this))};g.mc=function(){this.ob()};g.nc=function(){this.ob()};function rm(a,b){var c=null,d=null;return T(a,b.then(function(b){c=wg(b);d=Gf(b);return om(a,b)}).then(function(){return Pe({user:U(a),credential:c,additionalUserInfo:d,operationType:"signIn"})}))}g.oc=function(a){var b=this;this.addAuthTokenListener(function(){a.next(U(b))})};g.pc=function(a){var b=this;sm(this,function(){a.next(U(b))})};g.xc=function(a,b,c){var d=this;this.X&&firebase.Promise.resolve().then(function(){n(a)?a(U(d)):n(a.next)&&a.next(U(d))});return this.Tb(a,b,c)};g.wc=function(a,b,c){var d=this;this.X&&firebase.Promise.resolve().then(function(){d.O=d.getUid();n(a)?a(U(d)):n(a.next)&&a.next(U(d))});return this.Ub(a,b,c)};g.cc=function(a){var b=this,c=this.i.then(function(){return U(b)?U(b).F(a).then(function(a){return{accessToken:a}}):null});return T(this,c)};g.Nb=function(a){var b=this;return this.i.then(function(){return rm(b,P(b.b,Ji,{token:a}))}).then(function(a){var c=a.user;Bl(c,"isAnonymous",!1);b.Z(c);return a})};g.Gc=function(a){Me("firebase.auth.Auth.prototype.signInAndRetrieveDataWithCustomToken is deprecated. Please use firebase.auth.Auth.prototype.signInWithCustomToken instead.");return this.Nb(a)};g.Hc=function(a,b){Me("firebase.auth.Auth.prototype.signInAndRetrieveDataWithEmailAndPassword is deprecated. Please use firebase.auth.Auth.prototype.signInWithEmailAndPassword instead.");return this.Ob(a,b)};g.Ob=function(a,b){var c=this;return this.i.then(function(){return rm(c,P(c.b,kg,{email:a,password:b}))})};g.yb=function(a,b){var c=this;return this.i.then(function(){return rm(c,P(c.b,Fi,{email:a,password:b}))})};g.Wb=function(a,b){Me("firebase.auth.Auth.prototype.createUserAndRetrieveDataWithEmailAndPassword is deprecated. Please use firebase.auth.Auth.prototype.createUserWithEmailAndPassword instead.");return this.yb(a,b)};g.Jc=function(a){Me("firebase.auth.Auth.prototype.signInWithCredential is deprecated. Please use firebase.auth.Auth.prototype.signInAndRetrieveDataWithCredential instead.");return this.Qa(a).then(function(a){return a.user})};g.Qa=function(a){var b=this;return this.i.then(function(){return rm(b,a.la(b.b))})};g.Ra=function(){var a=this;return this.i.then(function(){var b=U(a);if(b&&b.isAnonymous){var c=Pe({providerId:null,isNewUser:!1});return Pe({user:b,credential:null,additionalUserInfo:c,operationType:"signIn"})}return rm(a,a.b.Ra()).then(function(b){var c=b.user;Bl(c,"isAnonymous",!0);a.Z(c);return b})})};g.Ic=function(){Me("firebase.auth.Auth.prototype.signInAnonymouslyAndRetrieveData is deprecated. Please use firebase.auth.Auth.prototype.signInAnonymously instead.");return this.Ra()};function S(a){return a.app}function U(a){return a.currentUser}g.getUid=function(){return U(this)&&U(this).uid||null};function tm(a){return U(a)&&U(a)._lat||null}function pm(a){if(a.X){for(var b=0;b<a.m.length;b++)if(a.m[b])a.m[b](tm(a));if(a.O!==a.getUid()&&a.I.length)for(a.O=a.getUid(),b=0;b<a.I.length;b++)if(a.I[b])a.I[b](tm(a))}}g.Vb=function(a){this.addAuthTokenListener(a);this.u++;0<this.u&&U(this)&&rl(U(this))};g.Ec=function(a){var b=this;v(this.m,function(c){c==a&&b.u--});0>this.u&&(this.u=0);0==this.u&&U(this)&&sl(U(this));this.removeAuthTokenListener(a)};g.addAuthTokenListener=function(a){var b=this;this.m.push(a);T(this,this.i.then(function(){b.l||Ha(b.m,a)&&a(tm(b))}))};g.removeAuthTokenListener=function(a){w(this.m,function(b){return b==a})};function sm(a,b){a.I.push(b);T(a,a.i.then(function(){!a.l&&Ha(a.I,b)&&a.O!==a.getUid()&&(a.O=a.getUid(),b(tm(a)))}))}g.delete=function(){this.l=!0;for(var a=0;a<this.N.length;a++)this.N[a].cancel("app-deleted");this.N=[];this.h&&(a=this.h,a.b.removeListener(Yl("local"),a.a,this.ka));this.a&&(this.a.unsubscribe(this),this.a.Za());return firebase.Promise.resolve()};function T(a,b){a.N.push(b);b.ia(function(){Ia(a.N,b)});return b}g.Zb=function(a){Me("firebase.auth.Auth.prototype.fetchProvidersForEmail is deprecated. Please use firebase.auth.Auth.prototype.fetchSignInMethodsForEmail instead.");return T(this,di(this.b,a))};g.$b=function(a){return T(this,fi(this.b,a))};g.qc=function(a){return!!og(a)};g.mb=function(a,b){var c=this;return T(this,B().then(function(){var a=new ef(b);if(!a.c)throw new L("argument-error",nf+" must be true when sending sign in link to email");return pf(a)}).then(function(b){return c.b.mb(a,b)}).then(function(){}))};g.Vc=function(a){return this.Ja(a).then(function(a){return a.data.email})};g.$a=function(a,b){return T(this,this.b.$a(a,b).then(function(){}))};g.Ja=function(a){return T(this,this.b.Ja(a).then(function(a){return new Te(a)}))};g.Xa=function(a){return T(this,this.b.Xa(a).then(function(){}))};g.lb=function(a,b){var c=this;return T(this,B().then(function(){return"undefined"===typeof b||Ya(b)?{}:pf(new ef(b))}).then(function(b){return c.b.lb(a,b)}).then(function(){}))};g.Lc=function(a,b){return T(this,Xk(this,a,b,r(this.Qa,this)))};g.Kc=function(a,b){var c=this;return T(this,B().then(function(){var d=ng(a,b||Xd());return c.Qa(d)}))};function um(){}um.prototype.render=function(){};um.prototype.reset=function(){};um.prototype.getResponse=function(){};um.prototype.execute=function(){};function vm(){this.a={};this.b=1e12}var wm=null;vm.prototype.render=function(a,b){this.a[this.b.toString()]=new xm(a,b);return this.b++};vm.prototype.reset=function(a){var b=ym(this,a);a=zm(a);b&&a&&(b.delete(),delete this.a[a])};vm.prototype.getResponse=function(a){return(a=ym(this,a))?a.getResponse():null};vm.prototype.execute=function(a){(a=ym(this,a))&&a.execute()};function ym(a,b){return(b=zm(b))?a.a[b]||null:null}function zm(a){return(a="undefined"===typeof a?1e12:a)?a.toString():null}function xm(a,b){this.g=!1;this.c=b;this.a=this.b=null;this.h="invisible"!==this.c.size;this.f=Kd(a);var c=this;this.i=function(){c.execute()};this.h?this.execute():sc(this.f,"click",this.i)}xm.prototype.getResponse=function(){Am(this);return this.b};xm.prototype.execute=function(){Am(this);var a=this;this.a||(this.a=setTimeout(function(){a.b=re();var b=a.c.callback,c=a.c["expired-callback"];if(b)try{b(a.b)}catch(d){}a.a=setTimeout(function(){a.a=null;a.b=null;if(c)try{c()}catch(d){}a.h&&a.execute()},6e4)},500))};xm.prototype.delete=function(){Am(this);this.g=!0;clearTimeout(this.a);this.a=null;E(this.f,"click",this.i)};function Am(a){if(a.g)throw Error("reCAPTCHA mock was already deleted!")}function Bm(){}Bm.prototype.g=function(){wm||(wm=new vm);return B(wm)};Bm.prototype.c=function(){};var Cm=null;function Dm(){this.b=k.grecaptcha?Infinity:0;this.f=null;this.a="__rcb"+Math.floor(1e6*Math.random()).toString()}var Em=new od(pd,"https://www.google.com/recaptcha/api.js?onload=%{onload}&render=explicit&hl=%{hl}"),Fm=new Ee(3e4,6e4);Dm.prototype.g=function(a){var b=this;return new A(function(c,d){var e=setTimeout(function(){d(new L("network-request-failed"))},Fm.get());if(!k.grecaptcha||a!==b.f&&!b.b){k[b.a]=function(){if(k.grecaptcha){b.f=a;var f=k.grecaptcha.render;k.grecaptcha.render=function(a,c){a=f(a,c);b.b++;return a};clearTimeout(e);c(k.grecaptcha)}else clearTimeout(e),d(new L("internal-error"));delete k[b.a]};var f=vd(Em,{onload:b.a,hl:a||""});B(Gh(f)).s(function(){clearTimeout(e);d(new L("internal-error","Unable to load external reCAPTCHA dependencies!"))})}else clearTimeout(e),c(k.grecaptcha)})};Dm.prototype.c=function(){this.b--};var Gm=null;function Hm(a,b,c,d,e,f,h){J(this,"type","recaptcha");this.c=this.f=null;this.D=!1;this.l=b;this.g=null;h?(Cm||(Cm=new Bm),h=Cm):(Gm||(Gm=new Dm),h=Gm);this.m=h;this.a=c||{theme:"light",type:"image"};this.h=[];if(this.a[Im])throw new L("argument-error","sitekey should not be provided for reCAPTCHA as one is automatically provisioned for the current project.");this.i="invisible"===this.a[Jm];if(!k.document)throw new L("operation-not-supported-in-this-environment","RecaptchaVerifier is only supported in a browser HTTP/HTTPS environment with DOM support.");if(!Kd(b)||!this.i&&Kd(b).hasChildNodes())throw new L("argument-error","reCAPTCHA container is either not found or already contains inner elements!");this.u=new Nh(a,f||null,e||null);this.v=d||function(){return null};var m=this;this.o=[];var p=this.a[Km];this.a[Km]=function(a){Lm(m,a);if("function"===typeof p)p(a);else if("string"===typeof p){var b=I(p,k);"function"===typeof b&&b(a)}};var x=this.a[Mm];this.a[Mm]=function(){Lm(m,null);if("function"===typeof x)x();else if("string"===typeof x){var a=I(x,k);"function"===typeof a&&a()}}}var Km="callback",Mm="expired-callback",Im="sitekey",Jm="size";function Lm(a,b){for(var c=0;c<a.o.length;c++)try{a.o[c](b)}catch(d){}}function Nm(a,b){w(a.o,function(a){return a==b})}function Om(a,b){a.h.push(b);b.ia(function(){Ia(a.h,b)});return b}g=Hm.prototype;g.za=function(){var a=this;return this.f?this.f:this.f=Om(this,B().then(function(){if(xe()&&!oe())return je();throw new L("operation-not-supported-in-this-environment","RecaptchaVerifier is only supported in a browser HTTP/HTTPS environment.")}).then(function(){return a.m.g(a.v())}).then(function(b){a.g=b;return P(a.u,Ii,{})}).then(function(b){a.a[Im]=b.recaptchaSiteKey}).s(function(b){a.f=null;throw b}))};g.render=function(){Pm(this);var a=this;return Om(this,this.za().then(function(){if(null===a.c){var b=a.l;if(!a.i){var c=Kd(b);b=Nd("DIV");c.appendChild(b)}a.c=a.g.render(b,a.a)}return a.c}))};g.verify=function(){Pm(this);var a=this;return Om(this,this.render().then(function(b){return new A(function(c){var d=a.g.getResponse(b);if(d)c(d);else{var e=function(b){b&&(Nm(a,e),c(b))};a.o.push(e);a.i&&a.g.execute(a.c)}})}))};g.reset=function(){Pm(this);null!==this.c&&this.g.reset(this.c)};function Pm(a){if(a.D)throw new L("internal-error","RecaptchaVerifier instance has been destroyed.")}g.clear=function(){Pm(this);this.D=!0;this.m.c();for(var a=0;a<this.h.length;a++)this.h[a].cancel("RecaptchaVerifier instance has been destroyed.");if(!this.i){a=Kd(this.l);for(var b;b=a.firstChild;)a.removeChild(b)}};function Qm(a,b,c){var d=!1;try{this.b=c||firebase.app()}catch(h){throw new L("argument-error","No firebase.app.App instance is currently initialized.")}if(this.b.options&&this.b.options.apiKey)c=this.b.options.apiKey;else throw new L("invalid-api-key");var e=this,f=null;try{f=this.b.auth().ya()}catch(h){}try{d=this.b.auth().settings.appVerificationDisabledForTesting}catch(h){}f=firebase.SDK_VERSION?te(firebase.SDK_VERSION,f):null;Hm.call(this,c,a,b,function(){try{var a=e.b.auth().ea()}catch(m){a=null}return a},f,Af(Bf),d)}t(Qm,Hm);function Rm(a,b,c,d){a:{c=Array.prototype.slice.call(c);var e=0;for(var f=!1,h=0;h<b.length;h++)if(b[h].optional)f=!0;else{if(f)throw new L("internal-error","Argument validator encountered a required argument after an optional argument.");e++}f=b.length;if(c.length<e||f<c.length)d="Expected "+(e==f?1==e?"1 argument":e+" arguments":e+"-"+f+" arguments")+" but got "+c.length+".";else{for(e=0;e<c.length;e++)if(f=b[e].optional&&void 0===c[e],!b[e].M(c[e])&&!f){b=b[e];if(0>e||e>=Sm.length)throw new L("internal-error","Argument validator received an unsupported number of arguments.");c=Sm[e];d=(d?"":c+" argument ")+(b.name?'"'+b.name+'" ':"")+"must be "+b.K+".";break a}d=null}}if(d)throw new L("argument-error",a+" failed: "+d)}var Sm="First Second Third Fourth Fifth Sixth Seventh Eighth Ninth".split(" ");function V(a,b){return{name:a||"",K:"a valid string",optional:!!b,M:l}}function Tm(a,b){return{name:a||"",K:"a boolean",optional:!!b,M:ba}}function W(a,b){return{name:a||"",K:"a valid object",optional:!!b,M:q}}function Um(a,b){return{name:a||"",K:"a function",optional:!!b,M:n}}function Vm(a,b){return{name:a||"",K:"null",optional:!!b,M:ha}}function Wm(){return{name:"",K:"an HTML element",optional:!1,M:function(a){return!!(a&&a instanceof Element)}}}function Xm(){return{name:"auth",K:"an instance of Firebase Auth",optional:!0,M:function(a){return!!(a&&a instanceof fm)}}}function Ym(){return{name:"app",K:"an instance of Firebase App",optional:!0,M:function(a){return!!(a&&a instanceof firebase.app.App)}}}function Zm(a){return{name:a?a+"Credential":"credential",K:a?"a valid "+a+" credential":"a valid credential",optional:!1,M:function(b){if(!b)return!1;var c=!a||b.providerId===a;return!(!b.la||!c)}}}function $m(){return{name:"authProvider",K:"a valid Auth provider",optional:!1,M:function(a){return!!(a&&a.providerId&&a.hasOwnProperty&&a.hasOwnProperty("isOAuthProvider"))}}}function an(){return{name:"applicationVerifier",K:"an implementation of firebase.auth.ApplicationVerifier",optional:!1,M:function(a){return!!(a&&l(a.type)&&n(a.verify))}}}function X(a,b,c,d){return{name:c||"",K:a.K+" or "+b.K,optional:!!d,M:function(c){return a.M(c)||b.M(c)}}}function Y(a,b){for(var c in b){var d=b[c].name;a[d]=bn(d,a[c],b[c].j)}}function cn(a,b){for(var c in b){var d=b[c].name;d!==c&&Object.defineProperty(a,d,{get:pa(function(a){return this[a]},c),set:pa(function(a,b,c,d){Rm(a,[c],[d],!0);this[b]=d},d,c,b[c].ub),enumerable:!0})}}function Z(a,b,c,d){a[b]=bn(b,c,d)}function bn(a,b,c){function d(){var a=Array.prototype.slice.call(arguments);Rm(e,c,a);return b.apply(this,a)}if(!c)return b;var e=dn(a),f;for(f in b)d[f]=b[f];for(f in b.prototype)d.prototype[f]=b.prototype[f];return d}function dn(a){a=a.split(".");return a[a.length-1]}Y(fm.prototype,{Xa:{name:"applyActionCode",j:[V("code")]},Ja:{name:"checkActionCode",j:[V("code")]},$a:{name:"confirmPasswordReset",j:[V("code"),V("newPassword")]},yb:{name:"createUserWithEmailAndPassword",j:[V("email"),V("password")]},Wb:{name:"createUserAndRetrieveDataWithEmailAndPassword",j:[V("email"),V("password")]},Zb:{name:"fetchProvidersForEmail",j:[V("email")]},$b:{name:"fetchSignInMethodsForEmail",j:[V("email")]},fa:{name:"getRedirectResult",j:[]},qc:{name:"isSignInWithEmailLink",j:[V("emailLink")]},wc:{name:"onAuthStateChanged",j:[X(W(),Um(),"nextOrObserver"),Um("opt_error",!0),Um("opt_completed",!0)]},xc:{name:"onIdTokenChanged",j:[X(W(),Um(),"nextOrObserver"),Um("opt_error",!0),Um("opt_completed",!0)]},lb:{name:"sendPasswordResetEmail",j:[V("email"),X(W("opt_actionCodeSettings",!0),Vm(null,!0),"opt_actionCodeSettings",!0)]},mb:{name:"sendSignInLinkToEmail",j:[V("email"),W("actionCodeSettings")]},nb:{name:"setPersistence",j:[V("persistence")]},Qa:{name:"signInAndRetrieveDataWithCredential",j:[Zm()]},Ra:{name:"signInAnonymously",j:[]},Ic:{name:"signInAnonymouslyAndRetrieveData",j:[]},Jc:{name:"signInWithCredential",j:[Zm()]},Nb:{name:"signInWithCustomToken",j:[V("token")]},Gc:{name:"signInAndRetrieveDataWithCustomToken",j:[V("token")]},Ob:{name:"signInWithEmailAndPassword",j:[V("email"),V("password")]},Kc:{name:"signInWithEmailLink",j:[V("email"),V("emailLink",!0)]},Hc:{name:"signInAndRetrieveDataWithEmailAndPassword",j:[V("email"),V("password")]},Lc:{name:"signInWithPhoneNumber",j:[V("phoneNumber"),an()]},Mc:{name:"signInWithPopup",j:[$m()]},Nc:{name:"signInWithRedirect",j:[$m()]},Sc:{name:"updateCurrentUser",j:[X(function(a){return{name:"user",K:"an instance of Firebase User",optional:!!a,M:function(a){return!!(a&&a instanceof Q)}}}(),Vm(),"user")]},ob:{name:"signOut",j:[]},toJSON:{name:"toJSON",j:[V(null,!0)]},Uc:{name:"useDeviceLanguage",j:[]},Vc:{name:"verifyPasswordResetCode",j:[V("code")]}});cn(fm.prototype,{lc:{name:"languageCode",ub:X(V(),Vm(),"languageCode")}});fm.Persistence=Mj;fm.Persistence.LOCAL="local";fm.Persistence.SESSION="session";fm.Persistence.NONE="none";Y(Q.prototype,{delete:{name:"delete",j:[]},dc:{name:"getIdTokenResult",j:[Tm("opt_forceRefresh",!0)]},F:{name:"getIdToken",j:[Tm("opt_forceRefresh",!0)]},fb:{name:"linkAndRetrieveDataWithCredential",j:[Zm()]},rc:{name:"linkWithCredential",j:[Zm()]},sc:{name:"linkWithPhoneNumber",j:[V("phoneNumber"),an()]},tc:{name:"linkWithPopup",j:[$m()]},uc:{name:"linkWithRedirect",j:[$m()]},hb:{name:"reauthenticateAndRetrieveDataWithCredential",j:[Zm()]},Ac:{name:"reauthenticateWithCredential",j:[Zm()]},Bc:{name:"reauthenticateWithPhoneNumber",j:[V("phoneNumber"),an()]},Cc:{name:"reauthenticateWithPopup",j:[$m()]},Dc:{name:"reauthenticateWithRedirect",j:[$m()]},reload:{name:"reload",j:[]},kb:{name:"sendEmailVerification",j:[X(W("opt_actionCodeSettings",!0),Vm(null,!0),"opt_actionCodeSettings",!0)]},toJSON:{name:"toJSON",j:[V(null,!0)]},Rc:{name:"unlink",j:[V("provider")]},qb:{name:"updateEmail",j:[V("email")]},rb:{name:"updatePassword",j:[V("password")]},Tc:{name:"updatePhoneNumber",j:[Zm("phone")]},sb:{name:"updateProfile",j:[W("profile")]}});Y(vm.prototype,{execute:{name:"execute"},render:{name:"render"},reset:{name:"reset"},getResponse:{name:"getResponse"}});Y(um.prototype,{execute:{name:"execute"},render:{name:"render"},reset:{name:"reset"},getResponse:{name:"getResponse"}});Y(A.prototype,{ia:{name:"finally"},s:{name:"catch"},then:{name:"then"}});cn(Vk.prototype,{appVerificationDisabled:{name:"appVerificationDisabledForTesting",ub:Tm("appVerificationDisabledForTesting")}});Y(Wk.prototype,{confirm:{name:"confirm",j:[V("verificationCode")]}});Z(O,"credential",function(a,b){return new ig(a,b)},[V("email"),V("password")]);Y(ag.prototype,{ua:{name:"addScope",j:[V("scope")]},Da:{name:"setCustomParameters",j:[W("customOAuthParameters")]}});Z(ag,"credential",bg,[X(V(),W(),"token")]);Z(O,"credentialWithLink",ng,[V("email"),V("emailLink")]);Y(cg.prototype,{ua:{name:"addScope",j:[V("scope")]},Da:{name:"setCustomParameters",j:[W("customOAuthParameters")]}});Z(cg,"credential",dg,[X(V(),W(),"token")]);Y(eg.prototype,{ua:{name:"addScope",j:[V("scope")]},Da:{name:"setCustomParameters",j:[W("customOAuthParameters")]}});Z(eg,"credential",fg,[X(V(),X(W(),Vm()),"idToken"),X(V(),Vm(),"accessToken",!0)]);Y(gg.prototype,{Da:{name:"setCustomParameters",j:[W("customOAuthParameters")]}});Z(gg,"credential",hg,[X(V(),W(),"token"),V("secret",!0)]);Y(N.prototype,{ua:{name:"addScope",j:[V("scope")]},credential:{name:"credential",j:[X(V(),Vm(),"idToken",!0),X(V(),Vm(),"accessToken",!0),X(V(),Vm(),"nonce",!0)]},Da:{name:"setCustomParameters",j:[W("customOAuthParameters")]}});Z(tg,"credential",vg,[V("verificationId"),V("verificationCode")]);Y(tg.prototype,{Va:{name:"verifyPhoneNumber",j:[V("phoneNumber"),an()]}});Y(L.prototype,{toJSON:{name:"toJSON",j:[V(null,!0)]}});Y(Dg.prototype,{toJSON:{name:"toJSON",j:[V(null,!0)]}});Y(Cg.prototype,{toJSON:{name:"toJSON",j:[V(null,!0)]}});Y(Qm.prototype,{clear:{name:"clear",j:[]},render:{name:"render",j:[]},verify:{name:"verify",j:[]}});(function(){if("undefined"!==typeof firebase&&firebase.INTERNAL&&firebase.INTERNAL.registerService){var a={Auth:fm,Error:L};Z(a,"EmailAuthProvider",O,[]);Z(a,"FacebookAuthProvider",ag,[]);Z(a,"GithubAuthProvider",cg,[]);Z(a,"GoogleAuthProvider",eg,[]);Z(a,"TwitterAuthProvider",gg,[]);Z(a,"OAuthProvider",N,[V("providerId")]);Z(a,"SAMLAuthProvider",$f,[V("providerId")]);Z(a,"PhoneAuthProvider",tg,[Xm()]);Z(a,"RecaptchaVerifier",Qm,[X(V(),Wm(),"recaptchaContainer"),W("recaptchaParameters",!0),Ym()]);firebase.INTERNAL.registerService("auth",function(a,c){a=new fm(a);c({INTERNAL:{getUid:r(a.getUid,a),getToken:r(a.cc,a),addAuthTokenListener:r(a.Vb,a),removeAuthTokenListener:r(a.Ec,a)}});return a},a,function(a,c){if("create"===a)try{c.auth()}catch(d){}});firebase.INTERNAL.extendNamespace({User:Q})}else throw Error("Cannot find the firebase namespace; be sure to include firebase-app.js before this library.")})()}).apply(typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"@firebase/app":5}],7:[function(require,module,exports){(function(process){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopDefault(ex){return ex&&typeof ex==="object"&&"default"in ex?ex["default"]:ex}var firebase=_interopDefault(require("@firebase/app"));var logger=require("@firebase/logger");var tslib_1=require("tslib");var webchannelWrapper=require("@firebase/webchannel-wrapper");var util=require("@firebase/util");var SDK_VERSION=firebase.SDK_VERSION;var logClient=new logger.Logger("@firebase/firestore");var LogLevel;(function(LogLevel){LogLevel[LogLevel["DEBUG"]=0]="DEBUG";LogLevel[LogLevel["ERROR"]=1]="ERROR";LogLevel[LogLevel["SILENT"]=2]="SILENT"})(LogLevel||(LogLevel={}));function getLogLevel(){if(logClient.logLevel===logger.LogLevel.DEBUG){return LogLevel.DEBUG}else if(logClient.logLevel===logger.LogLevel.SILENT){return LogLevel.SILENT}else{return LogLevel.ERROR}}function setLogLevel(newLevel){switch(newLevel){case LogLevel.DEBUG:logClient.logLevel=logger.LogLevel.DEBUG;break;case LogLevel.ERROR:logClient.logLevel=logger.LogLevel.ERROR;break;case LogLevel.SILENT:logClient.logLevel=logger.LogLevel.SILENT;break;default:logClient.error("Firestore ("+SDK_VERSION+"): Invalid value passed to `setLogLevel`")}}function debug(tag,msg){var obj=[];for(var _i=2;_i<arguments.length;_i++){obj[_i-2]=arguments[_i]}if(logClient.logLevel<=logger.LogLevel.DEBUG){var args=obj.map(argToString);logClient.debug.apply(logClient,["Firestore ("+SDK_VERSION+") ["+tag+"]: "+msg].concat(args))}}function error(msg){var obj=[];for(var _i=1;_i<arguments.length;_i++){obj[_i-1]=arguments[_i]}if(logClient.logLevel<=logger.LogLevel.ERROR){var args=obj.map(argToString);logClient.error.apply(logClient,["Firestore ("+SDK_VERSION+"): "+msg].concat(args))}}function argToString(obj){if(typeof obj==="string"){return obj}else{var platform=PlatformSupport.getPlatform();try{return platform.formatJSON(obj)}catch(e){return obj}}}function fail(failure){var message="FIRESTORE ("+SDK_VERSION+") INTERNAL ASSERTION FAILED: "+failure;error(message);throw new Error(message)}function assert(assertion,message){if(!assertion){fail(message)}}var PlatformSupport=function(){function PlatformSupport(){}PlatformSupport.setPlatform=function(platform){if(PlatformSupport.platform){fail("Platform already defined")}PlatformSupport.platform=platform};PlatformSupport.getPlatform=function(){if(!PlatformSupport.platform){fail("Platform not set")}return PlatformSupport.platform};return PlatformSupport}();function emptyByteString(){return PlatformSupport.getPlatform().emptyByteString}var Code={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};var FirestoreError=function(_super){tslib_1.__extends(FirestoreError,_super);function FirestoreError(code,message){var _this=_super.call(this,message)||this;_this.code=code;_this.message=message;_this.name="FirebaseError";_this.toString=function(){return _this.name+": [code="+_this.code+"]: "+_this.message};return _this}return FirestoreError}(Error);function makeConstructorPrivate(cls,optionalMessage){function PublicConstructor(){var error="This constructor is private.";if(optionalMessage){error+=" ";error+=optionalMessage}throw new FirestoreError(Code.INVALID_ARGUMENT,error)}PublicConstructor.prototype=cls.prototype;for(var staticProperty in cls){if(cls.hasOwnProperty(staticProperty)){PublicConstructor[staticProperty]=cls[staticProperty]}}return PublicConstructor}function contains(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)}function defaulted(value,defaultValue){return value!==undefined?value:defaultValue}function forEachNumber(obj,fn){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var num=Number(key);if(!isNaN(num)){fn(num,obj[key])}}}}function values(obj){var vs=[];forEach(obj,function(_,v){return vs.push(v)});return vs}function forEach(obj,fn){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){fn(key,obj[key])}}}function isEmpty(obj){assert(obj!=null&&typeof obj==="object","isEmpty() expects object parameter.");for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){return false}}return true}function shallowCopy(obj){assert(obj&&typeof obj==="object","shallowCopy() expects object parameter.");var result={};for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){result[key]=obj[key]}}return result}function validateNoArgs(functionName,args){if(args.length!==0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() does not support arguments, "+"but was called with "+formatPlural(args.length,"argument")+".")}}function validateExactNumberOfArgs(functionName,args,numberOfArgs){if(args.length!==numberOfArgs){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires "+formatPlural(numberOfArgs,"argument")+", but was called with "+formatPlural(args.length,"argument")+".")}}function validateAtLeastNumberOfArgs(functionName,args,minNumberOfArgs){if(args.length<minNumberOfArgs){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires at least "+formatPlural(minNumberOfArgs,"argument")+", but was called with "+formatPlural(args.length,"argument")+".")}}function validateBetweenNumberOfArgs(functionName,args,minNumberOfArgs,maxNumberOfArgs){if(args.length<minNumberOfArgs||args.length>maxNumberOfArgs){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires between "+minNumberOfArgs+" and "+(maxNumberOfArgs+" arguments, but was called with ")+formatPlural(args.length,"argument")+".")}}function validateNamedArrayAtLeastNumberOfElements(functionName,value,name,minNumberOfElements){if(!(value instanceof Array)||value.length<minNumberOfElements){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+name+" argument to be an "+"array with at least "+(formatPlural(minNumberOfElements,"element")+"."))}}function validateArgType(functionName,type,position,argument){validateType(functionName,type,ordinal(position)+" argument",argument)}function validateOptionalArgType(functionName,type,position,argument){if(argument!==undefined){validateArgType(functionName,type,position,argument)}}function validateNamedType(functionName,type,optionName,argument){validateType(functionName,type,optionName+" option",argument)}function validateNamedOptionalType(functionName,type,optionName,argument){if(argument!==undefined){validateNamedType(functionName,type,optionName,argument)}}function validateArrayElements(functionName,optionName,typeDescription,argument,validator){if(!(argument instanceof Array)){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+optionName+" "+("option to be an array, but it was: "+valueDescription(argument)))}for(var i=0;i<argument.length;++i){if(!validator(argument[i])){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires all "+optionName+" "+("elements to be "+typeDescription+", but the value at index "+i+" ")+("was: "+valueDescription(argument[i])))}}}function validateOptionalArrayElements(functionName,optionName,typeDescription,argument,validator){if(argument!==undefined){validateArrayElements(functionName,optionName,typeDescription,argument,validator)}}function validateNamedPropertyEquals(functionName,inputName,optionName,input,expected){var expectedDescription=[];for(var _i=0,expected_1=expected;_i<expected_1.length;_i++){var val=expected_1[_i];if(val===input){return}expectedDescription.push(valueDescription(val))}var actualDescription=valueDescription(input);throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid value "+actualDescription+" provided to function "+functionName+"() for option "+('"'+optionName+'". Acceptable values: '+expectedDescription.join(", ")))}function validateNamedOptionalPropertyEquals(functionName,inputName,optionName,input,expected){if(input!==undefined){validateNamedPropertyEquals(functionName,inputName,optionName,input,expected)}}function validateType(functionName,type,inputName,input){var valid=false;if(type==="object"){valid=isPlainObject(input)}else if(type==="non-empty string"){valid=typeof input==="string"&&input!==""}else{valid=typeof input===type}if(!valid){var description=valueDescription(input);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+inputName+" "+("to be of type "+type+", but it was: "+description))}}function isPlainObject(input){return typeof input==="object"&&input!==null&&(Object.getPrototypeOf(input)===Object.prototype||Object.getPrototypeOf(input)===null)}function valueDescription(input){if(input===undefined){return"undefined"}else if(input===null){return"null"}else if(typeof input==="string"){if(input.length>20){input=input.substring(0,20)+"..."}return JSON.stringify(input)}else if(typeof input==="number"||typeof input==="boolean"){return""+input}else if(typeof input==="object"){if(input instanceof Array){return"an array"}else{var customObjectName=tryGetCustomObjectType(input);if(customObjectName){return"a custom "+customObjectName+" object"}else{return"an object"}}}else if(typeof input==="function"){return"a function"}else{return fail("Unknown wrong type: "+typeof input)}}function tryGetCustomObjectType(input){if(input.constructor){var funcNameRegex=/function\s+([^\s(]+)\s*\(/;var results=funcNameRegex.exec(input.constructor.toString());if(results&&results.length>1){return results[1]}}return null}function validateDefined(functionName,position,argument){if(argument===undefined){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires a valid "+ordinal(position)+" "+"argument, but it was undefined.")}}function validateOptionNames(functionName,options,optionNames){forEach(options,function(key,_){if(optionNames.indexOf(key)<0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Unknown option '"+key+"' passed to function "+functionName+"(). "+"Available options: "+optionNames.join(", "))}})}function invalidClassError(functionName,type,position,argument){var description=valueDescription(argument);return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+ordinal(position)+" "+("argument to be a "+type+", but it was: "+description))}function ordinal(num){switch(num){case 1:return"first";case 2:return"second";case 3:return"third";default:return num+"th"}}function formatPlural(num,str){return num+" "+str+(num===1?"":"s")}var AutoId=function(){function AutoId(){}AutoId.newId=function(){var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var autoId="";for(var i=0;i<20;i++){autoId+=chars.charAt(Math.floor(Math.random()*chars.length))}assert(autoId.length===20,"Invalid auto ID: "+autoId);return autoId};return AutoId}();function primitiveComparator(left,right){if(left<right)return-1;if(left>right)return 1;return 0}function equals(left,right){if(left!==null&&left!==undefined){return!!(right&&left.isEqual(right))}else{return left===right}}function arrayEquals(left,right){if(left.length!==right.length){return false}for(var i=0;i<left.length;i++){if(!left[i].isEqual(right[i])){return false}}return true}function immediateSuccessor(s){return s+"\0"}function assertUint8ArrayAvailable(){if(typeof Uint8Array==="undefined"){throw new FirestoreError(Code.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}}function assertBase64Available(){if(!PlatformSupport.getPlatform().base64Available){throw new FirestoreError(Code.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}}var Blob=function(){function Blob(binaryString){assertBase64Available();this._binaryString=binaryString}Blob.fromBase64String=function(base64){validateExactNumberOfArgs("Blob.fromBase64String",arguments,1);validateArgType("Blob.fromBase64String","string",1,base64);assertBase64Available();try{var binaryString=PlatformSupport.getPlatform().atob(base64);return new Blob(binaryString)}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+e)}};Blob.fromUint8Array=function(array){validateExactNumberOfArgs("Blob.fromUint8Array",arguments,1);assertUint8ArrayAvailable();if(!(array instanceof Uint8Array)){throw invalidClassError("Blob.fromUint8Array","Uint8Array",1,array)}var binaryString=Array.prototype.map.call(array,function(char){return String.fromCharCode(char)}).join("");return new Blob(binaryString)};Blob.prototype.toBase64=function(){validateExactNumberOfArgs("Blob.toBase64",arguments,0);assertBase64Available();return PlatformSupport.getPlatform().btoa(this._binaryString)};Blob.prototype.toUint8Array=function(){validateExactNumberOfArgs("Blob.toUint8Array",arguments,0);assertUint8ArrayAvailable();var buffer=new Uint8Array(this._binaryString.length);for(var i=0;i<this._binaryString.length;i++){buffer[i]=this._binaryString.charCodeAt(i)}return buffer};Blob.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"};Blob.prototype.isEqual=function(other){return this._binaryString===other._binaryString};Blob.prototype._compareTo=function(other){return primitiveComparator(this._binaryString,other._binaryString)};return Blob}();var PublicBlob=makeConstructorPrivate(Blob,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead.");var GeoPoint=function(){function GeoPoint(latitude,longitude){validateExactNumberOfArgs("GeoPoint",arguments,2);validateArgType("GeoPoint","number",1,latitude);validateArgType("GeoPoint","number",2,longitude);if(!isFinite(latitude)||latitude<-90||latitude>90){throw new FirestoreError(Code.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+latitude)}if(!isFinite(longitude)||longitude<-180||longitude>180){throw new FirestoreError(Code.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+longitude)}this._lat=latitude;this._long=longitude}Object.defineProperty(GeoPoint.prototype,"latitude",{get:function(){return this._lat},enumerable:true,configurable:true});Object.defineProperty(GeoPoint.prototype,"longitude",{get:function(){return this._long},enumerable:true,configurable:true});GeoPoint.prototype.isEqual=function(other){return this._lat===other._lat&&this._long===other._long};GeoPoint.prototype._compareTo=function(other){return primitiveComparator(this._lat,other._lat)||primitiveComparator(this._long,other._long)};return GeoPoint}();var Timestamp=function(){function Timestamp(seconds,nanoseconds){this.seconds=seconds;this.nanoseconds=nanoseconds;if(nanoseconds<0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+nanoseconds)}if(nanoseconds>=1e9){throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+nanoseconds)}if(seconds<-62135596800){throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp seconds out of range: "+seconds)}if(seconds>=253402300800){throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp seconds out of range: "+seconds)}}Timestamp.now=function(){return Timestamp.fromMillis(Date.now())};Timestamp.fromDate=function(date){return Timestamp.fromMillis(date.getTime())};Timestamp.fromMillis=function(milliseconds){var seconds=Math.floor(milliseconds/1e3);var nanos=(milliseconds-seconds*1e3)*1e6;return new Timestamp(seconds,nanos)};Timestamp.prototype.toDate=function(){return new Date(this.toMillis())};Timestamp.prototype.toMillis=function(){return this.seconds*1e3+this.nanoseconds/1e6};Timestamp.prototype._compareTo=function(other){if(this.seconds===other.seconds){return primitiveComparator(this.nanoseconds,other.nanoseconds)}return primitiveComparator(this.seconds,other.seconds)};Timestamp.prototype.isEqual=function(other){return other.seconds===this.seconds&&other.nanoseconds===this.nanoseconds};Timestamp.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"};return Timestamp}();var DatabaseInfo=function(){function DatabaseInfo(databaseId,persistenceKey,host,ssl){this.databaseId=databaseId;this.persistenceKey=persistenceKey;this.host=host;this.ssl=ssl}return DatabaseInfo}();var DEFAULT_DATABASE_NAME="(default)";var DatabaseId=function(){function DatabaseId(projectId,database){this.projectId=projectId;this.database=database?database:DEFAULT_DATABASE_NAME}Object.defineProperty(DatabaseId.prototype,"isDefaultDatabase",{get:function(){return this.database===DEFAULT_DATABASE_NAME},enumerable:true,configurable:true});DatabaseId.prototype.isEqual=function(other){return other instanceof DatabaseId&&other.projectId===this.projectId&&other.database===this.database};DatabaseId.prototype.compareTo=function(other){return primitiveComparator(this.projectId,other.projectId)||primitiveComparator(this.database,other.database)};return DatabaseId}();var DOCUMENT_KEY_NAME="__name__";var Path=function(){function Path(segments,offset,length){this.init(segments,offset,length)}Path.prototype.init=function(segments,offset,length){if(offset===undefined){offset=0}else if(offset>segments.length){fail("offset "+offset+" out of range "+segments.length)}if(length===undefined){length=segments.length-offset}else if(length>segments.length-offset){fail("length "+length+" out of range "+(segments.length-offset))}this.segments=segments;this.offset=offset;this.len=length};Path.prototype.construct=function(segments,offset,length){var path=Object.create(Object.getPrototypeOf(this));path.init(segments,offset,length);return path};Object.defineProperty(Path.prototype,"length",{get:function(){return this.len},enumerable:true,configurable:true});Path.prototype.isEqual=function(other){return Path.comparator(this,other)===0};Path.prototype.child=function(nameOrPath){var segments=this.segments.slice(this.offset,this.limit());if(nameOrPath instanceof Path){nameOrPath.forEach(function(segment){segments.push(segment)})}else if(typeof nameOrPath==="string"){segments.push(nameOrPath)}else{fail("Unknown parameter type for Path.child(): "+nameOrPath)}return this.construct(segments)};Path.prototype.limit=function(){return this.offset+this.length};Path.prototype.popFirst=function(size){size=size===undefined?1:size;assert(this.length>=size,"Can't call popFirst() with less segments");return this.construct(this.segments,this.offset+size,this.length-size)};Path.prototype.popLast=function(){assert(!this.isEmpty(),"Can't call popLast() on empty path");return this.construct(this.segments,this.offset,this.length-1)};Path.prototype.firstSegment=function(){assert(!this.isEmpty(),"Can't call firstSegment() on empty path");return this.segments[this.offset]};Path.prototype.lastSegment=function(){return this.get(this.length-1)};Path.prototype.get=function(index){assert(index<this.length,"Index out of range");return this.segments[this.offset+index]};Path.prototype.isEmpty=function(){return this.length===0};Path.prototype.isPrefixOf=function(other){if(other.length<this.length){return false}for(var i=0;i<this.length;i++){if(this.get(i)!==other.get(i)){return false}}return true};Path.prototype.isImmediateParentOf=function(potentialChild){if(this.length+1!==potentialChild.length){return false}for(var i=0;i<this.length;i++){if(this.get(i)!==potentialChild.get(i)){return false}}return true};Path.prototype.forEach=function(fn){for(var i=this.offset,end=this.limit();i<end;i++){fn(this.segments[i])}};Path.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())};Path.comparator=function(p1,p2){var len=Math.min(p1.length,p2.length);for(var i=0;i<len;i++){var left=p1.get(i);var right=p2.get(i);if(left<right)return-1;if(left>right)return 1}if(p1.length<p2.length)return-1;if(p1.length>p2.length)return 1;return 0};return Path}();var ResourcePath=function(_super){tslib_1.__extends(ResourcePath,_super);function ResourcePath(){return _super!==null&&_super.apply(this,arguments)||this}ResourcePath.prototype.canonicalString=function(){return this.toArray().join("/")};ResourcePath.prototype.toString=function(){return this.canonicalString()};ResourcePath.fromString=function(path){if(path.indexOf("//")>=0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid path ("+path+"). Paths must not contain // in them.")}var segments=path.split("/").filter(function(segment){return segment.length>0});return new ResourcePath(segments)};ResourcePath.EMPTY_PATH=new ResourcePath([]);return ResourcePath}(Path);var identifierRegExp=/^[_a-zA-Z][_a-zA-Z0-9]*$/;var FieldPath=function(_super){tslib_1.__extends(FieldPath,_super);function FieldPath(){return _super!==null&&_super.apply(this,arguments)||this}FieldPath.isValidIdentifier=function(segment){return identifierRegExp.test(segment)};FieldPath.prototype.canonicalString=function(){return this.toArray().map(function(str){str=str.replace("\\","\\\\").replace("`","\\`");if(!FieldPath.isValidIdentifier(str)){str="`"+str+"`"}return str}).join(".")};FieldPath.prototype.toString=function(){return this.canonicalString()};FieldPath.prototype.isKeyField=function(){return this.length===1&&this.get(0)===DOCUMENT_KEY_NAME};FieldPath.keyField=function(){return new FieldPath([DOCUMENT_KEY_NAME])};FieldPath.fromServerFormat=function(path){var segments=[];var current="";var i=0;var addCurrentSegment=function(){if(current.length===0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not be empty, begin "+"with '.', end with '.', or contain '..'")}segments.push(current);current=""};var inBackticks=false;while(i<path.length){var c=path[i];if(c==="\\"){if(i+1===path.length){throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has trailing escape character: "+path)}var next=path[i+1];if(!(next==="\\"||next==="."||next==="`")){throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has invalid escape sequence: "+path)}current+=next;i+=2}else if(c==="`"){inBackticks=!inBackticks;i++}else if(c==="."&&!inBackticks){addCurrentSegment();i++}else{current+=c;i++}}addCurrentSegment();if(inBackticks){throw new FirestoreError(Code.INVALID_ARGUMENT,"Unterminated ` in path: "+path)}return new FieldPath(segments)};FieldPath.EMPTY_PATH=new FieldPath([]);return FieldPath}(Path);var DocumentKey=function(){function DocumentKey(path){this.path=path;assert(DocumentKey.isDocumentKey(path),"Invalid DocumentKey with an odd number of segments: "+path.toArray().join("/"))}DocumentKey.prototype.hasCollectionId=function(collectionId){return this.path.length>=2&&this.path.get(this.path.length-2)===collectionId};DocumentKey.prototype.isEqual=function(other){return other!==null&&ResourcePath.comparator(this.path,other.path)===0};DocumentKey.prototype.toString=function(){return this.path.toString()};DocumentKey.comparator=function(k1,k2){return ResourcePath.comparator(k1.path,k2.path)};DocumentKey.isDocumentKey=function(path){return path.length%2===0};DocumentKey.fromSegments=function(segments){return new DocumentKey(new ResourcePath(segments.slice()))};DocumentKey.fromPathString=function(path){return new DocumentKey(ResourcePath.fromString(path))};DocumentKey.EMPTY=new DocumentKey(new ResourcePath([]));return DocumentKey}();var MaybeDocument=function(){function MaybeDocument(key,version){this.key=key;this.version=version}MaybeDocument.compareByKey=function(d1,d2){return DocumentKey.comparator(d1.key,d2.key)};return MaybeDocument}();var Document=function(_super){tslib_1.__extends(Document,_super);function Document(key,version,data,options,proto){var _this=_super.call(this,key,version)||this;_this.data=data;_this.proto=proto;_this.hasLocalMutations=!!options.hasLocalMutations;_this.hasCommittedMutations=!!options.hasCommittedMutations;return _this}Document.prototype.field=function(path){return this.data.field(path)};Document.prototype.fieldValue=function(path){var field=this.field(path);return field?field.value():undefined};Document.prototype.value=function(){return this.data.value()};Document.prototype.isEqual=function(other){return other instanceof Document&&this.key.isEqual(other.key)&&this.version.isEqual(other.version)&&this.data.isEqual(other.data)&&this.hasLocalMutations===other.hasLocalMutations&&this.hasCommittedMutations===other.hasCommittedMutations};Document.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", "+("{hasLocalMutations: "+this.hasLocalMutations+"}), ")+("{hasCommittedMutations: "+this.hasCommittedMutations+"})")};Object.defineProperty(Document.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:true,configurable:true});Document.compareByField=function(field,d1,d2){var v1=d1.field(field);var v2=d2.field(field);if(v1!==undefined&&v2!==undefined){return v1.compareTo(v2)}else{return fail("Trying to compare documents on fields that don't exist")}};return Document}(MaybeDocument);var NoDocument=function(_super){tslib_1.__extends(NoDocument,_super);function NoDocument(key,version,options){var _this=_super.call(this,key,version)||this;_this.hasCommittedMutations=!!(options&&options.hasCommittedMutations);return _this}NoDocument.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"};Object.defineProperty(NoDocument.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:true,configurable:true});NoDocument.prototype.isEqual=function(other){return other instanceof NoDocument&&other.hasCommittedMutations===this.hasCommittedMutations&&other.version.isEqual(this.version)&&other.key.isEqual(this.key)};return NoDocument}(MaybeDocument);var UnknownDocument=function(_super){tslib_1.__extends(UnknownDocument,_super);function UnknownDocument(key,version){return _super.call(this,key,version)||this}UnknownDocument.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"};Object.defineProperty(UnknownDocument.prototype,"hasPendingWrites",{get:function(){return true},enumerable:true,configurable:true});UnknownDocument.prototype.isEqual=function(other){return other instanceof UnknownDocument&&other.version.isEqual(this.version)&&other.key.isEqual(this.key)};return UnknownDocument}(MaybeDocument);var SortedMap=function(){function SortedMap(comparator,root){this.comparator=comparator;this.root=root?root:LLRBNode.EMPTY}SortedMap.prototype.insert=function(key,value){return new SortedMap(this.comparator,this.root.insert(key,value,this.comparator).copy(null,null,LLRBNode.BLACK,null,null))};SortedMap.prototype.remove=function(key){return new SortedMap(this.comparator,this.root.remove(key,this.comparator).copy(null,null,LLRBNode.BLACK,null,null))};SortedMap.prototype.get=function(key){var node=this.root;while(!node.isEmpty()){var cmp=this.comparator(key,node.key);if(cmp===0){return node.value}else if(cmp<0){node=node.left}else if(cmp>0){node=node.right}}return null};SortedMap.prototype.indexOf=function(key){var prunedNodes=0;var node=this.root;while(!node.isEmpty()){var cmp=this.comparator(key,node.key);if(cmp===0){return prunedNodes+node.left.size}else if(cmp<0){node=node.left}else{prunedNodes+=node.left.size+1;node=node.right}}return-1};SortedMap.prototype.isEmpty=function(){return this.root.isEmpty()};Object.defineProperty(SortedMap.prototype,"size",{get:function(){return this.root.size},enumerable:true,configurable:true});SortedMap.prototype.minKey=function(){return this.root.minKey()};SortedMap.prototype.maxKey=function(){return this.root.maxKey()};SortedMap.prototype.inorderTraversal=function(action){return this.root.inorderTraversal(action)};SortedMap.prototype.forEach=function(fn){this.inorderTraversal(function(k,v){fn(k,v);return false})};SortedMap.prototype.toString=function(){var descriptions=[];this.inorderTraversal(function(k,v){descriptions.push(k+":"+v);return false});return"{"+descriptions.join(", ")+"}"};SortedMap.prototype.reverseTraversal=function(action){return this.root.reverseTraversal(action)};SortedMap.prototype.getIterator=function(){return new SortedMapIterator(this.root,null,this.comparator,false)};SortedMap.prototype.getIteratorFrom=function(key){return new SortedMapIterator(this.root,key,this.comparator,false)};SortedMap.prototype.getReverseIterator=function(){return new SortedMapIterator(this.root,null,this.comparator,true)};SortedMap.prototype.getReverseIteratorFrom=function(key){return new SortedMapIterator(this.root,key,this.comparator,true)};return SortedMap}();var SortedMapIterator=function(){function SortedMapIterator(node,startKey,comparator,isReverse){this.isReverse=isReverse;this.nodeStack=[];var cmp=1;while(!node.isEmpty()){cmp=startKey?comparator(node.key,startKey):1;if(isReverse)cmp*=-1;if(cmp<0){if(this.isReverse){node=node.left}else{node=node.right}}else if(cmp===0){this.nodeStack.push(node);break}else{this.nodeStack.push(node);if(this.isReverse){node=node.right}else{node=node.left}}}}SortedMapIterator.prototype.getNext=function(){assert(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var node=this.nodeStack.pop();var result={key:node.key,value:node.value};if(this.isReverse){node=node.left;while(!node.isEmpty()){this.nodeStack.push(node);node=node.right}}else{node=node.right;while(!node.isEmpty()){this.nodeStack.push(node);node=node.left}}return result};SortedMapIterator.prototype.hasNext=function(){return this.nodeStack.length>0};SortedMapIterator.prototype.peek=function(){if(this.nodeStack.length===0)return null;var node=this.nodeStack[this.nodeStack.length-1];return{key:node.key,value:node.value}};return SortedMapIterator}();var LLRBNode=function(){function LLRBNode(key,value,color,left,right){this.key=key;this.value=value;this.color=color!=null?color:LLRBNode.RED;this.left=left!=null?left:LLRBNode.EMPTY;this.right=right!=null?right:LLRBNode.EMPTY;this.size=this.left.size+1+this.right.size}LLRBNode.prototype.copy=function(key,value,color,left,right){return new LLRBNode(key!=null?key:this.key,value!=null?value:this.value,color!=null?color:this.color,left!=null?left:this.left,right!=null?right:this.right)};LLRBNode.prototype.isEmpty=function(){return false};LLRBNode.prototype.inorderTraversal=function(action){return this.left.inorderTraversal(action)||action(this.key,this.value)||this.right.inorderTraversal(action)};LLRBNode.prototype.reverseTraversal=function(action){return this.right.reverseTraversal(action)||action(this.key,this.value)||this.left.reverseTraversal(action)};LLRBNode.prototype.min=function(){if(this.left.isEmpty()){return this}else{return this.left.min()}};LLRBNode.prototype.minKey=function(){return this.min().key};LLRBNode.prototype.maxKey=function(){if(this.right.isEmpty()){return this.key}else{return this.right.maxKey()}};LLRBNode.prototype.insert=function(key,value,comparator){var n=this;var cmp=comparator(key,n.key);if(cmp<0){n=n.copy(null,null,null,n.left.insert(key,value,comparator),null)}else if(cmp===0){n=n.copy(null,value,null,null,null)}else{n=n.copy(null,null,null,null,n.right.insert(key,value,comparator))}return n.fixUp()};LLRBNode.prototype.removeMin=function(){if(this.left.isEmpty()){return LLRBNode.EMPTY}var n=this;if(!n.left.isRed()&&!n.left.left.isRed())n=n.moveRedLeft();n=n.copy(null,null,null,n.left.removeMin(),null);return n.fixUp()};LLRBNode.prototype.remove=function(key,comparator){var smallest;var n=this;if(comparator(key,n.key)<0){if(!n.left.isEmpty()&&!n.left.isRed()&&!n.left.left.isRed()){n=n.moveRedLeft()}n=n.copy(null,null,null,n.left.remove(key,comparator),null)}else{if(n.left.isRed())n=n.rotateRight();if(!n.right.isEmpty()&&!n.right.isRed()&&!n.right.left.isRed()){n=n.moveRedRight()}if(comparator(key,n.key)===0){if(n.right.isEmpty()){return LLRBNode.EMPTY}else{smallest=n.right.min();n=n.copy(smallest.key,smallest.value,null,null,n.right.removeMin())}}n=n.copy(null,null,null,null,n.right.remove(key,comparator))}return n.fixUp()};LLRBNode.prototype.isRed=function(){return this.color};LLRBNode.prototype.fixUp=function(){var n=this;if(n.right.isRed()&&!n.left.isRed())n=n.rotateLeft();if(n.left.isRed()&&n.left.left.isRed())n=n.rotateRight();if(n.left.isRed()&&n.right.isRed())n=n.colorFlip();return n};LLRBNode.prototype.moveRedLeft=function(){var n=this.colorFlip();if(n.right.left.isRed()){n=n.copy(null,null,null,null,n.right.rotateRight());n=n.rotateLeft();n=n.colorFlip()}return n};LLRBNode.prototype.moveRedRight=function(){var n=this.colorFlip();if(n.left.left.isRed()){n=n.rotateRight();n=n.colorFlip()}return n};LLRBNode.prototype.rotateLeft=function(){var nl=this.copy(null,null,LLRBNode.RED,null,this.right.left);return this.right.copy(null,null,this.color,nl,null)};LLRBNode.prototype.rotateRight=function(){var nr=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,nr)};LLRBNode.prototype.colorFlip=function(){var left=this.left.copy(null,null,!this.left.color,null,null);var right=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,left,right)};LLRBNode.prototype.checkMaxDepth=function(){var blackDepth=this.check();if(Math.pow(2,blackDepth)<=this.size+1){return true}else{return false}};LLRBNode.prototype.check=function(){if(this.isRed()&&this.left.isRed()){throw fail("Red node has red child("+this.key+","+this.value+")")}if(this.right.isRed()){throw fail("Right child of ("+this.key+","+this.value+") is red")}var blackDepth=this.left.check();if(blackDepth!==this.right.check()){throw fail("Black depths differ")}else{return blackDepth+(this.isRed()?0:1)}};LLRBNode.EMPTY=null;LLRBNode.RED=true;LLRBNode.BLACK=false;return LLRBNode}();var LLRBEmptyNode=function(){function LLRBEmptyNode(){this.size=0}LLRBEmptyNode.prototype.copy=function(key,value,color,left,right){return this};LLRBEmptyNode.prototype.insert=function(key,value,comparator){return new LLRBNode(key,value)};LLRBEmptyNode.prototype.remove=function(key,comparator){return this};LLRBEmptyNode.prototype.isEmpty=function(){return true};LLRBEmptyNode.prototype.inorderTraversal=function(action){return false};LLRBEmptyNode.prototype.reverseTraversal=function(action){return false};LLRBEmptyNode.prototype.minKey=function(){return null};LLRBEmptyNode.prototype.maxKey=function(){return null};LLRBEmptyNode.prototype.isRed=function(){return false};LLRBEmptyNode.prototype.checkMaxDepth=function(){return true};LLRBEmptyNode.prototype.check=function(){return 0};return LLRBEmptyNode}();LLRBNode.EMPTY=new LLRBEmptyNode;var TypeOrder;(function(TypeOrder){TypeOrder[TypeOrder["NullValue"]=0]="NullValue";TypeOrder[TypeOrder["BooleanValue"]=1]="BooleanValue";TypeOrder[TypeOrder["NumberValue"]=2]="NumberValue";TypeOrder[TypeOrder["TimestampValue"]=3]="TimestampValue";TypeOrder[TypeOrder["StringValue"]=4]="StringValue";TypeOrder[TypeOrder["BlobValue"]=5]="BlobValue";TypeOrder[TypeOrder["RefValue"]=6]="RefValue";TypeOrder[TypeOrder["GeoPointValue"]=7]="GeoPointValue";TypeOrder[TypeOrder["ArrayValue"]=8]="ArrayValue";TypeOrder[TypeOrder["ObjectValue"]=9]="ObjectValue"})(TypeOrder||(TypeOrder={}));var ServerTimestampBehavior;(function(ServerTimestampBehavior){ServerTimestampBehavior[ServerTimestampBehavior["Default"]=0]="Default";ServerTimestampBehavior[ServerTimestampBehavior["Estimate"]=1]="Estimate";ServerTimestampBehavior[ServerTimestampBehavior["Previous"]=2]="Previous"})(ServerTimestampBehavior||(ServerTimestampBehavior={}));var FieldValueOptions=function(){function FieldValueOptions(serverTimestampBehavior,timestampsInSnapshots){this.serverTimestampBehavior=serverTimestampBehavior;this.timestampsInSnapshots=timestampsInSnapshots}FieldValueOptions.fromSnapshotOptions=function(options,timestampsInSnapshots){switch(options.serverTimestamps){case"estimate":return new FieldValueOptions(ServerTimestampBehavior.Estimate,timestampsInSnapshots);case"previous":return new FieldValueOptions(ServerTimestampBehavior.Previous,timestampsInSnapshots);case"none":case undefined:return new FieldValueOptions(ServerTimestampBehavior.Default,timestampsInSnapshots);default:return fail("fromSnapshotOptions() called with invalid options.")}};return FieldValueOptions}();var FieldValue=function(){function FieldValue(){}FieldValue.prototype.toString=function(){var val=this.value();return val===null?"null":val.toString()};FieldValue.prototype.defaultCompareTo=function(other){assert(this.typeOrder!==other.typeOrder,"Default compareTo should not be used for values of same type.");var cmp=primitiveComparator(this.typeOrder,other.typeOrder);return cmp};return FieldValue}();var NullValue=function(_super){tslib_1.__extends(NullValue,_super);function NullValue(){var _this=_super.call(this)||this;_this.typeOrder=TypeOrder.NullValue;_this.internalValue=null;return _this}NullValue.prototype.value=function(options){return null};NullValue.prototype.isEqual=function(other){return other instanceof NullValue};NullValue.prototype.compareTo=function(other){if(other instanceof NullValue){return 0}return this.defaultCompareTo(other)};NullValue.INSTANCE=new NullValue;return NullValue}(FieldValue);var BooleanValue=function(_super){tslib_1.__extends(BooleanValue,_super);function BooleanValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.BooleanValue;return _this}BooleanValue.prototype.value=function(options){return this.internalValue};BooleanValue.prototype.isEqual=function(other){return other instanceof BooleanValue&&this.internalValue===other.internalValue};BooleanValue.prototype.compareTo=function(other){if(other instanceof BooleanValue){return primitiveComparator(this,other)}return this.defaultCompareTo(other)};BooleanValue.of=function(value){return value?BooleanValue.TRUE:BooleanValue.FALSE};BooleanValue.TRUE=new BooleanValue(true);BooleanValue.FALSE=new BooleanValue(false);return BooleanValue}(FieldValue);var NumberValue=function(_super){tslib_1.__extends(NumberValue,_super);function NumberValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.NumberValue;return _this}NumberValue.prototype.value=function(options){return this.internalValue};NumberValue.prototype.compareTo=function(other){if(other instanceof NumberValue){return numericComparator(this.internalValue,other.internalValue)}return this.defaultCompareTo(other)};return NumberValue}(FieldValue);function numericComparator(left,right){if(left<right){return-1}else if(left>right){return 1}else if(left===right){return 0}else{if(isNaN(left)){return isNaN(right)?0:-1}else{return 1}}}function numericEquals(left,right){if(left===right){return left!==0||1/left===1/right}else{return left!==left&&right!==right}}var IntegerValue=function(_super){tslib_1.__extends(IntegerValue,_super);function IntegerValue(internalValue){return _super.call(this,internalValue)||this}IntegerValue.prototype.isEqual=function(other){if(other instanceof IntegerValue){return numericEquals(this.internalValue,other.internalValue)}else{return false}};return IntegerValue}(NumberValue);var DoubleValue=function(_super){tslib_1.__extends(DoubleValue,_super);function DoubleValue(internalValue){var _this=_super.call(this,internalValue)||this;_this.internalValue=internalValue;return _this}DoubleValue.prototype.isEqual=function(other){if(other instanceof DoubleValue){return numericEquals(this.internalValue,other.internalValue)}else{return false}};DoubleValue.NAN=new DoubleValue(NaN);DoubleValue.POSITIVE_INFINITY=new DoubleValue(Infinity);DoubleValue.NEGATIVE_INFINITY=new DoubleValue(-Infinity);return DoubleValue}(NumberValue);var StringValue=function(_super){tslib_1.__extends(StringValue,_super);function StringValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.StringValue;return _this}StringValue.prototype.value=function(options){return this.internalValue};StringValue.prototype.isEqual=function(other){return other instanceof StringValue&&this.internalValue===other.internalValue};StringValue.prototype.compareTo=function(other){if(other instanceof StringValue){return primitiveComparator(this.internalValue,other.internalValue)}return this.defaultCompareTo(other)};return StringValue}(FieldValue);var TimestampValue=function(_super){tslib_1.__extends(TimestampValue,_super);function TimestampValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.TimestampValue;return _this}TimestampValue.prototype.value=function(options){if(!options||options.timestampsInSnapshots){return this.internalValue}else{return this.internalValue.toDate()}};TimestampValue.prototype.isEqual=function(other){return other instanceof TimestampValue&&this.internalValue.isEqual(other.internalValue)};TimestampValue.prototype.compareTo=function(other){if(other instanceof TimestampValue){return this.internalValue._compareTo(other.internalValue)}else if(other instanceof ServerTimestampValue){return-1}else{return this.defaultCompareTo(other)}};return TimestampValue}(FieldValue);var ServerTimestampValue=function(_super){tslib_1.__extends(ServerTimestampValue,_super);function ServerTimestampValue(localWriteTime,previousValue){var _this=_super.call(this)||this;_this.localWriteTime=localWriteTime;_this.previousValue=previousValue;_this.typeOrder=TypeOrder.TimestampValue;return _this}ServerTimestampValue.prototype.value=function(options){if(options&&options.serverTimestampBehavior===ServerTimestampBehavior.Estimate){return new TimestampValue(this.localWriteTime).value(options)}else if(options&&options.serverTimestampBehavior===ServerTimestampBehavior.Previous){return this.previousValue?this.previousValue.value(options):null}else{return null}};ServerTimestampValue.prototype.isEqual=function(other){return other instanceof ServerTimestampValue&&this.localWriteTime.isEqual(other.localWriteTime)};ServerTimestampValue.prototype.compareTo=function(other){if(other instanceof ServerTimestampValue){return this.localWriteTime._compareTo(other.localWriteTime)}else if(other instanceof TimestampValue){return 1}else{return this.defaultCompareTo(other)}};ServerTimestampValue.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"};return ServerTimestampValue}(FieldValue);var BlobValue=function(_super){tslib_1.__extends(BlobValue,_super);function BlobValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.BlobValue;return _this}BlobValue.prototype.value=function(options){return this.internalValue};BlobValue.prototype.isEqual=function(other){return other instanceof BlobValue&&this.internalValue.isEqual(other.internalValue)};BlobValue.prototype.compareTo=function(other){if(other instanceof BlobValue){return this.internalValue._compareTo(other.internalValue)}return this.defaultCompareTo(other)};return BlobValue}(FieldValue);var RefValue=function(_super){tslib_1.__extends(RefValue,_super);function RefValue(databaseId,key){var _this=_super.call(this)||this;_this.databaseId=databaseId;_this.key=key;_this.typeOrder=TypeOrder.RefValue;return _this}RefValue.prototype.value=function(options){return this.key};RefValue.prototype.isEqual=function(other){if(other instanceof RefValue){return this.key.isEqual(other.key)&&this.databaseId.isEqual(other.databaseId)}else{return false}};RefValue.prototype.compareTo=function(other){if(other instanceof RefValue){var cmp=this.databaseId.compareTo(other.databaseId);return cmp!==0?cmp:DocumentKey.comparator(this.key,other.key)}return this.defaultCompareTo(other)};return RefValue}(FieldValue);var GeoPointValue=function(_super){tslib_1.__extends(GeoPointValue,_super);function GeoPointValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.GeoPointValue;return _this}GeoPointValue.prototype.value=function(options){return this.internalValue};GeoPointValue.prototype.isEqual=function(other){return other instanceof GeoPointValue&&this.internalValue.isEqual(other.internalValue)};GeoPointValue.prototype.compareTo=function(other){if(other instanceof GeoPointValue){return this.internalValue._compareTo(other.internalValue)}return this.defaultCompareTo(other)};return GeoPointValue}(FieldValue);var ObjectValue=function(_super){tslib_1.__extends(ObjectValue,_super);function ObjectValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.ObjectValue;return _this}ObjectValue.prototype.value=function(options){var result={};this.internalValue.inorderTraversal(function(key,val){result[key]=val.value(options)});return result};ObjectValue.prototype.forEach=function(action){this.internalValue.inorderTraversal(action)};ObjectValue.prototype.isEqual=function(other){if(other instanceof ObjectValue){var it1=this.internalValue.getIterator();var it2=other.internalValue.getIterator();while(it1.hasNext()&&it2.hasNext()){var next1=it1.getNext();var next2=it2.getNext();if(next1.key!==next2.key||!next1.value.isEqual(next2.value)){return false}}return!it1.hasNext()&&!it2.hasNext()}return false};ObjectValue.prototype.compareTo=function(other){if(other instanceof ObjectValue){var it1=this.internalValue.getIterator();var it2=other.internalValue.getIterator();while(it1.hasNext()&&it2.hasNext()){var next1=it1.getNext();var next2=it2.getNext();var cmp=primitiveComparator(next1.key,next2.key)||next1.value.compareTo(next2.value);if(cmp){return cmp}}return primitiveComparator(it1.hasNext(),it2.hasNext())}else{return this.defaultCompareTo(other)}};ObjectValue.prototype.set=function(path,to){assert(!path.isEmpty(),"Cannot set field for empty path on ObjectValue");if(path.length===1){return this.setChild(path.firstSegment(),to)}else{var child=this.child(path.firstSegment());if(!(child instanceof ObjectValue)){child=ObjectValue.EMPTY}var newChild=child.set(path.popFirst(),to);return this.setChild(path.firstSegment(),newChild)}};ObjectValue.prototype.delete=function(path){assert(!path.isEmpty(),"Cannot delete field for empty path on ObjectValue");if(path.length===1){return new ObjectValue(this.internalValue.remove(path.firstSegment()))}else{var child=this.child(path.firstSegment());if(child instanceof ObjectValue){var newChild=child.delete(path.popFirst());return new ObjectValue(this.internalValue.insert(path.firstSegment(),newChild))}else{return this}}};ObjectValue.prototype.contains=function(path){return this.field(path)!==undefined};ObjectValue.prototype.field=function(path){assert(!path.isEmpty(),"Can't get field of empty path");var field=this;path.forEach(function(pathSegment){if(field instanceof ObjectValue){field=field.internalValue.get(pathSegment)||undefined}else{field=undefined}});return field};ObjectValue.prototype.toString=function(){return this.internalValue.toString()};ObjectValue.prototype.child=function(childName){return this.internalValue.get(childName)||undefined};ObjectValue.prototype.setChild=function(childName,value){return new ObjectValue(this.internalValue.insert(childName,value))};ObjectValue.EMPTY=new ObjectValue(new SortedMap(primitiveComparator));return ObjectValue}(FieldValue);var ArrayValue=function(_super){tslib_1.__extends(ArrayValue,_super);function ArrayValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.ArrayValue;return _this}ArrayValue.prototype.value=function(options){return this.internalValue.map(function(v){return v.value(options)})};ArrayValue.prototype.forEach=function(action){this.internalValue.forEach(action)};ArrayValue.prototype.isEqual=function(other){if(other instanceof ArrayValue){if(this.internalValue.length!==other.internalValue.length){return false}for(var i=0;i<this.internalValue.length;i++){if(!this.internalValue[i].isEqual(other.internalValue[i])){return false}}return true}return false};ArrayValue.prototype.compareTo=function(other){if(other instanceof ArrayValue){var minLength=Math.min(this.internalValue.length,other.internalValue.length);for(var i=0;i<minLength;i++){var cmp=this.internalValue[i].compareTo(other.internalValue[i]);if(cmp){return cmp}}return primitiveComparator(this.internalValue.length,other.internalValue.length)}else{return this.defaultCompareTo(other)}};ArrayValue.prototype.toString=function(){var descriptions=this.internalValue.map(function(v){return v.toString()});return"["+descriptions.join(",")+"]"};return ArrayValue}(FieldValue);var NumberAsAny=Number;var MIN_SAFE_INTEGER=NumberAsAny.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1);var MAX_SAFE_INTEGER=NumberAsAny.MAX_SAFE_INTEGER||Math.pow(2,53)-1;var isInteger=NumberAsAny.isInteger||function(value){return typeof value==="number"&&isFinite(value)&&Math.floor(value)===value};function isNullOrUndefined(value){return value===null||value===undefined}function isSafeInteger(value){return isInteger(value)&&value<=MAX_SAFE_INTEGER&&value>=MIN_SAFE_INTEGER}var Query=function(){function Query(path,collectionGroup,explicitOrderBy,filters,limit,startAt,endAt){if(collectionGroup===void 0){collectionGroup=null}if(explicitOrderBy===void 0){explicitOrderBy=[]}if(filters===void 0){filters=[]}if(limit===void 0){limit=null}if(startAt===void 0){startAt=null}if(endAt===void 0){endAt=null}this.path=path;this.collectionGroup=collectionGroup;this.explicitOrderBy=explicitOrderBy;this.filters=filters;this.limit=limit;this.startAt=startAt;this.endAt=endAt;this.memoizedCanonicalId=null;this.memoizedOrderBy=null;if(this.startAt){this.assertValidBound(this.startAt)}if(this.endAt){this.assertValidBound(this.endAt)}}Query.atPath=function(path){return new Query(path)};Object.defineProperty(Query.prototype,"orderBy",{get:function(){if(this.memoizedOrderBy===null){var inequalityField=this.getInequalityFilterField();var firstOrderByField=this.getFirstOrderByField();if(inequalityField!==null&&firstOrderByField===null){if(inequalityField.isKeyField()){this.memoizedOrderBy=[KEY_ORDERING_ASC]}else{this.memoizedOrderBy=[new OrderBy(inequalityField),KEY_ORDERING_ASC]}}else{assert(inequalityField===null||firstOrderByField!==null&&inequalityField.isEqual(firstOrderByField),"First orderBy should match inequality field.");this.memoizedOrderBy=[];var foundKeyOrdering=false;for(var _i=0,_a=this.explicitOrderBy;_i<_a.length;_i++){var orderBy=_a[_i];this.memoizedOrderBy.push(orderBy);if(orderBy.field.isKeyField()){foundKeyOrdering=true}}if(!foundKeyOrdering){var lastDirection=this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Direction.ASCENDING;this.memoizedOrderBy.push(lastDirection===Direction.ASCENDING?KEY_ORDERING_ASC:KEY_ORDERING_DESC)}}}return this.memoizedOrderBy},enumerable:true,configurable:true});Query.prototype.addFilter=function(filter){assert(this.getInequalityFilterField()==null||!(filter instanceof RelationFilter)||!filter.isInequality()||filter.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field.");assert(!this.isDocumentQuery(),"No filtering allowed for document query");var newFilters=this.filters.concat([filter]);return new Query(this.path,this.collectionGroup,this.explicitOrderBy.slice(),newFilters,this.limit,this.startAt,this.endAt)};Query.prototype.addOrderBy=function(orderBy){assert(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var newOrderBy=this.explicitOrderBy.concat([orderBy]);return new Query(this.path,this.collectionGroup,newOrderBy,this.filters.slice(),this.limit,this.startAt,this.endAt)};Query.prototype.withLimit=function(limit){return new Query(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),limit,this.startAt,this.endAt)};Query.prototype.withStartAt=function(bound){return new Query(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,bound,this.endAt)};Query.prototype.withEndAt=function(bound){return new Query(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,bound)};Query.prototype.asCollectionQueryAtPath=function(path){return new Query(path,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)};Query.prototype.canonicalId=function(){if(this.memoizedCanonicalId===null){var canonicalId=this.path.canonicalString();if(this.isCollectionGroupQuery()){canonicalId+="|cg:"+this.collectionGroup}canonicalId+="|f:";for(var _i=0,_a=this.filters;_i<_a.length;_i++){var filter=_a[_i];canonicalId+=filter.canonicalId();canonicalId+=","}canonicalId+="|ob:";for(var _b=0,_c=this.orderBy;_b<_c.length;_b++){var orderBy=_c[_b];canonicalId+=orderBy.canonicalId();canonicalId+=","}if(!isNullOrUndefined(this.limit)){canonicalId+="|l:";canonicalId+=this.limit}if(this.startAt){canonicalId+="|lb:";canonicalId+=this.startAt.canonicalId()}if(this.endAt){canonicalId+="|ub:";canonicalId+=this.endAt.canonicalId()}this.memoizedCanonicalId=canonicalId}return this.memoizedCanonicalId};Query.prototype.toString=function(){var str="Query("+this.path.canonicalString();if(this.isCollectionGroupQuery()){str+=" collectionGroup="+this.collectionGroup}if(this.filters.length>0){str+=", filters: ["+this.filters.join(", ")+"]"}if(!isNullOrUndefined(this.limit)){str+=", limit: "+this.limit}if(this.explicitOrderBy.length>0){str+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"}if(this.startAt){str+=", startAt: "+this.startAt.canonicalId()}if(this.endAt){str+=", endAt: "+this.endAt.canonicalId()}return str+")"};Query.prototype.isEqual=function(other){if(this.limit!==other.limit){return false}if(this.orderBy.length!==other.orderBy.length){return false}for(var i=0;i<this.orderBy.length;i++){if(!this.orderBy[i].isEqual(other.orderBy[i])){return false}}if(this.filters.length!==other.filters.length){return false}for(var i=0;i<this.filters.length;i++){if(!this.filters[i].isEqual(other.filters[i])){return false}}if(this.collectionGroup!==other.collectionGroup){return false}if(!this.path.isEqual(other.path)){return false}if(this.startAt!==null?!this.startAt.isEqual(other.startAt):other.startAt!==null){return false}return this.endAt!==null?this.endAt.isEqual(other.endAt):other.endAt===null};Query.prototype.docComparator=function(d1,d2){var comparedOnKeyField=false;for(var _i=0,_a=this.orderBy;_i<_a.length;_i++){var orderBy=_a[_i];var comp=orderBy.compare(d1,d2);if(comp!==0)return comp;comparedOnKeyField=comparedOnKeyField||orderBy.field.isKeyField()}assert(comparedOnKeyField,"orderBy used that doesn't compare on key field");return 0};Query.prototype.matches=function(doc){return this.matchesPathAndCollectionGroup(doc)&&this.matchesOrderBy(doc)&&this.matchesFilters(doc)&&this.matchesBounds(doc)};Query.prototype.hasLimit=function(){return!isNullOrUndefined(this.limit)};Query.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null};Query.prototype.getInequalityFilterField=function(){for(var _i=0,_a=this.filters;_i<_a.length;_i++){var filter=_a[_i];if(filter instanceof RelationFilter&&filter.isInequality()){return filter.field}}return null};Query.prototype.hasArrayContainsFilter=function(){return this.filters.find(function(filter){return filter instanceof RelationFilter&&filter.op===RelationOp.ARRAY_CONTAINS})!==undefined};Query.prototype.isDocumentQuery=function(){return DocumentKey.isDocumentKey(this.path)&&this.collectionGroup===null&&this.filters.length===0};Query.prototype.isCollectionGroupQuery=function(){return this.collectionGroup!==null};Query.prototype.matchesPathAndCollectionGroup=function(doc){var docPath=doc.key.path;if(this.collectionGroup!==null){return doc.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(docPath)}else if(DocumentKey.isDocumentKey(this.path)){return this.path.isEqual(docPath)}else{return this.path.isImmediateParentOf(docPath)}};Query.prototype.matchesOrderBy=function(doc){for(var _i=0,_a=this.explicitOrderBy;_i<_a.length;_i++){var orderBy=_a[_i];if(!orderBy.field.isKeyField()&&doc.field(orderBy.field)===undefined){return false}}return true};Query.prototype.matchesFilters=function(doc){for(var _i=0,_a=this.filters;_i<_a.length;_i++){var filter=_a[_i];if(!filter.matches(doc)){return false}}return true};Query.prototype.matchesBounds=function(doc){if(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,doc)){return false}if(this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,doc)){return false}return true};Query.prototype.assertValidBound=function(bound){assert(bound.position.length<=this.orderBy.length,"Bound is longer than orderBy")};return Query}();var Filter=function(){function Filter(){}Filter.create=function(field,op,value){if(value.isEqual(NullValue.INSTANCE)){if(op!==RelationOp.EQUAL){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.")}return new NullFilter(field)}else if(value.isEqual(DoubleValue.NAN)){if(op!==RelationOp.EQUAL){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.")}return new NanFilter(field)}else{return new RelationFilter(field,op,value)}};return Filter}();var RelationOp=function(){function RelationOp(name){this.name=name}RelationOp.fromString=function(op){switch(op){case"<":return RelationOp.LESS_THAN;case"<=":return RelationOp.LESS_THAN_OR_EQUAL;case"==":return RelationOp.EQUAL;case">=":return RelationOp.GREATER_THAN_OR_EQUAL;case">":return RelationOp.GREATER_THAN;case"array-contains":return RelationOp.ARRAY_CONTAINS;default:return fail("Unknown relation: "+op)}};RelationOp.prototype.toString=function(){return this.name};RelationOp.prototype.isEqual=function(other){return this.name===other.name};RelationOp.LESS_THAN=new RelationOp("<");RelationOp.LESS_THAN_OR_EQUAL=new RelationOp("<=");RelationOp.EQUAL=new RelationOp("==");RelationOp.GREATER_THAN=new RelationOp(">");RelationOp.GREATER_THAN_OR_EQUAL=new RelationOp(">=");RelationOp.ARRAY_CONTAINS=new RelationOp("array-contains");return RelationOp}();var RelationFilter=function(_super){tslib_1.__extends(RelationFilter,_super);function RelationFilter(field,op,value){var _this=_super.call(this)||this;_this.field=field;_this.op=op;_this.value=value;return _this}RelationFilter.prototype.matches=function(doc){if(this.field.isKeyField()){assert(this.value instanceof RefValue,"Comparing on key, but filter value not a RefValue");assert(this.op!==RelationOp.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys.");var refValue=this.value;var comparison=DocumentKey.comparator(doc.key,refValue.key);return this.matchesComparison(comparison)}else{var val=doc.field(this.field);return val!==undefined&&this.matchesValue(val)}};RelationFilter.prototype.matchesValue=function(value){var _this=this;if(this.op===RelationOp.ARRAY_CONTAINS){return value instanceof ArrayValue&&value.internalValue.find(function(element){return element.isEqual(_this.value)})!==undefined}else{return this.value.typeOrder===value.typeOrder&&this.matchesComparison(value.compareTo(this.value))}};RelationFilter.prototype.matchesComparison=function(comparison){switch(this.op){case RelationOp.LESS_THAN:return comparison<0;case RelationOp.LESS_THAN_OR_EQUAL:return comparison<=0;case RelationOp.EQUAL:return comparison===0;case RelationOp.GREATER_THAN:return comparison>0;case RelationOp.GREATER_THAN_OR_EQUAL:return comparison>=0;default:return fail("Unknown relation op"+this.op)}};RelationFilter.prototype.isInequality=function(){return this.op!==RelationOp.EQUAL&&this.op!==RelationOp.ARRAY_CONTAINS};RelationFilter.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()};RelationFilter.prototype.isEqual=function(other){if(other instanceof RelationFilter){return this.op.isEqual(other.op)&&this.field.isEqual(other.field)&&this.value.isEqual(other.value)}else{return false}};RelationFilter.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()};return RelationFilter}(Filter);var NullFilter=function(_super){tslib_1.__extends(NullFilter,_super);function NullFilter(field){var _this=_super.call(this)||this;_this.field=field;return _this}NullFilter.prototype.matches=function(doc){var val=doc.field(this.field);return val!==undefined&&val.value()===null};NullFilter.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"};NullFilter.prototype.toString=function(){return this.field.canonicalString()+" IS null"};NullFilter.prototype.isEqual=function(other){if(other instanceof NullFilter){return this.field.isEqual(other.field)}else{return false}};return NullFilter}(Filter);var NanFilter=function(_super){tslib_1.__extends(NanFilter,_super);function NanFilter(field){var _this=_super.call(this)||this;_this.field=field;return _this}NanFilter.prototype.matches=function(doc){var field=doc.field(this.field);var val=field&&field.value();return typeof val==="number"&&isNaN(val)};NanFilter.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"};NanFilter.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"};NanFilter.prototype.isEqual=function(other){if(other instanceof NanFilter){return this.field.isEqual(other.field)}else{return false}};return NanFilter}(Filter);var Direction=function(){function Direction(name){this.name=name}Direction.prototype.toString=function(){return this.name};Direction.ASCENDING=new Direction("asc");Direction.DESCENDING=new Direction("desc");return Direction}();var Bound=function(){function Bound(position,before){this.position=position;this.before=before}Bound.prototype.canonicalId=function(){var canonicalId=this.before?"b:":"a:";for(var _i=0,_a=this.position;_i<_a.length;_i++){var component=_a[_i];canonicalId+=component.toString()}return canonicalId};Bound.prototype.sortsBeforeDocument=function(orderBy,doc){assert(this.position.length<=orderBy.length,"Bound has more components than query's orderBy");var comparison=0;for(var i=0;i<this.position.length;i++){var orderByComponent=orderBy[i];var component=this.position[i];if(orderByComponent.field.isKeyField()){assert(component instanceof RefValue,"Bound has a non-key value where the key path is being used.");comparison=DocumentKey.comparator(component.key,doc.key)}else{var docValue=doc.field(orderByComponent.field);assert(docValue!==undefined,"Field should exist since document matched the orderBy already.");comparison=component.compareTo(docValue)}if(orderByComponent.dir===Direction.DESCENDING){comparison=comparison*-1}if(comparison!==0){break}}return this.before?comparison<=0:comparison<0};Bound.prototype.isEqual=function(other){if(other===null){return false}if(this.before!==other.before||this.position.length!==other.position.length){return false}for(var i=0;i<this.position.length;i++){var thisPosition=this.position[i];var otherPosition=other.position[i];return thisPosition.isEqual(otherPosition)}return true};return Bound}();var OrderBy=function(){function OrderBy(field,dir){this.field=field;if(dir===undefined){dir=Direction.ASCENDING}this.dir=dir;this.isKeyOrderBy=field.isKeyField()}OrderBy.prototype.compare=function(d1,d2){var comparison=this.isKeyOrderBy?Document.compareByKey(d1,d2):Document.compareByField(this.field,d1,d2);switch(this.dir){case Direction.ASCENDING:return comparison;case Direction.DESCENDING:return-1*comparison;default:return fail("Unknown direction: "+this.dir)}};OrderBy.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()};OrderBy.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"};OrderBy.prototype.isEqual=function(other){return this.dir===other.dir&&this.field.isEqual(other.field)};return OrderBy}();var KEY_ORDERING_ASC=new OrderBy(FieldPath.keyField(),Direction.ASCENDING);var KEY_ORDERING_DESC=new OrderBy(FieldPath.keyField(),Direction.DESCENDING);var SnapshotVersion=function(){function SnapshotVersion(timestamp){this.timestamp=timestamp}SnapshotVersion.fromMicroseconds=function(value){var seconds=Math.floor(value/1e6);var nanos=value%1e6*1e3;return new SnapshotVersion(new Timestamp(seconds,nanos))};SnapshotVersion.fromTimestamp=function(value){return new SnapshotVersion(value)};SnapshotVersion.forDeletedDoc=function(){return SnapshotVersion.MIN};SnapshotVersion.prototype.compareTo=function(other){return this.timestamp._compareTo(other.timestamp)};SnapshotVersion.prototype.isEqual=function(other){return this.timestamp.isEqual(other.timestamp)};SnapshotVersion.prototype.toMicroseconds=function(){return this.timestamp.seconds*1e6+this.timestamp.nanoseconds/1e3};SnapshotVersion.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"};SnapshotVersion.prototype.toTimestamp=function(){return this.timestamp};SnapshotVersion.MIN=new SnapshotVersion(new Timestamp(0,0));return SnapshotVersion}();var QueryPurpose;(function(QueryPurpose){QueryPurpose[QueryPurpose["Listen"]=0]="Listen";QueryPurpose[QueryPurpose["ExistenceFilterMismatch"]=1]="ExistenceFilterMismatch";QueryPurpose[QueryPurpose["LimboResolution"]=2]="LimboResolution"})(QueryPurpose||(QueryPurpose={}));var QueryData=function(){function QueryData(query,targetId,purpose,sequenceNumber,snapshotVersion,resumeToken){if(snapshotVersion===void 0){snapshotVersion=SnapshotVersion.MIN}if(resumeToken===void 0){resumeToken=emptyByteString()}this.query=query;this.targetId=targetId;this.purpose=purpose;this.sequenceNumber=sequenceNumber;this.snapshotVersion=snapshotVersion;this.resumeToken=resumeToken}QueryData.prototype.copy=function(overwrite){return new QueryData(this.query,this.targetId,this.purpose,overwrite.sequenceNumber===undefined?this.sequenceNumber:overwrite.sequenceNumber,overwrite.snapshotVersion===undefined?this.snapshotVersion:overwrite.snapshotVersion,overwrite.resumeToken===undefined?this.resumeToken:overwrite.resumeToken)};QueryData.prototype.isEqual=function(other){return this.targetId===other.targetId&&this.purpose===other.purpose&&this.sequenceNumber===other.sequenceNumber&&this.snapshotVersion.isEqual(other.snapshotVersion)&&this.resumeToken===other.resumeToken&&this.query.isEqual(other.query)};return QueryData}();var SortedSet=function(){function SortedSet(comparator){this.comparator=comparator;this.data=new SortedMap(this.comparator)}SortedSet.fromMapKeys=function(map){var keys=new SortedSet(map.comparator);map.forEach(function(key){keys=keys.add(key)});return keys};SortedSet.prototype.has=function(elem){return this.data.get(elem)!==null};SortedSet.prototype.first=function(){return this.data.minKey()};SortedSet.prototype.last=function(){return this.data.maxKey()};Object.defineProperty(SortedSet.prototype,"size",{get:function(){return this.data.size},enumerable:true,configurable:true});SortedSet.prototype.indexOf=function(elem){return this.data.indexOf(elem)};SortedSet.prototype.forEach=function(cb){this.data.inorderTraversal(function(k,v){cb(k);return false})};SortedSet.prototype.forEachInRange=function(range,cb){var iter=this.data.getIteratorFrom(range[0]);while(iter.hasNext()){var elem=iter.getNext();if(this.comparator(elem.key,range[1])>=0)return;cb(elem.key)}};SortedSet.prototype.forEachWhile=function(cb,start){var iter;if(start!==undefined){iter=this.data.getIteratorFrom(start)}else{iter=this.data.getIterator()}while(iter.hasNext()){var elem=iter.getNext();var result=cb(elem.key);if(!result)return}};SortedSet.prototype.firstAfterOrEqual=function(elem){var iter=this.data.getIteratorFrom(elem);return iter.hasNext()?iter.getNext().key:null};SortedSet.prototype.getIterator=function(){return new SortedSetIterator(this.data.getIterator())};SortedSet.prototype.getIteratorFrom=function(key){return new SortedSetIterator(this.data.getIteratorFrom(key))};SortedSet.prototype.add=function(elem){return this.copy(this.data.remove(elem).insert(elem,true))};SortedSet.prototype.delete=function(elem){if(!this.has(elem))return this;return this.copy(this.data.remove(elem))};SortedSet.prototype.isEmpty=function(){return this.data.isEmpty()};SortedSet.prototype.unionWith=function(other){var result=this;other.forEach(function(elem){result=result.add(elem)});return result};SortedSet.prototype.isEqual=function(other){if(!(other instanceof SortedSet))return false;if(this.size!==other.size)return false;var thisIt=this.data.getIterator();var otherIt=other.data.getIterator();while(thisIt.hasNext()){var thisElem=thisIt.getNext().key;var otherElem=otherIt.getNext().key;if(this.comparator(thisElem,otherElem)!==0)return false}return true};SortedSet.prototype.toArray=function(){var res=[];this.forEach(function(targetId){res.push(targetId)});return res};SortedSet.prototype.toString=function(){var result=[];this.forEach(function(elem){return result.push(elem)});return"SortedSet("+result.toString()+")"};SortedSet.prototype.copy=function(data){var result=new SortedSet(this.comparator);result.data=data;return result};return SortedSet}();var SortedSetIterator=function(){function SortedSetIterator(iter){this.iter=iter}SortedSetIterator.prototype.getNext=function(){return this.iter.getNext().key};SortedSetIterator.prototype.hasNext=function(){return this.iter.hasNext()};return SortedSetIterator}();var FieldMask=function(){function FieldMask(fields){this.fields=fields}FieldMask.fromSet=function(fields){return new FieldMask(fields)};FieldMask.fromArray=function(fields){var fieldsAsSet=new SortedSet(FieldPath.comparator);fields.forEach(function(fieldPath){return fieldsAsSet=fieldsAsSet.add(fieldPath)});return new FieldMask(fieldsAsSet)};FieldMask.prototype.covers=function(fieldPath){var found=false;this.fields.forEach(function(fieldMaskPath){if(fieldMaskPath.isPrefixOf(fieldPath)){found=true}});return found};FieldMask.prototype.applyTo=function(data){var filteredObject=ObjectValue.EMPTY;this.fields.forEach(function(fieldMaskPath){if(fieldMaskPath.isEmpty()){return data}else{var newValue=data.field(fieldMaskPath);if(newValue!==undefined){filteredObject=filteredObject.set(fieldMaskPath,newValue)}}});return filteredObject};FieldMask.prototype.isEqual=function(other){return this.fields.isEqual(other.fields)};return FieldMask}();var FieldTransform=function(){function FieldTransform(field,transform){this.field=field;this.transform=transform}Object.defineProperty(FieldTransform.prototype,"isIdempotent",{get:function(){return this.transform.isIdempotent},enumerable:true,configurable:true});FieldTransform.prototype.isEqual=function(other){return this.field.isEqual(other.field)&&this.transform.isEqual(other.transform)};return FieldTransform}();var MutationResult=function(){function MutationResult(version,transformResults){this.version=version;this.transformResults=transformResults}return MutationResult}();var MutationType;(function(MutationType){MutationType[MutationType["Set"]=0]="Set";MutationType[MutationType["Patch"]=1]="Patch";MutationType[MutationType["Transform"]=2]="Transform";MutationType[MutationType["Delete"]=3]="Delete"})(MutationType||(MutationType={}));var Precondition=function(){function Precondition(updateTime,exists){this.updateTime=updateTime;this.exists=exists;assert(updateTime===undefined||exists===undefined,'Precondition can specify "exists" or "updateTime" but not both')}Precondition.exists=function(exists){return new Precondition(undefined,exists)};Precondition.updateTime=function(version){return new Precondition(version)};Object.defineProperty(Precondition.prototype,"isNone",{get:function(){return this.updateTime===undefined&&this.exists===undefined},enumerable:true,configurable:true});Precondition.prototype.isValidFor=function(maybeDoc){if(this.updateTime!==undefined){return maybeDoc instanceof Document&&maybeDoc.version.isEqual(this.updateTime)}else if(this.exists!==undefined){return this.exists===maybeDoc instanceof Document}else{assert(this.isNone,"Precondition should be empty");return true}};Precondition.prototype.isEqual=function(other){return equals(this.updateTime,other.updateTime)&&this.exists===other.exists};Precondition.NONE=new Precondition;return Precondition}();var Mutation=function(){function Mutation(){}Mutation.prototype.verifyKeyMatches=function(maybeDoc){if(maybeDoc!=null){assert(maybeDoc.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")}};Mutation.getPostMutationVersion=function(maybeDoc){if(maybeDoc instanceof Document){return maybeDoc.version}else{return SnapshotVersion.MIN}};return Mutation}();var SetMutation=function(_super){tslib_1.__extends(SetMutation,_super);function SetMutation(key,value,precondition){var _this=_super.call(this)||this;_this.key=key;_this.value=value;_this.precondition=precondition;_this.type=MutationType.Set;return _this}SetMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(mutationResult.transformResults==null,"Transform results received by SetMutation.");var version=mutationResult.version;return new Document(this.key,version,this.value,{hasCommittedMutations:true})};SetMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc)){return maybeDoc}var version=Mutation.getPostMutationVersion(maybeDoc);return new Document(this.key,version,this.value,{hasLocalMutations:true})};Object.defineProperty(SetMutation.prototype,"isIdempotent",{get:function(){return true},enumerable:true,configurable:true});Object.defineProperty(SetMutation.prototype,"fieldMask",{get:function(){return null},enumerable:true,configurable:true});SetMutation.prototype.isEqual=function(other){return other instanceof SetMutation&&this.key.isEqual(other.key)&&this.value.isEqual(other.value)&&this.precondition.isEqual(other.precondition)};return SetMutation}(Mutation);var PatchMutation=function(_super){tslib_1.__extends(PatchMutation,_super);function PatchMutation(key,data,fieldMask,precondition){var _this=_super.call(this)||this;_this.key=key;_this.data=data;_this.fieldMask=fieldMask;_this.precondition=precondition;_this.type=MutationType.Patch;return _this}PatchMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(mutationResult.transformResults==null,"Transform results received by PatchMutation.");if(!this.precondition.isValidFor(maybeDoc)){return new UnknownDocument(this.key,mutationResult.version)}var newData=this.patchDocument(maybeDoc);return new Document(this.key,mutationResult.version,newData,{hasCommittedMutations:true})};PatchMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc)){return maybeDoc}var version=Mutation.getPostMutationVersion(maybeDoc);var newData=this.patchDocument(maybeDoc);return new Document(this.key,version,newData,{hasLocalMutations:true})};Object.defineProperty(PatchMutation.prototype,"isIdempotent",{get:function(){return true},enumerable:true,configurable:true});PatchMutation.prototype.isEqual=function(other){return other instanceof PatchMutation&&this.key.isEqual(other.key)&&this.fieldMask.isEqual(other.fieldMask)&&this.precondition.isEqual(other.precondition)};PatchMutation.prototype.patchDocument=function(maybeDoc){var data;if(maybeDoc instanceof Document){data=maybeDoc.data}else{data=ObjectValue.EMPTY}return this.patchObject(data)};PatchMutation.prototype.patchObject=function(data){var _this=this;this.fieldMask.fields.forEach(function(fieldPath){if(!fieldPath.isEmpty()){var newValue=_this.data.field(fieldPath);if(newValue!==undefined){data=data.set(fieldPath,newValue)}else{data=data.delete(fieldPath)}}});return data};return PatchMutation}(Mutation);var TransformMutation=function(_super){tslib_1.__extends(TransformMutation,_super);function TransformMutation(key,fieldTransforms){var _this=_super.call(this)||this;_this.key=key;_this.fieldTransforms=fieldTransforms;_this.type=MutationType.Transform;_this.precondition=Precondition.exists(true);return _this}TransformMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(mutationResult.transformResults!=null,"Transform results missing for TransformMutation.");if(!this.precondition.isValidFor(maybeDoc)){return new UnknownDocument(this.key,mutationResult.version)}var doc=this.requireDocument(maybeDoc);var transformResults=this.serverTransformResults(maybeDoc,mutationResult.transformResults);var version=mutationResult.version;var newData=this.transformObject(doc.data,transformResults);return new Document(this.key,version,newData,{hasCommittedMutations:true})};TransformMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc)){return maybeDoc}var doc=this.requireDocument(maybeDoc);var transformResults=this.localTransformResults(localWriteTime,baseDoc);var newData=this.transformObject(doc.data,transformResults);return new Document(this.key,doc.version,newData,{hasLocalMutations:true})};Object.defineProperty(TransformMutation.prototype,"isIdempotent",{get:function(){for(var _i=0,_a=this.fieldTransforms;_i<_a.length;_i++){var fieldTransform=_a[_i];if(!fieldTransform.isIdempotent){return false}}return true},enumerable:true,configurable:true});Object.defineProperty(TransformMutation.prototype,"fieldMask",{get:function(){var fieldMask=new SortedSet(FieldPath.comparator);this.fieldTransforms.forEach(function(transform){return fieldMask=fieldMask.add(transform.field)});return new FieldMask(fieldMask)},enumerable:true,configurable:true});TransformMutation.prototype.isEqual=function(other){return other instanceof TransformMutation&&this.key.isEqual(other.key)&&arrayEquals(this.fieldTransforms,other.fieldTransforms)&&this.precondition.isEqual(other.precondition)};TransformMutation.prototype.requireDocument=function(maybeDoc){assert(maybeDoc instanceof Document,"Unknown MaybeDocument type "+maybeDoc);var doc=maybeDoc;assert(doc.key.isEqual(this.key),"Can only transform a document with the same key");return doc};TransformMutation.prototype.serverTransformResults=function(baseDoc,serverTransformResults){var transformResults=[];assert(this.fieldTransforms.length===serverTransformResults.length,"server transform result count ("+serverTransformResults.length+") "+("should match field transform count ("+this.fieldTransforms.length+")"));for(var i=0;i<serverTransformResults.length;i++){var fieldTransform=this.fieldTransforms[i];var transform=fieldTransform.transform;var previousValue=null;if(baseDoc instanceof Document){previousValue=baseDoc.field(fieldTransform.field)||null}transformResults.push(transform.applyToRemoteDocument(previousValue,serverTransformResults[i]))}return transformResults};TransformMutation.prototype.localTransformResults=function(localWriteTime,baseDoc){var transformResults=[];for(var _i=0,_a=this.fieldTransforms;_i<_a.length;_i++){var fieldTransform=_a[_i];var transform=fieldTransform.transform;var previousValue=null;if(baseDoc instanceof Document){previousValue=baseDoc.field(fieldTransform.field)||null}transformResults.push(transform.applyToLocalView(previousValue,localWriteTime))}return transformResults};TransformMutation.prototype.transformObject=function(data,transformResults){assert(transformResults.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var i=0;i<this.fieldTransforms.length;i++){var fieldTransform=this.fieldTransforms[i];var fieldPath=fieldTransform.field;data=data.set(fieldPath,transformResults[i])}return data};return TransformMutation}(Mutation);var DeleteMutation=function(_super){tslib_1.__extends(DeleteMutation,_super);function DeleteMutation(key,precondition){var _this=_super.call(this)||this;_this.key=key;_this.precondition=precondition;_this.type=MutationType.Delete;return _this}DeleteMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(mutationResult.transformResults==null,"Transform results received by DeleteMutation.");return new NoDocument(this.key,mutationResult.version,{hasCommittedMutations:true})};DeleteMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc)){return maybeDoc}if(maybeDoc){assert(maybeDoc.key.isEqual(this.key),"Can only apply mutation to document with same key")}return new NoDocument(this.key,SnapshotVersion.forDeletedDoc())};DeleteMutation.prototype.isEqual=function(other){return other instanceof DeleteMutation&&this.key.isEqual(other.key)&&this.precondition.isEqual(other.precondition)};Object.defineProperty(DeleteMutation.prototype,"isIdempotent",{get:function(){return true},enumerable:true,configurable:true});Object.defineProperty(DeleteMutation.prototype,"fieldMask",{get:function(){return null},enumerable:true,configurable:true});return DeleteMutation}(Mutation);var ServerTimestampTransform=function(){function ServerTimestampTransform(){this.isIdempotent=true}ServerTimestampTransform.prototype.applyToLocalView=function(previousValue,localWriteTime){return new ServerTimestampValue(localWriteTime,previousValue)};ServerTimestampTransform.prototype.applyToRemoteDocument=function(previousValue,transformResult){return transformResult};ServerTimestampTransform.prototype.isEqual=function(other){return other instanceof ServerTimestampTransform};ServerTimestampTransform.instance=new ServerTimestampTransform;return ServerTimestampTransform}();var ArrayUnionTransformOperation=function(){function ArrayUnionTransformOperation(elements){this.elements=elements;this.isIdempotent=true}ArrayUnionTransformOperation.prototype.applyToLocalView=function(previousValue,localWriteTime){return this.apply(previousValue)};ArrayUnionTransformOperation.prototype.applyToRemoteDocument=function(previousValue,transformResult){return this.apply(previousValue)};ArrayUnionTransformOperation.prototype.apply=function(previousValue){var result=coercedFieldValuesArray(previousValue);var _loop_1=function(toUnion){if(!result.find(function(element){return element.isEqual(toUnion)})){result.push(toUnion)}};for(var _i=0,_a=this.elements;_i<_a.length;_i++){var toUnion=_a[_i];_loop_1(toUnion)}return new ArrayValue(result)};ArrayUnionTransformOperation.prototype.isEqual=function(other){return other instanceof ArrayUnionTransformOperation&&arrayEquals(other.elements,this.elements)};return ArrayUnionTransformOperation}();var ArrayRemoveTransformOperation=function(){function ArrayRemoveTransformOperation(elements){this.elements=elements;this.isIdempotent=true}ArrayRemoveTransformOperation.prototype.applyToLocalView=function(previousValue,localWriteTime){return this.apply(previousValue)};ArrayRemoveTransformOperation.prototype.applyToRemoteDocument=function(previousValue,transformResult){return this.apply(previousValue)};ArrayRemoveTransformOperation.prototype.apply=function(previousValue){var result=coercedFieldValuesArray(previousValue);var _loop_2=function(toRemove){result=result.filter(function(element){return!element.isEqual(toRemove)})};for(var _i=0,_a=this.elements;_i<_a.length;_i++){var toRemove=_a[_i];_loop_2(toRemove)}return new ArrayValue(result)};ArrayRemoveTransformOperation.prototype.isEqual=function(other){return other instanceof ArrayRemoveTransformOperation&&arrayEquals(other.elements,this.elements)};return ArrayRemoveTransformOperation}();var NumericIncrementTransformOperation=function(){function NumericIncrementTransformOperation(operand){this.operand=operand;this.isIdempotent=false}NumericIncrementTransformOperation.prototype.applyToLocalView=function(previousValue,localWriteTime){if(previousValue instanceof IntegerValue&&this.operand instanceof IntegerValue){var sum=previousValue.internalValue+this.operand.internalValue;return new IntegerValue(sum)}else if(previousValue instanceof NumberValue){var sum=previousValue.internalValue+this.operand.internalValue;return new DoubleValue(sum)}else{return this.operand}};NumericIncrementTransformOperation.prototype.applyToRemoteDocument=function(previousValue,transformResult){assert(transformResult!==null,"Didn't receive transformResult for NUMERIC_ADD transform");return transformResult};NumericIncrementTransformOperation.prototype.isEqual=function(other){return other instanceof NumericIncrementTransformOperation&&this.operand.isEqual(other.operand)};return NumericIncrementTransformOperation}();function coercedFieldValuesArray(value){if(value instanceof ArrayValue){return value.internalValue.slice()}else{return[]}}var ExistenceFilter=function(){function ExistenceFilter(count){this.count=count}ExistenceFilter.prototype.isEqual=function(other){return other&&other.count===this.count};return ExistenceFilter}();var RpcCode;(function(RpcCode){RpcCode[RpcCode["OK"]=0]="OK";RpcCode[RpcCode["CANCELLED"]=1]="CANCELLED";RpcCode[RpcCode["UNKNOWN"]=2]="UNKNOWN";RpcCode[RpcCode["INVALID_ARGUMENT"]=3]="INVALID_ARGUMENT";RpcCode[RpcCode["DEADLINE_EXCEEDED"]=4]="DEADLINE_EXCEEDED";RpcCode[RpcCode["NOT_FOUND"]=5]="NOT_FOUND";RpcCode[RpcCode["ALREADY_EXISTS"]=6]="ALREADY_EXISTS";RpcCode[RpcCode["PERMISSION_DENIED"]=7]="PERMISSION_DENIED";RpcCode[RpcCode["UNAUTHENTICATED"]=16]="UNAUTHENTICATED";RpcCode[RpcCode["RESOURCE_EXHAUSTED"]=8]="RESOURCE_EXHAUSTED";RpcCode[RpcCode["FAILED_PRECONDITION"]=9]="FAILED_PRECONDITION";RpcCode[RpcCode["ABORTED"]=10]="ABORTED";RpcCode[RpcCode["OUT_OF_RANGE"]=11]="OUT_OF_RANGE";RpcCode[RpcCode["UNIMPLEMENTED"]=12]="UNIMPLEMENTED";RpcCode[RpcCode["INTERNAL"]=13]="INTERNAL";RpcCode[RpcCode["UNAVAILABLE"]=14]="UNAVAILABLE";RpcCode[RpcCode["DATA_LOSS"]=15]="DATA_LOSS"})(RpcCode||(RpcCode={}));function isPermanentError(code){switch(code){case Code.OK:return fail("Treated status OK as error");case Code.CANCELLED:case Code.UNKNOWN:case Code.DEADLINE_EXCEEDED:case Code.RESOURCE_EXHAUSTED:case Code.INTERNAL:case Code.UNAVAILABLE:case Code.UNAUTHENTICATED:return false;case Code.INVALID_ARGUMENT:case Code.NOT_FOUND:case Code.ALREADY_EXISTS:case Code.PERMISSION_DENIED:case Code.FAILED_PRECONDITION:case Code.ABORTED:case Code.OUT_OF_RANGE:case Code.UNIMPLEMENTED:case Code.DATA_LOSS:return true;default:return fail("Unknown status code: "+code)}}function isPermanentWriteError(code){return isPermanentError(code)&&code!==Code.ABORTED}function mapCodeFromRpcStatus(status){var code=RpcCode[status];if(code===undefined){return undefined}return mapCodeFromRpcCode(code)}function mapCodeFromRpcCode(code){if(code===undefined){error("GRPC error has no .code");return Code.UNKNOWN}switch(code){case RpcCode.OK:return Code.OK;case RpcCode.CANCELLED:return Code.CANCELLED;case RpcCode.UNKNOWN:return Code.UNKNOWN;case RpcCode.DEADLINE_EXCEEDED:return Code.DEADLINE_EXCEEDED;case RpcCode.RESOURCE_EXHAUSTED:return Code.RESOURCE_EXHAUSTED;case RpcCode.INTERNAL:return Code.INTERNAL;case RpcCode.UNAVAILABLE:return Code.UNAVAILABLE;case RpcCode.UNAUTHENTICATED:return Code.UNAUTHENTICATED;case RpcCode.INVALID_ARGUMENT:return Code.INVALID_ARGUMENT;case RpcCode.NOT_FOUND:return Code.NOT_FOUND;case RpcCode.ALREADY_EXISTS:return Code.ALREADY_EXISTS;case RpcCode.PERMISSION_DENIED:return Code.PERMISSION_DENIED;case RpcCode.FAILED_PRECONDITION:return Code.FAILED_PRECONDITION;case RpcCode.ABORTED:return Code.ABORTED;case RpcCode.OUT_OF_RANGE:return Code.OUT_OF_RANGE;case RpcCode.UNIMPLEMENTED:return Code.UNIMPLEMENTED;case RpcCode.DATA_LOSS:return Code.DATA_LOSS;default:return fail("Unknown status code: "+code)}}function mapRpcCodeFromCode(code){if(code===undefined){return RpcCode.OK}switch(code){case Code.OK:return RpcCode.OK;case Code.CANCELLED:return RpcCode.CANCELLED;case Code.UNKNOWN:return RpcCode.UNKNOWN;case Code.DEADLINE_EXCEEDED:return RpcCode.DEADLINE_EXCEEDED;case Code.RESOURCE_EXHAUSTED:return RpcCode.RESOURCE_EXHAUSTED;case Code.INTERNAL:return RpcCode.INTERNAL;case Code.UNAVAILABLE:return RpcCode.UNAVAILABLE;case Code.UNAUTHENTICATED:return RpcCode.UNAUTHENTICATED;case Code.INVALID_ARGUMENT:return RpcCode.INVALID_ARGUMENT;case Code.NOT_FOUND:return RpcCode.NOT_FOUND;case Code.ALREADY_EXISTS:return RpcCode.ALREADY_EXISTS;case Code.PERMISSION_DENIED:return RpcCode.PERMISSION_DENIED;case Code.FAILED_PRECONDITION:return RpcCode.FAILED_PRECONDITION;case Code.ABORTED:return RpcCode.ABORTED;case Code.OUT_OF_RANGE:return RpcCode.OUT_OF_RANGE;case Code.UNIMPLEMENTED:return RpcCode.UNIMPLEMENTED;case Code.DATA_LOSS:return RpcCode.DATA_LOSS;default:return fail("Unknown status code: "+code)}}function mapCodeFromHttpStatus(status){switch(status){case 200:return Code.OK;case 400:return Code.INVALID_ARGUMENT;case 401:return Code.UNAUTHENTICATED;case 403:return Code.PERMISSION_DENIED;case 404:return Code.NOT_FOUND;case 409:return Code.ABORTED;case 416:return Code.OUT_OF_RANGE;case 429:return Code.RESOURCE_EXHAUSTED;case 499:return Code.CANCELLED;case 500:return Code.UNKNOWN;case 501:return Code.UNIMPLEMENTED;case 503:return Code.UNAVAILABLE;case 504:return Code.DEADLINE_EXCEEDED;default:if(status>=200&&status<300)return Code.OK;if(status>=400&&status<500)return Code.FAILED_PRECONDITION;if(status>=500&&status<600)return Code.INTERNAL;return Code.UNKNOWN}}var EMPTY_MAYBE_DOCUMENT_MAP=new SortedMap(DocumentKey.comparator);function maybeDocumentMap(){return EMPTY_MAYBE_DOCUMENT_MAP}function nullableMaybeDocumentMap(){return maybeDocumentMap()}var EMPTY_DOCUMENT_MAP=new SortedMap(DocumentKey.comparator);function documentMap(){return EMPTY_DOCUMENT_MAP}var EMPTY_DOCUMENT_VERSION_MAP=new SortedMap(DocumentKey.comparator);function documentVersionMap(){return EMPTY_DOCUMENT_VERSION_MAP}var EMPTY_DOCUMENT_KEY_SET=new SortedSet(DocumentKey.comparator);function documentKeySet(){var keys=[];for(var _i=0;_i<arguments.length;_i++){keys[_i]=arguments[_i]}var set=EMPTY_DOCUMENT_KEY_SET;for(var _a=0,keys_1=keys;_a<keys_1.length;_a++){var key=keys_1[_a];set=set.add(key)}return set}var EMPTY_TARGET_ID_SET=new SortedSet(primitiveComparator);function targetIdSet(){return EMPTY_TARGET_ID_SET}var DocumentSet=function(){function DocumentSet(comp){if(comp){this.comparator=function(d1,d2){return comp(d1,d2)||DocumentKey.comparator(d1.key,d2.key)}}else{this.comparator=function(d1,d2){return DocumentKey.comparator(d1.key,d2.key)}}this.keyedMap=documentMap();this.sortedSet=new SortedMap(this.comparator)}DocumentSet.emptySet=function(oldSet){return new DocumentSet(oldSet.comparator)};DocumentSet.prototype.has=function(key){return this.keyedMap.get(key)!=null};DocumentSet.prototype.get=function(key){return this.keyedMap.get(key)};DocumentSet.prototype.first=function(){return this.sortedSet.minKey()};DocumentSet.prototype.last=function(){return this.sortedSet.maxKey()};DocumentSet.prototype.isEmpty=function(){return this.sortedSet.isEmpty()};DocumentSet.prototype.indexOf=function(key){var doc=this.keyedMap.get(key);return doc?this.sortedSet.indexOf(doc):-1};Object.defineProperty(DocumentSet.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:true,configurable:true});DocumentSet.prototype.forEach=function(cb){this.sortedSet.inorderTraversal(function(k,v){cb(k);return false})};DocumentSet.prototype.add=function(doc){var set=this.delete(doc.key);return set.copy(set.keyedMap.insert(doc.key,doc),set.sortedSet.insert(doc,null))};DocumentSet.prototype.delete=function(key){var doc=this.get(key);if(!doc){return this}return this.copy(this.keyedMap.remove(key),this.sortedSet.remove(doc))};DocumentSet.prototype.isEqual=function(other){if(!(other instanceof DocumentSet))return false;if(this.size!==other.size)return false;var thisIt=this.sortedSet.getIterator();var otherIt=other.sortedSet.getIterator();while(thisIt.hasNext()){var thisDoc=thisIt.getNext().key;var otherDoc=otherIt.getNext().key;if(!thisDoc.isEqual(otherDoc))return false}return true};DocumentSet.prototype.toString=function(){var docStrings=[];this.forEach(function(doc){docStrings.push(doc.toString())});if(docStrings.length===0){return"DocumentSet ()"}else{return"DocumentSet (\n  "+docStrings.join("  \n")+"\n)"}};DocumentSet.prototype.copy=function(keyedMap,sortedSet){var newSet=new DocumentSet;newSet.comparator=this.comparator;newSet.keyedMap=keyedMap;newSet.sortedSet=sortedSet;return newSet};return DocumentSet}();var ChangeType;(function(ChangeType){ChangeType[ChangeType["Added"]=0]="Added";ChangeType[ChangeType["Removed"]=1]="Removed";ChangeType[ChangeType["Modified"]=2]="Modified";ChangeType[ChangeType["Metadata"]=3]="Metadata"})(ChangeType||(ChangeType={}));var SyncState;(function(SyncState){SyncState[SyncState["Local"]=0]="Local";SyncState[SyncState["Synced"]=1]="Synced"})(SyncState||(SyncState={}));var DocumentChangeSet=function(){function DocumentChangeSet(){this.changeMap=new SortedMap(DocumentKey.comparator)}DocumentChangeSet.prototype.track=function(change){var key=change.doc.key;var oldChange=this.changeMap.get(key);if(!oldChange){this.changeMap=this.changeMap.insert(key,change);return}if(change.type!==ChangeType.Added&&oldChange.type===ChangeType.Metadata){this.changeMap=this.changeMap.insert(key,change)}else if(change.type===ChangeType.Metadata&&oldChange.type!==ChangeType.Removed){this.changeMap=this.changeMap.insert(key,{type:oldChange.type,doc:change.doc})}else if(change.type===ChangeType.Modified&&oldChange.type===ChangeType.Modified){this.changeMap=this.changeMap.insert(key,{type:ChangeType.Modified,doc:change.doc})}else if(change.type===ChangeType.Modified&&oldChange.type===ChangeType.Added){this.changeMap=this.changeMap.insert(key,{type:ChangeType.Added,doc:change.doc})}else if(change.type===ChangeType.Removed&&oldChange.type===ChangeType.Added){this.changeMap=this.changeMap.remove(key)}else if(change.type===ChangeType.Removed&&oldChange.type===ChangeType.Modified){this.changeMap=this.changeMap.insert(key,{type:ChangeType.Removed,doc:oldChange.doc})}else if(change.type===ChangeType.Added&&oldChange.type===ChangeType.Removed){this.changeMap=this.changeMap.insert(key,{type:ChangeType.Modified,doc:change.doc})}else{fail("unsupported combination of changes: "+JSON.stringify(change)+" after "+JSON.stringify(oldChange))}};DocumentChangeSet.prototype.getChanges=function(){var changes=[];this.changeMap.inorderTraversal(function(key,change){changes.push(change)});return changes};return DocumentChangeSet}();var ViewSnapshot=function(){function ViewSnapshot(query,docs,oldDocs,docChanges,mutatedKeys,fromCache,syncStateChanged,excludesMetadataChanges){this.query=query;this.docs=docs;this.oldDocs=oldDocs;this.docChanges=docChanges;this.mutatedKeys=mutatedKeys;this.fromCache=fromCache;this.syncStateChanged=syncStateChanged;this.excludesMetadataChanges=excludesMetadataChanges}ViewSnapshot.fromInitialDocuments=function(query,documents,mutatedKeys,fromCache){var changes=[];documents.forEach(function(doc){changes.push({type:ChangeType.Added,doc:doc})});return new ViewSnapshot(query,documents,DocumentSet.emptySet(documents),changes,mutatedKeys,fromCache,true,false)};Object.defineProperty(ViewSnapshot.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:true,configurable:true});ViewSnapshot.prototype.isEqual=function(other){if(this.fromCache!==other.fromCache||this.syncStateChanged!==other.syncStateChanged||!this.mutatedKeys.isEqual(other.mutatedKeys)||!this.query.isEqual(other.query)||!this.docs.isEqual(other.docs)||!this.oldDocs.isEqual(other.oldDocs)){return false}var changes=this.docChanges;var otherChanges=other.docChanges;if(changes.length!==otherChanges.length){return false}for(var i=0;i<changes.length;i++){if(changes[i].type!==otherChanges[i].type||!changes[i].doc.isEqual(otherChanges[i].doc)){return false}}return true};return ViewSnapshot}();var RemoteEvent=function(){function RemoteEvent(snapshotVersion,targetChanges,targetMismatches,documentUpdates,resolvedLimboDocuments){this.snapshotVersion=snapshotVersion;this.targetChanges=targetChanges;this.targetMismatches=targetMismatches;this.documentUpdates=documentUpdates;this.resolvedLimboDocuments=resolvedLimboDocuments}RemoteEvent.createSynthesizedRemoteEventForCurrentChange=function(targetId,current){var _a;var targetChanges=(_a={},_a[targetId]=TargetChange.createSynthesizedTargetChangeForCurrentChange(targetId,current),_a);return new RemoteEvent(SnapshotVersion.MIN,targetChanges,targetIdSet(),maybeDocumentMap(),documentKeySet())};return RemoteEvent}();var TargetChange=function(){function TargetChange(resumeToken,current,addedDocuments,modifiedDocuments,removedDocuments){this.resumeToken=resumeToken;this.current=current;this.addedDocuments=addedDocuments;this.modifiedDocuments=modifiedDocuments;this.removedDocuments=removedDocuments}TargetChange.createSynthesizedTargetChangeForCurrentChange=function(targetId,current){return new TargetChange(emptyByteString(),current,documentKeySet(),documentKeySet(),documentKeySet())};return TargetChange}();var DocumentWatchChange=function(){function DocumentWatchChange(updatedTargetIds,removedTargetIds,key,newDoc){this.updatedTargetIds=updatedTargetIds;this.removedTargetIds=removedTargetIds;this.key=key;this.newDoc=newDoc}return DocumentWatchChange}();var ExistenceFilterChange=function(){function ExistenceFilterChange(targetId,existenceFilter){this.targetId=targetId;this.existenceFilter=existenceFilter}return ExistenceFilterChange}();var WatchTargetChangeState;(function(WatchTargetChangeState){WatchTargetChangeState[WatchTargetChangeState["NoChange"]=0]="NoChange";WatchTargetChangeState[WatchTargetChangeState["Added"]=1]="Added";WatchTargetChangeState[WatchTargetChangeState["Removed"]=2]="Removed";WatchTargetChangeState[WatchTargetChangeState["Current"]=3]="Current";WatchTargetChangeState[WatchTargetChangeState["Reset"]=4]="Reset"})(WatchTargetChangeState||(WatchTargetChangeState={}));var WatchTargetChange=function(){function WatchTargetChange(state,targetIds,resumeToken,cause){if(resumeToken===void 0){resumeToken=emptyByteString()}if(cause===void 0){cause=null}this.state=state;this.targetIds=targetIds;this.resumeToken=resumeToken;this.cause=cause}return WatchTargetChange}();var TargetState=function(){function TargetState(){this.pendingResponses=0;this.documentChanges=snapshotChangesMap();this._resumeToken=emptyByteString();this._current=false;this._hasPendingChanges=true}Object.defineProperty(TargetState.prototype,"current",{get:function(){return this._current},enumerable:true,configurable:true});Object.defineProperty(TargetState.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:true,configurable:true});Object.defineProperty(TargetState.prototype,"isPending",{get:function(){return this.pendingResponses!==0},enumerable:true,configurable:true});Object.defineProperty(TargetState.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:true,configurable:true});TargetState.prototype.updateResumeToken=function(resumeToken){if(resumeToken.length>0){this._hasPendingChanges=true;this._resumeToken=resumeToken}};TargetState.prototype.toTargetChange=function(){var addedDocuments=documentKeySet();var modifiedDocuments=documentKeySet();var removedDocuments=documentKeySet();this.documentChanges.forEach(function(key,changeType){switch(changeType){case ChangeType.Added:addedDocuments=addedDocuments.add(key);break;case ChangeType.Modified:modifiedDocuments=modifiedDocuments.add(key);break;case ChangeType.Removed:removedDocuments=removedDocuments.add(key);break;default:fail("Encountered invalid change type: "+changeType)}});return new TargetChange(this._resumeToken,this._current,addedDocuments,modifiedDocuments,removedDocuments)};TargetState.prototype.clearPendingChanges=function(){this._hasPendingChanges=false;this.documentChanges=snapshotChangesMap()};TargetState.prototype.addDocumentChange=function(key,changeType){this._hasPendingChanges=true;this.documentChanges=this.documentChanges.insert(key,changeType)};TargetState.prototype.removeDocumentChange=function(key){this._hasPendingChanges=true;this.documentChanges=this.documentChanges.remove(key)};TargetState.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1};TargetState.prototype.recordTargetResponse=function(){this.pendingResponses-=1};TargetState.prototype.markCurrent=function(){this._hasPendingChanges=true;this._current=true};return TargetState}();var WatchChangeAggregator=function(){function WatchChangeAggregator(metadataProvider){this.metadataProvider=metadataProvider;this.targetStates={};this.pendingDocumentUpdates=maybeDocumentMap();this.pendingDocumentTargetMapping=documentTargetMap();this.pendingTargetResets=new SortedSet(primitiveComparator)}WatchChangeAggregator.prototype.handleDocumentChange=function(docChange){for(var _i=0,_a=docChange.updatedTargetIds;_i<_a.length;_i++){var targetId=_a[_i];if(docChange.newDoc instanceof Document){this.addDocumentToTarget(targetId,docChange.newDoc)}else if(docChange.newDoc instanceof NoDocument){this.removeDocumentFromTarget(targetId,docChange.key,docChange.newDoc)}}for(var _b=0,_c=docChange.removedTargetIds;_b<_c.length;_b++){var targetId=_c[_b];this.removeDocumentFromTarget(targetId,docChange.key,docChange.newDoc)}};WatchChangeAggregator.prototype.handleTargetChange=function(targetChange){var _this=this;this.forEachTarget(targetChange,function(targetId){var targetState=_this.ensureTargetState(targetId);switch(targetChange.state){case WatchTargetChangeState.NoChange:if(_this.isActiveTarget(targetId)){targetState.updateResumeToken(targetChange.resumeToken)}break;case WatchTargetChangeState.Added:targetState.recordTargetResponse();if(!targetState.isPending){targetState.clearPendingChanges()}targetState.updateResumeToken(targetChange.resumeToken);break;case WatchTargetChangeState.Removed:targetState.recordTargetResponse();if(!targetState.isPending){_this.removeTarget(targetId)}assert(!targetChange.cause,"WatchChangeAggregator does not handle errored targets");break;case WatchTargetChangeState.Current:if(_this.isActiveTarget(targetId)){targetState.markCurrent();targetState.updateResumeToken(targetChange.resumeToken)}break;case WatchTargetChangeState.Reset:if(_this.isActiveTarget(targetId)){_this.resetTarget(targetId);targetState.updateResumeToken(targetChange.resumeToken)}break;default:fail("Unknown target watch change state: "+targetChange.state)}})};WatchChangeAggregator.prototype.forEachTarget=function(targetChange,fn){if(targetChange.targetIds.length>0){targetChange.targetIds.forEach(fn)}else{forEachNumber(this.targetStates,fn)}};WatchChangeAggregator.prototype.handleExistenceFilter=function(watchChange){var targetId=watchChange.targetId;var expectedCount=watchChange.existenceFilter.count;var queryData=this.queryDataForActiveTarget(targetId);if(queryData){var query=queryData.query;if(query.isDocumentQuery()){if(expectedCount===0){var key=new DocumentKey(query.path);this.removeDocumentFromTarget(targetId,key,new NoDocument(key,SnapshotVersion.forDeletedDoc()))}else{assert(expectedCount===1,"Single document existence filter with count: "+expectedCount)}}else{var currentSize=this.getCurrentDocumentCountForTarget(targetId);if(currentSize!==expectedCount){this.resetTarget(targetId);this.pendingTargetResets=this.pendingTargetResets.add(targetId)}}}};WatchChangeAggregator.prototype.createRemoteEvent=function(snapshotVersion){var _this=this;var targetChanges={};forEachNumber(this.targetStates,function(targetId,targetState){var queryData=_this.queryDataForActiveTarget(targetId);if(queryData){if(targetState.current&&queryData.query.isDocumentQuery()){var key=new DocumentKey(queryData.query.path);if(_this.pendingDocumentUpdates.get(key)===null&&!_this.targetContainsDocument(targetId,key)){_this.removeDocumentFromTarget(targetId,key,new NoDocument(key,snapshotVersion))}}if(targetState.hasPendingChanges){targetChanges[targetId]=targetState.toTargetChange();targetState.clearPendingChanges()}}});var resolvedLimboDocuments=documentKeySet();this.pendingDocumentTargetMapping.forEach(function(key,targets){var isOnlyLimboTarget=true;targets.forEachWhile(function(targetId){var queryData=_this.queryDataForActiveTarget(targetId);if(queryData&&queryData.purpose!==QueryPurpose.LimboResolution){isOnlyLimboTarget=false;return false}return true});if(isOnlyLimboTarget){resolvedLimboDocuments=resolvedLimboDocuments.add(key)}});var remoteEvent=new RemoteEvent(snapshotVersion,targetChanges,this.pendingTargetResets,this.pendingDocumentUpdates,resolvedLimboDocuments);this.pendingDocumentUpdates=maybeDocumentMap();this.pendingDocumentTargetMapping=documentTargetMap();this.pendingTargetResets=new SortedSet(primitiveComparator);return remoteEvent};WatchChangeAggregator.prototype.addDocumentToTarget=function(targetId,document){if(!this.isActiveTarget(targetId)){return}var changeType=this.targetContainsDocument(targetId,document.key)?ChangeType.Modified:ChangeType.Added;var targetState=this.ensureTargetState(targetId);targetState.addDocumentChange(document.key,changeType);this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(document.key,document);this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(document.key,this.ensureDocumentTargetMapping(document.key).add(targetId))};WatchChangeAggregator.prototype.removeDocumentFromTarget=function(targetId,key,updatedDocument){if(!this.isActiveTarget(targetId)){return}var targetState=this.ensureTargetState(targetId);if(this.targetContainsDocument(targetId,key)){targetState.addDocumentChange(key,ChangeType.Removed)}else{targetState.removeDocumentChange(key)}this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(key,this.ensureDocumentTargetMapping(key).delete(targetId));if(updatedDocument){this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(key,updatedDocument)}};WatchChangeAggregator.prototype.removeTarget=function(targetId){delete this.targetStates[targetId]};WatchChangeAggregator.prototype.getCurrentDocumentCountForTarget=function(targetId){var targetState=this.ensureTargetState(targetId);var targetChange=targetState.toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(targetId).size+targetChange.addedDocuments.size-targetChange.removedDocuments.size};WatchChangeAggregator.prototype.recordPendingTargetRequest=function(targetId){var targetState=this.ensureTargetState(targetId);targetState.recordPendingTargetRequest()};WatchChangeAggregator.prototype.ensureTargetState=function(targetId){if(!this.targetStates[targetId]){this.targetStates[targetId]=new TargetState}return this.targetStates[targetId]};WatchChangeAggregator.prototype.ensureDocumentTargetMapping=function(key){var targetMapping=this.pendingDocumentTargetMapping.get(key);if(!targetMapping){targetMapping=new SortedSet(primitiveComparator);this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(key,targetMapping)}return targetMapping};WatchChangeAggregator.prototype.isActiveTarget=function(targetId){return this.queryDataForActiveTarget(targetId)!==null};WatchChangeAggregator.prototype.queryDataForActiveTarget=function(targetId){var targetState=this.targetStates[targetId];return targetState&&targetState.isPending?null:this.metadataProvider.getQueryDataForTarget(targetId)};WatchChangeAggregator.prototype.resetTarget=function(targetId){var _this=this;assert(!this.targetStates[targetId].isPending,"Should only reset active targets");this.targetStates[targetId]=new TargetState;var existingKeys=this.metadataProvider.getRemoteKeysForTarget(targetId);existingKeys.forEach(function(key){_this.removeDocumentFromTarget(targetId,key,null)})};WatchChangeAggregator.prototype.targetContainsDocument=function(targetId,key){var existingKeys=this.metadataProvider.getRemoteKeysForTarget(targetId);return existingKeys.has(key)};return WatchChangeAggregator}();function documentTargetMap(){return new SortedMap(DocumentKey.comparator)}function snapshotChangesMap(){return new SortedMap(DocumentKey.comparator)}var DIRECTIONS=function(){var dirs={};dirs[Direction.ASCENDING.name]="ASCENDING";dirs[Direction.DESCENDING.name]="DESCENDING";return dirs}();var OPERATORS=function(){var ops={};ops[RelationOp.LESS_THAN.name]="LESS_THAN";ops[RelationOp.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL";ops[RelationOp.GREATER_THAN.name]="GREATER_THAN";ops[RelationOp.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL";ops[RelationOp.EQUAL.name]="EQUAL";ops[RelationOp.ARRAY_CONTAINS.name]="ARRAY_CONTAINS";return ops}();var ISO_REG_EXP=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function assertPresent(value,description){assert(!isNullOrUndefined(value),description+" is missing")}function parseInt64(value){if(typeof value==="number"){return value}else if(typeof value==="string"){return Number(value)}else{return fail("can't parse "+value)}}var JsonProtoSerializer=function(){function JsonProtoSerializer(databaseId,options){this.databaseId=databaseId;this.options=options}JsonProtoSerializer.prototype.emptyByteString=function(){if(this.options.useProto3Json){return""}else{return new Uint8Array(0)}};JsonProtoSerializer.prototype.unsafeCastProtoByteString=function(byteString){return byteString};JsonProtoSerializer.prototype.fromRpcStatus=function(status){var code=status.code===undefined?Code.UNKNOWN:mapCodeFromRpcCode(status.code);return new FirestoreError(code,status.message||"")};JsonProtoSerializer.prototype.toInt32Value=function(val){if(!isNullOrUndefined(val)){return{value:val}}else{return undefined}};JsonProtoSerializer.prototype.fromInt32Value=function(val){var result;if(typeof val==="object"){result=val.value}else{result=val}return isNullOrUndefined(result)?null:result};JsonProtoSerializer.prototype.toTimestamp=function(timestamp){return{seconds:timestamp.seconds,nanos:timestamp.nanoseconds}};JsonProtoSerializer.prototype.fromTimestamp=function(date){if(typeof date==="string"){return this.fromIso8601String(date)}else{assert(!!date,"Cannot deserialize null or undefined timestamp.");var seconds=parseInt64(date.seconds||"0");var nanos=date.nanos||0;return new Timestamp(seconds,nanos)}};JsonProtoSerializer.prototype.fromIso8601String=function(utc){var nanos=0;var fraction=ISO_REG_EXP.exec(utc);assert(!!fraction,"invalid timestamp: "+utc);if(fraction[1]){var nanoStr=fraction[1];nanoStr=(nanoStr+"000000000").substr(0,9);nanos=Number(nanoStr)}var date=new Date(utc);var seconds=Math.floor(date.getTime()/1e3);return new Timestamp(seconds,nanos)};JsonProtoSerializer.prototype.toBytes=function(bytes){if(this.options.useProto3Json){return bytes.toBase64()}else{return this.unsafeCastProtoByteString(bytes.toUint8Array())}};JsonProtoSerializer.prototype.fromBlob=function(blob){if(typeof blob==="string"){assert(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead.");return Blob.fromBase64String(blob)}else{assert(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead.");return Blob.fromUint8Array(blob)}};JsonProtoSerializer.prototype.toVersion=function(version){return this.toTimestamp(version.toTimestamp())};JsonProtoSerializer.prototype.fromVersion=function(version){assert(!!version,"Trying to deserialize version that isn't set");return SnapshotVersion.fromTimestamp(this.fromTimestamp(version))};JsonProtoSerializer.prototype.toResourceName=function(databaseId,path){return this.fullyQualifiedPrefixPath(databaseId).child("documents").child(path).canonicalString()};JsonProtoSerializer.prototype.fromResourceName=function(name){var resource=ResourcePath.fromString(name);assert(this.isValidResourceName(resource),"Tried to deserialize invalid key "+resource.toString());return resource};JsonProtoSerializer.prototype.toName=function(key){return this.toResourceName(this.databaseId,key.path)};JsonProtoSerializer.prototype.fromName=function(name){var resource=this.fromResourceName(name);assert(resource.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+resource.get(1)+" vs "+this.databaseId.projectId);assert(!resource.get(3)&&!this.databaseId.database||resource.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+resource.get(3)+" vs "+this.databaseId.database);return new DocumentKey(this.extractLocalPathFromResourceName(resource))};JsonProtoSerializer.prototype.toQueryPath=function(path){return this.toResourceName(this.databaseId,path)};JsonProtoSerializer.prototype.fromQueryPath=function(name){var resourceName=this.fromResourceName(name);if(resourceName.length===4){return ResourcePath.EMPTY_PATH}return this.extractLocalPathFromResourceName(resourceName)};Object.defineProperty(JsonProtoSerializer.prototype,"encodedDatabaseId",{get:function(){var path=new ResourcePath(["projects",this.databaseId.projectId,"databases",this.databaseId.database]);return path.canonicalString()},enumerable:true,configurable:true});JsonProtoSerializer.prototype.fullyQualifiedPrefixPath=function(databaseId){return new ResourcePath(["projects",databaseId.projectId,"databases",databaseId.database])};JsonProtoSerializer.prototype.extractLocalPathFromResourceName=function(resourceName){assert(resourceName.length>4&&resourceName.get(4)==="documents","tried to deserialize invalid key "+resourceName.toString());return resourceName.popFirst(5)};JsonProtoSerializer.prototype.isValidResourceName=function(path){return path.length>=4&&path.get(0)==="projects"&&path.get(2)==="databases"};JsonProtoSerializer.prototype.toValue=function(val){if(val instanceof NullValue){return{nullValue:"NULL_VALUE"}}else if(val instanceof BooleanValue){return{booleanValue:val.value()}}else if(val instanceof IntegerValue){return{integerValue:""+val.value()}}else if(val instanceof DoubleValue){var doubleValue=val.value();if(this.options.useProto3Json){if(isNaN(doubleValue)){return{doubleValue:"NaN"}}else if(doubleValue===Infinity){return{doubleValue:"Infinity"}}else if(doubleValue===-Infinity){return{doubleValue:"-Infinity"}}}return{doubleValue:val.value()}}else if(val instanceof StringValue){return{stringValue:val.value()}}else if(val instanceof ObjectValue){return{mapValue:this.toMapValue(val)}}else if(val instanceof ArrayValue){return{arrayValue:this.toArrayValue(val)}}else if(val instanceof TimestampValue){return{timestampValue:this.toTimestamp(val.internalValue)}}else if(val instanceof GeoPointValue){return{geoPointValue:{latitude:val.value().latitude,longitude:val.value().longitude}}}else if(val instanceof BlobValue){return{bytesValue:this.toBytes(val.value())}}else if(val instanceof RefValue){return{referenceValue:this.toResourceName(val.databaseId,val.key.path)}}else{return fail("Unknown FieldValue "+JSON.stringify(val))}};JsonProtoSerializer.prototype.fromValue=function(obj){var _this=this;var type=obj["value_type"];if(hasTag(obj,type,"nullValue")){return NullValue.INSTANCE}else if(hasTag(obj,type,"booleanValue")){return BooleanValue.of(obj.booleanValue)}else if(hasTag(obj,type,"integerValue")){return new IntegerValue(parseInt64(obj.integerValue))}else if(hasTag(obj,type,"doubleValue")){if(this.options.useProto3Json){if(obj.doubleValue==="NaN"){return DoubleValue.NAN}else if(obj.doubleValue==="Infinity"){return DoubleValue.POSITIVE_INFINITY}else if(obj.doubleValue==="-Infinity"){return DoubleValue.NEGATIVE_INFINITY}}return new DoubleValue(obj.doubleValue)}else if(hasTag(obj,type,"stringValue")){return new StringValue(obj.stringValue)}else if(hasTag(obj,type,"mapValue")){return this.fromFields(obj.mapValue.fields||{})}else if(hasTag(obj,type,"arrayValue")){assertPresent(obj.arrayValue,"arrayValue");var values=obj.arrayValue.values||[];return new ArrayValue(values.map(function(v){return _this.fromValue(v)}))}else if(hasTag(obj,type,"timestampValue")){assertPresent(obj.timestampValue,"timestampValue");return new TimestampValue(this.fromTimestamp(obj.timestampValue))}else if(hasTag(obj,type,"geoPointValue")){assertPresent(obj.geoPointValue,"geoPointValue");var latitude=obj.geoPointValue.latitude||0;var longitude=obj.geoPointValue.longitude||0;return new GeoPointValue(new GeoPoint(latitude,longitude))}else if(hasTag(obj,type,"bytesValue")){assertPresent(obj.bytesValue,"bytesValue");var blob=this.fromBlob(obj.bytesValue);return new BlobValue(blob)}else if(hasTag(obj,type,"referenceValue")){assertPresent(obj.referenceValue,"referenceValue");var resourceName=this.fromResourceName(obj.referenceValue);var dbId=new DatabaseId(resourceName.get(1),resourceName.get(3));var key=new DocumentKey(this.extractLocalPathFromResourceName(resourceName));return new RefValue(dbId,key)}else{return fail("Unknown Value proto "+JSON.stringify(obj))}};JsonProtoSerializer.prototype.toMutationDocument=function(key,fields){return{name:this.toName(key),fields:this.toFields(fields)}};JsonProtoSerializer.prototype.toDocument=function(document){assert(!document.hasLocalMutations,"Can't serialize documents with mutations.");return{name:this.toName(document.key),fields:this.toFields(document.data),updateTime:this.toTimestamp(document.version.toTimestamp())}};JsonProtoSerializer.prototype.fromDocument=function(document,hasCommittedMutations){return new Document(this.fromName(document.name),this.fromVersion(document.updateTime),this.fromFields(document.fields||{}),{hasCommittedMutations:!!hasCommittedMutations})};JsonProtoSerializer.prototype.toFields=function(fields){var _this=this;var result={};fields.forEach(function(key,value){result[key]=_this.toValue(value)});return result};JsonProtoSerializer.prototype.fromFields=function(object){var _this=this;var map=object;var result=ObjectValue.EMPTY;forEach(map,function(key,value){result=result.set(new FieldPath([key]),_this.fromValue(value))});return result};JsonProtoSerializer.prototype.toMapValue=function(map){return{fields:this.toFields(map)}};JsonProtoSerializer.prototype.toArrayValue=function(array){var _this=this;var result=[];array.forEach(function(value){result.push(_this.toValue(value))});return{values:result}};JsonProtoSerializer.prototype.fromFound=function(doc){assert(!!doc.found,"Tried to deserialize a found document from a missing document.");assertPresent(doc.found.name,"doc.found.name");assertPresent(doc.found.updateTime,"doc.found.updateTime");var key=this.fromName(doc.found.name);var version=this.fromVersion(doc.found.updateTime);var fields=this.fromFields(doc.found.fields||{});return new Document(key,version,fields,{},doc.found)};JsonProtoSerializer.prototype.fromMissing=function(result){assert(!!result.missing,"Tried to deserialize a missing document from a found document.");assert(!!result.readTime,"Tried to deserialize a missing document without a read time.");var key=this.fromName(result.missing);var version=this.fromVersion(result.readTime);return new NoDocument(key,version)};JsonProtoSerializer.prototype.fromMaybeDocument=function(result){var type=result["result"];if(hasTag(result,type,"found")){return this.fromFound(result)}else if(hasTag(result,type,"missing")){return this.fromMissing(result)}return fail("invalid batch get response: "+JSON.stringify(result))};JsonProtoSerializer.prototype.toWatchTargetChangeState=function(state){switch(state){case WatchTargetChangeState.Added:return"ADD";case WatchTargetChangeState.Current:return"CURRENT";case WatchTargetChangeState.NoChange:return"NO_CHANGE";case WatchTargetChangeState.Removed:return"REMOVE";case WatchTargetChangeState.Reset:return"RESET";default:return fail("Unknown WatchTargetChangeState: "+state)}};JsonProtoSerializer.prototype.toTestWatchChange=function(watchChange){if(watchChange instanceof ExistenceFilterChange){return{filter:{count:watchChange.existenceFilter.count,targetId:watchChange.targetId}}}if(watchChange instanceof DocumentWatchChange){if(watchChange.newDoc instanceof Document){var doc=watchChange.newDoc;return{documentChange:{document:{name:this.toName(doc.key),fields:this.toFields(doc.data),updateTime:this.toVersion(doc.version)},targetIds:watchChange.updatedTargetIds,removedTargetIds:watchChange.removedTargetIds}}}else if(watchChange.newDoc instanceof NoDocument){var doc=watchChange.newDoc;return{documentDelete:{document:this.toName(doc.key),readTime:this.toVersion(doc.version),removedTargetIds:watchChange.removedTargetIds}}}else if(watchChange.newDoc===null){return{documentRemove:{document:this.toName(watchChange.key),removedTargetIds:watchChange.removedTargetIds}}}}if(watchChange instanceof WatchTargetChange){var cause=undefined;if(watchChange.cause){cause={code:mapRpcCodeFromCode(watchChange.cause.code),message:watchChange.cause.message}}return{targetChange:{targetChangeType:this.toWatchTargetChangeState(watchChange.state),targetIds:watchChange.targetIds,resumeToken:this.unsafeCastProtoByteString(watchChange.resumeToken),cause:cause}}}return fail("Unrecognized watch change: "+JSON.stringify(watchChange))};JsonProtoSerializer.prototype.fromWatchChange=function(change){var type=change["response_type"];var watchChange;if(hasTag(change,type,"targetChange")){assertPresent(change.targetChange,"targetChange");var state=this.fromWatchTargetChangeState(change.targetChange.targetChangeType||"NO_CHANGE");var targetIds=change.targetChange.targetIds||[];var resumeToken=change.targetChange.resumeToken||this.emptyByteString();var causeProto=change.targetChange.cause;var cause=causeProto&&this.fromRpcStatus(causeProto);watchChange=new WatchTargetChange(state,targetIds,resumeToken,cause||null)}else if(hasTag(change,type,"documentChange")){assertPresent(change.documentChange,"documentChange");assertPresent(change.documentChange.document,"documentChange.name");assertPresent(change.documentChange.document.name,"documentChange.document.name");assertPresent(change.documentChange.document.updateTime,"documentChange.document.updateTime");var entityChange=change.documentChange;var key=this.fromName(entityChange.document.name);var version=this.fromVersion(entityChange.document.updateTime);var fields=this.fromFields(entityChange.document.fields||{});var doc=new Document(key,version,fields,{},entityChange.document);var updatedTargetIds=entityChange.targetIds||[];var removedTargetIds=entityChange.removedTargetIds||[];watchChange=new DocumentWatchChange(updatedTargetIds,removedTargetIds,doc.key,doc)}else if(hasTag(change,type,"documentDelete")){assertPresent(change.documentDelete,"documentDelete");assertPresent(change.documentDelete.document,"documentDelete.document");var docDelete=change.documentDelete;var key=this.fromName(docDelete.document);var version=docDelete.readTime?this.fromVersion(docDelete.readTime):SnapshotVersion.forDeletedDoc();var doc=new NoDocument(key,version);var removedTargetIds=docDelete.removedTargetIds||[];watchChange=new DocumentWatchChange([],removedTargetIds,doc.key,doc)}else if(hasTag(change,type,"documentRemove")){assertPresent(change.documentRemove,"documentRemove");assertPresent(change.documentRemove.document,"documentRemove");var docRemove=change.documentRemove;var key=this.fromName(docRemove.document);var removedTargetIds=docRemove.removedTargetIds||[];watchChange=new DocumentWatchChange([],removedTargetIds,key,null)}else if(hasTag(change,type,"filter")){assertPresent(change.filter,"filter");assertPresent(change.filter.targetId,"filter.targetId");var filter=change.filter;var count=filter.count||0;var existenceFilter=new ExistenceFilter(count);var targetId=filter.targetId;watchChange=new ExistenceFilterChange(targetId,existenceFilter)}else{return fail("Unknown change type "+JSON.stringify(change))}return watchChange};JsonProtoSerializer.prototype.fromWatchTargetChangeState=function(state){if(state==="NO_CHANGE"){return WatchTargetChangeState.NoChange}else if(state==="ADD"){return WatchTargetChangeState.Added}else if(state==="REMOVE"){return WatchTargetChangeState.Removed}else if(state==="CURRENT"){return WatchTargetChangeState.Current}else if(state==="RESET"){return WatchTargetChangeState.Reset}else{return fail("Got unexpected TargetChange.state: "+state)}};JsonProtoSerializer.prototype.versionFromListenResponse=function(change){var type=change["response_type"];if(!hasTag(change,type,"targetChange")){return SnapshotVersion.MIN}var targetChange=change.targetChange;if(targetChange.targetIds&&targetChange.targetIds.length){return SnapshotVersion.MIN}if(!targetChange.readTime){return SnapshotVersion.MIN}return this.fromVersion(targetChange.readTime)};JsonProtoSerializer.prototype.toMutation=function(mutation){var _this=this;var result;if(mutation instanceof SetMutation){result={update:this.toMutationDocument(mutation.key,mutation.value)}}else if(mutation instanceof DeleteMutation){result={delete:this.toName(mutation.key)}}else if(mutation instanceof PatchMutation){result={update:this.toMutationDocument(mutation.key,mutation.data),updateMask:this.toDocumentMask(mutation.fieldMask)}}else if(mutation instanceof TransformMutation){result={transform:{document:this.toName(mutation.key),fieldTransforms:mutation.fieldTransforms.map(function(transform){return _this.toFieldTransform(transform)})}}}else{return fail("Unknown mutation type "+mutation.type)}if(!mutation.precondition.isNone){result.currentDocument=this.toPrecondition(mutation.precondition)}return result};JsonProtoSerializer.prototype.fromMutation=function(proto){var _this=this;var precondition=proto.currentDocument?this.fromPrecondition(proto.currentDocument):Precondition.NONE;if(proto.update){assertPresent(proto.update.name,"name");var key=this.fromName(proto.update.name);var value=this.fromFields(proto.update.fields||{});if(proto.updateMask){var fieldMask=this.fromDocumentMask(proto.updateMask);return new PatchMutation(key,value,fieldMask,precondition)}else{return new SetMutation(key,value,precondition)}}else if(proto.delete){var key=this.fromName(proto.delete);return new DeleteMutation(key,precondition)}else if(proto.transform){var key=this.fromName(proto.transform.document);var fieldTransforms=proto.transform.fieldTransforms.map(function(transform){return _this.fromFieldTransform(transform)});assert(precondition.exists===true,'Transforms only support precondition "exists == true"');return new TransformMutation(key,fieldTransforms)}else{return fail("unknown mutation proto: "+JSON.stringify(proto))}};JsonProtoSerializer.prototype.toPrecondition=function(precondition){assert(!precondition.isNone,"Can't serialize an empty precondition");if(precondition.updateTime!==undefined){return{updateTime:this.toVersion(precondition.updateTime)}}else if(precondition.exists!==undefined){return{exists:precondition.exists}}else{return fail("Unknown precondition")}};JsonProtoSerializer.prototype.fromPrecondition=function(precondition){if(precondition.updateTime!==undefined){return Precondition.updateTime(this.fromVersion(precondition.updateTime))}else if(precondition.exists!==undefined){return Precondition.exists(precondition.exists)}else{return Precondition.NONE}};JsonProtoSerializer.prototype.fromWriteResult=function(proto,commitTime){var _this=this;var version=proto.updateTime?this.fromVersion(proto.updateTime):this.fromVersion(commitTime);var transformResults=null;if(proto.transformResults&&proto.transformResults.length>0){transformResults=proto.transformResults.map(function(result){return _this.fromValue(result)})}return new MutationResult(version,transformResults)};JsonProtoSerializer.prototype.fromWriteResults=function(protos,commitTime){var _this=this;if(protos&&protos.length>0){assert(commitTime!==undefined,"Received a write result without a commit time");return protos.map(function(proto){return _this.fromWriteResult(proto,commitTime)})}else{return[]}};JsonProtoSerializer.prototype.toFieldTransform=function(fieldTransform){var _this=this;var transform=fieldTransform.transform;if(transform instanceof ServerTimestampTransform){return{fieldPath:fieldTransform.field.canonicalString(),setToServerValue:"REQUEST_TIME"}}else if(transform instanceof ArrayUnionTransformOperation){return{fieldPath:fieldTransform.field.canonicalString(),appendMissingElements:{values:transform.elements.map(function(v){return _this.toValue(v)})}}}else if(transform instanceof ArrayRemoveTransformOperation){return{fieldPath:fieldTransform.field.canonicalString(),removeAllFromArray:{values:transform.elements.map(function(v){return _this.toValue(v)})}}}else if(transform instanceof NumericIncrementTransformOperation){return{fieldPath:fieldTransform.field.canonicalString(),increment:this.toValue(transform.operand)}}else{throw fail("Unknown transform: "+fieldTransform.transform)}};JsonProtoSerializer.prototype.fromFieldTransform=function(proto){var _this=this;var type=proto["transform_type"];var transform=null;if(hasTag(proto,type,"setToServerValue")){assert(proto.setToServerValue==="REQUEST_TIME","Unknown server value transform proto: "+JSON.stringify(proto));transform=ServerTimestampTransform.instance}else if(hasTag(proto,type,"appendMissingElements")){var values=proto.appendMissingElements.values||[];transform=new ArrayUnionTransformOperation(values.map(function(v){return _this.fromValue(v)}))}else if(hasTag(proto,type,"removeAllFromArray")){var values=proto.removeAllFromArray.values||[];transform=new ArrayRemoveTransformOperation(values.map(function(v){return _this.fromValue(v)}))}else if(hasTag(proto,type,"increment")){var operand=this.fromValue(proto.increment);assert(operand instanceof NumberValue,"NUMERIC_ADD transform requires a NumberValue");transform=new NumericIncrementTransformOperation(operand)}else{fail("Unknown transform proto: "+JSON.stringify(proto))}var fieldPath=FieldPath.fromServerFormat(proto.fieldPath);return new FieldTransform(fieldPath,transform)};JsonProtoSerializer.prototype.toDocumentsTarget=function(query){return{documents:[this.toQueryPath(query.path)]}};JsonProtoSerializer.prototype.fromDocumentsTarget=function(documentsTarget){var count=documentsTarget.documents.length;assert(count===1,"DocumentsTarget contained other than 1 document: "+count);var name=documentsTarget.documents[0];return Query.atPath(this.fromQueryPath(name))};JsonProtoSerializer.prototype.toQueryTarget=function(query){var result={structuredQuery:{}};var path=query.path;if(query.collectionGroup!==null){assert(path.length%2===0,"Collection Group queries should be within a document path or root.");result.parent=this.toQueryPath(path);result.structuredQuery.from=[{collectionId:query.collectionGroup,allDescendants:true}]}else{assert(path.length%2!==0,"Document queries with filters are not supported.");result.parent=this.toQueryPath(path.popLast());result.structuredQuery.from=[{collectionId:path.lastSegment()}]}var where=this.toFilter(query.filters);if(where){result.structuredQuery.where=where}var orderBy=this.toOrder(query.orderBy);if(orderBy){result.structuredQuery.orderBy=orderBy}var limit=this.toInt32Value(query.limit);if(limit!==undefined){result.structuredQuery.limit=limit}if(query.startAt){result.structuredQuery.startAt=this.toCursor(query.startAt)}if(query.endAt){result.structuredQuery.endAt=this.toCursor(query.endAt)}return result};JsonProtoSerializer.prototype.fromQueryTarget=function(target){var path=this.fromQueryPath(target.parent);var query=target.structuredQuery;var fromCount=query.from?query.from.length:0;var collectionGroup=null;if(fromCount>0){assert(fromCount===1,"StructuredQuery.from with more than one collection is not supported.");var from=query.from[0];if(from.allDescendants){collectionGroup=from.collectionId}else{path=path.child(from.collectionId)}}var filterBy=[];if(query.where){filterBy=this.fromFilter(query.where)}var orderBy=[];if(query.orderBy){orderBy=this.fromOrder(query.orderBy)}var limit=null;if(query.limit){limit=this.fromInt32Value(query.limit)}var startAt=null;if(query.startAt){startAt=this.fromCursor(query.startAt)}var endAt=null;if(query.endAt){endAt=this.fromCursor(query.endAt)}return new Query(path,collectionGroup,orderBy,filterBy,limit,startAt,endAt)};JsonProtoSerializer.prototype.toListenRequestLabels=function(queryData){var value=this.toLabel(queryData.purpose);if(value==null){return null}else{return{"goog-listen-tags":value}}};JsonProtoSerializer.prototype.toLabel=function(purpose){switch(purpose){case QueryPurpose.Listen:return null;case QueryPurpose.ExistenceFilterMismatch:return"existence-filter-mismatch";case QueryPurpose.LimboResolution:return"limbo-document";default:return fail("Unrecognized query purpose: "+purpose)}};JsonProtoSerializer.prototype.toTarget=function(queryData){var result;var query=queryData.query;if(query.isDocumentQuery()){result={documents:this.toDocumentsTarget(query)}}else{result={query:this.toQueryTarget(query)}}result.targetId=queryData.targetId;if(queryData.resumeToken.length>0){result.resumeToken=this.unsafeCastProtoByteString(queryData.resumeToken)}return result};JsonProtoSerializer.prototype.toFilter=function(filters){var _this=this;if(filters.length===0)return;var protos=filters.map(function(filter){return filter instanceof RelationFilter?_this.toRelationFilter(filter):_this.toUnaryFilter(filter)});if(protos.length===1){return protos[0]}return{compositeFilter:{op:"AND",filters:protos}}};JsonProtoSerializer.prototype.fromFilter=function(filter){var _this=this;if(!filter){return[]}else if(filter.unaryFilter!==undefined){return[this.fromUnaryFilter(filter)]}else if(filter.fieldFilter!==undefined){return[this.fromRelationFilter(filter)]}else if(filter.compositeFilter!==undefined){return filter.compositeFilter.filters.map(function(f){return _this.fromFilter(f)}).reduce(function(accum,current){return accum.concat(current)})}else{return fail("Unknown filter: "+JSON.stringify(filter))}};JsonProtoSerializer.prototype.toOrder=function(orderBys){var _this=this;if(orderBys.length===0)return;return orderBys.map(function(order){return _this.toPropertyOrder(order)})};JsonProtoSerializer.prototype.fromOrder=function(orderBys){var _this=this;return orderBys.map(function(order){return _this.fromPropertyOrder(order)})};JsonProtoSerializer.prototype.toCursor=function(cursor){var _this=this;return{before:cursor.before,values:cursor.position.map(function(component){return _this.toValue(component)})}};JsonProtoSerializer.prototype.fromCursor=function(cursor){var _this=this;var before=!!cursor.before;var position=cursor.values.map(function(component){return _this.fromValue(component)});return new Bound(position,before)};JsonProtoSerializer.prototype.toDirection=function(dir){return DIRECTIONS[dir.name]};JsonProtoSerializer.prototype.fromDirection=function(dir){switch(dir){case"ASCENDING":return Direction.ASCENDING;case"DESCENDING":return Direction.DESCENDING;default:return undefined}};JsonProtoSerializer.prototype.toOperatorName=function(op){return OPERATORS[op.name]};JsonProtoSerializer.prototype.fromOperatorName=function(op){switch(op){case"EQUAL":return RelationOp.EQUAL;case"GREATER_THAN":return RelationOp.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return RelationOp.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return RelationOp.LESS_THAN;case"LESS_THAN_OR_EQUAL":return RelationOp.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return RelationOp.ARRAY_CONTAINS;case"OPERATOR_UNSPECIFIED":return fail("Unspecified relation");default:return fail("Unknown relation")}};JsonProtoSerializer.prototype.toFieldPathReference=function(path){return{fieldPath:path.canonicalString()}};JsonProtoSerializer.prototype.fromFieldPathReference=function(fieldReference){return FieldPath.fromServerFormat(fieldReference.fieldPath)};JsonProtoSerializer.prototype.toPropertyOrder=function(orderBy){return{field:this.toFieldPathReference(orderBy.field),direction:this.toDirection(orderBy.dir)}};JsonProtoSerializer.prototype.fromPropertyOrder=function(orderBy){return new OrderBy(this.fromFieldPathReference(orderBy.field),this.fromDirection(orderBy.direction))};JsonProtoSerializer.prototype.toRelationFilter=function(filter){if(filter instanceof RelationFilter){return{fieldFilter:{field:this.toFieldPathReference(filter.field),op:this.toOperatorName(filter.op),value:this.toValue(filter.value)}}}else{return fail("Unrecognized filter: "+JSON.stringify(filter))}};JsonProtoSerializer.prototype.fromRelationFilter=function(filter){return new RelationFilter(this.fromFieldPathReference(filter.fieldFilter.field),this.fromOperatorName(filter.fieldFilter.op),this.fromValue(filter.fieldFilter.value))};JsonProtoSerializer.prototype.toUnaryFilter=function(filter){if(filter instanceof NanFilter){return{unaryFilter:{field:this.toFieldPathReference(filter.field),op:"IS_NAN"}}}else if(filter instanceof NullFilter){return{unaryFilter:{field:this.toFieldPathReference(filter.field),op:"IS_NULL"}}}else{return fail("Unrecognized filter: "+JSON.stringify(filter))}};JsonProtoSerializer.prototype.fromUnaryFilter=function(filter){switch(filter.unaryFilter.op){case"IS_NAN":var nanField=this.fromFieldPathReference(filter.unaryFilter.field);return new NanFilter(nanField);case"IS_NULL":var nullField=this.fromFieldPathReference(filter.unaryFilter.field);return new NullFilter(nullField);case"OPERATOR_UNSPECIFIED":return fail("Unspecified filter");default:return fail("Unknown filter")}};JsonProtoSerializer.prototype.toDocumentMask=function(fieldMask){var canonicalFields=[];fieldMask.fields.forEach(function(field){return canonicalFields.push(field.canonicalString())});return{fieldPaths:canonicalFields}};JsonProtoSerializer.prototype.fromDocumentMask=function(proto){var paths=proto.fieldPaths||[];var fields=paths.map(function(path){return FieldPath.fromServerFormat(path)});return FieldMask.fromArray(fields)};return JsonProtoSerializer}();function hasTag(obj,type,tag){return type===tag||!type&&tag in obj}var StreamBridge=function(){function StreamBridge(args){this.sendFn=args.sendFn;this.closeFn=args.closeFn}StreamBridge.prototype.onOpen=function(callback){assert(!this.wrappedOnOpen,"Called onOpen on stream twice!");this.wrappedOnOpen=callback};StreamBridge.prototype.onClose=function(callback){assert(!this.wrappedOnClose,"Called onClose on stream twice!");this.wrappedOnClose=callback};StreamBridge.prototype.onMessage=function(callback){assert(!this.wrappedOnMessage,"Called onMessage on stream twice!");this.wrappedOnMessage=callback};StreamBridge.prototype.close=function(){this.closeFn()};StreamBridge.prototype.send=function(msg){this.sendFn(msg)};StreamBridge.prototype.callOnOpen=function(){assert(this.wrappedOnOpen!==undefined,"Cannot call onOpen because no callback was set");this.wrappedOnOpen()};StreamBridge.prototype.callOnClose=function(err){assert(this.wrappedOnClose!==undefined,"Cannot call onClose because no callback was set");this.wrappedOnClose(err)};StreamBridge.prototype.callOnMessage=function(msg){assert(this.wrappedOnMessage!==undefined,"Cannot call onMessage because no callback was set");this.wrappedOnMessage(msg)};return StreamBridge}();var LOG_TAG="Connection";var RPC_STREAM_SERVICE="google.firestore.v1.Firestore";var RPC_URL_VERSION="v1";var RPC_NAME_REST_MAPPING={BatchGetDocuments:"batchGet",Commit:"commit"};var X_GOOG_API_CLIENT_VALUE="gl-js/ fire/"+SDK_VERSION;var XHR_TIMEOUT_SECS=15;var WebChannelConnection=function(){function WebChannelConnection(info){this.databaseId=info.databaseId;var proto=info.ssl?"https":"http";this.baseUrl=proto+"://"+info.host}WebChannelConnection.prototype.modifyHeadersForRequest=function(headers,token){if(token){for(var header in token.authHeaders){if(token.authHeaders.hasOwnProperty(header)){headers[header]=token.authHeaders[header]}}}headers["X-Goog-Api-Client"]=X_GOOG_API_CLIENT_VALUE};WebChannelConnection.prototype.invokeRPC=function(rpcName,request,token){var _this=this;var url=this.makeUrl(rpcName);return new Promise(function(resolve,reject){var xhr=new webchannelWrapper.XhrIo;xhr.listenOnce(webchannelWrapper.EventType.COMPLETE,function(){try{switch(xhr.getLastErrorCode()){case webchannelWrapper.ErrorCode.NO_ERROR:var json=xhr.getResponseJson();debug(LOG_TAG,"XHR received:",JSON.stringify(json));resolve(json);break;case webchannelWrapper.ErrorCode.TIMEOUT:debug(LOG_TAG,'RPC "'+rpcName+'" timed out');reject(new FirestoreError(Code.DEADLINE_EXCEEDED,"Request time out"));break;case webchannelWrapper.ErrorCode.HTTP_ERROR:var status_1=xhr.getStatus();debug(LOG_TAG,'RPC "'+rpcName+'" failed with status:',status_1,"response text:",xhr.getResponseText());if(status_1>0){reject(new FirestoreError(mapCodeFromHttpStatus(status_1),"Server responded with status "+xhr.getStatusText()))}else{debug(LOG_TAG,'RPC "'+rpcName+'" failed');reject(new FirestoreError(Code.UNAVAILABLE,"Connection failed."))}break;default:fail('RPC "'+rpcName+'" failed with unanticipated '+"webchannel error "+xhr.getLastErrorCode()+": "+xhr.getLastError()+", giving up.")}}finally{debug(LOG_TAG,'RPC "'+rpcName+'" completed.')}});var requestString=JSON.stringify(request);debug(LOG_TAG,"XHR sending: ",url+" "+requestString);var headers={"Content-Type":"text/plain"};_this.modifyHeadersForRequest(headers,token);xhr.send(url,"POST",requestString,headers,XHR_TIMEOUT_SECS)})};WebChannelConnection.prototype.invokeStreamingRPC=function(rpcName,request,token){return this.invokeRPC(rpcName,request,token)};WebChannelConnection.prototype.openStream=function(rpcName,token){var urlParts=[this.baseUrl,"/",RPC_STREAM_SERVICE,"/",rpcName,"/channel"];var webchannelTransport=webchannelWrapper.createWebChannelTransport();var request={backgroundChannelTest:true,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:true,supportsCrossDomainXhr:true,internalChannelParams:{forwardChannelRequestTimeoutMs:10*60*1e3}};this.modifyHeadersForRequest(request.initMessageHeaders,token);if(!util.isReactNative()){request["httpHeadersOverwriteParam"]="$httpHeaders"}var url=urlParts.join("");debug(LOG_TAG,"Creating WebChannel: "+url+" "+request);var channel=webchannelTransport.createWebChannel(url,request);var opened=false;var closed=false;var streamBridge=new StreamBridge({sendFn:function(msg){if(!closed){if(!opened){debug(LOG_TAG,"Opening WebChannel transport.");channel.open();opened=true}debug(LOG_TAG,"WebChannel sending:",msg);channel.send(msg)}else{debug(LOG_TAG,"Not sending because WebChannel is closed:",msg)}},closeFn:function(){return channel.close()}});var unguardedEventListen=function(type,fn){channel.listen(type,function(param){try{fn(param)}catch(e){setTimeout(function(){throw e},0)}})};unguardedEventListen(webchannelWrapper.WebChannel.EventType.OPEN,function(){if(!closed){debug(LOG_TAG,"WebChannel transport opened.")}});unguardedEventListen(webchannelWrapper.WebChannel.EventType.CLOSE,function(){if(!closed){closed=true;debug(LOG_TAG,"WebChannel transport closed");streamBridge.callOnClose()}});unguardedEventListen(webchannelWrapper.WebChannel.EventType.ERROR,function(err){if(!closed){closed=true;debug(LOG_TAG,"WebChannel transport errored:",err);streamBridge.callOnClose(new FirestoreError(Code.UNAVAILABLE,"The operation could not be completed"))}});unguardedEventListen(webchannelWrapper.WebChannel.EventType.MESSAGE,function(msg){if(!closed){var msgData=msg.data[0];assert(!!msgData,"Got a webchannel message without data.");var error=msgData.error||msgData[0]&&msgData[0].error;if(error){debug(LOG_TAG,"WebChannel received error:",error);var status_2=error.status;var code=mapCodeFromRpcStatus(status_2);var message=error.message;if(code===undefined){code=Code.INTERNAL;message="Unknown error status: "+status_2+" with message "+error.message}closed=true;streamBridge.callOnClose(new FirestoreError(code,message));channel.close()}else{debug(LOG_TAG,"WebChannel received:",msgData);streamBridge.callOnMessage(msgData)}}});setTimeout(function(){streamBridge.callOnOpen()},0);return streamBridge};WebChannelConnection.prototype.makeUrl=function(rpcName){var urlRpcName=RPC_NAME_REST_MAPPING[rpcName];assert(urlRpcName!==undefined,"Unknown REST mapping for: "+rpcName);var url=[this.baseUrl,"/",RPC_URL_VERSION];url.push("/projects/");url.push(this.databaseId.projectId);url.push("/databases/");url.push(this.databaseId.database);url.push("/documents");url.push(":");url.push(urlRpcName);return url.join("")};return WebChannelConnection}();var BrowserPlatform=function(){function BrowserPlatform(){this.emptyByteString="";this.base64Available=typeof atob!=="undefined"}Object.defineProperty(BrowserPlatform.prototype,"document",{get:function(){return typeof document!=="undefined"?document:null},enumerable:true,configurable:true});Object.defineProperty(BrowserPlatform.prototype,"window",{get:function(){return typeof window!=="undefined"?window:null},enumerable:true,configurable:true});BrowserPlatform.prototype.loadConnection=function(databaseInfo){return Promise.resolve(new WebChannelConnection(databaseInfo))};BrowserPlatform.prototype.newSerializer=function(databaseId){return new JsonProtoSerializer(databaseId,{useProto3Json:true})};BrowserPlatform.prototype.formatJSON=function(value){return JSON.stringify(value)};BrowserPlatform.prototype.atob=function(encoded){return atob(encoded)};BrowserPlatform.prototype.btoa=function(raw){return btoa(raw)};return BrowserPlatform}();PlatformSupport.setPlatform(new BrowserPlatform);var ListenSequence=function(){function ListenSequence(previousValue,sequenceNumberSyncer){var _this=this;this.previousValue=previousValue;if(sequenceNumberSyncer){sequenceNumberSyncer.sequenceNumberHandler=function(sequenceNumber){return _this.setPreviousValue(sequenceNumber)};this.writeNewSequenceNumber=function(sequenceNumber){return sequenceNumberSyncer.writeSequenceNumber(sequenceNumber)}}}ListenSequence.prototype.setPreviousValue=function(externalPreviousValue){this.previousValue=Math.max(externalPreviousValue,this.previousValue);return this.previousValue};ListenSequence.prototype.next=function(){var nextValue=++this.previousValue;if(this.writeNewSequenceNumber){this.writeNewSequenceNumber(nextValue)}return nextValue};ListenSequence.INVALID=-1;return ListenSequence}();var Deferred=function(){function Deferred(){var _this=this;this.promise=new Promise(function(resolve,reject){_this.resolve=resolve;_this.reject=reject})}return Deferred}();var TimerId;(function(TimerId){TimerId["All"]="all";TimerId["ListenStreamIdle"]="listen_stream_idle";TimerId["ListenStreamConnectionBackoff"]="listen_stream_connection_backoff";TimerId["WriteStreamIdle"]="write_stream_idle";TimerId["WriteStreamConnectionBackoff"]="write_stream_connection_backoff";TimerId["OnlineStateTimeout"]="online_state_timeout";TimerId["ClientMetadataRefresh"]="client_metadata_refresh";TimerId["LruGarbageCollection"]="lru_garbage_collection"})(TimerId||(TimerId={}));var DelayedOperation=function(){function DelayedOperation(asyncQueue,timerId,targetTimeMs,op,removalCallback){this.asyncQueue=asyncQueue;this.timerId=timerId;this.targetTimeMs=targetTimeMs;this.op=op;this.removalCallback=removalCallback;this.deferred=new Deferred;this.then=this.deferred.promise.then.bind(this.deferred.promise);this.catch=this.deferred.promise.catch.bind(this.deferred.promise);this.deferred.promise.catch(function(err){})}DelayedOperation.createAndSchedule=function(asyncQueue,timerId,delayMs,op,removalCallback){var targetTime=Date.now()+delayMs;var delayedOp=new DelayedOperation(asyncQueue,timerId,targetTime,op,removalCallback);delayedOp.start(delayMs);return delayedOp};DelayedOperation.prototype.start=function(delayMs){var _this=this;this.timerHandle=setTimeout(function(){return _this.handleDelayElapsed()},delayMs)};DelayedOperation.prototype.skipDelay=function(){return this.handleDelayElapsed()};DelayedOperation.prototype.cancel=function(reason){if(this.timerHandle!==null){this.clearTimeout();this.deferred.reject(new FirestoreError(Code.CANCELLED,"Operation cancelled"+(reason?": "+reason:"")))}};DelayedOperation.prototype.handleDelayElapsed=function(){var _this=this;this.asyncQueue.enqueueAndForget(function(){if(_this.timerHandle!==null){_this.clearTimeout();return _this.op().then(function(result){return _this.deferred.resolve(result)})}else{return Promise.resolve()}})};DelayedOperation.prototype.clearTimeout=function(){if(this.timerHandle!==null){this.removalCallback(this);clearTimeout(this.timerHandle);this.timerHandle=null}};return DelayedOperation}();var AsyncQueue=function(){function AsyncQueue(){this.tail=Promise.resolve();this.delayedOperations=[];this.operationInProgress=false}AsyncQueue.prototype.enqueueAndForget=function(op){this.enqueue(op)};AsyncQueue.prototype.enqueue=function(op){var _this=this;this.verifyNotFailed();var newTail=this.tail.then(function(){_this.operationInProgress=true;return op().catch(function(error$1){_this.failure=error$1;_this.operationInProgress=false;var message=error$1.stack||error$1.message||"";error("INTERNAL UNHANDLED ERROR: ",message);if(message.indexOf("Firestore Test Simulated Error")<0){setTimeout(function(){throw error$1},0)}throw error$1}).then(function(result){_this.operationInProgress=false;return result})});this.tail=newTail;return newTail};AsyncQueue.prototype.enqueueAfterDelay=function(timerId,delayMs,op){var _this=this;this.verifyNotFailed();assert(delayMs>=0,"Attempted to schedule an operation with a negative delay of "+delayMs);assert(!this.containsDelayedOperation(timerId),"Attempted to schedule multiple operations with timer id "+timerId+".");var delayedOp=DelayedOperation.createAndSchedule(this,timerId,delayMs,op,function(op){return _this.removeDelayedOperation(op)});this.delayedOperations.push(delayedOp);return delayedOp};AsyncQueue.prototype.verifyNotFailed=function(){if(this.failure){fail("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))}};AsyncQueue.prototype.verifyOperationInProgress=function(){assert(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")};AsyncQueue.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})};AsyncQueue.prototype.containsDelayedOperation=function(timerId){for(var _i=0,_a=this.delayedOperations;_i<_a.length;_i++){var op=_a[_i];if(op.timerId===timerId){return true}}return false};AsyncQueue.prototype.runDelayedOperationsEarly=function(lastTimerId){var _this=this;return this.drain().then(function(){assert(lastTimerId===TimerId.All||_this.containsDelayedOperation(lastTimerId),"Attempted to drain to missing operation "+lastTimerId);_this.delayedOperations.sort(function(a,b){return a.targetTimeMs-b.targetTimeMs});for(var _i=0,_a=_this.delayedOperations;_i<_a.length;_i++){var op=_a[_i];op.skipDelay();if(lastTimerId!==TimerId.All&&op.timerId===lastTimerId){break}}return _this.drain()})};AsyncQueue.prototype.removeDelayedOperation=function(op){var index=this.delayedOperations.indexOf(op);assert(index>=0,"Delayed operation not found.");this.delayedOperations.splice(index,1)};return AsyncQueue}();var escapeChar="";var encodedSeparatorChar="";var encodedNul="";var encodedEscape="";function encode(path){var result="";for(var i=0;i<path.length;i++){if(result.length>0){result=encodeSeparator(result)}result=encodeSegment(path.get(i),result)}return encodeSeparator(result)}function encodeSegment(segment,resultBuf){var result=resultBuf;var length=segment.length;for(var i=0;i<length;i++){var c=segment.charAt(i);switch(c){case"\0":result+=escapeChar+encodedNul;break;case escapeChar:result+=escapeChar+encodedEscape;break;default:result+=c}}return result}function encodeSeparator(result){return result+escapeChar+encodedSeparatorChar}function decode(path){var length=path.length;assert(length>=2,"Invalid path "+path);if(length===2){assert(path.charAt(0)===escapeChar&&path.charAt(1)===encodedSeparatorChar,"Non-empty path "+path+" had length 2");return ResourcePath.EMPTY_PATH}var lastReasonableEscapeIndex=length-2;var segments=[];var segmentBuilder="";for(var start=0;start<length;){var end=path.indexOf(escapeChar,start);if(end<0||end>lastReasonableEscapeIndex){fail('Invalid encoded resource path: "'+path+'"')}var next=path.charAt(end+1);switch(next){case encodedSeparatorChar:var currentPiece=path.substring(start,end);var segment=void 0;if(segmentBuilder.length===0){segment=currentPiece}else{segmentBuilder+=currentPiece;segment=segmentBuilder;segmentBuilder=""}segments.push(segment);break;case encodedNul:segmentBuilder+=path.substring(start,end);segmentBuilder+="\0";break;case encodedEscape:segmentBuilder+=path.substring(start,end+1);break;default:fail('Invalid encoded resource path: "'+path+'"')}start=end+2}return new ResourcePath(segments)}var BATCHID_UNKNOWN=-1;var MutationBatch=function(){function MutationBatch(batchId,localWriteTime,baseMutations,mutations){this.batchId=batchId;this.localWriteTime=localWriteTime;this.baseMutations=baseMutations;this.mutations=mutations;assert(mutations.length>0,"Cannot create an empty mutation batch")}MutationBatch.prototype.applyToRemoteDocument=function(docKey,maybeDoc,batchResult){if(maybeDoc){assert(maybeDoc.key.isEqual(docKey),"applyToRemoteDocument: key "+docKey+" should match maybeDoc key\n        "+maybeDoc.key)}var mutationResults=batchResult.mutationResults;assert(mutationResults.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+mutationResults.length+").");for(var i=0;i<this.mutations.length;i++){var mutation=this.mutations[i];if(mutation.key.isEqual(docKey)){var mutationResult=mutationResults[i];maybeDoc=mutation.applyToRemoteDocument(maybeDoc,mutationResult)}}return maybeDoc};MutationBatch.prototype.applyToLocalView=function(docKey,maybeDoc){if(maybeDoc){assert(maybeDoc.key.isEqual(docKey),"applyToLocalDocument: key "+docKey+" should match maybeDoc key\n        "+maybeDoc.key)}for(var _i=0,_a=this.baseMutations;_i<_a.length;_i++){var mutation=_a[_i];if(mutation.key.isEqual(docKey)){maybeDoc=mutation.applyToLocalView(maybeDoc,maybeDoc,this.localWriteTime)}}var baseDoc=maybeDoc;for(var _b=0,_c=this.mutations;_b<_c.length;_b++){var mutation=_c[_b];if(mutation.key.isEqual(docKey)){maybeDoc=mutation.applyToLocalView(maybeDoc,baseDoc,this.localWriteTime)}}return maybeDoc};MutationBatch.prototype.applyToLocalDocumentSet=function(maybeDocs){var _this=this;var mutatedDocuments=maybeDocs;this.mutations.forEach(function(m){var mutatedDocument=_this.applyToLocalView(m.key,maybeDocs.get(m.key));if(mutatedDocument){mutatedDocuments=mutatedDocuments.insert(m.key,mutatedDocument)}});return mutatedDocuments};MutationBatch.prototype.keys=function(){return this.mutations.reduce(function(keys,m){return keys.add(m.key)},documentKeySet())};MutationBatch.prototype.isEqual=function(other){return this.batchId===other.batchId&&arrayEquals(this.mutations,other.mutations)&&arrayEquals(this.baseMutations,other.baseMutations)};return MutationBatch}();var MutationBatchResult=function(){function MutationBatchResult(batch,commitVersion,mutationResults,streamToken,docVersions){this.batch=batch;this.commitVersion=commitVersion;this.mutationResults=mutationResults;this.streamToken=streamToken;this.docVersions=docVersions}MutationBatchResult.from=function(batch,commitVersion,results,streamToken){assert(batch.mutations.length===results.length,"Mutations sent "+batch.mutations.length+" must equal results received "+results.length);var versionMap=documentVersionMap();var mutations=batch.mutations;for(var i=0;i<mutations.length;i++){versionMap=versionMap.insert(mutations[i].key,results[i].version)}return new MutationBatchResult(batch,commitVersion,results,streamToken,versionMap)};return MutationBatchResult}();var PersistencePromise=function(){function PersistencePromise(callback){var _this=this;this.nextCallback=null;this.catchCallback=null;this.result=undefined;this.error=undefined;this.isDone=false;this.callbackAttached=false;callback(function(value){_this.isDone=true;_this.result=value;if(_this.nextCallback){_this.nextCallback(value)}},function(error){_this.isDone=true;_this.error=error;if(_this.catchCallback){_this.catchCallback(error)}})}PersistencePromise.prototype.catch=function(fn){return this.next(undefined,fn)};PersistencePromise.prototype.next=function(nextFn,catchFn){var _this=this;if(this.callbackAttached){fail("Called next() or catch() twice for PersistencePromise")}this.callbackAttached=true;if(this.isDone){if(!this.error){return this.wrapSuccess(nextFn,this.result)}else{return this.wrapFailure(catchFn,this.error)}}else{return new PersistencePromise(function(resolve,reject){_this.nextCallback=function(value){_this.wrapSuccess(nextFn,value).next(resolve,reject)};_this.catchCallback=function(error){_this.wrapFailure(catchFn,error).next(resolve,reject)}})}};PersistencePromise.prototype.toPromise=function(){var _this=this;return new Promise(function(resolve,reject){_this.next(resolve,reject)})};PersistencePromise.prototype.wrapUserFunction=function(fn){try{var result=fn();if(result instanceof PersistencePromise){return result}else{return PersistencePromise.resolve(result)}}catch(e){return PersistencePromise.reject(e)}};PersistencePromise.prototype.wrapSuccess=function(nextFn,value){if(nextFn){return this.wrapUserFunction(function(){return nextFn(value)})}else{return PersistencePromise.resolve(value)}};PersistencePromise.prototype.wrapFailure=function(catchFn,error){if(catchFn){return this.wrapUserFunction(function(){return catchFn(error)})}else{return PersistencePromise.reject(error)}};PersistencePromise.resolve=function(result){return new PersistencePromise(function(resolve,reject){resolve(result)})};PersistencePromise.reject=function(error){return new PersistencePromise(function(resolve,reject){reject(error)})};PersistencePromise.waitFor=function(all){return new PersistencePromise(function(resolve,reject){var expectedCount=0;var resolvedCount=0;var done=false;all.forEach(function(element){++expectedCount;element.next(function(){++resolvedCount;if(done&&resolvedCount===expectedCount){resolve()}},function(err){return reject(err)})});done=true;if(resolvedCount===expectedCount){resolve()}})};PersistencePromise.or=function(predicates){var p=PersistencePromise.resolve(false);var _loop_1=function(predicate){p=p.next(function(isTrue){if(isTrue){return PersistencePromise.resolve(isTrue)}else{return predicate()}})};for(var _i=0,predicates_1=predicates;_i<predicates_1.length;_i++){var predicate=predicates_1[_i];_loop_1(predicate)}return p};PersistencePromise.forEach=function(collection,f){var _this=this;var promises=[];collection.forEach(function(r,s){promises.push(f.call(_this,r,s))});return this.waitFor(promises)};return PersistencePromise}();var IndexedDbMutationQueue=function(){function IndexedDbMutationQueue(userId,serializer,indexManager,referenceDelegate){this.userId=userId;this.serializer=serializer;this.indexManager=indexManager;this.referenceDelegate=referenceDelegate;this.documentKeysByBatchId={}}IndexedDbMutationQueue.forUser=function(user,serializer,indexManager,referenceDelegate){assert(user.uid!=="","UserID must not be an empty string.");var userId=user.isAuthenticated()?user.uid:"";return new IndexedDbMutationQueue(userId,serializer,indexManager,referenceDelegate)};IndexedDbMutationQueue.prototype.checkEmpty=function(transaction){var empty=true;var range=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(transaction).iterate({index:DbMutationBatch.userMutationsIndex,range:range},function(key,value,control){empty=false;control.done()}).next(function(){return empty})};IndexedDbMutationQueue.prototype.acknowledgeBatch=function(transaction,batch,streamToken){return this.getMutationQueueMetadata(transaction).next(function(metadata){metadata.lastStreamToken=convertStreamToken(streamToken);return mutationQueuesStore(transaction).put(metadata)})};IndexedDbMutationQueue.prototype.getLastStreamToken=function(transaction){return this.getMutationQueueMetadata(transaction).next(function(metadata){return metadata.lastStreamToken})};IndexedDbMutationQueue.prototype.setLastStreamToken=function(transaction,streamToken){return this.getMutationQueueMetadata(transaction).next(function(metadata){metadata.lastStreamToken=convertStreamToken(streamToken);return mutationQueuesStore(transaction).put(metadata)})};IndexedDbMutationQueue.prototype.addMutationBatch=function(transaction,localWriteTime,baseMutations,mutations){var _this=this;var documentStore=documentMutationsStore(transaction);var mutationStore=mutationsStore(transaction);return mutationStore.add({}).next(function(batchId){assert(typeof batchId==="number","Auto-generated key is not a number");var batch=new MutationBatch(batchId,localWriteTime,baseMutations,mutations);var dbBatch=_this.serializer.toDbMutationBatch(_this.userId,batch);_this.documentKeysByBatchId[batchId]=batch.keys();var promises=[];for(var _i=0,mutations_1=mutations;_i<mutations_1.length;_i++){var mutation=mutations_1[_i];var indexKey=DbDocumentMutation.key(_this.userId,mutation.key.path,batchId);promises.push(mutationStore.put(dbBatch));promises.push(documentStore.put(indexKey,DbDocumentMutation.PLACEHOLDER));promises.push(_this.indexManager.addToCollectionParentIndex(transaction,mutation.key.path.popLast()))}return PersistencePromise.waitFor(promises).next(function(){return batch})})};IndexedDbMutationQueue.prototype.lookupMutationBatch=function(transaction,batchId){var _this=this;return mutationsStore(transaction).get(batchId).next(function(dbBatch){if(dbBatch){assert(dbBatch.userId===_this.userId,"Unexpected user '"+dbBatch.userId+"' for mutation batch "+batchId);return _this.serializer.fromDbMutationBatch(dbBatch)}return null})};IndexedDbMutationQueue.prototype.lookupMutationKeys=function(transaction,batchId){var _this=this;if(this.documentKeysByBatchId[batchId]){return PersistencePromise.resolve(this.documentKeysByBatchId[batchId])}else{return this.lookupMutationBatch(transaction,batchId).next(function(batch){if(batch){var keys=batch.keys();_this.documentKeysByBatchId[batchId]=keys;return keys}else{return null}})}};IndexedDbMutationQueue.prototype.getNextMutationBatchAfterBatchId=function(transaction,batchId){var _this=this;return this.getMutationQueueMetadata(transaction).next(function(metadata){var nextBatchId=batchId+1;var range=IDBKeyRange.lowerBound([_this.userId,nextBatchId]);var foundBatch=null;return mutationsStore(transaction).iterate({index:DbMutationBatch.userMutationsIndex,range:range},function(key,dbBatch,control){if(dbBatch.userId===_this.userId){assert(dbBatch.batchId>=nextBatchId,"Should have found mutation after "+nextBatchId);foundBatch=_this.serializer.fromDbMutationBatch(dbBatch)}control.done()}).next(function(){return foundBatch})})};IndexedDbMutationQueue.prototype.getAllMutationBatches=function(transaction){var _this=this;var range=IDBKeyRange.bound([this.userId,BATCHID_UNKNOWN],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(transaction).loadAll(DbMutationBatch.userMutationsIndex,range).next(function(dbBatches){return dbBatches.map(function(dbBatch){return _this.serializer.fromDbMutationBatch(dbBatch)})})};IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(transaction,documentKey){var _this=this;var indexPrefix=DbDocumentMutation.prefixForPath(this.userId,documentKey.path);var indexStart=IDBKeyRange.lowerBound(indexPrefix);var results=[];return documentMutationsStore(transaction).iterate({range:indexStart},function(indexKey,_,control){var userID=indexKey[0],encodedPath=indexKey[1],batchId=indexKey[2];var path=decode(encodedPath);if(userID!==_this.userId||!documentKey.path.isEqual(path)){control.done();return}return mutationsStore(transaction).get(batchId).next(function(mutation){if(!mutation){throw fail("Dangling document-mutation reference found: "+indexKey+" which points to "+batchId)}assert(mutation.userId===_this.userId,"Unexpected user '"+mutation.userId+"' for mutation batch "+batchId);results.push(_this.serializer.fromDbMutationBatch(mutation))})}).next(function(){return results})};IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(transaction,documentKeys){var _this=this;var uniqueBatchIDs=new SortedSet(primitiveComparator);var promises=[];documentKeys.forEach(function(documentKey){var indexStart=DbDocumentMutation.prefixForPath(_this.userId,documentKey.path);var range=IDBKeyRange.lowerBound(indexStart);var promise=documentMutationsStore(transaction).iterate({range:range},function(indexKey,_,control){var userID=indexKey[0],encodedPath=indexKey[1],batchID=indexKey[2];var path=decode(encodedPath);if(userID!==_this.userId||!documentKey.path.isEqual(path)){control.done();return}uniqueBatchIDs=uniqueBatchIDs.add(batchID)});promises.push(promise)});return PersistencePromise.waitFor(promises).next(function(){return _this.lookupMutationBatches(transaction,uniqueBatchIDs)})};IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(transaction,query){var _this=this;assert(!query.isDocumentQuery(),"Document queries shouldn't go down this path");assert(!query.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var queryPath=query.path;var immediateChildrenLength=queryPath.length+1;var indexPrefix=DbDocumentMutation.prefixForPath(this.userId,queryPath);var indexStart=IDBKeyRange.lowerBound(indexPrefix);var uniqueBatchIDs=new SortedSet(primitiveComparator);return documentMutationsStore(transaction).iterate({range:indexStart},function(indexKey,_,control){var userID=indexKey[0],encodedPath=indexKey[1],batchID=indexKey[2];var path=decode(encodedPath);if(userID!==_this.userId||!queryPath.isPrefixOf(path)){control.done();return}if(path.length!==immediateChildrenLength){return}uniqueBatchIDs=uniqueBatchIDs.add(batchID)}).next(function(){return _this.lookupMutationBatches(transaction,uniqueBatchIDs)})};IndexedDbMutationQueue.prototype.lookupMutationBatches=function(transaction,batchIDs){var _this=this;var results=[];var promises=[];batchIDs.forEach(function(batchId){promises.push(mutationsStore(transaction).get(batchId).next(function(mutation){if(mutation===null){throw fail("Dangling document-mutation reference found, "+"which points to "+batchId)}assert(mutation.userId===_this.userId,"Unexpected user '"+mutation.userId+"' for mutation batch "+batchId);results.push(_this.serializer.fromDbMutationBatch(mutation))}))});return PersistencePromise.waitFor(promises).next(function(){return results})};IndexedDbMutationQueue.prototype.removeMutationBatch=function(transaction,batch){var _this=this;return removeMutationBatch(transaction.simpleDbTransaction,this.userId,batch).next(function(removedDocuments){_this.removeCachedMutationKeys(batch.batchId);return PersistencePromise.forEach(removedDocuments,function(key){return _this.referenceDelegate.removeMutationReference(transaction,key)})})};IndexedDbMutationQueue.prototype.removeCachedMutationKeys=function(batchId){delete this.documentKeysByBatchId[batchId]};IndexedDbMutationQueue.prototype.performConsistencyCheck=function(txn){var _this=this;return this.checkEmpty(txn).next(function(empty){if(!empty){return PersistencePromise.resolve()}var startRange=IDBKeyRange.lowerBound(DbDocumentMutation.prefixForUser(_this.userId));var danglingMutationReferences=[];return documentMutationsStore(txn).iterate({range:startRange},function(key,_,control){var userID=key[0];if(userID!==_this.userId){control.done();return}else{var path=decode(key[1]);danglingMutationReferences.push(path)}}).next(function(){assert(danglingMutationReferences.length===0,"Document leak -- detected dangling mutation references when queue is empty. "+"Dangling keys: "+danglingMutationReferences.map(function(p){return p.canonicalString()}))})})};IndexedDbMutationQueue.prototype.containsKey=function(txn,key){return mutationQueueContainsKey(txn,this.userId,key)};IndexedDbMutationQueue.prototype.getMutationQueueMetadata=function(transaction){var _this=this;return mutationQueuesStore(transaction).get(this.userId).next(function(metadata){return metadata||new DbMutationQueue(_this.userId,BATCHID_UNKNOWN,"")})};return IndexedDbMutationQueue}();function mutationQueueContainsKey(txn,userId,key){var indexKey=DbDocumentMutation.prefixForPath(userId,key.path);var encodedPath=indexKey[1];var startRange=IDBKeyRange.lowerBound(indexKey);var containsKey=false;return documentMutationsStore(txn).iterate({range:startRange,keysOnly:true},function(key,value,control){var userID=key[0],keyPath=key[1],_=key[2];if(userID===userId&&keyPath===encodedPath){containsKey=true}control.done()}).next(function(){return containsKey})}function mutationQueuesContainKey(txn,docKey){var found=false;return mutationQueuesStore(txn).iterateSerial(function(userId){return mutationQueueContainsKey(txn,userId,docKey).next(function(containsKey){if(containsKey){found=true}return PersistencePromise.resolve(!containsKey)})}).next(function(){return found})}function removeMutationBatch(txn,userId,batch){var mutationStore=txn.store(DbMutationBatch.store);var indexTxn=txn.store(DbDocumentMutation.store);var promises=[];var range=IDBKeyRange.only(batch.batchId);var numDeleted=0;var removePromise=mutationStore.iterate({range:range},function(key,value,control){numDeleted++;return control.delete()});promises.push(removePromise.next(function(){assert(numDeleted===1,"Dangling document-mutation reference found: Missing batch "+batch.batchId)}));var removedDocuments=[];for(var _i=0,_a=batch.mutations;_i<_a.length;_i++){var mutation=_a[_i];var indexKey=DbDocumentMutation.key(userId,mutation.key.path,batch.batchId);promises.push(indexTxn.delete(indexKey));removedDocuments.push(mutation.key)}return PersistencePromise.waitFor(promises).next(function(){return removedDocuments})}function convertStreamToken(token){if(token instanceof Uint8Array){assert(process.env.USE_MOCK_PERSISTENCE==="YES","Persisting non-string stream tokens is only supported with mock persistence.");return token.toString()}else{return token}}function mutationsStore(txn){return IndexedDbPersistence.getStore(txn,DbMutationBatch.store)}function documentMutationsStore(txn){return IndexedDbPersistence.getStore(txn,DbDocumentMutation.store)}function mutationQueuesStore(txn){return IndexedDbPersistence.getStore(txn,DbMutationQueue.store)}var RESERVED_BITS=1;var GeneratorIds;(function(GeneratorIds){GeneratorIds[GeneratorIds["QueryCache"]=0]="QueryCache";GeneratorIds[GeneratorIds["SyncEngine"]=1]="SyncEngine"})(GeneratorIds||(GeneratorIds={}));var TargetIdGenerator=function(){function TargetIdGenerator(generatorId,seed){this.generatorId=generatorId;assert((generatorId&RESERVED_BITS)===generatorId,"Generator ID "+generatorId+" contains more than "+RESERVED_BITS+" reserved bits");this.seek(seed!==undefined?seed:this.generatorId)}TargetIdGenerator.prototype.next=function(){var nextId=this.nextId;this.nextId+=1<<RESERVED_BITS;return nextId};TargetIdGenerator.prototype.after=function(targetId){this.seek(targetId+(1<<RESERVED_BITS));return this.next()};TargetIdGenerator.prototype.seek=function(targetId){assert((targetId&RESERVED_BITS)===this.generatorId,"Cannot supply target ID from different generator ID");this.nextId=targetId};TargetIdGenerator.forQueryCache=function(){var targetIdGenerator=new TargetIdGenerator(GeneratorIds.QueryCache,2);return targetIdGenerator};TargetIdGenerator.forSyncEngine=function(){return new TargetIdGenerator(GeneratorIds.SyncEngine)};return TargetIdGenerator}();var LOG_TAG$1="SimpleDb";var SimpleDb=function(){function SimpleDb(db){this.db=db}SimpleDb.openOrCreate=function(name,version,schemaConverter){assert(SimpleDb.isAvailable(),"IndexedDB not supported in current environment.");debug(LOG_TAG$1,"Opening database:",name);return new PersistencePromise(function(resolve,reject){var request=window.indexedDB.open(name,version);request.onsuccess=function(event){var db=event.target.result;resolve(new SimpleDb(db))};request.onblocked=function(){reject(new FirestoreError(Code.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. "+"Close all tabs that access Firestore and reload this page to proceed."))};request.onerror=function(event){var error=event.target.error;if(error.name==="VersionError"){reject(new FirestoreError(Code.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted "+"data is not compatible with the version of the SDK you are now using. The SDK "+"will operate with persistence disabled. If you need persistence, please "+"re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB "+"data for your app to start fresh."))}else{reject(error)}};request.onupgradeneeded=function(event){debug(LOG_TAG$1,'Database "'+name+'" requires upgrade from version:',event.oldVersion);var db=event.target.result;var txn=new SimpleDbTransaction(request.transaction);schemaConverter.createOrUpgrade(db,txn,event.oldVersion,SCHEMA_VERSION).next(function(){debug(LOG_TAG$1,"Database upgrade to version "+SCHEMA_VERSION+" complete")})}}).toPromise()};SimpleDb.delete=function(name){debug(LOG_TAG$1,"Removing database:",name);return wrapRequest(window.indexedDB.deleteDatabase(name)).toPromise()};SimpleDb.isAvailable=function(){if(typeof window==="undefined"||window.indexedDB==null){return false}if(window.navigator===undefined){return process.env.USE_MOCK_PERSISTENCE==="YES"}var ua=window.navigator.userAgent;if(ua.indexOf("MSIE ")>0||ua.indexOf("Trident/")>0||ua.indexOf("Edge/")>0){return false}else{return true}};SimpleDb.getStore=function(txn,store){return txn.store(store)};SimpleDb.prototype.runTransaction=function(mode,objectStores,transactionFn){var transaction=SimpleDbTransaction.open(this.db,mode,objectStores);var transactionFnResult=transactionFn(transaction).catch(function(error){transaction.abort(error);return PersistencePromise.reject(error)}).toPromise();transactionFnResult.catch(function(){});return transaction.completionPromise.then(function(){return transactionFnResult})};SimpleDb.prototype.close=function(){this.db.close()};return SimpleDb}();var IterationController=function(){function IterationController(dbCursor){this.dbCursor=dbCursor;this.shouldStop=false;this.nextKey=null}Object.defineProperty(IterationController.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:true,configurable:true});Object.defineProperty(IterationController.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:true,configurable:true});Object.defineProperty(IterationController.prototype,"cursor",{set:function(value){this.dbCursor=value},enumerable:true,configurable:true});IterationController.prototype.done=function(){this.shouldStop=true};IterationController.prototype.skip=function(key){this.nextKey=key};IterationController.prototype.delete=function(){return wrapRequest(this.dbCursor.delete())};return IterationController}();var SimpleDbTransaction=function(){function SimpleDbTransaction(transaction){var _this=this;this.transaction=transaction;this.aborted=false;this.completionDeferred=new Deferred;this.transaction.oncomplete=function(){_this.completionDeferred.resolve()};this.transaction.onabort=function(){if(transaction.error){_this.completionDeferred.reject(transaction.error)}else{_this.completionDeferred.resolve()}};this.transaction.onerror=function(event){_this.completionDeferred.reject(event.target.error)}}SimpleDbTransaction.open=function(db,mode,objectStoreNames){return new SimpleDbTransaction(db.transaction(objectStoreNames,mode))};Object.defineProperty(SimpleDbTransaction.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:true,configurable:true});SimpleDbTransaction.prototype.abort=function(error){if(error){this.completionDeferred.reject(error)}if(!this.aborted){debug(LOG_TAG$1,"Aborting transaction:",error?error.message:"Client-initiated abort");this.aborted=true;this.transaction.abort()}};SimpleDbTransaction.prototype.store=function(storeName){var store=this.transaction.objectStore(storeName);assert(!!store,"Object store not part of transaction: "+storeName);return new SimpleDbStore(store)};return SimpleDbTransaction}();var SimpleDbStore=function(){function SimpleDbStore(store){this.store=store}SimpleDbStore.prototype.put=function(keyOrValue,value){var request;if(value!==undefined){debug(LOG_TAG$1,"PUT",this.store.name,keyOrValue,value);request=this.store.put(value,keyOrValue)}else{debug(LOG_TAG$1,"PUT",this.store.name,"<auto-key>",keyOrValue);request=this.store.put(keyOrValue)}return wrapRequest(request)};SimpleDbStore.prototype.add=function(value){debug(LOG_TAG$1,"ADD",this.store.name,value,value);var request=this.store.add(value);return wrapRequest(request)};SimpleDbStore.prototype.get=function(key){var _this=this;var request=this.store.get(key);return wrapRequest(request).next(function(result){if(result===undefined){result=null}debug(LOG_TAG$1,"GET",_this.store.name,key,result);return result})};SimpleDbStore.prototype.delete=function(key){debug(LOG_TAG$1,"DELETE",this.store.name,key);var request=this.store.delete(key);return wrapRequest(request)};SimpleDbStore.prototype.count=function(){debug(LOG_TAG$1,"COUNT",this.store.name);var request=this.store.count();return wrapRequest(request)};SimpleDbStore.prototype.loadAll=function(indexOrRange,range){var cursor=this.cursor(this.options(indexOrRange,range));var results=[];return this.iterateCursor(cursor,function(key,value){results.push(value)}).next(function(){return results})};SimpleDbStore.prototype.deleteAll=function(indexOrRange,range){debug(LOG_TAG$1,"DELETE ALL",this.store.name);var options=this.options(indexOrRange,range);options.keysOnly=false;var cursor=this.cursor(options);return this.iterateCursor(cursor,function(key,value,control){return control.delete()})};SimpleDbStore.prototype.iterate=function(optionsOrCallback,callback){var options;if(!callback){options={};callback=optionsOrCallback}else{options=optionsOrCallback}var cursor=this.cursor(options);return this.iterateCursor(cursor,callback)};SimpleDbStore.prototype.iterateSerial=function(callback){var cursorRequest=this.cursor({});return new PersistencePromise(function(resolve,reject){cursorRequest.onerror=function(event){reject(event.target.error)};cursorRequest.onsuccess=function(event){var cursor=event.target.result;if(!cursor){resolve();return}callback(cursor.primaryKey,cursor.value).next(function(shouldContinue){if(shouldContinue){cursor.continue()}else{resolve()}})}})};SimpleDbStore.prototype.iterateCursor=function(cursorRequest,fn){var results=[];return new PersistencePromise(function(resolve,reject){cursorRequest.onerror=function(event){reject(event.target.error)};cursorRequest.onsuccess=function(event){var cursor=event.target.result;if(!cursor){resolve();return}var controller=new IterationController(cursor);var userResult=fn(cursor.primaryKey,cursor.value,controller);if(userResult instanceof PersistencePromise){var userPromise=userResult.catch(function(err){controller.done();return PersistencePromise.reject(err)});results.push(userPromise)}if(controller.isDone){resolve()}else if(controller.skipToKey===null){cursor.continue()}else{cursor.continue(controller.skipToKey)}}}).next(function(){return PersistencePromise.waitFor(results)})};SimpleDbStore.prototype.options=function(indexOrRange,range){var indexName=undefined;if(indexOrRange!==undefined){if(typeof indexOrRange==="string"){indexName=indexOrRange}else{assert(range===undefined,"3rd argument must not be defined if 2nd is a range.");range=indexOrRange}}return{index:indexName,range:range}};SimpleDbStore.prototype.cursor=function(options){var direction="next";if(options.reverse){direction="prev"}if(options.index){var index=this.store.index(options.index);if(options.keysOnly){return index.openKeyCursor(options.range,direction)}else{return index.openCursor(options.range,direction)}}else{return this.store.openCursor(options.range,direction)}};return SimpleDbStore}();function wrapRequest(request){return new PersistencePromise(function(resolve,reject){request.onsuccess=function(event){var result=event.target.result;resolve(result)};request.onerror=function(event){reject(event.target.error)}})}var IndexedDbQueryCache=function(){function IndexedDbQueryCache(referenceDelegate,serializer){this.referenceDelegate=referenceDelegate;this.serializer=serializer;this.targetIdGenerator=TargetIdGenerator.forQueryCache()}IndexedDbQueryCache.prototype.allocateTargetId=function(transaction){var _this=this;return this.retrieveMetadata(transaction).next(function(metadata){metadata.highestTargetId=_this.targetIdGenerator.after(metadata.highestTargetId);return _this.saveMetadata(transaction,metadata).next(function(){return metadata.highestTargetId})})};IndexedDbQueryCache.prototype.getLastRemoteSnapshotVersion=function(transaction){return this.retrieveMetadata(transaction).next(function(metadata){return SnapshotVersion.fromTimestamp(new Timestamp(metadata.lastRemoteSnapshotVersion.seconds,metadata.lastRemoteSnapshotVersion.nanoseconds))})};IndexedDbQueryCache.prototype.getHighestSequenceNumber=function(transaction){return getHighestListenSequenceNumber(transaction.simpleDbTransaction)};IndexedDbQueryCache.prototype.setTargetsMetadata=function(transaction,highestListenSequenceNumber,lastRemoteSnapshotVersion){var _this=this;return this.retrieveMetadata(transaction).next(function(metadata){metadata.highestListenSequenceNumber=highestListenSequenceNumber;if(lastRemoteSnapshotVersion){metadata.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion.toTimestamp()}if(highestListenSequenceNumber>metadata.highestListenSequenceNumber){metadata.highestListenSequenceNumber=highestListenSequenceNumber}return _this.saveMetadata(transaction,metadata)})};IndexedDbQueryCache.prototype.addQueryData=function(transaction,queryData){var _this=this;return this.saveQueryData(transaction,queryData).next(function(){return _this.retrieveMetadata(transaction).next(function(metadata){metadata.targetCount+=1;_this.updateMetadataFromQueryData(queryData,metadata);return _this.saveMetadata(transaction,metadata)})})};IndexedDbQueryCache.prototype.updateQueryData=function(transaction,queryData){return this.saveQueryData(transaction,queryData)};IndexedDbQueryCache.prototype.removeQueryData=function(transaction,queryData){var _this=this;return this.removeMatchingKeysForTargetId(transaction,queryData.targetId).next(function(){return targetsStore(transaction).delete(queryData.targetId)}).next(function(){return _this.retrieveMetadata(transaction)}).next(function(metadata){assert(metadata.targetCount>0,"Removing from an empty query cache");metadata.targetCount-=1;return _this.saveMetadata(transaction,metadata)})};IndexedDbQueryCache.prototype.removeTargets=function(txn,upperBound,activeTargetIds){var _this=this;var count=0;var promises=[];return targetsStore(txn).iterate(function(key,value){var queryData=_this.serializer.fromDbTarget(value);if(queryData.sequenceNumber<=upperBound&&activeTargetIds[queryData.targetId]===undefined){count++;promises.push(_this.removeQueryData(txn,queryData))}}).next(function(){return PersistencePromise.waitFor(promises)}).next(function(){return count})};IndexedDbQueryCache.prototype.forEachTarget=function(txn,f){var _this=this;return targetsStore(txn).iterate(function(key,value){var queryData=_this.serializer.fromDbTarget(value);f(queryData)})};IndexedDbQueryCache.prototype.retrieveMetadata=function(transaction){return retrieveMetadata(transaction.simpleDbTransaction)};IndexedDbQueryCache.prototype.saveMetadata=function(transaction,metadata){return globalTargetStore(transaction).put(DbTargetGlobal.key,metadata)};IndexedDbQueryCache.prototype.saveQueryData=function(transaction,queryData){return targetsStore(transaction).put(this.serializer.toDbTarget(queryData))};IndexedDbQueryCache.prototype.updateMetadataFromQueryData=function(queryData,metadata){var updated=false;if(queryData.targetId>metadata.highestTargetId){metadata.highestTargetId=queryData.targetId;updated=true}if(queryData.sequenceNumber>metadata.highestListenSequenceNumber){metadata.highestListenSequenceNumber=queryData.sequenceNumber;updated=true}return updated};IndexedDbQueryCache.prototype.getQueryCount=function(transaction){return this.retrieveMetadata(transaction).next(function(metadata){return metadata.targetCount})};IndexedDbQueryCache.prototype.getQueryData=function(transaction,query){var _this=this;var canonicalId=query.canonicalId();var range=IDBKeyRange.bound([canonicalId,Number.NEGATIVE_INFINITY],[canonicalId,Number.POSITIVE_INFINITY]);var result=null;return targetsStore(transaction).iterate({range:range,index:DbTarget.queryTargetsIndexName},function(key,value,control){var found=_this.serializer.fromDbTarget(value);if(query.isEqual(found.query)){result=found;control.done()}}).next(function(){return result})};IndexedDbQueryCache.prototype.addMatchingKeys=function(txn,keys,targetId){var _this=this;var promises=[];var store=documentTargetStore(txn);keys.forEach(function(key){var path=encode(key.path);promises.push(store.put(new DbTargetDocument(targetId,path)));promises.push(_this.referenceDelegate.addReference(txn,key))});return PersistencePromise.waitFor(promises)};IndexedDbQueryCache.prototype.removeMatchingKeys=function(txn,keys,targetId){var _this=this;var store=documentTargetStore(txn);return PersistencePromise.forEach(keys,function(key){var path=encode(key.path);return PersistencePromise.waitFor([store.delete([targetId,path]),_this.referenceDelegate.removeReference(txn,key)])})};IndexedDbQueryCache.prototype.removeMatchingKeysForTargetId=function(txn,targetId){var store=documentTargetStore(txn);var range=IDBKeyRange.bound([targetId],[targetId+1],false,true);return store.delete(range)};IndexedDbQueryCache.prototype.getMatchingKeysForTargetId=function(txn,targetId){var range=IDBKeyRange.bound([targetId],[targetId+1],false,true);var store=documentTargetStore(txn);var result=documentKeySet();return store.iterate({range:range,keysOnly:true},function(key,_,control){var path=decode(key[1]);var docKey=new DocumentKey(path);result=result.add(docKey)}).next(function(){return result})};IndexedDbQueryCache.prototype.containsKey=function(txn,key){var path=encode(key.path);var range=IDBKeyRange.bound([path],[immediateSuccessor(path)],false,true);var count=0;return documentTargetStore(txn).iterate({index:DbTargetDocument.documentTargetsIndex,keysOnly:true,range:range},function(_a,_,control){var targetId=_a[0],path=_a[1];if(targetId!==0){count++;control.done()}}).next(function(){return count>0})};IndexedDbQueryCache.prototype.getQueryDataForTarget=function(transaction,targetId){var _this=this;return targetsStore(transaction).get(targetId).next(function(found){if(found){return _this.serializer.fromDbTarget(found)}else{return null}})};return IndexedDbQueryCache}();function targetsStore(txn){return IndexedDbPersistence.getStore(txn,DbTarget.store)}function globalTargetStore(txn){return IndexedDbPersistence.getStore(txn,DbTargetGlobal.store)}function retrieveMetadata(txn){var globalStore=SimpleDb.getStore(txn,DbTargetGlobal.store);return globalStore.get(DbTargetGlobal.key).next(function(metadata){assert(metadata!==null,"Missing metadata row.");return metadata})}function getHighestListenSequenceNumber(txn){return retrieveMetadata(txn).next(function(targetGlobal){return targetGlobal.highestListenSequenceNumber})}function documentTargetStore(txn){return IndexedDbPersistence.getStore(txn,DbTargetDocument.store)}var ObjectMap=function(){function ObjectMap(mapKeyFn){this.mapKeyFn=mapKeyFn;this.inner={}}ObjectMap.prototype.get=function(key){var id=this.mapKeyFn(key);var matches=this.inner[id];if(matches===undefined){return undefined}for(var _i=0,matches_1=matches;_i<matches_1.length;_i++){var _a=matches_1[_i],otherKey=_a[0],value=_a[1];if(otherKey.isEqual(key)){return value}}return undefined};ObjectMap.prototype.has=function(key){return this.get(key)!==undefined};ObjectMap.prototype.set=function(key,value){var id=this.mapKeyFn(key);var matches=this.inner[id];if(matches===undefined){this.inner[id]=[[key,value]];return}for(var i=0;i<matches.length;i++){if(matches[i][0].isEqual(key)){matches[i]=[key,value];return}}matches.push([key,value])};ObjectMap.prototype.delete=function(key){var id=this.mapKeyFn(key);var matches=this.inner[id];if(matches===undefined){return false}for(var i=0;i<matches.length;i++){if(matches[i][0].isEqual(key)){if(matches.length===1){delete this.inner[id]}else{matches.splice(i,1)}return true}}return false};ObjectMap.prototype.forEach=function(fn){forEach(this.inner,function(_,entries){for(var _i=0,entries_1=entries;_i<entries_1.length;_i++){var _a=entries_1[_i],k=_a[0],v=_a[1];fn(k,v)}})};ObjectMap.prototype.isEmpty=function(){return isEmpty(this.inner)};return ObjectMap}();var RemoteDocumentChangeBuffer=function(){function RemoteDocumentChangeBuffer(){this.changes=maybeDocumentMap();this.documentSizes=new ObjectMap(function(key){return key.toString()})}RemoteDocumentChangeBuffer.prototype.addEntry=function(maybeDocument){var changes=this.assertChanges();this.changes=changes.insert(maybeDocument.key,maybeDocument)};RemoteDocumentChangeBuffer.prototype.getEntry=function(transaction,documentKey){var _this=this;var changes=this.assertChanges();var bufferedEntry=changes.get(documentKey);if(bufferedEntry){return PersistencePromise.resolve(bufferedEntry)}else{return this.getFromCache(transaction,documentKey).next(function(getResult){if(getResult===null){_this.documentSizes.set(documentKey,0);return null}else{_this.documentSizes.set(documentKey,getResult.size);return getResult.maybeDocument}})}};RemoteDocumentChangeBuffer.prototype.getEntries=function(transaction,documentKeys){var _this=this;return this.getAllFromCache(transaction,documentKeys).next(function(_a){var maybeDocuments=_a.maybeDocuments,sizeMap=_a.sizeMap;sizeMap.forEach(function(documentKey,size){_this.documentSizes.set(documentKey,size)});return maybeDocuments})};RemoteDocumentChangeBuffer.prototype.apply=function(transaction){var result=this.applyChanges(transaction);this.changes=null;return result};RemoteDocumentChangeBuffer.prototype.assertChanges=function(){assert(this.changes!==null,"Changes have already been applied.");return this.changes};return RemoteDocumentChangeBuffer}();var REMOTE_DOCUMENT_CHANGE_MISSING_ERR_MSG="The remote document changelog no longer contains all changes for all "+"local query views. It may be necessary to rebuild these views.";var IndexedDbRemoteDocumentCache=function(){function IndexedDbRemoteDocumentCache(serializer,indexManager,keepDocumentChangeLog){this.serializer=serializer;this.indexManager=indexManager;this.keepDocumentChangeLog=keepDocumentChangeLog;this._lastProcessedDocumentChangeId=0}Object.defineProperty(IndexedDbRemoteDocumentCache.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:true,configurable:true});IndexedDbRemoteDocumentCache.prototype.start=function(transaction){var store=SimpleDb.getStore(transaction,DbRemoteDocumentChanges.store);return this.synchronizeLastDocumentChangeId(store)};IndexedDbRemoteDocumentCache.prototype.addEntries=function(transaction,entries,sizeDelta){var promises=[];if(entries.length>0){var documentStore=remoteDocumentsStore(transaction);var changedKeys=documentKeySet();for(var _i=0,entries_1=entries;_i<entries_1.length;_i++){var _a=entries_1[_i],key=_a.key,doc=_a.doc;promises.push(documentStore.put(dbKey(key),doc));changedKeys=changedKeys.add(key);promises.push(this.indexManager.addToCollectionParentIndex(transaction,key.path.popLast()))}if(this.keepDocumentChangeLog){promises.push(documentChangesStore(transaction).put({changes:this.serializer.toDbResourcePaths(changedKeys)}))}promises.push(this.updateSize(transaction,sizeDelta))}return PersistencePromise.waitFor(promises)};IndexedDbRemoteDocumentCache.prototype.removeEntry=function(transaction,documentKey){var store=remoteDocumentsStore(transaction);var key=dbKey(documentKey);return store.get(key).next(function(document){if(document){return store.delete(key).next(function(){return dbDocumentSize(document)})}else{return PersistencePromise.resolve(0)}})};IndexedDbRemoteDocumentCache.prototype.getEntry=function(transaction,documentKey){var _this=this;return remoteDocumentsStore(transaction).get(dbKey(documentKey)).next(function(dbRemoteDoc){return dbRemoteDoc?_this.serializer.fromDbRemoteDocument(dbRemoteDoc):null})};IndexedDbRemoteDocumentCache.prototype.getSizedEntry=function(transaction,documentKey){var _this=this;return remoteDocumentsStore(transaction).get(dbKey(documentKey)).next(function(dbRemoteDoc){return dbRemoteDoc?{maybeDocument:_this.serializer.fromDbRemoteDocument(dbRemoteDoc),size:dbDocumentSize(dbRemoteDoc)}:null})};IndexedDbRemoteDocumentCache.prototype.getEntries=function(transaction,documentKeys){var _this=this;var results=nullableMaybeDocumentMap();return this.forEachDbEntry(transaction,documentKeys,function(key,dbRemoteDoc){if(dbRemoteDoc){results=results.insert(key,_this.serializer.fromDbRemoteDocument(dbRemoteDoc))}else{results=results.insert(key,null)}}).next(function(){return results})};IndexedDbRemoteDocumentCache.prototype.getSizedEntries=function(transaction,documentKeys){var _this=this;var results=nullableMaybeDocumentMap();var sizeMap=new SortedMap(DocumentKey.comparator);return this.forEachDbEntry(transaction,documentKeys,function(key,dbRemoteDoc){if(dbRemoteDoc){results=results.insert(key,_this.serializer.fromDbRemoteDocument(dbRemoteDoc));sizeMap=sizeMap.insert(key,dbDocumentSize(dbRemoteDoc))}else{results=results.insert(key,null);sizeMap=sizeMap.insert(key,0)}}).next(function(){return{maybeDocuments:results,sizeMap:sizeMap}})};IndexedDbRemoteDocumentCache.prototype.forEachDbEntry=function(transaction,documentKeys,callback){if(documentKeys.isEmpty()){return PersistencePromise.resolve()}var range=IDBKeyRange.bound(documentKeys.first().path.toArray(),documentKeys.last().path.toArray());var keyIter=documentKeys.getIterator();var nextKey=keyIter.getNext();return remoteDocumentsStore(transaction).iterate({range:range},function(potentialKeyRaw,dbRemoteDoc,control){var potentialKey=DocumentKey.fromSegments(potentialKeyRaw);while(nextKey&&DocumentKey.comparator(nextKey,potentialKey)<0){callback(nextKey,null);nextKey=keyIter.getNext()}if(nextKey&&nextKey.isEqual(potentialKey)){callback(nextKey,dbRemoteDoc);nextKey=keyIter.hasNext()?keyIter.getNext():null}if(nextKey){control.skip(nextKey.path.toArray())}else{control.done()}}).next(function(){while(nextKey){callback(nextKey,null);nextKey=keyIter.hasNext()?keyIter.getNext():null}})};IndexedDbRemoteDocumentCache.prototype.getDocumentsMatchingQuery=function(transaction,query){var _this=this;assert(!query.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var results=documentMap();var immediateChildrenPathLength=query.path.length+1;var startKey=query.path.toArray();var range=IDBKeyRange.lowerBound(startKey);return remoteDocumentsStore(transaction).iterate({range:range},function(key,dbRemoteDoc,control){if(key.length!==immediateChildrenPathLength){return}var maybeDoc=_this.serializer.fromDbRemoteDocument(dbRemoteDoc);if(!query.path.isPrefixOf(maybeDoc.key.path)){control.done()}else if(maybeDoc instanceof Document&&query.matches(maybeDoc)){results=results.insert(maybeDoc.key,maybeDoc)}}).next(function(){return results})};IndexedDbRemoteDocumentCache.prototype.getNewDocumentChanges=function(transaction){var _this=this;assert(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var changedKeys=documentKeySet();var changedDocs=maybeDocumentMap();var range=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1);var firstIteration=true;var changesStore=documentChangesStore(transaction);return changesStore.iterate({range:range},function(_,documentChange){if(firstIteration){firstIteration=false;if(_this._lastProcessedDocumentChangeId+1!==documentChange.id){return _this.synchronizeLastDocumentChangeId(changesStore).next(function(){return PersistencePromise.reject(new FirestoreError(Code.DATA_LOSS,REMOTE_DOCUMENT_CHANGE_MISSING_ERR_MSG))})}}changedKeys=changedKeys.unionWith(_this.serializer.fromDbResourcePaths(documentChange.changes));_this._lastProcessedDocumentChangeId=documentChange.id}).next(function(){var documentPromises=[];changedKeys.forEach(function(key){documentPromises.push(_this.getEntry(transaction,key).next(function(maybeDocument){var doc=maybeDocument||new NoDocument(key,SnapshotVersion.forDeletedDoc());changedDocs=changedDocs.insert(key,doc)}))});return PersistencePromise.waitFor(documentPromises)}).next(function(){return changedDocs})};IndexedDbRemoteDocumentCache.prototype.removeDocumentChangesThroughChangeId=function(transaction,changeId){var range=IDBKeyRange.upperBound(changeId);return documentChangesStore(transaction).delete(range)};IndexedDbRemoteDocumentCache.prototype.synchronizeLastDocumentChangeId=function(documentChangesStore){var _this=this;this._lastProcessedDocumentChangeId=0;return documentChangesStore.iterate({keysOnly:true,reverse:true},function(key,value,control){_this._lastProcessedDocumentChangeId=key;control.done()})};IndexedDbRemoteDocumentCache.prototype.newChangeBuffer=function(){return new IndexedDbRemoteDocumentChangeBuffer(this)};IndexedDbRemoteDocumentCache.prototype.getSize=function(txn){return this.getMetadata(txn).next(function(metadata){return metadata.byteSize})};IndexedDbRemoteDocumentCache.prototype.getMetadata=function(txn){return documentGlobalStore(txn).get(DbRemoteDocumentGlobal.key).next(function(metadata){assert(!!metadata,"Missing document cache metadata");return metadata})};IndexedDbRemoteDocumentCache.prototype.setMetadata=function(txn,metadata){return documentGlobalStore(txn).put(DbRemoteDocumentGlobal.key,metadata)};IndexedDbRemoteDocumentCache.prototype.updateSize=function(txn,sizeDelta){var _this=this;return this.getMetadata(txn).next(function(metadata){metadata.byteSize+=sizeDelta;return _this.setMetadata(txn,metadata)})};return IndexedDbRemoteDocumentCache}();function documentGlobalStore(txn){return IndexedDbPersistence.getStore(txn,DbRemoteDocumentGlobal.store)}var IndexedDbRemoteDocumentChangeBuffer=function(_super){tslib_1.__extends(IndexedDbRemoteDocumentChangeBuffer,_super);function IndexedDbRemoteDocumentChangeBuffer(documentCache){var _this=_super.call(this)||this;_this.documentCache=documentCache;return _this}IndexedDbRemoteDocumentChangeBuffer.prototype.applyChanges=function(transaction){var _this=this;var changes=this.assertChanges();var delta=0;var toApply=[];changes.forEach(function(key,maybeDocument){var doc=_this.documentCache.serializer.toDbRemoteDocument(maybeDocument);var previousSize=_this.documentSizes.get(key);assert(previousSize!==undefined,"Attempting to change document "+key.toString()+" without having read it first");var size=dbDocumentSize(doc);delta+=size-previousSize;toApply.push({key:key,doc:doc})});return this.documentCache.addEntries(transaction,toApply,delta)};IndexedDbRemoteDocumentChangeBuffer.prototype.getFromCache=function(transaction,documentKey){return this.documentCache.getSizedEntry(transaction,documentKey)};IndexedDbRemoteDocumentChangeBuffer.prototype.getAllFromCache=function(transaction,documentKeys){return this.documentCache.getSizedEntries(transaction,documentKeys)};return IndexedDbRemoteDocumentChangeBuffer}(RemoteDocumentChangeBuffer);function isDocumentChangeMissingError(err){return err.code===Code.DATA_LOSS&&err.message===REMOTE_DOCUMENT_CHANGE_MISSING_ERR_MSG}function remoteDocumentsStore(txn){return IndexedDbPersistence.getStore(txn,DbRemoteDocument.store)}function documentChangesStore(txn){return IndexedDbPersistence.getStore(txn,DbRemoteDocumentChanges.store)}function dbKey(docKey){return docKey.path.toArray()}function dbDocumentSize(doc){var value;if(doc.document){value=doc.document}else if(doc.unknownDocument){value=doc.unknownDocument}else if(doc.noDocument){value=doc.noDocument}else{throw fail("Unknown remote document type")}return JSON.stringify(value).length}var MemoryIndexManager=function(){function MemoryIndexManager(){this.collectionParentIndex=new MemoryCollectionParentIndex}MemoryIndexManager.prototype.addToCollectionParentIndex=function(transaction,collectionPath){this.collectionParentIndex.add(collectionPath);return PersistencePromise.resolve()};MemoryIndexManager.prototype.getCollectionParents=function(transaction,collectionId){return PersistencePromise.resolve(this.collectionParentIndex.getEntries(collectionId))};return MemoryIndexManager}();var MemoryCollectionParentIndex=function(){function MemoryCollectionParentIndex(){this.index={}}MemoryCollectionParentIndex.prototype.add=function(collectionPath){assert(collectionPath.length%2===1,"Expected a collection path.");var collectionId=collectionPath.lastSegment();var parentPath=collectionPath.popLast();var existingParents=this.index[collectionId]||new SortedSet(ResourcePath.comparator);var added=!existingParents.has(parentPath);this.index[collectionId]=existingParents.add(parentPath);return added};MemoryCollectionParentIndex.prototype.getEntries=function(collectionId){var parentPaths=this.index[collectionId]||new SortedSet(ResourcePath.comparator);return parentPaths.toArray()};return MemoryCollectionParentIndex}();var SCHEMA_VERSION=8;var SchemaConverter=function(){function SchemaConverter(serializer){this.serializer=serializer}SchemaConverter.prototype.createOrUpgrade=function(db,txn,fromVersion,toVersion){var _this=this;assert(fromVersion<toVersion&&fromVersion>=0&&toVersion<=SCHEMA_VERSION,"Unexpected schema upgrade from v"+fromVersion+" to v{toVersion}.");if(fromVersion<1&&toVersion>=1){createPrimaryClientStore(db);createMutationQueue(db);createQueryCache(db);createRemoteDocumentCache(db)}var p=PersistencePromise.resolve();if(fromVersion<3&&toVersion>=3){if(fromVersion!==0){dropQueryCache(db);createQueryCache(db)}p=p.next(function(){return writeEmptyTargetGlobalEntry(txn)})}if(fromVersion<4&&toVersion>=4){if(fromVersion!==0){p=p.next(function(){return upgradeMutationBatchSchemaAndMigrateData(db,txn)})}p=p.next(function(){createClientMetadataStore(db);createRemoteDocumentChangesStore(db)})}if(fromVersion<5&&toVersion>=5){p=p.next(function(){return _this.removeAcknowledgedMutations(txn)})}if(fromVersion<6&&toVersion>=6){p=p.next(function(){createDocumentGlobalStore(db);return _this.addDocumentGlobal(txn)})}if(fromVersion<7&&toVersion>=7){p=p.next(function(){return _this.ensureSequenceNumbers(txn)})}if(fromVersion<8&&toVersion>=8){p=p.next(function(){return _this.createCollectionParentIndex(db,txn)})}return p};SchemaConverter.prototype.addDocumentGlobal=function(txn){var byteCount=0;return txn.store(DbRemoteDocument.store).iterate(function(_,doc){byteCount+=dbDocumentSize(doc)}).next(function(){var metadata=new DbRemoteDocumentGlobal(byteCount);return txn.store(DbRemoteDocumentGlobal.store).put(DbRemoteDocumentGlobal.key,metadata)})};SchemaConverter.prototype.removeAcknowledgedMutations=function(txn){var _this=this;var queuesStore=txn.store(DbMutationQueue.store);var mutationsStore=txn.store(DbMutationBatch.store);return queuesStore.loadAll().next(function(queues){return PersistencePromise.forEach(queues,function(queue){var range=IDBKeyRange.bound([queue.userId,BATCHID_UNKNOWN],[queue.userId,queue.lastAcknowledgedBatchId]);return mutationsStore.loadAll(DbMutationBatch.userMutationsIndex,range).next(function(dbBatches){return PersistencePromise.forEach(dbBatches,function(dbBatch){assert(dbBatch.userId===queue.userId,"Cannot process batch "+dbBatch.batchId+" from unexpected user");var batch=_this.serializer.fromDbMutationBatch(dbBatch);return removeMutationBatch(txn,queue.userId,batch).next(function(){})})})})})};SchemaConverter.prototype.ensureSequenceNumbers=function(txn){var documentTargetStore=txn.store(DbTargetDocument.store);var documentsStore=txn.store(DbRemoteDocument.store);return getHighestListenSequenceNumber(txn).next(function(currentSequenceNumber){var writeSentinelKey=function(path){return documentTargetStore.put(new DbTargetDocument(0,encode(path),currentSequenceNumber))};var promises=[];return documentsStore.iterate(function(key,doc){var path=new ResourcePath(key);var docSentinelKey=sentinelKey(path);promises.push(documentTargetStore.get(docSentinelKey).next(function(maybeSentinel){if(!maybeSentinel){return writeSentinelKey(path)}else{return PersistencePromise.resolve()}}))}).next(function(){return PersistencePromise.waitFor(promises)})})};SchemaConverter.prototype.createCollectionParentIndex=function(db,txn){db.createObjectStore(DbCollectionParent.store,{keyPath:DbCollectionParent.keyPath});var collectionParentsStore=txn.store(DbCollectionParent.store);var cache=new MemoryCollectionParentIndex;var addEntry=function(collectionPath){if(cache.add(collectionPath)){var collectionId=collectionPath.lastSegment();var parentPath=collectionPath.popLast();return collectionParentsStore.put({collectionId:collectionId,parent:encode(parentPath)})}};return txn.store(DbRemoteDocument.store).iterate({keysOnly:true},function(pathSegments,_){var path=new ResourcePath(pathSegments);return addEntry(path.popLast())}).next(function(){return txn.store(DbDocumentMutation.store).iterate({keysOnly:true},function(_a,_){var userID=_a[0],encodedPath=_a[1],batchId=_a[2];var path=decode(encodedPath);return addEntry(path.popLast())})})};return SchemaConverter}();function sentinelKey(path){return[0,encode(path)]}var DbTimestamp=function(){function DbTimestamp(seconds,nanoseconds){this.seconds=seconds;this.nanoseconds=nanoseconds}return DbTimestamp}();var DbPrimaryClient=function(){function DbPrimaryClient(ownerId,allowTabSynchronization,leaseTimestampMs){this.ownerId=ownerId;this.allowTabSynchronization=allowTabSynchronization;this.leaseTimestampMs=leaseTimestampMs}DbPrimaryClient.store="owner";DbPrimaryClient.key="owner";return DbPrimaryClient}();function createPrimaryClientStore(db){db.createObjectStore(DbPrimaryClient.store)}var DbMutationQueue=function(){function DbMutationQueue(userId,lastAcknowledgedBatchId,lastStreamToken){this.userId=userId;this.lastAcknowledgedBatchId=lastAcknowledgedBatchId;this.lastStreamToken=lastStreamToken}DbMutationQueue.store="mutationQueues";DbMutationQueue.keyPath="userId";return DbMutationQueue}();var DbMutationBatch=function(){function DbMutationBatch(userId,batchId,localWriteTimeMs,baseMutations,mutations){this.userId=userId;this.batchId=batchId;this.localWriteTimeMs=localWriteTimeMs;this.baseMutations=baseMutations;this.mutations=mutations}DbMutationBatch.store="mutations";DbMutationBatch.keyPath="batchId";DbMutationBatch.userMutationsIndex="userMutationsIndex";DbMutationBatch.userMutationsKeyPath=["userId","batchId"];return DbMutationBatch}();function createMutationQueue(db){db.createObjectStore(DbMutationQueue.store,{keyPath:DbMutationQueue.keyPath});var mutationBatchesStore=db.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath,autoIncrement:true});mutationBatchesStore.createIndex(DbMutationBatch.userMutationsIndex,DbMutationBatch.userMutationsKeyPath,{unique:true});db.createObjectStore(DbDocumentMutation.store)}function upgradeMutationBatchSchemaAndMigrateData(db,txn){var v1MutationsStore=txn.store(DbMutationBatch.store);return v1MutationsStore.loadAll().next(function(existingMutations){db.deleteObjectStore(DbMutationBatch.store);var mutationsStore=db.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath,autoIncrement:true});mutationsStore.createIndex(DbMutationBatch.userMutationsIndex,DbMutationBatch.userMutationsKeyPath,{unique:true});var v3MutationsStore=txn.store(DbMutationBatch.store);var writeAll=existingMutations.map(function(mutation){return v3MutationsStore.put(mutation)});return PersistencePromise.waitFor(writeAll)})}var DbDocumentMutation=function(){function DbDocumentMutation(){}DbDocumentMutation.prefixForUser=function(userId){return[userId]};DbDocumentMutation.prefixForPath=function(userId,path){return[userId,encode(path)]};DbDocumentMutation.key=function(userId,path,batchId){return[userId,encode(path),batchId]};DbDocumentMutation.store="documentMutations";DbDocumentMutation.PLACEHOLDER=new DbDocumentMutation;return DbDocumentMutation}();function createRemoteDocumentCache(db){db.createObjectStore(DbRemoteDocument.store)}var DbNoDocument=function(){function DbNoDocument(path,readTime){this.path=path;this.readTime=readTime}return DbNoDocument}();var DbUnknownDocument=function(){function DbUnknownDocument(path,version){this.path=path;this.version=version}return DbUnknownDocument}();var DbRemoteDocument=function(){function DbRemoteDocument(unknownDocument,noDocument,document,hasCommittedMutations){this.unknownDocument=unknownDocument;this.noDocument=noDocument;this.document=document;this.hasCommittedMutations=hasCommittedMutations}DbRemoteDocument.store="remoteDocuments";return DbRemoteDocument}();var DbRemoteDocumentGlobal=function(){function DbRemoteDocumentGlobal(byteSize){this.byteSize=byteSize}DbRemoteDocumentGlobal.store="remoteDocumentGlobal";DbRemoteDocumentGlobal.key="remoteDocumentGlobalKey";return DbRemoteDocumentGlobal}();function createDocumentGlobalStore(db){db.createObjectStore(DbRemoteDocumentGlobal.store)}var DbTarget=function(){function DbTarget(targetId,canonicalId,readTime,resumeToken,lastListenSequenceNumber,query){this.targetId=targetId;this.canonicalId=canonicalId;this.readTime=readTime;this.resumeToken=resumeToken;this.lastListenSequenceNumber=lastListenSequenceNumber;this.query=query}DbTarget.store="targets";DbTarget.keyPath="targetId";DbTarget.queryTargetsIndexName="queryTargetsIndex";DbTarget.queryTargetsKeyPath=["canonicalId","targetId"];return DbTarget}();var DbTargetDocument=function(){function DbTargetDocument(targetId,path,sequenceNumber){this.targetId=targetId;this.path=path;this.sequenceNumber=sequenceNumber;assert(targetId===0===(sequenceNumber!==undefined),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}DbTargetDocument.store="targetDocuments";DbTargetDocument.keyPath=["targetId","path"];DbTargetDocument.documentTargetsIndex="documentTargetsIndex";DbTargetDocument.documentTargetsKeyPath=["path","targetId"];return DbTargetDocument}();var DbTargetGlobal=function(){function DbTargetGlobal(highestTargetId,highestListenSequenceNumber,lastRemoteSnapshotVersion,targetCount){this.highestTargetId=highestTargetId;this.highestListenSequenceNumber=highestListenSequenceNumber;this.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion;this.targetCount=targetCount}DbTargetGlobal.key="targetGlobalKey";DbTargetGlobal.store="targetGlobal";return DbTargetGlobal}();var DbCollectionParent=function(){function DbCollectionParent(collectionId,parent){this.collectionId=collectionId;this.parent=parent}DbCollectionParent.store="collectionParents";DbCollectionParent.keyPath=["collectionId","parent"];return DbCollectionParent}();function createQueryCache(db){var targetDocumentsStore=db.createObjectStore(DbTargetDocument.store,{keyPath:DbTargetDocument.keyPath});targetDocumentsStore.createIndex(DbTargetDocument.documentTargetsIndex,DbTargetDocument.documentTargetsKeyPath,{unique:true});var targetStore=db.createObjectStore(DbTarget.store,{keyPath:DbTarget.keyPath});targetStore.createIndex(DbTarget.queryTargetsIndexName,DbTarget.queryTargetsKeyPath,{unique:true});db.createObjectStore(DbTargetGlobal.store)}function dropQueryCache(db){db.deleteObjectStore(DbTargetDocument.store);db.deleteObjectStore(DbTarget.store);db.deleteObjectStore(DbTargetGlobal.store)}function writeEmptyTargetGlobalEntry(txn){var globalStore=txn.store(DbTargetGlobal.store);var metadata=new DbTargetGlobal(0,0,SnapshotVersion.MIN.toTimestamp(),0);return globalStore.put(DbTargetGlobal.key,metadata)}var DbRemoteDocumentChanges=function(){function DbRemoteDocumentChanges(changes){this.changes=changes}DbRemoteDocumentChanges.store="remoteDocumentChanges";DbRemoteDocumentChanges.keyPath="id";return DbRemoteDocumentChanges}();function createRemoteDocumentChangesStore(db){db.createObjectStore(DbRemoteDocumentChanges.store,{keyPath:"id",autoIncrement:true})}var DbClientMetadata=function(){function DbClientMetadata(clientId,updateTimeMs,networkEnabled,inForeground,lastProcessedDocumentChangeId){this.clientId=clientId;this.updateTimeMs=updateTimeMs;this.networkEnabled=networkEnabled;this.inForeground=inForeground;this.lastProcessedDocumentChangeId=lastProcessedDocumentChangeId}DbClientMetadata.store="clientMetadata";DbClientMetadata.keyPath="clientId";return DbClientMetadata}();function createClientMetadataStore(db){db.createObjectStore(DbClientMetadata.store,{keyPath:DbClientMetadata.keyPath})}var V1_STORES=[DbMutationQueue.store,DbMutationBatch.store,DbDocumentMutation.store,DbRemoteDocument.store,DbTarget.store,DbPrimaryClient.store,DbTargetGlobal.store,DbTargetDocument.store];var V3_STORES=V1_STORES;var V4_STORES=V3_STORES.concat([DbClientMetadata.store,DbRemoteDocumentChanges.store]);var V6_STORES=V4_STORES.concat([DbRemoteDocumentGlobal.store]);var V8_STORES=V6_STORES.concat([DbCollectionParent.store]);var ALL_STORES=V8_STORES;var IndexedDbIndexManager=function(){function IndexedDbIndexManager(){this.collectionParentsCache=new MemoryCollectionParentIndex}IndexedDbIndexManager.prototype.addToCollectionParentIndex=function(transaction,collectionPath){assert(collectionPath.length%2===1,"Expected a collection path.");if(this.collectionParentsCache.add(collectionPath)){assert(collectionPath.length>=1,"Invalid collection path.");var collectionId=collectionPath.lastSegment();var parentPath=collectionPath.popLast();return collectionParentsStore(transaction).put({collectionId:collectionId,parent:encode(parentPath)})}return PersistencePromise.resolve()};IndexedDbIndexManager.prototype.getCollectionParents=function(transaction,collectionId){var parentPaths=[];var range=IDBKeyRange.bound([collectionId,""],[immediateSuccessor(collectionId),""],false,true);return collectionParentsStore(transaction).loadAll(range).next(function(entries){for(var _i=0,entries_1=entries;_i<entries_1.length;_i++){var entry=entries_1[_i];if(entry.collectionId!==collectionId){break}parentPaths.push(decode(entry.parent))}return parentPaths})};return IndexedDbIndexManager}();function collectionParentsStore(txn){return IndexedDbPersistence.getStore(txn,DbCollectionParent.store)}var LocalSerializer=function(){function LocalSerializer(remoteSerializer){this.remoteSerializer=remoteSerializer}LocalSerializer.prototype.fromDbRemoteDocument=function(remoteDoc){if(remoteDoc.document){return this.remoteSerializer.fromDocument(remoteDoc.document,!!remoteDoc.hasCommittedMutations)}else if(remoteDoc.noDocument){var key=DocumentKey.fromSegments(remoteDoc.noDocument.path);var version=this.fromDbTimestamp(remoteDoc.noDocument.readTime);return new NoDocument(key,version,{hasCommittedMutations:!!remoteDoc.hasCommittedMutations})}else if(remoteDoc.unknownDocument){var key=DocumentKey.fromSegments(remoteDoc.unknownDocument.path);var version=this.fromDbTimestamp(remoteDoc.unknownDocument.version);return new UnknownDocument(key,version)}else{return fail("Unexpected DbRemoteDocument")}};LocalSerializer.prototype.toDbRemoteDocument=function(maybeDoc){if(maybeDoc instanceof Document){var doc=maybeDoc.proto?maybeDoc.proto:this.remoteSerializer.toDocument(maybeDoc);var hasCommittedMutations=maybeDoc.hasCommittedMutations;return new DbRemoteDocument(null,null,doc,hasCommittedMutations)}else if(maybeDoc instanceof NoDocument){var path=maybeDoc.key.path.toArray();var readTime=this.toDbTimestamp(maybeDoc.version);var hasCommittedMutations=maybeDoc.hasCommittedMutations;return new DbRemoteDocument(null,new DbNoDocument(path,readTime),null,hasCommittedMutations)}else if(maybeDoc instanceof UnknownDocument){var path=maybeDoc.key.path.toArray();var readTime=this.toDbTimestamp(maybeDoc.version);return new DbRemoteDocument(new DbUnknownDocument(path,readTime),null,null,true)}else{return fail("Unexpected MaybeDocumment")}};LocalSerializer.prototype.toDbTimestamp=function(snapshotVersion){var timestamp=snapshotVersion.toTimestamp();return new DbTimestamp(timestamp.seconds,timestamp.nanoseconds)};LocalSerializer.prototype.fromDbTimestamp=function(dbTimestamp){var timestamp=new Timestamp(dbTimestamp.seconds,dbTimestamp.nanoseconds);return SnapshotVersion.fromTimestamp(timestamp)};LocalSerializer.prototype.toDbMutationBatch=function(userId,batch){var _this=this;var serializedBaseMutations=batch.baseMutations.map(function(m){return _this.remoteSerializer.toMutation(m)});var serializedMutations=batch.mutations.map(function(m){return _this.remoteSerializer.toMutation(m)});return new DbMutationBatch(userId,batch.batchId,batch.localWriteTime.toMillis(),serializedBaseMutations,serializedMutations)};LocalSerializer.prototype.fromDbMutationBatch=function(dbBatch){var _this=this;var baseMutations=(dbBatch.baseMutations||[]).map(function(m){return _this.remoteSerializer.fromMutation(m)});var mutations=dbBatch.mutations.map(function(m){return _this.remoteSerializer.fromMutation(m)});var timestamp=Timestamp.fromMillis(dbBatch.localWriteTimeMs);return new MutationBatch(dbBatch.batchId,timestamp,baseMutations,mutations)};LocalSerializer.prototype.toDbResourcePaths=function(keys){var encodedKeys=[];keys.forEach(function(key){encodedKeys.push(encode(key.path))});return encodedKeys};LocalSerializer.prototype.fromDbResourcePaths=function(encodedPaths){var keys=documentKeySet();for(var _i=0,encodedPaths_1=encodedPaths;_i<encodedPaths_1.length;_i++){var documentKey=encodedPaths_1[_i];keys=keys.add(new DocumentKey(decode(documentKey)))}return keys};LocalSerializer.prototype.fromDbTarget=function(dbTarget){var version=this.fromDbTimestamp(dbTarget.readTime);var query;if(isDocumentQuery(dbTarget.query)){query=this.remoteSerializer.fromDocumentsTarget(dbTarget.query)}else{query=this.remoteSerializer.fromQueryTarget(dbTarget.query)}return new QueryData(query,dbTarget.targetId,QueryPurpose.Listen,dbTarget.lastListenSequenceNumber,version,dbTarget.resumeToken)};LocalSerializer.prototype.toDbTarget=function(queryData){assert(QueryPurpose.Listen===queryData.purpose,"Only queries with purpose "+QueryPurpose.Listen+" may be stored, got "+queryData.purpose);var dbTimestamp=this.toDbTimestamp(queryData.snapshotVersion);var queryProto;if(queryData.query.isDocumentQuery()){queryProto=this.remoteSerializer.toDocumentsTarget(queryData.query)}else{queryProto=this.remoteSerializer.toQueryTarget(queryData.query)}var resumeToken;if(queryData.resumeToken instanceof Uint8Array){assert(process.env.USE_MOCK_PERSISTENCE==="YES","Persisting non-string stream tokens is only supported with mock persistence .");resumeToken=queryData.resumeToken.toString()}else{resumeToken=queryData.resumeToken}return new DbTarget(queryData.targetId,queryData.query.canonicalId(),dbTimestamp,resumeToken,queryData.sequenceNumber,queryProto)};return LocalSerializer}();function isDocumentQuery(dbQuery){return dbQuery.documents!==undefined}function bufferEntryComparator(_a,_b){var aSequence=_a[0],aIndex=_a[1];var bSequence=_b[0],bIndex=_b[1];var seqCmp=primitiveComparator(aSequence,bSequence);if(seqCmp===0){return primitiveComparator(aIndex,bIndex)}else{return seqCmp}}var RollingSequenceNumberBuffer=function(){function RollingSequenceNumberBuffer(maxElements){this.maxElements=maxElements;this.buffer=new SortedSet(bufferEntryComparator);this.previousIndex=0}RollingSequenceNumberBuffer.prototype.nextIndex=function(){return++this.previousIndex};RollingSequenceNumberBuffer.prototype.addElement=function(sequenceNumber){var entry=[sequenceNumber,this.nextIndex()];if(this.buffer.size<this.maxElements){this.buffer=this.buffer.add(entry)}else{var highestValue=this.buffer.last();if(bufferEntryComparator(entry,highestValue)<0){this.buffer=this.buffer.delete(highestValue).add(entry)}}};Object.defineProperty(RollingSequenceNumberBuffer.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:true,configurable:true});return RollingSequenceNumberBuffer}();var GC_DID_NOT_RUN={didRun:false,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};var LruParams=function(){function LruParams(cacheSizeCollectionThreshold,percentileToCollect,maximumSequenceNumbersToCollect){this.cacheSizeCollectionThreshold=cacheSizeCollectionThreshold;this.percentileToCollect=percentileToCollect;this.maximumSequenceNumbersToCollect=maximumSequenceNumbersToCollect}LruParams.withCacheSize=function(cacheSize){return new LruParams(cacheSize,LruParams.DEFAULT_COLLECTION_PERCENTILE,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)};LruParams.COLLECTION_DISABLED=-1;LruParams.MINIMUM_CACHE_SIZE_BYTES=1*1024*1024;LruParams.DEFAULT_CACHE_SIZE_BYTES=40*1024*1024;LruParams.DEFAULT_COLLECTION_PERCENTILE=10;LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3;LruParams.DEFAULT=new LruParams(LruParams.DEFAULT_CACHE_SIZE_BYTES,LruParams.DEFAULT_COLLECTION_PERCENTILE,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT);LruParams.DISABLED=new LruParams(LruParams.COLLECTION_DISABLED,0,0);return LruParams}();var INITIAL_GC_DELAY_MS=1*60*1e3;var REGULAR_GC_DELAY_MS=5*60*1e3;var LruScheduler=function(){function LruScheduler(garbageCollector,asyncQueue,localStore){this.garbageCollector=garbageCollector;this.asyncQueue=asyncQueue;this.localStore=localStore;this.gcTask=null}LruScheduler.prototype.start=function(){assert(this.gcTask===null,"Cannot start an already started LruScheduler");if(this.garbageCollector.params.cacheSizeCollectionThreshold!==LruParams.COLLECTION_DISABLED){this.scheduleGC()}};LruScheduler.prototype.stop=function(){if(this.gcTask){this.gcTask.cancel();this.gcTask=null}};Object.defineProperty(LruScheduler.prototype,"started",{get:function(){return this.gcTask!==null},enumerable:true,configurable:true});LruScheduler.prototype.scheduleGC=function(){var _this=this;assert(this.gcTask===null,"Cannot schedule GC while a task is pending");var delay=this.hasRun?REGULAR_GC_DELAY_MS:INITIAL_GC_DELAY_MS;debug("LruGarbageCollector","Garbage collection scheduled in "+delay+"ms");this.gcTask=this.asyncQueue.enqueueAfterDelay(TimerId.LruGarbageCollection,delay,function(){_this.gcTask=null;_this.hasRun=true;return _this.localStore.collectGarbage(_this.garbageCollector).then(function(){return _this.scheduleGC()}).catch(ignoreIfPrimaryLeaseLoss)})};return LruScheduler}();var LruGarbageCollector=function(){function LruGarbageCollector(delegate,params){this.delegate=delegate;this.params=params}LruGarbageCollector.prototype.calculateTargetCount=function(txn,percentile){return this.delegate.getSequenceNumberCount(txn).next(function(targetCount){return Math.floor(percentile/100*targetCount)})};LruGarbageCollector.prototype.nthSequenceNumber=function(txn,n){var _this=this;if(n===0){return PersistencePromise.resolve(ListenSequence.INVALID)}var buffer=new RollingSequenceNumberBuffer(n);return this.delegate.forEachTarget(txn,function(target){return buffer.addElement(target.sequenceNumber)}).next(function(){return _this.delegate.forEachOrphanedDocumentSequenceNumber(txn,function(sequenceNumber){return buffer.addElement(sequenceNumber)})}).next(function(){return buffer.maxValue})};LruGarbageCollector.prototype.removeTargets=function(txn,upperBound,activeTargetIds){return this.delegate.removeTargets(txn,upperBound,activeTargetIds)};LruGarbageCollector.prototype.removeOrphanedDocuments=function(txn,upperBound){return this.delegate.removeOrphanedDocuments(txn,upperBound)};LruGarbageCollector.prototype.collect=function(txn,activeTargetIds){var _this=this;if(this.params.cacheSizeCollectionThreshold===LruParams.COLLECTION_DISABLED){debug("LruGarbageCollector","Garbage collection skipped; disabled");return PersistencePromise.resolve(GC_DID_NOT_RUN)}return this.getCacheSize(txn).next(function(cacheSize){if(cacheSize<_this.params.cacheSizeCollectionThreshold){debug("LruGarbageCollector","Garbage collection skipped; Cache size "+cacheSize+" "+("is lower than threshold "+_this.params.cacheSizeCollectionThreshold));return GC_DID_NOT_RUN}else{return _this.runGarbageCollection(txn,activeTargetIds)}})};LruGarbageCollector.prototype.getCacheSize=function(txn){return this.delegate.getCacheSize(txn)};LruGarbageCollector.prototype.runGarbageCollection=function(txn,activeTargetIds){var _this=this;var upperBoundSequenceNumber;var sequenceNumbersToCollect,targetsRemoved;var startTs,countedTargetsTs,foundUpperBoundTs,removedTargetsTs,removedDocumentsTs;startTs=Date.now();return this.calculateTargetCount(txn,this.params.percentileToCollect).next(function(sequenceNumbers){if(sequenceNumbers>_this.params.maximumSequenceNumbersToCollect){debug("LruGarbageCollector","Capping sequence numbers to collect down "+("to the maximum of "+_this.params.maximumSequenceNumbersToCollect+" ")+("from "+sequenceNumbers));sequenceNumbersToCollect=_this.params.maximumSequenceNumbersToCollect}else{sequenceNumbersToCollect=sequenceNumbers}countedTargetsTs=Date.now();return _this.nthSequenceNumber(txn,sequenceNumbersToCollect)}).next(function(upperBound){upperBoundSequenceNumber=upperBound;foundUpperBoundTs=Date.now();return _this.removeTargets(txn,upperBoundSequenceNumber,activeTargetIds)}).next(function(numTargetsRemoved){targetsRemoved=numTargetsRemoved;removedTargetsTs=Date.now();return _this.removeOrphanedDocuments(txn,upperBoundSequenceNumber)}).next(function(documentsRemoved){removedDocumentsTs=Date.now();if(getLogLevel()<=LogLevel.DEBUG){var desc="LRU Garbage Collection\n"+("\tCounted targets in "+(countedTargetsTs-startTs)+"ms\n")+("\tDetermined least recently used "+sequenceNumbersToCollect+" in ")+(foundUpperBoundTs-countedTargetsTs+"ms\n")+("\tRemoved "+targetsRemoved+" targets in ")+(removedTargetsTs-foundUpperBoundTs+"ms\n")+("\tRemoved "+documentsRemoved+" documents in ")+(removedDocumentsTs-removedTargetsTs+"ms\n")+("Total Duration: "+(removedDocumentsTs-startTs)+"ms");debug("LruGarbageCollector",desc)}return PersistencePromise.resolve({didRun:true,sequenceNumbersCollected:sequenceNumbersToCollect,targetsRemoved:targetsRemoved,documentsRemoved:documentsRemoved})})};return LruGarbageCollector}();var PersistenceTransaction=function(){function PersistenceTransaction(){}return PersistenceTransaction}();var LOG_TAG$2="IndexedDbPersistence";var MAX_CLIENT_AGE_MS=30*60*1e3;var MAX_PRIMARY_ELIGIBLE_AGE_MS=5e3;var CLIENT_METADATA_REFRESH_INTERVAL_MS=4e3;var PRIMARY_LEASE_LOST_ERROR_MSG="The current tab is not in the required state to perform this operation. "+"It might be necessary to refresh the browser tab.";var PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG="Another tab has exclusive access to the persistence layer. "+"To allow shared access, make sure to invoke "+"`enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.";var UNSUPPORTED_PLATFORM_ERROR_MSG="This platform is either missing"+" IndexedDB or is known to have an incomplete implementation. Offline"+" persistence has been disabled.";var ZOMBIED_CLIENTS_KEY_PREFIX="firestore_zombie";var IndexedDbTransaction=function(_super){tslib_1.__extends(IndexedDbTransaction,_super);function IndexedDbTransaction(simpleDbTransaction,currentSequenceNumber){var _this=_super.call(this)||this;_this.simpleDbTransaction=simpleDbTransaction;_this.currentSequenceNumber=currentSequenceNumber;return _this}return IndexedDbTransaction}(PersistenceTransaction);var IndexedDbPersistence=function(){function IndexedDbPersistence(persistenceKey,clientId,platform,queue,serializer,lruParams,multiClientParams){this.persistenceKey=persistenceKey;this.clientId=clientId;this.queue=queue;this.multiClientParams=multiClientParams;this._started=false;this.isPrimary=false;this.networkEnabled=true;this.inForeground=false;this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY;this.primaryStateListener=function(_){return Promise.resolve()};if(!IndexedDbPersistence.isAvailable()){throw new FirestoreError(Code.UNIMPLEMENTED,UNSUPPORTED_PLATFORM_ERROR_MSG)}this.referenceDelegate=new IndexedDbLruDelegate(this,lruParams);this.dbName=persistenceKey+IndexedDbPersistence.MAIN_DATABASE;this.serializer=new LocalSerializer(serializer);this.document=platform.document;this.allowTabSynchronization=multiClientParams!==undefined;this.queryCache=new IndexedDbQueryCache(this.referenceDelegate,this.serializer);this.indexManager=new IndexedDbIndexManager;this.remoteDocumentCache=new IndexedDbRemoteDocumentCache(this.serializer,this.indexManager,this.allowTabSynchronization);if(platform.window&&platform.window.localStorage){this.window=platform.window;this.webStorage=this.window.localStorage}else{throw new FirestoreError(Code.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.")}}IndexedDbPersistence.getStore=function(txn,store){if(txn instanceof IndexedDbTransaction){return SimpleDb.getStore(txn.simpleDbTransaction,store)}else{throw fail("IndexedDbPersistence must use instances of IndexedDbTransaction")}};IndexedDbPersistence.createIndexedDbPersistence=function(persistenceKey,clientId,platform,queue,serializer,lruParams){return tslib_1.__awaiter(this,void 0,void 0,function(){var persistence;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:persistence=new IndexedDbPersistence(persistenceKey,clientId,platform,queue,serializer,lruParams);return[4,persistence.start()];case 1:_a.sent();return[2,persistence]}})})};IndexedDbPersistence.createMultiClientIndexedDbPersistence=function(persistenceKey,clientId,platform,queue,serializer,lruParams,multiClientParams){return tslib_1.__awaiter(this,void 0,void 0,function(){var persistence;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:persistence=new IndexedDbPersistence(persistenceKey,clientId,platform,queue,serializer,lruParams,multiClientParams);return[4,persistence.start()];case 1:_a.sent();return[2,persistence]}})})};IndexedDbPersistence.prototype.start=function(){var _this=this;assert(!this.started,"IndexedDbPersistence double-started!");assert(this.window!==null,"Expected 'window' to be defined");return SimpleDb.openOrCreate(this.dbName,SCHEMA_VERSION,new SchemaConverter(this.serializer)).then(function(db){_this.simpleDb=db;return _this.updateClientMetadataAndTryBecomePrimary()}).then(function(){_this.attachVisibilityHandler();_this.attachWindowUnloadHook();_this.scheduleClientMetadataAndPrimaryLeaseRefreshes();return _this.startRemoteDocumentCache()}).then(function(){return _this.simpleDb.runTransaction("readonly",[DbTargetGlobal.store],function(txn){return getHighestListenSequenceNumber(txn).next(function(highestListenSequenceNumber){var sequenceNumberSyncer=_this.multiClientParams?_this.multiClientParams.sequenceNumberSyncer:undefined;_this.listenSequence=new ListenSequence(highestListenSequenceNumber,sequenceNumberSyncer)})})}).then(function(){_this._started=true}).catch(function(reason){_this.simpleDb&&_this.simpleDb.close();return Promise.reject(reason)})};IndexedDbPersistence.prototype.startRemoteDocumentCache=function(){var _this=this;return this.simpleDb.runTransaction("readonly",ALL_STORES,function(txn){return _this.remoteDocumentCache.start(txn)})};IndexedDbPersistence.prototype.setPrimaryStateListener=function(primaryStateListener){var _this=this;this.primaryStateListener=function(primaryState){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(this.started){return[2,primaryStateListener(primaryState)]}return[2]})})};return primaryStateListener(this.isPrimary)};IndexedDbPersistence.prototype.setNetworkEnabled=function(networkEnabled){var _this=this;if(this.networkEnabled!==networkEnabled){this.networkEnabled=networkEnabled;this.queue.enqueueAndForget(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!this.started)return[3,2];return[4,this.updateClientMetadataAndTryBecomePrimary()];case 1:_a.sent();_a.label=2;case 2:return[2]}})})})}};IndexedDbPersistence.prototype.updateClientMetadataAndTryBecomePrimary=function(){var _this=this;return this.simpleDb.runTransaction("readwrite",ALL_STORES,function(txn){var metadataStore=clientMetadataStore(txn);return metadataStore.put(new DbClientMetadata(_this.clientId,Date.now(),_this.networkEnabled,_this.inForeground,_this.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(_this.isPrimary){return _this.verifyPrimaryLease(txn).next(function(success){if(!success){_this.isPrimary=false;_this.queue.enqueueAndForget(function(){return _this.primaryStateListener(false)})}})}}).next(function(){return _this.canActAsPrimary(txn)}).next(function(canActAsPrimary){var wasPrimary=_this.isPrimary;_this.isPrimary=canActAsPrimary;if(wasPrimary!==_this.isPrimary){_this.queue.enqueueAndForget(function(){return _this.primaryStateListener(_this.isPrimary)})}if(wasPrimary&&!_this.isPrimary){return _this.releasePrimaryLeaseIfHeld(txn)}else if(_this.isPrimary){return _this.acquireOrExtendPrimaryLease(txn)}})})};IndexedDbPersistence.prototype.verifyPrimaryLease=function(txn){var _this=this;var store=primaryClientStore(txn);return store.get(DbPrimaryClient.key).next(function(primaryClient){return PersistencePromise.resolve(_this.isLocalClient(primaryClient))})};IndexedDbPersistence.prototype.removeClientMetadata=function(txn){var metadataStore=clientMetadataStore(txn);return metadataStore.delete(this.clientId)};IndexedDbPersistence.prototype.maybeGarbageCollectMultiClientState=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var activeClients_1,inactiveClients_1;var _this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!(this.isPrimary&&!this.isWithinAge(this.lastGarbageCollectionTime,MAX_CLIENT_AGE_MS)))return[3,2];this.lastGarbageCollectionTime=Date.now();inactiveClients_1=[];return[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(txn){var metadataStore=IndexedDbPersistence.getStore(txn,DbClientMetadata.store);return metadataStore.loadAll().next(function(existingClients){activeClients_1=_this.filterActiveClients(existingClients,MAX_CLIENT_AGE_MS);inactiveClients_1=existingClients.filter(function(client){return activeClients_1.indexOf(client)===-1})}).next(function(){return PersistencePromise.forEach(inactiveClients_1,function(inactiveClient){return metadataStore.delete(inactiveClient.clientId)})}).next(function(){activeClients_1=activeClients_1.filter(function(client){return client.clientId!==_this.clientId});if(activeClients_1.length>0){var processedChangeIds=activeClients_1.map(function(client){return client.lastProcessedDocumentChangeId||0});var oldestChangeId=Math.min.apply(Math,processedChangeIds);return _this.remoteDocumentCache.removeDocumentChangesThroughChangeId(txn,oldestChangeId)}})})];case 1:_a.sent();inactiveClients_1.forEach(function(inactiveClient){_this.window.localStorage.removeItem(_this.zombiedClientLocalStorageKey(inactiveClient.clientId))});_a.label=2;case 2:return[2]}})})};IndexedDbPersistence.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var _this=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(TimerId.ClientMetadataRefresh,CLIENT_METADATA_REFRESH_INTERVAL_MS,function(){return _this.updateClientMetadataAndTryBecomePrimary().then(function(){return _this.maybeGarbageCollectMultiClientState()}).then(function(){return _this.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})};IndexedDbPersistence.prototype.isLocalClient=function(client){return client?client.ownerId===this.clientId:false};IndexedDbPersistence.prototype.canActAsPrimary=function(txn){var _this=this;var store=primaryClientStore(txn);return store.get(DbPrimaryClient.key).next(function(currentPrimary){var currentLeaseIsValid=currentPrimary!==null&&_this.isWithinAge(currentPrimary.leaseTimestampMs,MAX_PRIMARY_ELIGIBLE_AGE_MS)&&!_this.isClientZombied(currentPrimary.ownerId);if(currentLeaseIsValid){if(_this.isLocalClient(currentPrimary)&&_this.networkEnabled){return true}if(!_this.isLocalClient(currentPrimary)){if(!currentPrimary.allowTabSynchronization){throw new FirestoreError(Code.FAILED_PRECONDITION,PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG)}return false}}if(_this.networkEnabled&&_this.inForeground){return true}return clientMetadataStore(txn).loadAll().next(function(existingClients){var preferredCandidate=_this.filterActiveClients(existingClients,MAX_PRIMARY_ELIGIBLE_AGE_MS).find(function(otherClient){if(_this.clientId!==otherClient.clientId){var otherClientHasBetterNetworkState=!_this.networkEnabled&&otherClient.networkEnabled;var otherClientHasBetterVisibility=!_this.inForeground&&otherClient.inForeground;var otherClientHasSameNetworkState=_this.networkEnabled===otherClient.networkEnabled;if(otherClientHasBetterNetworkState||otherClientHasBetterVisibility&&otherClientHasSameNetworkState){return true}}return false});return preferredCandidate===undefined})}).next(function(canActAsPrimary){if(_this.isPrimary!==canActAsPrimary){debug(LOG_TAG$2,"Client "+(canActAsPrimary?"is":"is not")+" eligible for a primary lease.")}return canActAsPrimary})};IndexedDbPersistence.prototype.shutdown=function(deleteData){return tslib_1.__awaiter(this,void 0,void 0,function(){var _this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this._started=false;this.markClientZombied();if(this.clientMetadataRefresher){this.clientMetadataRefresher.cancel()}this.detachVisibilityHandler();this.detachWindowUnloadHook();return[4,this.simpleDb.runTransaction("readwrite",[DbPrimaryClient.store,DbClientMetadata.store],function(txn){return _this.releasePrimaryLeaseIfHeld(txn).next(function(){return _this.removeClientMetadata(txn)})})];case 1:_a.sent();this.simpleDb.close();this.removeClientZombiedEntry();if(!deleteData)return[3,3];return[4,SimpleDb.delete(this.dbName)];case 2:_a.sent();_a.label=3;case 3:return[2]}})})};IndexedDbPersistence.prototype.filterActiveClients=function(clients,activityThresholdMs){var _this=this;return clients.filter(function(client){return _this.isWithinAge(client.updateTimeMs,activityThresholdMs)&&!_this.isClientZombied(client.clientId)})};IndexedDbPersistence.prototype.getActiveClients=function(){var _this=this;return this.simpleDb.runTransaction("readonly",[DbClientMetadata.store],function(txn){return clientMetadataStore(txn).loadAll().next(function(clients){return _this.filterActiveClients(clients,MAX_CLIENT_AGE_MS).map(function(clientMetadata){return clientMetadata.clientId})})})};Object.defineProperty(IndexedDbPersistence.prototype,"started",{get:function(){return this._started},enumerable:true,configurable:true});IndexedDbPersistence.prototype.getMutationQueue=function(user){assert(this.started,"Cannot initialize MutationQueue before persistence is started.");return IndexedDbMutationQueue.forUser(user,this.serializer,this.indexManager,this.referenceDelegate)};IndexedDbPersistence.prototype.getQueryCache=function(){assert(this.started,"Cannot initialize QueryCache before persistence is started.");return this.queryCache};IndexedDbPersistence.prototype.getRemoteDocumentCache=function(){assert(this.started,"Cannot initialize RemoteDocumentCache before persistence is started.");return this.remoteDocumentCache};IndexedDbPersistence.prototype.getIndexManager=function(){assert(this.started,"Cannot initialize IndexManager before persistence is started.");return this.indexManager};IndexedDbPersistence.prototype.runTransaction=function(action,mode,transactionOperation){var _this=this;debug(LOG_TAG$2,"Starting transaction:",action);return this.simpleDb.runTransaction(mode==="readonly"?"readonly":"readwrite",ALL_STORES,function(simpleDbTxn){if(mode==="readwrite-primary"){return _this.verifyPrimaryLease(simpleDbTxn).next(function(success){if(!success){error("Failed to obtain primary lease for action '"+action+"'.");_this.isPrimary=false;_this.queue.enqueueAndForget(function(){return _this.primaryStateListener(false)});throw new FirestoreError(Code.FAILED_PRECONDITION,PRIMARY_LEASE_LOST_ERROR_MSG)}return transactionOperation(new IndexedDbTransaction(simpleDbTxn,_this.listenSequence.next()))}).next(function(result){return _this.acquireOrExtendPrimaryLease(simpleDbTxn).next(function(){return result})})}else{return _this.verifyAllowTabSynchronization(simpleDbTxn).next(function(){return transactionOperation(new IndexedDbTransaction(simpleDbTxn,_this.listenSequence.next()))})}})};IndexedDbPersistence.prototype.verifyAllowTabSynchronization=function(txn){var _this=this;var store=primaryClientStore(txn);return store.get(DbPrimaryClient.key).next(function(currentPrimary){var currentLeaseIsValid=currentPrimary!==null&&_this.isWithinAge(currentPrimary.leaseTimestampMs,MAX_PRIMARY_ELIGIBLE_AGE_MS)&&!_this.isClientZombied(currentPrimary.ownerId);if(currentLeaseIsValid&&!_this.isLocalClient(currentPrimary)){if(!currentPrimary.allowTabSynchronization){throw new FirestoreError(Code.FAILED_PRECONDITION,PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG)}}})};IndexedDbPersistence.prototype.acquireOrExtendPrimaryLease=function(txn){var newPrimary=new DbPrimaryClient(this.clientId,this.allowTabSynchronization,Date.now());return primaryClientStore(txn).put(DbPrimaryClient.key,newPrimary)};IndexedDbPersistence.isAvailable=function(){return SimpleDb.isAvailable()};IndexedDbPersistence.buildStoragePrefix=function(databaseInfo){var database=databaseInfo.databaseId.projectId;if(!databaseInfo.databaseId.isDefaultDatabase){database+="."+databaseInfo.databaseId.database}return"firestore/"+databaseInfo.persistenceKey+"/"+database+"/"};IndexedDbPersistence.prototype.releasePrimaryLeaseIfHeld=function(txn){var _this=this;var store=primaryClientStore(txn);return store.get(DbPrimaryClient.key).next(function(primaryClient){if(_this.isLocalClient(primaryClient)){debug(LOG_TAG$2,"Releasing primary lease.");return store.delete(DbPrimaryClient.key)}else{return PersistencePromise.resolve()}})};IndexedDbPersistence.prototype.isWithinAge=function(updateTimeMs,maxAgeMs){var now=Date.now();var minAcceptable=now-maxAgeMs;var maxAcceptable=now;if(updateTimeMs<minAcceptable){return false}else if(updateTimeMs>maxAcceptable){error("Detected an update time that is in the future: "+updateTimeMs+" > "+maxAcceptable);return false}return true};IndexedDbPersistence.prototype.attachVisibilityHandler=function(){var _this=this;if(this.document!==null&&typeof this.document.addEventListener==="function"){this.documentVisibilityHandler=function(){_this.queue.enqueueAndForget(function(){_this.inForeground=_this.document.visibilityState==="visible";return _this.updateClientMetadataAndTryBecomePrimary()})};this.document.addEventListener("visibilitychange",this.documentVisibilityHandler);this.inForeground=this.document.visibilityState==="visible"}};IndexedDbPersistence.prototype.detachVisibilityHandler=function(){if(this.documentVisibilityHandler){assert(this.document!==null&&typeof this.document.addEventListener==="function","Expected 'document.addEventListener' to be a function");this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler);this.documentVisibilityHandler=null}};IndexedDbPersistence.prototype.attachWindowUnloadHook=function(){var _this=this;if(typeof this.window.addEventListener==="function"){this.windowUnloadHandler=function(){_this.markClientZombied();_this.queue.enqueueAndForget(function(){return _this.shutdown()})};this.window.addEventListener("unload",this.windowUnloadHandler)}};IndexedDbPersistence.prototype.detachWindowUnloadHook=function(){if(this.windowUnloadHandler){assert(typeof this.window.removeEventListener==="function","Expected 'window.removeEventListener' to be a function");this.window.removeEventListener("unload",this.windowUnloadHandler);this.windowUnloadHandler=null}};IndexedDbPersistence.prototype.isClientZombied=function(clientId){try{var isZombied=this.webStorage.getItem(this.zombiedClientLocalStorageKey(clientId))!==null;debug(LOG_TAG$2,"Client '"+clientId+"' "+(isZombied?"is":"is not")+" zombied in LocalStorage");return isZombied}catch(e){error(LOG_TAG$2,"Failed to get zombied client id.",e);return false}};IndexedDbPersistence.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(e){error("Failed to set zombie client id.",e)}};IndexedDbPersistence.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(e){}};IndexedDbPersistence.prototype.zombiedClientLocalStorageKey=function(clientId){return ZOMBIED_CLIENTS_KEY_PREFIX+"_"+this.persistenceKey+"_"+clientId};IndexedDbPersistence.MAIN_DATABASE="main";return IndexedDbPersistence}();function isPrimaryLeaseLostError(err){return err.code===Code.FAILED_PRECONDITION&&err.message===PRIMARY_LEASE_LOST_ERROR_MSG}function ignoreIfPrimaryLeaseLoss(err){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(isPrimaryLeaseLostError(err)){debug(LOG_TAG$2,"Unexpectedly lost primary lease")}else{throw err}return[2]})})}function primaryClientStore(txn){return txn.store(DbPrimaryClient.store)}function clientMetadataStore(txn){return txn.store(DbClientMetadata.store)}var IndexedDbLruDelegate=function(){function IndexedDbLruDelegate(db,params){this.db=db;this.garbageCollector=new LruGarbageCollector(this,params)}IndexedDbLruDelegate.prototype.getSequenceNumberCount=function(txn){var docCountPromise=this.orphanedDocmentCount(txn);var targetCountPromise=this.db.getQueryCache().getQueryCount(txn);return targetCountPromise.next(function(targetCount){return docCountPromise.next(function(docCount){return targetCount+docCount})})};IndexedDbLruDelegate.prototype.orphanedDocmentCount=function(txn){var orphanedCount=0;return this.forEachOrphanedDocumentSequenceNumber(txn,function(_){orphanedCount++}).next(function(){return orphanedCount})};IndexedDbLruDelegate.prototype.forEachTarget=function(txn,f){return this.db.getQueryCache().forEachTarget(txn,f)};IndexedDbLruDelegate.prototype.forEachOrphanedDocumentSequenceNumber=function(txn,f){return this.forEachOrphanedDocument(txn,function(docKey,sequenceNumber){return f(sequenceNumber)})};IndexedDbLruDelegate.prototype.setInMemoryPins=function(inMemoryPins){this.inMemoryPins=inMemoryPins};IndexedDbLruDelegate.prototype.addReference=function(txn,key){return writeSentinelKey(txn,key)};IndexedDbLruDelegate.prototype.removeReference=function(txn,key){return writeSentinelKey(txn,key)};IndexedDbLruDelegate.prototype.removeTargets=function(txn,upperBound,activeTargetIds){return this.db.getQueryCache().removeTargets(txn,upperBound,activeTargetIds)};IndexedDbLruDelegate.prototype.removeMutationReference=function(txn,key){return writeSentinelKey(txn,key)};IndexedDbLruDelegate.prototype.isPinned=function(txn,docKey){if(this.inMemoryPins.containsKey(docKey)){return PersistencePromise.resolve(true)}else{return mutationQueuesContainKey(txn,docKey)}};IndexedDbLruDelegate.prototype.removeOrphanedDocuments=function(txn,upperBound){var _this=this;var count=0;var bytesRemoved=0;var promises=[];var iteration=this.forEachOrphanedDocument(txn,function(docKey,sequenceNumber){if(sequenceNumber<=upperBound){var p=_this.isPinned(txn,docKey).next(function(isPinned){if(!isPinned){count++;return _this.removeOrphanedDocument(txn,docKey).next(function(documentBytes){bytesRemoved+=documentBytes})}});promises.push(p)}});return iteration.next(function(){return PersistencePromise.waitFor(promises)}).next(function(){return _this.db.getRemoteDocumentCache().updateSize(txn,-bytesRemoved)}).next(function(){return count})};IndexedDbLruDelegate.prototype.removeOrphanedDocument=function(txn,docKey){var totalBytesRemoved=0;var documentCache=this.db.getRemoteDocumentCache();return PersistencePromise.waitFor([documentTargetStore(txn).delete(sentinelKey$1(docKey)),documentCache.removeEntry(txn,docKey).next(function(bytesRemoved){totalBytesRemoved+=bytesRemoved})]).next(function(){return totalBytesRemoved})};IndexedDbLruDelegate.prototype.removeTarget=function(txn,queryData){var updated=queryData.copy({sequenceNumber:txn.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(txn,updated)};IndexedDbLruDelegate.prototype.updateLimboDocument=function(txn,key){return writeSentinelKey(txn,key)};IndexedDbLruDelegate.prototype.forEachOrphanedDocument=function(txn,f){var store=documentTargetStore(txn);var nextToReport=ListenSequence.INVALID;var nextPath;return store.iterate({index:DbTargetDocument.documentTargetsIndex},function(_a,_b){var targetId=_a[0],docKey=_a[1];var path=_b.path,sequenceNumber=_b.sequenceNumber;if(targetId===0){if(nextToReport!==ListenSequence.INVALID){f(new DocumentKey(decode(nextPath)),nextToReport)}nextToReport=sequenceNumber;nextPath=path}else{nextToReport=ListenSequence.INVALID}}).next(function(){if(nextToReport!==ListenSequence.INVALID){f(new DocumentKey(decode(nextPath)),nextToReport)}})};IndexedDbLruDelegate.prototype.getCacheSize=function(txn){return this.db.getRemoteDocumentCache().getSize(txn)};return IndexedDbLruDelegate}();function sentinelKey$1(key){return[0,encode(key.path)]}function sentinelRow(key,sequenceNumber){return new DbTargetDocument(0,encode(key.path),sequenceNumber)}function writeSentinelKey(txn,key){return documentTargetStore(txn).put(sentinelRow(key,txn.currentSequenceNumber))}var LocalDocumentsView=function(){function LocalDocumentsView(remoteDocumentCache,mutationQueue,indexManager){this.remoteDocumentCache=remoteDocumentCache;this.mutationQueue=mutationQueue;this.indexManager=indexManager}LocalDocumentsView.prototype.getDocument=function(transaction,key){var _this=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(transaction,key).next(function(batches){return _this.getDocumentInternal(transaction,key,batches)})};LocalDocumentsView.prototype.getDocumentInternal=function(transaction,key,inBatches){return this.remoteDocumentCache.getEntry(transaction,key).next(function(doc){for(var _i=0,inBatches_1=inBatches;_i<inBatches_1.length;_i++){var batch=inBatches_1[_i];doc=batch.applyToLocalView(key,doc)}return doc})};LocalDocumentsView.prototype.applyLocalMutationsToDocuments=function(transaction,docs,batches){var results=nullableMaybeDocumentMap();docs.forEach(function(key,localView){for(var _i=0,batches_1=batches;_i<batches_1.length;_i++){var batch=batches_1[_i];localView=batch.applyToLocalView(key,localView)}results=results.insert(key,localView)});return results};LocalDocumentsView.prototype.getDocuments=function(transaction,keys){var _this=this;return this.remoteDocumentCache.getEntries(transaction,keys).next(function(docs){return _this.getLocalViewOfDocuments(transaction,docs)})};LocalDocumentsView.prototype.getLocalViewOfDocuments=function(transaction,baseDocs){var _this=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(transaction,baseDocs).next(function(batches){var docs=_this.applyLocalMutationsToDocuments(transaction,baseDocs,batches);var results=maybeDocumentMap();docs.forEach(function(key,maybeDoc){if(!maybeDoc){maybeDoc=new NoDocument(key,SnapshotVersion.forDeletedDoc())}results=results.insert(key,maybeDoc)});return results})};LocalDocumentsView.prototype.getDocumentsMatchingQuery=function(transaction,query){if(query.isDocumentQuery()){return this.getDocumentsMatchingDocumentQuery(transaction,query.path)}else if(query.isCollectionGroupQuery()){return this.getDocumentsMatchingCollectionGroupQuery(transaction,query)}else{return this.getDocumentsMatchingCollectionQuery(transaction,query)}};LocalDocumentsView.prototype.getDocumentsMatchingDocumentQuery=function(transaction,docPath){return this.getDocument(transaction,new DocumentKey(docPath)).next(function(maybeDoc){var result=documentMap();if(maybeDoc instanceof Document){result=result.insert(maybeDoc.key,maybeDoc)}return result})};LocalDocumentsView.prototype.getDocumentsMatchingCollectionGroupQuery=function(transaction,query){var _this=this;assert(query.path.isEmpty(),"Currently we only support collection group queries at the root.");var collectionId=query.collectionGroup;var results=documentMap();return this.indexManager.getCollectionParents(transaction,collectionId).next(function(parents){return PersistencePromise.forEach(parents,function(parent){var collectionQuery=query.asCollectionQueryAtPath(parent.child(collectionId));return _this.getDocumentsMatchingCollectionQuery(transaction,collectionQuery).next(function(r){r.forEach(function(key,doc){results=results.insert(key,doc)})})}).next(function(){return results})})};LocalDocumentsView.prototype.getDocumentsMatchingCollectionQuery=function(transaction,query){var _this=this;var results;return this.remoteDocumentCache.getDocumentsMatchingQuery(transaction,query).next(function(queryResults){results=queryResults;return _this.mutationQueue.getAllMutationBatchesAffectingQuery(transaction,query)}).next(function(matchingMutationBatches){for(var _i=0,matchingMutationBatches_1=matchingMutationBatches;_i<matchingMutationBatches_1.length;_i++){var batch=matchingMutationBatches_1[_i];for(var _a=0,_b=batch.mutations;_a<_b.length;_a++){var mutation=_b[_a];var key=mutation.key;if(!query.path.isImmediateParentOf(key.path)){continue}var baseDoc=results.get(key);var mutatedDoc=mutation.applyToLocalView(baseDoc,baseDoc,batch.localWriteTime);if(mutatedDoc instanceof Document){results=results.insert(key,mutatedDoc)}else{results=results.remove(key)}}}}).next(function(){results.forEach(function(key,doc){if(!query.matches(doc)){results=results.remove(key)}});return results})};return LocalDocumentsView}();var ReferenceSet=function(){function ReferenceSet(){this.refsByKey=new SortedSet(DocReference.compareByKey);this.refsByTarget=new SortedSet(DocReference.compareByTargetId)}ReferenceSet.prototype.isEmpty=function(){return this.refsByKey.isEmpty()};ReferenceSet.prototype.addReference=function(key,id){var ref=new DocReference(key,id);this.refsByKey=this.refsByKey.add(ref);this.refsByTarget=this.refsByTarget.add(ref)};ReferenceSet.prototype.addReferences=function(keys,id){var _this=this;keys.forEach(function(key){return _this.addReference(key,id)})};ReferenceSet.prototype.removeReference=function(key,id){this.removeRef(new DocReference(key,id))};ReferenceSet.prototype.removeReferences=function(keys,id){var _this=this;keys.forEach(function(key){return _this.removeReference(key,id)})};ReferenceSet.prototype.removeReferencesForId=function(id){var _this=this;var emptyKey=DocumentKey.EMPTY;var startRef=new DocReference(emptyKey,id);var endRef=new DocReference(emptyKey,id+1);var keys=[];this.refsByTarget.forEachInRange([startRef,endRef],function(ref){_this.removeRef(ref);keys.push(ref.key)});return keys};ReferenceSet.prototype.removeAllReferences=function(){var _this=this;this.refsByKey.forEach(function(ref){return _this.removeRef(ref)})};ReferenceSet.prototype.removeRef=function(ref){this.refsByKey=this.refsByKey.delete(ref);this.refsByTarget=this.refsByTarget.delete(ref)};ReferenceSet.prototype.referencesForId=function(id){var emptyKey=DocumentKey.EMPTY;var startRef=new DocReference(emptyKey,id);var endRef=new DocReference(emptyKey,id+1);var keys=documentKeySet();this.refsByTarget.forEachInRange([startRef,endRef],function(ref){keys=keys.add(ref.key)});return keys};ReferenceSet.prototype.containsKey=function(key){var ref=new DocReference(key,0);var firstRef=this.refsByKey.firstAfterOrEqual(ref);return firstRef!==null&&key.isEqual(firstRef.key)};return ReferenceSet}();var DocReference=function(){function DocReference(key,targetOrBatchId){this.key=key;this.targetOrBatchId=targetOrBatchId}DocReference.compareByKey=function(left,right){return DocumentKey.comparator(left.key,right.key)||primitiveComparator(left.targetOrBatchId,right.targetOrBatchId)};DocReference.compareByTargetId=function(left,right){return primitiveComparator(left.targetOrBatchId,right.targetOrBatchId)||DocumentKey.comparator(left.key,right.key)};return DocReference}();var LOG_TAG$3="LocalStore";var LocalStore=function(){function LocalStore(persistence,initialUser){this.persistence=persistence;this.localViewReferences=new ReferenceSet;this.queryDataByTarget={};assert(persistence.started,"LocalStore was passed an unstarted persistence implementation");this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences);this.mutationQueue=persistence.getMutationQueue(initialUser);this.remoteDocuments=persistence.getRemoteDocumentCache();this.queryCache=persistence.getQueryCache();this.localDocuments=new LocalDocumentsView(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}LocalStore.prototype.handleUserChange=function(user){var _this=this;return this.persistence.runTransaction("Handle user change","readonly",function(txn){var oldBatches;return _this.mutationQueue.getAllMutationBatches(txn).next(function(promisedOldBatches){oldBatches=promisedOldBatches;_this.mutationQueue=_this.persistence.getMutationQueue(user);_this.localDocuments=new LocalDocumentsView(_this.remoteDocuments,_this.mutationQueue,_this.persistence.getIndexManager());return _this.mutationQueue.getAllMutationBatches(txn)}).next(function(newBatches){var removedBatchIds=[];var addedBatchIds=[];var changedKeys=documentKeySet();for(var _i=0,oldBatches_1=oldBatches;_i<oldBatches_1.length;_i++){var batch=oldBatches_1[_i];removedBatchIds.push(batch.batchId);for(var _a=0,_b=batch.mutations;_a<_b.length;_a++){var mutation=_b[_a];changedKeys=changedKeys.add(mutation.key)}}for(var _c=0,newBatches_1=newBatches;_c<newBatches_1.length;_c++){var batch=newBatches_1[_c];addedBatchIds.push(batch.batchId);for(var _d=0,_e=batch.mutations;_d<_e.length;_d++){var mutation=_e[_d];changedKeys=changedKeys.add(mutation.key)}}return _this.localDocuments.getDocuments(txn,changedKeys).next(function(affectedDocuments){return{affectedDocuments:affectedDocuments,removedBatchIds:removedBatchIds,addedBatchIds:addedBatchIds}})})})};LocalStore.prototype.localWrite=function(mutations){var _this=this;var localWriteTime=Timestamp.now();var keys=mutations.reduce(function(keys,m){return keys.add(m.key)},documentKeySet());return this.persistence.runTransaction("Locally write mutations","readwrite",function(txn){return _this.localDocuments.getDocuments(txn,keys).next(function(existingDocs){var baseMutations=[];for(var _i=0,mutations_1=mutations;_i<mutations_1.length;_i++){var mutation=mutations_1[_i];var maybeDoc=existingDocs.get(mutation.key);if(!mutation.isIdempotent){var fieldMask=mutation.fieldMask;if(fieldMask){var baseValues=maybeDoc instanceof Document?fieldMask.applyTo(maybeDoc.data):ObjectValue.EMPTY;baseMutations.push(new PatchMutation(mutation.key,baseValues,fieldMask,Precondition.exists(true)))}}}return _this.mutationQueue.addMutationBatch(txn,localWriteTime,baseMutations,mutations).next(function(batch){var changes=batch.applyToLocalDocumentSet(existingDocs);return{batchId:batch.batchId,changes:changes}})})})};LocalStore.prototype.lookupMutationDocuments=function(batchId){var _this=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(txn){return _this.mutationQueue.lookupMutationKeys(txn,batchId).next(function(keys){if(keys){return _this.localDocuments.getDocuments(txn,keys)}else{return PersistencePromise.resolve(null)}})})};LocalStore.prototype.acknowledgeBatch=function(batchResult){var _this=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(txn){var affected=batchResult.batch.keys();var documentBuffer=_this.remoteDocuments.newChangeBuffer();return _this.mutationQueue.acknowledgeBatch(txn,batchResult.batch,batchResult.streamToken).next(function(){return _this.applyWriteToRemoteDocuments(txn,batchResult,documentBuffer)}).next(function(){return documentBuffer.apply(txn)}).next(function(){return _this.mutationQueue.performConsistencyCheck(txn)}).next(function(){return _this.localDocuments.getDocuments(txn,affected)})})};LocalStore.prototype.rejectBatch=function(batchId){var _this=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(txn){var affectedKeys;return _this.mutationQueue.lookupMutationBatch(txn,batchId).next(function(batch){assert(batch!==null,"Attempt to reject nonexistent batch!");affectedKeys=batch.keys();return _this.mutationQueue.removeMutationBatch(txn,batch)}).next(function(){return _this.mutationQueue.performConsistencyCheck(txn)}).next(function(){return _this.localDocuments.getDocuments(txn,affectedKeys)})})};LocalStore.prototype.getLastStreamToken=function(){var _this=this;return this.persistence.runTransaction("Get last stream token","readonly",function(txn){return _this.mutationQueue.getLastStreamToken(txn)})};LocalStore.prototype.setLastStreamToken=function(streamToken){var _this=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(txn){return _this.mutationQueue.setLastStreamToken(txn,streamToken)})};LocalStore.prototype.getLastRemoteSnapshotVersion=function(){var _this=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(txn){return _this.queryCache.getLastRemoteSnapshotVersion(txn)})};LocalStore.prototype.applyRemoteEvent=function(remoteEvent){var _this=this;var documentBuffer=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(txn){var promises=[];var authoritativeUpdates=documentKeySet();forEachNumber(remoteEvent.targetChanges,function(targetId,change){var queryData=_this.queryDataByTarget[targetId];if(!queryData)return;change.addedDocuments.forEach(function(key){authoritativeUpdates=authoritativeUpdates.add(key)});change.modifiedDocuments.forEach(function(key){authoritativeUpdates=authoritativeUpdates.add(key)});promises.push(_this.queryCache.removeMatchingKeys(txn,change.removedDocuments,targetId).next(function(){return _this.queryCache.addMatchingKeys(txn,change.addedDocuments,targetId)}));var resumeToken=change.resumeToken;if(resumeToken.length>0){var oldQueryData=queryData;queryData=queryData.copy({resumeToken:resumeToken,snapshotVersion:remoteEvent.snapshotVersion});_this.queryDataByTarget[targetId]=queryData;if(LocalStore.shouldPersistQueryData(oldQueryData,queryData,change)){promises.push(_this.queryCache.updateQueryData(txn,queryData))}}});var changedDocs=maybeDocumentMap();var updatedKeys=documentKeySet();remoteEvent.documentUpdates.forEach(function(key,doc){updatedKeys=updatedKeys.add(key)});promises.push(documentBuffer.getEntries(txn,updatedKeys).next(function(existingDocs){remoteEvent.documentUpdates.forEach(function(key,doc){var existingDoc=existingDocs.get(key);if(existingDoc==null||doc.version.isEqual(SnapshotVersion.MIN)||authoritativeUpdates.has(doc.key)&&!existingDoc.hasPendingWrites||doc.version.compareTo(existingDoc.version)>=0){documentBuffer.addEntry(doc);changedDocs=changedDocs.insert(key,doc)}else{debug(LOG_TAG$3,"Ignoring outdated watch update for ",key,". Current version:",existingDoc.version," Watch version:",doc.version)}if(remoteEvent.resolvedLimboDocuments.has(key)){promises.push(_this.persistence.referenceDelegate.updateLimboDocument(txn,key))}})}));var remoteVersion=remoteEvent.snapshotVersion;if(!remoteVersion.isEqual(SnapshotVersion.MIN)){var updateRemoteVersion=_this.queryCache.getLastRemoteSnapshotVersion(txn).next(function(lastRemoteVersion){assert(remoteVersion.compareTo(lastRemoteVersion)>=0,"Watch stream reverted to previous snapshot?? "+remoteVersion+" < "+lastRemoteVersion);return _this.queryCache.setTargetsMetadata(txn,txn.currentSequenceNumber,remoteVersion)});promises.push(updateRemoteVersion)}return PersistencePromise.waitFor(promises).next(function(){return documentBuffer.apply(txn)}).next(function(){return _this.localDocuments.getLocalViewOfDocuments(txn,changedDocs)})})};LocalStore.shouldPersistQueryData=function(oldQueryData,newQueryData,change){if(newQueryData.resumeToken.length===0)return false;if(oldQueryData.resumeToken.length===0)return true;var timeDelta=newQueryData.snapshotVersion.toMicroseconds()-oldQueryData.snapshotVersion.toMicroseconds();if(timeDelta>=this.RESUME_TOKEN_MAX_AGE_MICROS)return true;var changes=change.addedDocuments.size+change.modifiedDocuments.size+change.removedDocuments.size;return changes>0};LocalStore.prototype.notifyLocalViewChanges=function(viewChanges){var _this=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(txn){return PersistencePromise.forEach(viewChanges,function(viewChange){_this.localViewReferences.addReferences(viewChange.addedKeys,viewChange.targetId);_this.localViewReferences.removeReferences(viewChange.removedKeys,viewChange.targetId);return PersistencePromise.forEach(viewChange.removedKeys,function(key){return _this.persistence.referenceDelegate.removeReference(txn,key)})})})};LocalStore.prototype.nextMutationBatch=function(afterBatchId){var _this=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(txn){if(afterBatchId===undefined){afterBatchId=BATCHID_UNKNOWN}return _this.mutationQueue.getNextMutationBatchAfterBatchId(txn,afterBatchId)})};LocalStore.prototype.readDocument=function(key){var _this=this;return this.persistence.runTransaction("read document","readonly",function(txn){return _this.localDocuments.getDocument(txn,key)})};LocalStore.prototype.allocateQuery=function(query){var _this=this;return this.persistence.runTransaction("Allocate query","readwrite",function(txn){var queryData;return _this.queryCache.getQueryData(txn,query).next(function(cached){if(cached){queryData=cached;return PersistencePromise.resolve()}else{return _this.queryCache.allocateTargetId(txn).next(function(targetId){queryData=new QueryData(query,targetId,QueryPurpose.Listen,txn.currentSequenceNumber);return _this.queryCache.addQueryData(txn,queryData)})}}).next(function(){assert(!_this.queryDataByTarget[queryData.targetId],"Tried to allocate an already allocated query: "+query);_this.queryDataByTarget[queryData.targetId]=queryData;return queryData})})};LocalStore.prototype.releaseQuery=function(query,keepPersistedQueryData){var _this=this;var mode=keepPersistedQueryData?"readwrite":"readwrite-primary";return this.persistence.runTransaction("Release query",mode,function(txn){return _this.queryCache.getQueryData(txn,query).next(function(queryData){assert(queryData!=null,"Tried to release nonexistent query: "+query);var targetId=queryData.targetId;var cachedQueryData=_this.queryDataByTarget[targetId];var removed=_this.localViewReferences.removeReferencesForId(targetId);delete _this.queryDataByTarget[targetId];if(!keepPersistedQueryData){return PersistencePromise.forEach(removed,function(key){return _this.persistence.referenceDelegate.removeReference(txn,key)}).next(function(){return _this.persistence.referenceDelegate.removeTarget(txn,cachedQueryData)})}else{return PersistencePromise.resolve()}})})};LocalStore.prototype.executeQuery=function(query){var _this=this;return this.persistence.runTransaction("Execute query","readonly",function(txn){return _this.localDocuments.getDocumentsMatchingQuery(txn,query)})};LocalStore.prototype.remoteDocumentKeys=function(targetId){var _this=this;return this.persistence.runTransaction("Remote document keys","readonly",function(txn){return _this.queryCache.getMatchingKeysForTargetId(txn,targetId)})};LocalStore.prototype.getActiveClients=function(){return this.persistence.getActiveClients()};LocalStore.prototype.removeCachedMutationBatchMetadata=function(batchId){this.mutationQueue.removeCachedMutationKeys(batchId)};LocalStore.prototype.setNetworkEnabled=function(networkEnabled){this.persistence.setNetworkEnabled(networkEnabled)};LocalStore.prototype.applyWriteToRemoteDocuments=function(txn,batchResult,documentBuffer){var _this=this;var batch=batchResult.batch;var docKeys=batch.keys();var promiseChain=PersistencePromise.resolve();docKeys.forEach(function(docKey){promiseChain=promiseChain.next(function(){return documentBuffer.getEntry(txn,docKey)}).next(function(remoteDoc){var doc=remoteDoc;var ackVersion=batchResult.docVersions.get(docKey);assert(ackVersion!==null,"ackVersions should contain every doc in the write.");if(!doc||doc.version.compareTo(ackVersion)<0){doc=batch.applyToRemoteDocument(docKey,doc,batchResult);if(!doc){assert(!remoteDoc,"Mutation batch "+batch+" applied to document "+remoteDoc+" resulted in null")}else{documentBuffer.addEntry(doc)}}})});return promiseChain.next(function(){return _this.mutationQueue.removeMutationBatch(txn,batch)})};LocalStore.prototype.collectGarbage=function(garbageCollector){var _this=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(txn){return garbageCollector.collect(txn,_this.queryDataByTarget)})};LocalStore.prototype.getQueryForTarget=function(targetId){var _this=this;if(this.queryDataByTarget[targetId]){return Promise.resolve(this.queryDataByTarget[targetId].query)}else{return this.persistence.runTransaction("Get query data","readonly",function(txn){return _this.queryCache.getQueryDataForTarget(txn,targetId).next(function(queryData){return queryData?queryData.query:null})})}};LocalStore.prototype.getNewDocumentChanges=function(){var _this=this;return this.persistence.runTransaction("Get new document changes","readonly",function(txn){return _this.remoteDocuments.getNewDocumentChanges(txn)})};LocalStore.RESUME_TOKEN_MAX_AGE_MICROS=5*60*1e6;return LocalStore}();var MemoryMutationQueue=function(){function MemoryMutationQueue(indexManager,referenceDelegate){this.indexManager=indexManager;this.referenceDelegate=referenceDelegate;this.mutationQueue=[];this.nextBatchId=1;this.lastStreamToken=emptyByteString();this.batchesByDocumentKey=new SortedSet(DocReference.compareByKey)}MemoryMutationQueue.prototype.checkEmpty=function(transaction){return PersistencePromise.resolve(this.mutationQueue.length===0)};MemoryMutationQueue.prototype.acknowledgeBatch=function(transaction,batch,streamToken){var batchId=batch.batchId;var batchIndex=this.indexOfExistingBatchId(batchId,"acknowledged");assert(batchIndex===0,"Can only acknowledge the first batch in the mutation queue");var check=this.mutationQueue[batchIndex];assert(batchId===check.batchId,"Queue ordering failure: expected batch "+batchId+", got batch "+check.batchId);this.lastStreamToken=streamToken;return PersistencePromise.resolve()};MemoryMutationQueue.prototype.getLastStreamToken=function(transaction){return PersistencePromise.resolve(this.lastStreamToken)};MemoryMutationQueue.prototype.setLastStreamToken=function(transaction,streamToken){this.lastStreamToken=streamToken;return PersistencePromise.resolve()};MemoryMutationQueue.prototype.addMutationBatch=function(transaction,localWriteTime,baseMutations,mutations){assert(mutations.length!==0,"Mutation batches should not be empty");var batchId=this.nextBatchId;this.nextBatchId++;if(this.mutationQueue.length>0){var prior=this.mutationQueue[this.mutationQueue.length-1];assert(prior.batchId<batchId,"Mutation batchIDs must be monotonically increasing order")}var batch=new MutationBatch(batchId,localWriteTime,baseMutations,mutations);this.mutationQueue.push(batch);for(var _i=0,mutations_1=mutations;_i<mutations_1.length;_i++){var mutation=mutations_1[_i];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new DocReference(mutation.key,batchId));this.indexManager.addToCollectionParentIndex(transaction,mutation.key.path.popLast())}return PersistencePromise.resolve(batch)};MemoryMutationQueue.prototype.lookupMutationBatch=function(transaction,batchId){return PersistencePromise.resolve(this.findMutationBatch(batchId))};MemoryMutationQueue.prototype.lookupMutationKeys=function(transaction,batchId){var mutationBatch=this.findMutationBatch(batchId);assert(mutationBatch!=null,"Failed to find local mutation batch.");return PersistencePromise.resolve(mutationBatch.keys())};MemoryMutationQueue.prototype.getNextMutationBatchAfterBatchId=function(transaction,batchId){var nextBatchId=batchId+1;var rawIndex=this.indexOfBatchId(nextBatchId);var index=rawIndex<0?0:rawIndex;return PersistencePromise.resolve(this.mutationQueue.length>index?this.mutationQueue[index]:null)};MemoryMutationQueue.prototype.getAllMutationBatches=function(transaction){return PersistencePromise.resolve(this.mutationQueue.slice())};MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(transaction,documentKey){var _this=this;var start=new DocReference(documentKey,0);var end=new DocReference(documentKey,Number.POSITIVE_INFINITY);var result=[];this.batchesByDocumentKey.forEachInRange([start,end],function(ref){assert(documentKey.isEqual(ref.key),"Should only iterate over a single key's batches");var batch=_this.findMutationBatch(ref.targetOrBatchId);assert(batch!==null,"Batches in the index must exist in the main table");result.push(batch)});return PersistencePromise.resolve(result)};MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(transaction,documentKeys){var _this=this;var uniqueBatchIDs=new SortedSet(primitiveComparator);documentKeys.forEach(function(documentKey){var start=new DocReference(documentKey,0);var end=new DocReference(documentKey,Number.POSITIVE_INFINITY);_this.batchesByDocumentKey.forEachInRange([start,end],function(ref){assert(documentKey.isEqual(ref.key),"For each key, should only iterate over a single key's batches");uniqueBatchIDs=uniqueBatchIDs.add(ref.targetOrBatchId)})});return PersistencePromise.resolve(this.findMutationBatches(uniqueBatchIDs))};MemoryMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(transaction,query){assert(!query.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var prefix=query.path;var immediateChildrenPathLength=prefix.length+1;var startPath=prefix;if(!DocumentKey.isDocumentKey(startPath)){startPath=startPath.child("")}var start=new DocReference(new DocumentKey(startPath),0);var uniqueBatchIDs=new SortedSet(primitiveComparator);this.batchesByDocumentKey.forEachWhile(function(ref){var rowKeyPath=ref.key.path;if(!prefix.isPrefixOf(rowKeyPath)){return false}else{if(rowKeyPath.length===immediateChildrenPathLength){uniqueBatchIDs=uniqueBatchIDs.add(ref.targetOrBatchId)}return true}},start);return PersistencePromise.resolve(this.findMutationBatches(uniqueBatchIDs))};MemoryMutationQueue.prototype.findMutationBatches=function(batchIDs){var _this=this;var result=[];batchIDs.forEach(function(batchId){var batch=_this.findMutationBatch(batchId);if(batch!==null){result.push(batch)}});return result};MemoryMutationQueue.prototype.removeMutationBatch=function(transaction,batch){var _this=this;var batchIndex=this.indexOfExistingBatchId(batch.batchId,"removed");assert(batchIndex===0,"Can only remove the first entry of the mutation queue");this.mutationQueue.shift();var references=this.batchesByDocumentKey;return PersistencePromise.forEach(batch.mutations,function(mutation){var ref=new DocReference(mutation.key,batch.batchId);references=references.delete(ref);return _this.referenceDelegate.removeMutationReference(transaction,mutation.key)}).next(function(){_this.batchesByDocumentKey=references})};MemoryMutationQueue.prototype.removeCachedMutationKeys=function(batchId){};MemoryMutationQueue.prototype.containsKey=function(txn,key){var ref=new DocReference(key,0);var firstRef=this.batchesByDocumentKey.firstAfterOrEqual(ref);return PersistencePromise.resolve(key.isEqual(firstRef&&firstRef.key))};MemoryMutationQueue.prototype.performConsistencyCheck=function(txn){if(this.mutationQueue.length===0){assert(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty.")}return PersistencePromise.resolve()};MemoryMutationQueue.prototype.indexOfExistingBatchId=function(batchId,action){var index=this.indexOfBatchId(batchId);assert(index>=0&&index<this.mutationQueue.length,"Batches must exist to be "+action);return index};MemoryMutationQueue.prototype.indexOfBatchId=function(batchId){if(this.mutationQueue.length===0){return 0}var firstBatchId=this.mutationQueue[0].batchId;return batchId-firstBatchId};MemoryMutationQueue.prototype.findMutationBatch=function(batchId){var index=this.indexOfBatchId(batchId);if(index<0||index>=this.mutationQueue.length){return null}var batch=this.mutationQueue[index];assert(batch.batchId===batchId,"If found batch must match");return batch};return MemoryMutationQueue}();var MemoryQueryCache=function(){function MemoryQueryCache(persistence){this.persistence=persistence;this.queries=new ObjectMap(function(q){return q.canonicalId()});this.lastRemoteSnapshotVersion=SnapshotVersion.MIN;this.highestTargetId=0;this.highestSequenceNumber=0;this.references=new ReferenceSet;this.targetCount=0;this.targetIdGenerator=TargetIdGenerator.forQueryCache()}MemoryQueryCache.prototype.getTargetCount=function(txn){return PersistencePromise.resolve(this.targetCount)};MemoryQueryCache.prototype.forEachTarget=function(txn,f){this.queries.forEach(function(_,queryData){return f(queryData)});return PersistencePromise.resolve()};MemoryQueryCache.prototype.getLastRemoteSnapshotVersion=function(transaction){return PersistencePromise.resolve(this.lastRemoteSnapshotVersion)};MemoryQueryCache.prototype.getHighestSequenceNumber=function(transaction){return PersistencePromise.resolve(this.highestSequenceNumber)};MemoryQueryCache.prototype.allocateTargetId=function(transaction){var nextTargetId=this.targetIdGenerator.after(this.highestTargetId);this.highestTargetId=nextTargetId;return PersistencePromise.resolve(nextTargetId)};MemoryQueryCache.prototype.setTargetsMetadata=function(transaction,highestListenSequenceNumber,lastRemoteSnapshotVersion){if(lastRemoteSnapshotVersion){this.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion}if(highestListenSequenceNumber>this.highestSequenceNumber){this.highestSequenceNumber=highestListenSequenceNumber}return PersistencePromise.resolve()};MemoryQueryCache.prototype.saveQueryData=function(queryData){this.queries.set(queryData.query,queryData);var targetId=queryData.targetId;if(targetId>this.highestTargetId){this.highestTargetId=targetId}if(queryData.sequenceNumber>this.highestSequenceNumber){this.highestSequenceNumber=queryData.sequenceNumber}};MemoryQueryCache.prototype.addQueryData=function(transaction,queryData){assert(!this.queries.has(queryData.query),"Adding a query that already exists");this.saveQueryData(queryData);this.targetCount+=1;return PersistencePromise.resolve()};MemoryQueryCache.prototype.updateQueryData=function(transaction,queryData){assert(this.queries.has(queryData.query),"Updating a non-existent query");this.saveQueryData(queryData);return PersistencePromise.resolve()};MemoryQueryCache.prototype.removeQueryData=function(transaction,queryData){assert(this.targetCount>0,"Removing a target from an empty cache");assert(this.queries.has(queryData.query),"Removing a non-existent target from the cache");this.queries.delete(queryData.query);this.references.removeReferencesForId(queryData.targetId);this.targetCount-=1;return PersistencePromise.resolve()};MemoryQueryCache.prototype.removeTargets=function(transaction,upperBound,activeTargetIds){var _this=this;var count=0;var removals=[];this.queries.forEach(function(key,queryData){if(queryData.sequenceNumber<=upperBound&&!activeTargetIds[queryData.targetId]){_this.queries.delete(key);removals.push(_this.removeMatchingKeysForTargetId(transaction,queryData.targetId));count++}});return PersistencePromise.waitFor(removals).next(function(){return count})};MemoryQueryCache.prototype.getQueryCount=function(transaction){return PersistencePromise.resolve(this.targetCount)};MemoryQueryCache.prototype.getQueryData=function(transaction,query){var queryData=this.queries.get(query)||null;return PersistencePromise.resolve(queryData)};MemoryQueryCache.prototype.getQueryDataForTarget=function(transaction,targetId){return fail("Not yet implemented.")};MemoryQueryCache.prototype.addMatchingKeys=function(txn,keys,targetId){this.references.addReferences(keys,targetId);var referenceDelegate=this.persistence.referenceDelegate;var promises=[];if(referenceDelegate){keys.forEach(function(key){promises.push(referenceDelegate.addReference(txn,key))})}return PersistencePromise.waitFor(promises)};MemoryQueryCache.prototype.removeMatchingKeys=function(txn,keys,targetId){this.references.removeReferences(keys,targetId);var referenceDelegate=this.persistence.referenceDelegate;var promises=[];if(referenceDelegate){keys.forEach(function(key){promises.push(referenceDelegate.removeReference(txn,key))})}return PersistencePromise.waitFor(promises)};MemoryQueryCache.prototype.removeMatchingKeysForTargetId=function(txn,targetId){this.references.removeReferencesForId(targetId);return PersistencePromise.resolve()};MemoryQueryCache.prototype.getMatchingKeysForTargetId=function(txn,targetId){var matchingKeys=this.references.referencesForId(targetId);return PersistencePromise.resolve(matchingKeys)};MemoryQueryCache.prototype.containsKey=function(txn,key){return PersistencePromise.resolve(this.references.containsKey(key))};return MemoryQueryCache}();function documentSizeMap(){return new SortedMap(DocumentKey.comparator)}var MemoryRemoteDocumentCache=function(){function MemoryRemoteDocumentCache(indexManager,sizer){this.indexManager=indexManager;this.sizer=sizer;this.docs=documentSizeMap();this.newDocumentChanges=documentKeySet();this.size=0}MemoryRemoteDocumentCache.prototype.addEntries=function(transaction,entries,sizeDelta){var promises=[];for(var _i=0,entries_1=entries;_i<entries_1.length;_i++){var entry=entries_1[_i];var key=entry.maybeDocument.key;this.docs=this.docs.insert(key,entry);this.newDocumentChanges=this.newDocumentChanges.add(key);promises.push(this.indexManager.addToCollectionParentIndex(transaction,key.path.popLast()))}this.size+=sizeDelta;return PersistencePromise.waitFor(promises)};MemoryRemoteDocumentCache.prototype.removeEntry=function(transaction,documentKey){var entry=this.docs.get(documentKey);if(entry){this.docs=this.docs.remove(documentKey);this.size-=entry.size;return PersistencePromise.resolve(entry.size)}else{return PersistencePromise.resolve(0)}};MemoryRemoteDocumentCache.prototype.getEntry=function(transaction,documentKey){var entry=this.docs.get(documentKey);return PersistencePromise.resolve(entry?entry.maybeDocument:null)};MemoryRemoteDocumentCache.prototype.getSizedEntry=function(transaction,documentKey){return PersistencePromise.resolve(this.docs.get(documentKey))};MemoryRemoteDocumentCache.prototype.getEntries=function(transaction,documentKeys){var _this=this;var results=nullableMaybeDocumentMap();documentKeys.forEach(function(documentKey){var entry=_this.docs.get(documentKey);results=results.insert(documentKey,entry?entry.maybeDocument:null)});return PersistencePromise.resolve(results)};MemoryRemoteDocumentCache.prototype.getSizedEntries=function(transaction,documentKeys){var _this=this;var results=nullableMaybeDocumentMap();var sizeMap=new SortedMap(DocumentKey.comparator);documentKeys.forEach(function(documentKey){var entry=_this.docs.get(documentKey);results=results.insert(documentKey,entry?entry.maybeDocument:null);sizeMap=sizeMap.insert(documentKey,entry?entry.size:0)});return PersistencePromise.resolve({maybeDocuments:results,sizeMap:sizeMap})};MemoryRemoteDocumentCache.prototype.getDocumentsMatchingQuery=function(transaction,query){assert(!query.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var results=documentMap();var prefix=new DocumentKey(query.path.child(""));var iterator=this.docs.getIteratorFrom(prefix);while(iterator.hasNext()){var _a=iterator.getNext(),key=_a.key,maybeDocument=_a.value.maybeDocument;if(!query.path.isPrefixOf(key.path)){break}if(maybeDocument instanceof Document&&query.matches(maybeDocument)){results=results.insert(maybeDocument.key,maybeDocument)}}return PersistencePromise.resolve(results)};MemoryRemoteDocumentCache.prototype.forEachDocumentKey=function(transaction,f){return PersistencePromise.forEach(this.docs,function(key){return f(key)})};MemoryRemoteDocumentCache.prototype.getNewDocumentChanges=function(transaction){var _this=this;var changedDocs=maybeDocumentMap();this.newDocumentChanges.forEach(function(key){var entry=_this.docs.get(key);var changedDoc=entry?entry.maybeDocument:new NoDocument(key,SnapshotVersion.forDeletedDoc());changedDocs=changedDocs.insert(key,changedDoc)});this.newDocumentChanges=documentKeySet();return PersistencePromise.resolve(changedDocs)};MemoryRemoteDocumentCache.prototype.newChangeBuffer=function(){return new MemoryRemoteDocumentChangeBuffer(this.sizer,this)};MemoryRemoteDocumentCache.prototype.getSize=function(txn){return PersistencePromise.resolve(this.size)};return MemoryRemoteDocumentCache}();var MemoryRemoteDocumentChangeBuffer=function(_super){tslib_1.__extends(MemoryRemoteDocumentChangeBuffer,_super);function MemoryRemoteDocumentChangeBuffer(sizer,documentCache){var _this=_super.call(this)||this;_this.sizer=sizer;_this.documentCache=documentCache;return _this}MemoryRemoteDocumentChangeBuffer.prototype.applyChanges=function(transaction){var _this=this;var changes=this.assertChanges();var delta=0;var docs=[];changes.forEach(function(key,maybeDocument){var previousSize=_this.documentSizes.get(key);assert(previousSize!==undefined,"Attempting to change document "+key.toString()+" without having read it first");var size=_this.sizer(maybeDocument);delta+=size-previousSize;docs.push({maybeDocument:maybeDocument,size:size})});return this.documentCache.addEntries(transaction,docs,delta)};MemoryRemoteDocumentChangeBuffer.prototype.getFromCache=function(transaction,documentKey){return this.documentCache.getSizedEntry(transaction,documentKey)};MemoryRemoteDocumentChangeBuffer.prototype.getAllFromCache=function(transaction,documentKeys){return this.documentCache.getSizedEntries(transaction,documentKeys)};return MemoryRemoteDocumentChangeBuffer}(RemoteDocumentChangeBuffer);var LOG_TAG$4="MemoryPersistence";var MemoryPersistence=function(){function MemoryPersistence(clientId,referenceDelegateFactory){var _this=this;this.clientId=clientId;this.mutationQueues={};this.listenSequence=new ListenSequence(0);this._started=false;this._started=true;this.referenceDelegate=referenceDelegateFactory(this);this.queryCache=new MemoryQueryCache(this);var sizer=function(doc){return _this.referenceDelegate.documentSize(doc)};this.indexManager=new MemoryIndexManager;this.remoteDocumentCache=new MemoryRemoteDocumentCache(this.indexManager,sizer)}MemoryPersistence.createLruPersistence=function(clientId,serializer,params){var factory=function(p){return new MemoryLruDelegate(p,new LocalSerializer(serializer),params)};return new MemoryPersistence(clientId,factory)};MemoryPersistence.createEagerPersistence=function(clientId){var factory=function(p){return new MemoryEagerDelegate(p)};return new MemoryPersistence(clientId,factory)};MemoryPersistence.prototype.shutdown=function(deleteData){this._started=false;return Promise.resolve()};Object.defineProperty(MemoryPersistence.prototype,"started",{get:function(){return this._started},enumerable:true,configurable:true});MemoryPersistence.prototype.getActiveClients=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return[2,[this.clientId]]})})};MemoryPersistence.prototype.setPrimaryStateListener=function(primaryStateListener){return primaryStateListener(true)};MemoryPersistence.prototype.setNetworkEnabled=function(networkEnabled){};MemoryPersistence.prototype.getIndexManager=function(){return this.indexManager};MemoryPersistence.prototype.getMutationQueue=function(user){var queue=this.mutationQueues[user.toKey()];if(!queue){queue=new MemoryMutationQueue(this.indexManager,this.referenceDelegate);this.mutationQueues[user.toKey()]=queue}return queue};MemoryPersistence.prototype.getQueryCache=function(){return this.queryCache};MemoryPersistence.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache};MemoryPersistence.prototype.runTransaction=function(action,mode,transactionOperation){var _this=this;debug(LOG_TAG$4,"Starting transaction:",action);var txn=new MemoryTransaction(this.listenSequence.next());this.referenceDelegate.onTransactionStarted();return transactionOperation(txn).next(function(result){return _this.referenceDelegate.onTransactionCommitted(txn).next(function(){return result})}).toPromise()};MemoryPersistence.prototype.mutationQueuesContainKey=function(transaction,key){return PersistencePromise.or(values(this.mutationQueues).map(function(queue){return function(){return queue.containsKey(transaction,key)}}))};return MemoryPersistence}();var MemoryTransaction=function(){function MemoryTransaction(currentSequenceNumber){this.currentSequenceNumber=currentSequenceNumber}return MemoryTransaction}();var MemoryEagerDelegate=function(){function MemoryEagerDelegate(persistence){this.persistence=persistence}MemoryEagerDelegate.prototype.setInMemoryPins=function(inMemoryPins){this.inMemoryPins=inMemoryPins};MemoryEagerDelegate.prototype.addReference=function(txn,key){this.orphanedDocuments.delete(key);return PersistencePromise.resolve()};MemoryEagerDelegate.prototype.removeReference=function(txn,key){this.orphanedDocuments.add(key);return PersistencePromise.resolve()};MemoryEagerDelegate.prototype.removeMutationReference=function(txn,key){this.orphanedDocuments.add(key);return PersistencePromise.resolve()};MemoryEagerDelegate.prototype.removeTarget=function(txn,queryData){var _this=this;var cache=this.persistence.getQueryCache();return cache.getMatchingKeysForTargetId(txn,queryData.targetId).next(function(keys){keys.forEach(function(key){return _this.orphanedDocuments.add(key)})}).next(function(){return cache.removeQueryData(txn,queryData)})};MemoryEagerDelegate.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set};MemoryEagerDelegate.prototype.onTransactionCommitted=function(txn){var _this=this;var cache=this.persistence.getRemoteDocumentCache();return PersistencePromise.forEach(this.orphanedDocuments,function(key){return _this.isReferenced(txn,key).next(function(isReferenced){if(!isReferenced){return cache.removeEntry(txn,key).next(function(){})}return PersistencePromise.resolve()})})};MemoryEagerDelegate.prototype.updateLimboDocument=function(txn,key){var _this=this;return this.isReferenced(txn,key).next(function(isReferenced){if(isReferenced){_this.orphanedDocuments.delete(key)}else{_this.orphanedDocuments.add(key)}})};MemoryEagerDelegate.prototype.documentSize=function(doc){return 0};MemoryEagerDelegate.prototype.isReferenced=function(txn,key){var _this=this;return PersistencePromise.or([function(){return _this.persistence.getQueryCache().containsKey(txn,key)},function(){return _this.persistence.mutationQueuesContainKey(txn,key)},function(){return PersistencePromise.resolve(_this.inMemoryPins.containsKey(key))}])};return MemoryEagerDelegate}();var MemoryLruDelegate=function(){function MemoryLruDelegate(persistence,serializer,lruParams){this.persistence=persistence;this.serializer=serializer;this.orphanedSequenceNumbers=new ObjectMap(function(k){return encode(k.path)});this.garbageCollector=new LruGarbageCollector(this,lruParams)}MemoryLruDelegate.prototype.onTransactionStarted=function(){};MemoryLruDelegate.prototype.onTransactionCommitted=function(txn){return PersistencePromise.resolve()};MemoryLruDelegate.prototype.forEachTarget=function(txn,f){return this.persistence.getQueryCache().forEachTarget(txn,f)};MemoryLruDelegate.prototype.getSequenceNumberCount=function(txn){var docCountPromise=this.orphanedDocumentCount(txn);var targetCountPromise=this.persistence.getQueryCache().getTargetCount(txn);return targetCountPromise.next(function(targetCount){return docCountPromise.next(function(docCount){return targetCount+docCount})})};MemoryLruDelegate.prototype.orphanedDocumentCount=function(txn){var orphanedCount=0;return this.forEachOrphanedDocumentSequenceNumber(txn,function(_){orphanedCount++}).next(function(){return orphanedCount})};MemoryLruDelegate.prototype.forEachOrphanedDocumentSequenceNumber=function(txn,f){var _this=this;return PersistencePromise.forEach(this.orphanedSequenceNumbers,function(key,sequenceNumber){return _this.isPinned(txn,key,sequenceNumber).next(function(isPinned){if(!isPinned){return f(sequenceNumber)}else{return PersistencePromise.resolve()}})})};MemoryLruDelegate.prototype.setInMemoryPins=function(inMemoryPins){this.inMemoryPins=inMemoryPins};MemoryLruDelegate.prototype.removeTargets=function(txn,upperBound,activeTargetIds){return this.persistence.getQueryCache().removeTargets(txn,upperBound,activeTargetIds)};MemoryLruDelegate.prototype.removeOrphanedDocuments=function(txn,upperBound){var _this=this;var count=0;var cache=this.persistence.getRemoteDocumentCache();var p=cache.forEachDocumentKey(txn,function(key){return _this.isPinned(txn,key,upperBound).next(function(isPinned){if(isPinned){return PersistencePromise.resolve()}else{count++;return cache.removeEntry(txn,key).next()}})});return p.next(function(){return count})};MemoryLruDelegate.prototype.removeMutationReference=function(txn,key){this.orphanedSequenceNumbers.set(key,txn.currentSequenceNumber);return PersistencePromise.resolve()};MemoryLruDelegate.prototype.removeTarget=function(txn,queryData){var updated=queryData.copy({sequenceNumber:txn.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(txn,updated)};MemoryLruDelegate.prototype.addReference=function(txn,key){this.orphanedSequenceNumbers.set(key,txn.currentSequenceNumber);return PersistencePromise.resolve()};MemoryLruDelegate.prototype.removeReference=function(txn,key){this.orphanedSequenceNumbers.set(key,txn.currentSequenceNumber);return PersistencePromise.resolve()};MemoryLruDelegate.prototype.updateLimboDocument=function(txn,key){this.orphanedSequenceNumbers.set(key,txn.currentSequenceNumber);return PersistencePromise.resolve()};MemoryLruDelegate.prototype.documentSize=function(maybeDoc){var remoteDocument=this.serializer.toDbRemoteDocument(maybeDoc);var value;if(remoteDocument.document){value=remoteDocument.document}else if(remoteDocument.unknownDocument){value=remoteDocument.unknownDocument}else if(remoteDocument.noDocument){value=remoteDocument.noDocument}else{throw fail("Unknown remote document type")}return JSON.stringify(value).length};MemoryLruDelegate.prototype.isPinned=function(txn,key,upperBound){var _this=this;return PersistencePromise.or([function(){return _this.persistence.mutationQueuesContainKey(txn,key)},function(){return PersistencePromise.resolve(_this.inMemoryPins.containsKey(key))},function(){return _this.persistence.getQueryCache().containsKey(txn,key)},function(){var orphanedAt=_this.orphanedSequenceNumbers.get(key);return PersistencePromise.resolve(orphanedAt!==undefined&&orphanedAt>upperBound)}])};MemoryLruDelegate.prototype.getCacheSize=function(txn){return this.persistence.getRemoteDocumentCache().getSize(txn)};return MemoryLruDelegate}();var LOG_TAG$5="ExponentialBackoff";var ExponentialBackoff=function(){function ExponentialBackoff(queue,timerId,initialDelayMs,backoffFactor,maxDelayMs){this.queue=queue;this.timerId=timerId;this.initialDelayMs=initialDelayMs;this.backoffFactor=backoffFactor;this.maxDelayMs=maxDelayMs;this.timerPromise=null;this.lastAttemptTime=Date.now();this.reset()}ExponentialBackoff.prototype.reset=function(){this.currentBaseMs=0};ExponentialBackoff.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs};ExponentialBackoff.prototype.backoffAndRun=function(op){var _this=this;this.cancel();var desiredDelayWithJitterMs=Math.floor(this.currentBaseMs+this.jitterDelayMs());var delaySoFarMs=Math.max(0,Date.now()-this.lastAttemptTime);var remainingDelayMs=Math.max(0,desiredDelayWithJitterMs-delaySoFarMs);if(this.currentBaseMs>0){debug(LOG_TAG$5,"Backing off for "+remainingDelayMs+" ms "+("(base delay: "+this.currentBaseMs+" ms, ")+("delay with jitter: "+desiredDelayWithJitterMs+" ms, ")+("last attempt: "+delaySoFarMs+" ms ago)"))}this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,remainingDelayMs,function(){_this.lastAttemptTime=Date.now();return op()});this.currentBaseMs*=this.backoffFactor;if(this.currentBaseMs<this.initialDelayMs){this.currentBaseMs=this.initialDelayMs}if(this.currentBaseMs>this.maxDelayMs){this.currentBaseMs=this.maxDelayMs}};ExponentialBackoff.prototype.cancel=function(){if(this.timerPromise!==null){this.timerPromise.cancel();this.timerPromise=null}};ExponentialBackoff.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs};return ExponentialBackoff}();var LOG_TAG$6="PersistentStream";var PersistentStreamState;(function(PersistentStreamState){PersistentStreamState[PersistentStreamState["Initial"]=0]="Initial";PersistentStreamState[PersistentStreamState["Starting"]=1]="Starting";PersistentStreamState[PersistentStreamState["Open"]=2]="Open";PersistentStreamState[PersistentStreamState["Error"]=3]="Error";PersistentStreamState[PersistentStreamState["Backoff"]=4]="Backoff"})(PersistentStreamState||(PersistentStreamState={}));var BACKOFF_INITIAL_DELAY_MS=1e3;var BACKOFF_MAX_DELAY_MS=60*1e3;var BACKOFF_FACTOR=1.5;var IDLE_TIMEOUT_MS=60*1e3;var PersistentStream=function(){function PersistentStream(queue,connectionTimerId,idleTimerId,connection,credentialsProvider,listener){this.queue=queue;this.idleTimerId=idleTimerId;this.connection=connection;this.credentialsProvider=credentialsProvider;this.listener=listener;this.state=PersistentStreamState.Initial;this.closeCount=0;this.idleTimer=null;this.stream=null;this.backoff=new ExponentialBackoff(queue,connectionTimerId,BACKOFF_INITIAL_DELAY_MS,BACKOFF_FACTOR,BACKOFF_MAX_DELAY_MS)}PersistentStream.prototype.isStarted=function(){return this.state===PersistentStreamState.Starting||this.state===PersistentStreamState.Open||this.state===PersistentStreamState.Backoff};PersistentStream.prototype.isOpen=function(){return this.state===PersistentStreamState.Open};PersistentStream.prototype.start=function(){if(this.state===PersistentStreamState.Error){this.performBackoff();return}assert(this.state===PersistentStreamState.Initial,"Already started");this.auth()};PersistentStream.prototype.stop=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!this.isStarted())return[3,2];return[4,this.close(PersistentStreamState.Initial)];case 1:_a.sent();_a.label=2;case 2:return[2]}})})};PersistentStream.prototype.inhibitBackoff=function(){assert(!this.isStarted(),"Can only inhibit backoff in a stopped state");this.state=PersistentStreamState.Initial;this.backoff.reset()};PersistentStream.prototype.markIdle=function(){var _this=this;if(this.isOpen()&&this.idleTimer===null){this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,IDLE_TIMEOUT_MS,function(){return _this.handleIdleCloseTimer()})}};PersistentStream.prototype.sendRequest=function(msg){this.cancelIdleCheck();this.stream.send(msg)};PersistentStream.prototype.handleIdleCloseTimer=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(this.isOpen()){return[2,this.close(PersistentStreamState.Initial)]}return[2]})})};PersistentStream.prototype.cancelIdleCheck=function(){if(this.idleTimer){this.idleTimer.cancel();this.idleTimer=null}};PersistentStream.prototype.close=function(finalState,error$1){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:assert(this.isStarted(),"Only started streams should be closed.");assert(finalState===PersistentStreamState.Error||isNullOrUndefined(error$1),"Can't provide an error when not in an error state.");this.cancelIdleCheck();this.backoff.cancel();this.closeCount++;if(finalState!==PersistentStreamState.Error){this.backoff.reset()}else if(error$1&&error$1.code===Code.RESOURCE_EXHAUSTED){error(error$1.toString());error("Using maximum backoff delay to prevent overloading the backend.");this.backoff.resetToMax()}else if(error$1&&error$1.code===Code.UNAUTHENTICATED){this.credentialsProvider.invalidateToken()}if(this.stream!==null){this.tearDown();this.stream.close();this.stream=null}this.state=finalState;return[4,this.listener.onClose(error$1)];case 1:_a.sent();return[2]}})})};PersistentStream.prototype.tearDown=function(){};PersistentStream.prototype.auth=function(){var _this=this;assert(this.state===PersistentStreamState.Initial,"Must be in initial state to auth");this.state=PersistentStreamState.Starting;var dispatchIfNotClosed=this.getCloseGuardedDispatcher(this.closeCount);var closeCount=this.closeCount;this.credentialsProvider.getToken().then(function(token){if(_this.closeCount===closeCount){_this.startStream(token)}},function(error){dispatchIfNotClosed(function(){var rpcError=new FirestoreError(Code.UNKNOWN,"Fetching auth token failed: "+error.message);return _this.handleStreamClose(rpcError)})})};PersistentStream.prototype.startStream=function(token){var _this=this;assert(this.state===PersistentStreamState.Starting,"Trying to start stream in a non-starting state");var dispatchIfNotClosed=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(token);this.stream.onOpen(function(){dispatchIfNotClosed(function(){assert(_this.state===PersistentStreamState.Starting,"Expected stream to be in state Starting, but was "+_this.state);_this.state=PersistentStreamState.Open;return _this.listener.onOpen()})});this.stream.onClose(function(error){dispatchIfNotClosed(function(){return _this.handleStreamClose(error)})});this.stream.onMessage(function(msg){dispatchIfNotClosed(function(){return _this.onMessage(msg)})})};PersistentStream.prototype.performBackoff=function(){var _this=this;assert(this.state===PersistentStreamState.Error,"Should only perform backoff when in Error state");this.state=PersistentStreamState.Backoff;this.backoff.backoffAndRun(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){assert(this.state===PersistentStreamState.Backoff,"Backoff elapsed but state is now: "+this.state);this.state=PersistentStreamState.Initial;this.start();assert(this.isStarted(),"PersistentStream should have started");return[2]})})})};PersistentStream.prototype.handleStreamClose=function(error){assert(this.isStarted(),"Can't handle server close on non-started stream");debug(LOG_TAG$6,"close with error: "+error);this.stream=null;return this.close(PersistentStreamState.Error,error)};PersistentStream.prototype.getCloseGuardedDispatcher=function(startCloseCount){var _this=this;return function(fn){_this.queue.enqueueAndForget(function(){if(_this.closeCount===startCloseCount){return fn()}else{debug(LOG_TAG$6,"stream callback skipped by getCloseGuardedDispatcher.");return Promise.resolve()}})}};return PersistentStream}();var PersistentListenStream=function(_super){tslib_1.__extends(PersistentListenStream,_super);function PersistentListenStream(queue,connection,credentials,serializer,listener){var _this=_super.call(this,queue,TimerId.ListenStreamConnectionBackoff,TimerId.ListenStreamIdle,connection,credentials,listener)||this;_this.serializer=serializer;return _this}PersistentListenStream.prototype.startRpc=function(token){return this.connection.openStream("Listen",token)};PersistentListenStream.prototype.onMessage=function(watchChangeProto){this.backoff.reset();var watchChange=this.serializer.fromWatchChange(watchChangeProto);var snapshot=this.serializer.versionFromListenResponse(watchChangeProto);return this.listener.onWatchChange(watchChange,snapshot)};PersistentListenStream.prototype.watch=function(queryData){var request={};request.database=this.serializer.encodedDatabaseId;request.addTarget=this.serializer.toTarget(queryData);var labels=this.serializer.toListenRequestLabels(queryData);if(labels){request.labels=labels}this.sendRequest(request)};PersistentListenStream.prototype.unwatch=function(targetId){var request={};request.database=this.serializer.encodedDatabaseId;request.removeTarget=targetId;this.sendRequest(request)};return PersistentListenStream}(PersistentStream);var PersistentWriteStream=function(_super){tslib_1.__extends(PersistentWriteStream,_super);function PersistentWriteStream(queue,connection,credentials,serializer,listener){var _this=_super.call(this,queue,TimerId.WriteStreamConnectionBackoff,TimerId.WriteStreamIdle,connection,credentials,listener)||this;_this.serializer=serializer;_this.handshakeComplete_=false;return _this}Object.defineProperty(PersistentWriteStream.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:true,configurable:true});PersistentWriteStream.prototype.start=function(){this.handshakeComplete_=false;_super.prototype.start.call(this)};PersistentWriteStream.prototype.tearDown=function(){if(this.handshakeComplete_){this.writeMutations([])}};PersistentWriteStream.prototype.startRpc=function(token){return this.connection.openStream("Write",token)};PersistentWriteStream.prototype.onMessage=function(responseProto){assert(!!responseProto.streamToken,"Got a write response without a stream token");this.lastStreamToken=responseProto.streamToken;if(!this.handshakeComplete_){assert(!responseProto.writeResults||responseProto.writeResults.length===0,"Got mutation results for handshake");this.handshakeComplete_=true;return this.listener.onHandshakeComplete()}else{this.backoff.reset();var results=this.serializer.fromWriteResults(responseProto.writeResults,responseProto.commitTime);var commitVersion=this.serializer.fromVersion(responseProto.commitTime);return this.listener.onMutationResult(commitVersion,results)}};PersistentWriteStream.prototype.writeHandshake=function(){assert(this.isOpen(),"Writing handshake requires an opened stream");assert(!this.handshakeComplete_,"Handshake already completed");var request={};request.database=this.serializer.encodedDatabaseId;this.sendRequest(request)};PersistentWriteStream.prototype.writeMutations=function(mutations){var _this=this;assert(this.isOpen(),"Writing mutations requires an opened stream");assert(this.handshakeComplete_,"Handshake must be complete before writing mutations");assert(this.lastStreamToken.length>0,"Trying to write mutation without a token");var request={streamToken:this.lastStreamToken,writes:mutations.map(function(mutation){return _this.serializer.toMutation(mutation)})};this.sendRequest(request)};return PersistentWriteStream}(PersistentStream);var Datastore=function(){function Datastore(queue,connection,credentials,serializer){this.queue=queue;this.connection=connection;this.credentials=credentials;this.serializer=serializer}Datastore.prototype.newPersistentWriteStream=function(listener){return new PersistentWriteStream(this.queue,this.connection,this.credentials,this.serializer,listener)};Datastore.prototype.newPersistentWatchStream=function(listener){return new PersistentListenStream(this.queue,this.connection,this.credentials,this.serializer,listener)};Datastore.prototype.commit=function(mutations){var _this=this;var params={database:this.serializer.encodedDatabaseId,writes:mutations.map(function(m){return _this.serializer.toMutation(m)})};return this.invokeRPC("Commit",params).then(function(response){return _this.serializer.fromWriteResults(response.writeResults,response.commitTime)})};Datastore.prototype.lookup=function(keys){var _this=this;var params={database:this.serializer.encodedDatabaseId,documents:keys.map(function(k){return _this.serializer.toName(k)})};return this.invokeStreamingRPC("BatchGetDocuments",params).then(function(response){var docs=maybeDocumentMap();response.forEach(function(proto){var doc=_this.serializer.fromMaybeDocument(proto);docs=docs.insert(doc.key,doc)});var result=[];keys.forEach(function(key){var doc=docs.get(key);assert(!!doc,"Missing entity in write response for "+key);result.push(doc)});return result})};Datastore.prototype.invokeRPC=function(rpcName,request){var _this=this;return this.credentials.getToken().then(function(token){return _this.connection.invokeRPC(rpcName,request,token)}).catch(function(error){if(error.code===Code.UNAUTHENTICATED){_this.credentials.invalidateToken()}throw error})};Datastore.prototype.invokeStreamingRPC=function(rpcName,request){var _this=this;return this.credentials.getToken().then(function(token){return _this.connection.invokeStreamingRPC(rpcName,request,token)}).catch(function(error){if(error.code===Code.UNAUTHENTICATED){_this.credentials.invalidateToken()}throw error})};return Datastore}();var Transaction=function(){function Transaction(datastore){this.datastore=datastore;this.readVersions=documentVersionMap();this.mutations=[];this.committed=false}Transaction.prototype.recordVersion=function(doc){var docVersion;if(doc instanceof Document){docVersion=doc.version}else if(doc instanceof NoDocument){docVersion=SnapshotVersion.forDeletedDoc()}else{throw fail("Document in a transaction was a "+doc.constructor.name)}var existingVersion=this.readVersions.get(doc.key);if(existingVersion!==null){if(!docVersion.isEqual(existingVersion)){throw new FirestoreError(Code.ABORTED,"Document version changed between two reads.")}}else{this.readVersions=this.readVersions.insert(doc.key,docVersion)}};Transaction.prototype.lookup=function(keys){var _this=this;if(this.committed){return Promise.reject("Transaction has already completed.")}if(this.mutations.length>0){return Promise.reject("Transactions lookups are invalid after writes.")}return this.datastore.lookup(keys).then(function(docs){docs.forEach(function(doc){if(doc instanceof NoDocument||doc instanceof Document){_this.recordVersion(doc)}else{fail("Document in a transaction was a "+doc.constructor.name)}});return docs})};Transaction.prototype.write=function(mutations){if(this.committed){throw new FirestoreError(Code.FAILED_PRECONDITION,"Transaction has already completed.")}this.mutations=this.mutations.concat(mutations)};Transaction.prototype.precondition=function(key){var version=this.readVersions.get(key);if(version){return Precondition.updateTime(version)}else{return Precondition.NONE}};Transaction.prototype.preconditionForUpdate=function(key){var version=this.readVersions.get(key);if(version&&version.isEqual(SnapshotVersion.forDeletedDoc())){throw new FirestoreError(Code.FAILED_PRECONDITION,"Can't update a document that doesn't exist.")}else if(version){return Precondition.updateTime(version)}else{return Precondition.exists(true)}};Transaction.prototype.set=function(key,data){this.write(data.toMutations(key,this.precondition(key)))};Transaction.prototype.update=function(key,data){this.write(data.toMutations(key,this.preconditionForUpdate(key)))};Transaction.prototype.delete=function(key){this.write([new DeleteMutation(key,this.precondition(key))]);this.readVersions=this.readVersions.insert(key,SnapshotVersion.forDeletedDoc())};Transaction.prototype.commit=function(){var _this=this;var unwritten=this.readVersions;this.mutations.forEach(function(mutation){unwritten=unwritten.remove(mutation.key)});if(!unwritten.isEmpty()){return Promise.reject(Error("Every document read in a transaction must also be written."))}return this.datastore.commit(this.mutations).then(function(){_this.committed=true})};return Transaction}();var OnlineState;(function(OnlineState){OnlineState[OnlineState["Unknown"]=0]="Unknown";OnlineState[OnlineState["Online"]=1]="Online";OnlineState[OnlineState["Offline"]=2]="Offline"})(OnlineState||(OnlineState={}));var OnlineStateSource;(function(OnlineStateSource){OnlineStateSource[OnlineStateSource["RemoteStore"]=0]="RemoteStore";OnlineStateSource[OnlineStateSource["SharedClientState"]=1]="SharedClientState"})(OnlineStateSource||(OnlineStateSource={}));var LOG_TAG$7="OnlineStateTracker";var MAX_WATCH_STREAM_FAILURES=1;var ONLINE_STATE_TIMEOUT_MS=10*1e3;var OnlineStateTracker=function(){function OnlineStateTracker(asyncQueue,onlineStateHandler){this.asyncQueue=asyncQueue;this.onlineStateHandler=onlineStateHandler;this.state=OnlineState.Unknown;this.watchStreamFailures=0;this.onlineStateTimer=null;this.shouldWarnClientIsOffline=true}OnlineStateTracker.prototype.handleWatchStreamStart=function(){var _this=this;if(this.watchStreamFailures===0){this.setAndBroadcast(OnlineState.Unknown);assert(this.onlineStateTimer===null,"onlineStateTimer shouldn't be started yet");this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(TimerId.OnlineStateTimeout,ONLINE_STATE_TIMEOUT_MS,function(){_this.onlineStateTimer=null;assert(_this.state===OnlineState.Unknown,"Timer should be canceled if we transitioned to a different state.");_this.logClientOfflineWarningIfNecessary("Backend didn't respond within "+ONLINE_STATE_TIMEOUT_MS/1e3+" "+"seconds.");_this.setAndBroadcast(OnlineState.Offline);return Promise.resolve()})}};OnlineStateTracker.prototype.handleWatchStreamFailure=function(error){if(this.state===OnlineState.Online){this.setAndBroadcast(OnlineState.Unknown);assert(this.watchStreamFailures===0,"watchStreamFailures must be 0");assert(this.onlineStateTimer===null,"onlineStateTimer must be null")}else{this.watchStreamFailures++;if(this.watchStreamFailures>=MAX_WATCH_STREAM_FAILURES){this.clearOnlineStateTimer();this.logClientOfflineWarningIfNecessary("Connection failed "+MAX_WATCH_STREAM_FAILURES+" "+("times. Most recent error: "+error.toString()));this.setAndBroadcast(OnlineState.Offline)}}};OnlineStateTracker.prototype.set=function(newState){this.clearOnlineStateTimer();this.watchStreamFailures=0;if(newState===OnlineState.Online){this.shouldWarnClientIsOffline=false}this.setAndBroadcast(newState)};OnlineStateTracker.prototype.setAndBroadcast=function(newState){if(newState!==this.state){this.state=newState;this.onlineStateHandler(newState)}};OnlineStateTracker.prototype.logClientOfflineWarningIfNecessary=function(details){var message="Could not reach Cloud Firestore backend. "+details+"\n"+"This typically indicates that your device does not have a healthy "+"Internet connection at the moment. The client will operate in offline "+"mode until it is able to successfully connect to the backend.";if(this.shouldWarnClientIsOffline){error(message);this.shouldWarnClientIsOffline=false}else{debug(LOG_TAG$7,message)}};OnlineStateTracker.prototype.clearOnlineStateTimer=function(){if(this.onlineStateTimer!==null){this.onlineStateTimer.cancel();this.onlineStateTimer=null}};return OnlineStateTracker}();var LOG_TAG$8="RemoteStore";var MAX_PENDING_WRITES=10;var RemoteStore=function(){function RemoteStore(localStore,datastore,asyncQueue,onlineStateHandler){this.localStore=localStore;this.datastore=datastore;this.writePipeline=[];this.listenTargets={};this.watchChangeAggregator=null;this.networkEnabled=false;this.isPrimary=false;this.onlineStateTracker=new OnlineStateTracker(asyncQueue,onlineStateHandler);this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)});this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}RemoteStore.prototype.start=function(){return this.enableNetwork()};RemoteStore.prototype.enableNetwork=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:this.networkEnabled=true;if(!this.canUseNetwork())return[3,3];_a=this.writeStream;return[4,this.localStore.getLastStreamToken()];case 1:_a.lastStreamToken=_b.sent();if(this.shouldStartWatchStream()){this.startWatchStream()}else{this.onlineStateTracker.set(OnlineState.Unknown)}return[4,this.fillWritePipeline()];case 2:_b.sent();_b.label=3;case 3:return[2]}})})};RemoteStore.prototype.disableNetwork=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.networkEnabled=false;return[4,this.disableNetworkInternal()];case 1:_a.sent();this.onlineStateTracker.set(OnlineState.Offline);return[2]}})})};RemoteStore.prototype.disableNetworkInternal=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.writeStream.stop()];case 1:_a.sent();return[4,this.watchStream.stop()];case 2:_a.sent();if(this.writePipeline.length>0){debug(LOG_TAG$8,"Stopping write stream with "+this.writePipeline.length+" pending writes");this.writePipeline=[]}this.cleanUpWatchStreamState();return[2]}})})};RemoteStore.prototype.shutdown=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:debug(LOG_TAG$8,"RemoteStore shutting down.");this.networkEnabled=false;return[4,this.disableNetworkInternal()];case 1:_a.sent();this.onlineStateTracker.set(OnlineState.Unknown);return[2]}})})};RemoteStore.prototype.listen=function(queryData){assert(!contains(this.listenTargets,queryData.targetId),"listen called with duplicate targetId!");this.listenTargets[queryData.targetId]=queryData;if(this.shouldStartWatchStream()){this.startWatchStream()}else if(this.watchStream.isOpen()){this.sendWatchRequest(queryData)}};RemoteStore.prototype.unlisten=function(targetId){assert(contains(this.listenTargets,targetId),"unlisten called without assigned target ID!");delete this.listenTargets[targetId];if(this.watchStream.isOpen()){this.sendUnwatchRequest(targetId)}if(isEmpty(this.listenTargets)){if(this.watchStream.isOpen()){this.watchStream.markIdle()}else if(this.canUseNetwork()){this.onlineStateTracker.set(OnlineState.Unknown)}}};RemoteStore.prototype.getQueryDataForTarget=function(targetId){return this.listenTargets[targetId]||null};RemoteStore.prototype.getRemoteKeysForTarget=function(targetId){return this.syncEngine.getRemoteKeysForTarget(targetId)};RemoteStore.prototype.sendWatchRequest=function(queryData){this.watchChangeAggregator.recordPendingTargetRequest(queryData.targetId);this.watchStream.watch(queryData)};RemoteStore.prototype.sendUnwatchRequest=function(targetId){this.watchChangeAggregator.recordPendingTargetRequest(targetId);this.watchStream.unwatch(targetId)};RemoteStore.prototype.startWatchStream=function(){assert(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false.");this.watchChangeAggregator=new WatchChangeAggregator(this);this.watchStream.start();this.onlineStateTracker.handleWatchStreamStart()};RemoteStore.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!isEmpty(this.listenTargets)};RemoteStore.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled};RemoteStore.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null};RemoteStore.prototype.onWatchStreamOpen=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _this=this;return tslib_1.__generator(this,function(_a){forEachNumber(this.listenTargets,function(targetId,queryData){_this.sendWatchRequest(queryData)});return[2]})})};RemoteStore.prototype.onWatchStreamClose=function(error){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(error===undefined){assert(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed.")}this.cleanUpWatchStreamState();if(this.shouldStartWatchStream()){this.onlineStateTracker.handleWatchStreamFailure(error);this.startWatchStream()}else{this.onlineStateTracker.set(OnlineState.Unknown)}return[2]})})};RemoteStore.prototype.onWatchStreamChange=function(watchChange,snapshotVersion){return tslib_1.__awaiter(this,void 0,void 0,function(){var lastRemoteSnapshotVersion;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.onlineStateTracker.set(OnlineState.Online);if(watchChange instanceof WatchTargetChange&&watchChange.state===WatchTargetChangeState.Removed&&watchChange.cause){return[2,this.handleTargetError(watchChange)]}if(watchChange instanceof DocumentWatchChange){this.watchChangeAggregator.handleDocumentChange(watchChange)}else if(watchChange instanceof ExistenceFilterChange){this.watchChangeAggregator.handleExistenceFilter(watchChange)}else{assert(watchChange instanceof WatchTargetChange,"Expected watchChange to be an instance of WatchTargetChange");this.watchChangeAggregator.handleTargetChange(watchChange)}if(!!snapshotVersion.isEqual(SnapshotVersion.MIN))return[3,3];return[4,this.localStore.getLastRemoteSnapshotVersion()];case 1:lastRemoteSnapshotVersion=_a.sent();if(!(snapshotVersion.compareTo(lastRemoteSnapshotVersion)>=0))return[3,3];return[4,this.raiseWatchSnapshot(snapshotVersion)];case 2:_a.sent();_a.label=3;case 3:return[2]}})})};RemoteStore.prototype.raiseWatchSnapshot=function(snapshotVersion){var _this=this;assert(!snapshotVersion.isEqual(SnapshotVersion.MIN),"Can't raise event for unknown SnapshotVersion");var remoteEvent=this.watchChangeAggregator.createRemoteEvent(snapshotVersion);forEachNumber(remoteEvent.targetChanges,function(targetId,change){if(change.resumeToken.length>0){var queryData=_this.listenTargets[targetId];if(queryData){_this.listenTargets[targetId]=queryData.copy({resumeToken:change.resumeToken,snapshotVersion:snapshotVersion})}}});remoteEvent.targetMismatches.forEach(function(targetId){var queryData=_this.listenTargets[targetId];if(!queryData){return}_this.listenTargets[targetId]=queryData.copy({resumeToken:emptyByteString()});_this.sendUnwatchRequest(targetId);var requestQueryData=new QueryData(queryData.query,targetId,QueryPurpose.ExistenceFilterMismatch,queryData.sequenceNumber);_this.sendWatchRequest(requestQueryData)});return this.syncEngine.applyRemoteEvent(remoteEvent)};RemoteStore.prototype.handleTargetError=function(watchChange){var _this=this;assert(!!watchChange.cause,"Handling target error without a cause");var error=watchChange.cause;var promiseChain=Promise.resolve();watchChange.targetIds.forEach(function(targetId){promiseChain=promiseChain.then(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(contains(this.listenTargets,targetId)){delete this.listenTargets[targetId];this.watchChangeAggregator.removeTarget(targetId);return[2,this.syncEngine.rejectListen(targetId,error)]}return[2]})})})});return promiseChain};RemoteStore.prototype.fillWritePipeline=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var lastBatchIdRetrieved,batch;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!this.canAddToWritePipeline())return[3,4];lastBatchIdRetrieved=this.writePipeline.length>0?this.writePipeline[this.writePipeline.length-1].batchId:BATCHID_UNKNOWN;return[4,this.localStore.nextMutationBatch(lastBatchIdRetrieved)];case 1:batch=_a.sent();if(!(batch===null))return[3,2];if(this.writePipeline.length===0){this.writeStream.markIdle()}return[3,4];case 2:this.addToWritePipeline(batch);return[4,this.fillWritePipeline()];case 3:_a.sent();_a.label=4;case 4:if(this.shouldStartWriteStream()){this.startWriteStream()}return[2]}})})};RemoteStore.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<MAX_PENDING_WRITES};RemoteStore.prototype.outstandingWrites=function(){return this.writePipeline.length};RemoteStore.prototype.addToWritePipeline=function(batch){assert(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full");this.writePipeline.push(batch);if(this.writeStream.isOpen()&&this.writeStream.handshakeComplete){this.writeStream.writeMutations(batch.mutations)}};RemoteStore.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&this.writePipeline.length>0};RemoteStore.prototype.startWriteStream=function(){assert(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false.");this.writeStream.start()};RemoteStore.prototype.onWriteStreamOpen=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){this.writeStream.writeHandshake();return[2]})})};RemoteStore.prototype.onWriteHandshakeComplete=function(){var _this=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var _i=0,_a=_this.writePipeline;_i<_a.length;_i++){var batch=_a[_i];_this.writeStream.writeMutations(batch.mutations)}}).catch(ignoreIfPrimaryLeaseLoss)};RemoteStore.prototype.onMutationResult=function(commitVersion,results){var _this=this;assert(this.writePipeline.length>0,"Got result for empty write pipeline");var batch=this.writePipeline.shift();var success=MutationBatchResult.from(batch,commitVersion,results,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(success).then(function(){return _this.fillWritePipeline()})};RemoteStore.prototype.onWriteStreamClose=function(error){return tslib_1.__awaiter(this,void 0,void 0,function(){var errorHandling;var _this=this;return tslib_1.__generator(this,function(_a){if(error===undefined){assert(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed.")}if(error&&this.writePipeline.length>0){errorHandling=void 0;if(this.writeStream.handshakeComplete){errorHandling=this.handleWriteError(error)}else{errorHandling=this.handleHandshakeError(error)}return[2,errorHandling.then(function(){if(_this.shouldStartWriteStream()){_this.startWriteStream()}})]}return[2]})})};RemoteStore.prototype.handleHandshakeError=function(error){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(isPermanentError(error.code)){debug(LOG_TAG$8,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken);this.writeStream.lastStreamToken=emptyByteString();return[2,this.localStore.setLastStreamToken(emptyByteString()).catch(ignoreIfPrimaryLeaseLoss)]}return[2]})})};RemoteStore.prototype.handleWriteError=function(error){return tslib_1.__awaiter(this,void 0,void 0,function(){var batch;var _this=this;return tslib_1.__generator(this,function(_a){if(isPermanentWriteError(error.code)){batch=this.writePipeline.shift();this.writeStream.inhibitBackoff();return[2,this.syncEngine.rejectFailedWrite(batch.batchId,error).then(function(){return _this.fillWritePipeline()})]}return[2]})})};RemoteStore.prototype.createTransaction=function(){return new Transaction(this.datastore)};RemoteStore.prototype.handleCredentialChange=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!this.canUseNetwork())return[3,3];debug(LOG_TAG$8,"RemoteStore restarting streams for new credential");this.networkEnabled=false;return[4,this.disableNetworkInternal()];case 1:_a.sent();this.onlineStateTracker.set(OnlineState.Unknown);return[4,this.enableNetwork()];case 2:_a.sent();_a.label=3;case 3:return[2]}})})};RemoteStore.prototype.applyPrimaryState=function(isPrimary){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.isPrimary=isPrimary;if(!(isPrimary&&this.networkEnabled))return[3,2];return[4,this.enableNetwork()];case 1:_a.sent();return[3,4];case 2:if(!!isPrimary)return[3,4];return[4,this.disableNetworkInternal()];case 3:_a.sent();this.onlineStateTracker.set(OnlineState.Unknown);_a.label=4;case 4:return[2]}})})};return RemoteStore}();var QueryListenersInfo=function(){function QueryListenersInfo(){this.listeners=[]}return QueryListenersInfo}();var EventManager=function(){function EventManager(syncEngine){this.syncEngine=syncEngine;this.queries=new ObjectMap(function(q){return q.canonicalId()});this.onlineState=OnlineState.Unknown;this.syncEngine.subscribe(this)}EventManager.prototype.listen=function(listener){var query=listener.query;var firstListen=false;var queryInfo=this.queries.get(query);if(!queryInfo){firstListen=true;queryInfo=new QueryListenersInfo;this.queries.set(query,queryInfo)}queryInfo.listeners.push(listener);listener.applyOnlineStateChange(this.onlineState);if(queryInfo.viewSnap)listener.onViewSnapshot(queryInfo.viewSnap);if(firstListen){return this.syncEngine.listen(query).then(function(targetId){queryInfo.targetId=targetId;return targetId})}else{return Promise.resolve(queryInfo.targetId)}};EventManager.prototype.unlisten=function(listener){return tslib_1.__awaiter(this,void 0,void 0,function(){var query,lastListen,queryInfo,i;return tslib_1.__generator(this,function(_a){query=listener.query;lastListen=false;queryInfo=this.queries.get(query);if(queryInfo){i=queryInfo.listeners.indexOf(listener);if(i>=0){queryInfo.listeners.splice(i,1);lastListen=queryInfo.listeners.length===0}}if(lastListen){this.queries.delete(query);return[2,this.syncEngine.unlisten(query)]}return[2]})})};EventManager.prototype.onWatchChange=function(viewSnaps){for(var _i=0,viewSnaps_1=viewSnaps;_i<viewSnaps_1.length;_i++){var viewSnap=viewSnaps_1[_i];var query=viewSnap.query;var queryInfo=this.queries.get(query);if(queryInfo){for(var _a=0,_b=queryInfo.listeners;_a<_b.length;_a++){var listener=_b[_a];listener.onViewSnapshot(viewSnap)}queryInfo.viewSnap=viewSnap}}};EventManager.prototype.onWatchError=function(query,error){var queryInfo=this.queries.get(query);if(queryInfo){for(var _i=0,_a=queryInfo.listeners;_i<_a.length;_i++){var listener=_a[_i];listener.onError(error)}}this.queries.delete(query)};EventManager.prototype.onOnlineStateChange=function(onlineState){this.onlineState=onlineState;this.queries.forEach(function(_,queryInfo){for(var _i=0,_a=queryInfo.listeners;_i<_a.length;_i++){var listener=_a[_i];listener.applyOnlineStateChange(onlineState)}})};return EventManager}();var QueryListener=function(){function QueryListener(query,queryObserver,options){this.query=query;this.queryObserver=queryObserver;this.raisedInitialEvent=false;this.onlineState=OnlineState.Unknown;this.options=options||{}}QueryListener.prototype.onViewSnapshot=function(snap){assert(snap.docChanges.length>0||snap.syncStateChanged,"We got a new snapshot with no changes?");if(!this.options.includeMetadataChanges){var docChanges=[];for(var _i=0,_a=snap.docChanges;_i<_a.length;_i++){var docChange=_a[_i];if(docChange.type!==ChangeType.Metadata){docChanges.push(docChange)}}snap=new ViewSnapshot(snap.query,snap.docs,snap.oldDocs,docChanges,snap.mutatedKeys,snap.fromCache,snap.syncStateChanged,true)}if(!this.raisedInitialEvent){if(this.shouldRaiseInitialEvent(snap,this.onlineState)){this.raiseInitialEvent(snap)}}else if(this.shouldRaiseEvent(snap)){this.queryObserver.next(snap)}this.snap=snap};QueryListener.prototype.onError=function(error){this.queryObserver.error(error)};QueryListener.prototype.applyOnlineStateChange=function(onlineState){this.onlineState=onlineState;if(this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,onlineState)){this.raiseInitialEvent(this.snap)}};QueryListener.prototype.shouldRaiseInitialEvent=function(snap,onlineState){assert(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event");if(!snap.fromCache){return true}var maybeOnline=onlineState!==OnlineState.Offline;if(this.options.waitForSyncWhenOnline&&maybeOnline){assert(snap.fromCache,"Waiting for sync, but snapshot is not from cache");return false}return!snap.docs.isEmpty()||onlineState===OnlineState.Offline};QueryListener.prototype.shouldRaiseEvent=function(snap){if(snap.docChanges.length>0){return true}var hasPendingWritesChanged=this.snap&&this.snap.hasPendingWrites!==snap.hasPendingWrites;if(snap.syncStateChanged||hasPendingWritesChanged){return this.options.includeMetadataChanges===true}return false};QueryListener.prototype.raiseInitialEvent=function(snap){assert(!this.raisedInitialEvent,"Trying to raise initial events for second time");snap=ViewSnapshot.fromInitialDocuments(snap.query,snap.docs,snap.mutatedKeys,snap.fromCache);this.raisedInitialEvent=true;this.queryObserver.next(snap)};return QueryListener}();var LocalViewChanges=function(){function LocalViewChanges(targetId,addedKeys,removedKeys){this.targetId=targetId;this.addedKeys=addedKeys;this.removedKeys=removedKeys}LocalViewChanges.fromSnapshot=function(targetId,viewSnapshot){var addedKeys=documentKeySet();var removedKeys=documentKeySet();for(var _i=0,_a=viewSnapshot.docChanges;_i<_a.length;_i++){var docChange=_a[_i];switch(docChange.type){case ChangeType.Added:addedKeys=addedKeys.add(docChange.doc.key);break;case ChangeType.Removed:removedKeys=removedKeys.add(docChange.doc.key);break;default:}}return new LocalViewChanges(targetId,addedKeys,removedKeys)};return LocalViewChanges}();var AddedLimboDocument=function(){function AddedLimboDocument(key){this.key=key}return AddedLimboDocument}();var RemovedLimboDocument=function(){function RemovedLimboDocument(key){this.key=key}return RemovedLimboDocument}();var View=function(){function View(query,_syncedDocuments){this.query=query;this._syncedDocuments=_syncedDocuments;this.syncState=null;this.current=false;this.limboDocuments=documentKeySet();this.mutatedKeys=documentKeySet();this.documentSet=new DocumentSet(query.docComparator.bind(query))}Object.defineProperty(View.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:true,configurable:true});View.prototype.computeDocChanges=function(docChanges,previousChanges){var _this=this;var changeSet=previousChanges?previousChanges.changeSet:new DocumentChangeSet;var oldDocumentSet=previousChanges?previousChanges.documentSet:this.documentSet;var newMutatedKeys=previousChanges?previousChanges.mutatedKeys:this.mutatedKeys;var newDocumentSet=oldDocumentSet;var needsRefill=false;var lastDocInLimit=this.query.hasLimit()&&oldDocumentSet.size===this.query.limit?oldDocumentSet.last():null;docChanges.inorderTraversal(function(key,newMaybeDoc){var oldDoc=oldDocumentSet.get(key);var newDoc=newMaybeDoc instanceof Document?newMaybeDoc:null;if(newDoc){assert(key.isEqual(newDoc.key),"Mismatching keys found in document changes: "+key+" != "+newDoc.key);newDoc=_this.query.matches(newDoc)?newDoc:null}var oldDocHadPendingMutations=oldDoc?_this.mutatedKeys.has(oldDoc.key):false;var newDocHasPendingMutations=newDoc?newDoc.hasLocalMutations||_this.mutatedKeys.has(newDoc.key)&&newDoc.hasCommittedMutations:false;var changeApplied=false;if(oldDoc&&newDoc){var docsEqual=oldDoc.data.isEqual(newDoc.data);if(!docsEqual){if(!_this.shouldWaitForSyncedDocument(oldDoc,newDoc)){changeSet.track({type:ChangeType.Modified,doc:newDoc});changeApplied=true;if(lastDocInLimit&&_this.query.docComparator(newDoc,lastDocInLimit)>0){needsRefill=true}}}else if(oldDocHadPendingMutations!==newDocHasPendingMutations){changeSet.track({type:ChangeType.Metadata,doc:newDoc});changeApplied=true}}else if(!oldDoc&&newDoc){changeSet.track({type:ChangeType.Added,doc:newDoc});changeApplied=true}else if(oldDoc&&!newDoc){changeSet.track({type:ChangeType.Removed,doc:oldDoc});changeApplied=true;if(lastDocInLimit){needsRefill=true}}if(changeApplied){if(newDoc){newDocumentSet=newDocumentSet.add(newDoc);if(newDocHasPendingMutations){newMutatedKeys=newMutatedKeys.add(key)}else{newMutatedKeys=newMutatedKeys.delete(key)}}else{newDocumentSet=newDocumentSet.delete(key);newMutatedKeys=newMutatedKeys.delete(key)}}});if(this.query.hasLimit()){while(newDocumentSet.size>this.query.limit){var oldDoc=newDocumentSet.last();newDocumentSet=newDocumentSet.delete(oldDoc.key);newMutatedKeys=newMutatedKeys.delete(oldDoc.key);changeSet.track({type:ChangeType.Removed,doc:oldDoc})}}assert(!needsRefill||!previousChanges,"View was refilled using docs that themselves needed refilling.");return{documentSet:newDocumentSet,changeSet:changeSet,needsRefill:needsRefill,mutatedKeys:newMutatedKeys}};View.prototype.shouldWaitForSyncedDocument=function(oldDoc,newDoc){return oldDoc.hasLocalMutations&&newDoc.hasCommittedMutations&&!newDoc.hasLocalMutations};View.prototype.applyChanges=function(docChanges,updateLimboDocuments,targetChange){var _this=this;assert(!docChanges.needsRefill,"Cannot apply changes that need a refill");var oldDocs=this.documentSet;this.documentSet=docChanges.documentSet;this.mutatedKeys=docChanges.mutatedKeys;var changes=docChanges.changeSet.getChanges();changes.sort(function(c1,c2){return compareChangeType(c1.type,c2.type)||_this.query.docComparator(c1.doc,c2.doc)});this.applyTargetChange(targetChange);var limboChanges=updateLimboDocuments?this.updateLimboDocuments():[];var synced=this.limboDocuments.size===0&&this.current;var newSyncState=synced?SyncState.Synced:SyncState.Local;var syncStateChanged=newSyncState!==this.syncState;this.syncState=newSyncState;if(changes.length===0&&!syncStateChanged){return{limboChanges:limboChanges}}else{var snap=new ViewSnapshot(this.query,docChanges.documentSet,oldDocs,changes,docChanges.mutatedKeys,newSyncState===SyncState.Local,syncStateChanged,false);return{snapshot:snap,limboChanges:limboChanges}}};View.prototype.applyOnlineStateChange=function(onlineState){if(this.current&&onlineState===OnlineState.Offline){this.current=false;return this.applyChanges({documentSet:this.documentSet,changeSet:new DocumentChangeSet,mutatedKeys:this.mutatedKeys,needsRefill:false},false)}else{return{limboChanges:[]}}};View.prototype.shouldBeInLimbo=function(key){if(this._syncedDocuments.has(key)){return false}if(!this.documentSet.has(key)){return false}if(this.documentSet.get(key).hasLocalMutations){return false}return true};View.prototype.applyTargetChange=function(targetChange){var _this=this;if(targetChange){targetChange.addedDocuments.forEach(function(key){return _this._syncedDocuments=_this._syncedDocuments.add(key)});targetChange.modifiedDocuments.forEach(function(key){return assert(_this._syncedDocuments.has(key),"Modified document "+key+" not found in view.")});targetChange.removedDocuments.forEach(function(key){return _this._syncedDocuments=_this._syncedDocuments.delete(key)});this.current=targetChange.current}};View.prototype.updateLimboDocuments=function(){var _this=this;if(!this.current){return[]}var oldLimboDocuments=this.limboDocuments;this.limboDocuments=documentKeySet();this.documentSet.forEach(function(doc){if(_this.shouldBeInLimbo(doc.key)){_this.limboDocuments=_this.limboDocuments.add(doc.key)}});var changes=[];oldLimboDocuments.forEach(function(key){if(!_this.limboDocuments.has(key)){changes.push(new RemovedLimboDocument(key))}});this.limboDocuments.forEach(function(key){if(!oldLimboDocuments.has(key)){changes.push(new AddedLimboDocument(key))}});return changes};View.prototype.synchronizeWithPersistedState=function(localDocs,remoteKeys){this._syncedDocuments=remoteKeys;this.limboDocuments=documentKeySet();var docChanges=this.computeDocChanges(localDocs);return this.applyChanges(docChanges,true)};View.prototype.computeInitialSnapshot=function(){return ViewSnapshot.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===SyncState.Local)};return View}();function compareChangeType(c1,c2){var order=function(change){switch(change){case ChangeType.Added:return 1;case ChangeType.Modified:return 2;case ChangeType.Metadata:return 2;case ChangeType.Removed:return 0;default:return fail("Unknown ChangeType: "+change)}};return order(c1)-order(c2)}var LOG_TAG$9="SyncEngine";var QueryView=function(){function QueryView(query,targetId,view){this.query=query;this.targetId=targetId;this.view=view}return QueryView}();var LimboResolution=function(){function LimboResolution(key){this.key=key}return LimboResolution}();var SyncEngine=function(){function SyncEngine(localStore,remoteStore,sharedClientState,currentUser){this.localStore=localStore;this.remoteStore=remoteStore;this.sharedClientState=sharedClientState;this.currentUser=currentUser;this.syncEngineListener=null;this.queryViewsByQuery=new ObjectMap(function(q){return q.canonicalId()});this.queryViewsByTarget={};this.limboTargetsByKey=new SortedMap(DocumentKey.comparator);this.limboResolutionsByTarget={};this.limboDocumentRefs=new ReferenceSet;this.mutationUserCallbacks={};this.limboTargetIdGenerator=TargetIdGenerator.forSyncEngine();this.isPrimary=undefined;this.onlineState=OnlineState.Unknown}Object.defineProperty(SyncEngine.prototype,"isPrimaryClient",{get:function(){return this.isPrimary===true},enumerable:true,configurable:true});SyncEngine.prototype.subscribe=function(syncEngineListener){assert(syncEngineListener!==null,"SyncEngine listener cannot be null");assert(this.syncEngineListener===null,"SyncEngine already has a subscriber.");this.syncEngineListener=syncEngineListener};SyncEngine.prototype.listen=function(query){return tslib_1.__awaiter(this,void 0,void 0,function(){var targetId,viewSnapshot,queryView,queryData,status_1;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.assertSubscribed("listen()");queryView=this.queryViewsByQuery.get(query);if(!queryView)return[3,1];targetId=queryView.targetId;this.sharedClientState.addLocalQueryTarget(targetId);viewSnapshot=queryView.view.computeInitialSnapshot();return[3,4];case 1:return[4,this.localStore.allocateQuery(query)];case 2:queryData=_a.sent();status_1=this.sharedClientState.addLocalQueryTarget(queryData.targetId);targetId=queryData.targetId;return[4,this.initializeViewAndComputeSnapshot(queryData,status_1==="current")];case 3:viewSnapshot=_a.sent();if(this.isPrimary){this.remoteStore.listen(queryData)}_a.label=4;case 4:this.syncEngineListener.onWatchChange([viewSnapshot]);return[2,targetId]}})})};SyncEngine.prototype.initializeViewAndComputeSnapshot=function(queryData,current){var _this=this;var query=queryData.query;return this.localStore.executeQuery(query).then(function(docs){return _this.localStore.remoteDocumentKeys(queryData.targetId).then(function(remoteKeys){var view=new View(query,remoteKeys);var viewDocChanges=view.computeDocChanges(docs);var synthesizedTargetChange=TargetChange.createSynthesizedTargetChangeForCurrentChange(queryData.targetId,current&&_this.onlineState!==OnlineState.Offline);var viewChange=view.applyChanges(viewDocChanges,_this.isPrimary===true,synthesizedTargetChange);assert(viewChange.limboChanges.length===0,"View returned limbo docs before target ack from the server.");assert(!!viewChange.snapshot,"applyChanges for new view should always return a snapshot");var data=new QueryView(query,queryData.targetId,view);_this.queryViewsByQuery.set(query,data);_this.queryViewsByTarget[queryData.targetId]=data;return viewChange.snapshot})})};SyncEngine.prototype.synchronizeViewAndComputeSnapshot=function(queryView){var _this=this;return this.localStore.executeQuery(queryView.query).then(function(docs){return _this.localStore.remoteDocumentKeys(queryView.targetId).then(function(remoteKeys){return tslib_1.__awaiter(_this,void 0,void 0,function(){var viewSnapshot;return tslib_1.__generator(this,function(_a){viewSnapshot=queryView.view.synchronizeWithPersistedState(docs,remoteKeys);if(this.isPrimary){this.updateTrackedLimbos(queryView.targetId,viewSnapshot.limboChanges)}return[2,viewSnapshot]})})})})};SyncEngine.prototype.unlisten=function(query){return tslib_1.__awaiter(this,void 0,void 0,function(){var queryView,targetRemainsActive;var _this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.assertSubscribed("unlisten()");queryView=this.queryViewsByQuery.get(query);assert(!!queryView,"Trying to unlisten on query not found:"+query);if(!this.isPrimary)return[3,3];this.sharedClientState.removeLocalQueryTarget(queryView.targetId);targetRemainsActive=this.sharedClientState.isActiveQueryTarget(queryView.targetId);if(!!targetRemainsActive)return[3,2];return[4,this.localStore.releaseQuery(query,false).then(function(){_this.sharedClientState.clearQueryState(queryView.targetId);_this.remoteStore.unlisten(queryView.targetId);_this.removeAndCleanupQuery(queryView)}).catch(ignoreIfPrimaryLeaseLoss)];case 1:_a.sent();_a.label=2;case 2:return[3,5];case 3:this.removeAndCleanupQuery(queryView);return[4,this.localStore.releaseQuery(query,true)];case 4:_a.sent();_a.label=5;case 5:return[2]}})})};SyncEngine.prototype.write=function(batch,userCallback){var _this=this;this.assertSubscribed("write()");return this.localStore.localWrite(batch).then(function(result){_this.sharedClientState.addPendingMutation(result.batchId);_this.addMutationCallback(result.batchId,userCallback);return _this.emitNewSnapsAndNotifyLocalStore(result.changes)}).then(function(){return _this.remoteStore.fillWritePipeline()})};SyncEngine.prototype.wrapUpdateFunctionError=function(error){return error};SyncEngine.prototype.runTransaction=function(updateFunction,retries){var _this=this;if(retries===void 0){retries=5}assert(retries>=0,"Got negative number of retries for transaction.");var transaction=this.remoteStore.createTransaction();var wrappedUpdateFunction=function(){try{var userPromise=updateFunction(transaction);if(isNullOrUndefined(userPromise)||!userPromise.catch||!userPromise.then){return Promise.reject(Error("Transaction callback must return a Promise"))}return userPromise.catch(function(e){return Promise.reject(_this.wrapUpdateFunctionError(e))})}catch(e){return Promise.reject(_this.wrapUpdateFunctionError(e))}};return wrappedUpdateFunction().then(function(result){return transaction.commit().then(function(){return result}).catch(function(error){if(retries===0){return Promise.reject(error)}return _this.runTransaction(updateFunction,retries-1)})})};SyncEngine.prototype.applyRemoteEvent=function(remoteEvent){var _this=this;this.assertSubscribed("applyRemoteEvent()");return this.localStore.applyRemoteEvent(remoteEvent).then(function(changes){forEach(remoteEvent.targetChanges,function(targetId,targetChange){var limboResolution=_this.limboResolutionsByTarget[targetId];if(limboResolution){assert(targetChange.addedDocuments.size+targetChange.modifiedDocuments.size+targetChange.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes.");if(targetChange.addedDocuments.size>0){limboResolution.receivedDocument=true}else if(targetChange.modifiedDocuments.size>0){assert(limboResolution.receivedDocument,"Received change for limbo target document without add.")}else if(targetChange.removedDocuments.size>0){assert(limboResolution.receivedDocument,"Received remove for limbo target document without add.");limboResolution.receivedDocument=false}}});return _this.emitNewSnapsAndNotifyLocalStore(changes,remoteEvent)}).catch(ignoreIfPrimaryLeaseLoss)};SyncEngine.prototype.applyOnlineStateChange=function(onlineState,source){if(this.isPrimary&&source===OnlineStateSource.RemoteStore||!this.isPrimary&&source===OnlineStateSource.SharedClientState){var newViewSnapshots_1=[];this.queryViewsByQuery.forEach(function(query,queryView){var viewChange=queryView.view.applyOnlineStateChange(onlineState);assert(viewChange.limboChanges.length===0,"OnlineState should not affect limbo documents.");if(viewChange.snapshot){newViewSnapshots_1.push(viewChange.snapshot)}});this.syncEngineListener.onOnlineStateChange(onlineState);this.syncEngineListener.onWatchChange(newViewSnapshots_1);this.onlineState=onlineState;if(this.isPrimary){this.sharedClientState.setOnlineState(onlineState)}}};SyncEngine.prototype.rejectListen=function(targetId,err){return tslib_1.__awaiter(this,void 0,void 0,function(){var limboResolution,limboKey,documentUpdates,resolvedLimboDocuments,event_1,queryView_1;var _this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.assertSubscribed("rejectListens()");this.sharedClientState.updateQueryState(targetId,"rejected",err);limboResolution=this.limboResolutionsByTarget[targetId];limboKey=limboResolution&&limboResolution.key;if(!limboKey)return[3,1];this.limboTargetsByKey=this.limboTargetsByKey.remove(limboKey);delete this.limboResolutionsByTarget[targetId];documentUpdates=new SortedMap(DocumentKey.comparator);documentUpdates=documentUpdates.insert(limboKey,new NoDocument(limboKey,SnapshotVersion.forDeletedDoc()));resolvedLimboDocuments=documentKeySet().add(limboKey);event_1=new RemoteEvent(SnapshotVersion.MIN,{},new SortedSet(primitiveComparator),documentUpdates,resolvedLimboDocuments);return[2,this.applyRemoteEvent(event_1)];case 1:queryView_1=this.queryViewsByTarget[targetId];assert(!!queryView_1,"Unknown targetId: "+targetId);return[4,this.localStore.releaseQuery(queryView_1.query,false).then(function(){return _this.removeAndCleanupQuery(queryView_1)}).catch(ignoreIfPrimaryLeaseLoss)];case 2:_a.sent();this.syncEngineListener.onWatchError(queryView_1.query,err);_a.label=3;case 3:return[2]}})})};SyncEngine.prototype.applyBatchState=function(batchId,batchState,error){return tslib_1.__awaiter(this,void 0,void 0,function(){var documents;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.assertSubscribed("applyBatchState()");return[4,this.localStore.lookupMutationDocuments(batchId)];case 1:documents=_a.sent();if(documents===null){debug(LOG_TAG$9,"Cannot apply mutation batch with id: "+batchId);return[2]}if(!(batchState==="pending"))return[3,3];return[4,this.remoteStore.fillWritePipeline()];case 2:_a.sent();return[3,4];case 3:if(batchState==="acknowledged"||batchState==="rejected"){this.processUserCallback(batchId,error?error:null);this.localStore.removeCachedMutationBatchMetadata(batchId)}else{fail("Unknown batchState: "+batchState)}_a.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(documents)];case 5:_a.sent();return[2]}})})};SyncEngine.prototype.applySuccessfulWrite=function(mutationBatchResult){var _this=this;this.assertSubscribed("applySuccessfulWrite()");var batchId=mutationBatchResult.batch.batchId;this.processUserCallback(batchId,null);return this.localStore.acknowledgeBatch(mutationBatchResult).then(function(changes){_this.sharedClientState.updateMutationState(batchId,"acknowledged");return _this.emitNewSnapsAndNotifyLocalStore(changes)}).catch(ignoreIfPrimaryLeaseLoss)};SyncEngine.prototype.rejectFailedWrite=function(batchId,error){var _this=this;this.assertSubscribed("rejectFailedWrite()");this.processUserCallback(batchId,error);return this.localStore.rejectBatch(batchId).then(function(changes){_this.sharedClientState.updateMutationState(batchId,"rejected",error);return _this.emitNewSnapsAndNotifyLocalStore(changes)}).catch(ignoreIfPrimaryLeaseLoss)};SyncEngine.prototype.addMutationCallback=function(batchId,callback){var newCallbacks=this.mutationUserCallbacks[this.currentUser.toKey()];if(!newCallbacks){newCallbacks=new SortedMap(primitiveComparator)}newCallbacks=newCallbacks.insert(batchId,callback);this.mutationUserCallbacks[this.currentUser.toKey()]=newCallbacks};SyncEngine.prototype.processUserCallback=function(batchId,error){var newCallbacks=this.mutationUserCallbacks[this.currentUser.toKey()];if(newCallbacks){var callback=newCallbacks.get(batchId);if(callback){assert(batchId===newCallbacks.minKey(),"Mutation callbacks processed out-of-order?");if(error){callback.reject(error)}else{callback.resolve()}newCallbacks=newCallbacks.remove(batchId)}this.mutationUserCallbacks[this.currentUser.toKey()]=newCallbacks}};SyncEngine.prototype.removeAndCleanupQuery=function(queryView){var _this=this;this.sharedClientState.removeLocalQueryTarget(queryView.targetId);this.queryViewsByQuery.delete(queryView.query);delete this.queryViewsByTarget[queryView.targetId];if(this.isPrimary){var limboKeys=this.limboDocumentRefs.referencesForId(queryView.targetId);this.limboDocumentRefs.removeReferencesForId(queryView.targetId);limboKeys.forEach(function(limboKey){var isReferenced=_this.limboDocumentRefs.containsKey(limboKey);if(!isReferenced){_this.removeLimboTarget(limboKey)}})}};SyncEngine.prototype.removeLimboTarget=function(key){var limboTargetId=this.limboTargetsByKey.get(key);if(limboTargetId===null){return}this.remoteStore.unlisten(limboTargetId);this.limboTargetsByKey=this.limboTargetsByKey.remove(key);delete this.limboResolutionsByTarget[limboTargetId]};SyncEngine.prototype.updateTrackedLimbos=function(targetId,limboChanges){for(var _i=0,limboChanges_1=limboChanges;_i<limboChanges_1.length;_i++){var limboChange=limboChanges_1[_i];if(limboChange instanceof AddedLimboDocument){this.limboDocumentRefs.addReference(limboChange.key,targetId);this.trackLimboChange(limboChange)}else if(limboChange instanceof RemovedLimboDocument){debug(LOG_TAG$9,"Document no longer in limbo: "+limboChange.key);this.limboDocumentRefs.removeReference(limboChange.key,targetId);var isReferenced=this.limboDocumentRefs.containsKey(limboChange.key);if(!isReferenced){this.removeLimboTarget(limboChange.key)}}else{fail("Unknown limbo change: "+JSON.stringify(limboChange))}}};SyncEngine.prototype.trackLimboChange=function(limboChange){var key=limboChange.key;if(!this.limboTargetsByKey.get(key)){debug(LOG_TAG$9,"New document in limbo: "+key);var limboTargetId=this.limboTargetIdGenerator.next();var query=Query.atPath(key.path);this.limboResolutionsByTarget[limboTargetId]=new LimboResolution(key);this.remoteStore.listen(new QueryData(query,limboTargetId,QueryPurpose.LimboResolution,ListenSequence.INVALID));this.limboTargetsByKey=this.limboTargetsByKey.insert(key,limboTargetId)}};SyncEngine.prototype.currentLimboDocs=function(){return this.limboTargetsByKey};SyncEngine.prototype.emitNewSnapsAndNotifyLocalStore=function(changes,remoteEvent){return tslib_1.__awaiter(this,void 0,void 0,function(){var newSnaps,docChangesInAllViews,queriesProcessed;var _this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:newSnaps=[];docChangesInAllViews=[];queriesProcessed=[];this.queryViewsByQuery.forEach(function(_,queryView){queriesProcessed.push(Promise.resolve().then(function(){var viewDocChanges=queryView.view.computeDocChanges(changes);if(!viewDocChanges.needsRefill){return viewDocChanges}return _this.localStore.executeQuery(queryView.query).then(function(docs){return queryView.view.computeDocChanges(docs,viewDocChanges)})}).then(function(viewDocChanges){var targetChange=remoteEvent&&remoteEvent.targetChanges[queryView.targetId];var viewChange=queryView.view.applyChanges(viewDocChanges,_this.isPrimary===true,targetChange);_this.updateTrackedLimbos(queryView.targetId,viewChange.limboChanges);if(viewChange.snapshot){if(_this.isPrimary){_this.sharedClientState.updateQueryState(queryView.targetId,viewChange.snapshot.fromCache?"not-current":"current")}newSnaps.push(viewChange.snapshot);var docChanges=LocalViewChanges.fromSnapshot(queryView.targetId,viewChange.snapshot);docChangesInAllViews.push(docChanges)}}))});return[4,Promise.all(queriesProcessed)];case 1:_a.sent();this.syncEngineListener.onWatchChange(newSnaps);return[4,this.localStore.notifyLocalViewChanges(docChangesInAllViews)];case 2:_a.sent();return[2]}})})};SyncEngine.prototype.assertSubscribed=function(fnName){assert(this.syncEngineListener!==null,"Trying to call "+fnName+" before calling subscribe().")};SyncEngine.prototype.handleCredentialChange=function(user){return tslib_1.__awaiter(this,void 0,void 0,function(){var userChanged,result;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:userChanged=!this.currentUser.isEqual(user);this.currentUser=user;if(!userChanged)return[3,3];return[4,this.localStore.handleUserChange(user)];case 1:result=_a.sent();this.sharedClientState.handleUserChange(user,result.removedBatchIds,result.addedBatchIds);return[4,this.emitNewSnapsAndNotifyLocalStore(result.affectedDocuments)];case 2:_a.sent();_a.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:_a.sent();return[2]}})})};SyncEngine.prototype.applyPrimaryState=function(isPrimary){return tslib_1.__awaiter(this,void 0,void 0,function(){var activeTargets,activeQueries,_i,activeQueries_1,queryData,activeTargets_1,p_1;var _this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!(isPrimary===true&&this.isPrimary!==true))return[3,3];this.isPrimary=true;return[4,this.remoteStore.applyPrimaryState(true)];case 1:_a.sent();activeTargets=this.sharedClientState.getAllActiveQueryTargets();return[4,this.synchronizeQueryViewsAndRaiseSnapshots(activeTargets.toArray())];case 2:activeQueries=_a.sent();for(_i=0,activeQueries_1=activeQueries;_i<activeQueries_1.length;_i++){queryData=activeQueries_1[_i];this.remoteStore.listen(queryData)}return[3,7];case 3:if(!(isPrimary===false&&this.isPrimary!==false))return[3,7];this.isPrimary=false;activeTargets_1=[];p_1=Promise.resolve();forEachNumber(this.queryViewsByTarget,function(targetId,queryView){if(_this.sharedClientState.isLocalQueryTarget(targetId)){activeTargets_1.push(targetId)}else{p_1=p_1.then(function(){return _this.unlisten(queryView.query)})}_this.remoteStore.unlisten(queryView.targetId)});return[4,p_1];case 4:_a.sent();return[4,this.synchronizeQueryViewsAndRaiseSnapshots(activeTargets_1)];case 5:_a.sent();this.resetLimboDocuments();return[4,this.remoteStore.applyPrimaryState(false)];case 6:_a.sent();_a.label=7;case 7:return[2]}})})};SyncEngine.prototype.resetLimboDocuments=function(){var _this=this;forEachNumber(this.limboResolutionsByTarget,function(targetId){_this.remoteStore.unlisten(targetId)});this.limboDocumentRefs.removeAllReferences();this.limboResolutionsByTarget=[];this.limboTargetsByKey=new SortedMap(DocumentKey.comparator)};SyncEngine.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(targets){var _this=this;var p=Promise.resolve();var activeQueries=[];var newViewSnapshots=[];var _loop_1=function(targetId){p=p.then(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var queryData,queryView,viewChange,query;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:queryView=this.queryViewsByTarget[targetId];if(!queryView)return[3,4];return[4,this.localStore.releaseQuery(queryView.query,true)];case 1:_a.sent();return[4,this.localStore.allocateQuery(queryView.query)];case 2:queryData=_a.sent();return[4,this.synchronizeViewAndComputeSnapshot(queryView)];case 3:viewChange=_a.sent();if(viewChange.snapshot){newViewSnapshots.push(viewChange.snapshot)}return[3,8];case 4:assert(this.isPrimary===true,"A secondary tab should never have an active query without an active view.");return[4,this.localStore.getQueryForTarget(targetId)];case 5:query=_a.sent();assert(!!query,"Query data for target "+targetId+" not found");return[4,this.localStore.allocateQuery(query)];case 6:queryData=_a.sent();return[4,this.initializeViewAndComputeSnapshot(queryData,false)];case 7:_a.sent();_a.label=8;case 8:activeQueries.push(queryData);return[2]}})})})};for(var _i=0,targets_1=targets;_i<targets_1.length;_i++){var targetId=targets_1[_i];_loop_1(targetId)}return p.then(function(){_this.syncEngineListener.onWatchChange(newViewSnapshots);return activeQueries})};SyncEngine.prototype.getActiveClients=function(){return this.localStore.getActiveClients()};SyncEngine.prototype.applyTargetState=function(targetId,state,error){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,queryView;var _this=this;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:if(this.isPrimary){debug(LOG_TAG$9,"Ignoring unexpected query state notification.");return[2]}if(!this.queryViewsByTarget[targetId])return[3,5];_a=state;switch(_a){case"current":return[3,1];case"not-current":return[3,1];case"rejected":return[3,2]}return[3,4];case 1:{return[2,this.localStore.getNewDocumentChanges().then(function(changes){return tslib_1.__awaiter(_this,void 0,void 0,function(){var synthesizedRemoteEvent;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:synthesizedRemoteEvent=RemoteEvent.createSynthesizedRemoteEventForCurrentChange(targetId,state==="current");return[4,this.emitNewSnapsAndNotifyLocalStore(changes,synthesizedRemoteEvent)];case 1:_a.sent();return[2]}})})},function(err){return tslib_1.__awaiter(_this,void 0,void 0,function(){var activeTargets_2;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!isDocumentChangeMissingError(err))return[3,2];activeTargets_2=[];forEachNumber(this.queryViewsByTarget,function(target){return activeTargets_2.push(target)});return[4,this.synchronizeQueryViewsAndRaiseSnapshots(activeTargets_2)];case 1:_a.sent();return[3,3];case 2:throw err;case 3:return[2]}})})})]}_b.label=2;case 2:queryView=this.queryViewsByTarget[targetId];this.removeAndCleanupQuery(queryView);return[4,this.localStore.releaseQuery(queryView.query,true)];case 3:_b.sent();this.syncEngineListener.onWatchError(queryView.query,error);return[3,5];case 4:fail("Unexpected target state: "+state);_b.label=5;case 5:return[2]}})})};SyncEngine.prototype.applyActiveTargetsChange=function(added,removed){return tslib_1.__awaiter(this,void 0,void 0,function(){var _i,added_1,targetId,query,queryData,_loop_2,this_1,_a,removed_1,targetId;var _this=this;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:if(!this.isPrimary){return[2]}_i=0,added_1=added;_b.label=1;case 1:if(!(_i<added_1.length))return[3,6];targetId=added_1[_i];assert(!this.queryViewsByTarget[targetId],"Trying to add an already active target");return[4,this.localStore.getQueryForTarget(targetId)];case 2:query=_b.sent();assert(!!query,"Query data for active target "+targetId+" not found");return[4,this.localStore.allocateQuery(query)];case 3:queryData=_b.sent();return[4,this.initializeViewAndComputeSnapshot(queryData,false)];case 4:_b.sent();this.remoteStore.listen(queryData);_b.label=5;case 5:_i++;return[3,1];case 6:_loop_2=function(targetId){var queryView;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:queryView=this_1.queryViewsByTarget[targetId];if(!queryView)return[3,2];return[4,this_1.localStore.releaseQuery(queryView.query,false).then(function(){_this.remoteStore.unlisten(targetId);_this.removeAndCleanupQuery(queryView)}).catch(ignoreIfPrimaryLeaseLoss)];case 1:_a.sent();_a.label=2;case 2:return[2]}})};this_1=this;_a=0,removed_1=removed;_b.label=7;case 7:if(!(_a<removed_1.length))return[3,10];targetId=removed_1[_a];return[5,_loop_2(targetId)];case 8:_b.sent();_b.label=9;case 9:_a++;return[3,7];case 10:return[2]}})})};SyncEngine.prototype.enableNetwork=function(){this.localStore.setNetworkEnabled(true);return this.remoteStore.enableNetwork()};SyncEngine.prototype.disableNetwork=function(){this.localStore.setNetworkEnabled(false);return this.remoteStore.disableNetwork()};SyncEngine.prototype.getRemoteKeysForTarget=function(targetId){var limboResolution=this.limboResolutionsByTarget[targetId];if(limboResolution&&limboResolution.receivedDocument){return documentKeySet().add(limboResolution.key)}else{return this.queryViewsByTarget[targetId]?this.queryViewsByTarget[targetId].view.syncedDocuments:documentKeySet()}};return SyncEngine}();var User=function(){function User(uid){this.uid=uid}User.prototype.isAuthenticated=function(){return this.uid!=null};User.prototype.toKey=function(){if(this.isAuthenticated()){return"uid:"+this.uid}else{return"anonymous-user"}};User.prototype.isEqual=function(otherUser){return otherUser.uid===this.uid};User.UNAUTHENTICATED=new User(null);User.GOOGLE_CREDENTIALS=new User("google-credentials-uid");User.FIRST_PARTY=new User("first-party-uid");return User}();var LOG_TAG$a="SharedClientState";var CLIENT_STATE_KEY_PREFIX="firestore_clients";var MUTATION_BATCH_KEY_PREFIX="firestore_mutations";var QUERY_TARGET_KEY_PREFIX="firestore_targets";var ONLINE_STATE_KEY_PREFIX="firestore_online_state";var SEQUENCE_NUMBER_KEY_PREFIX="firestore_sequence_number";var MutationMetadata=function(){function MutationMetadata(user,batchId,state,error){this.user=user;this.batchId=batchId;this.state=state;this.error=error;assert(error!==undefined===(state==="rejected"),"MutationMetadata must contain an error iff state is 'rejected'")}MutationMetadata.fromWebStorageEntry=function(user,batchId,value){var mutationBatch=JSON.parse(value);var validData=typeof mutationBatch==="object"&&["pending","acknowledged","rejected"].indexOf(mutationBatch.state)!==-1&&(mutationBatch.error===undefined||typeof mutationBatch.error==="object");var firestoreError=undefined;if(validData&&mutationBatch.error){validData=typeof mutationBatch.error.message==="string"&&typeof mutationBatch.error.code==="string";if(validData){firestoreError=new FirestoreError(mutationBatch.error.code,mutationBatch.error.message)}}if(validData){return new MutationMetadata(user,batchId,mutationBatch.state,firestoreError)}else{error(LOG_TAG$a,"Failed to parse mutation state for ID '"+batchId+"': "+value);return null}};MutationMetadata.prototype.toWebStorageJSON=function(){var batchMetadata={state:this.state,updateTimeMs:Date.now()};if(this.error){batchMetadata.error={code:this.error.code,message:this.error.message}}return JSON.stringify(batchMetadata)};return MutationMetadata}();var QueryTargetMetadata=function(){function QueryTargetMetadata(targetId,state,error){this.targetId=targetId;this.state=state;this.error=error;assert(error!==undefined===(state==="rejected"),"QueryTargetMetadata must contain an error iff state is 'rejected'")}QueryTargetMetadata.fromWebStorageEntry=function(targetId,value){var targetState=JSON.parse(value);var validData=typeof targetState==="object"&&["not-current","current","rejected"].indexOf(targetState.state)!==-1&&(targetState.error===undefined||typeof targetState.error==="object");var firestoreError=undefined;if(validData&&targetState.error){validData=typeof targetState.error.message==="string"&&typeof targetState.error.code==="string";if(validData){firestoreError=new FirestoreError(targetState.error.code,targetState.error.message)}}if(validData){return new QueryTargetMetadata(targetId,targetState.state,firestoreError)}else{error(LOG_TAG$a,"Failed to parse target state for ID '"+targetId+"': "+value);return null}};QueryTargetMetadata.prototype.toWebStorageJSON=function(){var targetState={state:this.state,updateTimeMs:Date.now()};if(this.error){targetState.error={code:this.error.code,message:this.error.message}}return JSON.stringify(targetState)};return QueryTargetMetadata}();var RemoteClientState=function(){function RemoteClientState(clientId,activeTargetIds){this.clientId=clientId;this.activeTargetIds=activeTargetIds}RemoteClientState.fromWebStorageEntry=function(clientId,value){var clientState=JSON.parse(value);var validData=typeof clientState==="object"&&clientState.activeTargetIds instanceof Array;var activeTargetIdsSet=targetIdSet();for(var i=0;validData&&i<clientState.activeTargetIds.length;++i){validData=isSafeInteger(clientState.activeTargetIds[i]);activeTargetIdsSet=activeTargetIdsSet.add(clientState.activeTargetIds[i])}if(validData){return new RemoteClientState(clientId,activeTargetIdsSet)}else{error(LOG_TAG$a,"Failed to parse client data for instance '"+clientId+"': "+value);return null}};return RemoteClientState}();var SharedOnlineState=function(){function SharedOnlineState(clientId,onlineState){this.clientId=clientId;this.onlineState=onlineState}SharedOnlineState.fromWebStorageEntry=function(value){var onlineState=JSON.parse(value);var validData=typeof onlineState==="object"&&OnlineState[onlineState.onlineState]!==undefined&&typeof onlineState.clientId==="string";if(validData){return new SharedOnlineState(onlineState.clientId,OnlineState[onlineState.onlineState])}else{error(LOG_TAG$a,"Failed to parse online state: "+value);return null}};return SharedOnlineState}();var LocalClientState=function(){function LocalClientState(){this.activeTargetIds=targetIdSet()}LocalClientState.prototype.addQueryTarget=function(targetId){assert(!this.activeTargetIds.has(targetId),"Target with ID '"+targetId+"' already active.");this.activeTargetIds=this.activeTargetIds.add(targetId)};LocalClientState.prototype.removeQueryTarget=function(targetId){this.activeTargetIds=this.activeTargetIds.delete(targetId)};LocalClientState.prototype.toWebStorageJSON=function(){var data={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(data)};return LocalClientState}();var WebStorageSharedClientState=function(){function WebStorageSharedClientState(queue,platform,persistenceKey,localClientId,initialUser){this.queue=queue;this.platform=platform;this.persistenceKey=persistenceKey;this.localClientId=localClientId;this.syncEngine=null;this.onlineStateHandler=null;this.sequenceNumberHandler=null;this.activeClients={};this.storageListener=this.handleWebStorageEvent.bind(this);this.started=false;this.earlyEvents=[];if(!WebStorageSharedClientState.isAvailable(this.platform)){throw new FirestoreError(Code.UNIMPLEMENTED,"LocalStorage is not available on this platform.")}var escapedPersistenceKey=persistenceKey.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage;this.currentUser=initialUser;this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId);this.sequenceNumberKey=SEQUENCE_NUMBER_KEY_PREFIX+"_"+persistenceKey;this.activeClients[this.localClientId]=new LocalClientState;this.clientStateKeyRe=new RegExp("^"+CLIENT_STATE_KEY_PREFIX+"_"+escapedPersistenceKey+"_([^_]*)$");this.mutationBatchKeyRe=new RegExp("^"+MUTATION_BATCH_KEY_PREFIX+"_"+escapedPersistenceKey+"_(\\d+)(?:_(.*))?$");this.queryTargetKeyRe=new RegExp("^"+QUERY_TARGET_KEY_PREFIX+"_"+escapedPersistenceKey+"_(\\d+)$");this.onlineStateKey=ONLINE_STATE_KEY_PREFIX+"_"+persistenceKey;this.platform.window.addEventListener("storage",this.storageListener)}WebStorageSharedClientState.isAvailable=function(platform){return!!(platform.window&&platform.window.localStorage!=null)};WebStorageSharedClientState.prototype.start=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var existingClients,_i,existingClients_1,clientId,storageItem,clientState,onlineStateJSON,onlineState,_a,_b,event_1;var _this=this;return tslib_1.__generator(this,function(_c){switch(_c.label){case 0:assert(!this.started,"WebStorageSharedClientState already started");assert(this.syncEngine!==null,"syncEngine property must be set before calling start()");assert(this.onlineStateHandler!==null,"onlineStateHandler property must be set before calling start()");return[4,this.syncEngine.getActiveClients()];case 1:existingClients=_c.sent();for(_i=0,existingClients_1=existingClients;_i<existingClients_1.length;_i++){clientId=existingClients_1[_i];if(clientId===this.localClientId){continue}storageItem=this.getItem(this.toWebStorageClientStateKey(clientId));if(storageItem){clientState=RemoteClientState.fromWebStorageEntry(clientId,storageItem);if(clientState){this.activeClients[clientState.clientId]=clientState}}}this.persistClientState();onlineStateJSON=this.storage.getItem(this.onlineStateKey);if(onlineStateJSON){onlineState=this.fromWebStorageOnlineState(onlineStateJSON);if(onlineState){this.handleOnlineStateEvent(onlineState)}}for(_a=0,_b=this.earlyEvents;_a<_b.length;_a++){event_1=_b[_a];this.handleWebStorageEvent(event_1)}this.earlyEvents=[];this.platform.window.addEventListener("unload",function(){return _this.shutdown()});this.started=true;return[2]}})})};WebStorageSharedClientState.prototype.writeSequenceNumber=function(sequenceNumber){this.setItem(this.sequenceNumberKey,JSON.stringify(sequenceNumber))};WebStorageSharedClientState.prototype.getAllActiveQueryTargets=function(){var activeTargets=targetIdSet();forEach(this.activeClients,function(key,value){activeTargets=activeTargets.unionWith(value.activeTargetIds)});return activeTargets};WebStorageSharedClientState.prototype.isActiveQueryTarget=function(targetId){for(var clientId in this.activeClients){if(this.activeClients.hasOwnProperty(clientId)){if(this.activeClients[clientId].activeTargetIds.has(targetId)){return true}}}return false};WebStorageSharedClientState.prototype.addPendingMutation=function(batchId){this.persistMutationState(batchId,"pending")};WebStorageSharedClientState.prototype.updateMutationState=function(batchId,state,error){this.persistMutationState(batchId,state,error);this.removeMutationState(batchId)};WebStorageSharedClientState.prototype.addLocalQueryTarget=function(targetId){var queryState="not-current";if(this.isActiveQueryTarget(targetId)){var storageItem=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(targetId));if(storageItem){var metadata=QueryTargetMetadata.fromWebStorageEntry(targetId,storageItem);if(metadata){queryState=metadata.state}}}this.localClientState.addQueryTarget(targetId);this.persistClientState();return queryState};WebStorageSharedClientState.prototype.removeLocalQueryTarget=function(targetId){this.localClientState.removeQueryTarget(targetId);this.persistClientState()};WebStorageSharedClientState.prototype.isLocalQueryTarget=function(targetId){return this.localClientState.activeTargetIds.has(targetId)};WebStorageSharedClientState.prototype.clearQueryState=function(targetId){this.removeItem(this.toWebStorageQueryTargetMetadataKey(targetId))};WebStorageSharedClientState.prototype.updateQueryState=function(targetId,state,error){this.persistQueryTargetState(targetId,state,error)};WebStorageSharedClientState.prototype.handleUserChange=function(user,removedBatchIds,addedBatchIds){var _this=this;removedBatchIds.forEach(function(batchId){_this.removeMutationState(batchId)});this.currentUser=user;addedBatchIds.forEach(function(batchId){_this.addPendingMutation(batchId)})};WebStorageSharedClientState.prototype.setOnlineState=function(onlineState){this.persistOnlineState(onlineState)};WebStorageSharedClientState.prototype.shutdown=function(){if(this.started){this.platform.window.removeEventListener("storage",this.storageListener);this.removeItem(this.localClientStorageKey);this.started=false}};WebStorageSharedClientState.prototype.getItem=function(key){var value=this.storage.getItem(key);debug(LOG_TAG$a,"READ",key,value);return value};WebStorageSharedClientState.prototype.setItem=function(key,value){debug(LOG_TAG$a,"SET",key,value);this.storage.setItem(key,value)};WebStorageSharedClientState.prototype.removeItem=function(key){debug(LOG_TAG$a,"REMOVE",key);this.storage.removeItem(key)};WebStorageSharedClientState.prototype.handleWebStorageEvent=function(event){var _this=this;if(event.storageArea===this.storage){debug(LOG_TAG$a,"EVENT",event.key,event.newValue);if(event.key===this.localClientStorageKey){error("Received WebStorage notification for local change. Another client might have "+"garbage-collected our state");return}this.queue.enqueueAndForget(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var clientState,clientId,mutationMetadata,queryTargetMetadata,onlineState,sequenceNumber;return tslib_1.__generator(this,function(_a){if(!this.started){this.earlyEvents.push(event);return[2]}if(event.key===null){return[2]}if(this.clientStateKeyRe.test(event.key)){if(event.newValue!=null){clientState=this.fromWebStorageClientState(event.key,event.newValue);if(clientState){return[2,this.handleClientStateEvent(clientState.clientId,clientState)]}}else{clientId=this.fromWebStorageClientStateKey(event.key);return[2,this.handleClientStateEvent(clientId,null)]}}else if(this.mutationBatchKeyRe.test(event.key)){if(event.newValue!==null){mutationMetadata=this.fromWebStorageMutationMetadata(event.key,event.newValue);if(mutationMetadata){return[2,this.handleMutationBatchEvent(mutationMetadata)]}}}else if(this.queryTargetKeyRe.test(event.key)){if(event.newValue!==null){queryTargetMetadata=this.fromWebStorageQueryTargetMetadata(event.key,event.newValue);if(queryTargetMetadata){return[2,this.handleQueryTargetEvent(queryTargetMetadata)]}}}else if(event.key===this.onlineStateKey){if(event.newValue!==null){onlineState=this.fromWebStorageOnlineState(event.newValue);if(onlineState){return[2,this.handleOnlineStateEvent(onlineState)]}}}else if(event.key===this.sequenceNumberKey){assert(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler");sequenceNumber=fromWebStorageSequenceNumber(event.newValue);if(sequenceNumber!==ListenSequence.INVALID){this.sequenceNumberHandler(sequenceNumber)}}return[2]})})})}};Object.defineProperty(WebStorageSharedClientState.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:true,configurable:true});WebStorageSharedClientState.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())};WebStorageSharedClientState.prototype.persistMutationState=function(batchId,state,error){var mutationState=new MutationMetadata(this.currentUser,batchId,state,error);var mutationKey=this.toWebStorageMutationBatchKey(batchId);this.setItem(mutationKey,mutationState.toWebStorageJSON())};WebStorageSharedClientState.prototype.removeMutationState=function(batchId){var mutationKey=this.toWebStorageMutationBatchKey(batchId);this.removeItem(mutationKey)};WebStorageSharedClientState.prototype.persistOnlineState=function(onlineState){var entry={clientId:this.localClientId,onlineState:OnlineState[onlineState]};this.storage.setItem(this.onlineStateKey,JSON.stringify(entry))};WebStorageSharedClientState.prototype.persistQueryTargetState=function(targetId,state,error){var targetKey=this.toWebStorageQueryTargetMetadataKey(targetId);var targetMetadata=new QueryTargetMetadata(targetId,state,error);this.setItem(targetKey,targetMetadata.toWebStorageJSON())};WebStorageSharedClientState.prototype.toWebStorageClientStateKey=function(clientId){assert(clientId.indexOf("_")===-1,"Client key cannot contain '_', but was '"+clientId+"'");return CLIENT_STATE_KEY_PREFIX+"_"+this.persistenceKey+"_"+clientId};WebStorageSharedClientState.prototype.toWebStorageQueryTargetMetadataKey=function(targetId){return QUERY_TARGET_KEY_PREFIX+"_"+this.persistenceKey+"_"+targetId};WebStorageSharedClientState.prototype.toWebStorageMutationBatchKey=function(batchId){var mutationKey=MUTATION_BATCH_KEY_PREFIX+"_"+this.persistenceKey+"_"+batchId;if(this.currentUser.isAuthenticated()){mutationKey+="_"+this.currentUser.uid}return mutationKey};WebStorageSharedClientState.prototype.fromWebStorageClientStateKey=function(key){var match=this.clientStateKeyRe.exec(key);return match?match[1]:null};WebStorageSharedClientState.prototype.fromWebStorageClientState=function(key,value){var clientId=this.fromWebStorageClientStateKey(key);assert(clientId!==null,"Cannot parse client state key '"+key+"'");return RemoteClientState.fromWebStorageEntry(clientId,value)};WebStorageSharedClientState.prototype.fromWebStorageMutationMetadata=function(key,value){var match=this.mutationBatchKeyRe.exec(key);assert(match!==null,"Cannot parse mutation batch key '"+key+"'");var batchId=Number(match[1]);var userId=match[2]!==undefined?match[2]:null;return MutationMetadata.fromWebStorageEntry(new User(userId),batchId,value)};WebStorageSharedClientState.prototype.fromWebStorageQueryTargetMetadata=function(key,value){var match=this.queryTargetKeyRe.exec(key);assert(match!==null,"Cannot parse query target key '"+key+"'");var targetId=Number(match[1]);return QueryTargetMetadata.fromWebStorageEntry(targetId,value)};WebStorageSharedClientState.prototype.fromWebStorageOnlineState=function(value){return SharedOnlineState.fromWebStorageEntry(value)};WebStorageSharedClientState.prototype.handleMutationBatchEvent=function(mutationBatch){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(mutationBatch.user.uid!==this.currentUser.uid){debug(LOG_TAG$a,"Ignoring mutation for non-active user "+mutationBatch.user.uid);return[2]}return[2,this.syncEngine.applyBatchState(mutationBatch.batchId,mutationBatch.state,mutationBatch.error)]})})};WebStorageSharedClientState.prototype.handleQueryTargetEvent=function(targetMetadata){return this.syncEngine.applyTargetState(targetMetadata.targetId,targetMetadata.state,targetMetadata.error)};WebStorageSharedClientState.prototype.handleClientStateEvent=function(clientId,clientState){var _this=this;var existingTargets=this.getAllActiveQueryTargets();if(clientState){this.activeClients[clientId]=clientState}else{delete this.activeClients[clientId]}var newTargets=this.getAllActiveQueryTargets();var addedTargets=[];var removedTargets=[];newTargets.forEach(function(targetId){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(!existingTargets.has(targetId)){addedTargets.push(targetId)}return[2]})})});existingTargets.forEach(function(targetId){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(!newTargets.has(targetId)){removedTargets.push(targetId)}return[2]})})});return this.syncEngine.applyActiveTargetsChange(addedTargets,removedTargets)};WebStorageSharedClientState.prototype.handleOnlineStateEvent=function(onlineState){if(this.activeClients[onlineState.clientId]){this.onlineStateHandler(onlineState.onlineState)}};return WebStorageSharedClientState}();function fromWebStorageSequenceNumber(seqString){var sequenceNumber=ListenSequence.INVALID;if(seqString!=null){try{var parsed=JSON.parse(seqString);assert(typeof parsed==="number","Found non-numeric sequence number");sequenceNumber=parsed}catch(e){error(LOG_TAG$a,"Failed to read sequence number from WebStorage",e)}}return sequenceNumber}var MemorySharedClientState=function(){function MemorySharedClientState(){this.localState=new LocalClientState;this.queryState={};this.syncEngine=null;this.onlineStateHandler=null;this.sequenceNumberHandler=null}MemorySharedClientState.prototype.addPendingMutation=function(batchId){};MemorySharedClientState.prototype.updateMutationState=function(batchId,state,error){};MemorySharedClientState.prototype.addLocalQueryTarget=function(targetId){this.localState.addQueryTarget(targetId);return this.queryState[targetId]||"not-current"};MemorySharedClientState.prototype.updateQueryState=function(targetId,state,error){this.queryState[targetId]=state};MemorySharedClientState.prototype.removeLocalQueryTarget=function(targetId){this.localState.removeQueryTarget(targetId)};MemorySharedClientState.prototype.isLocalQueryTarget=function(targetId){return this.localState.activeTargetIds.has(targetId)};MemorySharedClientState.prototype.clearQueryState=function(targetId){delete this.queryState[targetId]};MemorySharedClientState.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds};MemorySharedClientState.prototype.isActiveQueryTarget=function(targetId){return this.localState.activeTargetIds.has(targetId)};MemorySharedClientState.prototype.start=function(){this.localState=new LocalClientState;return Promise.resolve()};MemorySharedClientState.prototype.handleUserChange=function(user,removedBatchIds,addedBatchIds){};MemorySharedClientState.prototype.setOnlineState=function(onlineState){};MemorySharedClientState.prototype.shutdown=function(){};MemorySharedClientState.prototype.writeSequenceNumber=function(sequenceNumber){};return MemorySharedClientState}();var LOG_TAG$b="FirestoreClient";var DOM_EXCEPTION_ABORTED=20;var DOM_EXCEPTION_QUOTA_EXCEEDED=22;var IndexedDbPersistenceSettings=function(){function IndexedDbPersistenceSettings(cacheSizeBytes,experimentalTabSynchronization){this.cacheSizeBytes=cacheSizeBytes;this.experimentalTabSynchronization=experimentalTabSynchronization}IndexedDbPersistenceSettings.prototype.lruParams=function(){return LruParams.withCacheSize(this.cacheSizeBytes)};return IndexedDbPersistenceSettings}();var MemoryPersistenceSettings=function(){function MemoryPersistenceSettings(){}return MemoryPersistenceSettings}();var FirestoreClient=function(){function FirestoreClient(platform,databaseInfo,credentials,asyncQueue){this.platform=platform;this.databaseInfo=databaseInfo;this.credentials=credentials;this.asyncQueue=asyncQueue;this.clientId=AutoId.newId()}FirestoreClient.prototype.start=function(persistenceSettings){var _this=this;var initializationDone=new Deferred;var persistenceResult=new Deferred;var initialized=false;this.credentials.setChangeListener(function(user){if(!initialized){initialized=true;_this.initializePersistence(persistenceSettings,persistenceResult,user).then(function(maybeLruGc){return _this.initializeRest(user,maybeLruGc)}).then(initializationDone.resolve,initializationDone.reject)}else{_this.asyncQueue.enqueueAndForget(function(){return _this.handleCredentialChange(user)})}});this.asyncQueue.enqueueAndForget(function(){return initializationDone.promise});return persistenceResult.promise};FirestoreClient.prototype.enableNetwork=function(){var _this=this;return this.asyncQueue.enqueue(function(){return _this.syncEngine.enableNetwork()})};FirestoreClient.prototype.initializePersistence=function(persistenceSettings,persistenceResult,user){var _this=this;if(persistenceSettings instanceof IndexedDbPersistenceSettings){return this.startIndexedDbPersistence(user,persistenceSettings).then(function(maybeLruGc){persistenceResult.resolve();return maybeLruGc}).catch(function(error){persistenceResult.reject(error);if(!_this.canFallback(error)){throw error}console.warn("Error enabling offline storage. Falling back to"+" storage disabled: "+error);return _this.startMemoryPersistence()})}else{persistenceResult.resolve();return this.startMemoryPersistence()}};FirestoreClient.prototype.canFallback=function(error){if(error instanceof FirestoreError){return error.code===Code.FAILED_PRECONDITION||error.code===Code.UNIMPLEMENTED}else if(typeof DOMException!=="undefined"&&error instanceof DOMException){return error.code===DOM_EXCEPTION_QUOTA_EXCEEDED||error.code===DOM_EXCEPTION_ABORTED}return true};FirestoreClient.prototype.startIndexedDbPersistence=function(user,settings){var _this=this;var storagePrefix=IndexedDbPersistence.buildStoragePrefix(this.databaseInfo);var serializer=new JsonProtoSerializer(this.databaseInfo.databaseId,{useProto3Json:true});return Promise.resolve().then(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var persistence,lruParams;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(settings.experimentalTabSynchronization&&!WebStorageSharedClientState.isAvailable(this.platform)){throw new FirestoreError(Code.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.")}lruParams=settings.lruParams();if(!settings.experimentalTabSynchronization)return[3,2];this.sharedClientState=new WebStorageSharedClientState(this.asyncQueue,this.platform,storagePrefix,this.clientId,user);return[4,IndexedDbPersistence.createMultiClientIndexedDbPersistence(storagePrefix,this.clientId,this.platform,this.asyncQueue,serializer,lruParams,{sequenceNumberSyncer:this.sharedClientState})];case 1:persistence=_a.sent();return[3,4];case 2:this.sharedClientState=new MemorySharedClientState;return[4,IndexedDbPersistence.createIndexedDbPersistence(storagePrefix,this.clientId,this.platform,this.asyncQueue,serializer,lruParams)];case 3:persistence=_a.sent();_a.label=4;case 4:this.persistence=persistence;return[2,persistence.referenceDelegate.garbageCollector]}})})})};FirestoreClient.prototype.startMemoryPersistence=function(){this.persistence=MemoryPersistence.createEagerPersistence(this.clientId);this.sharedClientState=new MemorySharedClientState;return Promise.resolve(null)};FirestoreClient.prototype.initializeRest=function(user,maybeLruGc){var _this=this;debug(LOG_TAG$b,"Initializing. user=",user.uid);return this.platform.loadConnection(this.databaseInfo).then(function(connection){return tslib_1.__awaiter(_this,void 0,void 0,function(){var serializer,datastore,remoteStoreOnlineStateChangedHandler,sharedClientStateOnlineStateChangedHandler;var _this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.localStore=new LocalStore(this.persistence,user);if(maybeLruGc){this.lruScheduler=new LruScheduler(maybeLruGc,this.asyncQueue,this.localStore)}serializer=this.platform.newSerializer(this.databaseInfo.databaseId);datastore=new Datastore(this.asyncQueue,connection,this.credentials,serializer);remoteStoreOnlineStateChangedHandler=function(onlineState){return _this.syncEngine.applyOnlineStateChange(onlineState,OnlineStateSource.RemoteStore)};sharedClientStateOnlineStateChangedHandler=function(onlineState){return _this.syncEngine.applyOnlineStateChange(onlineState,OnlineStateSource.SharedClientState)};this.remoteStore=new RemoteStore(this.localStore,datastore,this.asyncQueue,remoteStoreOnlineStateChangedHandler);this.syncEngine=new SyncEngine(this.localStore,this.remoteStore,this.sharedClientState,user);this.sharedClientState.onlineStateHandler=sharedClientStateOnlineStateChangedHandler;this.remoteStore.syncEngine=this.syncEngine;this.sharedClientState.syncEngine=this.syncEngine;this.eventMgr=new EventManager(this.syncEngine);return[4,this.sharedClientState.start()];case 1:_a.sent();return[4,this.remoteStore.start()];case 2:_a.sent();return[4,this.persistence.setPrimaryStateListener(function(isPrimary){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.syncEngine.applyPrimaryState(isPrimary)];case 1:_a.sent();if(this.lruScheduler){if(isPrimary&&!this.lruScheduler.started){this.lruScheduler.start()}else if(!isPrimary){this.lruScheduler.stop()}}return[2]}})})})];case 3:_a.sent();return[2]}})})})};FirestoreClient.prototype.handleCredentialChange=function(user){this.asyncQueue.verifyOperationInProgress();debug(LOG_TAG$b,"Credential Changed. Current user: "+user.uid);return this.syncEngine.handleCredentialChange(user)};FirestoreClient.prototype.disableNetwork=function(){var _this=this;return this.asyncQueue.enqueue(function(){return _this.syncEngine.disableNetwork()})};FirestoreClient.prototype.shutdown=function(options){var _this=this;return this.asyncQueue.enqueue(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(this.lruScheduler){this.lruScheduler.stop()}return[4,this.remoteStore.shutdown()];case 1:_a.sent();return[4,this.sharedClientState.shutdown()];case 2:_a.sent();return[4,this.persistence.shutdown(options&&options.purgePersistenceWithDataLoss)];case 3:_a.sent();this.credentials.removeChangeListener();return[2]}})})})};FirestoreClient.prototype.listen=function(query,observer,options){var _this=this;var listener=new QueryListener(query,observer,options);this.asyncQueue.enqueueAndForget(function(){return _this.eventMgr.listen(listener)});return listener};FirestoreClient.prototype.unlisten=function(listener){var _this=this;this.asyncQueue.enqueueAndForget(function(){return _this.eventMgr.unlisten(listener)})};FirestoreClient.prototype.getDocumentFromLocalCache=function(docKey){var _this=this;return this.asyncQueue.enqueue(function(){return _this.localStore.readDocument(docKey)}).then(function(maybeDoc){if(maybeDoc instanceof Document){return maybeDoc}else if(maybeDoc instanceof NoDocument){return null}else{throw new FirestoreError(Code.UNAVAILABLE,"Failed to get document from cache. (However, this document may "+"exist on the server. Run again without setting 'source' in "+"the GetOptions to attempt to retrieve the document from the "+"server.)")}})};FirestoreClient.prototype.getDocumentsFromLocalCache=function(query){var _this=this;return this.asyncQueue.enqueue(function(){return _this.localStore.executeQuery(query)}).then(function(docs){var remoteKeys=documentKeySet();var view=new View(query,remoteKeys);var viewDocChanges=view.computeDocChanges(docs);return view.applyChanges(viewDocChanges,false).snapshot})};FirestoreClient.prototype.write=function(mutations){var _this=this;var deferred=new Deferred;this.asyncQueue.enqueueAndForget(function(){return _this.syncEngine.write(mutations,deferred)});return deferred.promise};FirestoreClient.prototype.databaseId=function(){return this.databaseInfo.databaseId};FirestoreClient.prototype.transaction=function(updateFunction){var _this=this;return this.asyncQueue.enqueue(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return[2]})})}).then(function(){return _this.syncEngine.runTransaction(updateFunction)})};return FirestoreClient}();var AsyncObserver=function(){function AsyncObserver(observer){this.observer=observer;this.muted=false}AsyncObserver.prototype.next=function(value){this.scheduleEvent(this.observer.next,value)};AsyncObserver.prototype.error=function(error){this.scheduleEvent(this.observer.error,error)};AsyncObserver.prototype.mute=function(){this.muted=true};AsyncObserver.prototype.scheduleEvent=function(eventHandler,event){var _this=this;if(!this.muted){setTimeout(function(){if(!_this.muted){eventHandler(event)}},0)}};return AsyncObserver}();var FieldPath$1=function(){function FieldPath$1(){var fieldNames=[];for(var _i=0;_i<arguments.length;_i++){fieldNames[_i]=arguments[_i]}validateNamedArrayAtLeastNumberOfElements("FieldPath",fieldNames,"fieldNames",1);for(var i=0;i<fieldNames.length;++i){validateArgType("FieldPath","string",i,fieldNames[i]);if(fieldNames[i].length===0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). "+"Field names must not be empty.")}}this._internalPath=new FieldPath(fieldNames)}FieldPath$1.documentId=function(){return FieldPath$1._DOCUMENT_ID};FieldPath$1.prototype.isEqual=function(other){if(!(other instanceof FieldPath$1)){throw invalidClassError("isEqual","FieldPath",1,other)}return this._internalPath.isEqual(other._internalPath)};FieldPath$1._DOCUMENT_ID=new FieldPath$1(FieldPath.keyField().canonicalString());return FieldPath$1}();var RESERVED=new RegExp("[~\\*/\\[\\]]");function fromDotSeparatedString(path){var found=path.search(RESERVED);if(found>=0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not contain "+"'~', '*', '/', '[', or ']'")}try{return new(FieldPath$1.bind.apply(FieldPath$1,[void 0].concat(path.split("."))))}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not be empty, "+"begin with '.', end with '.', or contain '..'")}}var OAuthToken=function(){function OAuthToken(value,user){this.user=user;this.type="OAuth";this.authHeaders={Authorization:"Bearer "+value}}return OAuthToken}();var EmptyCredentialsProvider=function(){function EmptyCredentialsProvider(){this.changeListener=null}EmptyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(null)};EmptyCredentialsProvider.prototype.invalidateToken=function(){};EmptyCredentialsProvider.prototype.setChangeListener=function(changeListener){assert(!this.changeListener,"Can only call setChangeListener() once.");this.changeListener=changeListener;changeListener(User.UNAUTHENTICATED)};EmptyCredentialsProvider.prototype.removeChangeListener=function(){assert(this.changeListener!==null,"removeChangeListener() when no listener registered");this.changeListener=null};return EmptyCredentialsProvider}();var FirebaseCredentialsProvider=function(){function FirebaseCredentialsProvider(app){var _this=this;this.app=app;this.tokenListener=null;this.tokenCounter=0;this.changeListener=null;this.forceRefresh=false;this.tokenListener=function(){_this.tokenCounter++;_this.currentUser=_this.getUser();if(_this.changeListener){_this.changeListener(_this.currentUser)}};this.tokenCounter=0;this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}FirebaseCredentialsProvider.prototype.getToken=function(){var _this=this;assert(this.tokenListener!=null,"getToken cannot be called after listener removed.");var initialTokenCounter=this.tokenCounter;var forceRefresh=this.forceRefresh;this.forceRefresh=false;return this.app.INTERNAL.getToken(forceRefresh).then(function(tokenData){if(_this.tokenCounter!==initialTokenCounter){throw new FirestoreError(Code.ABORTED,"getToken aborted due to token change.")}else{if(tokenData){assert(typeof tokenData.accessToken==="string","Invalid tokenData returned from getToken():"+tokenData);return new OAuthToken(tokenData.accessToken,_this.currentUser)}else{return null}}})};FirebaseCredentialsProvider.prototype.invalidateToken=function(){this.forceRefresh=true};FirebaseCredentialsProvider.prototype.setChangeListener=function(changeListener){assert(!this.changeListener,"Can only call setChangeListener() once.");this.changeListener=changeListener;if(this.currentUser){changeListener(this.currentUser)}};FirebaseCredentialsProvider.prototype.removeChangeListener=function(){assert(this.tokenListener!=null,"removeChangeListener() called twice");assert(this.changeListener!==null,"removeChangeListener() called when no listener registered");this.app.INTERNAL.removeAuthTokenListener(this.tokenListener);this.tokenListener=null;this.changeListener=null};FirebaseCredentialsProvider.prototype.getUser=function(){var currentUid=this.app.INTERNAL.getUid();assert(currentUid===null||typeof currentUid==="string","Received invalid UID: "+currentUid);return new User(currentUid)};return FirebaseCredentialsProvider}();var FirstPartyToken=function(){function FirstPartyToken(gapi,sessionIndex){this.gapi=gapi;this.sessionIndex=sessionIndex;this.type="FirstParty";this.user=User.FIRST_PARTY}Object.defineProperty(FirstPartyToken.prototype,"authHeaders",{get:function(){var headers={"X-Goog-AuthUser":this.sessionIndex};var authHeader=this.gapi.auth.getAuthHeaderValueForFirstParty([]);if(authHeader){headers["Authorization"]=authHeader}return headers},enumerable:true,configurable:true});return FirstPartyToken}();var FirstPartyCredentialsProvider=function(){function FirstPartyCredentialsProvider(gapi,sessionIndex){this.gapi=gapi;this.sessionIndex=sessionIndex}FirstPartyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(new FirstPartyToken(this.gapi,this.sessionIndex))};FirstPartyCredentialsProvider.prototype.setChangeListener=function(changeListener){changeListener(User.FIRST_PARTY)};FirstPartyCredentialsProvider.prototype.removeChangeListener=function(){};FirstPartyCredentialsProvider.prototype.invalidateToken=function(){};return FirstPartyCredentialsProvider}();function makeCredentialsProvider(credentials){if(!credentials){return new EmptyCredentialsProvider}switch(credentials.type){case"gapi":var client=credentials.client;assert(!!(typeof client==="object"&&client!==null&&client["auth"]&&client["auth"]["getAuthHeaderValueForFirstParty"]),"unexpected gapi interface");return new FirstPartyCredentialsProvider(client,credentials.sessionIndex||"0");case"provider":return credentials.client;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}function isPartialObserver(obj){return implementsAnyMethods(obj,["next","error","complete"])}function implementsAnyMethods(obj,methods){if(typeof obj!=="object"||obj===null){return false}var object=obj;for(var _i=0,methods_1=methods;_i<methods_1.length;_i++){var method=methods_1[_i];if(method in object&&typeof object[method]==="function"){return true}}return false}var FieldValueImpl=function(){function FieldValueImpl(_methodName){this._methodName=_methodName}FieldValueImpl.delete=function(){validateNoArgs("FieldValue.delete",arguments);return DeleteFieldValueImpl.instance};FieldValueImpl.serverTimestamp=function(){validateNoArgs("FieldValue.serverTimestamp",arguments);return ServerTimestampFieldValueImpl.instance};FieldValueImpl.arrayUnion=function(){var elements=[];for(var _i=0;_i<arguments.length;_i++){elements[_i]=arguments[_i]}validateAtLeastNumberOfArgs("FieldValue.arrayUnion",arguments,1);return new ArrayUnionFieldValueImpl(elements)};FieldValueImpl.arrayRemove=function(){var elements=[];for(var _i=0;_i<arguments.length;_i++){elements[_i]=arguments[_i]}validateAtLeastNumberOfArgs("FieldValue.arrayRemove",arguments,1);return new ArrayRemoveFieldValueImpl(elements)};FieldValueImpl.increment=function(n){validateArgType("FieldValue.increment","number",1,n);validateExactNumberOfArgs("FieldValue.increment",arguments,1);return new NumericIncrementFieldValueImpl(n)};FieldValueImpl.prototype.isEqual=function(other){return this===other};return FieldValueImpl}();var DeleteFieldValueImpl=function(_super){tslib_1.__extends(DeleteFieldValueImpl,_super);function DeleteFieldValueImpl(){return _super.call(this,"FieldValue.delete")||this}DeleteFieldValueImpl.instance=new DeleteFieldValueImpl;return DeleteFieldValueImpl}(FieldValueImpl);var ServerTimestampFieldValueImpl=function(_super){tslib_1.__extends(ServerTimestampFieldValueImpl,_super);function ServerTimestampFieldValueImpl(){return _super.call(this,"FieldValue.serverTimestamp")||this}ServerTimestampFieldValueImpl.instance=new ServerTimestampFieldValueImpl;return ServerTimestampFieldValueImpl}(FieldValueImpl);var ArrayUnionFieldValueImpl=function(_super){tslib_1.__extends(ArrayUnionFieldValueImpl,_super);function ArrayUnionFieldValueImpl(_elements){var _this=_super.call(this,"FieldValue.arrayUnion")||this;_this._elements=_elements;return _this}return ArrayUnionFieldValueImpl}(FieldValueImpl);var ArrayRemoveFieldValueImpl=function(_super){tslib_1.__extends(ArrayRemoveFieldValueImpl,_super);function ArrayRemoveFieldValueImpl(_elements){var _this=_super.call(this,"FieldValue.arrayRemove")||this;_this._elements=_elements;return _this}return ArrayRemoveFieldValueImpl}(FieldValueImpl);var NumericIncrementFieldValueImpl=function(_super){tslib_1.__extends(NumericIncrementFieldValueImpl,_super);function NumericIncrementFieldValueImpl(_operand){var _this=_super.call(this,"FieldValue.increment")||this;_this._operand=_operand;return _this}return NumericIncrementFieldValueImpl}(FieldValueImpl);var PublicFieldValue=makeConstructorPrivate(FieldValueImpl,"Use FieldValue.<field>() instead.");var RESERVED_FIELD_REGEX=/^__.*__$/;var ParsedSetData=function(){function ParsedSetData(data,fieldMask,fieldTransforms){this.data=data;this.fieldMask=fieldMask;this.fieldTransforms=fieldTransforms}ParsedSetData.prototype.toMutations=function(key,precondition){var mutations=[];if(this.fieldMask!==null){mutations.push(new PatchMutation(key,this.data,this.fieldMask,precondition))}else{mutations.push(new SetMutation(key,this.data,precondition))}if(this.fieldTransforms.length>0){mutations.push(new TransformMutation(key,this.fieldTransforms))}return mutations};return ParsedSetData}();var ParsedUpdateData=function(){function ParsedUpdateData(data,fieldMask,fieldTransforms){this.data=data;this.fieldMask=fieldMask;this.fieldTransforms=fieldTransforms}ParsedUpdateData.prototype.toMutations=function(key,precondition){var mutations=[new PatchMutation(key,this.data,this.fieldMask,precondition)];if(this.fieldTransforms.length>0){mutations.push(new TransformMutation(key,this.fieldTransforms))}return mutations};return ParsedUpdateData}();var UserDataSource;(function(UserDataSource){UserDataSource[UserDataSource["Set"]=0]="Set";UserDataSource[UserDataSource["Update"]=1]="Update";UserDataSource[UserDataSource["MergeSet"]=2]="MergeSet";UserDataSource[UserDataSource["Argument"]=3]="Argument"})(UserDataSource||(UserDataSource={}));function isWrite(dataSource){switch(dataSource){case UserDataSource.Set:case UserDataSource.MergeSet:case UserDataSource.Update:return true;case UserDataSource.Argument:return false;default:throw fail("Unexpected case for UserDataSource: "+dataSource)}}var ParseContext=function(){function ParseContext(dataSource,methodName,path,arrayElement,fieldTransforms,fieldMask){this.dataSource=dataSource;this.methodName=methodName;this.path=path;this.arrayElement=arrayElement;if(fieldTransforms===undefined){this.validatePath()}this.arrayElement=arrayElement!==undefined?arrayElement:false;this.fieldTransforms=fieldTransforms||[];this.fieldMask=fieldMask||[]}ParseContext.prototype.childContextForField=function(field){var childPath=this.path==null?null:this.path.child(field);var context=new ParseContext(this.dataSource,this.methodName,childPath,false,this.fieldTransforms,this.fieldMask);context.validatePathSegment(field);return context};ParseContext.prototype.childContextForFieldPath=function(field){var childPath=this.path==null?null:this.path.child(field);var context=new ParseContext(this.dataSource,this.methodName,childPath,false,this.fieldTransforms,this.fieldMask);context.validatePath();return context};ParseContext.prototype.childContextForArray=function(index){return new ParseContext(this.dataSource,this.methodName,null,true,this.fieldTransforms,this.fieldMask)};ParseContext.prototype.createError=function(reason){var fieldDescription=this.path===null||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+reason+fieldDescription)};ParseContext.prototype.contains=function(fieldPath){return this.fieldMask.find(function(field){return fieldPath.isPrefixOf(field)})!==undefined||this.fieldTransforms.find(function(transform){return fieldPath.isPrefixOf(transform.field)})!==undefined};ParseContext.prototype.validatePath=function(){if(this.path===null){return}for(var i=0;i<this.path.length;i++){this.validatePathSegment(this.path.get(i))}};ParseContext.prototype.validatePathSegment=function(segment){if(isWrite(this.dataSource)&&RESERVED_FIELD_REGEX.test(segment)){throw this.createError("Document fields cannot begin and end with __")}};return ParseContext}();var DocumentKeyReference=function(){function DocumentKeyReference(databaseId,key){this.databaseId=databaseId;this.key=key}return DocumentKeyReference}();var UserDataConverter=function(){function UserDataConverter(preConverter){this.preConverter=preConverter}UserDataConverter.prototype.parseSetData=function(methodName,input){var context=new ParseContext(UserDataSource.Set,methodName,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",context,input);var updateData=this.parseData(input,context);return new ParsedSetData(updateData,null,context.fieldTransforms)};UserDataConverter.prototype.parseMergeData=function(methodName,input,fieldPaths){var context=new ParseContext(UserDataSource.MergeSet,methodName,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",context,input);var updateData=this.parseData(input,context);var fieldMask;var fieldTransforms;if(!fieldPaths){fieldMask=FieldMask.fromArray(context.fieldMask);fieldTransforms=context.fieldTransforms}else{var validatedFieldPaths=new SortedSet(FieldPath.comparator);for(var _i=0,fieldPaths_1=fieldPaths;_i<fieldPaths_1.length;_i++){var stringOrFieldPath=fieldPaths_1[_i];var fieldPath=void 0;if(stringOrFieldPath instanceof FieldPath$1){fieldPath=stringOrFieldPath._internalPath}else if(typeof stringOrFieldPath==="string"){fieldPath=fieldPathFromDotSeparatedString(methodName,stringOrFieldPath)}else{throw fail("Expected stringOrFieldPath to be a string or a FieldPath")}if(!context.contains(fieldPath)){throw new FirestoreError(Code.INVALID_ARGUMENT,"Field '"+fieldPath+"' is specified in your field mask but missing from your input data.")}validatedFieldPaths=validatedFieldPaths.add(fieldPath)}fieldMask=FieldMask.fromSet(validatedFieldPaths);fieldTransforms=context.fieldTransforms.filter(function(transform){return fieldMask.covers(transform.field)})}return new ParsedSetData(updateData,fieldMask,fieldTransforms)};UserDataConverter.prototype.parseUpdateData=function(methodName,input){var _this=this;var context=new ParseContext(UserDataSource.Update,methodName,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",context,input);var fieldMaskPaths=new SortedSet(FieldPath.comparator);var updateData=ObjectValue.EMPTY;forEach(input,function(key,value){var path=fieldPathFromDotSeparatedString(methodName,key);var childContext=context.childContextForFieldPath(path);value=_this.runPreConverter(value,childContext);if(value instanceof DeleteFieldValueImpl){fieldMaskPaths=fieldMaskPaths.add(path)}else{var parsedValue=_this.parseData(value,childContext);if(parsedValue!=null){fieldMaskPaths=fieldMaskPaths.add(path);updateData=updateData.set(path,parsedValue)}}});var mask=FieldMask.fromSet(fieldMaskPaths);return new ParsedUpdateData(updateData,mask,context.fieldTransforms)};UserDataConverter.prototype.parseUpdateVarargs=function(methodName,field,value,moreFieldsAndValues){var context=new ParseContext(UserDataSource.Update,methodName,FieldPath.EMPTY_PATH);var keys=[fieldPathFromArgument(methodName,field)];var values=[value];if(moreFieldsAndValues.length%2!==0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+methodName+"() needs to be called with an even number "+"of arguments that alternate between field names and values.")}for(var i=0;i<moreFieldsAndValues.length;i+=2){keys.push(fieldPathFromArgument(methodName,moreFieldsAndValues[i]));values.push(moreFieldsAndValues[i+1])}var fieldMaskPaths=new SortedSet(FieldPath.comparator);var updateData=ObjectValue.EMPTY;for(var i=0;i<keys.length;++i){var path=keys[i];var childContext=context.childContextForFieldPath(path);var value_1=this.runPreConverter(values[i],childContext);if(value_1 instanceof DeleteFieldValueImpl){fieldMaskPaths=fieldMaskPaths.add(path)}else{var parsedValue=this.parseData(value_1,childContext);if(parsedValue!=null){fieldMaskPaths=fieldMaskPaths.add(path);updateData=updateData.set(path,parsedValue)}}}var mask=FieldMask.fromSet(fieldMaskPaths);return new ParsedUpdateData(updateData,mask,context.fieldTransforms)};UserDataConverter.prototype.parseQueryValue=function(methodName,input){var context=new ParseContext(UserDataSource.Argument,methodName,FieldPath.EMPTY_PATH);var parsed=this.parseData(input,context);assert(parsed!=null,"Parsed data should not be null.");assert(context.fieldTransforms.length===0,"Field transforms should have been disallowed.");return parsed};UserDataConverter.prototype.runPreConverter=function(input,context){try{return this.preConverter(input)}catch(e){var message=errorMessage(e);throw context.createError(message)}};UserDataConverter.prototype.parseData=function(input,context){input=this.runPreConverter(input,context);if(looksLikeJsonObject(input)){validatePlainObject("Unsupported field value:",context,input);return this.parseObject(input,context)}else if(input instanceof FieldValueImpl){this.parseSentinelFieldValue(input,context);return null}else{if(context.path){context.fieldMask.push(context.path)}if(input instanceof Array){if(context.arrayElement){throw context.createError("Nested arrays are not supported")}return this.parseArray(input,context)}else{return this.parseScalarValue(input,context)}}};UserDataConverter.prototype.parseObject=function(obj,context){var _this=this;var result=new SortedMap(primitiveComparator);if(isEmpty(obj)){if(context.path&&context.path.length>0){context.fieldMask.push(context.path)}}else{forEach(obj,function(key,val){var parsedValue=_this.parseData(val,context.childContextForField(key));if(parsedValue!=null){result=result.insert(key,parsedValue)}})}return new ObjectValue(result)};UserDataConverter.prototype.parseArray=function(array,context){var result=[];var entryIndex=0;for(var _i=0,array_1=array;_i<array_1.length;_i++){var entry=array_1[_i];var parsedEntry=this.parseData(entry,context.childContextForArray(entryIndex));if(parsedEntry==null){parsedEntry=NullValue.INSTANCE}result.push(parsedEntry);entryIndex++}return new ArrayValue(result)};UserDataConverter.prototype.parseSentinelFieldValue=function(value,context){if(!isWrite(context.dataSource)){throw context.createError(value._methodName+"() can only be used with update() and set()")}if(context.path===null){throw context.createError(value._methodName+"() is not currently supported inside arrays")}if(value instanceof DeleteFieldValueImpl){if(context.dataSource===UserDataSource.MergeSet){context.fieldMask.push(context.path)}else if(context.dataSource===UserDataSource.Update){assert(context.path.length>0,"FieldValue.delete() at the top level should have already"+" been handled.");throw context.createError("FieldValue.delete() can only appear at the top level "+"of your update data")}else{throw context.createError("FieldValue.delete() cannot be used with set() unless you pass "+"{merge:true}")}}else if(value instanceof ServerTimestampFieldValueImpl){context.fieldTransforms.push(new FieldTransform(context.path,ServerTimestampTransform.instance))}else if(value instanceof ArrayUnionFieldValueImpl){var parsedElements=this.parseArrayTransformElements(value._methodName,value._elements);var arrayUnion=new ArrayUnionTransformOperation(parsedElements);context.fieldTransforms.push(new FieldTransform(context.path,arrayUnion))}else if(value instanceof ArrayRemoveFieldValueImpl){var parsedElements=this.parseArrayTransformElements(value._methodName,value._elements);var arrayRemove=new ArrayRemoveTransformOperation(parsedElements);context.fieldTransforms.push(new FieldTransform(context.path,arrayRemove))}else if(value instanceof NumericIncrementFieldValueImpl){var operand=this.parseQueryValue("FieldValue.increment",value._operand);var numericIncrement=new NumericIncrementTransformOperation(operand);context.fieldTransforms.push(new FieldTransform(context.path,numericIncrement))}else{fail("Unknown FieldValue type: "+value)}};UserDataConverter.prototype.parseScalarValue=function(value,context){if(value===null){return NullValue.INSTANCE}else if(typeof value==="number"){if(isSafeInteger(value)){return new IntegerValue(value)}else{return new DoubleValue(value)}}else if(typeof value==="boolean"){return BooleanValue.of(value)}else if(typeof value==="string"){return new StringValue(value)}else if(value instanceof Date){return new TimestampValue(Timestamp.fromDate(value))}else if(value instanceof Timestamp){return new TimestampValue(new Timestamp(value.seconds,Math.floor(value.nanoseconds/1e3)*1e3))}else if(value instanceof GeoPoint){return new GeoPointValue(value)}else if(value instanceof Blob){return new BlobValue(value)}else if(value instanceof DocumentKeyReference){return new RefValue(value.databaseId,value.key)}else{throw context.createError("Unsupported field value: "+valueDescription(value))}};UserDataConverter.prototype.parseArrayTransformElements=function(methodName,elements){var _this=this;return elements.map(function(element,i){var context=new ParseContext(UserDataSource.Argument,methodName,FieldPath.EMPTY_PATH);return _this.parseData(element,context.childContextForArray(i))})};return UserDataConverter}();function looksLikeJsonObject(input){return typeof input==="object"&&input!==null&&!(input instanceof Array)&&!(input instanceof Date)&&!(input instanceof Timestamp)&&!(input instanceof GeoPoint)&&!(input instanceof Blob)&&!(input instanceof DocumentKeyReference)&&!(input instanceof FieldValueImpl)}function validatePlainObject(message,context,input){if(!looksLikeJsonObject(input)||!isPlainObject(input)){var description=valueDescription(input);if(description==="an object"){throw context.createError(message+" a custom object")}else{throw context.createError(message+" "+description)}}}function fieldPathFromArgument(methodName,path){if(path instanceof FieldPath$1){return path._internalPath}else if(typeof path==="string"){return fieldPathFromDotSeparatedString(methodName,path)}else{var message="Field path arguments must be of type string or FieldPath.";throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+methodName+"() called with invalid data. "+message)}}function fieldPathFromDotSeparatedString(methodName,path){try{return fromDotSeparatedString(path)._internalPath}catch(e){var message=errorMessage(e);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+methodName+"() called with invalid data. "+message)}}function errorMessage(error){return error instanceof Error?error.message:error.toString()}var DEFAULT_HOST="firestore.googleapis.com";var DEFAULT_SSL=true;var DEFAULT_TIMESTAMPS_IN_SNAPSHOTS=true;var CACHE_SIZE_UNLIMITED=LruParams.COLLECTION_DISABLED;var DEFAULT_SYNCHRONIZE_TABS=false;var FirestoreSettings=function(){function FirestoreSettings(settings){if(settings.host===undefined){if(settings.ssl!==undefined){throw new FirestoreError(Code.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set")}this.host=DEFAULT_HOST;this.ssl=DEFAULT_SSL}else{validateNamedType("settings","non-empty string","host",settings.host);this.host=settings.host;validateNamedOptionalType("settings","boolean","ssl",settings.ssl);this.ssl=defaulted(settings.ssl,DEFAULT_SSL)}validateOptionNames("settings",settings,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes"]);validateNamedOptionalType("settings","object","credentials",settings.credentials);this.credentials=settings.credentials;validateNamedOptionalType("settings","boolean","timestampsInSnapshots",settings.timestampsInSnapshots);if(settings.timestampsInSnapshots===true){error("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now.")}else if(settings.timestampsInSnapshots===false){error("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior.")}this.timestampsInSnapshots=defaulted(settings.timestampsInSnapshots,DEFAULT_TIMESTAMPS_IN_SNAPSHOTS);validateNamedOptionalType("settings","number","cacheSizeBytes",settings.cacheSizeBytes);if(settings.cacheSizeBytes===undefined){this.cacheSizeBytes=LruParams.DEFAULT_CACHE_SIZE_BYTES}else{if(settings.cacheSizeBytes!==CACHE_SIZE_UNLIMITED&&settings.cacheSizeBytes<LruParams.MINIMUM_CACHE_SIZE_BYTES){throw new FirestoreError(Code.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+LruParams.MINIMUM_CACHE_SIZE_BYTES)}else{this.cacheSizeBytes=settings.cacheSizeBytes}}}FirestoreSettings.prototype.isEqual=function(other){return this.host===other.host&&this.ssl===other.ssl&&this.timestampsInSnapshots===other.timestampsInSnapshots&&this.credentials===other.credentials&&this.cacheSizeBytes===other.cacheSizeBytes};return FirestoreSettings}();var FirestoreConfig=function(){function FirestoreConfig(){}return FirestoreConfig}();var Firestore=function(){function Firestore(databaseIdOrApp){var _this=this;this._queue=new AsyncQueue;this.INTERNAL={delete:function(options){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(this._firestoreClient){return[2,this._firestoreClient.shutdown(options)]}return[2]})})}};var config=new FirestoreConfig;if(typeof databaseIdOrApp.options==="object"){var app=databaseIdOrApp;config.firebaseApp=app;config.databaseId=Firestore.databaseIdFromApp(app);config.persistenceKey=config.firebaseApp.name;config.credentials=new FirebaseCredentialsProvider(app)}else{var external_1=databaseIdOrApp;if(!external_1.projectId){throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide projectId")}config.databaseId=new DatabaseId(external_1.projectId,external_1.database);config.persistenceKey="[DEFAULT]";config.credentials=new EmptyCredentialsProvider}config.settings=new FirestoreSettings({});this._config=config;this._databaseId=config.databaseId}Firestore.prototype.settings=function(settingsLiteral){validateExactNumberOfArgs("Firestore.settings",arguments,1);validateArgType("Firestore.settings","object",1,settingsLiteral);if(contains(settingsLiteral,"persistence")){throw new FirestoreError(Code.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to '+"firestore.enablePersistence().")}var newSettings=new FirestoreSettings(settingsLiteral);if(this._firestoreClient&&!this._config.settings.isEqual(newSettings)){throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer "+"be changed. You can only call settings() before calling any other "+"methods on a Firestore object.")}this._config.settings=newSettings;if(newSettings.credentials!==undefined){this._config.credentials=makeCredentialsProvider(newSettings.credentials)}};Firestore.prototype.enableNetwork=function(){this.ensureClientConfigured();return this._firestoreClient.enableNetwork()};Firestore.prototype.disableNetwork=function(){this.ensureClientConfigured();return this._firestoreClient.disableNetwork()};Firestore.prototype.enablePersistence=function(settings){if(this._firestoreClient){throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer "+"be enabled. You can only call enablePersistence() before calling "+"any other methods on a Firestore object.")}return this.configureClient(new IndexedDbPersistenceSettings(this._config.settings.cacheSizeBytes,settings!==undefined&&defaulted(settings.experimentalTabSynchronization,DEFAULT_SYNCHRONIZE_TABS)))};Firestore.prototype.ensureClientConfigured=function(){if(!this._firestoreClient){this.configureClient(new MemoryPersistenceSettings)}return this._firestoreClient};Firestore.prototype.configureClient=function(persistenceSettings){var _this=this;assert(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey");assert(!this._firestoreClient,"configureClient() called multiple times");var databaseInfo=new DatabaseInfo(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl);var preConverter=function(value){if(value instanceof DocumentReference){var thisDb=_this._config.databaseId;var otherDb=value.firestore._config.databaseId;if(!otherDb.isEqual(thisDb)){throw new FirestoreError(Code.INVALID_ARGUMENT,"Document reference is for database "+(otherDb.projectId+"/"+otherDb.database+" but should be ")+("for database "+thisDb.projectId+"/"+thisDb.database))}return new DocumentKeyReference(_this._config.databaseId,value._key)}else{return value}};this._dataConverter=new UserDataConverter(preConverter);this._firestoreClient=new FirestoreClient(PlatformSupport.getPlatform(),databaseInfo,this._config.credentials,this._queue);return this._firestoreClient.start(persistenceSettings)};Firestore.databaseIdFromApp=function(app){var options=app.options;if(!contains(options,"projectId")){throw new FirestoreError(Code.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}var projectId=options["projectId"];if(!projectId||typeof projectId!=="string"){throw new FirestoreError(Code.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options")}return new DatabaseId(projectId)};Object.defineProperty(Firestore.prototype,"app",{get:function(){if(!this._config.firebaseApp){throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is "+"not available")}return this._config.firebaseApp},enumerable:true,configurable:true});Firestore.prototype.collection=function(pathString){validateExactNumberOfArgs("Firestore.collection",arguments,1);validateArgType("Firestore.collection","non-empty string",1,pathString);this.ensureClientConfigured();return new CollectionReference(ResourcePath.fromString(pathString),this)};Firestore.prototype.doc=function(pathString){validateExactNumberOfArgs("Firestore.doc",arguments,1);validateArgType("Firestore.doc","non-empty string",1,pathString);this.ensureClientConfigured();return DocumentReference.forPath(ResourcePath.fromString(pathString),this)};Firestore.prototype._collectionGroup=function(collectionId){validateExactNumberOfArgs("Firestore.collectionGroup",arguments,1);validateArgType("Firestore.collectionGroup","non-empty string",1,collectionId);if(collectionId.indexOf("/")>=0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid collection ID '"+collectionId+"' passed to function "+"Firestore.collectionGroup(). Collection IDs must not contain '/'.")}this.ensureClientConfigured();return new Query$1(new Query(ResourcePath.EMPTY_PATH,collectionId),this)};Firestore.prototype.runTransaction=function(updateFunction){var _this=this;validateExactNumberOfArgs("Firestore.runTransaction",arguments,1);validateArgType("Firestore.runTransaction","function",1,updateFunction);return this.ensureClientConfigured().transaction(function(transaction){return updateFunction(new Transaction$1(_this,transaction))})};Firestore.prototype.batch=function(){this.ensureClientConfigured();return new WriteBatch(this)};Object.defineProperty(Firestore,"logLevel",{get:function(){switch(getLogLevel()){case LogLevel.DEBUG:return"debug";case LogLevel.ERROR:return"error";case LogLevel.SILENT:return"silent";default:return fail("Unknown log level: "+getLogLevel())}},enumerable:true,configurable:true});Firestore.setLogLevel=function(level){validateExactNumberOfArgs("Firestore.setLogLevel",arguments,1);validateArgType("Firestore.setLogLevel","non-empty string",1,level);switch(level){case"debug":setLogLevel(LogLevel.DEBUG);break;case"error":setLogLevel(LogLevel.ERROR);break;case"silent":setLogLevel(LogLevel.SILENT);break;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid log level: "+level)}};Firestore.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots};return Firestore}();var Transaction$1=function(){function Transaction(_firestore,_transaction){this._firestore=_firestore;this._transaction=_transaction}Transaction.prototype.get=function(documentRef){var _this=this;validateExactNumberOfArgs("Transaction.get",arguments,1);var ref=validateReference("Transaction.get",documentRef,this._firestore);return this._transaction.lookup([ref._key]).then(function(docs){if(!docs||docs.length!==1){return fail("Mismatch in docs returned from document lookup.")}var doc=docs[0];if(doc instanceof NoDocument){return new DocumentSnapshot(_this._firestore,ref._key,null,false,false)}else if(doc instanceof Document){return new DocumentSnapshot(_this._firestore,ref._key,doc,false,false)}else{throw fail("BatchGetDocumentsRequest returned unexpected document type: "+doc.constructor.name)}})};Transaction.prototype.set=function(documentRef,value,options){validateBetweenNumberOfArgs("Transaction.set",arguments,2,3);var ref=validateReference("Transaction.set",documentRef,this._firestore);options=validateSetOptions("Transaction.set",options);var parsed=options.merge||options.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",value,options.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",value);this._transaction.set(ref._key,parsed);return this};Transaction.prototype.update=function(documentRef,fieldOrUpdateData,value){var moreFieldsAndValues=[];for(var _i=3;_i<arguments.length;_i++){moreFieldsAndValues[_i-3]=arguments[_i]}var ref;var parsed;if(typeof fieldOrUpdateData==="string"||fieldOrUpdateData instanceof FieldPath$1){validateAtLeastNumberOfArgs("Transaction.update",arguments,3);ref=validateReference("Transaction.update",documentRef,this._firestore);parsed=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",fieldOrUpdateData,value,moreFieldsAndValues)}else{validateExactNumberOfArgs("Transaction.update",arguments,2);ref=validateReference("Transaction.update",documentRef,this._firestore);parsed=this._firestore._dataConverter.parseUpdateData("Transaction.update",fieldOrUpdateData)}this._transaction.update(ref._key,parsed);return this};Transaction.prototype.delete=function(documentRef){validateExactNumberOfArgs("Transaction.delete",arguments,1);var ref=validateReference("Transaction.delete",documentRef,this._firestore);this._transaction.delete(ref._key);return this};return Transaction}();var WriteBatch=function(){function WriteBatch(_firestore){this._firestore=_firestore;this._mutations=[];this._committed=false}WriteBatch.prototype.set=function(documentRef,value,options){validateBetweenNumberOfArgs("WriteBatch.set",arguments,2,3);this.verifyNotCommitted();var ref=validateReference("WriteBatch.set",documentRef,this._firestore);options=validateSetOptions("WriteBatch.set",options);var parsed=options.merge||options.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",value,options.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",value);this._mutations=this._mutations.concat(parsed.toMutations(ref._key,Precondition.NONE));return this};WriteBatch.prototype.update=function(documentRef,fieldOrUpdateData,value){var moreFieldsAndValues=[];for(var _i=3;_i<arguments.length;_i++){moreFieldsAndValues[_i-3]=arguments[_i]}this.verifyNotCommitted();var ref;var parsed;if(typeof fieldOrUpdateData==="string"||fieldOrUpdateData instanceof FieldPath$1){validateAtLeastNumberOfArgs("WriteBatch.update",arguments,3);ref=validateReference("WriteBatch.update",documentRef,this._firestore);parsed=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",fieldOrUpdateData,value,moreFieldsAndValues)}else{validateExactNumberOfArgs("WriteBatch.update",arguments,2);ref=validateReference("WriteBatch.update",documentRef,this._firestore);parsed=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",fieldOrUpdateData)}this._mutations=this._mutations.concat(parsed.toMutations(ref._key,Precondition.exists(true)));return this};WriteBatch.prototype.delete=function(documentRef){validateExactNumberOfArgs("WriteBatch.delete",arguments,1);this.verifyNotCommitted();var ref=validateReference("WriteBatch.delete",documentRef,this._firestore);this._mutations=this._mutations.concat(new DeleteMutation(ref._key,Precondition.NONE));return this};WriteBatch.prototype.commit=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){this.verifyNotCommitted();this._committed=true;if(this._mutations.length>0){return[2,this._firestore.ensureClientConfigured().write(this._mutations)]}return[2]})})};WriteBatch.prototype.verifyNotCommitted=function(){if(this._committed){throw new FirestoreError(Code.FAILED_PRECONDITION,"A write batch can no longer be used after commit() "+"has been called.")}};return WriteBatch}();var DocumentReference=function(){function DocumentReference(_key,firestore){this._key=_key;this.firestore=firestore;this._firestoreClient=this.firestore.ensureClientConfigured()}DocumentReference.forPath=function(path,firestore){if(path.length%2!==0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid document reference. Document "+"references must have an even number of segments, but "+(path.canonicalString()+" has "+path.length))}return new DocumentReference(new DocumentKey(path),firestore)};Object.defineProperty(DocumentReference.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:true,configurable:true});Object.defineProperty(DocumentReference.prototype,"parent",{get:function(){return new CollectionReference(this._key.path.popLast(),this.firestore)},enumerable:true,configurable:true});Object.defineProperty(DocumentReference.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:true,configurable:true});DocumentReference.prototype.collection=function(pathString){validateExactNumberOfArgs("DocumentReference.collection",arguments,1);validateArgType("DocumentReference.collection","non-empty string",1,pathString);if(!pathString){throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()")}var path=ResourcePath.fromString(pathString);return new CollectionReference(this._key.path.child(path),this.firestore)};DocumentReference.prototype.isEqual=function(other){if(!(other instanceof DocumentReference)){throw invalidClassError("isEqual","DocumentReference",1,other)}return this.firestore===other.firestore&&this._key.isEqual(other._key)};DocumentReference.prototype.set=function(value,options){validateBetweenNumberOfArgs("DocumentReference.set",arguments,1,2);options=validateSetOptions("DocumentReference.set",options);var parsed=options.merge||options.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",value,options.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",value);return this._firestoreClient.write(parsed.toMutations(this._key,Precondition.NONE))};DocumentReference.prototype.update=function(fieldOrUpdateData,value){var moreFieldsAndValues=[];for(var _i=2;_i<arguments.length;_i++){moreFieldsAndValues[_i-2]=arguments[_i]}var parsed;if(typeof fieldOrUpdateData==="string"||fieldOrUpdateData instanceof FieldPath$1){validateAtLeastNumberOfArgs("DocumentReference.update",arguments,2);parsed=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",fieldOrUpdateData,value,moreFieldsAndValues)}else{validateExactNumberOfArgs("DocumentReference.update",arguments,1);parsed=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",fieldOrUpdateData)}return this._firestoreClient.write(parsed.toMutations(this._key,Precondition.exists(true)))};DocumentReference.prototype.delete=function(){validateExactNumberOfArgs("DocumentReference.delete",arguments,0);return this._firestoreClient.write([new DeleteMutation(this._key,Precondition.NONE)])};DocumentReference.prototype.onSnapshot=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}validateBetweenNumberOfArgs("DocumentReference.onSnapshot",arguments,1,4);var options={includeMetadataChanges:false};var observer;var currArg=0;if(typeof args[currArg]==="object"&&!isPartialObserver(args[currArg])){options=args[currArg];validateOptionNames("DocumentReference.onSnapshot",options,["includeMetadataChanges"]);validateNamedOptionalType("DocumentReference.onSnapshot","boolean","includeMetadataChanges",options.includeMetadataChanges);currArg++}var internalOptions={includeMetadataChanges:options.includeMetadataChanges};if(isPartialObserver(args[currArg])){observer=args[currArg]}else{validateArgType("DocumentReference.onSnapshot","function",currArg,args[currArg]);validateOptionalArgType("DocumentReference.onSnapshot","function",currArg+1,args[currArg+1]);validateOptionalArgType("DocumentReference.onSnapshot","function",currArg+2,args[currArg+2]);observer={next:args[currArg],error:args[currArg+1],complete:args[currArg+2]}}return this.onSnapshotInternal(internalOptions,observer)};DocumentReference.prototype.onSnapshotInternal=function(options,observer){var _this=this;var errHandler=function(err){console.error("Uncaught Error in onSnapshot:",err)};if(observer.error){errHandler=observer.error.bind(observer)}var asyncObserver=new AsyncObserver({next:function(snapshot){if(observer.next){assert(snapshot.docs.size<=1,"Too many documents returned on a document query");var doc=snapshot.docs.get(_this._key);observer.next(new DocumentSnapshot(_this.firestore,_this._key,doc,snapshot.fromCache,snapshot.hasPendingWrites))}},error:errHandler});var internalListener=this._firestoreClient.listen(Query.atPath(this._key.path),asyncObserver,options);return function(){asyncObserver.mute();_this._firestoreClient.unlisten(internalListener)}};DocumentReference.prototype.get=function(options){var _this=this;validateBetweenNumberOfArgs("DocumentReference.get",arguments,0,1);validateGetOptions("DocumentReference.get",options);return new Promise(function(resolve,reject){if(options&&options.source==="cache"){_this.firestore.ensureClientConfigured().getDocumentFromLocalCache(_this._key).then(function(doc){resolve(new DocumentSnapshot(_this.firestore,_this._key,doc,true,doc instanceof Document?doc.hasLocalMutations:false))},reject)}else{_this.getViaSnapshotListener(resolve,reject,options)}})};DocumentReference.prototype.getViaSnapshotListener=function(resolve,reject,options){var unlisten=this.onSnapshotInternal({includeMetadataChanges:true,waitForSyncWhenOnline:true},{next:function(snap){unlisten();if(!snap.exists&&snap.metadata.fromCache){reject(new FirestoreError(Code.UNAVAILABLE,"Failed to get document because the client is "+"offline."))}else if(snap.exists&&snap.metadata.fromCache&&options&&options.source==="server"){reject(new FirestoreError(Code.UNAVAILABLE,"Failed to get document from server. (However, this "+"document does exist in the local cache. Run again "+'without setting source to "server" to '+"retrieve the cached document.)"))}else{resolve(snap)}},error:reject})};return DocumentReference}();var SnapshotMetadata=function(){function SnapshotMetadata(hasPendingWrites,fromCache){this.hasPendingWrites=hasPendingWrites;this.fromCache=fromCache}SnapshotMetadata.prototype.isEqual=function(other){return this.hasPendingWrites===other.hasPendingWrites&&this.fromCache===other.fromCache};return SnapshotMetadata}();var DocumentSnapshot=function(){function DocumentSnapshot(_firestore,_key,_document,_fromCache,_hasPendingWrites){this._firestore=_firestore;this._key=_key;this._document=_document;this._fromCache=_fromCache;this._hasPendingWrites=_hasPendingWrites}DocumentSnapshot.prototype.data=function(options){validateBetweenNumberOfArgs("DocumentSnapshot.data",arguments,0,1);options=validateSnapshotOptions("DocumentSnapshot.data",options);return!this._document?undefined:this.convertObject(this._document.data,FieldValueOptions.fromSnapshotOptions(options,this._firestore._areTimestampsInSnapshotsEnabled()))};DocumentSnapshot.prototype.get=function(fieldPath,options){validateBetweenNumberOfArgs("DocumentSnapshot.get",arguments,1,2);options=validateSnapshotOptions("DocumentSnapshot.get",options);if(this._document){var value=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",fieldPath));if(value!==undefined){return this.convertValue(value,FieldValueOptions.fromSnapshotOptions(options,this._firestore._areTimestampsInSnapshotsEnabled()))}}return undefined};Object.defineProperty(DocumentSnapshot.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:true,configurable:true});Object.defineProperty(DocumentSnapshot.prototype,"ref",{get:function(){return new DocumentReference(this._key,this._firestore)},enumerable:true,configurable:true});Object.defineProperty(DocumentSnapshot.prototype,"exists",{get:function(){return this._document!==null},enumerable:true,configurable:true});Object.defineProperty(DocumentSnapshot.prototype,"metadata",{get:function(){return new SnapshotMetadata(this._hasPendingWrites,this._fromCache)},enumerable:true,configurable:true});DocumentSnapshot.prototype.isEqual=function(other){if(!(other instanceof DocumentSnapshot)){throw invalidClassError("isEqual","DocumentSnapshot",1,other)}return this._firestore===other._firestore&&this._fromCache===other._fromCache&&this._key.isEqual(other._key)&&(this._document===null?other._document===null:this._document.isEqual(other._document))};DocumentSnapshot.prototype.convertObject=function(data,options){var _this=this;var result={};data.forEach(function(key,value){result[key]=_this.convertValue(value,options)});return result};DocumentSnapshot.prototype.convertValue=function(value,options){if(value instanceof ObjectValue){return this.convertObject(value,options)}else if(value instanceof ArrayValue){return this.convertArray(value,options)}else if(value instanceof RefValue){var key=value.value(options);var database=this._firestore.ensureClientConfigured().databaseId();if(!value.databaseId.isEqual(database)){error("Document "+this._key.path+" contains a document "+"reference within a different database ("+(value.databaseId.projectId+"/"+value.databaseId.database+") which is not ")+"supported. It will be treated as a reference in the current "+("database ("+database.projectId+"/"+database.database+") ")+"instead.")}return new DocumentReference(key,this._firestore)}else{return value.value(options)}};DocumentSnapshot.prototype.convertArray=function(data,options){var _this=this;return data.internalValue.map(function(value){return _this.convertValue(value,options)})};return DocumentSnapshot}();var QueryDocumentSnapshot=function(_super){tslib_1.__extends(QueryDocumentSnapshot,_super);function QueryDocumentSnapshot(firestore,key,document,fromCache,hasPendingWrites){return _super.call(this,firestore,key,document,fromCache,hasPendingWrites)||this}QueryDocumentSnapshot.prototype.data=function(options){var data=_super.prototype.data.call(this,options);assert(typeof data==="object","Document in a QueryDocumentSnapshot should exist");return data};return QueryDocumentSnapshot}(DocumentSnapshot);var Query$1=function(){function Query(_query,firestore){this._query=_query;this.firestore=firestore}Query.prototype.where=function(field,opStr,value){validateExactNumberOfArgs("Query.where",arguments,3);validateArgType("Query.where","non-empty string",2,opStr);validateDefined("Query.where",3,value);var fieldValue;var fieldPath=fieldPathFromArgument("Query.where",field);var relationOp=RelationOp.fromString(opStr);if(fieldPath.isKeyField()){if(relationOp===RelationOp.ARRAY_CONTAINS){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on "+"FieldPath.documentId() since document IDs are not arrays.")}if(typeof value==="string"){if(value===""){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a "+"valid document ID if the first parameter is "+"FieldPath.documentId(), but it was an empty string.")}if(!this._query.isCollectionGroupQuery()&&value.indexOf("/")!==-1){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection by "+"FieldPath.documentId(), the value provided must be a plain document ID, but "+("'"+value+"' contains a slash."))}var path=this._query.path.child(ResourcePath.fromString(value));if(!DocumentKey.isDocumentKey(path)){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection group by "+"FieldPath.documentId(), the value provided must result in a valid document path, "+("but '"+path+"' is not because it has an odd number of segments ("+path.length+")."))}fieldValue=new RefValue(this.firestore._databaseId,new DocumentKey(path))}else if(value instanceof DocumentReference){var ref=value;fieldValue=new RefValue(this.firestore._databaseId,ref._key)}else{throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a "+"string or a DocumentReference if the first parameter is "+"FieldPath.documentId(), but it was: "+(valueDescription(value)+"."))}}else{fieldValue=this.firestore._dataConverter.parseQueryValue("Query.where",value)}var filter=Filter.create(fieldPath,relationOp,fieldValue);this.validateNewFilter(filter);return new Query(this._query.addFilter(filter),this.firestore)};Query.prototype.orderBy=function(field,directionStr){validateBetweenNumberOfArgs("Query.orderBy",arguments,1,2);validateOptionalArgType("Query.orderBy","non-empty string",2,directionStr);var direction;if(directionStr===undefined||directionStr==="asc"){direction=Direction.ASCENDING}else if(directionStr==="desc"){direction=Direction.DESCENDING}else{throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+directionStr+"', "+"expected 'asc' or 'desc'.")}if(this._query.startAt!==null){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or "+"Query.startAfter() before calling Query.orderBy().")}if(this._query.endAt!==null){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or "+"Query.endBefore() before calling Query.orderBy().")}var fieldPath=fieldPathFromArgument("Query.orderBy",field);var orderBy=new OrderBy(fieldPath,direction);this.validateNewOrderBy(orderBy);return new Query(this._query.addOrderBy(orderBy),this.firestore)};Query.prototype.limit=function(n){validateExactNumberOfArgs("Query.limit",arguments,1);validateArgType("Query.limit","number",1,n);if(n<=0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. Query limit ("+n+") is invalid. Limit must be "+"positive.")}return new Query(this._query.withLimit(n),this.firestore)};Query.prototype.startAt=function(docOrField){var fields=[];for(var _i=1;_i<arguments.length;_i++){fields[_i-1]=arguments[_i]}validateAtLeastNumberOfArgs("Query.startAt",arguments,1);var bound=this.boundFromDocOrFields("Query.startAt",docOrField,fields,true);return new Query(this._query.withStartAt(bound),this.firestore)};Query.prototype.startAfter=function(docOrField){var fields=[];for(var _i=1;_i<arguments.length;_i++){fields[_i-1]=arguments[_i]}validateAtLeastNumberOfArgs("Query.startAfter",arguments,1);var bound=this.boundFromDocOrFields("Query.startAfter",docOrField,fields,false);return new Query(this._query.withStartAt(bound),this.firestore)};Query.prototype.endBefore=function(docOrField){var fields=[];for(var _i=1;_i<arguments.length;_i++){fields[_i-1]=arguments[_i]}validateAtLeastNumberOfArgs("Query.endBefore",arguments,1);var bound=this.boundFromDocOrFields("Query.endBefore",docOrField,fields,true);return new Query(this._query.withEndAt(bound),this.firestore)};Query.prototype.endAt=function(docOrField){var fields=[];for(var _i=1;_i<arguments.length;_i++){fields[_i-1]=arguments[_i]}validateAtLeastNumberOfArgs("Query.endAt",arguments,1);var bound=this.boundFromDocOrFields("Query.endAt",docOrField,fields,false);return new Query(this._query.withEndAt(bound),this.firestore)};Query.prototype.isEqual=function(other){if(!(other instanceof Query)){throw invalidClassError("isEqual","Query",1,other)}return this.firestore===other.firestore&&this._query.isEqual(other._query)};Query.prototype.boundFromDocOrFields=function(methodName,docOrField,fields,before){validateDefined(methodName,1,docOrField);if(docOrField instanceof DocumentSnapshot){if(fields.length>0){throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+methodName+"().")}var snap=docOrField;if(!snap.exists){throw new FirestoreError(Code.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+(methodName+"()."))}return this.boundFromDocument(methodName,snap._document,before)}else{var allFields=[docOrField].concat(fields);return this.boundFromFields(methodName,allFields,before)}};Query.prototype.boundFromDocument=function(methodName,doc,before){var components=[];for(var _i=0,_a=this._query.orderBy;_i<_a.length;_i++){var orderBy=_a[_i];if(orderBy.field.isKeyField()){components.push(new RefValue(this.firestore._databaseId,doc.key))}else{var value=doc.field(orderBy.field);if(value instanceof ServerTimestampValue){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a "+'document for which the field "'+orderBy.field+'" is an uncommitted server timestamp. (Since the value of '+"this field is unknown, you cannot start/end a query with it.)")}else if(value!==undefined){components.push(value)}else{var field=orderBy.field.canonicalString();throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a "+("document for which the field '"+field+"' (used as the ")+"orderBy) does not exist.")}}}return new Bound(components,before)};Query.prototype.boundFromFields=function(methodName,values,before){var orderBy=this._query.explicitOrderBy;if(values.length>orderBy.length){throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+methodName+"(). "+"The number of arguments must be less than or equal to the "+"number of Query.orderBy() clauses")}var components=[];for(var i=0;i<values.length;i++){var rawValue=values[i];var orderByComponent=orderBy[i];if(orderByComponent.field.isKeyField()){if(typeof rawValue!=="string"){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+(methodName+"(), but got a "+typeof rawValue))}if(!this._query.isCollectionGroupQuery()&&rawValue.indexOf("/")!==-1){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), "+("the value passed to "+methodName+"() must be a plain document ID, but ")+("'"+rawValue+"' contains a slash."))}var path=this._query.path.child(ResourcePath.fromString(rawValue));if(!DocumentKey.isDocumentKey(path)){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by "+("FieldPath.documentId(), the value passed to "+methodName+"() must result in a ")+("valid document path, but '"+path+"' is not because it contains an odd number ")+"of segments.")}var key=new DocumentKey(path);components.push(new RefValue(this.firestore._databaseId,key))}else{var wrapped=this.firestore._dataConverter.parseQueryValue(methodName,rawValue);components.push(wrapped)}}return new Bound(components,before)};Query.prototype.onSnapshot=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}validateBetweenNumberOfArgs("Query.onSnapshot",arguments,1,4);var options={};var observer;var currArg=0;if(typeof args[currArg]==="object"&&!isPartialObserver(args[currArg])){options=args[currArg];validateOptionNames("Query.onSnapshot",options,["includeMetadataChanges"]);validateNamedOptionalType("Query.onSnapshot","boolean","includeMetadataChanges",options.includeMetadataChanges);currArg++}if(isPartialObserver(args[currArg])){observer=args[currArg]}else{validateArgType("Query.onSnapshot","function",currArg,args[currArg]);validateOptionalArgType("Query.onSnapshot","function",currArg+1,args[currArg+1]);validateOptionalArgType("Query.onSnapshot","function",currArg+2,args[currArg+2]);observer={next:args[currArg],error:args[currArg+1],complete:args[currArg+2]}}return this.onSnapshotInternal(options,observer)};Query.prototype.onSnapshotInternal=function(options,observer){var _this=this;var errHandler=function(err){console.error("Uncaught Error in onSnapshot:",err)};if(observer.error){errHandler=observer.error.bind(observer)}var asyncObserver=new AsyncObserver({next:function(result){if(observer.next){observer.next(new QuerySnapshot(_this.firestore,_this._query,result))}},error:errHandler});var firestoreClient=this.firestore.ensureClientConfigured();var internalListener=firestoreClient.listen(this._query,asyncObserver,options);return function(){asyncObserver.mute();firestoreClient.unlisten(internalListener)}};Query.prototype.get=function(options){var _this=this;validateBetweenNumberOfArgs("Query.get",arguments,0,1);validateGetOptions("Query.get",options);return new Promise(function(resolve,reject){if(options&&options.source==="cache"){_this.firestore.ensureClientConfigured().getDocumentsFromLocalCache(_this._query).then(function(viewSnap){resolve(new QuerySnapshot(_this.firestore,_this._query,viewSnap))},reject)}else{_this.getViaSnapshotListener(resolve,reject,options)}})};Query.prototype.getViaSnapshotListener=function(resolve,reject,options){var unlisten=this.onSnapshotInternal({includeMetadataChanges:true,waitForSyncWhenOnline:true},{next:function(result){unlisten();if(result.metadata.fromCache&&options&&options.source==="server"){reject(new FirestoreError(Code.UNAVAILABLE,"Failed to get documents from server. (However, these "+"documents may exist in the local cache. Run again "+'without setting source to "server" to '+"retrieve the cached documents.)"))}else{resolve(result)}},error:reject})};Query.prototype.validateNewFilter=function(filter){if(filter instanceof RelationFilter){if(filter.isInequality()){var existingField=this._query.getInequalityFilterField();if(existingField!==null&&!existingField.isEqual(filter.field)){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality"+" (<, <=, >, or >=) must be on the same field. But you have"+(" inequality filters on '"+existingField.toString()+"'")+(" and '"+filter.field.toString()+"'"))}var firstOrderByField=this._query.getFirstOrderByField();if(firstOrderByField!==null){this.validateOrderByAndInequalityMatch(filter.field,firstOrderByField)}}else if(filter.op===RelationOp.ARRAY_CONTAINS){if(this._query.hasArrayContainsFilter()){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains "+"filter.")}}}};Query.prototype.validateNewOrderBy=function(orderBy){if(this._query.getFirstOrderByField()===null){var inequalityField=this._query.getInequalityFilterField();if(inequalityField!==null){this.validateOrderByAndInequalityMatch(inequalityField,orderBy.field)}}};Query.prototype.validateOrderByAndInequalityMatch=function(inequality,orderBy){if(!orderBy.isEqual(inequality)){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality "+("(<, <=, >, or >=) on field '"+inequality.toString()+"' ")+("and so you must also use '"+inequality.toString()+"' ")+"as your first Query.orderBy(), but your first Query.orderBy() "+("is on field '"+orderBy.toString()+"' instead."))}};return Query}();var QuerySnapshot=function(){function QuerySnapshot(_firestore,_originalQuery,_snapshot){this._firestore=_firestore;this._originalQuery=_originalQuery;this._snapshot=_snapshot;this._cachedChanges=null;this._cachedChangesIncludeMetadataChanges=null;this.metadata=new SnapshotMetadata(_snapshot.hasPendingWrites,_snapshot.fromCache)}Object.defineProperty(QuerySnapshot.prototype,"docs",{get:function(){var result=[];this.forEach(function(doc){return result.push(doc)});return result},enumerable:true,configurable:true});Object.defineProperty(QuerySnapshot.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:true,configurable:true});Object.defineProperty(QuerySnapshot.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:true,configurable:true});QuerySnapshot.prototype.forEach=function(callback,thisArg){var _this=this;validateBetweenNumberOfArgs("QuerySnapshot.forEach",arguments,1,2);validateArgType("QuerySnapshot.forEach","function",1,callback);this._snapshot.docs.forEach(function(doc){callback.call(thisArg,_this.convertToDocumentImpl(doc))})};Object.defineProperty(QuerySnapshot.prototype,"query",{get:function(){return new Query$1(this._originalQuery,this._firestore)},enumerable:true,configurable:true});QuerySnapshot.prototype.docChanges=function(options){if(options){validateOptionNames("QuerySnapshot.docChanges",options,["includeMetadataChanges"]);validateNamedOptionalType("QuerySnapshot.docChanges","boolean","includeMetadataChanges",options.includeMetadataChanges)}var includeMetadataChanges=!!(options&&options.includeMetadataChanges);if(includeMetadataChanges&&this._snapshot.excludesMetadataChanges){throw new FirestoreError(Code.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must "+"also pass { includeMetadataChanges:true } to onSnapshot().")}if(!this._cachedChanges||this._cachedChangesIncludeMetadataChanges!==includeMetadataChanges){this._cachedChanges=changesFromSnapshot(this._firestore,includeMetadataChanges,this._snapshot);this._cachedChangesIncludeMetadataChanges=includeMetadataChanges}return this._cachedChanges};QuerySnapshot.prototype.isEqual=function(other){if(!(other instanceof QuerySnapshot)){throw invalidClassError("isEqual","QuerySnapshot",1,other)}return this._firestore===other._firestore&&this._originalQuery.isEqual(other._originalQuery)&&this._snapshot.isEqual(other._snapshot)};QuerySnapshot.prototype.convertToDocumentImpl=function(doc){return new QueryDocumentSnapshot(this._firestore,doc.key,doc,this.metadata.fromCache,this._snapshot.mutatedKeys.has(doc.key))};return QuerySnapshot}();function throwDocChangesMethodError(){throw new FirestoreError(Code.INVALID_ARGUMENT,"QuerySnapshot.docChanges has been changed from a property into a "+'method, so usages like "querySnapshot.docChanges" should become '+'"querySnapshot.docChanges()"')}var docChangesPropertiesToOverride=["length","forEach","map"].concat(typeof Symbol!=="undefined"?[Symbol.iterator]:[]);docChangesPropertiesToOverride.forEach(function(property){try{Object.defineProperty(QuerySnapshot.prototype.docChanges,property,{get:function(){return throwDocChangesMethodError()}})}catch(err){}});var CollectionReference=function(_super){tslib_1.__extends(CollectionReference,_super);function CollectionReference(path,firestore){var _this=_super.call(this,Query.atPath(path),firestore)||this;if(path.length%2!==1){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid collection reference. Collection "+"references must have an odd number of segments, but "+(path.canonicalString()+" has "+path.length))}return _this}Object.defineProperty(CollectionReference.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:true,configurable:true});Object.defineProperty(CollectionReference.prototype,"parent",{get:function(){var parentPath=this._query.path.popLast();if(parentPath.isEmpty()){return null}else{return new DocumentReference(new DocumentKey(parentPath),this.firestore)}},enumerable:true,configurable:true});Object.defineProperty(CollectionReference.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:true,configurable:true});CollectionReference.prototype.doc=function(pathString){validateBetweenNumberOfArgs("CollectionReference.doc",arguments,0,1);if(arguments.length===0){pathString=AutoId.newId()}validateArgType("CollectionReference.doc","non-empty string",1,pathString);if(pathString===""){throw new FirestoreError(Code.INVALID_ARGUMENT,"Document path must be a non-empty string")}var path=ResourcePath.fromString(pathString);return DocumentReference.forPath(this._query.path.child(path),this.firestore)};CollectionReference.prototype.add=function(value){validateExactNumberOfArgs("CollectionReference.add",arguments,1);validateArgType("CollectionReference.add","object",1,value);var docRef=this.doc();return docRef.set(value).then(function(){return docRef})};return CollectionReference}(Query$1);function validateSetOptions(methodName,options){if(options===undefined){return{merge:false}}validateOptionNames(methodName,options,["merge","mergeFields"]);validateNamedOptionalType(methodName,"boolean","merge",options.merge);validateOptionalArrayElements(methodName,"mergeFields","a string or a FieldPath",options.mergeFields,function(element){return typeof element==="string"||element instanceof FieldPath$1});if(options.mergeFields!==undefined&&options.merge!==undefined){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid options passed to function "+methodName+'(): You cannot specify both "merge" '+'and "mergeFields".')}return options}function validateSnapshotOptions(methodName,options){if(options===undefined){return{}}validateOptionNames(methodName,options,["serverTimestamps"]);validateNamedOptionalPropertyEquals(methodName,"options","serverTimestamps",options.serverTimestamps,["estimate","previous","none"]);return options}function validateGetOptions(methodName,options){validateOptionalArgType(methodName,"object",1,options);if(options){validateOptionNames(methodName,options,["source"]);validateNamedOptionalPropertyEquals(methodName,"options","source",options.source,["default","server","cache"])}}function validateReference(methodName,documentRef,firestore){if(!(documentRef instanceof DocumentReference)){throw invalidClassError(methodName,"DocumentReference",1,documentRef)}else if(documentRef.firestore!==firestore){throw new FirestoreError(Code.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.")}else{return documentRef}}function changesFromSnapshot(firestore,includeMetadataChanges,snapshot){if(snapshot.oldDocs.isEmpty()){var lastDoc_1;var index_1=0;return snapshot.docChanges.map(function(change){var doc=new QueryDocumentSnapshot(firestore,change.doc.key,change.doc,snapshot.fromCache,snapshot.mutatedKeys.has(change.doc.key));assert(change.type===ChangeType.Added,"Invalid event type for first snapshot");assert(!lastDoc_1||snapshot.query.docComparator(lastDoc_1,change.doc)<0,"Got added events in wrong order");lastDoc_1=change.doc;return{type:"added",doc:doc,oldIndex:-1,newIndex:index_1++}})}else{var indexTracker_1=snapshot.oldDocs;return snapshot.docChanges.filter(function(change){return includeMetadataChanges||change.type!==ChangeType.Metadata}).map(function(change){var doc=new QueryDocumentSnapshot(firestore,change.doc.key,change.doc,snapshot.fromCache,snapshot.mutatedKeys.has(change.doc.key));var oldIndex=-1;var newIndex=-1;if(change.type!==ChangeType.Added){oldIndex=indexTracker_1.indexOf(change.doc.key);assert(oldIndex>=0,"Index for document not found");indexTracker_1=indexTracker_1.delete(change.doc.key)}if(change.type!==ChangeType.Removed){indexTracker_1=indexTracker_1.add(change.doc);newIndex=indexTracker_1.indexOf(change.doc.key)}return{type:resultChangeType(change.type),doc:doc,oldIndex:oldIndex,newIndex:newIndex}})}}function resultChangeType(type){switch(type){case ChangeType.Added:return"added";case ChangeType.Modified:case ChangeType.Metadata:return"modified";case ChangeType.Removed:return"removed";default:return fail("Unknown change type: "+type)}}var PublicFirestore=makeConstructorPrivate(Firestore,"Use firebase.firestore() instead.");var PublicTransaction=makeConstructorPrivate(Transaction$1,"Use firebase.firestore().runTransaction() instead.");var PublicWriteBatch=makeConstructorPrivate(WriteBatch,"Use firebase.firestore().batch() instead.");var PublicDocumentReference=makeConstructorPrivate(DocumentReference,"Use firebase.firestore().doc() instead.");var PublicDocumentSnapshot=makeConstructorPrivate(DocumentSnapshot);var PublicQueryDocumentSnapshot=makeConstructorPrivate(QueryDocumentSnapshot);var PublicQuery=makeConstructorPrivate(Query$1);var PublicQuerySnapshot=makeConstructorPrivate(QuerySnapshot);var PublicCollectionReference=makeConstructorPrivate(CollectionReference,"Use firebase.firestore().collection() instead.");var firestoreNamespace={Firestore:PublicFirestore,GeoPoint:GeoPoint,Timestamp:Timestamp,Blob:PublicBlob,Transaction:PublicTransaction,WriteBatch:PublicWriteBatch,DocumentReference:PublicDocumentReference,DocumentSnapshot:PublicDocumentSnapshot,Query:PublicQuery,QueryDocumentSnapshot:PublicQueryDocumentSnapshot,QuerySnapshot:PublicQuerySnapshot,CollectionReference:PublicCollectionReference,FieldPath:FieldPath$1,FieldValue:PublicFieldValue,setLogLevel:Firestore.setLogLevel,CACHE_SIZE_UNLIMITED:CACHE_SIZE_UNLIMITED};function configureForFirebase(firebase){firebase.INTERNAL.registerService("firestore",function(app){return new Firestore(app)},shallowCopy(firestoreNamespace))}function registerFirestore(instance){configureForFirebase(instance)}registerFirestore(firebase);exports.registerFirestore=registerFirestore}).call(this,require("_process"))},{"@firebase/app":5,"@firebase/logger":8,"@firebase/util":11,"@firebase/webchannel-wrapper":12,_process:182,tslib:188}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var instances=[];(function(LogLevel){LogLevel[LogLevel["DEBUG"]=0]="DEBUG";LogLevel[LogLevel["VERBOSE"]=1]="VERBOSE";LogLevel[LogLevel["INFO"]=2]="INFO";LogLevel[LogLevel["WARN"]=3]="WARN";LogLevel[LogLevel["ERROR"]=4]="ERROR";LogLevel[LogLevel["SILENT"]=5]="SILENT"})(exports.LogLevel||(exports.LogLevel={}));var defaultLogLevel=exports.LogLevel.INFO;var defaultLogHandler=function(instance,logType){var args=[];for(var _i=2;_i<arguments.length;_i++){args[_i-2]=arguments[_i]}if(logType<instance.logLevel)return;var now=(new Date).toISOString();switch(logType){case exports.LogLevel.DEBUG:console.log.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;case exports.LogLevel.VERBOSE:console.log.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;case exports.LogLevel.INFO:console.info.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;case exports.LogLevel.WARN:console.warn.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;case exports.LogLevel.ERROR:console.error.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+logType+")")}};var Logger=function(){function Logger(name){this.name=name;this._logLevel=defaultLogLevel;this._logHandler=defaultLogHandler;instances.push(this)}Object.defineProperty(Logger.prototype,"logLevel",{get:function(){return this._logLevel},set:function(val){if(!(val in exports.LogLevel)){throw new TypeError("Invalid value assigned to `logLevel`")}this._logLevel=val},enumerable:true,configurable:true});Object.defineProperty(Logger.prototype,"logHandler",{get:function(){return this._logHandler},set:function(val){if(typeof val!=="function"){throw new TypeError("Value assigned to `logHandler` must be a function")}this._logHandler=val},enumerable:true,configurable:true});Logger.prototype.debug=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this._logHandler.apply(this,[this,exports.LogLevel.DEBUG].concat(args))};Logger.prototype.log=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this._logHandler.apply(this,[this,exports.LogLevel.VERBOSE].concat(args))};Logger.prototype.info=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this._logHandler.apply(this,[this,exports.LogLevel.INFO].concat(args))};Logger.prototype.warn=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this._logHandler.apply(this,[this,exports.LogLevel.WARN].concat(args))};Logger.prototype.error=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this._logHandler.apply(this,[this,exports.LogLevel.ERROR].concat(args))};return Logger}();function setLogLevel(level){instances.forEach(function(inst){inst.logLevel=level})}exports.setLogLevel=setLogLevel;exports.Logger=Logger},{}],9:[function(require,module,exports){"use strict";require("whatwg-fetch");require("promise-polyfill/lib/polyfill");require("core-js/features/array/find");require("core-js/features/array/find-index");require("core-js/features/object/assign");require("core-js/features/string/starts-with");require("core-js/features/string/repeat");require("core-js/features/symbol");require("core-js/features/symbol/iterator")},{"core-js/features/array/find":47,"core-js/features/array/find-index":46,"core-js/features/object/assign":48,"core-js/features/string/repeat":49,"core-js/features/string/starts-with":50,"core-js/features/symbol":51,"core-js/features/symbol/iterator":52,"promise-polyfill/lib/polyfill":183,"whatwg-fetch":10}],10:[function(require,module,exports){(function(self){"use strict";if(self.fetch){return}var support={searchParams:"URLSearchParams"in self,iterable:"Symbol"in self&&"iterator"in Symbol,blob:"FileReader"in self&&"Blob"in self&&function(){try{new Blob;return true}catch(e){return false}}(),formData:"FormData"in self,arrayBuffer:"ArrayBuffer"in self};if(support.arrayBuffer){var viewClasses=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"];var isDataView=function(obj){return obj&&DataView.prototype.isPrototypeOf(obj)};var isArrayBufferView=ArrayBuffer.isView||function(obj){return obj&&viewClasses.indexOf(Object.prototype.toString.call(obj))>-1}}function normalizeName(name){if(typeof name!=="string"){name=String(name)}if(/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(name)){throw new TypeError("Invalid character in header field name")}return name.toLowerCase()}function normalizeValue(value){if(typeof value!=="string"){value=String(value)}return value}function iteratorFor(items){var iterator={next:function(){var value=items.shift();return{done:value===undefined,value:value}}};if(support.iterable){iterator[Symbol.iterator]=function(){return iterator}}return iterator}function Headers(headers){this.map={};if(headers instanceof Headers){headers.forEach(function(value,name){this.append(name,value)},this)}else if(Array.isArray(headers)){headers.forEach(function(header){this.append(header[0],header[1])},this)}else if(headers){Object.getOwnPropertyNames(headers).forEach(function(name){this.append(name,headers[name])},this)}}Headers.prototype.append=function(name,value){name=normalizeName(name);value=normalizeValue(value);var oldValue=this.map[name];this.map[name]=oldValue?oldValue+","+value:value};Headers.prototype["delete"]=function(name){delete this.map[normalizeName(name)]};Headers.prototype.get=function(name){name=normalizeName(name);return this.has(name)?this.map[name]:null};Headers.prototype.has=function(name){return this.map.hasOwnProperty(normalizeName(name))};Headers.prototype.set=function(name,value){this.map[normalizeName(name)]=normalizeValue(value)};Headers.prototype.forEach=function(callback,thisArg){for(var name in this.map){if(this.map.hasOwnProperty(name)){callback.call(thisArg,this.map[name],name,this)}}};Headers.prototype.keys=function(){var items=[];this.forEach(function(value,name){items.push(name)});return iteratorFor(items)};Headers.prototype.values=function(){var items=[];this.forEach(function(value){items.push(value)});return iteratorFor(items)};Headers.prototype.entries=function(){var items=[];this.forEach(function(value,name){items.push([name,value])});return iteratorFor(items)};if(support.iterable){Headers.prototype[Symbol.iterator]=Headers.prototype.entries}function consumed(body){if(body.bodyUsed){return Promise.reject(new TypeError("Already read"))}body.bodyUsed=true}function fileReaderReady(reader){return new Promise(function(resolve,reject){reader.onload=function(){resolve(reader.result)};reader.onerror=function(){reject(reader.error)}})}function readBlobAsArrayBuffer(blob){var reader=new FileReader;var promise=fileReaderReady(reader);reader.readAsArrayBuffer(blob);return promise}function readBlobAsText(blob){var reader=new FileReader;var promise=fileReaderReady(reader);reader.readAsText(blob);return promise}function readArrayBufferAsText(buf){var view=new Uint8Array(buf);var chars=new Array(view.length);for(var i=0;i<view.length;i++){chars[i]=String.fromCharCode(view[i])}return chars.join("")}function bufferClone(buf){if(buf.slice){return buf.slice(0)}else{var view=new Uint8Array(buf.byteLength);view.set(new Uint8Array(buf));return view.buffer}}function Body(){this.bodyUsed=false;this._initBody=function(body){this._bodyInit=body;if(!body){this._bodyText=""}else if(typeof body==="string"){this._bodyText=body}else if(support.blob&&Blob.prototype.isPrototypeOf(body)){this._bodyBlob=body}else if(support.formData&&FormData.prototype.isPrototypeOf(body)){this._bodyFormData=body}else if(support.searchParams&&URLSearchParams.prototype.isPrototypeOf(body)){this._bodyText=body.toString()}else if(support.arrayBuffer&&support.blob&&isDataView(body)){this._bodyArrayBuffer=bufferClone(body.buffer);this._bodyInit=new Blob([this._bodyArrayBuffer])}else if(support.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(body)||isArrayBufferView(body))){this._bodyArrayBuffer=bufferClone(body)}else{throw new Error("unsupported BodyInit type")}if(!this.headers.get("content-type")){if(typeof body==="string"){this.headers.set("content-type","text/plain;charset=UTF-8")}else if(this._bodyBlob&&this._bodyBlob.type){this.headers.set("content-type",this._bodyBlob.type)}else if(support.searchParams&&URLSearchParams.prototype.isPrototypeOf(body)){this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8")}}};if(support.blob){this.blob=function(){var rejected=consumed(this);if(rejected){return rejected}if(this._bodyBlob){return Promise.resolve(this._bodyBlob)}else if(this._bodyArrayBuffer){return Promise.resolve(new Blob([this._bodyArrayBuffer]))}else if(this._bodyFormData){throw new Error("could not read FormData body as blob")}else{return Promise.resolve(new Blob([this._bodyText]))}};this.arrayBuffer=function(){if(this._bodyArrayBuffer){return consumed(this)||Promise.resolve(this._bodyArrayBuffer)}else{return this.blob().then(readBlobAsArrayBuffer)}}}this.text=function(){var rejected=consumed(this);if(rejected){return rejected}if(this._bodyBlob){return readBlobAsText(this._bodyBlob)}else if(this._bodyArrayBuffer){return Promise.resolve(readArrayBufferAsText(this._bodyArrayBuffer))}else if(this._bodyFormData){throw new Error("could not read FormData body as text")}else{return Promise.resolve(this._bodyText)}};if(support.formData){this.formData=function(){return this.text().then(decode)}}this.json=function(){return this.text().then(JSON.parse)};return this}var methods=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function normalizeMethod(method){var upcased=method.toUpperCase();return methods.indexOf(upcased)>-1?upcased:method}function Request(input,options){options=options||{};var body=options.body;if(input instanceof Request){if(input.bodyUsed){throw new TypeError("Already read")}this.url=input.url;this.credentials=input.credentials;if(!options.headers){this.headers=new Headers(input.headers)}this.method=input.method;this.mode=input.mode;if(!body&&input._bodyInit!=null){body=input._bodyInit;input.bodyUsed=true}}else{this.url=String(input)}this.credentials=options.credentials||this.credentials||"omit";if(options.headers||!this.headers){this.headers=new Headers(options.headers)}this.method=normalizeMethod(options.method||this.method||"GET");this.mode=options.mode||this.mode||null;this.referrer=null;if((this.method==="GET"||this.method==="HEAD")&&body){throw new TypeError("Body not allowed for GET or HEAD requests")}this._initBody(body)}Request.prototype.clone=function(){return new Request(this,{body:this._bodyInit})};function decode(body){var form=new FormData;body.trim().split("&").forEach(function(bytes){if(bytes){var split=bytes.split("=");var name=split.shift().replace(/\+/g," ");var value=split.join("=").replace(/\+/g," ");form.append(decodeURIComponent(name),decodeURIComponent(value))}});return form}function parseHeaders(rawHeaders){var headers=new Headers;var preProcessedHeaders=rawHeaders.replace(/\r?\n[\t ]+/g," ");preProcessedHeaders.split(/\r?\n/).forEach(function(line){var parts=line.split(":");var key=parts.shift().trim();if(key){var value=parts.join(":").trim();headers.append(key,value)}});return headers}Body.call(Request.prototype);function Response(bodyInit,options){if(!options){options={}}this.type="default";this.status=options.status===undefined?200:options.status;this.ok=this.status>=200&&this.status<300;this.statusText="statusText"in options?options.statusText:"OK";this.headers=new Headers(options.headers);this.url=options.url||"";this._initBody(bodyInit)}Body.call(Response.prototype);Response.prototype.clone=function(){return new Response(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new Headers(this.headers),url:this.url})};Response.error=function(){var response=new Response(null,{status:0,statusText:""});response.type="error";return response};var redirectStatuses=[301,302,303,307,308];Response.redirect=function(url,status){if(redirectStatuses.indexOf(status)===-1){throw new RangeError("Invalid status code")}return new Response(null,{status:status,headers:{location:url}})};self.Headers=Headers;self.Request=Request;self.Response=Response;self.fetch=function(input,init){return new Promise(function(resolve,reject){var request=new Request(input,init);var xhr=new XMLHttpRequest;xhr.onload=function(){var options={status:xhr.status,statusText:xhr.statusText,headers:parseHeaders(xhr.getAllResponseHeaders()||"")};options.url="responseURL"in xhr?xhr.responseURL:options.headers.get("X-Request-URL");var body="response"in xhr?xhr.response:xhr.responseText;resolve(new Response(body,options))};xhr.onerror=function(){reject(new TypeError("Network request failed"))};xhr.ontimeout=function(){reject(new TypeError("Network request failed"))};xhr.open(request.method,request.url,true);if(request.credentials==="include"){xhr.withCredentials=true}else if(request.credentials==="omit"){xhr.withCredentials=false}if("responseType"in xhr&&support.blob){xhr.responseType="blob"}request.headers.forEach(function(value,name){xhr.setRequestHeader(name,value)});xhr.send(typeof request._bodyInit==="undefined"?null:request._bodyInit)})};self.fetch.polyfill=true})(typeof self!=="undefined"?self:this)},{}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var CONSTANTS={NODE_CLIENT:false,NODE_ADMIN:false,SDK_VERSION:"${JSCORE_VERSION}"};var assert=function(assertion,message){if(!assertion){throw assertionError(message)}};var assertionError=function(message){return new Error("Firebase Database ("+CONSTANTS.SDK_VERSION+") INTERNAL ASSERT FAILED: "+message)};var stringToByteArray=function(str){var out=[],p=0;for(var i=0;i<str.length;i++){var c=str.charCodeAt(i);if(c<128){out[p++]=c}else if(c<2048){out[p++]=c>>6|192;out[p++]=c&63|128}else if((c&64512)==55296&&i+1<str.length&&(str.charCodeAt(i+1)&64512)==56320){c=65536+((c&1023)<<10)+(str.charCodeAt(++i)&1023);out[p++]=c>>18|240;out[p++]=c>>12&63|128;out[p++]=c>>6&63|128;out[p++]=c&63|128}else{out[p++]=c>>12|224;out[p++]=c>>6&63|128;out[p++]=c&63|128}}return out};var byteArrayToString=function(bytes){var out=[],pos=0,c=0;while(pos<bytes.length){var c1=bytes[pos++];if(c1<128){out[c++]=String.fromCharCode(c1)}else if(c1>191&&c1<224){var c2=bytes[pos++];out[c++]=String.fromCharCode((c1&31)<<6|c2&63)}else if(c1>239&&c1<365){var c2=bytes[pos++];var c3=bytes[pos++];var c4=bytes[pos++];var u=((c1&7)<<18|(c2&63)<<12|(c3&63)<<6|c4&63)-65536;out[c++]=String.fromCharCode(55296+(u>>10));out[c++]=String.fromCharCode(56320+(u&1023))}else{var c2=bytes[pos++];var c3=bytes[pos++];out[c++]=String.fromCharCode((c1&15)<<12|(c2&63)<<6|c3&63)}}return out.join("")};var base64={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ"+"abcdefghijklmnopqrstuvwxyz"+"0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob==="function",encodeByteArray:function(input,opt_webSafe){if(!Array.isArray(input)){throw Error("encodeByteArray takes an array as a parameter")}this.init_();var byteToCharMap=opt_webSafe?this.byteToCharMapWebSafe_:this.byteToCharMap_;var output=[];for(var i=0;i<input.length;i+=3){var byte1=input[i];var haveByte2=i+1<input.length;var byte2=haveByte2?input[i+1]:0;var haveByte3=i+2<input.length;var byte3=haveByte3?input[i+2]:0;var outByte1=byte1>>2;var outByte2=(byte1&3)<<4|byte2>>4;var outByte3=(byte2&15)<<2|byte3>>6;var outByte4=byte3&63;if(!haveByte3){outByte4=64;if(!haveByte2){outByte3=64}}output.push(byteToCharMap[outByte1],byteToCharMap[outByte2],byteToCharMap[outByte3],byteToCharMap[outByte4])}return output.join("")},encodeString:function(input,opt_webSafe){if(this.HAS_NATIVE_SUPPORT&&!opt_webSafe){return btoa(input)}return this.encodeByteArray(stringToByteArray(input),opt_webSafe)},decodeString:function(input,opt_webSafe){if(this.HAS_NATIVE_SUPPORT&&!opt_webSafe){return atob(input)}return byteArrayToString(this.decodeStringToByteArray(input,opt_webSafe))},decodeStringToByteArray:function(input,opt_webSafe){this.init_();var charToByteMap=opt_webSafe?this.charToByteMapWebSafe_:this.charToByteMap_;var output=[];for(var i=0;i<input.length;){var byte1=charToByteMap[input.charAt(i++)];var haveByte2=i<input.length;var byte2=haveByte2?charToByteMap[input.charAt(i)]:0;++i;var haveByte3=i<input.length;var byte3=haveByte3?charToByteMap[input.charAt(i)]:64;++i;var haveByte4=i<input.length;var byte4=haveByte4?charToByteMap[input.charAt(i)]:64;++i;if(byte1==null||byte2==null||byte3==null||byte4==null){throw Error()}var outByte1=byte1<<2|byte2>>4;output.push(outByte1);if(byte3!=64){var outByte2=byte2<<4&240|byte3>>2;output.push(outByte2);if(byte4!=64){var outByte3=byte3<<6&192|byte4;output.push(outByte3)}}}return output},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={};this.charToByteMap_={};this.byteToCharMapWebSafe_={};this.charToByteMapWebSafe_={};for(var i=0;i<this.ENCODED_VALS.length;i++){this.byteToCharMap_[i]=this.ENCODED_VALS.charAt(i);this.charToByteMap_[this.byteToCharMap_[i]]=i;this.byteToCharMapWebSafe_[i]=this.ENCODED_VALS_WEBSAFE.charAt(i);this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[i]]=i;if(i>=this.ENCODED_VALS_BASE.length){this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(i)]=i;this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(i)]=i}}}}};var base64Encode=function(str){var utf8Bytes=stringToByteArray(str);return base64.encodeByteArray(utf8Bytes,true)};var base64Decode=function(str){try{return base64.decodeString(str,true)}catch(e){console.error("base64Decode failed: ",e)}return null};function deepCopy(value){return deepExtend(undefined,value)}function deepExtend(target,source){if(!(source instanceof Object)){return source}switch(source.constructor){case Date:var dateValue=source;return new Date(dateValue.getTime());case Object:if(target===undefined){target={}}break;case Array:target=[];break;default:return source}for(var prop in source){if(!source.hasOwnProperty(prop)){continue}target[prop]=deepExtend(target[prop],source[prop])}return target}function patchProperty(obj,prop,value){obj[prop]=value}var Deferred=function(){function Deferred(){var _this=this;this.promise=new Promise(function(resolve,reject){_this.resolve=resolve;_this.reject=reject})}Deferred.prototype.wrapCallback=function(callback){var _this=this;return function(error,value){if(error){_this.reject(error)}else{_this.resolve(value)}if(typeof callback==="function"){_this.promise.catch(function(){});if(callback.length===1){callback(error)}else{callback(error,value)}}}};return Deferred}();var getUA=function(){if(typeof navigator!=="undefined"&&typeof navigator["userAgent"]==="string"){return navigator["userAgent"]}else{return""}};var isMobileCordova=function(){return typeof window!=="undefined"&&!!(window["cordova"]||window["phonegap"]||window["PhoneGap"])&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(getUA())};var isReactNative=function(){return typeof navigator==="object"&&navigator["product"]==="ReactNative"};var isNodeSdk=function(){return CONSTANTS.NODE_CLIENT===true||CONSTANTS.NODE_ADMIN===true};var ERROR_NAME="FirebaseError";var captureStackTrace=Error.captureStackTrace;function patchCapture(captureFake){var result=captureStackTrace;captureStackTrace=captureFake;return result}var FirebaseError=function(){function FirebaseError(code,message){this.code=code;this.message=message;if(captureStackTrace){captureStackTrace(this,ErrorFactory.prototype.create)}else{try{throw Error.apply(this,arguments)}catch(err){this.name=ERROR_NAME;Object.defineProperty(this,"stack",{get:function(){return err.stack}})}}}return FirebaseError}();FirebaseError.prototype=Object.create(Error.prototype);FirebaseError.prototype.constructor=FirebaseError;FirebaseError.prototype.name=ERROR_NAME;var ErrorFactory=function(){function ErrorFactory(service,serviceName,errors){this.service=service;this.serviceName=serviceName;this.errors=errors;this.pattern=/\{\$([^}]+)}/g}ErrorFactory.prototype.create=function(code,data){if(data===undefined){data={}}var template=this.errors[code];var fullCode=this.service+"/"+code;var message;if(template===undefined){message="Error"}else{message=template.replace(this.pattern,function(match,key){var value=data[key];return value!==undefined?value.toString():"<"+key+"?>"})}message=this.serviceName+": "+message+" ("+fullCode+").";var err=new FirebaseError(fullCode,message);for(var prop in data){if(!data.hasOwnProperty(prop)||prop.slice(-1)==="_"){continue}err[prop]=data[prop]}return err};return ErrorFactory}();function jsonEval(str){return JSON.parse(str)}function stringify(data){return JSON.stringify(data)}var decode=function(token){var header={},claims={},data={},signature="";try{var parts=token.split(".");header=jsonEval(base64Decode(parts[0])||"");claims=jsonEval(base64Decode(parts[1])||"");signature=parts[2];data=claims["d"]||{};delete claims["d"]}catch(e){}return{header:header,claims:claims,data:data,signature:signature}};var isValidTimestamp=function(token){var claims=decode(token).claims,now=Math.floor((new Date).getTime()/1e3),validSince,validUntil;if(typeof claims==="object"){if(claims.hasOwnProperty("nbf")){validSince=claims["nbf"]}else if(claims.hasOwnProperty("iat")){validSince=claims["iat"]}if(claims.hasOwnProperty("exp")){validUntil=claims["exp"]}else{validUntil=validSince+86400}}return now&&validSince&&validUntil&&now>=validSince&&now<=validUntil};var issuedAtTime=function(token){var claims=decode(token).claims;if(typeof claims==="object"&&claims.hasOwnProperty("iat")){return claims["iat"]}return null};var isValidFormat=function(token){var decoded=decode(token),claims=decoded.claims;return!!claims&&typeof claims==="object"&&claims.hasOwnProperty("iat")};var isAdmin=function(token){var claims=decode(token).claims;return typeof claims==="object"&&claims["admin"]===true};var contains=function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)};var safeGet=function(obj,key){if(Object.prototype.hasOwnProperty.call(obj,key))return obj[key]};var forEach=function(obj,fn){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){fn(key,obj[key])}}};var extend=function(objTo,objFrom){forEach(objFrom,function(key,value){objTo[key]=value});return objTo};var clone=function(obj){return extend({},obj)};var isNonNullObject=function(obj){return typeof obj==="object"&&obj!==null};var isEmpty=function(obj){for(var key in obj){return false}return true};var getCount=function(obj){var rv=0;for(var key in obj){rv++}return rv};var map=function(obj,f,opt_obj){var res={};for(var key in obj){res[key]=f.call(opt_obj,obj[key],key,obj)}return res};var findKey=function(obj,fn,opt_this){for(var key in obj){if(fn.call(opt_this,obj[key],key,obj)){return key}}return undefined};var findValue=function(obj,fn,opt_this){var key=findKey(obj,fn,opt_this);return key&&obj[key]};var getAnyKey=function(obj){for(var key in obj){return key}};var getValues=function(obj){var res=[];var i=0;for(var key in obj){res[i++]=obj[key]}return res};var every=function(obj,fn){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){if(!fn(key,obj[key])){return false}}}return true};var querystring=function(querystringParams){var params=[];forEach(querystringParams,function(key,value){if(Array.isArray(value)){value.forEach(function(arrayVal){params.push(encodeURIComponent(key)+"="+encodeURIComponent(arrayVal))})}else{params.push(encodeURIComponent(key)+"="+encodeURIComponent(value))}});return params.length?"&"+params.join("&"):""};var querystringDecode=function(querystring){var obj={};var tokens=querystring.replace(/^\?/,"").split("&");tokens.forEach(function(token){if(token){var key=token.split("=");obj[key[0]]=key[1]}});return obj};var Hash=function(){function Hash(){this.blockSize=-1}return Hash}();var Sha1=function(_super){tslib_1.__extends(Sha1,_super);function Sha1(){var _this=_super.call(this)||this;_this.chain_=[];_this.buf_=[];_this.W_=[];_this.pad_=[];_this.inbuf_=0;_this.total_=0;_this.blockSize=512/8;_this.pad_[0]=128;for(var i=1;i<_this.blockSize;++i){_this.pad_[i]=0}_this.reset();return _this}Sha1.prototype.reset=function(){this.chain_[0]=1732584193;this.chain_[1]=4023233417;this.chain_[2]=2562383102;this.chain_[3]=271733878;this.chain_[4]=3285377520;this.inbuf_=0;this.total_=0};Sha1.prototype.compress_=function(buf,opt_offset){if(!opt_offset){opt_offset=0}var W=this.W_;if(typeof buf==="string"){for(var i=0;i<16;i++){W[i]=buf.charCodeAt(opt_offset)<<24|buf.charCodeAt(opt_offset+1)<<16|buf.charCodeAt(opt_offset+2)<<8|buf.charCodeAt(opt_offset+3);opt_offset+=4}}else{for(var i=0;i<16;i++){W[i]=buf[opt_offset]<<24|buf[opt_offset+1]<<16|buf[opt_offset+2]<<8|buf[opt_offset+3];opt_offset+=4}}for(var i=16;i<80;i++){var t=W[i-3]^W[i-8]^W[i-14]^W[i-16];W[i]=(t<<1|t>>>31)&4294967295}var a=this.chain_[0];var b=this.chain_[1];var c=this.chain_[2];var d=this.chain_[3];var e=this.chain_[4];var f,k;for(var i=0;i<80;i++){if(i<40){if(i<20){f=d^b&(c^d);k=1518500249}else{f=b^c^d;k=1859775393}}else{if(i<60){f=b&c|d&(b|c);k=2400959708}else{f=b^c^d;k=3395469782}}var t=(a<<5|a>>>27)+f+e+k+W[i]&4294967295;e=d;d=c;c=(b<<30|b>>>2)&4294967295;b=a;a=t}this.chain_[0]=this.chain_[0]+a&4294967295;this.chain_[1]=this.chain_[1]+b&4294967295;this.chain_[2]=this.chain_[2]+c&4294967295;this.chain_[3]=this.chain_[3]+d&4294967295;this.chain_[4]=this.chain_[4]+e&4294967295};Sha1.prototype.update=function(bytes,opt_length){if(bytes==null){return}if(opt_length===undefined){opt_length=bytes.length}var lengthMinusBlock=opt_length-this.blockSize;var n=0;var buf=this.buf_;var inbuf=this.inbuf_;while(n<opt_length){if(inbuf==0){while(n<=lengthMinusBlock){this.compress_(bytes,n);n+=this.blockSize}}if(typeof bytes==="string"){while(n<opt_length){buf[inbuf]=bytes.charCodeAt(n);++inbuf;++n;if(inbuf==this.blockSize){this.compress_(buf);inbuf=0;break}}}else{while(n<opt_length){buf[inbuf]=bytes[n];++inbuf;++n;if(inbuf==this.blockSize){this.compress_(buf);inbuf=0;break}}}}this.inbuf_=inbuf;this.total_+=opt_length};Sha1.prototype.digest=function(){var digest=[];var totalBits=this.total_*8;if(this.inbuf_<56){this.update(this.pad_,56-this.inbuf_)}else{this.update(this.pad_,this.blockSize-(this.inbuf_-56))}for(var i=this.blockSize-1;i>=56;i--){this.buf_[i]=totalBits&255;totalBits/=256}this.compress_(this.buf_);var n=0;for(var i=0;i<5;i++){for(var j=24;j>=0;j-=8){digest[n]=this.chain_[i]>>j&255;++n}}return digest};return Sha1}(Hash);function createSubscribe(executor,onNoObservers){var proxy=new ObserverProxy(executor,onNoObservers);return proxy.subscribe.bind(proxy)}var ObserverProxy=function(){function ObserverProxy(executor,onNoObservers){var _this=this;this.observers=[];this.unsubscribes=[];this.observerCount=0;this.task=Promise.resolve();this.finalized=false;this.onNoObservers=onNoObservers;this.task.then(function(){executor(_this)}).catch(function(e){_this.error(e)})}ObserverProxy.prototype.next=function(value){this.forEachObserver(function(observer){observer.next(value)})};ObserverProxy.prototype.error=function(error){this.forEachObserver(function(observer){observer.error(error)});this.close(error)};ObserverProxy.prototype.complete=function(){this.forEachObserver(function(observer){observer.complete()});this.close()};ObserverProxy.prototype.subscribe=function(nextOrObserver,error,complete){var _this=this;var observer;if(nextOrObserver===undefined&&error===undefined&&complete===undefined){throw new Error("Missing Observer.")}if(implementsAnyMethods(nextOrObserver,["next","error","complete"])){observer=nextOrObserver}else{observer={next:nextOrObserver,error:error,complete:complete}}if(observer.next===undefined){observer.next=noop}if(observer.error===undefined){observer.error=noop}if(observer.complete===undefined){observer.complete=noop}var unsub=this.unsubscribeOne.bind(this,this.observers.length);if(this.finalized){this.task.then(function(){try{if(_this.finalError){observer.error(_this.finalError)}else{observer.complete()}}catch(e){}return})}this.observers.push(observer);return unsub};ObserverProxy.prototype.unsubscribeOne=function(i){if(this.observers===undefined||this.observers[i]===undefined){return}delete this.observers[i];this.observerCount-=1;if(this.observerCount===0&&this.onNoObservers!==undefined){this.onNoObservers(this)}};ObserverProxy.prototype.forEachObserver=function(fn){if(this.finalized){return}for(var i=0;i<this.observers.length;i++){this.sendOne(i,fn)}};ObserverProxy.prototype.sendOne=function(i,fn){var _this=this;this.task.then(function(){if(_this.observers!==undefined&&_this.observers[i]!==undefined){try{fn(_this.observers[i])}catch(e){if(typeof console!=="undefined"&&console.error){console.error(e)}}}})};ObserverProxy.prototype.close=function(err){var _this=this;if(this.finalized){return}this.finalized=true;if(err!==undefined){this.finalError=err}this.task.then(function(){_this.observers=undefined;_this.onNoObservers=undefined})};return ObserverProxy}();function async(fn,onError){return function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}Promise.resolve(true).then(function(){fn.apply(void 0,args)}).catch(function(error){if(onError){onError(error)}})}}function implementsAnyMethods(obj,methods){if(typeof obj!=="object"||obj===null){return false}for(var _i=0,methods_1=methods;_i<methods_1.length;_i++){var method=methods_1[_i];if(method in obj&&typeof obj[method]==="function"){return true}}return false}function noop(){}var validateArgCount=function(fnName,minCount,maxCount,argCount){var argError;if(argCount<minCount){argError="at least "+minCount}else if(argCount>maxCount){argError=maxCount===0?"none":"no more than "+maxCount}if(argError){var error=fnName+" failed: Was called with "+argCount+(argCount===1?" argument.":" arguments.")+" Expects "+argError+".";throw new Error(error)}};function errorPrefix(fnName,argumentNumber,optional){var argName="";switch(argumentNumber){case 1:argName=optional?"first":"First";break;case 2:argName=optional?"second":"Second";break;case 3:argName=optional?"third":"Third";break;case 4:argName=optional?"fourth":"Fourth";break;default:throw new Error("errorPrefix called with argumentNumber > 4.  Need to update it?")}var error=fnName+" failed: ";error+=argName+" argument ";return error}function validateNamespace(fnName,argumentNumber,namespace,optional){if(optional&&!namespace)return;if(typeof namespace!=="string"){throw new Error(errorPrefix(fnName,argumentNumber,optional)+"must be a valid firebase namespace.")}}function validateCallback(fnName,argumentNumber,callback,optional){if(optional&&!callback)return;if(typeof callback!=="function")throw new Error(errorPrefix(fnName,argumentNumber,optional)+"must be a valid function.")}function validateContextObject(fnName,argumentNumber,context,optional){if(optional&&!context)return;if(typeof context!=="object"||context===null)throw new Error(errorPrefix(fnName,argumentNumber,optional)+"must be a valid context object.")}var stringToByteArray$1=function(str){var out=[],p=0;for(var i=0;i<str.length;i++){var c=str.charCodeAt(i);if(c>=55296&&c<=56319){var high=c-55296;i++;assert(i<str.length,"Surrogate pair missing trail surrogate.");var low=str.charCodeAt(i)-56320;c=65536+(high<<10)+low}if(c<128){out[p++]=c}else if(c<2048){out[p++]=c>>6|192;out[p++]=c&63|128}else if(c<65536){out[p++]=c>>12|224;out[p++]=c>>6&63|128;out[p++]=c&63|128}else{out[p++]=c>>18|240;out[p++]=c>>12&63|128;out[p++]=c>>6&63|128;out[p++]=c&63|128}}return out};var stringLength=function(str){var p=0;for(var i=0;i<str.length;i++){var c=str.charCodeAt(i);if(c<128){p++}else if(c<2048){p+=2}else if(c>=55296&&c<=56319){p+=4;i++}else{p+=3}}return p};exports.assert=assert;exports.assertionError=assertionError;exports.base64=base64;exports.base64Decode=base64Decode;exports.base64Encode=base64Encode;exports.CONSTANTS=CONSTANTS;exports.deepCopy=deepCopy;exports.deepExtend=deepExtend;exports.patchProperty=patchProperty;exports.Deferred=Deferred;exports.getUA=getUA;exports.isMobileCordova=isMobileCordova;exports.isNodeSdk=isNodeSdk;exports.isReactNative=isReactNative;exports.ErrorFactory=ErrorFactory;exports.FirebaseError=FirebaseError;exports.patchCapture=patchCapture;exports.jsonEval=jsonEval;exports.stringify=stringify;exports.decode=decode;exports.isAdmin=isAdmin;exports.issuedAtTime=issuedAtTime;exports.isValidFormat=isValidFormat;exports.isValidTimestamp=isValidTimestamp;exports.clone=clone;exports.contains=contains;exports.every=every;exports.extend=extend;exports.findKey=findKey;exports.findValue=findValue;exports.forEach=forEach;exports.getAnyKey=getAnyKey;exports.getCount=getCount;exports.getValues=getValues;exports.isEmpty=isEmpty;exports.isNonNullObject=isNonNullObject;exports.map=map;exports.safeGet=safeGet;exports.querystring=querystring;exports.querystringDecode=querystringDecode;exports.Sha1=Sha1;exports.async=async;exports.createSubscribe=createSubscribe;exports.errorPrefix=errorPrefix;exports.validateArgCount=validateArgCount;exports.validateCallback=validateCallback;exports.validateContextObject=validateContextObject;exports.validateNamespace=validateNamespace;exports.stringLength=stringLength;exports.stringToByteArray=stringToByteArray$1},{tslib:188}],12:[function(require,module,exports){(function(global){(function(){"use strict";var e,goog=goog||{},h=this;function l(a){return"string"==typeof a}function n(a,b){a=a.split(".");b=b||h;for(var c=0;c<a.length;c++)if(b=b[a[c]],null==b)return null;return b}function p(){}function q(a){var b=typeof a;if("object"==b)if(a){if(a instanceof Array)return"array";if(a instanceof Object)return b;var c=Object.prototype.toString.call(a);if("[object Window]"==c)return"object";if("[object Array]"==c||"number"==typeof a.length&&"undefined"!=typeof a.splice&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("splice"))return"array";if("[object Function]"==c||"undefined"!=typeof a.call&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("call"))return"function"}else return"null";else if("function"==b&&"undefined"==typeof a.call)return"object";return b}function r(a){return"array"==q(a)}function aa(a){var b=q(a);return"array"==b||"object"==b&&"number"==typeof a.length}function t(a){var b=typeof a;return"object"==b&&null!=a||"function"==b}var u="closure_uid_"+(1e9*Math.random()>>>0),ba=0;function ca(a,b,c){return a.call.apply(a.bind,arguments)}function da(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c)}}return function(){return a.apply(b,arguments)}}function v(a,b,c){Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?v=ca:v=da;return v.apply(null,arguments)}function w(a,b){var c=Array.prototype.slice.call(arguments,1);return function(){var b=c.slice();b.push.apply(b,arguments);return a.apply(this,b)}}var x=Date.now||function(){return+new Date};function y(a,b){function c(){}c.prototype=b.prototype;a.S=b.prototype;a.prototype=new c;a.prototype.constructor=a;a.re=function(a,c,g){for(var d=Array(arguments.length-2),f=2;f<arguments.length;f++)d[f-2]=arguments[f];return b.prototype[c].apply(a,d)}}function z(){0!=ea&&(fa[this[u]||(this[u]=++ba)]=this);this.i=this.i;this.j=this.j}var ea=0,fa={};z.prototype.i=!1;z.prototype.La=function(){if(!this.i&&(this.i=!0,this.G(),0!=ea)){var a=this[u]||(this[u]=++ba);if(0!=ea&&this.j&&0<this.j.length)throw Error(this+" did not empty its onDisposeCallbacks queue. This probably means it overrode dispose() or disposeInternal() without calling the superclass' method.");delete fa[a]}};z.prototype.G=function(){if(this.j)for(;this.j.length;)this.j.shift()()};var ha=Array.prototype.indexOf?function(a,b){return Array.prototype.indexOf.call(a,b,void 0)}:function(a,b){if(l(a))return l(b)&&1==b.length?a.indexOf(b,0):-1;for(var c=0;c<a.length;c++)if(c in a&&a[c]===b)return c;return-1},A=Array.prototype.forEach?function(a,b,c){Array.prototype.forEach.call(a,b,c)}:function(a,b,c){for(var d=a.length,f=l(a)?a.split(""):a,g=0;g<d;g++)g in f&&b.call(c,f[g],g,a)};function ia(a){a:{var b=ja;for(var c=a.length,d=l(a)?a.split(""):a,f=0;f<c;f++)if(f in d&&b.call(void 0,d[f],f,a)){b=f;break a}b=-1}return 0>b?null:l(a)?a.charAt(b):a[b]}function ka(a){return Array.prototype.concat.apply([],arguments)}function la(a){var b=a.length;if(0<b){for(var c=Array(b),d=0;d<b;d++)c[d]=a[d];return c}return[]}function B(a){return/^[\s\xa0]*$/.test(a)}var ma=String.prototype.trim?function(a){return a.trim()}:function(a){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(a)[1]};function C(a,b){return-1!=a.indexOf(b)}function na(a,b){return a<b?-1:a>b?1:0}var D;a:{var oa=h.navigator;if(oa){var pa=oa.userAgent;if(pa){D=pa;break a}}D=""}function qa(a,b,c){for(var d in a)b.call(c,a[d],d,a)}function ra(a){var b={},c;for(c in a)b[c]=a[c];return b}var sa="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ta(a,b){for(var c,d,f=1;f<arguments.length;f++){d=arguments[f];for(c in d)a[c]=d[c];for(var g=0;g<sa.length;g++)c=sa[g],Object.prototype.hasOwnProperty.call(d,c)&&(a[c]=d[c])}}function ua(a){ua[" "](a);return a}ua[" "]=p;function va(a,b){var c=wa;return Object.prototype.hasOwnProperty.call(c,a)?c[a]:c[a]=b(a)}var xa=C(D,"Opera"),E=C(D,"Trident")||C(D,"MSIE"),ya=C(D,"Edge"),za=ya||E,Aa=C(D,"Gecko")&&!(C(D.toLowerCase(),"webkit")&&!C(D,"Edge"))&&!(C(D,"Trident")||C(D,"MSIE"))&&!C(D,"Edge"),Ba=C(D.toLowerCase(),"webkit")&&!C(D,"Edge");function Ca(){var a=h.document;return a?a.documentMode:void 0}var Da;a:{var Ea="",Fa=function(){var a=D;if(Aa)return/rv:([^\);]+)(\)|;)/.exec(a);if(ya)return/Edge\/([\d\.]+)/.exec(a);if(E)return/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(a);if(Ba)return/WebKit\/(\S+)/.exec(a);if(xa)return/(?:Version)[ \/]?(\S+)/.exec(a)}();Fa&&(Ea=Fa?Fa[1]:"");if(E){var Ga=Ca();if(null!=Ga&&Ga>parseFloat(Ea)){Da=String(Ga);break a}}Da=Ea}var wa={};function Ha(a){return va(a,function(){for(var b=0,c=ma(String(Da)).split("."),d=ma(String(a)).split("."),f=Math.max(c.length,d.length),g=0;0==b&&g<f;g++){var k=c[g]||"",m=d[g]||"";do{k=/(\d*)(\D*)(.*)/.exec(k)||["","","",""];m=/(\d*)(\D*)(.*)/.exec(m)||["","","",""];if(0==k[0].length&&0==m[0].length)break;b=na(0==k[1].length?0:parseInt(k[1],10),0==m[1].length?0:parseInt(m[1],10))||na(0==k[2].length,0==m[2].length)||na(k[2],m[2]);k=k[3];m=m[3]}while(0==b)}return 0<=b})}var Ia;var Ka=h.document;Ia=Ka&&E?Ca()||("CSS1Compat"==Ka.compatMode?parseInt(Da,10):5):void 0;var La=!E||9<=Number(Ia),Ma=E&&!Ha("9"),Na=function(){if(!h.addEventListener||!Object.defineProperty)return!1;var a=!1,b=Object.defineProperty({},"passive",{get:function(){a=!0}});try{h.addEventListener("test",p,b),h.removeEventListener("test",p,b)}catch(c){}return a}();function F(a,b){this.type=a;this.a=this.target=b;this.b=!1;this.hc=!0}F.prototype.c=function(){this.hc=!1};function G(a,b){F.call(this,a?a.type:"");this.relatedTarget=this.a=this.target=null;this.button=this.screenY=this.screenX=this.clientY=this.clientX=0;this.key="";this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1;this.pointerId=0;this.pointerType="";this.f=null;a&&this.g(a,b)}y(G,F);var Oa={2:"touch",3:"pen",4:"mouse"};G.prototype.g=function(a,b){var c=this.type=a.type,d=a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:null;this.target=a.target||a.srcElement;this.a=b;if(b=a.relatedTarget){if(Aa){a:{try{ua(b.nodeName);var f=!0;break a}catch(g){}f=!1}f||(b=null)}}else"mouseover"==c?b=a.fromElement:"mouseout"==c&&(b=a.toElement);this.relatedTarget=b;d?(this.clientX=void 0!==d.clientX?d.clientX:d.pageX,this.clientY=void 0!==d.clientY?d.clientY:d.pageY,this.screenX=d.screenX||0,this.screenY=d.screenY||0):(this.clientX=void 0!==a.clientX?a.clientX:a.pageX,this.clientY=void 0!==a.clientY?a.clientY:a.pageY,this.screenX=a.screenX||0,this.screenY=a.screenY||0);this.button=a.button;this.key=a.key||"";this.ctrlKey=a.ctrlKey;this.altKey=a.altKey;this.shiftKey=a.shiftKey;this.metaKey=a.metaKey;this.pointerId=a.pointerId||0;this.pointerType=l(a.pointerType)?a.pointerType:Oa[a.pointerType]||"";this.f=a;a.defaultPrevented&&this.c()};G.prototype.c=function(){G.S.c.call(this);var a=this.f;if(a.preventDefault)a.preventDefault();else if(a.returnValue=!1,Ma)try{if(a.ctrlKey||112<=a.keyCode&&123>=a.keyCode)a.keyCode=-1}catch(b){}};var H="closure_listenable_"+(1e6*Math.random()|0),Pa=0;function Qa(a,b,c,d,f){this.listener=a;this.proxy=null;this.src=b;this.type=c;this.capture=!!d;this.ya=f;this.key=++Pa;this.ja=this.oa=!1}Qa.prototype.a=function(){this.ja=!0;this.ya=this.src=this.proxy=this.listener=null};function Ra(a){this.src=a;this.a={};this.b=0}e=Ra.prototype;e.add=function(a,b,c,d,f){var g=a.toString();a=this.a[g];a||(a=this.a[g]=[],this.b++);var k=Sa(a,b,d,f);-1<k?(b=a[k],c||(b.oa=!1)):(b=new Qa(b,this.src,g,!!d,f),b.oa=c,a.push(b));return b};e.Sc=function(a,b,c,d){a=a.toString();if(a in this.a){var f=this.a[a];b=Sa(f,b,c,d);-1<b&&(f[b].a(),Array.prototype.splice.call(f,b,1),0==f.length&&(delete this.a[a],this.b--))}};e.fc=function(a){var b=a.type;if(b in this.a){var c=this.a[b],d=ha(c,a),f;(f=0<=d)&&Array.prototype.splice.call(c,d,1);f&&(a.a(),0==this.a[b].length&&(delete this.a[b],this.b--))}};e.Tc=function(){var a=0,b;for(b in this.a){for(var c=this.a[b],d=0;d<c.length;d++)++a,c[d].a();delete this.a[b];this.b--}};e.Rc=function(a,b,c,d){a=this.a[a.toString()];var f=-1;a&&(f=Sa(a,b,c,d));return-1<f?a[f]:null};function Sa(a,b,c,d){for(var f=0;f<a.length;++f){var g=a[f];if(!g.ja&&g.listener==b&&g.capture==!!c&&g.ya==d)return f}return-1}var Ta="closure_lm_"+(1e6*Math.random()|0),Ua={},Va=0;function Wa(a,b,c,d,f){if(d&&d.once)return Xa(a,b,c,d,f);if(r(b)){for(var g=0;g<b.length;g++)Wa(a,b[g],c,d,f);return null}c=Ya(c);return a&&a[H]?a.Lb(b,c,t(d)?!!d.capture:!!d,f):Za(a,b,c,!1,d,f)}function Za(a,b,c,d,f,g){if(!b)throw Error("Invalid event type");var k=t(f)?!!f.capture:!!f;if(k&&!La)return null;var m=$a(a);m||(a[Ta]=m=new Ra(a));c=m.add(b,c,d,k,g);if(c.proxy)return c;d=ab();c.proxy=d;d.src=a;d.listener=c;if(a.addEventListener)Na||(f=k),void 0===f&&(f=!1),a.addEventListener(b.toString(),d,f);else if(a.attachEvent)a.attachEvent(bb(b.toString()),d);else if(a.addListener&&a.removeListener)a.addListener(d);else throw Error("addEventListener and attachEvent are unavailable.");Va++;return c}function ab(){var a=cb,b=La?function(c){return a.call(b.src,b.listener,c)}:function(c){c=a.call(b.src,b.listener,c);if(!c)return c};return b}function Xa(a,b,c,d,f){if(r(b)){for(var g=0;g<b.length;g++)Xa(a,b[g],c,d,f);return null}c=Ya(c);return a&&a[H]?a.Mb(b,c,t(d)?!!d.capture:!!d,f):Za(a,b,c,!0,d,f)}function db(a,b,c,d,f){if(r(b))for(var g=0;g<b.length;g++)db(a,b[g],c,d,f);else d=t(d)?!!d.capture:!!d,c=Ya(c),a&&a[H]?a.Qc(b,c,d,f):a&&(a=$a(a))&&(b=a.Rc(b,c,d,f))&&eb(b)}function eb(a){if("number"!=typeof a&&a&&!a.ja){var b=a.src;if(b&&b[H])b.nc(a);else{var c=a.type,d=a.proxy;b.removeEventListener?b.removeEventListener(c,d,a.capture):b.detachEvent?b.detachEvent(bb(c),d):b.addListener&&b.removeListener&&b.removeListener(d);Va--;(c=$a(b))?(c.fc(a),0==c.b&&(c.src=null,b[Ta]=null)):a.a()}}}function bb(a){return a in Ua?Ua[a]:Ua[a]="on"+a}function fb(a,b){var c=a.listener,d=a.ya||a.src;a.oa&&eb(a);return c.call(d,b)}function cb(a,b){return a.ja?!0:La?fb(a,new G(b,this)):(b=new G(b||n("window.event"),this),fb(a,b))}function $a(a){a=a[Ta];return a instanceof Ra?a:null}var gb="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ya(a){if("function"==q(a))return a;a[gb]||(a[gb]=function(b){return a.handleEvent(b)});return a[gb]}function I(){z.call(this);this.c=new Ra(this);this.K=this;this.F=null}y(I,z);I.prototype[H]=!0;e=I.prototype;e.addEventListener=function(a,b,c,d){Wa(this,a,b,c,d)};e.removeEventListener=function(a,b,c,d){db(this,a,b,c,d)};e.dispatchEvent=function(a){var b,c=this.F;if(c)for(b=[];c;c=c.F)b.push(c);c=this.K;var d=a.type||a;if(l(a))a=new F(a,c);else if(a instanceof F)a.target=a.target||c;else{var f=a;a=new F(d,c);ta(a,f)}f=!0;if(b)for(var g=b.length-1;!a.b&&0<=g;g--){var k=a.a=b[g];f=k.ua(d,!0,a)&&f}a.b||(k=a.a=c,f=k.ua(d,!0,a)&&f,a.b||(f=k.ua(d,!1,a)&&f));if(b)for(g=0;!a.b&&g<b.length;g++)k=a.a=b[g],f=k.ua(d,!1,a)&&f;return f};e.G=function(){I.S.G.call(this);this.Id();this.F=null};e.Lb=function(a,b,c,d){return this.c.add(String(a),b,!1,c,d)};e.Mb=function(a,b,c,d){return this.c.add(String(a),b,!0,c,d)};e.Qc=function(a,b,c,d){this.c.Sc(String(a),b,c,d)};e.nc=function(a){this.c.fc(a)};e.Id=function(){this.c&&this.c.Tc()};e.ua=function(a,b,c){a=this.c.a[String(a)];if(!a)return!0;a=a.concat();for(var d=!0,f=0;f<a.length;++f){var g=a[f];if(g&&!g.ja&&g.capture==b){var k=g.listener,m=g.ya||g.src;g.oa&&this.nc(g);d=!1!==k.call(m,c)&&d}}return d&&0!=c.hc};var hb=h.JSON.stringify;function ib(a,b){this.g=100;this.c=a;this.h=b;this.b=0;this.a=null}ib.prototype.get=function(){if(0<this.b){this.b--;var a=this.a;this.a=a.next;a.next=null}else a=this.c();return a};ib.prototype.f=function(a){this.h(a);this.b<this.g&&(this.b++,a.next=this.a,this.a=a)};function J(){this.b=this.a=null}var kb=new ib(function(){return new jb},function(a){a.reset()});J.prototype.add=function(a,b){var c=this.c();c.set(a,b);this.b?this.b.next=c:this.a=c;this.b=c};J.prototype.f=function(){var a=null;this.a&&(a=this.a,this.a=this.a.next,this.a||(this.b=null),a.next=null);return a};J.prototype.g=function(a){kb.f(a)};J.prototype.c=function(){return kb.get()};function jb(){this.next=this.b=this.a=null}jb.prototype.set=function(a,b){this.a=a;this.b=b;this.next=null};jb.prototype.reset=function(){this.next=this.b=this.a=null};function lb(a){h.setTimeout(function(){throw a},0)}var mb;function nb(){var a=h.Promise.resolve(void 0);mb=function(){a.then(ob)}}var pb=!1,qb=new J;function ob(){for(var a;a=qb.f();){try{a.a.call(a.b)}catch(b){lb(b)}qb.g(a)}pb=!1}function rb(a,b){I.call(this);this.b=a||1;this.a=b||h;this.f=v(this.$d,this);this.g=x()}y(rb,I);e=rb.prototype;e.wa=!1;e.P=null;e.$d=function(){if(this.wa){var a=x()-this.g;0<a&&a<.8*this.b?this.P=this.a.setTimeout(this.f,this.b-a):(this.P&&(this.a.clearTimeout(this.P),this.P=null),this.Gc(),this.wa&&(this.Na(),this.start()))}};e.Gc=function(){this.dispatchEvent("tick")};e.start=function(){this.wa=!0;this.P||(this.P=this.a.setTimeout(this.f,this.b),this.g=x())};e.Na=function(){this.wa=!1;this.P&&(this.a.clearTimeout(this.P),this.P=null)};e.G=function(){rb.S.G.call(this);this.Na();delete this.a};function sb(a,b,c){if("function"==q(a))c&&(a=v(a,c));else if(a&&"function"==typeof a.handleEvent)a=v(a.handleEvent,a);else throw Error("Invalid listener argument");return 2147483647<Number(b)?-1:h.setTimeout(a,b||0)}function tb(a,b,c){z.call(this);this.f=null!=c?v(a,c):a;this.c=b;this.b=v(this.Cd,this);this.a=[]}y(tb,z);e=tb.prototype;e.Ca=!1;e.ec=0;e.ba=null;e.Hc=function(a){this.a=arguments;this.ba||this.ec?this.Ca=!0:this.yb()};e.Pc=function(){this.ba&&(h.clearTimeout(this.ba),this.ba=null,this.Ca=!1,this.a=[])};e.G=function(){tb.S.G.call(this);this.Pc()};e.Cd=function(){this.ba=null;this.Ca&&!this.ec&&(this.Ca=!1,this.yb())};e.yb=function(){this.ba=sb(this.b,this.c);this.f.apply(null,this.a)};function ub(a){z.call(this);this.b=a;this.a={}}y(ub,z);var vb=[];e=ub.prototype;e.Jb=function(a,b,c){this.wd(a,b,c)};e.wd=function(a,b,c){r(b)||(b&&(vb[0]=b.toString()),b=vb);for(var d=0;d<b.length;d++){var f=Wa(a,b[d],c||this.handleEvent,!1,this.b||this);if(!f)break;this.a[f.key]=f}};e.Kb=function(){qa(this.a,function(a,b){this.a.hasOwnProperty(b)&&eb(a)},this);this.a={}};e.G=function(){ub.S.G.call(this);this.Kb()};e.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};function wb(){}var K=new I;function xb(a){F.call(this,"serverreachability",a)}y(xb,F);function L(a){K.dispatchEvent(new xb(K,a))}function yb(a){F.call(this,"statevent",a)}y(yb,F);function M(a){K.dispatchEvent(new yb(K,a))}function zb(a){F.call(this,"timingevent",a)}y(zb,F);function N(a,b){if("function"!=q(a))throw Error("Fn must not be null and must be a function");return h.setTimeout(function(){a()},b)}var Ab={NO_ERROR:0,ae:1,he:2,ge:3,de:4,fe:5,ie:6,qc:7,TIMEOUT:8,le:9};var Bb={ce:"complete",pe:"success",rc:"error",qc:"abort",ne:"ready",oe:"readystatechange",TIMEOUT:"timeout",je:"incrementaldata",me:"progress",ee:"downloadprogress",qe:"uploadprogress"};function Cb(){}Cb.prototype.a=null;Cb.prototype.c=function(){return this.a||(this.a={})};function Db(){}var O={OPEN:"a",be:"b",rc:"c",ke:"d"};function Eb(){F.call(this,"d")}y(Eb,F);function Fb(){F.call(this,"c")}y(Fb,F);var Hb;function Ib(){}y(Ib,Cb);Ib.prototype.b=function(){return new XMLHttpRequest};Hb=new Ib;function P(a,b,c){this.g=a;this.da=b;this.ca=c||1;this.I=new ub(this);this.L=Jb;a=za?125:void 0;this.T=new rb(a);this.J=null;this.b=!1;this.i=this.C=this.f=this.F=this.u=this.U=this.h=null;this.j=[];this.a=null;this.A=0;this.c=this.v=null;this.o=-1;this.l=!1;this.K=0;this.B=null;this.s=this.Y=this.H=!1}var Jb=45e3,Kb={},Lb={};e=P.prototype;e.ha=function(a){this.J=a};e.setTimeout=function(a){this.L=a};e.Xc=function(a){this.K=a};e.Qd=function(a){this.j=a};e.cb=function(a,b){this.F=1;this.f=a.N().za();this.i=b;this.H=!0;this.ic(null)};e.bb=function(a,b,c){this.F=1;this.f=a.N().za();this.i=null;this.H=b;this.ic(c)};e.ic=function(a){this.u=x();this.fa();this.C=this.f.N();this.C.Aa("t",this.ca);this.A=0;this.a=this.g.sa(this.g.Da()?a:null);0<this.K&&(this.B=new tb(v(this.oc,this,this.a),this.K));this.I.Jb(this.a,"readystatechange",this.Hd);a=this.J?ra(this.J):{};this.i?(this.v||(this.v="POST"),a["Content-Type"]="application/x-www-form-urlencoded",this.a.xa(this.C,this.v,this.i,a)):(this.v="GET",this.a.xa(this.C,this.v,null,a));L(1)};e.Hd=function(a){a=a.target;var b=this.B;b&&3==a.W()?b.Hc():this.oc(a)};e.oc=function(a){try{a==this.a&&this.Ed()}catch(b){}finally{}};e.Ed=function(){var a=this.a.W(),b=this.a.Db(),c=this.a.aa();if(!(3>a||3==a&&!za&&!this.a.va()))if(this.l||4!=a||7==b||(8==b||0>=c?L(3):L(2)),this.pa(),this.o=c=this.a.aa(),b=this.a.va(),this.b=200==c){if(this.Td())if(c=this.Kc())this.s=!0,this.Wa(c);else{this.b=!1;this.c=3;M(12);this.Z();this.ta();return}this.H?(this.vb(a,b),za&&this.b&&3==a&&this.Yd()):this.Wa(b);4==a&&this.Z();this.b&&!this.l&&(4==a?this.g.Va(this):(this.b=!1,this.fa()))}else 400==c&&0<b.indexOf("Unknown SID")?(this.c=3,M(12)):(this.c=0,M(13)),this.Z(),this.ta()};e.Td=function(){return this.Y&&!this.s};e.Kc=function(){if(this.a){var a=this.a.ga("X-HTTP-Initial-Response");if(a&&!B(a))return a}return null};e.Md=function(){this.Y=!0};e.vb=function(a,b){for(var c=!0;!this.l&&this.A<b.length;){var d=this.Lc(b);if(d==Lb){4==a&&(this.c=4,M(14),c=!1);break}else if(d==Kb){this.c=4;M(15);c=!1;break}else this.Wa(d)}4==a&&0==b.length&&(this.c=1,M(16),c=!1);this.b=this.b&&c;c||(this.Z(),this.ta())};e.Gd=function(){if(this.a){var a=this.a.W(),b=this.a.va();this.A<b.length&&(this.pa(),this.vb(a,b),this.b&&4!=a&&this.fa())}};e.Yd=function(){this.I.Jb(this.T,"tick",this.Gd);this.T.start()};e.Lc=function(a){var b=this.A,c=a.indexOf("\n",b);if(-1==c)return Lb;b=Number(a.substring(b,c));if(isNaN(b))return Kb;c+=1;if(c+b>a.length)return Lb;a=a.substr(c,b);this.A=c+b;return a};e.Ld=function(a){this.F=2;this.f=a.N().za();a=!1;h.navigator&&h.navigator.sendBeacon&&(a=h.navigator.sendBeacon(this.f.toString(),""));!a&&h.Image&&((new Image).src=this.f,a=!0);a||(this.a=this.g.sa(null),this.a.xa(this.f));this.u=x();this.fa()};e.cancel=function(){this.l=!0;this.Z()};e.Kd=function(a){a&&this.setTimeout(a);this.h&&(this.pa(),this.fa())};e.fa=function(){this.U=x()+this.L;this.mc(this.L)};e.mc=function(a){if(null!=this.h)throw Error("WatchDog timer not null");this.h=N(v(this.Dd,this),a)};e.pa=function(){this.h&&(h.clearTimeout(this.h),this.h=null)};e.Dd=function(){this.h=null;var a=x();0<=a-this.U?this.md():this.mc(this.U-a)};e.md=function(){2!=this.F&&(L(3),M(17));this.Z();this.c=2;this.ta()};e.ta=function(){this.g.Tb()||this.l||this.g.Va(this)};e.Z=function(){this.pa();var a=this.B;a&&"function"==typeof a.La&&a.La();this.B=null;this.T.Na();this.I.Kb();this.a&&(a=this.a,this.a=null,a.abort(),a.La())};e.Wa=function(a){try{this.g.bc(this,a),L(4)}catch(b){}};function Mb(a){if(a.D&&"function"==typeof a.D)return a.D();if(l(a))return a.split("");if(aa(a)){for(var b=[],c=a.length,d=0;d<c;d++)b.push(a[d]);return b}b=[];c=0;for(d in a)b[c++]=a[d];return b}function Nb(a,b){if(a.forEach&&"function"==typeof a.forEach)a.forEach(b,void 0);else if(aa(a)||l(a))A(a,b,void 0);else{if(a.O&&"function"==typeof a.O)var c=a.O();else if(a.D&&"function"==typeof a.D)c=void 0;else if(aa(a)||l(a)){c=[];for(var d=a.length,f=0;f<d;f++)c.push(f)}else for(f in c=[],d=0,a)c[d++]=f;d=Mb(a);f=d.length;for(var g=0;g<f;g++)b.call(void 0,d[g],c&&c[g],a)}}function Q(a,b){this.b={};this.a=[];this.c=0;var c=arguments.length;if(1<c){if(c%2)throw Error("Uneven number of arguments");for(var d=0;d<c;d+=2)this.set(arguments[d],arguments[d+1])}else a&&this.fd(a)}e=Q.prototype;e.D=function(){this.Ka();for(var a=[],b=0;b<this.a.length;b++)a.push(this.b[this.a[b]]);return a};e.O=function(){this.Ka();return this.a.concat()};e.Ra=function(a){return R(this.b,a)};e.hd=function(){return 0==this.c};e.gd=function(){this.b={};this.c=this.a.length=0};e.Qb=function(a){R(this.b,a)&&(delete this.b[a],this.c--,this.a.length>2*this.c&&this.Ka())};e.Ka=function(){if(this.c!=this.a.length){for(var a=0,b=0;a<this.a.length;){var c=this.a[a];R(this.b,c)&&(this.a[b++]=c);a++}this.a.length=b}if(this.c!=this.a.length){var d={};for(b=a=0;a<this.a.length;)c=this.a[a],R(d,c)||(this.a[b++]=c,d[c]=1),a++;this.a.length=b}};e.get=function(a,b){return R(this.b,a)?this.b[a]:b};e.set=function(a,b){R(this.b,a)||(this.c++,this.a.push(a));this.b[a]=b};e.fd=function(a){if(a instanceof Q)for(var b=a.O(),c=0;c<b.length;c++)this.set(b[c],a.get(b[c]));else for(b in a)this.set(b,a[b])};e.forEach=function(a,b){for(var c=this.O(),d=0;d<c.length;d++){var f=c[d],g=this.get(f);a.call(b,g,f,this)}};e.Pb=function(){return new Q(this)};function R(a,b){return Object.prototype.hasOwnProperty.call(a,b)}var Ob=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Pb(a,b){if(a){a=a.split("&");for(var c=0;c<a.length;c++){var d=a[c].indexOf("="),f=null;if(0<=d){var g=a[c].substring(0,d);f=a[c].substring(d+1)}else g=a[c];b(g,f?decodeURIComponent(f.replace(/\+/g," ")):"")}}}function S(a,b){this.c=this.i=this.b="";this.h=null;this.j=this.g="";this.f=this.l=!1;var c;a instanceof S?(this.f=void 0!==b?b:a.f,this.ma(a.b),this.$a(a.i),this.ka(a.c),this.la(a.h),this.Ba(a.g),this.Za(a.a.Gb()),this.Ya(a.j)):a&&(c=String(a).match(Ob))?(this.f=!!b,this.ma(c[1]||"",!0),this.$a(c[2]||"",!0),this.ka(c[3]||"",!0),this.la(c[4]),this.Ba(c[5]||"",!0),this.Za(c[6]||"",!0),this.Ya(c[7]||"",!0)):(this.f=!!b,this.a=new T(null,this.f))}e=S.prototype;e.toString=function(){var a=[],b=this.b;b&&a.push(U(b,Qb,!0),":");var c=this.c;if(c||"file"==b)a.push("//"),(b=this.i)&&a.push(U(b,Qb,!0),"@"),a.push(encodeURIComponent(String(c)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),c=this.h,null!=c&&a.push(":",String(c));if(c=this.g)this.Sa()&&"/"!=c.charAt(0)&&a.push("/"),a.push(U(c,"/"==c.charAt(0)?Rb:Sb,!0));(c=this.Ic())&&a.push("?",c);(c=this.j)&&a.push("#",U(c,Tb));return a.join("")};e.resolve=function(a){var b=this.N(),c=a.qd();c?b.ma(a.b):c=a.rd();c?b.$a(a.i):c=a.Sa();c?b.ka(a.c):c=a.od();var d=a.g;if(c)b.la(a.h);else if(c=a.Sb()){if("/"!=d.charAt(0))if(this.Sa()&&!this.Sb())d="/"+d;else{var f=b.g.lastIndexOf("/");-1!=f&&(d=b.g.substr(0,f+1)+d)}f=d;if(".."==f||"."==f)d="";else if(C(f,"./")||C(f,"/.")){d=0==f.lastIndexOf("/",0);f=f.split("/");for(var g=[],k=0;k<f.length;){var m=f[k++];"."==m?d&&k==f.length&&g.push(""):".."==m?((1<g.length||1==g.length&&""!=g[0])&&g.pop(),d&&k==f.length&&g.push("")):(g.push(m),d=!0)}d=g.join("/")}else d=f}c?b.Ba(d):c=a.pd();c?b.Za(a.a.Gb()):c=a.nd();c&&b.Ya(a.j);return b};e.N=function(){return new S(this)};e.ma=function(a,b){this.M();if(this.b=b?V(a,!0):a)this.b=this.b.replace(/:$/,"")};e.qd=function(){return!!this.b};e.$a=function(a,b){this.M();this.i=b?V(a):a};e.rd=function(){return!!this.i};e.ka=function(a,b){this.M();this.c=b?V(a,!0):a};e.Sa=function(){return!!this.c};e.la=function(a){this.M();if(a){a=Number(a);if(isNaN(a)||0>a)throw Error("Bad port number "+a);this.h=a}else this.h=null};e.od=function(){return null!=this.h};e.Ba=function(a,b){this.M();this.g=b?V(a,!0):a};e.Sb=function(){return!!this.g};e.pd=function(){return""!==this.a.toString()};e.Za=function(a,b){this.M();a instanceof T?(this.a=a,this.a.Oc(this.f)):(b||(a=U(a,Ub)),this.a=new T(a,this.f))};e.Ic=function(){return this.a.toString()};e.m=function(a,b){this.M();this.a.set(a,b)};e.Aa=function(a,b){this.M();r(b)||(b=[String(b)]);this.a.lc(a,b)};e.Ya=function(a,b){this.M();this.j=b?V(a):a};e.nd=function(){return!!this.j};e.za=function(){this.M();this.m("zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^x()).toString(36));return this};e.M=function(){if(this.l)throw Error("Tried to modify a read-only Uri")};function Vb(a){return a instanceof S?a.N():new S(a,void 0)}function Wb(a,b,c,d){var f=new S(null,void 0);a&&f.ma(a);b&&f.ka(b);c&&f.la(c);d&&f.Ba(d);return f}function V(a,b){return a?b?decodeURI(a.replace(/%25/g,"%2525")):decodeURIComponent(a):""}function U(a,b,c){return l(a)?(a=encodeURI(a).replace(b,Xb),c&&(a=a.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),a):null}function Xb(a){a=a.charCodeAt(0);return"%"+(a>>4&15).toString(16)+(a&15).toString(16)}var Qb=/[#\/\?@]/g,Sb=/[#\?:]/g,Rb=/[#\?]/g,Ub=/[#\?@]/g,Tb=/#/g;function T(a,b){this.b=this.a=null;this.c=a||null;this.f=!!b}e=T.prototype;e.V=function(){if(!this.a&&(this.a=new Q,this.b=0,this.c)){var a=this;Pb(this.c,function(b,c){a.add(decodeURIComponent(b.replace(/\+/g," ")),c)})}};e.add=function(a,b){this.V();this.ia();a=this.$(a);var c=this.a.get(a);c||this.a.set(a,c=[]);c.push(b);this.b+=1;return this};e.Ib=function(a){this.V();a=this.$(a);this.a.Ra(a)&&(this.ia(),this.b-=this.a.get(a).length,this.a.Qb(a))};e.Hb=function(a){this.V();a=this.$(a);return this.a.Ra(a)};e.forEach=function(a,b){this.V();this.a.forEach(function(c,d){A(c,function(c){a.call(b,c,d,this)},this)},this)};e.O=function(){this.V();for(var a=this.a.D(),b=this.a.O(),c=[],d=0;d<b.length;d++)for(var f=a[d],g=0;g<f.length;g++)c.push(b[d]);return c};e.D=function(a){this.V();var b=[];if(l(a))this.Hb(a)&&(b=ka(b,this.a.get(this.$(a))));else{a=this.a.D();for(var c=0;c<a.length;c++)b=ka(b,a[c])}return b};e.set=function(a,b){this.V();this.ia();a=this.$(a);this.Hb(a)&&(this.b-=this.a.get(a).length);this.a.set(a,[b]);this.b+=1;return this};e.get=function(a,b){if(!a)return b;a=this.D(a);return 0<a.length?String(a[0]):b};e.lc=function(a,b){this.Ib(a);0<b.length&&(this.ia(),this.a.set(this.$(a),la(b)),this.b+=b.length)};e.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var a=[],b=this.a.O(),c=0;c<b.length;c++){var d=b[c],f=encodeURIComponent(String(d));d=this.D(d);for(var g=0;g<d.length;g++){var k=f;""!==d[g]&&(k+="="+encodeURIComponent(String(d[g])));a.push(k)}}return this.c=a.join("&")};e.ia=function(){this.c=null};e.Gb=function(){var a=new T;a.c=this.c;this.a&&(a.a=this.a.Pb(),a.b=this.b);return a};e.$=function(a){a=String(a);this.f&&(a=a.toLowerCase());return a};e.Oc=function(a){a&&!this.f&&(this.V(),this.ia(),this.a.forEach(function(a,c){var b=c.toLowerCase();c!=b&&(this.Ib(c),this.lc(b,a))},this));this.f=a};function W(){this.a=x()}var Yb=null;W.prototype.set=function(a){this.a=a};W.prototype.reset=function(){this.set(x())};W.prototype.get=function(){return this.a};function Zb(){Yb||(Yb=new W)}function $b(){Yb||(Yb=new W)}y($b,Zb);function ac(a){this.a=a;this.b=this.h=null;this.g=!1;this.i=null;this.c=-1;this.l=this.f=null}e=ac.prototype;e.R=null;e.Wc=function(a){this.h=a};e.Vc=function(a){this.i=a;a=this.a.Cb(this.i);M(3);var b=this.a.H.b;null!=b?(this.f=this.a.Oa(b[0]),this.R=1,this.rb()):(a.Aa("MODE","init"),!this.a.o&&this.a.j&&a.Aa("X-HTTP-Session-Id",this.a.j),this.b=new P(this,void 0,void 0),this.b.ha(this.h),this.b.bb(a,!1,null),this.R=0)};e.rb=function(){var a=this.a.H.a;if(null!=a)M(4),a?(M(10),this.a.na(this,!1)):(M(11),this.a.na(this,!0));else{this.b=new P(this,void 0,void 0);this.b.ha(this.h);a=this.a.Bb(this.f,this.i);M(4);a.Aa("TYPE","xmlhttp");var b=this.a.j,c=this.a.Fa;b&&c&&a.m(b,c);this.b.bb(a,!1,this.f)}};e.sa=function(a){return this.a.sa(a)};e.abort=function(){this.b&&(this.b.cancel(),this.b=null);this.c=-1};e.Tb=function(){return!1};e.bc=function(a,b){this.c=a.o;if(0==this.R)if(this.Uc(a),b){try{var c=this.a.U.a(b)}catch(d){this.a.ab(this);return}this.f=this.a.Oa(c[0])}else this.a.ab(this);else 1==this.R&&(this.g?M(6):"11111"==b?(M(5),this.g=!0,this.Ac()&&(this.c=200,this.b.cancel(),M(11),this.a.na(this,!0))):(M(7),this.g=!1))};e.Va=function(){this.c=this.b.o;this.b.b?0==this.R?(this.R=1,this.rb()):1==this.R&&(this.g?(M(11),this.a.na(this,!0)):(M(10),this.a.na(this,!1))):(0==this.R?M(8):1==this.R&&M(9),this.a.ab(this))};e.Uc=function(a){if(!this.a.o&&(a=a.a)){var b=a.ga("X-Client-Wire-Protocol");this.l=b?b:null;this.a.j&&(a=a.ga("X-HTTP-Session-Id"))&&this.a.kc(a)}};e.Da=function(){return this.a.Da()};e.Pa=function(){return this.a.Pa()};e.Ac=function(){return!E||10<=Number(Ia)};function bc(){this.a=this.b=null}function cc(){this.a=new Q}function dc(a){var b=typeof a;return"object"==b&&a||"function"==b?"o"+(a[u]||(a[u]=++ba)):b.charAt(0)+a}e=cc.prototype;e.add=function(a){this.a.set(dc(a),a)};e.ed=function(a){this.a.Qb(dc(a))};e.jd=function(){this.a.gd()};e.Rb=function(){return this.a.hd()};e.Ob=function(a){return this.a.Ra(dc(a))};e.D=function(){return this.a.D()};function ec(a,b){this.a=a;this.b=b}function fc(a){this.g=a||gc;h.PerformanceNavigationTiming?(a=h.performance.getEntriesByType("navigation"),a=0<a.length&&("hq"==a[0].nextHopProtocol||"h2"==a[0].nextHopProtocol)):a=!!(h.Ja&&h.Ja.Vb&&h.Ja.Vb()&&h.Ja.Vb().te);this.f=a?this.g:1;this.a=null;1<this.f&&(this.a=new cc);this.b=null;this.c=[]}var gc=10;e=fc.prototype;e.kb=function(a){!this.a&&(C(a,"spdy")||C(a,"quic")||C(a,"h2"))&&(this.f=this.g,this.a=new cc,this.b&&(this.Ha(this.b),this.b=null))};e.Ub=function(){return this.b?!0:this.a?this.a.a.c>=this.f:!1};e.Mc=function(){return this.b?1:this.a?this.a.a.c:0};e.Ta=function(a){return this.b?this.b==a:this.a?this.a.Ob(a):!1};e.Ha=function(a){this.a?this.a.add(a):this.b=a};e.gc=function(a){this.b&&this.b==a?this.b=null:this.a&&this.a.Ob(a)&&this.a.ed(a)};e.cancel=function(){this.c=this.Xb();this.b?(this.b.cancel(),this.b=null):this.a&&!this.a.Rb()&&(A(this.a.D(),function(a){a.cancel()}),this.a.jd())};e.Xb=function(){if(null!=this.b)return this.c.concat(this.b.j);if(null!=this.a&&!this.a.Rb()){var a=this.c;A(this.a.D(),function(b){a=a.concat(b.j)});return a}return la(this.c)};e.wc=function(a){this.c=this.c.concat(a)};e.Bc=function(){this.c.length=0};function hc(){this.b=this.a=void 0}hc.prototype.stringify=function(a){return h.JSON.stringify(a,this.a)};hc.prototype.parse=function(a){return h.JSON.parse(a,this.b)};function ic(){this.f=new hc}ic.prototype.b=function(a,b,c){var d=c||"";try{Nb(a,function(a,c){var f=a;t(a)&&(f=hb(a));b.push(d+c+"="+encodeURIComponent(f))})}catch(f){throw b.push(d+"type="+encodeURIComponent("_badmap")),f}};ic.prototype.c=function(a,b,c){for(var d=-1;;){var f=["count="+b];-1==d?0<b?(d=a[0].a,f.push("ofs="+d)):d=0:f.push("ofs="+d);for(var g=!0,k=0;k<b;k++){var m=a[k].a,Gb=a[k].b;m-=d;if(0>m)d=Math.max(0,a[k].a-100),g=!1;else try{this.b(Gb,f,"req"+m+"_")}catch(Ac){c&&c(Gb)}}if(g)return f.join("&")}};ic.prototype.a=function(a){return this.f.parse(a)};function jc(a,b){var c=new wb,d=new Image;d.onload=w(kc,c,d,"TestLoadImage: loaded",!0,b);d.onerror=w(kc,c,d,"TestLoadImage: error",!1,b);d.onabort=w(kc,c,d,"TestLoadImage: abort",!1,b);d.ontimeout=w(kc,c,d,"TestLoadImage: timeout",!1,b);h.setTimeout(function(){if(d.ontimeout)d.ontimeout()},1e4);d.src=a}function kc(a,b,c,d,f){try{b.onload=null,b.onerror=null,b.onabort=null,b.ontimeout=null,f(d)}catch(g){}}var lc=h.JSON.parse;function X(a){I.call(this);this.headers=new Q;this.l=a||null;this.b=!1;this.v=this.a=null;this.C="";this.h=0;this.f="";this.g=this.B=this.o=this.A=!1;this.u=0;this.s=null;this.J=mc;this.H=this.L=this.I=!1}y(X,I);var mc="",nc=/^https?$/i,oc=["POST","PUT"];e=X.prototype;e.Sd=function(a){this.I=a};e.xa=function(a,b,c,d){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.C+"; newUri="+a);b=b?b.toUpperCase():"GET";this.C=a;this.f="";this.h=0;this.A=!1;this.b=!0;this.a=this.Ec();this.v=this.l?this.l.c():Hb.c();this.a.onreadystatechange=v(this.ac,this);this.L&&"onprogress"in this.a&&(this.a.onprogress=v(function(a){this.Zb(a,!0)},this),this.a.upload&&(this.a.upload.onprogress=v(this.Zb,this)));try{this.B=!0,this.a.open(b,String(a),!0),this.B=!1}catch(g){this.Ab(g);return}a=c||"";var f=this.headers.Pb();d&&Nb(d,function(a,b){f.set(b,a)});d=ia(f.O());c=h.FormData&&a instanceof h.FormData;!(0<=ha(oc,b))||d||c||f.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");f.forEach(function(a,b){this.a.setRequestHeader(b,a)},this);this.J&&(this.a.responseType=this.J);"withCredentials"in this.a&&this.a.withCredentials!==this.I&&(this.a.withCredentials=this.I);try{this.sb(),0<this.u&&((this.H=pc(this.a))?(this.a.timeout=this.u,this.a.ontimeout=v(this.Nb,this)):this.s=sb(this.Nb,this.u,this)),this.o=!0,this.a.send(a),this.o=!1}catch(g){this.Ab(g)}};function pc(a){return E&&Ha(9)&&"number"==typeof a.timeout&&void 0!==a.ontimeout}function ja(a){return"content-type"==a.toLowerCase()}e.Ec=function(){return this.l?this.l.b():Hb.b()};e.Nb=function(){"undefined"!=typeof goog&&this.a&&(this.f="Timed out after "+this.u+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))};e.Ab=function(a){this.b=!1;this.a&&(this.g=!0,this.a.abort(),this.g=!1);this.f=a;this.h=5;this.xb();this.qa()};e.xb=function(){this.A||(this.A=!0,this.dispatchEvent("complete"),this.dispatchEvent("error"))};e.abort=function(a){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=a||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),this.qa())};e.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),this.qa(!0));X.S.G.call(this)};e.ac=function(){this.i||(this.B||this.o||this.g?this.$b():this.Bd())};e.Bd=function(){this.$b()};e.$b=function(){if(this.b&&"undefined"!=typeof goog&&(!this.v[1]||4!=this.W()||2!=this.aa()))if(this.o&&4==this.W())sb(this.ac,0,this);else if(this.dispatchEvent("readystatechange"),this.td()){this.b=!1;try{this.vd()?(this.dispatchEvent("complete"),this.dispatchEvent("success")):(this.h=6,this.f=this.Fb()+" ["+this.aa()+"]",this.xb())}finally{this.qa()}}};e.Zb=function(a,b){this.dispatchEvent(qc(a,"progress"));this.dispatchEvent(qc(a,b?"downloadprogress":"uploadprogress"))};function qc(a,b){return{type:b,lengthComputable:a.lengthComputable,loaded:a.loaded,total:a.total}}e.qa=function(a){if(this.a){this.sb();var b=this.a,c=this.v[0]?p:null;this.v=this.a=null;a||this.dispatchEvent("ready");try{b.onreadystatechange=c}catch(d){}}};e.sb=function(){this.a&&this.H&&(this.a.ontimeout=null);this.s&&(h.clearTimeout(this.s),this.s=null)};e.td=function(){return 4==this.W()};e.vd=function(){var a=this.aa();a:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var b=!0;break a;default:b=!1}return b||0===a&&!this.ud()};e.ud=function(){var a=String(this.C).match(Ob)[1]||null;!a&&h.self&&h.self.location&&(a=h.self.location.protocol,a=a.substr(0,a.length-1));return nc.test(a?a.toLowerCase():"")};e.W=function(){return this.a?this.a.readyState:0};e.aa=function(){try{return 2<this.W()?this.a.status:-1}catch(a){return-1}};e.Fb=function(){try{return 2<this.W()?this.a.statusText:""}catch(a){return""}};e.va=function(){try{return this.a?this.a.responseText:""}catch(a){return""}};e.Nc=function(a){if(this.a){var b=this.a.responseText;a&&0==b.indexOf(a)&&(b=b.substring(a.length));return lc(b)}};e.ga=function(a){return this.a?this.a.getResponseHeader(a):null};e.Db=function(){return this.h};e.dd=function(){return l(this.f)?this.f:String(this.f)};function rc(a){var b="";qa(a,function(a,d){b+=d;b+=":";b+=a;b+="\r\n"});return b}function sc(a,b,c){a:{for(d in c){var d=!1;break a}d=!0}if(d)return a;c=rc(c);if(l(a)){b=encodeURIComponent(String(b));c=null!=c?"="+encodeURIComponent(String(c)):"";if(b+=c){c=a.indexOf("#");0>c&&(c=a.length);d=a.indexOf("?");if(0>d||d>c){d=c;var f=""}else f=a.substring(d+1,c);a=[a.substr(0,d),f,a.substr(c)];c=a[1];a[1]=b?c?c+"&"+b:b:c;a=a[0]+(a[1]?"?"+a[1]:"")+a[2]}return a}a.m(b,c);return a}function tc(a){this.gb=22;this.g=[];this.H=new bc;this.da=this.fb=this.C=this.Ea=this.a=this.Fa=this.j=this.ca=this.f=this.J=this.h=null;this.sc=!0;this.zc=this.L=0;this.uc=!!n("internalChannelParams.failFast",a);this.Ga=this.v=this.s=this.l=this.i=this.b=null;this.eb=!0;this.B=this.jb=this.K=-1;this.Y=this.u=this.A=0;this.tc=n("internalChannelParams.baseRetryDelayMs",a)||5e3;this.Fc=n("internalChannelParams.retryDelaySeedMs",a)||1e4;this.pc=n("internalChannelParams.forwardChannelMaxRetries",a)||2;this.ib=n("internalChannelParams.forwardChannelRequestTimeoutMs",a)||2e4;this.xc=a&&a.ue||void 0;this.F=void 0;this.vc=0;this.T=a&&a.supportsCrossDomainXhr||!1;this.I="";this.c=new fc(a&&a.concurrentRequestLimit);this.U=new ic;this.o=a&&void 0!==a.backgroundChannelTest?a.backgroundChannelTest:!0;(this.hb=a&&a.fastHandshake||!1)&&!this.o&&(this.o=!0);a&&a.se&&(this.eb=!1)}e=tc.prototype;e.qb=8;e.w=1;e.bd=function(a,b,c){M(0);this.Ea=b;this.ca=c||{};this.o&&(this.H.b=[],this.H.a=!1);this.Dc(a)};e.Qa=function(){this.lb();if(3==this.w){var a=this.L++,b=this.C.N();b.m("SID",this.I);b.m("RID",a);b.m("TYPE","terminate");this.ea(b);new P(this,a,void 0).Ld(b)}this.Yb()};e.Dc=function(a){this.v=new ac(this);null===this.f&&this.v.Wc(this.h);var b=a;this.f&&this.h&&(b=sc(a,this.f,this.h));this.v.Vc(b)};e.Cc=function(){this.C=this.Cb(this.Ea);this.Ma()};e.lb=function(){this.v&&(this.v.abort(),this.v=null);this.a&&(this.a.cancel(),this.a=null);this.l&&(h.clearTimeout(this.l),this.l=null);this.ra();this.c.cancel();this.i&&(h.clearTimeout(this.i),this.i=null)};e.cd=function(a){this.h=a};e.Pd=function(a){this.J=a};e.Nd=function(a){this.f=a};e.Od=function(a){this.j=a};e.kc=function(a){this.Fa=a};e.Rd=function(){this.T=!0};e.jc=function(a){this.b=a};e.sd=function(){return!this.Ga};e.Xa=function(a){this.g.push(new ec(this.zc++,a));3==this.w&&this.Ma()};e.Jc=function(){return this.uc?0:this.pc};e.Tb=function(){return 0==this.w};e.Ma=function(){this.c.Ub()||this.i||(this.i=N(v(this.dc,this),0),this.A=0)};e.xd=function(a){if(this.c.Mc()>=this.c.f-(this.i?1:0))return!1;if(this.i)return this.g=a.j.concat(this.g),!0;if(1==this.w||2==this.w||this.A>=this.Jc())return!1;this.i=N(v(this.dc,this,a),this.Eb(this.A));this.A++;return!0};e.dc=function(a){this.i=null;this.Xd(a)};e.Xd=function(a){1==this.w?a||(this.Fd(),this.w=2):3==this.w&&(a?this.Wb(a):0==this.g.length||this.c.Ub()||this.Wb())};e.Fd=function(){this.L=Math.floor(1e5*Math.random());var a=this.L++,b=new P(this,a,void 0),c=this.h;this.J&&(c?(c=ra(c),ta(c,this.J)):c=this.J);null===this.f&&b.ha(c);var d=this.wb(b),f=this.C.N();f.m("RID",a);0<this.gb&&f.m("CVER",this.gb);this.o&&this.j&&f.m("X-HTTP-Session-Id",this.j);this.ea(f);this.f&&c&&sc(f,this.f,c);this.c.Ha(b);this.hb?(f.m("$req",d),f.m("SID","null"),b.Md(),b.cb(f,null)):b.cb(f,d)};e.Wb=function(a){var b;a?b=a.da:b=this.L++;var c=this.C.N();c.m("SID",this.I);c.m("RID",b);c.m("AID",this.K);this.ea(c);this.f&&this.h&&sc(c,this.f,this.h);b=new P(this,b,this.A+1);null===this.f&&b.ha(this.h);a&&this.Jd(a);a=this.wb(b);b.setTimeout(Math.round(.5*this.ib)+Math.round(.5*this.ib*Math.random()));this.c.Ha(b);b.cb(c,a)};e.ea=function(a){this.b&&Nb({},function(b,c){a.m(c,b)})};e.wb=function(a){var b=Math.min(this.g.length,1e3),c=this.b?v(this.b.yc,this.b,this):null;c=this.U.c(this.g,b,c);a.Qd(this.g.splice(0,b));return c};e.Jd=function(a){this.g=a.j.concat(this.g)};e.zb=function(){if(!this.a&&!this.l){this.Y=1;var a=this.cc;mb||nb();pb||(mb(),pb=!0);qb.add(a,this);this.u=0}};e.Ua=function(){if(this.a||this.l||3<=this.u)return!1;this.Y++;this.l=N(v(this.cc,this),this.Eb(this.u));this.u++;return!0};e.cc=function(){this.l=null;this.Vd()};e.Vd=function(){this.a=new P(this,"rpc",this.Y);null===this.f&&this.a.ha(this.h);this.a.Xc(this.vc);var a=this.fb.N();a.m("RID","rpc");a.m("SID",this.I);a.m("CI",this.Ga?"0":"1");a.m("AID",this.K);this.ea(a);a.m("TYPE","xmlhttp");this.f&&this.h&&sc(a,this.f,this.h);this.F&&this.a.setTimeout(this.F);this.a.bb(a,!0,this.da)};e.na=function(a,b){var c=a.l;c&&this.c.kb(c);this.Ga=this.eb&&b;this.B=a.c;this.Cc()};e.ab=function(a){this.B=a.c;this.X(2)};e.bc=function(a,b){if(0!=this.w&&(this.a==a||this.c.Ta(a)))if(this.B=a.o,!a.s&&this.c.Ta(a)&&3==this.w){try{var c=this.U.a(b)}catch(d){c=null}r(c)&&3==c.length?this.ld(c,a):this.X(11)}else(a.s||this.a==a)&&this.ra(),B(b)||(c=this.U.a(b),this.Ad(c,a))};e.ld=function(a,b){0==a[0]?this.kd(b):(this.jb=a[1],0<this.jb-this.K&&this.Ud(a[2])&&!this.s&&(this.s=N(v(this.yd,this),6e3)))};e.kd=function(a){if(!this.l){if(this.a)if(this.a.u+3e3<a.u)this.ra(),this.a.cancel(),this.a=null;else return;this.Ua();M(18)}};e.Ud=function(a){return 37500>a&&!this.sd()&&0==this.u};e.Oa=function(a){return this.sc?this.b?this.b.$c(a):a:null};e.yd=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,this.Ua(),M(19))};e.ra=function(){null!=this.s&&(h.clearTimeout(this.s),this.s=null)};e.Va=function(a){var b=null;if(this.a==a){this.ra();this.a=null;var c=2}else if(this.c.Ta(a))b=a.j,this.c.gc(a),c=1;else return;this.B=a.o;if(0!=this.w)if(a.b)1==c?(c=x()-a.u,K.dispatchEvent(new zb(K,a.i?a.i.length:0,c,this.A)),this.Ma()):this.zb();else{var d=a.c;if(3==d||0==d&&0<this.B||!(1==c&&this.xd(a)||2==c&&this.Ua()))switch(b&&0<b.length&&this.c.wc(b),d){case 1:this.X(5);break;case 4:this.X(10);break;case 3:this.X(6);break;default:this.X(2)}}};e.Eb=function(a){var b=this.tc+Math.floor(Math.random()*this.Fc);this.Pa()||(b*=2);return b*a};e.ad=function(a){if(this.o&&(a=a.a)){var b=a.ga("X-Client-Wire-Protocol");b&&this.c.kb(b);this.j&&(a=a.ga("X-HTTP-Session-Id"))&&(this.kc(a),this.C.m(this.j,a))}};e.Ad=function(a,b){for(var c=this.b&&this.b.Ia?[]:null,d=0;d<a.length;d++){var f=a[d];this.K=f[0];f=f[1];if(2==this.w)if("c"==f[0]){this.I=f[1];this.da=this.Oa(f[2]);var g=f[3];null!=g&&(this.qb=g);f=f[5];null!=f&&"number"==typeof f&&0<f&&(this.F=1.5*f);this.ad(b);this.w=3;this.b&&this.b.pb();this.Wd(b)}else"stop"!=f[0]&&"close"!=f[0]||this.X(7);else 3==this.w&&("stop"==f[0]||"close"==f[0]?(c&&0!=c.length&&(this.b.Ia(this,c),c.length=0),"stop"==f[0]?this.X(7):this.Qa()):"noop"!=f[0]&&(c?c.push(f):this.b&&this.b.ob(f)),this.u=0)}c&&0!=c.length&&this.b.Ia(this,c)};e.Wd=function(a){this.fb=this.Bb(this.da,this.Ea);a.s?(this.c.gc(a),a.Kd(this.F),this.a=a):this.zb()};e.X=function(a){if(2==a){var b=null;this.b&&(b=null);var c=v(this.Zd,this);b||(b=new S("//www.google.com/images/cleardot.gif"),h.location&&"http"==h.location.protocol||b.ma("https"),b.za());jc(b.toString(),c)}else M(2);this.zd(a)};e.Zd=function(a){a?M(2):M(1)};e.zd=function(a){this.w=0;this.b&&this.b.nb(a);this.Yb();this.lb()};e.Yb=function(){this.w=0;this.B=-1;if(this.b){if(0!=this.c.Xb().length||0!=this.g.length)this.c.Bc(),la(this.g),this.g.length=0;this.b.mb()}};e.Cb=function(a){return this.ub(null,a)};e.Bb=function(a,b){return this.ub(this.Da()?a:null,b)};e.ub=function(a,b){var c=Vb(b);if(""!=c.c)a&&c.ka(a+"."+c.c),c.la(c.h);else{var d=h.location,f;a?f=a+"."+d.hostname:f=d.hostname;c=Wb(d.protocol,f,+d.port,b)}this.ca&&qa(this.ca,function(a,b){c.m(b,a)});a=this.j;b=this.Fa;a&&b&&c.m(a,b);c.m("VER",this.qb);this.ea(c);return c};e.sa=function(a){if(a&&!this.T)throw Error("Can't create secondary domain capable XhrIo object.");a=new X(this.xc);a.Sd(this.T);return a};e.Pa=function(){return!!this.b&&!0};e.Da=function(){return this.T};new $b;function uc(){}e=uc.prototype;e.Ia=null;e.pb=function(){};e.ob=function(){};e.nb=function(){};e.mb=function(){};e.yc=function(){};e.$c=function(a){return a};function vc(a){for(var b=arguments[0],c=1;c<arguments.length;c++){var d=arguments[c];if(0==d.lastIndexOf("/",0))b=d;else{var f;(f=""==b)||(f=b.length-1,f=0<=f&&b.indexOf("/",f)==f);f?b+=d:b+="/"+d}}return b}function wc(){if(E&&!(10<=Number(Ia)))throw Error("Environmental error: no available transport.")}wc.prototype.a=function(a,b){return new Y(a,b)};function Y(a,b){I.call(this);this.a=new tc(b);this.g=a;this.o=b&&b.testUrl?b.testUrl:vc(this.g,"test");this.b=b&&b.messageUrlParams||null;a=b&&b.messageHeaders||null;b&&b.clientProtocolHeaderRequired&&(a?a["X-Client-Protocol"]="webchannel":a={"X-Client-Protocol":"webchannel"});this.a.cd(a);a=b&&b.initMessageHeaders||null;b&&b.messageContentType&&(a?a["X-WebChannel-Content-Type"]=b.messageContentType:a={"X-WebChannel-Content-Type":b.messageContentType});b&&b.tb&&(a?a["X-WebChannel-Client-Profile"]=b.tb:a={"X-WebChannel-Client-Profile":b.tb});this.a.Pd(a);(a=b&&b.httpHeadersOverwriteParam)&&!B(a)&&this.a.Nd(a);this.l=b&&b.supportsCrossDomainXhr||!1;this.h=b&&b.sendRawJson||!1;(b=b&&b.httpSessionIdParam)&&!B(b)&&(this.a.Od(b),a=this.b,null!==a&&b in a&&(a=this.b,b in a&&delete a[b]));this.f=new Z(this)}y(Y,I);e=Y.prototype;e.addEventListener=function(a,b,c,d){Y.S.addEventListener.call(this,a,b,c,d)};e.removeEventListener=function(a,b,c,d){Y.S.removeEventListener.call(this,a,b,c,d)};e.Yc=function(){this.a.jc(this.f);this.l&&this.a.Rd();this.a.bd(this.o,this.g,this.b||void 0)};e.close=function(){this.a.Qa()};e.Zc=function(a){if(l(a)){var b={};b.__data__=a;this.a.Xa(b)}else this.h?(b={},b.__data__=hb(a),this.a.Xa(b)):this.a.Xa(a)};e.G=function(){this.a.jc(null);delete this.f;this.a.Qa();delete this.a;Y.S.G.call(this)};function xc(a){Eb.call(this);var b=a.__sm__;if(b){a:{for(var c in b){a=c;break a}a=void 0}(this.f=a)?(a=this.f,this.data=null!==b&&a in b?b[a]:void 0):this.data=b}else this.data=a}y(xc,Eb);function yc(){Fb.call(this);this.status=1}y(yc,Fb);function Z(a){this.a=a}y(Z,uc);Z.prototype.pb=function(){this.a.dispatchEvent("a")};Z.prototype.ob=function(a){this.a.dispatchEvent(new xc(a))};Z.prototype.nb=function(a){this.a.dispatchEvent(new yc(a))};Z.prototype.mb=function(){this.a.dispatchEvent("b")};var zc=w(function(a,b){function c(){}c.prototype=a.prototype;var d=new c;a.apply(d,Array.prototype.slice.call(arguments,1));return d},wc);wc.prototype.createWebChannel=wc.prototype.a;Y.prototype.send=Y.prototype.Zc;Y.prototype.open=Y.prototype.Yc;Y.prototype.close=Y.prototype.close;Ab.NO_ERROR=0;Ab.TIMEOUT=8;Ab.HTTP_ERROR=6;Bb.COMPLETE="complete";Db.EventType=O;O.OPEN="a";O.CLOSE="b";O.ERROR="c";O.MESSAGE="d";I.prototype.listen=I.prototype.Lb;X.prototype.listenOnce=X.prototype.Mb;X.prototype.getLastError=X.prototype.dd;X.prototype.getLastErrorCode=X.prototype.Db;X.prototype.getStatus=X.prototype.aa;X.prototype.getStatusText=X.prototype.Fb;X.prototype.getResponseJson=X.prototype.Nc;X.prototype.getResponseText=X.prototype.va;X.prototype.send=X.prototype.xa;module.exports={createWebChannelTransport:zc,ErrorCode:Ab,EventType:Bb,WebChannel:Db,XhrIo:X}}).call(typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],13:[function(require,module,exports){(function(process){exports=module.exports=require("./debug");exports.log=log;exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.storage="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:localstorage();exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"];function useColors(){if(typeof window!=="undefined"&&window.process&&window.process.type==="renderer"){return true}return typeof document!=="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!=="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}exports.formatters.j=function(v){try{return JSON.stringify(v)}catch(err){return"[UnexpectedJSONParseError]: "+err.message}};function formatArgs(args){var useColors=this.useColors;args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff);if(!useColors)return;var c="color: "+this.color;args.splice(1,0,c,"color: inherit");var index=0;var lastC=0;args[0].replace(/%[a-zA-Z%]/g,function(match){if("%%"===match)return;index++;if("%c"===match){lastC=index}});args.splice(lastC,0,c)}function log(){return"object"===typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{if(null==namespaces){exports.storage.removeItem("debug")}else{exports.storage.debug=namespaces}}catch(e){}}function load(){var r;try{r=exports.storage.debug}catch(e){}if(!r&&typeof process!=="undefined"&&"env"in process){r=process.env.DEBUG}return r}exports.enable(load());function localstorage(){try{return window.localStorage}catch(e){}}}).call(this,require("_process"))},{"./debug":14,_process:182}],14:[function(require,module,exports){exports=module.exports=createDebug.debug=createDebug["default"]=createDebug;exports.coerce=coerce;exports.disable=disable;exports.enable=enable;exports.enabled=enabled;exports.humanize=require("ms");exports.names=[];exports.skips=[];exports.formatters={};var prevTime;function selectColor(namespace){var hash=0,i;for(i in namespace){hash=(hash<<5)-hash+namespace.charCodeAt(i);hash|=0}return exports.colors[Math.abs(hash)%exports.colors.length]}function createDebug(namespace){function debug(){if(!debug.enabled)return;var self=debug;var curr=+new Date;var ms=curr-(prevTime||curr);self.diff=ms;self.prev=prevTime;self.curr=curr;prevTime=curr;var args=new Array(arguments.length);for(var i=0;i<args.length;i++){args[i]=arguments[i]}args[0]=exports.coerce(args[0]);if("string"!==typeof args[0]){args.unshift("%O")}var index=0;args[0]=args[0].replace(/%([a-zA-Z%])/g,function(match,format){if(match==="%%")return match;index++;var formatter=exports.formatters[format];if("function"===typeof formatter){var val=args[index];match=formatter.call(self,val);args.splice(index,1);index--}return match});exports.formatArgs.call(self,args);var logFn=debug.log||exports.log||console.log.bind(console);logFn.apply(self,args)}debug.namespace=namespace;debug.enabled=exports.enabled(namespace);debug.useColors=exports.useColors();debug.color=selectColor(namespace);if("function"===typeof exports.init){exports.init(debug)}return debug}function enable(namespaces){exports.save(namespaces);exports.names=[];exports.skips=[];var split=(typeof namespaces==="string"?namespaces:"").split(/[\s,]+/);var len=split.length;for(var i=0;i<len;i++){if(!split[i])continue;namespaces=split[i].replace(/\*/g,".*?");if(namespaces[0]==="-"){exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$"))}else{exports.names.push(new RegExp("^"+namespaces+"$"))}}}function disable(){exports.enable("")}function enabled(name){var i,len;for(i=0,len=exports.skips.length;i<len;i++){if(exports.skips[i].test(name)){return false}}for(i=0,len=exports.names.length;i<len;i++){if(exports.names[i].test(name)){return true}}return false}function coerce(val){if(val instanceof Error)return val.stack||val.message;return val}},{ms:16}],15:[function(require,module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return toString.call(arr)=="[object Array]"}},{}],16:[function(require,module,exports){var s=1e3;var m=s*60;var h=m*60;var d=h*24;var y=d*365.25;module.exports=function(val,options){options=options||{};var type=typeof val;if(type==="string"&&val.length>0){return parse(val)}else if(type==="number"&&isNaN(val)===false){return options.long?fmtLong(val):fmtShort(val)}throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))};function parse(str){str=String(str);if(str.length>100){return}var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(!match){return}var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"yrs":case"yr":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h;case"minutes":case"minute":case"mins":case"min":case"m":return n*m;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return undefined}}function fmtShort(ms){if(ms>=d){return Math.round(ms/d)+"d"}if(ms>=h){return Math.round(ms/h)+"h"}if(ms>=m){return Math.round(ms/m)+"m"}if(ms>=s){return Math.round(ms/s)+"s"}return ms+"ms"}function fmtLong(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){if(ms<n){return}if(ms<n*1.5){return Math.floor(ms/n)+" "+name}return Math.ceil(ms/n)+" "+name+"s"}},{}],17:[function(require,module,exports){module.exports=AlgoliaSearch;var Index=require("./Index.js");var deprecate=require("./deprecate.js");var deprecatedMessage=require("./deprecatedMessage.js");var AlgoliaSearchCore=require("./AlgoliaSearchCore.js");var inherits=require("inherits");var errors=require("./errors");function AlgoliaSearch(){AlgoliaSearchCore.apply(this,arguments)}inherits(AlgoliaSearch,AlgoliaSearchCore);AlgoliaSearch.prototype.deleteIndex=function(indexName,callback){return this._jsonRequest({method:"DELETE",url:"/1/indexes/"+encodeURIComponent(indexName),hostType:"write",callback:callback})};AlgoliaSearch.prototype.moveIndex=function(srcIndexName,dstIndexName,callback){var postObj={operation:"move",destination:dstIndexName};return this._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(srcIndexName)+"/operation",body:postObj,hostType:"write",callback:callback})};AlgoliaSearch.prototype.copyIndex=function(srcIndexName,dstIndexName,scopeOrCallback,_callback){var postObj={operation:"copy",destination:dstIndexName};var callback=_callback;if(typeof scopeOrCallback==="function"){callback=scopeOrCallback}else if(Array.isArray(scopeOrCallback)&&scopeOrCallback.length>0){postObj.scope=scopeOrCallback}else if(typeof scopeOrCallback!=="undefined"){throw new Error("the scope given to `copyIndex` was not an array with settings, synonyms or rules")}return this._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(srcIndexName)+"/operation",body:postObj,hostType:"write",callback:callback})};AlgoliaSearch.prototype.getLogs=function(offset,length,callback){var clone=require("./clone.js");var params={};if(typeof offset==="object"){params=clone(offset);callback=length}else if(arguments.length===0||typeof offset==="function"){callback=offset}else if(arguments.length===1||typeof length==="function"){callback=length;params.offset=offset}else{params.offset=offset;params.length=length}if(params.offset===undefined)params.offset=0;if(params.length===undefined)params.length=10;return this._jsonRequest({method:"GET",url:"/1/logs?"+this._getSearchParams(params,""),hostType:"read",callback:callback})};AlgoliaSearch.prototype.listIndexes=function(page,callback){var params="";if(page===undefined||typeof page==="function"){callback=page}else{params="?page="+page}return this._jsonRequest({method:"GET",url:"/1/indexes"+params,hostType:"read",callback:callback})};AlgoliaSearch.prototype.initIndex=function(indexName){return new Index(this,indexName)};AlgoliaSearch.prototype.initAnalytics=function(opts){var createAnalyticsClient=require("./createAnalyticsClient.js");return createAnalyticsClient(this.applicationID,this.apiKey,opts)};AlgoliaSearch.prototype.listUserKeys=deprecate(function(callback){return this.listApiKeys(callback)},deprecatedMessage("client.listUserKeys()","client.listApiKeys()"));AlgoliaSearch.prototype.listApiKeys=function(callback){return this._jsonRequest({method:"GET",url:"/1/keys",hostType:"read",callback:callback})};AlgoliaSearch.prototype.getUserKeyACL=deprecate(function(key,callback){return this.getApiKey(key,callback)},deprecatedMessage("client.getUserKeyACL()","client.getApiKey()"));AlgoliaSearch.prototype.getApiKey=function(key,callback){return this._jsonRequest({method:"GET",url:"/1/keys/"+key,hostType:"read",callback:callback})};AlgoliaSearch.prototype.deleteUserKey=deprecate(function(key,callback){return this.deleteApiKey(key,callback)},deprecatedMessage("client.deleteUserKey()","client.deleteApiKey()"));AlgoliaSearch.prototype.deleteApiKey=function(key,callback){return this._jsonRequest({method:"DELETE",url:"/1/keys/"+key,hostType:"write",callback:callback})};AlgoliaSearch.prototype.addUserKey=deprecate(function(acls,params,callback){return this.addApiKey(acls,params,callback)},deprecatedMessage("client.addUserKey()","client.addApiKey()"));AlgoliaSearch.prototype.addApiKey=function(acls,params,callback){var isArray=require("isarray");var usage="Usage: client.addApiKey(arrayOfAcls[, params, callback])";if(!isArray(acls)){throw new Error(usage)}if(arguments.length===1||typeof params==="function"){callback=params;params=null}var postObj={acl:acls};if(params){postObj.validity=params.validity;postObj.maxQueriesPerIPPerHour=params.maxQueriesPerIPPerHour;postObj.maxHitsPerQuery=params.maxHitsPerQuery;postObj.indexes=params.indexes;postObj.description=params.description;if(params.queryParameters){postObj.queryParameters=this._getSearchParams(params.queryParameters,"")}postObj.referers=params.referers}return this._jsonRequest({method:"POST",url:"/1/keys",body:postObj,hostType:"write",callback:callback})};AlgoliaSearch.prototype.addUserKeyWithValidity=deprecate(function(acls,params,callback){return this.addApiKey(acls,params,callback)},deprecatedMessage("client.addUserKeyWithValidity()","client.addApiKey()"));AlgoliaSearch.prototype.updateUserKey=deprecate(function(key,acls,params,callback){return this.updateApiKey(key,acls,params,callback)},deprecatedMessage("client.updateUserKey()","client.updateApiKey()"));AlgoliaSearch.prototype.updateApiKey=function(key,acls,params,callback){var isArray=require("isarray");var usage="Usage: client.updateApiKey(key, arrayOfAcls[, params, callback])";if(!isArray(acls)){throw new Error(usage)}if(arguments.length===2||typeof params==="function"){callback=params;params=null}var putObj={acl:acls};if(params){putObj.validity=params.validity;putObj.maxQueriesPerIPPerHour=params.maxQueriesPerIPPerHour;putObj.maxHitsPerQuery=params.maxHitsPerQuery;putObj.indexes=params.indexes;putObj.description=params.description;if(params.queryParameters){putObj.queryParameters=this._getSearchParams(params.queryParameters,"")}putObj.referers=params.referers}return this._jsonRequest({method:"PUT",url:"/1/keys/"+key,body:putObj,hostType:"write",callback:callback})};AlgoliaSearch.prototype.startQueriesBatch=deprecate(function startQueriesBatchDeprecated(){this._batch=[]},deprecatedMessage("client.startQueriesBatch()","client.search()"));AlgoliaSearch.prototype.addQueryInBatch=deprecate(function addQueryInBatchDeprecated(indexName,query,args){this._batch.push({indexName:indexName,query:query,params:args})},deprecatedMessage("client.addQueryInBatch()","client.search()"));AlgoliaSearch.prototype.sendQueriesBatch=deprecate(function sendQueriesBatchDeprecated(callback){return this.search(this._batch,callback)},deprecatedMessage("client.sendQueriesBatch()","client.search()"));AlgoliaSearch.prototype.batch=function(operations,callback){var isArray=require("isarray");var usage="Usage: client.batch(operations[, callback])";if(!isArray(operations)){throw new Error(usage)}return this._jsonRequest({method:"POST",url:"/1/indexes/*/batch",body:{requests:operations},hostType:"write",callback:callback})};AlgoliaSearch.prototype.assignUserID=function(data,callback){if(!data.userID||!data.cluster){throw new errors.AlgoliaSearchError("You have to provide both a userID and cluster",data)}return this._jsonRequest({method:"POST",url:"/1/clusters/mapping",hostType:"write",body:{cluster:data.cluster},callback:callback,headers:{"x-algolia-user-id":data.userID}})};AlgoliaSearch.prototype.getTopUserID=function(callback){return this._jsonRequest({method:"GET",url:"/1/clusters/mapping/top",hostType:"read",callback:callback})};AlgoliaSearch.prototype.getUserID=function(data,callback){if(!data.userID){throw new errors.AlgoliaSearchError("You have to provide a userID",{debugData:data})}return this._jsonRequest({method:"GET",url:"/1/clusters/mapping/"+data.userID,hostType:"read",callback:callback})};AlgoliaSearch.prototype.listClusters=function(callback){return this._jsonRequest({method:"GET",url:"/1/clusters",hostType:"read",callback:callback})};AlgoliaSearch.prototype.listUserIDs=function(data,callback){return this._jsonRequest({method:"GET",url:"/1/clusters/mapping",body:data,hostType:"read",callback:callback})};AlgoliaSearch.prototype.removeUserID=function(data,callback){if(!data.userID){throw new errors.AlgoliaSearchError("You have to provide a userID",{debugData:data})}return this._jsonRequest({method:"DELETE",url:"/1/clusters/mapping",hostType:"write",callback:callback,headers:{"x-algolia-user-id":data.userID}})};AlgoliaSearch.prototype.searchUserIDs=function(data,callback){return this._jsonRequest({method:"POST",url:"/1/clusters/mapping/search",body:data,hostType:"read",callback:callback})};AlgoliaSearch.prototype.setPersonalizationStrategy=function(data,callback){return this._jsonRequest({method:"POST",url:"/1/recommendation/personalization/strategy",body:data,hostType:"write",callback:callback})};AlgoliaSearch.prototype.getPersonalizationStrategy=function(callback){return this._jsonRequest({method:"GET",url:"/1/recommendation/personalization/strategy",hostType:"read",callback:callback})};AlgoliaSearch.prototype.destroy=notImplemented;AlgoliaSearch.prototype.enableRateLimitForward=notImplemented;AlgoliaSearch.prototype.disableRateLimitForward=notImplemented;AlgoliaSearch.prototype.useSecuredAPIKey=notImplemented;AlgoliaSearch.prototype.disableSecuredAPIKey=notImplemented;AlgoliaSearch.prototype.generateSecuredApiKey=notImplemented;function notImplemented(){var message="Not implemented in this environment.\n"+"If you feel this is a mistake, write to support@algolia.com";throw new errors.AlgoliaSearchError(message)}},{"./AlgoliaSearchCore.js":18,"./Index.js":19,"./clone.js":27,"./createAnalyticsClient.js":28,"./deprecate.js":29,"./deprecatedMessage.js":30,"./errors":31,inherits:178,isarray:15}],18:[function(require,module,exports){(function(process){module.exports=AlgoliaSearchCore;var errors=require("./errors");var exitPromise=require("./exitPromise.js");var IndexCore=require("./IndexCore.js");var store=require("./store.js");var MAX_API_KEY_LENGTH=500;var RESET_APP_DATA_TIMER=process.env.RESET_APP_DATA_TIMER&&parseInt(process.env.RESET_APP_DATA_TIMER,10)||60*2*1e3;function AlgoliaSearchCore(applicationID,apiKey,opts){var debug=require("debug")("algoliasearch");var clone=require("./clone.js");var isArray=require("isarray");var map=require("./map.js");var usage="Usage: algoliasearch(applicationID, apiKey, opts)";if(opts._allowEmptyCredentials!==true&&!applicationID){throw new errors.AlgoliaSearchError("Please provide an application ID. "+usage)}if(opts._allowEmptyCredentials!==true&&!apiKey){throw new errors.AlgoliaSearchError("Please provide an API key. "+usage)}this.applicationID=applicationID;this.apiKey=apiKey;this.hosts={read:[],write:[]};opts=opts||{};this._timeouts=opts.timeouts||{connect:1*1e3,read:2*1e3,write:30*1e3};if(opts.timeout){this._timeouts.connect=this._timeouts.read=this._timeouts.write=opts.timeout}var protocol=opts.protocol||"https:";if(!/:$/.test(protocol)){protocol=protocol+":"}if(protocol!=="http:"&&protocol!=="https:"){throw new errors.AlgoliaSearchError("protocol must be `http:` or `https:` (was `"+opts.protocol+"`)")}this._checkAppIdData();if(!opts.hosts){var defaultHosts=map(this._shuffleResult,function(hostNumber){return applicationID+"-"+hostNumber+".algolianet.com"});var mainSuffix=(opts.dsn===false?"":"-dsn")+".algolia.net";this.hosts.read=[this.applicationID+mainSuffix].concat(defaultHosts);this.hosts.write=[this.applicationID+".algolia.net"].concat(defaultHosts)}else if(isArray(opts.hosts)){this.hosts.read=clone(opts.hosts);this.hosts.write=clone(opts.hosts)}else{this.hosts.read=clone(opts.hosts.read);this.hosts.write=clone(opts.hosts.write)}this.hosts.read=map(this.hosts.read,prepareHost(protocol));this.hosts.write=map(this.hosts.write,prepareHost(protocol));this.extraHeaders={};this.cache=opts._cache||{};this._ua=opts._ua;this._useCache=opts._useCache===undefined||opts._cache?true:opts._useCache;this._useRequestCache=this._useCache&&opts._useRequestCache;this._useFallback=opts.useFallback===undefined?true:opts.useFallback;this._setTimeout=opts._setTimeout;debug("init done, %j",this)}AlgoliaSearchCore.prototype.initIndex=function(indexName){return new IndexCore(this,indexName)};AlgoliaSearchCore.prototype.setExtraHeader=function(name,value){this.extraHeaders[name.toLowerCase()]=value};AlgoliaSearchCore.prototype.getExtraHeader=function(name){return this.extraHeaders[name.toLowerCase()]};AlgoliaSearchCore.prototype.unsetExtraHeader=function(name){delete this.extraHeaders[name.toLowerCase()]};AlgoliaSearchCore.prototype.addAlgoliaAgent=function(algoliaAgent){if(this._ua.indexOf(";"+algoliaAgent)===-1){this._ua+=";"+algoliaAgent}};AlgoliaSearchCore.prototype._jsonRequest=function(initialOpts){this._checkAppIdData();var requestDebug=require("debug")("algoliasearch:"+initialOpts.url);var body;var cacheID;var additionalUA=initialOpts.additionalUA||"";var cache=initialOpts.cache;var client=this;var tries=0;var usingFallback=false;var hasFallback=client._useFallback&&client._request.fallback&&initialOpts.fallback;var headers;if(this.apiKey.length>MAX_API_KEY_LENGTH&&initialOpts.body!==undefined&&(initialOpts.body.params!==undefined||initialOpts.body.requests!==undefined)){initialOpts.body.apiKey=this.apiKey;headers=this._computeRequestHeaders({additionalUA:additionalUA,withApiKey:false,headers:initialOpts.headers})}else{headers=this._computeRequestHeaders({additionalUA:additionalUA,headers:initialOpts.headers})}if(initialOpts.body!==undefined){body=safeJSONStringify(initialOpts.body)}requestDebug("request start");var debugData=[];function doRequest(requester,reqOpts){client._checkAppIdData();var startTime=new Date;if(client._useCache&&!client._useRequestCache){cacheID=initialOpts.url}if(client._useCache&&!client._useRequestCache&&body){cacheID+="_body_"+reqOpts.body}if(isCacheValidWithCurrentID(!client._useRequestCache,cache,cacheID)){requestDebug("serving response from cache");var responseText=cache[cacheID];return client._promise.resolve({body:JSON.parse(responseText),responseText:responseText})}if(tries>=client.hosts[initialOpts.hostType].length){if(!hasFallback||usingFallback){requestDebug("could not get any response");return client._promise.reject(new errors.AlgoliaSearchError("Cannot connect to the AlgoliaSearch API."+" Send an email to support@algolia.com to report and resolve the issue."+" Application id was: "+client.applicationID,{debugData:debugData}))}requestDebug("switching to fallback");tries=0;reqOpts.method=initialOpts.fallback.method;reqOpts.url=initialOpts.fallback.url;reqOpts.jsonBody=initialOpts.fallback.body;if(reqOpts.jsonBody){reqOpts.body=safeJSONStringify(reqOpts.jsonBody)}headers=client._computeRequestHeaders({additionalUA:additionalUA,headers:initialOpts.headers});reqOpts.timeouts=client._getTimeoutsForRequest(initialOpts.hostType);client._setHostIndexByType(0,initialOpts.hostType);usingFallback=true;return doRequest(client._request.fallback,reqOpts)}var currentHost=client._getHostByType(initialOpts.hostType);var url=currentHost+reqOpts.url;var options={body:reqOpts.body,jsonBody:reqOpts.jsonBody,method:reqOpts.method,headers:headers,timeouts:reqOpts.timeouts,debug:requestDebug,forceAuthHeaders:reqOpts.forceAuthHeaders};requestDebug("method: %s, url: %s, headers: %j, timeouts: %d",options.method,url,options.headers,options.timeouts);if(requester===client._request.fallback){requestDebug("using fallback")}return requester.call(client,url,options).then(success,tryFallback);function success(httpResponse){var status=httpResponse&&httpResponse.body&&httpResponse.body.message&&httpResponse.body.status||httpResponse.statusCode||httpResponse&&httpResponse.body&&200;requestDebug("received response: statusCode: %s, computed statusCode: %d, headers: %j",httpResponse.statusCode,status,httpResponse.headers);var httpResponseOk=Math.floor(status/100)===2;var endTime=new Date;debugData.push({currentHost:currentHost,headers:removeCredentials(headers),content:body||null,contentLength:body!==undefined?body.length:null,method:reqOpts.method,timeouts:reqOpts.timeouts,url:reqOpts.url,startTime:startTime,endTime:endTime,duration:endTime-startTime,statusCode:status});if(httpResponseOk){if(client._useCache&&!client._useRequestCache&&cache){cache[cacheID]=httpResponse.responseText}return{responseText:httpResponse.responseText,body:httpResponse.body}}var shouldRetry=Math.floor(status/100)!==4;if(shouldRetry){tries+=1;return retryRequest()}requestDebug("unrecoverable error");var unrecoverableError=new errors.AlgoliaSearchError(httpResponse.body&&httpResponse.body.message,{debugData:debugData,statusCode:status});return client._promise.reject(unrecoverableError)}function tryFallback(err){requestDebug("error: %s, stack: %s",err.message,err.stack);var endTime=new Date;debugData.push({currentHost:currentHost,headers:removeCredentials(headers),content:body||null,contentLength:body!==undefined?body.length:null,method:reqOpts.method,timeouts:reqOpts.timeouts,url:reqOpts.url,startTime:startTime,endTime:endTime,duration:endTime-startTime});if(!(err instanceof errors.AlgoliaSearchError)){err=new errors.Unknown(err&&err.message,err)}tries+=1;if(err instanceof errors.Unknown||err instanceof errors.UnparsableJSON||tries>=client.hosts[initialOpts.hostType].length&&(usingFallback||!hasFallback)){err.debugData=debugData;return client._promise.reject(err)}if(err instanceof errors.RequestTimeout){return retryRequestWithHigherTimeout()}return retryRequest()}function retryRequest(){requestDebug("retrying request");client._incrementHostIndex(initialOpts.hostType);return doRequest(requester,reqOpts)}function retryRequestWithHigherTimeout(){requestDebug("retrying request with higher timeout");client._incrementHostIndex(initialOpts.hostType);client._incrementTimeoutMultipler();reqOpts.timeouts=client._getTimeoutsForRequest(initialOpts.hostType);return doRequest(requester,reqOpts)}}function isCacheValidWithCurrentID(useRequestCache,currentCache,currentCacheID){return client._useCache&&useRequestCache&&currentCache&&currentCache[currentCacheID]!==undefined}function interopCallbackReturn(request,callback){if(isCacheValidWithCurrentID(client._useRequestCache,cache,cacheID)){request.catch(function(){delete cache[cacheID]})}if(typeof initialOpts.callback==="function"){request.then(function okCb(content){exitPromise(function(){initialOpts.callback(null,callback(content))},client._setTimeout||setTimeout)},function nookCb(err){exitPromise(function(){initialOpts.callback(err)},client._setTimeout||setTimeout)})}else{return request.then(callback)}}if(client._useCache&&client._useRequestCache){cacheID=initialOpts.url}if(client._useCache&&client._useRequestCache&&body){cacheID+="_body_"+body}if(isCacheValidWithCurrentID(client._useRequestCache,cache,cacheID)){requestDebug("serving request from cache");var maybePromiseForCache=cache[cacheID];var promiseForCache=typeof maybePromiseForCache.then!=="function"?client._promise.resolve({responseText:maybePromiseForCache}):maybePromiseForCache;return interopCallbackReturn(promiseForCache,function(content){return JSON.parse(content.responseText)})}var request=doRequest(client._request,{url:initialOpts.url,method:initialOpts.method,body:body,jsonBody:initialOpts.body,timeouts:client._getTimeoutsForRequest(initialOpts.hostType),forceAuthHeaders:initialOpts.forceAuthHeaders});if(client._useCache&&client._useRequestCache&&cache){cache[cacheID]=request}return interopCallbackReturn(request,function(content){return content.body})};AlgoliaSearchCore.prototype._getSearchParams=function(args,params){if(args===undefined||args===null){return params}for(var key in args){if(key!==null&&args[key]!==undefined&&args.hasOwnProperty(key)){params+=params===""?"":"&";params+=key+"="+encodeURIComponent(Object.prototype.toString.call(args[key])==="[object Array]"?safeJSONStringify(args[key]):args[key])}}return params};AlgoliaSearchCore.prototype._computeRequestHeaders=function(options){var forEach=require("foreach");var ua=options.additionalUA?this._ua+";"+options.additionalUA:this._ua;var requestHeaders={"x-algolia-agent":ua,"x-algolia-application-id":this.applicationID};if(options.withApiKey!==false){requestHeaders["x-algolia-api-key"]=this.apiKey}if(this.userToken){requestHeaders["x-algolia-usertoken"]=this.userToken}if(this.securityTags){requestHeaders["x-algolia-tagfilters"]=this.securityTags}forEach(this.extraHeaders,function addToRequestHeaders(value,key){requestHeaders[key]=value});if(options.headers){forEach(options.headers,function addToRequestHeaders(value,key){requestHeaders[key]=value})}return requestHeaders};AlgoliaSearchCore.prototype.search=function(queries,opts,callback){var isArray=require("isarray");var map=require("./map.js");var usage="Usage: client.search(arrayOfQueries[, callback])";if(!isArray(queries)){throw new Error(usage)}if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}var client=this;var postObj={requests:map(queries,function prepareRequest(query){var params="";if(query.query!==undefined){params+="query="+encodeURIComponent(query.query)}return{indexName:query.indexName,params:client._getSearchParams(query.params,params)}})};var JSONPParams=map(postObj.requests,function prepareJSONPParams(request,requestId){return requestId+"="+encodeURIComponent("/1/indexes/"+encodeURIComponent(request.indexName)+"?"+request.params)}).join("&");var url="/1/indexes/*/queries";if(opts.strategy!==undefined){postObj.strategy=opts.strategy}return this._jsonRequest({cache:this.cache,method:"POST",url:url,body:postObj,hostType:"read",fallback:{method:"GET",url:"/1/indexes/*",body:{params:JSONPParams}},callback:callback})};AlgoliaSearchCore.prototype.searchForFacetValues=function(queries){var isArray=require("isarray");var map=require("./map.js");var usage="Usage: client.searchForFacetValues([{indexName, params: {facetName, facetQuery, ...params}}, ...queries])";if(!isArray(queries)){throw new Error(usage)}var client=this;return client._promise.all(map(queries,function performQuery(query){if(!query||query.indexName===undefined||query.params.facetName===undefined||query.params.facetQuery===undefined){throw new Error(usage)}var clone=require("./clone.js");var omit=require("./omit.js");var indexName=query.indexName;var params=query.params;var facetName=params.facetName;var filteredParams=omit(clone(params),function(keyName){return keyName==="facetName"});var searchParameters=client._getSearchParams(filteredParams,"");return client._jsonRequest({cache:client.cache,method:"POST",url:"/1/indexes/"+encodeURIComponent(indexName)+"/facets/"+encodeURIComponent(facetName)+"/query",hostType:"read",body:{params:searchParameters}})}))};AlgoliaSearchCore.prototype.setSecurityTags=function(tags){if(Object.prototype.toString.call(tags)==="[object Array]"){var strTags=[];for(var i=0;i<tags.length;++i){if(Object.prototype.toString.call(tags[i])==="[object Array]"){var oredTags=[];for(var j=0;j<tags[i].length;++j){oredTags.push(tags[i][j])}strTags.push("("+oredTags.join(",")+")")}else{strTags.push(tags[i])}}tags=strTags.join(",")}this.securityTags=tags};AlgoliaSearchCore.prototype.setUserToken=function(userToken){this.userToken=userToken};AlgoliaSearchCore.prototype.clearCache=function(){this.cache={}};AlgoliaSearchCore.prototype.setRequestTimeout=function(milliseconds){if(milliseconds){this._timeouts.connect=this._timeouts.read=this._timeouts.write=milliseconds}};AlgoliaSearchCore.prototype.setTimeouts=function(timeouts){this._timeouts=timeouts};AlgoliaSearchCore.prototype.getTimeouts=function(){return this._timeouts};AlgoliaSearchCore.prototype._getAppIdData=function(){var data=store.get(this.applicationID);if(data!==null)this._cacheAppIdData(data);return data};AlgoliaSearchCore.prototype._setAppIdData=function(data){data.lastChange=(new Date).getTime();this._cacheAppIdData(data);return store.set(this.applicationID,data)};AlgoliaSearchCore.prototype._checkAppIdData=function(){var data=this._getAppIdData();var now=(new Date).getTime();if(data===null||now-data.lastChange>RESET_APP_DATA_TIMER){return this._resetInitialAppIdData(data)}return data};AlgoliaSearchCore.prototype._resetInitialAppIdData=function(data){var newData=data||{};newData.hostIndexes={read:0,write:0};newData.timeoutMultiplier=1;newData.shuffleResult=newData.shuffleResult||shuffle([1,2,3]);return this._setAppIdData(newData)};AlgoliaSearchCore.prototype._cacheAppIdData=function(data){this._hostIndexes=data.hostIndexes;this._timeoutMultiplier=data.timeoutMultiplier;this._shuffleResult=data.shuffleResult};AlgoliaSearchCore.prototype._partialAppIdDataUpdate=function(newData){var foreach=require("foreach");var currentData=this._getAppIdData();foreach(newData,function(value,key){currentData[key]=value});return this._setAppIdData(currentData)};AlgoliaSearchCore.prototype._getHostByType=function(hostType){return this.hosts[hostType][this._getHostIndexByType(hostType)]};AlgoliaSearchCore.prototype._getTimeoutMultiplier=function(){return this._timeoutMultiplier};AlgoliaSearchCore.prototype._getHostIndexByType=function(hostType){return this._hostIndexes[hostType]};AlgoliaSearchCore.prototype._setHostIndexByType=function(hostIndex,hostType){var clone=require("./clone");var newHostIndexes=clone(this._hostIndexes);newHostIndexes[hostType]=hostIndex;this._partialAppIdDataUpdate({hostIndexes:newHostIndexes});return hostIndex};AlgoliaSearchCore.prototype._incrementHostIndex=function(hostType){return this._setHostIndexByType((this._getHostIndexByType(hostType)+1)%this.hosts[hostType].length,hostType)};AlgoliaSearchCore.prototype._incrementTimeoutMultipler=function(){var timeoutMultiplier=Math.max(this._timeoutMultiplier+1,4);return this._partialAppIdDataUpdate({timeoutMultiplier:timeoutMultiplier})};AlgoliaSearchCore.prototype._getTimeoutsForRequest=function(hostType){return{connect:this._timeouts.connect*this._timeoutMultiplier,complete:this._timeouts[hostType]*this._timeoutMultiplier}};function prepareHost(protocol){return function prepare(host){return protocol+"//"+host.toLowerCase()}}function safeJSONStringify(obj){if(Array.prototype.toJSON===undefined){return JSON.stringify(obj)}var toJSON=Array.prototype.toJSON;delete Array.prototype.toJSON;var out=JSON.stringify(obj);Array.prototype.toJSON=toJSON;return out}function shuffle(array){var currentIndex=array.length;var temporaryValue;var randomIndex;while(currentIndex!==0){randomIndex=Math.floor(Math.random()*currentIndex);currentIndex-=1;temporaryValue=array[currentIndex];array[currentIndex]=array[randomIndex];array[randomIndex]=temporaryValue}return array}function removeCredentials(headers){var newHeaders={};for(var headerName in headers){if(Object.prototype.hasOwnProperty.call(headers,headerName)){var value;if(headerName==="x-algolia-api-key"||headerName==="x-algolia-application-id"){value="**hidden for security purposes**"}else{value=headers[headerName]}newHeaders[headerName]=value}}return newHeaders}}).call(this,require("_process"))},{"./IndexCore.js":21,"./clone":27,"./clone.js":27,"./errors":31,"./exitPromise.js":32,"./map.js":33,"./omit.js":35,"./store.js":37,_process:182,debug:13,foreach:166,isarray:15}],19:[function(require,module,exports){var inherits=require("inherits");var IndexCore=require("./IndexCore.js");var deprecate=require("./deprecate.js");var deprecatedMessage=require("./deprecatedMessage.js");var exitPromise=require("./exitPromise.js");var errors=require("./errors");var deprecateForwardToSlaves=deprecate(function(){},deprecatedMessage("forwardToSlaves","forwardToReplicas"));module.exports=Index;function Index(){IndexCore.apply(this,arguments)}inherits(Index,IndexCore);Index.prototype.addObject=function(content,objectID,callback){var indexObj=this;if(arguments.length===1||typeof objectID==="function"){callback=objectID;objectID=undefined}return this.as._jsonRequest({method:objectID!==undefined?"PUT":"POST",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+(objectID!==undefined?"/"+encodeURIComponent(objectID):""),body:content,hostType:"write",callback:callback})};Index.prototype.addObjects=function(objects,callback){var isArray=require("isarray");var usage="Usage: index.addObjects(arrayOfObjects[, callback])";if(!isArray(objects)){throw new Error(usage)}var indexObj=this;var postObj={requests:[]};for(var i=0;i<objects.length;++i){var request={action:"addObject",body:objects[i]};postObj.requests.push(request)}return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/batch",body:postObj,hostType:"write",callback:callback})};Index.prototype.partialUpdateObject=function(partialObject,createIfNotExists,callback){if(arguments.length===1||typeof createIfNotExists==="function"){callback=createIfNotExists;createIfNotExists=undefined}var indexObj=this;var url="/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/"+encodeURIComponent(partialObject.objectID)+"/partial";if(createIfNotExists===false){url+="?createIfNotExists=false"}return this.as._jsonRequest({method:"POST",url:url,body:partialObject,hostType:"write",callback:callback})};Index.prototype.partialUpdateObjects=function(objects,createIfNotExists,callback){if(arguments.length===1||typeof createIfNotExists==="function"){callback=createIfNotExists;createIfNotExists=true}var isArray=require("isarray");var usage="Usage: index.partialUpdateObjects(arrayOfObjects[, callback])";if(!isArray(objects)){throw new Error(usage)}var indexObj=this;var postObj={requests:[]};for(var i=0;i<objects.length;++i){var request={action:createIfNotExists===true?"partialUpdateObject":"partialUpdateObjectNoCreate",objectID:objects[i].objectID,body:objects[i]};postObj.requests.push(request)}return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/batch",body:postObj,hostType:"write",callback:callback})};Index.prototype.saveObject=function(object,callback){var indexObj=this;return this.as._jsonRequest({method:"PUT",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/"+encodeURIComponent(object.objectID),body:object,hostType:"write",callback:callback})};Index.prototype.saveObjects=function(objects,callback){var isArray=require("isarray");var usage="Usage: index.saveObjects(arrayOfObjects[, callback])";if(!isArray(objects)){throw new Error(usage)}var indexObj=this;var postObj={requests:[]};for(var i=0;i<objects.length;++i){var request={action:"updateObject",objectID:objects[i].objectID,body:objects[i]};postObj.requests.push(request)}return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/batch",body:postObj,hostType:"write",callback:callback})};Index.prototype.deleteObject=function(objectID,callback){if(typeof objectID==="function"||typeof objectID!=="string"&&typeof objectID!=="number"){var err=new errors.AlgoliaSearchError(objectID&&typeof objectID!=="function"?"ObjectID must be a string":"Cannot delete an object without an objectID");callback=objectID;if(typeof callback==="function"){return callback(err)}return this.as._promise.reject(err)}var indexObj=this;return this.as._jsonRequest({method:"DELETE",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/"+encodeURIComponent(objectID),hostType:"write",callback:callback})};Index.prototype.deleteObjects=function(objectIDs,callback){var isArray=require("isarray");var map=require("./map.js");var usage="Usage: index.deleteObjects(arrayOfObjectIDs[, callback])";if(!isArray(objectIDs)){throw new Error(usage)}var indexObj=this;var postObj={requests:map(objectIDs,function prepareRequest(objectID){return{action:"deleteObject",objectID:objectID,body:{objectID:objectID}}})};return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/batch",body:postObj,hostType:"write",callback:callback})};Index.prototype.deleteByQuery=deprecate(function(query,params,callback){var clone=require("./clone.js");var map=require("./map.js");var indexObj=this;var client=indexObj.as;if(arguments.length===1||typeof params==="function"){callback=params;params={}}else{params=clone(params)}params.attributesToRetrieve="objectID";params.hitsPerPage=1e3;params.distinct=false;this.clearCache();var promise=this.search(query,params).then(stopOrDelete);function stopOrDelete(searchContent){if(searchContent.nbHits===0){return searchContent}var objectIDs=map(searchContent.hits,function getObjectID(object){return object.objectID});return indexObj.deleteObjects(objectIDs).then(waitTask).then(doDeleteByQuery)}function waitTask(deleteObjectsContent){return indexObj.waitTask(deleteObjectsContent.taskID)}function doDeleteByQuery(){return indexObj.deleteByQuery(query,params)}if(!callback){return promise}promise.then(success,failure);function success(){exitPromise(function exit(){callback(null)},client._setTimeout||setTimeout)}function failure(err){exitPromise(function exit(){callback(err)},client._setTimeout||setTimeout)}},deprecatedMessage("index.deleteByQuery()","index.deleteBy()"));Index.prototype.deleteBy=function(params,callback){var indexObj=this;return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/deleteByQuery",body:{params:indexObj.as._getSearchParams(params,"")},hostType:"write",callback:callback})};Index.prototype.browseAll=function(query,queryParameters){if(typeof query==="object"){queryParameters=query;query=undefined}var merge=require("./merge.js");var IndexBrowser=require("./IndexBrowser");var browser=new IndexBrowser;var client=this.as;var index=this;var params=client._getSearchParams(merge({},queryParameters||{},{query:query}),"");browseLoop();function browseLoop(cursor){if(browser._stopped){return}var body;if(cursor!==undefined){body={cursor:cursor}}else{body={params:params}}client._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(index.indexName)+"/browse",hostType:"read",body:body,callback:browseCallback})}function browseCallback(err,content){if(browser._stopped){return}if(err){browser._error(err);return}browser._result(content);if(content.cursor===undefined){browser._end();return}browseLoop(content.cursor)}return browser};Index.prototype.ttAdapter=deprecate(function(params){var self=this;return function ttAdapter(query,syncCb,asyncCb){var cb;if(typeof asyncCb==="function"){cb=asyncCb}else{cb=syncCb}self.search(query,params,function searchDone(err,content){if(err){cb(err);return}cb(content.hits)})}},"ttAdapter is not necessary anymore and will be removed in the next version,\n"+"have a look at autocomplete.js (https://github.com/algolia/autocomplete.js)");Index.prototype.waitTask=function(taskID,callback){var baseDelay=100;var maxDelay=5e3;var loop=0;var indexObj=this;var client=indexObj.as;var promise=retryLoop();function retryLoop(){return client._jsonRequest({method:"GET",hostType:"read",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/task/"+taskID}).then(function success(content){loop++;var delay=baseDelay*loop*loop;if(delay>maxDelay){delay=maxDelay}if(content.status!=="published"){return client._promise.delay(delay).then(retryLoop)}return content})}if(!callback){return promise}promise.then(successCb,failureCb);function successCb(content){exitPromise(function exit(){callback(null,content)},client._setTimeout||setTimeout)}function failureCb(err){exitPromise(function exit(){callback(err)},client._setTimeout||setTimeout)}};Index.prototype.clearIndex=function(callback){var indexObj=this;return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/clear",hostType:"write",callback:callback})};Index.prototype.getSettings=function(opts,callback){if(arguments.length===1&&typeof opts==="function"){callback=opts;opts={}}opts=opts||{};var indexName=encodeURIComponent(this.indexName);return this.as._jsonRequest({method:"GET",url:"/1/indexes/"+indexName+"/settings?getVersion=2"+(opts.advanced?"&advanced="+opts.advanced:""),hostType:"read",callback:callback})};Index.prototype.searchSynonyms=function(params,callback){if(typeof params==="function"){callback=params;params={}}else if(params===undefined){params={}}return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/synonyms/search",body:params,hostType:"read",callback:callback})};function exportData(method,_hitsPerPage,callback){function search(page,_previous){var options={page:page||0,hitsPerPage:_hitsPerPage||100};var previous=_previous||[];return method(options).then(function(result){var hits=result.hits;var nbHits=result.nbHits;var current=hits.map(function(s){delete s._highlightResult;return s});var synonyms=previous.concat(current);if(synonyms.length<nbHits){return search(options.page+1,synonyms)}return synonyms})}return search().then(function(data){if(typeof callback==="function"){callback(data);return undefined}return data})}Index.prototype.exportSynonyms=function(hitsPerPage,callback){return exportData(this.searchSynonyms.bind(this),hitsPerPage,callback)};Index.prototype.saveSynonym=function(synonym,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}if(opts.forwardToSlaves!==undefined)deprecateForwardToSlaves();var forwardToReplicas=opts.forwardToSlaves||opts.forwardToReplicas?"true":"false";return this.as._jsonRequest({method:"PUT",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/synonyms/"+encodeURIComponent(synonym.objectID)+"?forwardToReplicas="+forwardToReplicas,body:synonym,hostType:"write",callback:callback})};Index.prototype.getSynonym=function(objectID,callback){return this.as._jsonRequest({method:"GET",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/synonyms/"+encodeURIComponent(objectID),hostType:"read",callback:callback})};Index.prototype.deleteSynonym=function(objectID,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}if(opts.forwardToSlaves!==undefined)deprecateForwardToSlaves();var forwardToReplicas=opts.forwardToSlaves||opts.forwardToReplicas?"true":"false";return this.as._jsonRequest({method:"DELETE",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/synonyms/"+encodeURIComponent(objectID)+"?forwardToReplicas="+forwardToReplicas,hostType:"write",callback:callback})};Index.prototype.clearSynonyms=function(opts,callback){if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}if(opts.forwardToSlaves!==undefined)deprecateForwardToSlaves();var forwardToReplicas=opts.forwardToSlaves||opts.forwardToReplicas?"true":"false";return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/synonyms/clear"+"?forwardToReplicas="+forwardToReplicas,hostType:"write",callback:callback})};Index.prototype.batchSynonyms=function(synonyms,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}if(opts.forwardToSlaves!==undefined)deprecateForwardToSlaves();var forwardToReplicas=opts.forwardToSlaves||opts.forwardToReplicas?"true":"false";return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/synonyms/batch"+"?forwardToReplicas="+forwardToReplicas+"&replaceExistingSynonyms="+(opts.replaceExistingSynonyms?"true":"false"),hostType:"write",body:synonyms,callback:callback})};Index.prototype.searchRules=function(params,callback){if(typeof params==="function"){callback=params;params={}}else if(params===undefined){params={}}return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/rules/search",body:params,hostType:"read",callback:callback})};Index.prototype.exportRules=function(hitsPerPage,callback){return exportData(this.searchRules.bind(this),hitsPerPage,callback)};Index.prototype.saveRule=function(rule,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}if(!rule.objectID){throw new errors.AlgoliaSearchError("Missing or empty objectID field for rule")}var forwardToReplicas=opts.forwardToReplicas===true?"true":"false";return this.as._jsonRequest({method:"PUT",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/rules/"+encodeURIComponent(rule.objectID)+"?forwardToReplicas="+forwardToReplicas,body:rule,hostType:"write",callback:callback})};Index.prototype.getRule=function(objectID,callback){return this.as._jsonRequest({method:"GET",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/rules/"+encodeURIComponent(objectID),hostType:"read",callback:callback})};Index.prototype.deleteRule=function(objectID,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}var forwardToReplicas=opts.forwardToReplicas===true?"true":"false";return this.as._jsonRequest({method:"DELETE",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/rules/"+encodeURIComponent(objectID)+"?forwardToReplicas="+forwardToReplicas,hostType:"write",callback:callback})};Index.prototype.clearRules=function(opts,callback){if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}var forwardToReplicas=opts.forwardToReplicas===true?"true":"false";return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/rules/clear"+"?forwardToReplicas="+forwardToReplicas,hostType:"write",callback:callback})};Index.prototype.batchRules=function(rules,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}else if(opts===undefined){opts={}}var forwardToReplicas=opts.forwardToReplicas===true?"true":"false";return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/rules/batch"+"?forwardToReplicas="+forwardToReplicas+"&clearExistingRules="+(opts.clearExistingRules===true?"true":"false"),hostType:"write",body:rules,callback:callback})};Index.prototype.setSettings=function(settings,opts,callback){if(arguments.length===1||typeof opts==="function"){callback=opts;opts={}}if(opts.forwardToSlaves!==undefined)deprecateForwardToSlaves();var forwardToReplicas=opts.forwardToSlaves||opts.forwardToReplicas?"true":"false";var indexObj=this;return this.as._jsonRequest({method:"PUT",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/settings?forwardToReplicas="+forwardToReplicas,hostType:"write",body:settings,callback:callback})};Index.prototype.listUserKeys=deprecate(function(callback){return this.listApiKeys(callback)},deprecatedMessage("index.listUserKeys()","client.listApiKeys()"));Index.prototype.listApiKeys=deprecate(function(callback){var indexObj=this;return this.as._jsonRequest({method:"GET",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/keys",hostType:"read",callback:callback})},deprecatedMessage("index.listApiKeys()","client.listApiKeys()"));Index.prototype.getUserKeyACL=deprecate(function(key,callback){return this.getApiKey(key,callback)},deprecatedMessage("index.getUserKeyACL()","client.getApiKey()"));Index.prototype.getApiKey=deprecate(function(key,callback){var indexObj=this;return this.as._jsonRequest({method:"GET",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/keys/"+key,hostType:"read",callback:callback})},deprecatedMessage("index.getApiKey()","client.getApiKey()"));Index.prototype.deleteUserKey=deprecate(function(key,callback){return this.deleteApiKey(key,callback)},deprecatedMessage("index.deleteUserKey()","client.deleteApiKey()"));Index.prototype.deleteApiKey=deprecate(function(key,callback){var indexObj=this;return this.as._jsonRequest({method:"DELETE",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/keys/"+key,hostType:"write",callback:callback})},deprecatedMessage("index.deleteApiKey()","client.deleteApiKey()"));Index.prototype.addUserKey=deprecate(function(acls,params,callback){return this.addApiKey(acls,params,callback)},deprecatedMessage("index.addUserKey()","client.addApiKey()"));Index.prototype.addApiKey=deprecate(function(acls,params,callback){var isArray=require("isarray");var usage="Usage: index.addApiKey(arrayOfAcls[, params, callback])";if(!isArray(acls)){throw new Error(usage)}if(arguments.length===1||typeof params==="function"){callback=params;params=null}var postObj={acl:acls};if(params){postObj.validity=params.validity;postObj.maxQueriesPerIPPerHour=params.maxQueriesPerIPPerHour;postObj.maxHitsPerQuery=params.maxHitsPerQuery;postObj.description=params.description;if(params.queryParameters){postObj.queryParameters=this.as._getSearchParams(params.queryParameters,"")}postObj.referers=params.referers}return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/keys",body:postObj,hostType:"write",callback:callback})},deprecatedMessage("index.addApiKey()","client.addApiKey()"));Index.prototype.addUserKeyWithValidity=deprecate(function deprecatedAddUserKeyWithValidity(acls,params,callback){return this.addApiKey(acls,params,callback)},deprecatedMessage("index.addUserKeyWithValidity()","client.addApiKey()"));Index.prototype.updateUserKey=deprecate(function(key,acls,params,callback){return this.updateApiKey(key,acls,params,callback)},deprecatedMessage("index.updateUserKey()","client.updateApiKey()"));Index.prototype.updateApiKey=deprecate(function(key,acls,params,callback){var isArray=require("isarray");var usage="Usage: index.updateApiKey(key, arrayOfAcls[, params, callback])";if(!isArray(acls)){throw new Error(usage)}if(arguments.length===2||typeof params==="function"){callback=params;params=null}var putObj={acl:acls};if(params){putObj.validity=params.validity;putObj.maxQueriesPerIPPerHour=params.maxQueriesPerIPPerHour;putObj.maxHitsPerQuery=params.maxHitsPerQuery;putObj.description=params.description;if(params.queryParameters){putObj.queryParameters=this.as._getSearchParams(params.queryParameters,"")}putObj.referers=params.referers}return this.as._jsonRequest({method:"PUT",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/keys/"+key,body:putObj,hostType:"write",callback:callback})},deprecatedMessage("index.updateApiKey()","client.updateApiKey()"))},{"./IndexBrowser":20,"./IndexCore.js":21,"./clone.js":27,"./deprecate.js":29,"./deprecatedMessage.js":30,"./errors":31,"./exitPromise.js":32,"./map.js":33,"./merge.js":34,inherits:178,isarray:15}],20:[function(require,module,exports){"use strict";module.exports=IndexBrowser;var inherits=require("inherits");var EventEmitter=require("events").EventEmitter;function IndexBrowser(){}inherits(IndexBrowser,EventEmitter);IndexBrowser.prototype.stop=function(){this._stopped=true;this._clean()};IndexBrowser.prototype._end=function(){this.emit("end");this._clean()};IndexBrowser.prototype._error=function(err){this.emit("error",err);this._clean()};IndexBrowser.prototype._result=function(content){this.emit("result",content)};IndexBrowser.prototype._clean=function(){this.removeAllListeners("stop");this.removeAllListeners("end");this.removeAllListeners("error");this.removeAllListeners("result")}},{events:162,inherits:178}],21:[function(require,module,exports){var buildSearchMethod=require("./buildSearchMethod.js");var deprecate=require("./deprecate.js");var deprecatedMessage=require("./deprecatedMessage.js");module.exports=IndexCore;function IndexCore(algoliasearch,indexName){this.indexName=indexName;this.as=algoliasearch;this.typeAheadArgs=null;this.typeAheadValueOption=null;this.cache={}}IndexCore.prototype.clearCache=function(){this.cache={}};IndexCore.prototype.search=buildSearchMethod("query");IndexCore.prototype.similarSearch=deprecate(buildSearchMethod("similarQuery"),deprecatedMessage("index.similarSearch(query[, callback])","index.search({ similarQuery: query }[, callback])"));IndexCore.prototype.browse=function(query,queryParameters,callback){var merge=require("./merge.js");var indexObj=this;var page;var hitsPerPage;if(arguments.length===0||arguments.length===1&&typeof arguments[0]==="function"){page=0;callback=arguments[0];query=undefined}else if(typeof arguments[0]==="number"){page=arguments[0];if(typeof arguments[1]==="number"){hitsPerPage=arguments[1]}else if(typeof arguments[1]==="function"){callback=arguments[1];hitsPerPage=undefined}query=undefined;queryParameters=undefined}else if(typeof arguments[0]==="object"){if(typeof arguments[1]==="function"){callback=arguments[1]}queryParameters=arguments[0];query=undefined}else if(typeof arguments[0]==="string"&&typeof arguments[1]==="function"){callback=arguments[1];queryParameters=undefined}queryParameters=merge({},queryParameters||{},{page:page,hitsPerPage:hitsPerPage,query:query});var params=this.as._getSearchParams(queryParameters,"");return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/browse",body:{params:params},hostType:"read",callback:callback})};IndexCore.prototype.browseFrom=function(cursor,callback){return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/browse",body:{cursor:cursor},hostType:"read",callback:callback})};IndexCore.prototype.searchForFacetValues=function(params,callback){var clone=require("./clone.js");var omit=require("./omit.js");var usage="Usage: index.searchForFacetValues({facetName, facetQuery, ...params}[, callback])";if(params.facetName===undefined||params.facetQuery===undefined){throw new Error(usage)}var facetName=params.facetName;var filteredParams=omit(clone(params),function(keyName){return keyName==="facetName"});var searchParameters=this.as._getSearchParams(filteredParams,"");return this.as._jsonRequest({method:"POST",url:"/1/indexes/"+encodeURIComponent(this.indexName)+"/facets/"+encodeURIComponent(facetName)+"/query",hostType:"read",body:{params:searchParameters},callback:callback})};IndexCore.prototype.searchFacet=deprecate(function(params,callback){return this.searchForFacetValues(params,callback)},deprecatedMessage("index.searchFacet(params[, callback])","index.searchForFacetValues(params[, callback])"));IndexCore.prototype._search=function(params,url,callback,additionalUA){return this.as._jsonRequest({cache:this.cache,method:"POST",url:url||"/1/indexes/"+encodeURIComponent(this.indexName)+"/query",body:{params:params},hostType:"read",fallback:{method:"GET",url:"/1/indexes/"+encodeURIComponent(this.indexName),body:{params:params}},callback:callback,additionalUA:additionalUA})};IndexCore.prototype.getObject=function(objectID,attrs,callback){var indexObj=this;if(arguments.length===1||typeof attrs==="function"){callback=attrs;attrs=undefined}var params="";if(attrs!==undefined){params="?attributes=";for(var i=0;i<attrs.length;++i){if(i!==0){params+=","}params+=attrs[i]}}return this.as._jsonRequest({method:"GET",url:"/1/indexes/"+encodeURIComponent(indexObj.indexName)+"/"+encodeURIComponent(objectID)+params,hostType:"read",callback:callback})};IndexCore.prototype.getObjects=function(objectIDs,attributesToRetrieve,callback){var isArray=require("isarray");var map=require("./map.js");var usage="Usage: index.getObjects(arrayOfObjectIDs[, callback])";if(!isArray(objectIDs)){throw new Error(usage)}var indexObj=this;if(arguments.length===1||typeof attributesToRetrieve==="function"){callback=attributesToRetrieve;attributesToRetrieve=undefined}var body={requests:map(objectIDs,function prepareRequest(objectID){var request={indexName:indexObj.indexName,objectID:objectID};if(attributesToRetrieve){request.attributesToRetrieve=attributesToRetrieve.join(",")}return request})};return this.as._jsonRequest({method:"POST",url:"/1/indexes/*/objects",hostType:"read",body:body,callback:callback})};IndexCore.prototype.as=null;IndexCore.prototype.indexName=null;IndexCore.prototype.typeAheadArgs=null;IndexCore.prototype.typeAheadValueOption=null},{"./buildSearchMethod.js":26,"./clone.js":27,"./deprecate.js":29,"./deprecatedMessage.js":30,"./map.js":33,"./merge.js":34,"./omit.js":35,isarray:15}],22:[function(require,module,exports){"use strict";var AlgoliaSearch=require("../../AlgoliaSearch.js");var createAlgoliasearch=require("../createAlgoliasearch.js");module.exports=createAlgoliasearch(AlgoliaSearch)},{"../../AlgoliaSearch.js":17,"../createAlgoliasearch.js":23}],23:[function(require,module,exports){(function(process){"use strict";var global=require("global");var Promise=global.Promise||require("es6-promise").Promise;module.exports=function createAlgoliasearch(AlgoliaSearch,uaSuffix){var inherits=require("inherits");var errors=require("../errors");var inlineHeaders=require("./inline-headers");var jsonpRequest=require("./jsonp-request");var places=require("../places.js");uaSuffix=uaSuffix||"";if(process.env.NODE_ENV==="debug"){require("debug").enable("algoliasearch*")}function algoliasearch(applicationID,apiKey,opts){var cloneDeep=require("../clone.js");opts=cloneDeep(opts||{});opts._ua=opts._ua||algoliasearch.ua;return new AlgoliaSearchBrowser(applicationID,apiKey,opts)}algoliasearch.version=require("../version.js");algoliasearch.ua="Algolia for vanilla JavaScript "+uaSuffix+algoliasearch.version;algoliasearch.initPlaces=places(algoliasearch);global.__algolia={debug:require("debug"),algoliasearch:algoliasearch};var support={hasXMLHttpRequest:"XMLHttpRequest"in global,hasXDomainRequest:"XDomainRequest"in global};if(support.hasXMLHttpRequest){support.cors="withCredentials"in new XMLHttpRequest}function AlgoliaSearchBrowser(){AlgoliaSearch.apply(this,arguments)}inherits(AlgoliaSearchBrowser,AlgoliaSearch);AlgoliaSearchBrowser.prototype._request=function request(url,opts){return new Promise(function wrapRequest(resolve,reject){if(!support.cors&&!support.hasXDomainRequest){reject(new errors.Network("CORS not supported"));return}url=inlineHeaders(url,opts.headers);var body=opts.body;var req=support.cors?new XMLHttpRequest:new XDomainRequest;var reqTimeout;var timedOut;var connected=false;reqTimeout=setTimeout(onTimeout,opts.timeouts.connect);req.onprogress=onProgress;if("onreadystatechange"in req)req.onreadystatechange=onReadyStateChange;req.onload=onLoad;req.onerror=onError;if(req instanceof XMLHttpRequest){req.open(opts.method,url,true);if(opts.forceAuthHeaders){req.setRequestHeader("x-algolia-application-id",opts.headers["x-algolia-application-id"]);req.setRequestHeader("x-algolia-api-key",opts.headers["x-algolia-api-key"])}}else{req.open(opts.method,url)}if(support.cors){if(body){if(opts.method==="POST"){req.setRequestHeader("content-type","application/x-www-form-urlencoded")}else{req.setRequestHeader("content-type","application/json")}}req.setRequestHeader("accept","application/json")}if(body){req.send(body)}else{req.send()}function onLoad(){if(timedOut){return}clearTimeout(reqTimeout);var out;try{out={body:JSON.parse(req.responseText),responseText:req.responseText,statusCode:req.status,headers:req.getAllResponseHeaders&&req.getAllResponseHeaders()||{}}}catch(e){out=new errors.UnparsableJSON({more:req.responseText})}if(out instanceof errors.UnparsableJSON){reject(out)}else{resolve(out)}}function onError(event){if(timedOut){return}clearTimeout(reqTimeout);reject(new errors.Network({more:event}))}function onTimeout(){timedOut=true;req.abort();reject(new errors.RequestTimeout)}function onConnect(){connected=true;clearTimeout(reqTimeout);reqTimeout=setTimeout(onTimeout,opts.timeouts.complete)}function onProgress(){if(!connected)onConnect()}function onReadyStateChange(){if(!connected&&req.readyState>1)onConnect()}})};AlgoliaSearchBrowser.prototype._request.fallback=function requestFallback(url,opts){url=inlineHeaders(url,opts.headers);return new Promise(function wrapJsonpRequest(resolve,reject){jsonpRequest(url,opts,function jsonpRequestDone(err,content){if(err){reject(err);return}resolve(content)})})};AlgoliaSearchBrowser.prototype._promise={reject:function rejectPromise(val){return Promise.reject(val)},resolve:function resolvePromise(val){return Promise.resolve(val)},delay:function delayPromise(ms){return new Promise(function resolveOnTimeout(resolve){setTimeout(resolve,ms)})},all:function all(promises){return Promise.all(promises)}};return algoliasearch}}).call(this,require("_process"))},{"../clone.js":27,"../errors":31,"../places.js":36,"../version.js":38,"./inline-headers":24,"./jsonp-request":25,_process:182,debug:13,"es6-promise":161,global:177,inherits:178}],24:[function(require,module,exports){"use strict";module.exports=inlineHeaders;var encode=require("querystring-es3/encode");function inlineHeaders(url,headers){if(/\?/.test(url)){url+="&"}else{url+="?"}return url+encode(headers)}},{"querystring-es3/encode":185}],25:[function(require,module,exports){"use strict";module.exports=jsonpRequest;var errors=require("../errors");var JSONPCounter=0;function jsonpRequest(url,opts,cb){if(opts.method!=="GET"){cb(new Error("Method "+opts.method+" "+url+" is not supported by JSONP."));return}opts.debug("JSONP: start");var cbCalled=false;var timedOut=false;JSONPCounter+=1;var head=document.getElementsByTagName("head")[0];var script=document.createElement("script");var cbName="algoliaJSONP_"+JSONPCounter;var done=false;window[cbName]=function(data){removeGlobals();if(timedOut){opts.debug("JSONP: Late answer, ignoring");return}cbCalled=true;clean();cb(null,{body:data,responseText:JSON.stringify(data)})};url+="&callback="+cbName;if(opts.jsonBody&&opts.jsonBody.params){url+="&"+opts.jsonBody.params}var ontimeout=setTimeout(timeout,opts.timeouts.complete);script.onreadystatechange=readystatechange;script.onload=success;script.onerror=error;script.async=true;script.defer=true;script.src=url;head.appendChild(script);function success(){opts.debug("JSONP: success");if(done||timedOut){return}done=true;if(!cbCalled){opts.debug("JSONP: Fail. Script loaded but did not call the callback");clean();cb(new errors.JSONPScriptFail)}}function readystatechange(){if(this.readyState==="loaded"||this.readyState==="complete"){success()}}function clean(){clearTimeout(ontimeout);script.onload=null;script.onreadystatechange=null;script.onerror=null;head.removeChild(script)}function removeGlobals(){try{delete window[cbName];delete window[cbName+"_loaded"]}catch(e){window[cbName]=window[cbName+"_loaded"]=undefined}}function timeout(){opts.debug("JSONP: Script timeout");timedOut=true;clean();cb(new errors.RequestTimeout)}function error(){opts.debug("JSONP: Script error");if(done||timedOut){return}clean();cb(new errors.JSONPScriptError)}}},{"../errors":31}],26:[function(require,module,exports){module.exports=buildSearchMethod;var errors=require("./errors.js");function buildSearchMethod(queryParam,url){return function search(query,args,callback){if(typeof query==="function"&&typeof args==="object"||typeof callback==="object"){throw new errors.AlgoliaSearchError("index.search usage is index.search(query, params, cb)")}if(arguments.length===0||typeof query==="function"){callback=query;query=""}else if(arguments.length===1||typeof args==="function"){callback=args;args=undefined}if(typeof query==="object"&&query!==null){args=query;query=undefined}else if(query===undefined||query===null){query=""}var params="";if(query!==undefined){params+=queryParam+"="+encodeURIComponent(query)}var additionalUA;if(args!==undefined){if(args.additionalUA){additionalUA=args.additionalUA;delete args.additionalUA}params=this.as._getSearchParams(args,params)}return this._search(params,url,callback,additionalUA)}}},{"./errors.js":31}],27:[function(require,module,exports){module.exports=function clone(obj){return JSON.parse(JSON.stringify(obj))}},{}],28:[function(require,module,exports){module.exports=createAnalyticsClient;var algoliasearch=require("../index.js");function createAnalyticsClient(appId,apiKey,opts){var analytics={};opts=opts||{};opts.hosts=opts.hosts||["analytics.algolia.com","analytics.algolia.com","analytics.algolia.com","analytics.algolia.com"];opts.protocol=opts.protocol||"https:";analytics.as=algoliasearch(appId,apiKey,opts);analytics.getABTests=function(_params,callback){var params=params||{};var offset=params.offset||0;var limit=params.limit||10;return this.as._jsonRequest({method:"GET",url:"/2/abtests?offset="+encodeURIComponent(offset)+"&limit="+encodeURIComponent(limit),hostType:"read",forceAuthHeaders:true,callback:callback})};analytics.getABTest=function(abTestID,callback){return this.as._jsonRequest({method:"GET",url:"/2/abtests/"+encodeURIComponent(abTestID),hostType:"read",forceAuthHeaders:true,callback:callback})};analytics.addABTest=function(abTest,callback){return this.as._jsonRequest({method:"POST",url:"/2/abtests",body:abTest,hostType:"read",forceAuthHeaders:true,callback:callback})};analytics.stopABTest=function(abTestID,callback){return this.as._jsonRequest({method:"POST",url:"/2/abtests/"+encodeURIComponent(abTestID)+"/stop",hostType:"read",forceAuthHeaders:true,callback:callback})};analytics.deleteABTest=function(abTestID,callback){return this.as._jsonRequest({method:"DELETE",url:"/2/abtests/"+encodeURIComponent(abTestID),hostType:"write",forceAuthHeaders:true,callback:callback})};analytics.waitTask=function(indexName,taskID,callback){return this.as.initIndex(indexName).waitTask(taskID,callback)};return analytics}},{"../index.js":22}],29:[function(require,module,exports){module.exports=function deprecate(fn,message){var warned=false;function deprecated(){if(!warned){console.warn(message);warned=true}return fn.apply(this,arguments)}return deprecated}},{}],30:[function(require,module,exports){module.exports=function deprecatedMessage(previousUsage,newUsage){var githubAnchorLink=previousUsage.toLowerCase().replace(/[\.\(\)]/g,"");return"algoliasearch: `"+previousUsage+"` was replaced by `"+newUsage+"`. Please see https://github.com/algolia/algoliasearch-client-javascript/wiki/Deprecated#"+githubAnchorLink}},{}],31:[function(require,module,exports){"use strict";var inherits=require("inherits");function AlgoliaSearchError(message,extraProperties){var forEach=require("foreach");var error=this;if(typeof Error.captureStackTrace==="function"){Error.captureStackTrace(this,this.constructor)}else{error.stack=(new Error).stack||"Cannot get a stacktrace, browser is too old"}this.name="AlgoliaSearchError";this.message=message||"Unknown error";if(extraProperties){forEach(extraProperties,function addToErrorObject(value,key){error[key]=value})}}inherits(AlgoliaSearchError,Error);function createCustomError(name,message){function AlgoliaSearchCustomError(){var args=Array.prototype.slice.call(arguments,0);if(typeof args[0]!=="string"){args.unshift(message)}AlgoliaSearchError.apply(this,args);this.name="AlgoliaSearch"+name+"Error"}inherits(AlgoliaSearchCustomError,AlgoliaSearchError);return AlgoliaSearchCustomError}module.exports={AlgoliaSearchError:AlgoliaSearchError,UnparsableJSON:createCustomError("UnparsableJSON","Could not parse the incoming response as JSON, see err.more for details"),RequestTimeout:createCustomError("RequestTimeout","Request timed out before getting a response"),Network:createCustomError("Network","Network issue, see err.more for details"),JSONPScriptFail:createCustomError("JSONPScriptFail","<script> was loaded but did not call our provided callback"),JSONPScriptError:createCustomError("JSONPScriptError","<script> unable to load due to an `error` event on it"),Unknown:createCustomError("Unknown","Unknown error occured")}},{foreach:166,inherits:178}],32:[function(require,module,exports){module.exports=function exitPromise(fn,_setTimeout){_setTimeout(fn,0)}},{}],33:[function(require,module,exports){var foreach=require("foreach");module.exports=function map(arr,fn){var newArr=[];foreach(arr,function(item,itemIndex){newArr.push(fn(item,itemIndex,arr))});return newArr}},{foreach:166}],34:[function(require,module,exports){var foreach=require("foreach");module.exports=function merge(destination){var sources=Array.prototype.slice.call(arguments);foreach(sources,function(source){for(var keyName in source){if(source.hasOwnProperty(keyName)){if(typeof destination[keyName]==="object"&&typeof source[keyName]==="object"){destination[keyName]=merge({},destination[keyName],source[keyName])}else if(source[keyName]!==undefined){destination[keyName]=source[keyName]}}}});return destination}},{foreach:166}],35:[function(require,module,exports){module.exports=function omit(obj,test){var keys=require("object-keys");var foreach=require("foreach");var filtered={};foreach(keys(obj),function doFilter(keyName){if(test(keyName)!==true){filtered[keyName]=obj[keyName]}});return filtered}},{foreach:166,"object-keys":180}],36:[function(require,module,exports){module.exports=createPlacesClient;var qs3=require("querystring-es3");var buildSearchMethod=require("./buildSearchMethod.js");function createPlacesClient(algoliasearch){return function places(appID,apiKey,opts){var cloneDeep=require("./clone.js");opts=opts&&cloneDeep(opts)||{};opts.hosts=opts.hosts||["places-dsn.algolia.net","places-1.algolianet.com","places-2.algolianet.com","places-3.algolianet.com"];if(arguments.length===0||typeof appID==="object"||appID===undefined){appID="";apiKey="";opts._allowEmptyCredentials=true}var client=algoliasearch(appID,apiKey,opts);var index=client.initIndex("places");index.search=buildSearchMethod("query","/1/places/query");index.reverse=function(options,callback){var encoded=qs3.encode(options);return this.as._jsonRequest({method:"GET",url:"/1/places/reverse?"+encoded,hostType:"read",callback:callback})};index.getObject=function(objectID,callback){return this.as._jsonRequest({method:"GET",url:"/1/places/"+encodeURIComponent(objectID),hostType:"read",callback:callback})};return index}}},{"./buildSearchMethod.js":26,"./clone.js":27,"querystring-es3":186}],37:[function(require,module,exports){(function(global){var debug=require("debug")("algoliasearch:src/hostIndexState.js");var localStorageNamespace="algoliasearch-client-js";var store;var moduleStore={state:{},set:function(key,data){this.state[key]=data;return this.state[key]},get:function(key){return this.state[key]||null}};var localStorageStore={set:function(key,data){moduleStore.set(key,data);try{var namespace=JSON.parse(global.localStorage[localStorageNamespace]);namespace[key]=data;global.localStorage[localStorageNamespace]=JSON.stringify(namespace);return namespace[key]}catch(e){return localStorageFailure(key,e)}},get:function(key){try{return JSON.parse(global.localStorage[localStorageNamespace])[key]||null}catch(e){return localStorageFailure(key,e)}}};function localStorageFailure(key,e){debug("localStorage failed with",e);cleanup();store=moduleStore;return store.get(key)}store=supportsLocalStorage()?localStorageStore:moduleStore;module.exports={get:getOrSet,set:getOrSet,supportsLocalStorage:supportsLocalStorage};function getOrSet(key,data){if(arguments.length===1){return store.get(key)}return store.set(key,data)}function supportsLocalStorage(){try{if("localStorage"in global&&global.localStorage!==null){if(!global.localStorage[localStorageNamespace]){global.localStorage.setItem(localStorageNamespace,JSON.stringify({}))}return true}return false}catch(_){return false}}function cleanup(){try{global.localStorage.removeItem(localStorageNamespace)}catch(_){}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{debug:13}],38:[function(require,module,exports){"use strict";module.exports="3.32.1"},{}],39:[function(require,module,exports){require("../../modules/es.array.find-index");module.exports=require("../../internals/entry-unbind")("Array","findIndex")},{"../../internals/entry-unbind":74,"../../modules/es.array.find-index":133}],40:[function(require,module,exports){require("../../modules/es.array.find");module.exports=require("../../internals/entry-unbind")("Array","find")},{"../../internals/entry-unbind":74,"../../modules/es.array.find":134}],41:[function(require,module,exports){require("../../modules/es.object.assign");module.exports=require("../../internals/path").Object.assign},{"../../internals/path":112,"../../modules/es.object.assign":138}],42:[function(require,module,exports){require("../../modules/es.string.repeat");module.exports=require("../../internals/entry-unbind")("String","repeat")},{"../../internals/entry-unbind":74,"../../modules/es.string.repeat":141}],43:[function(require,module,exports){require("../../modules/es.string.starts-with");module.exports=require("../../internals/entry-unbind")("String","startsWith")},{"../../internals/entry-unbind":74,"../../modules/es.string.starts-with":142}],44:[function(require,module,exports){require("../../modules/es.array.concat");require("../../modules/es.object.to-string");require("../../modules/es.symbol");require("../../modules/es.symbol.async-iterator");require("../../modules/es.symbol.description");require("../../modules/es.symbol.has-instance");require("../../modules/es.symbol.is-concat-spreadable");require("../../modules/es.symbol.iterator");require("../../modules/es.symbol.match");require("../../modules/es.symbol.replace");require("../../modules/es.symbol.search");require("../../modules/es.symbol.species");require("../../modules/es.symbol.split");require("../../modules/es.symbol.to-primitive");require("../../modules/es.symbol.to-string-tag");require("../../modules/es.symbol.unscopables");require("../../modules/es.math.to-string-tag");require("../../modules/es.json.to-string-tag");module.exports=require("../../internals/path").Symbol},{"../../internals/path":112,"../../modules/es.array.concat":132,"../../modules/es.json.to-string-tag":136,"../../modules/es.math.to-string-tag":137,"../../modules/es.object.to-string":139,"../../modules/es.symbol":148,"../../modules/es.symbol.async-iterator":143,"../../modules/es.symbol.description":144,"../../modules/es.symbol.has-instance":145,"../../modules/es.symbol.is-concat-spreadable":146,"../../modules/es.symbol.iterator":147,"../../modules/es.symbol.match":149,"../../modules/es.symbol.replace":150,"../../modules/es.symbol.search":151,"../../modules/es.symbol.species":152,"../../modules/es.symbol.split":153,"../../modules/es.symbol.to-primitive":154,"../../modules/es.symbol.to-string-tag":155,"../../modules/es.symbol.unscopables":156}],45:[function(require,module,exports){require("../../modules/es.symbol.iterator");require("../../modules/es.string.iterator");require("../../modules/web.dom-collections.iterator");module.exports=require("../../internals/wrapped-well-known-symbol").f("iterator")},{"../../internals/wrapped-well-known-symbol":131,"../../modules/es.string.iterator":140,"../../modules/es.symbol.iterator":147,"../../modules/web.dom-collections.iterator":160}],46:[function(require,module,exports){module.exports=require("../../es/array/find-index")},{"../../es/array/find-index":39}],47:[function(require,module,exports){module.exports=require("../../es/array/find")},{"../../es/array/find":40}],48:[function(require,module,exports){module.exports=require("../../es/object/assign")},{"../../es/object/assign":41}],49:[function(require,module,exports){module.exports=require("../../es/string/repeat")},{"../../es/string/repeat":42}],50:[function(require,module,exports){module.exports=require("../../es/string/starts-with")},{"../../es/string/starts-with":43}],51:[function(require,module,exports){module.exports=require("../../es/symbol");require("../../modules/esnext.symbol.dispose");require("../../modules/esnext.symbol.observable");require("../../modules/esnext.symbol.pattern-match")},{"../../es/symbol":44,"../../modules/esnext.symbol.dispose":157,"../../modules/esnext.symbol.observable":158,"../../modules/esnext.symbol.pattern-match":159}],52:[function(require,module,exports){module.exports=require("../../es/symbol/iterator")},{"../../es/symbol/iterator":45}],53:[function(require,module,exports){module.exports=function(it){if(typeof it!="function"){throw TypeError(String(it)+" is not a function")}return it}},{}],54:[function(require,module,exports){var UNSCOPABLES=require("../internals/well-known-symbol")("unscopables");var create=require("../internals/object-create");var hide=require("../internals/hide");var ArrayPrototype=Array.prototype;if(ArrayPrototype[UNSCOPABLES]==undefined){hide(ArrayPrototype,UNSCOPABLES,create(null))}module.exports=function(key){ArrayPrototype[UNSCOPABLES][key]=true}},{"../internals/hide":83,"../internals/object-create":98,"../internals/well-known-symbol":130}],55:[function(require,module,exports){var isObject=require("../internals/is-object");module.exports=function(it){if(!isObject(it)){throw TypeError(String(it)+" is not an object")}return it}},{"../internals/is-object":90}],56:[function(require,module,exports){var toIndexedObject=require("../internals/to-indexed-object");var toLength=require("../internals/to-length");var toAbsoluteIndex=require("../internals/to-absolute-index");module.exports=function(IS_INCLUDES){return function($this,el,fromIndex){var O=toIndexedObject($this);var length=toLength(O.length);var index=toAbsoluteIndex(fromIndex,length);var value;if(IS_INCLUDES&&el!=el)while(length>index){value=O[index++];if(value!=value)return true}else for(;length>index;index++)if(IS_INCLUDES||index in O){if(O[index]===el)return IS_INCLUDES||index||0}return!IS_INCLUDES&&-1}}},{"../internals/to-absolute-index":121,"../internals/to-indexed-object":122,"../internals/to-length":124}],57:[function(require,module,exports){var fails=require("../internals/fails");var SPECIES=require("../internals/well-known-symbol")("species");module.exports=function(METHOD_NAME){return!fails(function(){var array=[];var constructor=array.constructor={};constructor[SPECIES]=function(){return{foo:1}};return array[METHOD_NAME](Boolean).foo!==1})}},{"../internals/fails":78,"../internals/well-known-symbol":130}],58:[function(require,module,exports){var bind=require("../internals/bind-context");var IndexedObject=require("../internals/indexed-object");var toObject=require("../internals/to-object");var toLength=require("../internals/to-length");var arraySpeciesCreate=require("../internals/array-species-create");module.exports=function(TYPE,specificCreate){var IS_MAP=TYPE==1;var IS_FILTER=TYPE==2;var IS_SOME=TYPE==3;var IS_EVERY=TYPE==4;var IS_FIND_INDEX=TYPE==6;var NO_HOLES=TYPE==5||IS_FIND_INDEX;var create=specificCreate||arraySpeciesCreate;return function($this,callbackfn,that){var O=toObject($this);var self=IndexedObject(O);var boundFunction=bind(callbackfn,that,3);var length=toLength(self.length);var index=0;var target=IS_MAP?create($this,length):IS_FILTER?create($this,0):undefined;var value,result;for(;length>index;index++)if(NO_HOLES||index in self){value=self[index];result=boundFunction(value,index,O);if(TYPE){if(IS_MAP)target[index]=result;else if(result)switch(TYPE){case 3:return true;case 5:return value;case 6:return index;case 2:target.push(value)}else if(IS_EVERY)return false}}return IS_FIND_INDEX?-1:IS_SOME||IS_EVERY?IS_EVERY:target}}},{"../internals/array-species-create":59,"../internals/bind-context":60,"../internals/indexed-object":86,"../internals/to-length":124,"../internals/to-object":125}],59:[function(require,module,exports){var isObject=require("../internals/is-object");var isArray=require("../internals/is-array");var SPECIES=require("../internals/well-known-symbol")("species");module.exports=function(originalArray,length){var C;if(isArray(originalArray)){C=originalArray.constructor;if(typeof C=="function"&&(C===Array||isArray(C.prototype)))C=undefined;else if(isObject(C)){C=C[SPECIES];if(C===null)C=undefined}}return new(C===undefined?Array:C)(length===0?0:length)}},{"../internals/is-array":88,"../internals/is-object":90,"../internals/well-known-symbol":130}],60:[function(require,module,exports){var aFunction=require("../internals/a-function");module.exports=function(fn,that,length){aFunction(fn);if(that===undefined)return fn;switch(length){case 0:return function(){return fn.call(that)};case 1:return function(a){return fn.call(that,a)};case 2:return function(a,b){return fn.call(that,a,b)};case 3:return function(a,b,c){return fn.call(that,a,b,c)}}return function(){return fn.apply(that,arguments)}}},{"../internals/a-function":53}],61:[function(require,module,exports){var toString={}.toString;module.exports=function(it){return toString.call(it).slice(8,-1)}},{}],62:[function(require,module,exports){var classofRaw=require("../internals/classof-raw");var TO_STRING_TAG=require("../internals/well-known-symbol")("toStringTag");var CORRECT_ARGUMENTS=classofRaw(function(){return arguments}())=="Arguments";var tryGet=function(it,key){try{return it[key]}catch(e){}};module.exports=function(it){var O,tag,result;return it===undefined?"Undefined":it===null?"Null":typeof(tag=tryGet(O=Object(it),TO_STRING_TAG))=="string"?tag:CORRECT_ARGUMENTS?classofRaw(O):(result=classofRaw(O))=="Object"&&typeof O.callee=="function"?"Arguments":result}},{"../internals/classof-raw":61,"../internals/well-known-symbol":130}],63:[function(require,module,exports){var has=require("../internals/has");var ownKeys=require("../internals/own-keys");var getOwnPropertyDescriptorModule=require("../internals/object-get-own-property-descriptor");var definePropertyModule=require("../internals/object-define-property");module.exports=function(target,source){var keys=ownKeys(source);var defineProperty=definePropertyModule.f;var getOwnPropertyDescriptor=getOwnPropertyDescriptorModule.f;for(var i=0;i<keys.length;i++){var key=keys[i];if(!has(target,key))defineProperty(target,key,getOwnPropertyDescriptor(source,key))}}},{"../internals/has":81,"../internals/object-define-property":100,"../internals/object-get-own-property-descriptor":101,"../internals/own-keys":111}],64:[function(require,module,exports){var MATCH=require("../internals/well-known-symbol")("match");module.exports=function(METHOD_NAME){var regexp=/./;try{"/./"[METHOD_NAME](regexp)}catch(e){try{regexp[MATCH]=false;return"/./"[METHOD_NAME](regexp)}catch(f){}}return false}},{"../internals/well-known-symbol":130}],65:[function(require,module,exports){module.exports=!require("../internals/fails")(function(){function F(){}F.prototype.constructor=null;return Object.getPrototypeOf(new F)!==F.prototype})},{"../internals/fails":78}],66:[function(require,module,exports){"use strict";var IteratorPrototype=require("../internals/iterators-core").IteratorPrototype;var create=require("../internals/object-create");var createPropertyDescriptor=require("../internals/create-property-descriptor");var setToStringTag=require("../internals/set-to-string-tag");var Iterators=require("../internals/iterators");var returnThis=function(){return this};module.exports=function(IteratorConstructor,NAME,next){var TO_STRING_TAG=NAME+" Iterator";IteratorConstructor.prototype=create(IteratorPrototype,{next:createPropertyDescriptor(1,next)});setToStringTag(IteratorConstructor,TO_STRING_TAG,false,true);Iterators[TO_STRING_TAG]=returnThis;return IteratorConstructor}},{"../internals/create-property-descriptor":67,"../internals/iterators":94,"../internals/iterators-core":93,"../internals/object-create":98,"../internals/set-to-string-tag":116}],67:[function(require,module,exports){module.exports=function(bitmap,value){return{enumerable:!(bitmap&1),configurable:!(bitmap&2),writable:!(bitmap&4),value:value}}},{}],68:[function(require,module,exports){"use strict";var toPrimitive=require("../internals/to-primitive");var definePropertyModule=require("../internals/object-define-property");var createPropertyDescriptor=require("../internals/create-property-descriptor");module.exports=function(object,key,value){var propertyKey=toPrimitive(key);if(propertyKey in object)definePropertyModule.f(object,propertyKey,createPropertyDescriptor(0,value));else object[propertyKey]=value}},{"../internals/create-property-descriptor":67,"../internals/object-define-property":100,"../internals/to-primitive":126}],69:[function(require,module,exports){"use strict";var $export=require("../internals/export");var createIteratorConstructor=require("../internals/create-iterator-constructor");var getPrototypeOf=require("../internals/object-get-prototype-of");var setPrototypeOf=require("../internals/object-set-prototype-of");var setToStringTag=require("../internals/set-to-string-tag");var hide=require("../internals/hide");var redefine=require("../internals/redefine");var IS_PURE=require("../internals/is-pure");var ITERATOR=require("../internals/well-known-symbol")("iterator");var Iterators=require("../internals/iterators");var IteratorsCore=require("../internals/iterators-core");var IteratorPrototype=IteratorsCore.IteratorPrototype;var BUGGY_SAFARI_ITERATORS=IteratorsCore.BUGGY_SAFARI_ITERATORS;var KEYS="keys";var VALUES="values";var ENTRIES="entries";var returnThis=function(){return this};module.exports=function(Iterable,NAME,IteratorConstructor,next,DEFAULT,IS_SET,FORCED){createIteratorConstructor(IteratorConstructor,NAME,next);var getIterationMethod=function(KIND){if(KIND===DEFAULT&&defaultIterator)return defaultIterator;if(!BUGGY_SAFARI_ITERATORS&&KIND in IterablePrototype)return IterablePrototype[KIND];switch(KIND){case KEYS:return function keys(){return new IteratorConstructor(this,KIND)};case VALUES:return function values(){return new IteratorConstructor(this,KIND)};case ENTRIES:return function entries(){return new IteratorConstructor(this,KIND)}}return function(){return new IteratorConstructor(this)}};var TO_STRING_TAG=NAME+" Iterator";var INCORRECT_VALUES_NAME=false;var IterablePrototype=Iterable.prototype;var nativeIterator=IterablePrototype[ITERATOR]||IterablePrototype["@@iterator"]||DEFAULT&&IterablePrototype[DEFAULT];var defaultIterator=!BUGGY_SAFARI_ITERATORS&&nativeIterator||getIterationMethod(DEFAULT);var anyNativeIterator=NAME=="Array"?IterablePrototype.entries||nativeIterator:nativeIterator;var CurrentIteratorPrototype,methods,KEY;if(anyNativeIterator){CurrentIteratorPrototype=getPrototypeOf(anyNativeIterator.call(new Iterable));if(IteratorPrototype!==Object.prototype&&CurrentIteratorPrototype.next){if(!IS_PURE&&getPrototypeOf(CurrentIteratorPrototype)!==IteratorPrototype){if(setPrototypeOf){setPrototypeOf(CurrentIteratorPrototype,IteratorPrototype)}else if(typeof CurrentIteratorPrototype[ITERATOR]!="function"){hide(CurrentIteratorPrototype,ITERATOR,returnThis)}}setToStringTag(CurrentIteratorPrototype,TO_STRING_TAG,true,true);if(IS_PURE)Iterators[TO_STRING_TAG]=returnThis}}if(DEFAULT==VALUES&&nativeIterator&&nativeIterator.name!==VALUES){INCORRECT_VALUES_NAME=true;defaultIterator=function values(){return nativeIterator.call(this)}}if((!IS_PURE||FORCED)&&IterablePrototype[ITERATOR]!==defaultIterator){hide(IterablePrototype,ITERATOR,defaultIterator)}Iterators[NAME]=defaultIterator;if(DEFAULT){methods={values:getIterationMethod(VALUES),keys:IS_SET?defaultIterator:getIterationMethod(KEYS),entries:getIterationMethod(ENTRIES)};if(FORCED)for(KEY in methods){if(BUGGY_SAFARI_ITERATORS||INCORRECT_VALUES_NAME||!(KEY in IterablePrototype)){redefine(IterablePrototype,KEY,methods[KEY])}}else $export({target:NAME,proto:true,forced:BUGGY_SAFARI_ITERATORS||INCORRECT_VALUES_NAME},methods)}return methods}},{"../internals/create-iterator-constructor":66,"../internals/export":77,"../internals/hide":83,"../internals/is-pure":91,"../internals/iterators":94,"../internals/iterators-core":93,"../internals/object-get-prototype-of":105,"../internals/object-set-prototype-of":109,"../internals/redefine":113,"../internals/set-to-string-tag":116,"../internals/well-known-symbol":130}],70:[function(require,module,exports){var path=require("../internals/path");var has=require("../internals/has");var wrappedWellKnownSymbolModule=require("../internals/wrapped-well-known-symbol");var defineProperty=require("../internals/object-define-property").f;module.exports=function(NAME){var Symbol=path.Symbol||(path.Symbol={});if(!has(Symbol,NAME))defineProperty(Symbol,NAME,{value:wrappedWellKnownSymbolModule.f(NAME)})}},{"../internals/has":81,"../internals/object-define-property":100,"../internals/path":112,"../internals/wrapped-well-known-symbol":131}],71:[function(require,module,exports){module.exports=!require("../internals/fails")(function(){return Object.defineProperty({},"a",{get:function(){return 7}}).a!=7})},{"../internals/fails":78}],72:[function(require,module,exports){var isObject=require("../internals/is-object");var document=require("../internals/global").document;var exist=isObject(document)&&isObject(document.createElement);module.exports=function(it){return exist?document.createElement(it):{}}},{"../internals/global":80,"../internals/is-object":90}],73:[function(require,module,exports){module.exports={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}},{}],74:[function(require,module,exports){var global=require("../internals/global");var bind=require("../internals/bind-context");var call=Function.call;module.exports=function(CONSTRUCTOR,METHOD,length){return bind(call,global[CONSTRUCTOR].prototype[METHOD],length)}},{"../internals/bind-context":60,"../internals/global":80}],75:[function(require,module,exports){module.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},{}],76:[function(require,module,exports){var objectKeys=require("../internals/object-keys");var getOwnPropertySymbolsModule=require("../internals/object-get-own-property-symbols");var propertyIsEnumerableModule=require("../internals/object-property-is-enumerable");module.exports=function(it){var result=objectKeys(it);var getOwnPropertySymbols=getOwnPropertySymbolsModule.f;if(getOwnPropertySymbols){var symbols=getOwnPropertySymbols(it);var propertyIsEnumerable=propertyIsEnumerableModule.f;var i=0;var key;while(symbols.length>i)if(propertyIsEnumerable.call(it,key=symbols[i++]))result.push(key)}return result}},{"../internals/object-get-own-property-symbols":104,"../internals/object-keys":107,"../internals/object-property-is-enumerable":108}],77:[function(require,module,exports){var global=require("../internals/global");var getOwnPropertyDescriptor=require("../internals/object-get-own-property-descriptor").f;var hide=require("../internals/hide");var redefine=require("../internals/redefine");var setGlobal=require("../internals/set-global");var copyConstructorProperties=require("../internals/copy-constructor-properties");var isForced=require("../internals/is-forced");module.exports=function(options,source){var TARGET=options.target;var GLOBAL=options.global;var STATIC=options.stat;var FORCED,target,key,targetProperty,sourceProperty,descriptor;if(GLOBAL){target=global}else if(STATIC){target=global[TARGET]||setGlobal(TARGET,{})}else{target=(global[TARGET]||{}).prototype}if(target)for(key in source){sourceProperty=source[key];if(options.noTargetGet){descriptor=getOwnPropertyDescriptor(target,key);targetProperty=descriptor&&descriptor.value}else targetProperty=target[key];FORCED=isForced(GLOBAL?key:TARGET+(STATIC?".":"#")+key,options.forced);if(!FORCED&&targetProperty!==undefined){if(typeof sourceProperty===typeof targetProperty)continue;copyConstructorProperties(sourceProperty,targetProperty)}if(options.sham||targetProperty&&targetProperty.sham){hide(sourceProperty,"sham",true)}redefine(target,key,sourceProperty,options)}}},{"../internals/copy-constructor-properties":63,"../internals/global":80,"../internals/hide":83,"../internals/is-forced":89,"../internals/object-get-own-property-descriptor":101,"../internals/redefine":113,"../internals/set-global":115}],78:[function(require,module,exports){module.exports=function(exec){try{return!!exec()}catch(e){return true}}},{}],79:[function(require,module,exports){module.exports=require("../internals/shared")("native-function-to-string",Function.toString)},{"../internals/shared":118}],80:[function(require,module,exports){module.exports=typeof window=="object"&&window&&window.Math==Math?window:typeof self=="object"&&self&&self.Math==Math?self:Function("return this")()},{}],81:[function(require,module,exports){var hasOwnProperty={}.hasOwnProperty;module.exports=function(it,key){return hasOwnProperty.call(it,key)}},{}],82:[function(require,module,exports){module.exports={}},{}],83:[function(require,module,exports){var definePropertyModule=require("../internals/object-define-property");var createPropertyDescriptor=require("../internals/create-property-descriptor");module.exports=require("../internals/descriptors")?function(object,key,value){return definePropertyModule.f(object,key,createPropertyDescriptor(1,value))}:function(object,key,value){object[key]=value;return object}},{"../internals/create-property-descriptor":67,"../internals/descriptors":71,"../internals/object-define-property":100}],84:[function(require,module,exports){var document=require("../internals/global").document;module.exports=document&&document.documentElement},{"../internals/global":80}],85:[function(require,module,exports){module.exports=!require("../internals/descriptors")&&!require("../internals/fails")(function(){return Object.defineProperty(require("../internals/document-create-element")("div"),"a",{get:function(){return 7}}).a!=7})},{"../internals/descriptors":71,"../internals/document-create-element":72,"../internals/fails":78}],86:[function(require,module,exports){var fails=require("../internals/fails");var classof=require("../internals/classof-raw");var split="".split;module.exports=fails(function(){return!Object("z").propertyIsEnumerable(0)})?function(it){return classof(it)=="String"?split.call(it,""):Object(it)}:Object},{"../internals/classof-raw":61,"../internals/fails":78}],87:[function(require,module,exports){var NATIVE_WEAK_MAP=require("../internals/native-weak-map");var isObject=require("../internals/is-object");var hide=require("../internals/hide");var objectHas=require("../internals/has");var sharedKey=require("../internals/shared-key");var hiddenKeys=require("../internals/hidden-keys");var WeakMap=require("../internals/global").WeakMap;var set,get,has;var enforce=function(it){return has(it)?get(it):set(it,{})};var getterFor=function(TYPE){return function(it){var state;if(!isObject(it)||(state=get(it)).type!==TYPE){throw TypeError("Incompatible receiver, "+TYPE+" required")}return state}};if(NATIVE_WEAK_MAP){var store=new WeakMap;var wmget=store.get;var wmhas=store.has;var wmset=store.set;set=function(it,metadata){wmset.call(store,it,metadata);return metadata};get=function(it){return wmget.call(store,it)||{}};has=function(it){return wmhas.call(store,it)}}else{var STATE=sharedKey("state");hiddenKeys[STATE]=true;set=function(it,metadata){hide(it,STATE,metadata);return metadata};get=function(it){return objectHas(it,STATE)?it[STATE]:{}};has=function(it){return objectHas(it,STATE)}}module.exports={set:set,get:get,has:has,enforce:enforce,getterFor:getterFor}},{"../internals/global":80,"../internals/has":81,"../internals/hidden-keys":82,"../internals/hide":83,"../internals/is-object":90,"../internals/native-weak-map":96,"../internals/shared-key":117}],88:[function(require,module,exports){var classof=require("../internals/classof-raw");module.exports=Array.isArray||function isArray(arg){return classof(arg)=="Array"}},{"../internals/classof-raw":61}],89:[function(require,module,exports){var fails=require("../internals/fails");var replacement=/#|\.prototype\./;var isForced=function(feature,detection){var value=data[normalize(feature)];return value==POLYFILL?true:value==NATIVE?false:typeof detection=="function"?fails(detection):!!detection};var normalize=isForced.normalize=function(string){return String(string).replace(replacement,".").toLowerCase()};var data=isForced.data={};var NATIVE=isForced.NATIVE="N";var POLYFILL=isForced.POLYFILL="P";module.exports=isForced},{"../internals/fails":78}],90:[function(require,module,exports){module.exports=function(it){return typeof it==="object"?it!==null:typeof it==="function"}},{}],91:[function(require,module,exports){module.exports=false},{}],92:[function(require,module,exports){var isObject=require("../internals/is-object");var classof=require("../internals/classof-raw");var MATCH=require("../internals/well-known-symbol")("match");module.exports=function(it){var isRegExp;return isObject(it)&&((isRegExp=it[MATCH])!==undefined?!!isRegExp:classof(it)=="RegExp")}},{"../internals/classof-raw":61,"../internals/is-object":90,"../internals/well-known-symbol":130}],93:[function(require,module,exports){"use strict";var getPrototypeOf=require("../internals/object-get-prototype-of");var hide=require("../internals/hide");var has=require("../internals/has");var IS_PURE=require("../internals/is-pure");var ITERATOR=require("../internals/well-known-symbol")("iterator");var BUGGY_SAFARI_ITERATORS=false;var returnThis=function(){return this};var IteratorPrototype,PrototypeOfArrayIteratorPrototype,arrayIterator;if([].keys){arrayIterator=[].keys();if(!("next"in arrayIterator))BUGGY_SAFARI_ITERATORS=true;else{PrototypeOfArrayIteratorPrototype=getPrototypeOf(getPrototypeOf(arrayIterator));if(PrototypeOfArrayIteratorPrototype!==Object.prototype)IteratorPrototype=PrototypeOfArrayIteratorPrototype}}if(IteratorPrototype==undefined)IteratorPrototype={};if(!IS_PURE&&!has(IteratorPrototype,ITERATOR))hide(IteratorPrototype,ITERATOR,returnThis);module.exports={IteratorPrototype:IteratorPrototype,BUGGY_SAFARI_ITERATORS:BUGGY_SAFARI_ITERATORS}},{"../internals/has":81,"../internals/hide":83,"../internals/is-pure":91,"../internals/object-get-prototype-of":105,"../internals/well-known-symbol":130}],94:[function(require,module,exports){arguments[4][82][0].apply(exports,arguments)},{dup:82}],95:[function(require,module,exports){module.exports=!require("../internals/fails")(function(){String(Symbol())})},{"../internals/fails":78}],96:[function(require,module,exports){var nativeFunctionToString=require("../internals/function-to-string");var WeakMap=require("../internals/global").WeakMap;module.exports=typeof WeakMap==="function"&&/native code/.test(nativeFunctionToString.call(WeakMap))},{"../internals/function-to-string":79,"../internals/global":80}],97:[function(require,module,exports){"use strict";var objectKeys=require("../internals/object-keys");var getOwnPropertySymbolsModule=require("../internals/object-get-own-property-symbols");var propertyIsEnumerableModule=require("../internals/object-property-is-enumerable");var toObject=require("../internals/to-object");var IndexedObject=require("../internals/indexed-object");var nativeAssign=Object.assign;module.exports=!nativeAssign||require("../internals/fails")(function(){var A={};var B={};var symbol=Symbol();var alphabet="abcdefghijklmnopqrst";A[symbol]=7;alphabet.split("").forEach(function(chr){B[chr]=chr});return nativeAssign({},A)[symbol]!=7||objectKeys(nativeAssign({},B)).join("")!=alphabet})?function assign(target,source){var T=toObject(target);var argumentsLength=arguments.length;var index=1;var getOwnPropertySymbols=getOwnPropertySymbolsModule.f;var propertyIsEnumerable=propertyIsEnumerableModule.f;while(argumentsLength>index){var S=IndexedObject(arguments[index++]);var keys=getOwnPropertySymbols?objectKeys(S).concat(getOwnPropertySymbols(S)):objectKeys(S);var length=keys.length;var j=0;var key;while(length>j)if(propertyIsEnumerable.call(S,key=keys[j++]))T[key]=S[key]}return T}:nativeAssign},{"../internals/fails":78,"../internals/indexed-object":86,"../internals/object-get-own-property-symbols":104,"../internals/object-keys":107,"../internals/object-property-is-enumerable":108,"../internals/to-object":125}],98:[function(require,module,exports){var anObject=require("../internals/an-object");var defineProperties=require("../internals/object-define-properties");var enumBugKeys=require("../internals/enum-bug-keys");var html=require("../internals/html");var documentCreateElement=require("../internals/document-create-element");var IE_PROTO=require("../internals/shared-key")("IE_PROTO");var PROTOTYPE="prototype";var Empty=function(){};var createDict=function(){var iframe=documentCreateElement("iframe");var length=enumBugKeys.length;var lt="<";var script="script";var gt=">";var js="java"+script+":";var iframeDocument;iframe.style.display="none";html.appendChild(iframe);iframe.src=String(js);iframeDocument=iframe.contentWindow.document;iframeDocument.open();iframeDocument.write(lt+script+gt+"document.F=Object"+lt+"/"+script+gt);iframeDocument.close();createDict=iframeDocument.F;while(length--)delete createDict[PROTOTYPE][enumBugKeys[length]];return createDict()};module.exports=Object.create||function create(O,Properties){var result;if(O!==null){Empty[PROTOTYPE]=anObject(O);result=new Empty;Empty[PROTOTYPE]=null;result[IE_PROTO]=O}else result=createDict();return Properties===undefined?result:defineProperties(result,Properties)};require("../internals/hidden-keys")[IE_PROTO]=true},{"../internals/an-object":55,"../internals/document-create-element":72,"../internals/enum-bug-keys":75,"../internals/hidden-keys":82,"../internals/html":84,"../internals/object-define-properties":99,"../internals/shared-key":117}],99:[function(require,module,exports){var DESCRIPTORS=require("../internals/descriptors");var definePropertyModule=require("../internals/object-define-property");var anObject=require("../internals/an-object");var objectKeys=require("../internals/object-keys");module.exports=DESCRIPTORS?Object.defineProperties:function defineProperties(O,Properties){anObject(O);var keys=objectKeys(Properties);var length=keys.length;var i=0;var key;while(length>i)definePropertyModule.f(O,key=keys[i++],Properties[key]);return O}},{"../internals/an-object":55,"../internals/descriptors":71,"../internals/object-define-property":100,"../internals/object-keys":107}],100:[function(require,module,exports){var DESCRIPTORS=require("../internals/descriptors");var IE8_DOM_DEFINE=require("../internals/ie8-dom-define");var anObject=require("../internals/an-object");var toPrimitive=require("../internals/to-primitive");var nativeDefineProperty=Object.defineProperty;exports.f=DESCRIPTORS?nativeDefineProperty:function defineProperty(O,P,Attributes){anObject(O);P=toPrimitive(P,true);anObject(Attributes);if(IE8_DOM_DEFINE)try{return nativeDefineProperty(O,P,Attributes)}catch(e){}if("get"in Attributes||"set"in Attributes)throw TypeError("Accessors not supported");if("value"in Attributes)O[P]=Attributes.value;return O}},{"../internals/an-object":55,"../internals/descriptors":71,"../internals/ie8-dom-define":85,"../internals/to-primitive":126}],101:[function(require,module,exports){var DESCRIPTORS=require("../internals/descriptors");var propertyIsEnumerableModule=require("../internals/object-property-is-enumerable");var createPropertyDescriptor=require("../internals/create-property-descriptor");var toIndexedObject=require("../internals/to-indexed-object");var toPrimitive=require("../internals/to-primitive");var has=require("../internals/has");var IE8_DOM_DEFINE=require("../internals/ie8-dom-define");var nativeGetOwnPropertyDescriptor=Object.getOwnPropertyDescriptor;exports.f=DESCRIPTORS?nativeGetOwnPropertyDescriptor:function getOwnPropertyDescriptor(O,P){O=toIndexedObject(O);P=toPrimitive(P,true);if(IE8_DOM_DEFINE)try{return nativeGetOwnPropertyDescriptor(O,P)}catch(e){}if(has(O,P))return createPropertyDescriptor(!propertyIsEnumerableModule.f.call(O,P),O[P])}},{"../internals/create-property-descriptor":67,"../internals/descriptors":71,"../internals/has":81,"../internals/ie8-dom-define":85,"../internals/object-property-is-enumerable":108,"../internals/to-indexed-object":122,"../internals/to-primitive":126}],102:[function(require,module,exports){var toIndexedObject=require("../internals/to-indexed-object");var nativeGetOwnPropertyNames=require("../internals/object-get-own-property-names").f;var toString={}.toString;var windowNames=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];var getWindowNames=function(it){try{return nativeGetOwnPropertyNames(it)}catch(e){return windowNames.slice()}};module.exports.f=function getOwnPropertyNames(it){return windowNames&&toString.call(it)=="[object Window]"?getWindowNames(it):nativeGetOwnPropertyNames(toIndexedObject(it))}},{"../internals/object-get-own-property-names":103,"../internals/to-indexed-object":122}],103:[function(require,module,exports){var internalObjectKeys=require("../internals/object-keys-internal");var hiddenKeys=require("../internals/enum-bug-keys").concat("length","prototype");exports.f=Object.getOwnPropertyNames||function getOwnPropertyNames(O){return internalObjectKeys(O,hiddenKeys)}},{"../internals/enum-bug-keys":75,"../internals/object-keys-internal":106}],104:[function(require,module,exports){exports.f=Object.getOwnPropertySymbols},{}],105:[function(require,module,exports){var has=require("../internals/has");var toObject=require("../internals/to-object");var IE_PROTO=require("../internals/shared-key")("IE_PROTO");var CORRECT_PROTOTYPE_GETTER=require("../internals/correct-prototype-getter");var ObjectPrototype=Object.prototype;module.exports=CORRECT_PROTOTYPE_GETTER?Object.getPrototypeOf:function(O){O=toObject(O);if(has(O,IE_PROTO))return O[IE_PROTO];if(typeof O.constructor=="function"&&O instanceof O.constructor){return O.constructor.prototype}return O instanceof Object?ObjectPrototype:null}},{"../internals/correct-prototype-getter":65,"../internals/has":81,"../internals/shared-key":117,"../internals/to-object":125}],106:[function(require,module,exports){var has=require("../internals/has");var toIndexedObject=require("../internals/to-indexed-object");var arrayIndexOf=require("../internals/array-includes")(false);var hiddenKeys=require("../internals/hidden-keys");module.exports=function(object,names){var O=toIndexedObject(object);var i=0;var result=[];var key;for(key in O)!has(hiddenKeys,key)&&has(O,key)&&result.push(key);while(names.length>i)if(has(O,key=names[i++])){~arrayIndexOf(result,key)||result.push(key)}return result}},{"../internals/array-includes":56,"../internals/has":81,"../internals/hidden-keys":82,"../internals/to-indexed-object":122}],107:[function(require,module,exports){var internalObjectKeys=require("../internals/object-keys-internal");var enumBugKeys=require("../internals/enum-bug-keys");module.exports=Object.keys||function keys(O){return internalObjectKeys(O,enumBugKeys)}},{"../internals/enum-bug-keys":75,"../internals/object-keys-internal":106}],108:[function(require,module,exports){"use strict";var nativePropertyIsEnumerable={}.propertyIsEnumerable;var nativeGetOwnPropertyDescriptor=Object.getOwnPropertyDescriptor;var NASHORN_BUG=nativeGetOwnPropertyDescriptor&&!nativePropertyIsEnumerable.call({1:2},1);exports.f=NASHORN_BUG?function propertyIsEnumerable(V){var descriptor=nativeGetOwnPropertyDescriptor(this,V);return!!descriptor&&descriptor.enumerable}:nativePropertyIsEnumerable},{}],109:[function(require,module,exports){var validateSetPrototypeOfArguments=require("../internals/validate-set-prototype-of-arguments");module.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var correctSetter=false;var test={};var setter;try{setter=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set;setter.call(test,[]);correctSetter=test instanceof Array}catch(e){}return function setPrototypeOf(O,proto){validateSetPrototypeOfArguments(O,proto);if(correctSetter)setter.call(O,proto);else O.__proto__=proto;return O}}():undefined)},{"../internals/validate-set-prototype-of-arguments":128}],110:[function(require,module,exports){"use strict";var classof=require("../internals/classof");var TO_STRING_TAG=require("../internals/well-known-symbol")("toStringTag");var test={};test[TO_STRING_TAG]="z";module.exports=String(test)!=="[object z]"?function toString(){return"[object "+classof(this)+"]"}:test.toString},{"../internals/classof":62,"../internals/well-known-symbol":130}],111:[function(require,module,exports){var getOwnPropertyNamesModule=require("../internals/object-get-own-property-names");var getOwnPropertySymbolsModule=require("../internals/object-get-own-property-symbols");var anObject=require("../internals/an-object");var Reflect=require("../internals/global").Reflect;module.exports=Reflect&&Reflect.ownKeys||function ownKeys(it){var keys=getOwnPropertyNamesModule.f(anObject(it));var getOwnPropertySymbols=getOwnPropertySymbolsModule.f;return getOwnPropertySymbols?keys.concat(getOwnPropertySymbols(it)):keys}},{"../internals/an-object":55,"../internals/global":80,"../internals/object-get-own-property-names":103,"../internals/object-get-own-property-symbols":104}],112:[function(require,module,exports){module.exports=require("../internals/global")},{"../internals/global":80}],113:[function(require,module,exports){var global=require("../internals/global");var hide=require("../internals/hide");var has=require("../internals/has");var setGlobal=require("../internals/set-global");var nativeFunctionToString=require("../internals/function-to-string");var InternalStateModule=require("../internals/internal-state");var getInternalState=InternalStateModule.get;var enforceInternalState=InternalStateModule.enforce;var TEMPLATE=String(nativeFunctionToString).split("toString");require("../internals/shared")("inspectSource",function(it){return nativeFunctionToString.call(it)});(module.exports=function(O,key,value,options){var unsafe=options?!!options.unsafe:false;var simple=options?!!options.enumerable:false;var noTargetGet=options?!!options.noTargetGet:false;if(typeof value=="function"){if(typeof key=="string"&&!has(value,"name"))hide(value,"name",key);enforceInternalState(value).source=TEMPLATE.join(typeof key=="string"?key:"")}if(O===global){if(simple)O[key]=value;else setGlobal(key,value);return}else if(!unsafe){delete O[key]}else if(!noTargetGet&&O[key]){simple=true}if(simple)O[key]=value;else hide(O,key,value)})(Function.prototype,"toString",function toString(){return typeof this=="function"&&getInternalState(this).source||nativeFunctionToString.call(this)})},{"../internals/function-to-string":79,"../internals/global":80,"../internals/has":81,"../internals/hide":83,"../internals/internal-state":87,"../internals/set-global":115,"../internals/shared":118}],114:[function(require,module,exports){module.exports=function(it){if(it==undefined)throw TypeError("Can't call method on "+it);return it}},{}],115:[function(require,module,exports){var global=require("../internals/global");var hide=require("../internals/hide");module.exports=function(key,value){try{hide(global,key,value)}catch(e){global[key]=value}return value}},{"../internals/global":80,"../internals/hide":83}],116:[function(require,module,exports){var defineProperty=require("../internals/object-define-property").f;var has=require("../internals/has");var TO_STRING_TAG=require("../internals/well-known-symbol")("toStringTag");module.exports=function(it,TAG,STATIC){if(it&&!has(it=STATIC?it:it.prototype,TO_STRING_TAG)){defineProperty(it,TO_STRING_TAG,{configurable:true,value:TAG})}}},{"../internals/has":81,"../internals/object-define-property":100,"../internals/well-known-symbol":130}],117:[function(require,module,exports){var shared=require("../internals/shared")("keys");var uid=require("../internals/uid");module.exports=function(key){return shared[key]||(shared[key]=uid(key))}},{"../internals/shared":118,"../internals/uid":127}],118:[function(require,module,exports){var global=require("../internals/global");var setGlobal=require("../internals/set-global");var SHARED="__core-js_shared__";var store=global[SHARED]||setGlobal(SHARED,{});(module.exports=function(key,value){return store[key]||(store[key]=value!==undefined?value:{})})("versions",[]).push({version:"3.0.0",mode:require("../internals/is-pure")?"pure":"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})},{"../internals/global":80,"../internals/is-pure":91,"../internals/set-global":115}],119:[function(require,module,exports){var toInteger=require("../internals/to-integer");var requireObjectCoercible=require("../internals/require-object-coercible");module.exports=function(that,pos,CONVERT_TO_STRING){var S=String(requireObjectCoercible(that));var position=toInteger(pos);var size=S.length;var first,second;if(position<0||position>=size)return CONVERT_TO_STRING?"":undefined;first=S.charCodeAt(position);return first<55296||first>56319||position+1===size||(second=S.charCodeAt(position+1))<56320||second>57343?CONVERT_TO_STRING?S.charAt(position):first:CONVERT_TO_STRING?S.slice(position,position+2):(first-55296<<10)+(second-56320)+65536}},{"../internals/require-object-coercible":114,"../internals/to-integer":123}],120:[function(require,module,exports){"use strict";var toInteger=require("../internals/to-integer");var requireObjectCoercible=require("../internals/require-object-coercible");module.exports="".repeat||function repeat(count){var str=String(requireObjectCoercible(this));var result="";var n=toInteger(count);if(n<0||n==Infinity)throw RangeError("Wrong number of repetitions");for(;n>0;(n>>>=1)&&(str+=str))if(n&1)result+=str;return result}},{"../internals/require-object-coercible":114,"../internals/to-integer":123}],121:[function(require,module,exports){var toInteger=require("../internals/to-integer");var max=Math.max;var min=Math.min;module.exports=function(index,length){var integer=toInteger(index);return integer<0?max(integer+length,0):min(integer,length)}},{"../internals/to-integer":123}],122:[function(require,module,exports){var IndexedObject=require("../internals/indexed-object");var requireObjectCoercible=require("../internals/require-object-coercible");module.exports=function(it){return IndexedObject(requireObjectCoercible(it))}},{"../internals/indexed-object":86,"../internals/require-object-coercible":114}],123:[function(require,module,exports){var ceil=Math.ceil;var floor=Math.floor;module.exports=function(argument){return isNaN(argument=+argument)?0:(argument>0?floor:ceil)(argument)}},{}],124:[function(require,module,exports){var toInteger=require("../internals/to-integer");var min=Math.min;module.exports=function(argument){return argument>0?min(toInteger(argument),9007199254740991):0}},{"../internals/to-integer":123}],125:[function(require,module,exports){var requireObjectCoercible=require("../internals/require-object-coercible");module.exports=function(argument){return Object(requireObjectCoercible(argument))}},{"../internals/require-object-coercible":114}],126:[function(require,module,exports){var isObject=require("../internals/is-object");module.exports=function(it,S){if(!isObject(it))return it;var fn,val;if(S&&typeof(fn=it.toString)=="function"&&!isObject(val=fn.call(it)))return val;if(typeof(fn=it.valueOf)=="function"&&!isObject(val=fn.call(it)))return val;if(!S&&typeof(fn=it.toString)=="function"&&!isObject(val=fn.call(it)))return val;throw TypeError("Can't convert object to primitive value")}},{"../internals/is-object":90}],127:[function(require,module,exports){var id=0;var postfix=Math.random();module.exports=function(key){return"Symbol(".concat(key===undefined?"":key,")_",(++id+postfix).toString(36))}},{}],128:[function(require,module,exports){var isObject=require("../internals/is-object");var anObject=require("../internals/an-object");module.exports=function(O,proto){anObject(O);if(!isObject(proto)&&proto!==null){throw TypeError("Can't set "+String(proto)+" as a prototype")}}},{"../internals/an-object":55,"../internals/is-object":90}],129:[function(require,module,exports){var isRegExp=require("../internals/is-regexp");var requireObjectCoercible=require("../internals/require-object-coercible");module.exports=function(that,searchString,NAME){if(isRegExp(searchString)){throw TypeError("String.prototype."+NAME+" doesn't accept regex")}return String(requireObjectCoercible(that))}},{"../internals/is-regexp":92,"../internals/require-object-coercible":114}],130:[function(require,module,exports){var store=require("../internals/shared")("wks");var uid=require("../internals/uid");var Symbol=require("../internals/global").Symbol;var NATIVE_SYMBOL=require("../internals/native-symbol");module.exports=function(name){return store[name]||(store[name]=NATIVE_SYMBOL&&Symbol[name]||(NATIVE_SYMBOL?Symbol:uid)("Symbol."+name))}},{"../internals/global":80,"../internals/native-symbol":95,"../internals/shared":118,"../internals/uid":127}],131:[function(require,module,exports){exports.f=require("../internals/well-known-symbol")},{"../internals/well-known-symbol":130}],132:[function(require,module,exports){"use strict";var isArray=require("../internals/is-array");var isObject=require("../internals/is-object");var toObject=require("../internals/to-object");var toLength=require("../internals/to-length");var createProperty=require("../internals/create-property");var arraySpeciesCreate=require("../internals/array-species-create");var IS_CONCAT_SPREADABLE=require("../internals/well-known-symbol")("isConcatSpreadable");var MAX_SAFE_INTEGER=9007199254740991;var MAXIMUM_ALLOWED_INDEX_EXCEEDED="Maximum allowed index exceeded";var IS_CONCAT_SPREADABLE_SUPPORT=!require("../internals/fails")(function(){var array=[];array[IS_CONCAT_SPREADABLE]=false;return array.concat()[0]!==array});var SPECIES_SUPPORT=require("../internals/array-method-has-species-support")("concat");var isConcatSpreadable=function(O){if(!isObject(O))return false;var spreadable=O[IS_CONCAT_SPREADABLE];return spreadable!==undefined?!!spreadable:isArray(O)};var FORCED=!IS_CONCAT_SPREADABLE_SUPPORT||!SPECIES_SUPPORT;require("../internals/export")({target:"Array",proto:true,forced:FORCED},{concat:function concat(arg){var O=toObject(this);var A=arraySpeciesCreate(O,0);var n=0;var i,k,length,len,E;for(i=-1,length=arguments.length;i<length;i++){E=i===-1?O:arguments[i];if(isConcatSpreadable(E)){len=toLength(E.length);if(n+len>MAX_SAFE_INTEGER)throw TypeError(MAXIMUM_ALLOWED_INDEX_EXCEEDED);for(k=0;k<len;k++,n++)if(k in E)createProperty(A,n,E[k])}else{if(n>=MAX_SAFE_INTEGER)throw TypeError(MAXIMUM_ALLOWED_INDEX_EXCEEDED);createProperty(A,n++,E)}}A.length=n;return A}})},{"../internals/array-method-has-species-support":57,"../internals/array-species-create":59,"../internals/create-property":68,"../internals/export":77,"../internals/fails":78,"../internals/is-array":88,"../internals/is-object":90,"../internals/to-length":124,"../internals/to-object":125,"../internals/well-known-symbol":130}],133:[function(require,module,exports){"use strict";var internalFindIndex=require("../internals/array-methods")(6);var FIND_INDEX="findIndex";var SKIPS_HOLES=true;if(FIND_INDEX in[])Array(1)[FIND_INDEX](function(){SKIPS_HOLES=false});require("../internals/export")({target:"Array",proto:true,forced:SKIPS_HOLES},{findIndex:function findIndex(callbackfn){return internalFindIndex(this,callbackfn,arguments.length>1?arguments[1]:undefined)}});require("../internals/add-to-unscopables")(FIND_INDEX)},{"../internals/add-to-unscopables":54,"../internals/array-methods":58,"../internals/export":77}],134:[function(require,module,exports){"use strict";var internalFind=require("../internals/array-methods")(5);var FIND="find";var SKIPS_HOLES=true;if(FIND in[])Array(1)[FIND](function(){SKIPS_HOLES=false});require("../internals/export")({target:"Array",proto:true,forced:SKIPS_HOLES},{find:function find(callbackfn){return internalFind(this,callbackfn,arguments.length>1?arguments[1]:undefined)}});require("../internals/add-to-unscopables")(FIND)},{"../internals/add-to-unscopables":54,"../internals/array-methods":58,"../internals/export":77}],135:[function(require,module,exports){"use strict";var toIndexedObject=require("../internals/to-indexed-object");var addToUnscopables=require("../internals/add-to-unscopables");var Iterators=require("../internals/iterators");var InternalStateModule=require("../internals/internal-state");var defineIterator=require("../internals/define-iterator");var ARRAY_ITERATOR="Array Iterator";var setInternalState=InternalStateModule.set;var getInternalState=InternalStateModule.getterFor(ARRAY_ITERATOR);module.exports=defineIterator(Array,"Array",function(iterated,kind){setInternalState(this,{type:ARRAY_ITERATOR,target:toIndexedObject(iterated),index:0,kind:kind})},function(){var state=getInternalState(this);var target=state.target;var kind=state.kind;var index=state.index++;if(!target||index>=target.length){state.target=undefined;return{value:undefined,done:true}}if(kind=="keys")return{value:index,done:false};if(kind=="values")return{value:target[index],done:false};return{value:[index,target[index]],done:false}},"values");Iterators.Arguments=Iterators.Array;addToUnscopables("keys");addToUnscopables("values");addToUnscopables("entries")},{"../internals/add-to-unscopables":54,"../internals/define-iterator":69,"../internals/internal-state":87,"../internals/iterators":94,"../internals/to-indexed-object":122}],136:[function(require,module,exports){require("../internals/set-to-string-tag")(require("../internals/global").JSON,"JSON",true)},{"../internals/global":80,"../internals/set-to-string-tag":116}],137:[function(require,module,exports){require("../internals/set-to-string-tag")(Math,"Math",true)},{"../internals/set-to-string-tag":116}],138:[function(require,module,exports){var assign=require("../internals/object-assign");require("../internals/export")({target:"Object",stat:true,forced:Object.assign!==assign},{assign:assign})},{"../internals/export":77,"../internals/object-assign":97}],139:[function(require,module,exports){var toString=require("../internals/object-to-string");var ObjectPrototype=Object.prototype;if(toString!==ObjectPrototype.toString){require("../internals/redefine")(ObjectPrototype,"toString",toString,{unsafe:true})}},{"../internals/object-to-string":110,"../internals/redefine":113}],140:[function(require,module,exports){"use strict";var codePointAt=require("../internals/string-at");var InternalStateModule=require("../internals/internal-state");var defineIterator=require("../internals/define-iterator");var STRING_ITERATOR="String Iterator";var setInternalState=InternalStateModule.set;var getInternalState=InternalStateModule.getterFor(STRING_ITERATOR);defineIterator(String,"String",function(iterated){setInternalState(this,{type:STRING_ITERATOR,string:String(iterated),index:0})},function next(){var state=getInternalState(this);var string=state.string;var index=state.index;var point;if(index>=string.length)return{value:undefined,done:true};point=codePointAt(string,index,true);state.index+=point.length;return{value:point,done:false}})},{"../internals/define-iterator":69,"../internals/internal-state":87,"../internals/string-at":119}],141:[function(require,module,exports){require("../internals/export")({target:"String",proto:true},{repeat:require("../internals/string-repeat")})},{"../internals/export":77,"../internals/string-repeat":120}],142:[function(require,module,exports){"use strict";var toLength=require("../internals/to-length");var validateArguments=require("../internals/validate-string-method-arguments");var STARTS_WITH="startsWith";var CORRECT_IS_REGEXP_LOGIC=require("../internals/correct-is-regexp-logic")(STARTS_WITH);var nativeStartsWith=""[STARTS_WITH];require("../internals/export")({target:"String",proto:true,forced:!CORRECT_IS_REGEXP_LOGIC},{startsWith:function startsWith(searchString){var that=validateArguments(this,searchString,STARTS_WITH);var index=toLength(Math.min(arguments.length>1?arguments[1]:undefined,that.length));var search=String(searchString);return nativeStartsWith?nativeStartsWith.call(that,search,index):that.slice(index,index+search.length)===search}})},{"../internals/correct-is-regexp-logic":64,"../internals/export":77,"../internals/to-length":124,"../internals/validate-string-method-arguments":129}],143:[function(require,module,exports){require("../internals/define-well-known-symbol")("asyncIterator")},{"../internals/define-well-known-symbol":70}],144:[function(require,module,exports){"use strict";var DESCRIPTORS=require("../internals/descriptors");var has=require("../internals/has");var isObject=require("../internals/is-object");var defineProperty=require("../internals/object-define-property").f;var copyConstructorProperties=require("../internals/copy-constructor-properties");var NativeSymbol=require("../internals/global").Symbol;if(DESCRIPTORS&&typeof NativeSymbol=="function"&&(!("description"in NativeSymbol.prototype)||NativeSymbol().description!==undefined)){var EmptyStringDescriptionStore={};var SymbolWrapper=function Symbol(){var description=arguments.length<1||arguments[0]===undefined?undefined:String(arguments[0]);var result=this instanceof SymbolWrapper?new NativeSymbol(description):description===undefined?NativeSymbol():NativeSymbol(description);if(description==="")EmptyStringDescriptionStore[result]=true;return result};copyConstructorProperties(SymbolWrapper,NativeSymbol);var symbolPrototype=SymbolWrapper.prototype=NativeSymbol.prototype;symbolPrototype.constructor=SymbolWrapper;var symbolToString=symbolPrototype.toString;var native=String(NativeSymbol("test"))=="Symbol(test)";var regexp=/^Symbol\((.*)\)[^)]+$/;defineProperty(symbolPrototype,"description",{configurable:true,get:function description(){var symbol=isObject(this)?this.valueOf():this;var string=symbolToString.call(symbol);if(has(EmptyStringDescriptionStore,symbol))return"";var desc=native?string.slice(7,-1):string.replace(regexp,"$1");return desc===""?undefined:desc}});require("../internals/export")({global:true,forced:true},{Symbol:SymbolWrapper})}},{"../internals/copy-constructor-properties":63,"../internals/descriptors":71,"../internals/export":77,"../internals/global":80,"../internals/has":81,"../internals/is-object":90,"../internals/object-define-property":100}],145:[function(require,module,exports){require("../internals/define-well-known-symbol")("hasInstance")},{"../internals/define-well-known-symbol":70}],146:[function(require,module,exports){require("../internals/define-well-known-symbol")("isConcatSpreadable")},{"../internals/define-well-known-symbol":70}],147:[function(require,module,exports){require("../internals/define-well-known-symbol")("iterator")},{"../internals/define-well-known-symbol":70}],148:[function(require,module,exports){"use strict";var global=require("../internals/global");var has=require("../internals/has");var DESCRIPTORS=require("../internals/descriptors");var IS_PURE=require("../internals/is-pure");var $export=require("../internals/export");var redefine=require("../internals/redefine");var hiddenKeys=require("../internals/hidden-keys");var fails=require("../internals/fails");var shared=require("../internals/shared");var setToStringTag=require("../internals/set-to-string-tag");var uid=require("../internals/uid");var wellKnownSymbol=require("../internals/well-known-symbol");var wrappedWellKnownSymbolModule=require("../internals/wrapped-well-known-symbol");var defineWellKnownSymbol=require("../internals/define-well-known-symbol");var enumKeys=require("../internals/enum-keys");var isArray=require("../internals/is-array");var anObject=require("../internals/an-object");var isObject=require("../internals/is-object");var toIndexedObject=require("../internals/to-indexed-object");var toPrimitive=require("../internals/to-primitive");var createPropertyDescriptor=require("../internals/create-property-descriptor");var nativeObjectCreate=require("../internals/object-create");var getOwnPropertyNamesExternal=require("../internals/object-get-own-property-names-external");var getOwnPropertyDescriptorModule=require("../internals/object-get-own-property-descriptor");var definePropertyModule=require("../internals/object-define-property");var propertyIsEnumerableModule=require("../internals/object-property-is-enumerable");var hide=require("../internals/hide");var objectKeys=require("../internals/object-keys");var HIDDEN=require("../internals/shared-key")("hidden");var InternalStateModule=require("../internals/internal-state");var SYMBOL="Symbol";var setInternalState=InternalStateModule.set;var getInternalState=InternalStateModule.getterFor(SYMBOL);var nativeGetOwnPropertyDescriptor=getOwnPropertyDescriptorModule.f;var nativeDefineProperty=definePropertyModule.f;var nativeGetOwnPropertyNames=getOwnPropertyNamesExternal.f;var $Symbol=global.Symbol;var JSON=global.JSON;var nativeJSONStringify=JSON&&JSON.stringify;var PROTOTYPE="prototype";var TO_PRIMITIVE=wellKnownSymbol("toPrimitive");var nativePropertyIsEnumerable=propertyIsEnumerableModule.f;var SymbolRegistry=shared("symbol-registry");var AllSymbols=shared("symbols");var ObjectPrototypeSymbols=shared("op-symbols");var WellKnownSymbolsStore=shared("wks");var ObjectPrototype=Object[PROTOTYPE];var QObject=global.QObject;var NATIVE_SYMBOL=require("../internals/native-symbol");var USE_SETTER=!QObject||!QObject[PROTOTYPE]||!QObject[PROTOTYPE].findChild;var setSymbolDescriptor=DESCRIPTORS&&fails(function(){return nativeObjectCreate(nativeDefineProperty({},"a",{get:function(){return nativeDefineProperty(this,"a",{value:7}).a}})).a!=7})?function(it,key,D){var ObjectPrototypeDescriptor=nativeGetOwnPropertyDescriptor(ObjectPrototype,key);if(ObjectPrototypeDescriptor)delete ObjectPrototype[key];nativeDefineProperty(it,key,D);if(ObjectPrototypeDescriptor&&it!==ObjectPrototype){nativeDefineProperty(ObjectPrototype,key,ObjectPrototypeDescriptor)}}:nativeDefineProperty;var wrap=function(tag,description){var symbol=AllSymbols[tag]=nativeObjectCreate($Symbol[PROTOTYPE]);setInternalState(symbol,{type:SYMBOL,tag:tag,description:description});if(!DESCRIPTORS)symbol.description=description;return symbol};var isSymbol=NATIVE_SYMBOL&&typeof $Symbol.iterator=="symbol"?function(it){return typeof it=="symbol"}:function(it){return Object(it)instanceof $Symbol};var $defineProperty=function defineProperty(it,key,D){if(it===ObjectPrototype)$defineProperty(ObjectPrototypeSymbols,key,D);anObject(it);key=toPrimitive(key,true);anObject(D);if(has(AllSymbols,key)){if(!D.enumerable){if(!has(it,HIDDEN))nativeDefineProperty(it,HIDDEN,createPropertyDescriptor(1,{}));it[HIDDEN][key]=true}else{if(has(it,HIDDEN)&&it[HIDDEN][key])it[HIDDEN][key]=false;D=nativeObjectCreate(D,{enumerable:createPropertyDescriptor(0,false)})}return setSymbolDescriptor(it,key,D)}return nativeDefineProperty(it,key,D)};var $defineProperties=function defineProperties(it,P){anObject(it);var keys=enumKeys(P=toIndexedObject(P));var i=0;var l=keys.length;var key;while(l>i)$defineProperty(it,key=keys[i++],P[key]);return it};var $create=function create(it,P){return P===undefined?nativeObjectCreate(it):$defineProperties(nativeObjectCreate(it),P)};var $propertyIsEnumerable=function propertyIsEnumerable(key){var E=nativePropertyIsEnumerable.call(this,key=toPrimitive(key,true));if(this===ObjectPrototype&&has(AllSymbols,key)&&!has(ObjectPrototypeSymbols,key))return false;return E||!has(this,key)||!has(AllSymbols,key)||has(this,HIDDEN)&&this[HIDDEN][key]?E:true};var $getOwnPropertyDescriptor=function getOwnPropertyDescriptor(it,key){it=toIndexedObject(it);key=toPrimitive(key,true);if(it===ObjectPrototype&&has(AllSymbols,key)&&!has(ObjectPrototypeSymbols,key))return;var D=nativeGetOwnPropertyDescriptor(it,key);if(D&&has(AllSymbols,key)&&!(has(it,HIDDEN)&&it[HIDDEN][key]))D.enumerable=true;return D};var $getOwnPropertyNames=function getOwnPropertyNames(it){var names=nativeGetOwnPropertyNames(toIndexedObject(it));var result=[];var i=0;var key;while(names.length>i){if(!has(AllSymbols,key=names[i++])&&!has(hiddenKeys,key))result.push(key)}return result};var $getOwnPropertySymbols=function getOwnPropertySymbols(it){var IS_OP=it===ObjectPrototype;var names=nativeGetOwnPropertyNames(IS_OP?ObjectPrototypeSymbols:toIndexedObject(it));var result=[];var i=0;var key;while(names.length>i){if(has(AllSymbols,key=names[i++])&&(IS_OP?has(ObjectPrototype,key):true))result.push(AllSymbols[key])}return result};if(!NATIVE_SYMBOL){$Symbol=function Symbol(){if(this instanceof $Symbol)throw TypeError("Symbol is not a constructor");var description=arguments[0]===undefined?undefined:String(arguments[0]);var tag=uid(description);var setter=function(value){if(this===ObjectPrototype)setter.call(ObjectPrototypeSymbols,value);if(has(this,HIDDEN)&&has(this[HIDDEN],tag))this[HIDDEN][tag]=false;setSymbolDescriptor(this,tag,createPropertyDescriptor(1,value))};if(DESCRIPTORS&&USE_SETTER)setSymbolDescriptor(ObjectPrototype,tag,{configurable:true,set:setter});return wrap(tag,description)};redefine($Symbol[PROTOTYPE],"toString",function toString(){return getInternalState(this).tag});propertyIsEnumerableModule.f=$propertyIsEnumerable;definePropertyModule.f=$defineProperty;getOwnPropertyDescriptorModule.f=$getOwnPropertyDescriptor;require("../internals/object-get-own-property-names").f=getOwnPropertyNamesExternal.f=$getOwnPropertyNames;require("../internals/object-get-own-property-symbols").f=$getOwnPropertySymbols;if(DESCRIPTORS){nativeDefineProperty($Symbol[PROTOTYPE],"description",{configurable:true,get:function description(){return getInternalState(this).description}});if(!IS_PURE){redefine(ObjectPrototype,"propertyIsEnumerable",$propertyIsEnumerable,{unsafe:true})}}wrappedWellKnownSymbolModule.f=function(name){return wrap(wellKnownSymbol(name),name)}}$export({global:true,wrap:true,forced:!NATIVE_SYMBOL,sham:!NATIVE_SYMBOL},{Symbol:$Symbol});for(var wellKnownSymbols=objectKeys(WellKnownSymbolsStore),k=0;wellKnownSymbols.length>k;){defineWellKnownSymbol(wellKnownSymbols[k++])}$export({target:SYMBOL,stat:true,forced:!NATIVE_SYMBOL},{for:function(key){return has(SymbolRegistry,key+="")?SymbolRegistry[key]:SymbolRegistry[key]=$Symbol(key)},keyFor:function keyFor(sym){if(!isSymbol(sym))throw TypeError(sym+" is not a symbol");for(var key in SymbolRegistry)if(SymbolRegistry[key]===sym)return key},useSetter:function(){USE_SETTER=true},useSimple:function(){USE_SETTER=false}});$export({target:"Object",stat:true,forced:!NATIVE_SYMBOL,sham:!DESCRIPTORS},{create:$create,defineProperty:$defineProperty,defineProperties:$defineProperties,getOwnPropertyDescriptor:$getOwnPropertyDescriptor});$export({target:"Object",stat:true,forced:!NATIVE_SYMBOL},{getOwnPropertyNames:$getOwnPropertyNames,getOwnPropertySymbols:$getOwnPropertySymbols});JSON&&$export({target:"JSON",stat:true,forced:!NATIVE_SYMBOL||fails(function(){var symbol=$Symbol();return nativeJSONStringify([symbol])!="[null]"||nativeJSONStringify({a:symbol})!="{}"||nativeJSONStringify(Object(symbol))!="{}"})},{stringify:function stringify(it){var args=[it];var i=1;var replacer,$replacer;while(arguments.length>i)args.push(arguments[i++]);$replacer=replacer=args[1];if(!isObject(replacer)&&it===undefined||isSymbol(it))return;if(!isArray(replacer))replacer=function(key,value){if(typeof $replacer=="function")value=$replacer.call(this,key,value);if(!isSymbol(value))return value};args[1]=replacer;return nativeJSONStringify.apply(JSON,args)}});if(!$Symbol[PROTOTYPE][TO_PRIMITIVE])hide($Symbol[PROTOTYPE],TO_PRIMITIVE,$Symbol[PROTOTYPE].valueOf);setToStringTag($Symbol,SYMBOL);hiddenKeys[HIDDEN]=true},{"../internals/an-object":55,"../internals/create-property-descriptor":67,"../internals/define-well-known-symbol":70,"../internals/descriptors":71,"../internals/enum-keys":76,"../internals/export":77,"../internals/fails":78,"../internals/global":80,"../internals/has":81,"../internals/hidden-keys":82,"../internals/hide":83,"../internals/internal-state":87,"../internals/is-array":88,"../internals/is-object":90,"../internals/is-pure":91,"../internals/native-symbol":95,"../internals/object-create":98,"../internals/object-define-property":100,"../internals/object-get-own-property-descriptor":101,"../internals/object-get-own-property-names":103,"../internals/object-get-own-property-names-external":102,"../internals/object-get-own-property-symbols":104,"../internals/object-keys":107,"../internals/object-property-is-enumerable":108,"../internals/redefine":113,"../internals/set-to-string-tag":116,"../internals/shared":118,"../internals/shared-key":117,"../internals/to-indexed-object":122,"../internals/to-primitive":126,"../internals/uid":127,"../internals/well-known-symbol":130,"../internals/wrapped-well-known-symbol":131}],149:[function(require,module,exports){require("../internals/define-well-known-symbol")("match")},{"../internals/define-well-known-symbol":70}],150:[function(require,module,exports){require("../internals/define-well-known-symbol")("replace")},{"../internals/define-well-known-symbol":70}],151:[function(require,module,exports){require("../internals/define-well-known-symbol")("search")},{"../internals/define-well-known-symbol":70}],152:[function(require,module,exports){require("../internals/define-well-known-symbol")("species")},{"../internals/define-well-known-symbol":70}],153:[function(require,module,exports){require("../internals/define-well-known-symbol")("split")},{"../internals/define-well-known-symbol":70}],154:[function(require,module,exports){require("../internals/define-well-known-symbol")("toPrimitive")},{"../internals/define-well-known-symbol":70}],155:[function(require,module,exports){require("../internals/define-well-known-symbol")("toStringTag")},{"../internals/define-well-known-symbol":70}],156:[function(require,module,exports){require("../internals/define-well-known-symbol")("unscopables")},{"../internals/define-well-known-symbol":70}],157:[function(require,module,exports){require("../internals/define-well-known-symbol")("dispose")},{"../internals/define-well-known-symbol":70}],158:[function(require,module,exports){require("../internals/define-well-known-symbol")("observable")},{"../internals/define-well-known-symbol":70}],159:[function(require,module,exports){require("../internals/define-well-known-symbol")("patternMatch")},{"../internals/define-well-known-symbol":70}],160:[function(require,module,exports){var DOMIterables=require("../internals/dom-iterables");var ArrayIteratorMethods=require("../modules/es.array.iterator");var global=require("../internals/global");var hide=require("../internals/hide");var wellKnownSymbol=require("../internals/well-known-symbol");var ITERATOR=wellKnownSymbol("iterator");var TO_STRING_TAG=wellKnownSymbol("toStringTag");var ArrayValues=ArrayIteratorMethods.values;for(var COLLECTION_NAME in DOMIterables){var Collection=global[COLLECTION_NAME];var CollectionPrototype=Collection&&Collection.prototype;if(CollectionPrototype){if(CollectionPrototype[ITERATOR]!==ArrayValues)try{hide(CollectionPrototype,ITERATOR,ArrayValues)}catch(e){CollectionPrototype[ITERATOR]=ArrayValues}if(!CollectionPrototype[TO_STRING_TAG])hide(CollectionPrototype,TO_STRING_TAG,COLLECTION_NAME);if(DOMIterables[COLLECTION_NAME])for(var METHOD_NAME in ArrayIteratorMethods){if(CollectionPrototype[METHOD_NAME]!==ArrayIteratorMethods[METHOD_NAME])try{hide(CollectionPrototype,METHOD_NAME,ArrayIteratorMethods[METHOD_NAME])}catch(e){CollectionPrototype[METHOD_NAME]=ArrayIteratorMethods[METHOD_NAME]}}}}},{"../internals/dom-iterables":73,"../internals/global":80,"../internals/hide":83,"../internals/well-known-symbol":130,"../modules/es.array.iterator":135}],161:[function(require,module,exports){(function(process,global){(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):global.ES6Promise=factory()})(this,function(){"use strict";function objectOrFunction(x){var type=typeof x;return x!==null&&(type==="object"||type==="function")}function isFunction(x){return typeof x==="function"}var _isArray=void 0;if(Array.isArray){_isArray=Array.isArray}else{_isArray=function(x){return Object.prototype.toString.call(x)==="[object Array]"}}var isArray=_isArray;var len=0;var vertxNext=void 0;var customSchedulerFn=void 0;var asap=function asap(callback,arg){queue[len]=callback;queue[len+1]=arg;len+=2;if(len===2){if(customSchedulerFn){customSchedulerFn(flush)}else{scheduleFlush()}}};function setScheduler(scheduleFn){customSchedulerFn=scheduleFn}function setAsap(asapFn){asap=asapFn}var browserWindow=typeof window!=="undefined"?window:undefined;var browserGlobal=browserWindow||{};var BrowserMutationObserver=browserGlobal.MutationObserver||browserGlobal.WebKitMutationObserver;var isNode=typeof self==="undefined"&&typeof process!=="undefined"&&{}.toString.call(process)==="[object process]";var isWorker=typeof Uint8ClampedArray!=="undefined"&&typeof importScripts!=="undefined"&&typeof MessageChannel!=="undefined";function useNextTick(){return function(){return process.nextTick(flush)}}function useVertxTimer(){if(typeof vertxNext!=="undefined"){return function(){vertxNext(flush)}}return useSetTimeout()}function useMutationObserver(){var iterations=0;var observer=new BrowserMutationObserver(flush);var node=document.createTextNode("");observer.observe(node,{characterData:true});return function(){node.data=iterations=++iterations%2}}function useMessageChannel(){var channel=new MessageChannel;channel.port1.onmessage=flush;return function(){return channel.port2.postMessage(0)}}function useSetTimeout(){var globalSetTimeout=setTimeout;return function(){return globalSetTimeout(flush,1)}}var queue=new Array(1e3);function flush(){for(var i=0;i<len;i+=2){var callback=queue[i];var arg=queue[i+1];callback(arg);queue[i]=undefined;queue[i+1]=undefined}len=0}function attemptVertx(){try{var vertx=Function("return this")().require("vertx");vertxNext=vertx.runOnLoop||vertx.runOnContext;return useVertxTimer()}catch(e){return useSetTimeout()}}var scheduleFlush=void 0;if(isNode){scheduleFlush=useNextTick()}else if(BrowserMutationObserver){scheduleFlush=useMutationObserver()}else if(isWorker){scheduleFlush=useMessageChannel()}else if(browserWindow===undefined&&typeof require==="function"){scheduleFlush=attemptVertx()}else{scheduleFlush=useSetTimeout()}function then(onFulfillment,onRejection){var parent=this;var child=new this.constructor(noop);if(child[PROMISE_ID]===undefined){makePromise(child)}var _state=parent._state;if(_state){var callback=arguments[_state-1];asap(function(){return invokeCallback(_state,child,callback,parent._result)})}else{subscribe(parent,child,onFulfillment,onRejection)}return child}function resolve$1(object){var Constructor=this;if(object&&typeof object==="object"&&object.constructor===Constructor){return object}var promise=new Constructor(noop);resolve(promise,object);return promise}var PROMISE_ID=Math.random().toString(36).substring(2);function noop(){}var PENDING=void 0;var FULFILLED=1;var REJECTED=2;var TRY_CATCH_ERROR={error:null};function selfFulfillment(){return new TypeError("You cannot resolve a promise with itself")}function cannotReturnOwn(){return new TypeError("A promises callback cannot return that same promise.")}function getThen(promise){try{return promise.then}catch(error){TRY_CATCH_ERROR.error=error;return TRY_CATCH_ERROR}}function tryThen(then$$1,value,fulfillmentHandler,rejectionHandler){try{then$$1.call(value,fulfillmentHandler,rejectionHandler)}catch(e){return e}}function handleForeignThenable(promise,thenable,then$$1){asap(function(promise){var sealed=false;var error=tryThen(then$$1,thenable,function(value){if(sealed){return}sealed=true;if(thenable!==value){resolve(promise,value)}else{fulfill(promise,value)}},function(reason){if(sealed){return}sealed=true;reject(promise,reason)},"Settle: "+(promise._label||" unknown promise"));if(!sealed&&error){sealed=true;reject(promise,error)}},promise)}function handleOwnThenable(promise,thenable){if(thenable._state===FULFILLED){fulfill(promise,thenable._result)}else if(thenable._state===REJECTED){reject(promise,thenable._result)}else{subscribe(thenable,undefined,function(value){return resolve(promise,value)},function(reason){return reject(promise,reason)})}}function handleMaybeThenable(promise,maybeThenable,then$$1){if(maybeThenable.constructor===promise.constructor&&then$$1===then&&maybeThenable.constructor.resolve===resolve$1){handleOwnThenable(promise,maybeThenable)}else{if(then$$1===TRY_CATCH_ERROR){reject(promise,TRY_CATCH_ERROR.error);TRY_CATCH_ERROR.error=null}else if(then$$1===undefined){fulfill(promise,maybeThenable)}else if(isFunction(then$$1)){handleForeignThenable(promise,maybeThenable,then$$1)}else{fulfill(promise,maybeThenable)}}}function resolve(promise,value){if(promise===value){reject(promise,selfFulfillment())}else if(objectOrFunction(value)){handleMaybeThenable(promise,value,getThen(value))}else{fulfill(promise,value)}}function publishRejection(promise){if(promise._onerror){promise._onerror(promise._result)}publish(promise)}function fulfill(promise,value){if(promise._state!==PENDING){return}promise._result=value;promise._state=FULFILLED;if(promise._subscribers.length!==0){asap(publish,promise)}}function reject(promise,reason){if(promise._state!==PENDING){return}promise._state=REJECTED;promise._result=reason;asap(publishRejection,promise)}function subscribe(parent,child,onFulfillment,onRejection){var _subscribers=parent._subscribers;var length=_subscribers.length;parent._onerror=null;_subscribers[length]=child;_subscribers[length+FULFILLED]=onFulfillment;_subscribers[length+REJECTED]=onRejection;if(length===0&&parent._state){asap(publish,parent)}}function publish(promise){var subscribers=promise._subscribers;var settled=promise._state;if(subscribers.length===0){return}var child=void 0,callback=void 0,detail=promise._result;for(var i=0;i<subscribers.length;i+=3){child=subscribers[i];callback=subscribers[i+settled];if(child){invokeCallback(settled,child,callback,detail)}else{callback(detail)}}promise._subscribers.length=0}function tryCatch(callback,detail){try{return callback(detail)}catch(e){TRY_CATCH_ERROR.error=e;return TRY_CATCH_ERROR}}function invokeCallback(settled,promise,callback,detail){var hasCallback=isFunction(callback),value=void 0,error=void 0,succeeded=void 0,failed=void 0;if(hasCallback){value=tryCatch(callback,detail);if(value===TRY_CATCH_ERROR){failed=true;error=value.error;value.error=null}else{succeeded=true}if(promise===value){reject(promise,cannotReturnOwn());return}}else{value=detail;succeeded=true}if(promise._state!==PENDING){}else if(hasCallback&&succeeded){resolve(promise,value)}else if(failed){reject(promise,error)}else if(settled===FULFILLED){fulfill(promise,value)}else if(settled===REJECTED){reject(promise,value)}}function initializePromise(promise,resolver){try{resolver(function resolvePromise(value){resolve(promise,value)},function rejectPromise(reason){reject(promise,reason)})}catch(e){reject(promise,e)}}var id=0;function nextId(){return id++}function makePromise(promise){promise[PROMISE_ID]=id++;promise._state=undefined;promise._result=undefined;promise._subscribers=[]}function validationError(){return new Error("Array Methods must be provided an Array")}var Enumerator=function(){function Enumerator(Constructor,input){this._instanceConstructor=Constructor;this.promise=new Constructor(noop);if(!this.promise[PROMISE_ID]){makePromise(this.promise)}if(isArray(input)){this.length=input.length;this._remaining=input.length;this._result=new Array(this.length);if(this.length===0){fulfill(this.promise,this._result)}else{this.length=this.length||0;this._enumerate(input);if(this._remaining===0){fulfill(this.promise,this._result)}}}else{reject(this.promise,validationError())}}Enumerator.prototype._enumerate=function _enumerate(input){for(var i=0;this._state===PENDING&&i<input.length;i++){this._eachEntry(input[i],i)}};Enumerator.prototype._eachEntry=function _eachEntry(entry,i){var c=this._instanceConstructor;var resolve$$1=c.resolve;if(resolve$$1===resolve$1){var _then=getThen(entry);if(_then===then&&entry._state!==PENDING){this._settledAt(entry._state,i,entry._result)}else if(typeof _then!=="function"){this._remaining--;this._result[i]=entry}else if(c===Promise$1){var promise=new c(noop);handleMaybeThenable(promise,entry,_then);this._willSettleAt(promise,i)}else{this._willSettleAt(new c(function(resolve$$1){return resolve$$1(entry)}),i)}}else{this._willSettleAt(resolve$$1(entry),i)}};Enumerator.prototype._settledAt=function _settledAt(state,i,value){var promise=this.promise;if(promise._state===PENDING){this._remaining--;if(state===REJECTED){reject(promise,value)}else{this._result[i]=value}}if(this._remaining===0){fulfill(promise,this._result)}};Enumerator.prototype._willSettleAt=function _willSettleAt(promise,i){var enumerator=this;subscribe(promise,undefined,function(value){return enumerator._settledAt(FULFILLED,i,value)},function(reason){return enumerator._settledAt(REJECTED,i,reason)})};return Enumerator}();function all(entries){return new Enumerator(this,entries).promise}function race(entries){var Constructor=this;if(!isArray(entries)){return new Constructor(function(_,reject){return reject(new TypeError("You must pass an array to race."))})}else{return new Constructor(function(resolve,reject){var length=entries.length;for(var i=0;i<length;i++){Constructor.resolve(entries[i]).then(resolve,reject)}})}}function reject$1(reason){var Constructor=this;var promise=new Constructor(noop);reject(promise,reason);return promise}function needsResolver(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function needsNew(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}var Promise$1=function(){function Promise(resolver){this[PROMISE_ID]=nextId();this._result=this._state=undefined;this._subscribers=[];if(noop!==resolver){typeof resolver!=="function"&&needsResolver();this instanceof Promise?initializePromise(this,resolver):needsNew()}}Promise.prototype.catch=function _catch(onRejection){return this.then(null,onRejection)};Promise.prototype.finally=function _finally(callback){var promise=this;var constructor=promise.constructor;if(isFunction(callback)){return promise.then(function(value){return constructor.resolve(callback()).then(function(){return value})},function(reason){return constructor.resolve(callback()).then(function(){throw reason})})}return promise.then(callback,callback)};return Promise}();Promise$1.prototype.then=then;Promise$1.all=all;Promise$1.race=race;Promise$1.resolve=resolve$1;Promise$1.reject=reject$1;Promise$1._setScheduler=setScheduler;Promise$1._setAsap=setAsap;Promise$1._asap=asap;function polyfill(){var local=void 0;if(typeof global!=="undefined"){local=global}else if(typeof self!=="undefined"){local=self}else{try{local=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}}var P=local.Promise;if(P){var promiseToString=null;try{promiseToString=Object.prototype.toString.call(P.resolve())}catch(e){}if(promiseToString==="[object Promise]"&&!P.cast){return}}local.Promise=Promise$1}Promise$1.polyfill=polyfill;Promise$1.Promise=Promise$1;return Promise$1})}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{_process:182}],162:[function(require,module,exports){var objectCreate=Object.create||objectCreatePolyfill;var objectKeys=Object.keys||objectKeysPolyfill;var bind=Function.prototype.bind||functionBindPolyfill;function EventEmitter(){if(!this._events||!Object.prototype.hasOwnProperty.call(this,"_events")){this._events=objectCreate(null);this._eventsCount=0}this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;var defaultMaxListeners=10;var hasDefineProperty;try{var o={};if(Object.defineProperty)Object.defineProperty(o,"x",{value:0});hasDefineProperty=o.x===0}catch(err){hasDefineProperty=false}if(hasDefineProperty){Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:true,get:function(){return defaultMaxListeners},set:function(arg){if(typeof arg!=="number"||arg<0||arg!==arg)throw new TypeError('"defaultMaxListeners" must be a positive number');defaultMaxListeners=arg}})}else{EventEmitter.defaultMaxListeners=defaultMaxListeners}EventEmitter.prototype.setMaxListeners=function setMaxListeners(n){if(typeof n!=="number"||n<0||isNaN(n))throw new TypeError('"n" argument must be a positive number');this._maxListeners=n;return this};function $getMaxListeners(that){if(that._maxListeners===undefined)return EventEmitter.defaultMaxListeners;return that._maxListeners}EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return $getMaxListeners(this)};function emitNone(handler,isFn,self){if(isFn)handler.call(self);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self)}}function emitOne(handler,isFn,self,arg1){if(isFn)handler.call(self,arg1);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1)}}function emitTwo(handler,isFn,self,arg1,arg2){if(isFn)handler.call(self,arg1,arg2);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1,arg2)}}function emitThree(handler,isFn,self,arg1,arg2,arg3){if(isFn)handler.call(self,arg1,arg2,arg3);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1,arg2,arg3)}}function emitMany(handler,isFn,self,args){if(isFn)handler.apply(self,args);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].apply(self,args)}}EventEmitter.prototype.emit=function emit(type){var er,handler,len,args,i,events;var doError=type==="error";events=this._events;if(events)doError=doError&&events.error==null;else if(!doError)return false;if(doError){if(arguments.length>1)er=arguments[1];if(er instanceof Error){throw er}else{var err=new Error('Unhandled "error" event. ('+er+")");err.context=er;throw err}return false}handler=events[type];if(!handler)return false;var isFn=typeof handler==="function";len=arguments.length;switch(len){case 1:emitNone(handler,isFn,this);break;case 2:emitOne(handler,isFn,this,arguments[1]);break;case 3:emitTwo(handler,isFn,this,arguments[1],arguments[2]);break;case 4:emitThree(handler,isFn,this,arguments[1],arguments[2],arguments[3]);break;default:args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];emitMany(handler,isFn,this,args)}return true};function _addListener(target,type,listener,prepend){var m;var events;var existing;if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');events=target._events;if(!events){events=target._events=objectCreate(null);target._eventsCount=0}else{if(events.newListener){target.emit("newListener",type,listener.listener?listener.listener:listener);events=target._events}existing=events[type]}if(!existing){existing=events[type]=listener;++target._eventsCount}else{if(typeof existing==="function"){existing=events[type]=prepend?[listener,existing]:[existing,listener]}else{if(prepend){existing.unshift(listener)}else{existing.push(listener)}}if(!existing.warned){m=$getMaxListeners(target);if(m&&m>0&&existing.length>m){existing.warned=true;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+' "'+String(type)+'" listeners '+"added. Use emitter.setMaxListeners() to "+"increase limit.");w.name="MaxListenersExceededWarning";w.emitter=target;w.type=type;w.count=existing.length;if(typeof console==="object"&&console.warn){console.warn("%s: %s",w.name,w.message)}}}}return target}EventEmitter.prototype.addListener=function addListener(type,listener){return _addListener(this,type,listener,false)};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.prependListener=function prependListener(type,listener){return _addListener(this,type,listener,true)};function onceWrapper(){if(!this.fired){this.target.removeListener(this.type,this.wrapFn);this.fired=true;switch(arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:var args=new Array(arguments.length);for(var i=0;i<args.length;++i)args[i]=arguments[i];this.listener.apply(this.target,args)}}}function _onceWrap(target,type,listener){var state={fired:false,wrapFn:undefined,target:target,type:type,listener:listener};var wrapped=bind.call(onceWrapper,state);wrapped.listener=listener;state.wrapFn=wrapped;return wrapped}EventEmitter.prototype.once=function once(type,listener){if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');this.on(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.prependOnceListener=function prependOnceListener(type,listener){if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');this.prependListener(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.removeListener=function removeListener(type,listener){var list,events,position,i,originalListener;if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');events=this._events;if(!events)return this;list=events[type];if(!list)return this;if(list===listener||list.listener===listener){if(--this._eventsCount===0)this._events=objectCreate(null);else{delete events[type];if(events.removeListener)this.emit("removeListener",type,list.listener||listener)}}else if(typeof list!=="function"){position=-1;for(i=list.length-1;i>=0;i--){if(list[i]===listener||list[i].listener===listener){originalListener=list[i].listener;position=i;break}}if(position<0)return this;if(position===0)list.shift();else spliceOne(list,position);if(list.length===1)events[type]=list[0];if(events.removeListener)this.emit("removeListener",type,originalListener||listener)}return this};EventEmitter.prototype.removeAllListeners=function removeAllListeners(type){var listeners,events,i;events=this._events;if(!events)return this;if(!events.removeListener){if(arguments.length===0){this._events=objectCreate(null);this._eventsCount=0}else if(events[type]){if(--this._eventsCount===0)this._events=objectCreate(null);else delete events[type]}return this}if(arguments.length===0){var keys=objectKeys(events);var key;for(i=0;i<keys.length;++i){key=keys[i];if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events=objectCreate(null);this._eventsCount=0;return this}listeners=events[type];if(typeof listeners==="function"){this.removeListener(type,listeners)}else if(listeners){for(i=listeners.length-1;i>=0;i--){this.removeListener(type,listeners[i])}}return this};function _listeners(target,type,unwrap){var events=target._events;if(!events)return[];var evlistener=events[type];if(!evlistener)return[];if(typeof evlistener==="function")return unwrap?[evlistener.listener||evlistener]:[evlistener];return unwrap?unwrapListeners(evlistener):arrayClone(evlistener,evlistener.length)}EventEmitter.prototype.listeners=function listeners(type){return _listeners(this,type,true)};EventEmitter.prototype.rawListeners=function rawListeners(type){return _listeners(this,type,false)};EventEmitter.listenerCount=function(emitter,type){if(typeof emitter.listenerCount==="function"){return emitter.listenerCount(type)}else{return listenerCount.call(emitter,type)}};EventEmitter.prototype.listenerCount=listenerCount;function listenerCount(type){var events=this._events;if(events){var evlistener=events[type];if(typeof evlistener==="function"){return 1}else if(evlistener){return evlistener.length}}return 0}EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};function spliceOne(list,index){for(var i=index,k=i+1,n=list.length;k<n;i+=1,k+=1)list[i]=list[k];list.pop()}function arrayClone(arr,n){var copy=new Array(n);for(var i=0;i<n;++i)copy[i]=arr[i];return copy}function unwrapListeners(arr){var ret=new Array(arr.length);for(var i=0;i<ret.length;++i){ret[i]=arr[i].listener||arr[i]}return ret}function objectCreatePolyfill(proto){var F=function(){};F.prototype=proto;return new F}function objectKeysPolyfill(obj){var keys=[];for(var k in obj)if(Object.prototype.hasOwnProperty.call(obj,k)){keys.push(k)}return k}function functionBindPolyfill(context){var fn=this;return function(){return fn.apply(context,arguments)}}},{}],163:[function(require,module,exports){"use strict";function _interopDefault(ex){return ex&&typeof ex==="object"&&"default"in ex?ex["default"]:ex}require("@firebase/polyfill");var firebase=_interopDefault(require("@firebase/app"));module.exports=firebase},{"@firebase/app":5,"@firebase/polyfill":9}],164:[function(require,module,exports){"use strict";require("@firebase/auth")},{"@firebase/auth":6}],165:[function(require,module,exports){"use strict";require("@firebase/firestore")},{"@firebase/firestore":7}],166:[function(require,module,exports){var hasOwn=Object.prototype.hasOwnProperty;var toString=Object.prototype.toString;module.exports=function forEach(obj,fn,ctx){if(toString.call(fn)!=="[object Function]"){throw new TypeError("iterator must be a function")}var l=obj.length;if(l===+l){for(var i=0;i<l;i++){fn.call(ctx,obj[i],i,obj)}}else{for(var k in obj){if(hasOwn.call(obj,k)){fn.call(ctx,obj[k],k,obj)}}}}},{}],167:[function(require,module,exports){"use strict";var Dms={};Dms.parseDMS=function(dmsStr){if(typeof dmsStr=="number"&&isFinite(dmsStr))return Number(dmsStr);var dms=String(dmsStr).trim().replace(/^-/,"").replace(/[NSEW]$/i,"").split(/[^0-9.,]+/);if(dms[dms.length-1]=="")dms.splice(dms.length-1);if(dms=="")return NaN;var deg;switch(dms.length){case 3:deg=dms[0]/1+dms[1]/60+dms[2]/3600;break;case 2:deg=dms[0]/1+dms[1]/60;break;case 1:deg=dms[0];break;default:return NaN}if(/^-|[WS]$/i.test(dmsStr.trim()))deg=-deg;return Number(deg)};Dms.separator="";Dms.toDMS=function(deg,format,dp){if(isNaN(deg))return null;if(format===undefined)format="dms";if(dp===undefined){switch(format){case"d":case"deg":dp=4;break;case"dm":case"deg+min":dp=2;break;case"dms":case"deg+min+sec":dp=0;break;default:format="dms";dp=0}}deg=Math.abs(deg);var dms,d,m,s;switch(format){default:case"d":case"deg":d=deg.toFixed(dp);if(d<100)d="0"+d;if(d<10)d="0"+d;dms=d+"°";break;case"dm":case"deg+min":d=Math.floor(deg);m=(deg*60%60).toFixed(dp);if(m==60){m=0;d++}d=("000"+d).slice(-3);if(m<10)m="0"+m;dms=d+"°"+Dms.separator+m+"′";break;case"dms":case"deg+min+sec":d=Math.floor(deg);m=Math.floor(deg*3600/60)%60;s=(deg*3600%60).toFixed(dp);if(s==60){s=(0).toFixed(dp);m++}if(m==60){m=0;d++}d=("000"+d).slice(-3);m=("00"+m).slice(-2);if(s<10)s="0"+s;dms=d+"°"+Dms.separator+m+"′"+Dms.separator+s+"″";break}return dms};Dms.toLat=function(deg,format,dp){var lat=Dms.toDMS(deg,format,dp);return lat===null?"–":lat.slice(1)+Dms.separator+(deg<0?"S":"N")};Dms.toLon=function(deg,format,dp){var lon=Dms.toDMS(deg,format,dp);return lon===null?"–":lon+Dms.separator+(deg<0?"W":"E")};Dms.toBrng=function(deg,format,dp){deg=(Number(deg)+360)%360;var brng=Dms.toDMS(deg,format,dp);return brng===null?"–":brng.replace("360","0")};Dms.compassPoint=function(bearing,precision){if(precision===undefined)precision=3;bearing=(bearing%360+360)%360;var cardinals=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];var n=4*Math.pow(2,precision-1);var cardinal=cardinals[Math.round(bearing*n/360)%n*16/n];return cardinal};if(typeof module!="undefined"&&module.exports)module.exports=Dms},{}],168:[function(require,module,exports){"use strict";if(typeof module!="undefined"&&module.exports)var Vector3d=require("./vector3d.js");if(typeof module!="undefined"&&module.exports)var Dms=require("./dms.js");function LatLon(lat,lon,datum){if(!(this instanceof LatLon))return new LatLon(lat,lon,datum);if(datum===undefined)datum=LatLon.datum.WGS84;this.lat=Number(lat);this.lon=Number(lon);this.datum=datum}LatLon.ellipsoid={WGS84:{a:6378137,b:6356752.314245,f:1/298.257223563},Airy1830:{a:6377563.396,b:6356256.909,f:1/299.3249646},AiryModified:{a:6377340.189,b:6356034.448,f:1/299.3249646},Bessel1841:{a:6377397.155,b:6356078.962818,f:1/299.1528128},Clarke1866:{a:6378206.4,b:6356583.8,f:1/294.978698214},Clarke1880IGN:{a:6378249.2,b:6356515,f:1/293.466021294},GRS80:{a:6378137,b:6356752.31414,f:1/298.257222101},Intl1924:{a:6378388,b:6356911.946,f:1/297},WGS72:{a:6378135,b:6356750.5,f:1/298.26}};LatLon.datum={ED50:{ellipsoid:LatLon.ellipsoid.Intl1924,transform:[89.5,93.8,123.1,-1.2,0,0,.156]},Irl1975:{ellipsoid:LatLon.ellipsoid.AiryModified,transform:[-482.53,130.596,-564.557,-8.15,-1.042,-.214,-.631]},NAD27:{ellipsoid:LatLon.ellipsoid.Clarke1866,transform:[8,-160,-176,0,0,0,0]},NAD83:{ellipsoid:LatLon.ellipsoid.GRS80,transform:[1.004,-1.91,-.515,-.0015,.0267,34e-5,.011]},NTF:{ellipsoid:LatLon.ellipsoid.Clarke1880IGN,transform:[168,60,-320,0,0,0,0]},OSGB36:{ellipsoid:LatLon.ellipsoid.Airy1830,transform:[-446.448,125.157,-542.06,20.4894,-.1502,-.247,-.8421]},Potsdam:{ellipsoid:LatLon.ellipsoid.Bessel1841,transform:[-582,-105,-414,-8.3,1.04,.35,-3.08]},TokyoJapan:{ellipsoid:LatLon.ellipsoid.Bessel1841,transform:[148,-507,-685,0,0,0,0]},WGS72:{ellipsoid:LatLon.ellipsoid.WGS72,transform:[0,0,-4.5,-.22,0,0,.554]},WGS84:{ellipsoid:LatLon.ellipsoid.WGS84,transform:[0,0,0,0,0,0,0]}};LatLon.prototype.convertDatum=function(toDatum){var oldLatLon=this;var transform=null;if(oldLatLon.datum==LatLon.datum.WGS84){transform=toDatum.transform}if(toDatum==LatLon.datum.WGS84){transform=[];for(var p=0;p<7;p++)transform[p]=-oldLatLon.datum.transform[p]}if(transform==null){oldLatLon=this.convertDatum(LatLon.datum.WGS84);transform=toDatum.transform}var oldCartesian=oldLatLon.toCartesian();var newCartesian=oldCartesian.applyTransform(transform);var newLatLon=newCartesian.toLatLonE(toDatum);return newLatLon};LatLon.prototype.toCartesian=function(){var φ=this.lat.toRadians(),λ=this.lon.toRadians();var h=0;var a=this.datum.ellipsoid.a,f=this.datum.ellipsoid.f;var sinφ=Math.sin(φ),cosφ=Math.cos(φ);var sinλ=Math.sin(λ),cosλ=Math.cos(λ);var eSq=2*f-f*f;var ν=a/Math.sqrt(1-eSq*sinφ*sinφ);var x=(ν+h)*cosφ*cosλ;var y=(ν+h)*cosφ*sinλ;var z=(ν*(1-eSq)+h)*sinφ;var point=new Vector3d(x,y,z);return point};Vector3d.prototype.toLatLonE=function(datum){var x=this.x,y=this.y,z=this.z;var a=datum.ellipsoid.a,b=datum.ellipsoid.b,f=datum.ellipsoid.f;var e2=2*f-f*f;var ε2=e2/(1-e2);var p=Math.sqrt(x*x+y*y);var R=Math.sqrt(p*p+z*z);var tanβ=b*z/(a*p)*(1+ε2*b/R);var sinβ=tanβ/Math.sqrt(1+tanβ*tanβ);var cosβ=sinβ/tanβ;var φ=isNaN(cosβ)?0:Math.atan2(z+ε2*b*sinβ*sinβ*sinβ,p-e2*a*cosβ*cosβ*cosβ);var λ=Math.atan2(y,x);var sinφ=Math.sin(φ),cosφ=Math.cos(φ);var ν=a/Math.sqrt(1-e2*sinφ*sinφ);var h=p*cosφ+z*sinφ-a*a/ν;var point=new LatLon(φ.toDegrees(),λ.toDegrees(),datum);return point};Vector3d.prototype.applyTransform=function(t){var x1=this.x,y1=this.y,z1=this.z;var tx=t[0];var ty=t[1];var tz=t[2];var s1=t[3]/1e6+1;var rx=(t[4]/3600).toRadians();var ry=(t[5]/3600).toRadians();var rz=(t[6]/3600).toRadians();var x2=tx+x1*s1-y1*rz+z1*ry;var y2=ty+x1*rz+y1*s1-z1*rx;var z2=tz-x1*ry+y1*rx+z1*s1;return new Vector3d(x2,y2,z2)};LatLon.prototype.toString=function(format,dp){return Dms.toLat(this.lat,format,dp)+", "+Dms.toLon(this.lon,format,dp)};if(Number.prototype.toRadians===undefined){Number.prototype.toRadians=function(){return this*Math.PI/180}}if(Number.prototype.toDegrees===undefined){Number.prototype.toDegrees=function(){return this*180/Math.PI}}if(typeof module!="undefined"&&module.exports)module.exports=LatLon,module.exports.Vector3d=Vector3d},{"./dms.js":167,"./vector3d.js":176}],169:[function(require,module,exports){"use strict";if(typeof module!="undefined"&&module.exports)var Dms=require("./dms.js");function LatLon(lat,lon){if(!(this instanceof LatLon))return new LatLon(lat,lon);this.lat=Number(lat);this.lon=Number(lon)}LatLon.prototype.distanceTo=function(point,radius){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");radius=radius===undefined?6371e3:Number(radius);var R=radius;var φ1=this.lat.toRadians(),λ1=this.lon.toRadians();var φ2=point.lat.toRadians(),λ2=point.lon.toRadians();var Δφ=φ2-φ1;var Δλ=λ2-λ1;var a=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var d=R*c;return d};LatLon.prototype.bearingTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var φ1=this.lat.toRadians(),φ2=point.lat.toRadians();var Δλ=(point.lon-this.lon).toRadians();var y=Math.sin(Δλ)*Math.cos(φ2);var x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);var θ=Math.atan2(y,x);return(θ.toDegrees()+360)%360};LatLon.prototype.finalBearingTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");return(point.bearingTo(this)+180)%360};LatLon.prototype.midpointTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var φ1=this.lat.toRadians(),λ1=this.lon.toRadians();var φ2=point.lat.toRadians();var Δλ=(point.lon-this.lon).toRadians();var Bx=Math.cos(φ2)*Math.cos(Δλ);var By=Math.cos(φ2)*Math.sin(Δλ);var x=Math.sqrt((Math.cos(φ1)+Bx)*(Math.cos(φ1)+Bx)+By*By);var y=Math.sin(φ1)+Math.sin(φ2);var φ3=Math.atan2(y,x);var λ3=λ1+Math.atan2(By,Math.cos(φ1)+Bx);return new LatLon(φ3.toDegrees(),(λ3.toDegrees()+540)%360-180)};LatLon.prototype.intermediatePointTo=function(point,fraction){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var φ1=this.lat.toRadians(),λ1=this.lon.toRadians();var φ2=point.lat.toRadians(),λ2=point.lon.toRadians();var sinφ1=Math.sin(φ1),cosφ1=Math.cos(φ1),sinλ1=Math.sin(λ1),cosλ1=Math.cos(λ1);var sinφ2=Math.sin(φ2),cosφ2=Math.cos(φ2),sinλ2=Math.sin(λ2),cosλ2=Math.cos(λ2);var Δφ=φ2-φ1;var Δλ=λ2-λ1;var a=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);var δ=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var A=Math.sin((1-fraction)*δ)/Math.sin(δ);var B=Math.sin(fraction*δ)/Math.sin(δ);var x=A*cosφ1*cosλ1+B*cosφ2*cosλ2;var y=A*cosφ1*sinλ1+B*cosφ2*sinλ2;var z=A*sinφ1+B*sinφ2;var φ3=Math.atan2(z,Math.sqrt(x*x+y*y));var λ3=Math.atan2(y,x);return new LatLon(φ3.toDegrees(),(λ3.toDegrees()+540)%360-180)};LatLon.prototype.destinationPoint=function(distance,bearing,radius){radius=radius===undefined?6371e3:radius;var δ=Number(distance)/Number(radius);var θ=Number(bearing).toRadians();var φ1=this.lat.toRadians();var λ1=this.lon.toRadians();var sinφ1=Math.sin(φ1),cosφ1=Math.cos(φ1);var sinδ=Math.sin(δ),cosδ=Math.cos(δ);var sinθ=Math.sin(θ),cosθ=Math.cos(θ);var sinφ2=sinφ1*cosδ+cosφ1*sinδ*cosθ;var φ2=Math.asin(sinφ2);var y=sinθ*sinδ*cosφ1;var x=cosδ-sinφ1*sinφ2;var λ2=λ1+Math.atan2(y,x);return new LatLon(φ2.toDegrees(),(λ2.toDegrees()+540)%360-180)};LatLon.intersection=function(p1,brng1,p2,brng2){if(!(p1 instanceof LatLon))throw new TypeError("p1 is not LatLon object");if(!(p2 instanceof LatLon))throw new TypeError("p2 is not LatLon object");var φ1=p1.lat.toRadians(),λ1=p1.lon.toRadians();var φ2=p2.lat.toRadians(),λ2=p2.lon.toRadians();var θ13=Number(brng1).toRadians(),θ23=Number(brng2).toRadians();var Δφ=φ2-φ1,Δλ=λ2-λ1;var δ12=2*Math.asin(Math.sqrt(Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2)));if(δ12==0)return null;var θa=Math.acos((Math.sin(φ2)-Math.sin(φ1)*Math.cos(δ12))/(Math.sin(δ12)*Math.cos(φ1)));if(isNaN(θa))θa=0;var θb=Math.acos((Math.sin(φ1)-Math.sin(φ2)*Math.cos(δ12))/(Math.sin(δ12)*Math.cos(φ2)));var θ12=Math.sin(λ2-λ1)>0?θa:2*Math.PI-θa;var θ21=Math.sin(λ2-λ1)>0?2*Math.PI-θb:θb;var α1=θ13-θ12;var α2=θ21-θ23;if(Math.sin(α1)==0&&Math.sin(α2)==0)return null;if(Math.sin(α1)*Math.sin(α2)<0)return null;var cosα3=-Math.cos(α1)*Math.cos(α2)+Math.sin(α1)*Math.sin(α2)*Math.cos(δ12);var δ13=Math.atan2(Math.sin(δ12)*Math.sin(α1)*Math.sin(α2),Math.cos(α2)+Math.cos(α1)*cosα3);var φ3=Math.asin(Math.sin(φ1)*Math.cos(δ13)+Math.cos(φ1)*Math.sin(δ13)*Math.cos(θ13));var Δλ13=Math.atan2(Math.sin(θ13)*Math.sin(δ13)*Math.cos(φ1),Math.cos(δ13)-Math.sin(φ1)*Math.sin(φ3));var λ3=λ1+Δλ13;return new LatLon(φ3.toDegrees(),(λ3.toDegrees()+540)%360-180)};LatLon.prototype.crossTrackDistanceTo=function(pathStart,pathEnd,radius){if(!(pathStart instanceof LatLon))throw new TypeError("‘pathStart’ is not LatLon object");if(!(pathEnd instanceof LatLon))throw new TypeError("‘pathEnd’ is not LatLon object");var R=radius===undefined?6371e3:Number(radius);var δ13=pathStart.distanceTo(this,R)/R;var θ13=pathStart.bearingTo(this).toRadians();var θ12=pathStart.bearingTo(pathEnd).toRadians();var δxt=Math.asin(Math.sin(δ13)*Math.sin(θ13-θ12));return δxt*R};LatLon.prototype.alongTrackDistanceTo=function(pathStart,pathEnd,radius){if(!(pathStart instanceof LatLon))throw new TypeError("‘pathStart’ is not LatLon object");if(!(pathEnd instanceof LatLon))throw new TypeError("‘pathEnd’ is not LatLon object");var R=radius===undefined?6371e3:radius;var δ13=pathStart.distanceTo(this,R)/R;var θ13=pathStart.bearingTo(this).toRadians();var θ12=pathStart.bearingTo(pathEnd).toRadians();var δxt=Math.asin(Math.sin(δ13)*Math.sin(θ13-θ12));var δat=Math.acos(Math.cos(δ13)/Math.abs(Math.cos(δxt)));return δat*Math.sign(Math.cos(θ12-θ13))*R};LatLon.prototype.maxLatitude=function(bearing){var θ=Number(bearing).toRadians();var φ=this.lat.toRadians();var φMax=Math.acos(Math.abs(Math.sin(θ)*Math.cos(φ)));return φMax.toDegrees()};LatLon.crossingParallels=function(point1,point2,latitude){var φ=Number(latitude).toRadians();var φ1=point1.lat.toRadians();var λ1=point1.lon.toRadians();var φ2=point2.lat.toRadians();var λ2=point2.lon.toRadians();var Δλ=λ2-λ1;var x=Math.sin(φ1)*Math.cos(φ2)*Math.cos(φ)*Math.sin(Δλ);var y=Math.sin(φ1)*Math.cos(φ2)*Math.cos(φ)*Math.cos(Δλ)-Math.cos(φ1)*Math.sin(φ2)*Math.cos(φ);var z=Math.cos(φ1)*Math.cos(φ2)*Math.sin(φ)*Math.sin(Δλ);if(z*z>x*x+y*y)return null;var λm=Math.atan2(-y,x);var Δλi=Math.acos(z/Math.sqrt(x*x+y*y));var λi1=λ1+λm-Δλi;var λi2=λ1+λm+Δλi;return{lon1:(λi1.toDegrees()+540)%360-180,lon2:(λi2.toDegrees()+540)%360-180}};LatLon.prototype.rhumbDistanceTo=function(point,radius){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");radius=radius===undefined?6371e3:Number(radius);var R=radius;var φ1=this.lat.toRadians(),φ2=point.lat.toRadians();var Δφ=φ2-φ1;var Δλ=Math.abs(point.lon-this.lon).toRadians();if(Δλ>Math.PI)Δλ-=2*Math.PI;var Δψ=Math.log(Math.tan(φ2/2+Math.PI/4)/Math.tan(φ1/2+Math.PI/4));var q=Math.abs(Δψ)>1e-11?Δφ/Δψ:Math.cos(φ1);var δ=Math.sqrt(Δφ*Δφ+q*q*Δλ*Δλ);var dist=δ*R;return dist};LatLon.prototype.rhumbBearingTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var φ1=this.lat.toRadians(),φ2=point.lat.toRadians();var Δλ=(point.lon-this.lon).toRadians();if(Δλ>Math.PI)Δλ-=2*Math.PI;if(Δλ<-Math.PI)Δλ+=2*Math.PI;var Δψ=Math.log(Math.tan(φ2/2+Math.PI/4)/Math.tan(φ1/2+Math.PI/4));var θ=Math.atan2(Δλ,Δψ);return(θ.toDegrees()+360)%360};LatLon.prototype.rhumbDestinationPoint=function(distance,bearing,radius){radius=radius===undefined?6371e3:radius;var φ1=this.lat.toRadians(),λ1=this.lon.toRadians();var θ=Number(bearing).toRadians();var δ=distance/radius;var Δφ=δ*Math.cos(θ);var φ2=φ1+Δφ;if(Math.abs(φ2)>Math.PI/2)φ2=φ2>0?Math.PI-φ2:-Math.PI-φ2;var Δψ=Math.log(Math.tan(φ2/2+Math.PI/4)/Math.tan(φ1/2+Math.PI/4));var q=Math.abs(Δψ)>1e-11?Δφ/Δψ:Math.cos(φ1);var Δλ=δ*Math.sin(θ)/q;var λ2=λ1+Δλ;return new LatLon(φ2.toDegrees(),(λ2.toDegrees()+540)%360-180)};LatLon.prototype.rhumbMidpointTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var φ1=this.lat.toRadians(),λ1=this.lon.toRadians();var φ2=point.lat.toRadians(),λ2=point.lon.toRadians();if(Math.abs(λ2-λ1)>Math.PI)λ1+=2*Math.PI;var φ3=(φ1+φ2)/2;var f1=Math.tan(Math.PI/4+φ1/2);var f2=Math.tan(Math.PI/4+φ2/2);var f3=Math.tan(Math.PI/4+φ3/2);var λ3=((λ2-λ1)*Math.log(f3)+λ1*Math.log(f2)-λ2*Math.log(f1))/Math.log(f2/f1);if(!isFinite(λ3))λ3=(λ1+λ2)/2;var p=LatLon(φ3.toDegrees(),(λ3.toDegrees()+540)%360-180);return p};LatLon.areaOf=function(polygon,radius){var R=radius===undefined?6371e3:Number(radius);var closed=polygon[0].equals(polygon[polygon.length-1]);if(!closed)polygon.push(polygon[0]);var nVertices=polygon.length-1;var S=0;for(var v=0;v<nVertices;v++){var φ1=polygon[v].lat.toRadians();var φ2=polygon[v+1].lat.toRadians();var Δλ=(polygon[v+1].lon-polygon[v].lon).toRadians();var E=2*Math.atan2(Math.tan(Δλ/2)*(Math.tan(φ1/2)+Math.tan(φ2/2)),1+Math.tan(φ1/2)*Math.tan(φ2/2));S+=E}if(isPoleEnclosedBy(polygon))S=Math.abs(S)-2*Math.PI;var A=Math.abs(S*R*R);if(!closed)polygon.pop();return A;function isPoleEnclosedBy(polygon){var ΣΔ=0;var prevBrng=polygon[0].bearingTo(polygon[1]);for(var v=0;v<polygon.length-1;v++){var initBrng=polygon[v].bearingTo(polygon[v+1]);var finalBrng=polygon[v].finalBearingTo(polygon[v+1]);ΣΔ+=(initBrng-prevBrng+540)%360-180;ΣΔ+=(finalBrng-initBrng+540)%360-180;prevBrng=finalBrng}var initBrng=polygon[0].bearingTo(polygon[1]);ΣΔ+=(initBrng-prevBrng+540)%360-180;var enclosed=Math.abs(ΣΔ)<90;return enclosed}};LatLon.prototype.equals=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");if(this.lat!=point.lat)return false;if(this.lon!=point.lon)return false;return true};LatLon.prototype.toString=function(format,dp){return Dms.toLat(this.lat,format,dp)+", "+Dms.toLon(this.lon,format,dp)};if(Number.prototype.toRadians===undefined){Number.prototype.toRadians=function(){return this*Math.PI/180}}if(Number.prototype.toDegrees===undefined){Number.prototype.toDegrees=function(){return this*180/Math.PI}}if(typeof module!="undefined"&&module.exports)module.exports=LatLon},{"./dms.js":167}],170:[function(require,module,exports){"use strict";if(typeof module!="undefined"&&module.exports)var Vector3d=require("./vector3d.js");if(typeof module!="undefined"&&module.exports)var Dms=require("./dms.js");function LatLon(lat,lon){if(!(this instanceof LatLon))return new LatLon(lat,lon);this.lat=Number(lat);this.lon=Number(lon)}LatLon.prototype.toVector=function(){var φ=this.lat.toRadians();var λ=this.lon.toRadians();var x=Math.cos(φ)*Math.cos(λ);var y=Math.cos(φ)*Math.sin(λ);var z=Math.sin(φ);return new Vector3d(x,y,z)};Vector3d.prototype.toLatLonS=function(){var φ=Math.atan2(this.z,Math.sqrt(this.x*this.x+this.y*this.y));var λ=Math.atan2(this.y,this.x);return new LatLon(φ.toDegrees(),λ.toDegrees())};LatLon.prototype.greatCircle=function(bearing){var φ=this.lat.toRadians();var λ=this.lon.toRadians();var θ=Number(bearing).toRadians();var x=Math.sin(λ)*Math.cos(θ)-Math.sin(φ)*Math.cos(λ)*Math.sin(θ);var y=-Math.cos(λ)*Math.cos(θ)-Math.sin(φ)*Math.sin(λ)*Math.sin(θ);var z=Math.cos(φ)*Math.sin(θ);return new Vector3d(x,y,z)};Vector3d.prototype.greatCircle=function(bearing){var θ=Number(bearing).toRadians();var N=new Vector3d(0,0,1);var e=N.cross(this);var n=this.cross(e);var eʹ=e.times(Math.cos(θ)/e.length());var nʹ=n.times(Math.sin(θ)/n.length());var c=nʹ.minus(eʹ);return c};LatLon.prototype.distanceTo=function(point,radius){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");radius=radius===undefined?6371e3:Number(radius);var p1=this.toVector();var p2=point.toVector();var δ=p1.angleTo(p2);var d=δ*radius;return d};LatLon.prototype.bearingTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var p1=this.toVector();var p2=point.toVector();var N=new Vector3d(0,0,1);var c1=p1.cross(p2);var c2=p1.cross(N);var θ=c1.angleTo(c2,p1);return(θ.toDegrees()+360)%360};LatLon.prototype.midpointTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var p1=this.toVector();var p2=point.toVector();var mid=p1.plus(p2).unit();return mid.toLatLonS()};LatLon.prototype.intermediatePointTo=function(point,fraction){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var n1=this.toVector();var n2=point.toVector();var sinθ=n1.cross(n2).length();var cosθ=n1.dot(n2);var δ=Math.atan2(sinθ,cosθ);var δi=δ*Number(fraction);var sinδi=Math.sin(δi);var cosδi=Math.cos(δi);var d=n1.cross(n2).unit().cross(n1);var int=n1.times(cosδi).plus(d.times(sinδi));return new Vector3d(int.x,int.y,int.z).toLatLonS()};LatLon.prototype.intermediatePointOnChordTo=function(point,fraction){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");var n1=this.toVector();var n2=point.toVector();var int=n1.plus(n2.minus(n1).times(Number(fraction)));return new Vector3d(int.x,int.y,int.z).toLatLonS()};LatLon.prototype.destinationPoint=function(distance,bearing,radius){radius=radius===undefined?6371e3:Number(radius);var n1=this.toVector();var δ=Number(distance)/radius;var θ=Number(bearing).toRadians();var N=new Vector3d(0,0,1);var de=N.cross(n1).unit();var dn=n1.cross(de);var deSinθ=de.times(Math.sin(θ));var dnCosθ=dn.times(Math.cos(θ));var d=dnCosθ.plus(deSinθ);var x=n1.times(Math.cos(δ));var y=d.times(Math.sin(δ));var n2=x.plus(y);return n2.toLatLonS()};LatLon.intersection=function(path1start,path1brngEnd,path2start,path2brngEnd){if(!(path1start instanceof LatLon))throw new TypeError("path1start is not LatLon object");if(!(path2start instanceof LatLon))throw new TypeError("path2start is not LatLon object");if(!(path1brngEnd instanceof LatLon)&&isNaN(path1brngEnd))throw new TypeError("path1brngEnd is not LatLon object or bearing");if(!(path2brngEnd instanceof LatLon)&&isNaN(path2brngEnd))throw new TypeError("path2brngEnd is not LatLon object or bearing");var p1=path1start.toVector();var p2=path2start.toVector();var c1,c2,path1def,path2def;if(path1brngEnd instanceof LatLon){c1=p1.cross(path1brngEnd.toVector());path1def="endpoint"}else{c1=path1start.greatCircle(Number(path1brngEnd));path1def="bearing"}if(path2brngEnd instanceof LatLon){c2=p2.cross(path2brngEnd.toVector());path2def="endpoint"}else{c2=path2start.greatCircle(Number(path2brngEnd));path2def="bearing"}var i1=c1.cross(c2);var i2=c2.cross(c1);var intersection=null,dir1=null,dir2=null;switch(path1def+"+"+path2def){case"bearing+bearing":dir1=Math.sign(c1.cross(p1).dot(i1));dir2=Math.sign(c2.cross(p2).dot(i1));switch(dir1+dir2){case 2:intersection=i1;break;case-2:intersection=i2;break;case 0:intersection=p1.plus(p2).dot(i1)>0?i2:i1;break}break;case"bearing+endpoint":dir1=Math.sign(c1.cross(p1).dot(i1));intersection=dir1>0?i1:i2;break;case"endpoint+bearing":dir2=Math.sign(c2.cross(p2).dot(i1));intersection=dir2>0?i1:i2;break;case"endpoint+endpoint":var mid=p1.plus(p2).plus(path1brngEnd.toVector()).plus(path2brngEnd.toVector());intersection=mid.dot(i1)>0?i1:i2;break}return intersection.toLatLonS()};LatLon.prototype.crossTrackDistanceTo=function(pathStart,pathBrngEnd,radius){if(!(pathStart instanceof LatLon))throw new TypeError("pathStart is not LatLon object");var R=radius===undefined?6371e3:Number(radius);var p=this.toVector();var gc=pathBrngEnd instanceof LatLon?pathStart.toVector().cross(pathBrngEnd.toVector()):pathStart.greatCircle(Number(pathBrngEnd));var α=gc.angleTo(p)-Math.PI/2;var d=α*R;return d};LatLon.prototype.alongTrackDistanceTo=function(pathStart,pathBrngEnd,radius){if(!(pathStart instanceof LatLon))throw new TypeError("pathStart is not LatLon object");var R=radius===undefined?6371e3:Number(radius);var p=this.toVector();var gc=pathBrngEnd instanceof LatLon?pathStart.toVector().cross(pathBrngEnd.toVector()):pathStart.greatCircle(Number(pathBrngEnd));var pat=gc.cross(p).cross(gc);var α=pathStart.toVector().angleTo(pat,gc);var d=α*R;return d};LatLon.prototype.nearestPointOnSegment=function(point1,point2){var p=null;if(this.isBetween(point1,point2)){var n0=this.toVector(),n1=point1.toVector(),n2=point2.toVector();var c1=n1.cross(n2);var c2=n0.cross(c1);var n=c1.cross(c2);p=n.toLatLonS()}else{var d1=this.distanceTo(point1);var d2=this.distanceTo(point2);p=d1<d2?point1:point2}return p};LatLon.prototype.isBetween=function(point1,point2){var n0=this.toVector(),n1=point1.toVector(),n2=point2.toVector();var δ10=n0.minus(n1),δ12=n2.minus(n1);var δ20=n0.minus(n2),δ21=n1.minus(n2);var extent1=δ10.dot(δ12);var extent2=δ20.dot(δ21);var isBetween=extent1>=0&&extent2>=0;var isSameHemisphere=n0.dot(n1)>=0&&n0.dot(n2)>=0;return isBetween&&isSameHemisphere};LatLon.prototype.enclosedBy=function(polygon){var closed=polygon[0].equals(polygon[polygon.length-1]);if(!closed)polygon.push(polygon[0]);var nVertices=polygon.length-1;var p=this.toVector();var vectorToVertex=[];for(var v=0;v<nVertices;v++)vectorToVertex[v]=p.minus(polygon[v].toVector());vectorToVertex.push(vectorToVertex[0]);var Σθ=0;for(var v=0;v<nVertices;v++){Σθ+=vectorToVertex[v].angleTo(vectorToVertex[v+1],p)}var enclosed=Math.abs(Σθ)>Math.PI;if(!closed)polygon.pop();return enclosed};LatLon.areaOf=function(polygon,radius){var R=radius==undefined?6371e3:Number(radius);var closed=polygon[0].equals(polygon[polygon.length-1]);if(!closed)polygon.push(polygon[0]);var n=polygon.length-1;var c=[];for(var v=0;v<n;v++){var i=polygon[v].toVector();var j=polygon[v+1].toVector();c[v]=i.cross(j)}c.push(c[0]);var n1=polygon[0].toVector();var Σα=0;for(var v=0;v<n;v++)Σα+=c[v].angleTo(c[v+1],n1);var Σθ=n*Math.PI-Math.abs(Σα);var E=Σθ-(n-2)*Math.PI;var A=E*R*R;if(!closed)polygon.pop();return A};LatLon.meanOf=function(points){var m=new Vector3d(0,0,0);for(var p=0;p<points.length;p++){m=m.plus(points[p].toVector())}return m.unit().toLatLonS()};LatLon.prototype.equals=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");if(this.lat!=point.lat)return false;if(this.lon!=point.lon)return false;return true};LatLon.prototype.toString=function(format,dp){return Dms.toLat(this.lat,format,dp)+", "+Dms.toLon(this.lon,format,dp)};if(Number.prototype.toRadians===undefined){Number.prototype.toRadians=function(){return this*Math.PI/180}}if(Number.prototype.toDegrees===undefined){Number.prototype.toDegrees=function(){return this*180/Math.PI}}if(Math.sign===undefined){Math.sign=function(x){x=+x;if(x===0||isNaN(x))return x;return x>0?1:-1}}if(typeof module!="undefined"&&module.exports)module.exports=LatLon,module.exports.Vector3d=Vector3d},{"./dms.js":167,"./vector3d.js":176}],171:[function(require,module,exports){"use strict";if(typeof module!="undefined"&&module.exports)var LatLon=require("./latlon-ellipsoidal.js");LatLon.prototype.distanceTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");try{return Number(this.inverse(point).distance.toFixed(3))}catch(e){return NaN}};LatLon.prototype.initialBearingTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");try{return Number(this.inverse(point).initialBearing.toFixed(9))}catch(e){return NaN}};LatLon.prototype.finalBearingTo=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");try{return Number(this.inverse(point).finalBearing.toFixed(9))}catch(e){return NaN}};LatLon.prototype.destinationPoint=function(distance,initialBearing){return this.direct(Number(distance),Number(initialBearing)).point};LatLon.prototype.finalBearingOn=function(distance,initialBearing){return Number(this.direct(Number(distance),Number(initialBearing)).finalBearing.toFixed(9))};LatLon.prototype.direct=function(distance,initialBearing){var φ1=this.lat.toRadians(),λ1=this.lon.toRadians();var α1=initialBearing.toRadians();var s=distance;var a=this.datum.ellipsoid.a,b=this.datum.ellipsoid.b,f=this.datum.ellipsoid.f;var sinα1=Math.sin(α1);var cosα1=Math.cos(α1);var tanU1=(1-f)*Math.tan(φ1),cosU1=1/Math.sqrt(1+tanU1*tanU1),sinU1=tanU1*cosU1;var σ1=Math.atan2(tanU1,cosα1);var sinα=cosU1*sinα1;var cosSqα=1-sinα*sinα;var uSq=cosSqα*(a*a-b*b)/(b*b);var A=1+uSq/16384*(4096+uSq*(-768+uSq*(320-175*uSq)));var B=uSq/1024*(256+uSq*(-128+uSq*(74-47*uSq)));var cos2σM,sinσ,cosσ,Δσ;var σ=s/(b*A),σʹ,iterations=0;do{cos2σM=Math.cos(2*σ1+σ);sinσ=Math.sin(σ);cosσ=Math.cos(σ);Δσ=B*sinσ*(cos2σM+B/4*(cosσ*(-1+2*cos2σM*cos2σM)-B/6*cos2σM*(-3+4*sinσ*sinσ)*(-3+4*cos2σM*cos2σM)));σʹ=σ;σ=s/(b*A)+Δσ}while(Math.abs(σ-σʹ)>1e-12&&++iterations<100);if(iterations>=100)throw new Error("Formula failed to converge");var x=sinU1*sinσ-cosU1*cosσ*cosα1;var φ2=Math.atan2(sinU1*cosσ+cosU1*sinσ*cosα1,(1-f)*Math.sqrt(sinα*sinα+x*x));var λ=Math.atan2(sinσ*sinα1,cosU1*cosσ-sinU1*sinσ*cosα1);var C=f/16*cosSqα*(4+f*(4-3*cosSqα));var L=λ-(1-C)*f*sinα*(σ+C*sinσ*(cos2σM+C*cosσ*(-1+2*cos2σM*cos2σM)));var λ2=(λ1+L+3*Math.PI)%(2*Math.PI)-Math.PI;var α2=Math.atan2(sinα,-x);α2=(α2+2*Math.PI)%(2*Math.PI);return{point:new LatLon(φ2.toDegrees(),λ2.toDegrees(),this.datum),finalBearing:α2.toDegrees(),iterations:iterations}};LatLon.prototype.inverse=function(point){var p1=this,p2=point;if(p1.lon==-180)p1.lon=180;var φ1=p1.lat.toRadians(),λ1=p1.lon.toRadians();var φ2=p2.lat.toRadians(),λ2=p2.lon.toRadians();var a=this.datum.ellipsoid.a,b=this.datum.ellipsoid.b,f=this.datum.ellipsoid.f;var L=λ2-λ1;var tanU1=(1-f)*Math.tan(φ1),cosU1=1/Math.sqrt(1+tanU1*tanU1),sinU1=tanU1*cosU1;var tanU2=(1-f)*Math.tan(φ2),cosU2=1/Math.sqrt(1+tanU2*tanU2),sinU2=tanU2*cosU2;var sinλ,cosλ,sinSqσ,sinσ=0,cosσ=0,σ=0,sinα,cosSqα=0,cos2σM=0,C;var λ=L,λʹ,iterations=0,antimeridian=Math.abs(L)>Math.PI;do{sinλ=Math.sin(λ);cosλ=Math.cos(λ);sinSqσ=cosU2*sinλ*(cosU2*sinλ)+(cosU1*sinU2-sinU1*cosU2*cosλ)*(cosU1*sinU2-sinU1*cosU2*cosλ);if(sinSqσ==0)break;sinσ=Math.sqrt(sinSqσ);cosσ=sinU1*sinU2+cosU1*cosU2*cosλ;σ=Math.atan2(sinσ,cosσ);sinα=cosU1*cosU2*sinλ/sinσ;cosSqα=1-sinα*sinα;cos2σM=cosSqα!=0?cosσ-2*sinU1*sinU2/cosSqα:0;C=f/16*cosSqα*(4+f*(4-3*cosSqα));λʹ=λ;λ=L+(1-C)*f*sinα*(σ+C*sinσ*(cos2σM+C*cosσ*(-1+2*cos2σM*cos2σM)));var iterationCheck=antimeridian?Math.abs(λ)-Math.PI:Math.abs(λ);if(iterationCheck>Math.PI)throw new Error("λ > π")}while(Math.abs(λ-λʹ)>1e-12&&++iterations<1e3);if(iterations>=1e3)throw new Error("Formula failed to converge");var uSq=cosSqα*(a*a-b*b)/(b*b);var A=1+uSq/16384*(4096+uSq*(-768+uSq*(320-175*uSq)));var B=uSq/1024*(256+uSq*(-128+uSq*(74-47*uSq)));var Δσ=B*sinσ*(cos2σM+B/4*(cosσ*(-1+2*cos2σM*cos2σM)-B/6*cos2σM*(-3+4*sinσ*sinσ)*(-3+4*cos2σM*cos2σM)));var s=b*A*(σ-Δσ);var α1=Math.atan2(cosU2*sinλ,cosU1*sinU2-sinU1*cosU2*cosλ);var α2=Math.atan2(cosU1*sinλ,-sinU1*cosU2+cosU1*sinU2*cosλ);α1=(α1+2*Math.PI)%(2*Math.PI);α2=(α2+2*Math.PI)%(2*Math.PI);return{distance:s,initialBearing:s==0?NaN:α1.toDegrees(),finalBearing:s==0?NaN:α2.toDegrees(),iterations:iterations}};if(Number.prototype.toRadians===undefined){Number.prototype.toRadians=function(){return this*Math.PI/180}}if(Number.prototype.toDegrees===undefined){Number.prototype.toDegrees=function(){return this*180/Math.PI}}if(typeof module!="undefined"&&module.exports)module.exports=LatLon},{"./latlon-ellipsoidal.js":168}],172:[function(require,module,exports){"use strict";if(typeof module!="undefined"&&module.exports)var Utm=require("./utm.js");if(typeof module!="undefined"&&module.exports)var LatLon=require("./latlon-ellipsoidal.js");Mgrs.latBands="CDEFGHJKLMNPQRSTUVWXX";Mgrs.e100kLetters=["ABCDEFGH","JKLMNPQR","STUVWXYZ"];Mgrs.n100kLetters=["ABCDEFGHJKLMNPQRSTUV","FGHJKLMNPQRSTUVABCDE"];function Mgrs(zone,band,e100k,n100k,easting,northing,datum){if(!(this instanceof Mgrs))return new Mgrs(zone,band,e100k,n100k,easting,northing,datum);if(datum===undefined)datum=LatLon.datum.WGS84;if(!(1<=zone&&zone<=60))throw new Error("Invalid MGRS grid reference (zone ‘"+zone+"’)");if(band.length!=1)throw new Error("Invalid MGRS grid reference (band ‘"+band+"’)");if(Mgrs.latBands.indexOf(band)==-1)throw new Error("Invalid MGRS grid reference (band ‘"+band+"’)");if(e100k.length!=1)throw new Error("Invalid MGRS grid reference (e100k ‘"+e100k+"’)");if(n100k.length!=1)throw new Error("Invalid MGRS grid reference (n100k ‘"+n100k+"’)");this.zone=Number(zone);this.band=band;this.e100k=e100k;this.n100k=n100k;this.easting=Number(easting);this.northing=Number(northing);this.datum=datum}Utm.prototype.toMgrs=function(){if(isNaN(this.zone+this.easting+this.northing))throw new Error("Invalid UTM coordinate ‘"+this.toString()+"’");var zone=this.zone;var latlong=this.toLatLonE();var band=Mgrs.latBands.charAt(Math.floor(latlong.lat/8+10));var col=Math.floor(this.easting/1e5);var e100k=Mgrs.e100kLetters[(zone-1)%3].charAt(col-1);var row=Math.floor(this.northing/1e5)%20;var n100k=Mgrs.n100kLetters[(zone-1)%2].charAt(row);var easting=this.easting%1e5;var northing=this.northing%1e5;easting=Number(easting.toFixed(6));northing=Number(northing.toFixed(6));return new Mgrs(zone,band,e100k,n100k,easting,northing)};Mgrs.prototype.toUtm=function(){var zone=this.zone;var band=this.band;var e100k=this.e100k;var n100k=this.n100k;var easting=this.easting;var northing=this.northing;var hemisphere=band>="N"?"N":"S";var col=Mgrs.e100kLetters[(zone-1)%3].indexOf(e100k)+1;var e100kNum=col*1e5;var row=Mgrs.n100kLetters[(zone-1)%2].indexOf(n100k);var n100kNum=row*1e5;var latBand=(Mgrs.latBands.indexOf(band)-10)*8;var nBand=Math.floor(new LatLon(latBand,0).toUtm().northing/1e5)*1e5;var n2M=0;while(n2M+n100kNum+northing<nBand)n2M+=2e6;return new Utm(zone,hemisphere,e100kNum+easting,n2M+n100kNum+northing,this.datum)};Mgrs.parse=function(mgrsGridRef){mgrsGridRef=mgrsGridRef.trim();if(!mgrsGridRef.match(/\s/)){var en=mgrsGridRef.slice(5);en=en.slice(0,en.length/2)+" "+en.slice(-en.length/2);mgrsGridRef=mgrsGridRef.slice(0,3)+" "+mgrsGridRef.slice(3,5)+" "+en}mgrsGridRef=mgrsGridRef.match(/\S+/g);if(mgrsGridRef==null||mgrsGridRef.length!=4)throw new Error("Invalid MGRS grid reference ‘"+mgrsGridRef+"’");var gzd=mgrsGridRef[0];var zone=gzd.slice(0,2);var band=gzd.slice(2,3);var en100k=mgrsGridRef[1];var e100k=en100k.slice(0,1);var n100k=en100k.slice(1,2);var e=mgrsGridRef[2],n=mgrsGridRef[3];e=e.length>=5?e:(e+"00000").slice(0,5);n=n.length>=5?n:(n+"00000").slice(0,5);return new Mgrs(zone,band,e100k,n100k,e,n)};Mgrs.prototype.toString=function(digits){digits=digits===undefined?10:Number(digits);if([2,4,6,8,10].indexOf(digits)==-1)throw new Error("Invalid precision ‘"+digits+"’");var zone=("00"+this.zone).slice(-2);var band=this.band;var e100k=this.e100k;var n100k=this.n100k;var eRounded=Math.floor(this.easting/Math.pow(10,5-digits/2));var nRounded=Math.floor(this.northing/Math.pow(10,5-digits/2));var easting=("00000"+eRounded).slice(-digits/2);var northing=("00000"+nRounded).slice(-digits/2);return zone+band+" "+e100k+n100k+" "+easting+" "+northing};if(typeof module!="undefined"&&module.exports)module.exports=Mgrs},{"./latlon-ellipsoidal.js":168,"./utm.js":175}],173:[function(require,module,exports){"use strict";exports.LatLonSpherical=require("./latlon-spherical.js");exports.LatLonEllipsoidal=require("./latlon-ellipsoidal.js");var V=require("./latlon-vincenty.js");for(var prop in V)exports.LatLonEllipsoidal[prop]=V[prop];exports.LatLonVectors=require("./latlon-vectors.js");exports.Vector3d=require("./vector3d.js");exports.Utm=require("./utm.js");exports.Mgrs=require("./mgrs.js");exports.OsGridRef=require("./osgridref.js");exports.Dms=require("./dms.js")},{"./dms.js":167,"./latlon-ellipsoidal.js":168,"./latlon-spherical.js":169,"./latlon-vectors.js":170,"./latlon-vincenty.js":171,"./mgrs.js":172,"./osgridref.js":174,"./utm.js":175,"./vector3d.js":176}],174:[function(require,module,exports){"use strict";if(typeof module!="undefined"&&module.exports)var LatLon=require("./latlon-ellipsoidal.js");function OsGridRef(easting,northing){if(!(this instanceof OsGridRef))return new OsGridRef(easting,northing);this.easting=Number(easting);this.northing=Number(northing)}OsGridRef.latLonToOsGrid=function(point){if(!(point instanceof LatLon))throw new TypeError("point is not LatLon object");if(point.datum!=LatLon.datum.OSGB36)point=point.convertDatum(LatLon.datum.OSGB36);var φ=point.lat.toRadians();var λ=point.lon.toRadians();var a=6377563.396,b=6356256.909;var F0=.9996012717;var φ0=49..toRadians(),λ0=(-2).toRadians();var N0=-1e5,E0=4e5;var e2=1-b*b/(a*a);var n=(a-b)/(a+b),n2=n*n,n3=n*n*n;var cosφ=Math.cos(φ),sinφ=Math.sin(φ);var ν=a*F0/Math.sqrt(1-e2*sinφ*sinφ);var ρ=a*F0*(1-e2)/Math.pow(1-e2*sinφ*sinφ,1.5);var η2=ν/ρ-1;var Ma=(1+n+5/4*n2+5/4*n3)*(φ-φ0);var Mb=(3*n+3*n*n+21/8*n3)*Math.sin(φ-φ0)*Math.cos(φ+φ0);var Mc=(15/8*n2+15/8*n3)*Math.sin(2*(φ-φ0))*Math.cos(2*(φ+φ0));var Md=35/24*n3*Math.sin(3*(φ-φ0))*Math.cos(3*(φ+φ0));var M=b*F0*(Ma-Mb+Mc-Md);var cos3φ=cosφ*cosφ*cosφ;var cos5φ=cos3φ*cosφ*cosφ;var tan2φ=Math.tan(φ)*Math.tan(φ);var tan4φ=tan2φ*tan2φ;var I=M+N0;var II=ν/2*sinφ*cosφ;var III=ν/24*sinφ*cos3φ*(5-tan2φ+9*η2);var IIIA=ν/720*sinφ*cos5φ*(61-58*tan2φ+tan4φ);var IV=ν*cosφ;var V=ν/6*cos3φ*(ν/ρ-tan2φ);var VI=ν/120*cos5φ*(5-18*tan2φ+tan4φ+14*η2-58*tan2φ*η2);var Δλ=λ-λ0;var Δλ2=Δλ*Δλ,Δλ3=Δλ2*Δλ,Δλ4=Δλ3*Δλ,Δλ5=Δλ4*Δλ,Δλ6=Δλ5*Δλ;var N=I+II*Δλ2+III*Δλ4+IIIA*Δλ6;var E=E0+IV*Δλ+V*Δλ3+VI*Δλ5;N=Number(N.toFixed(3));E=Number(E.toFixed(3));return new OsGridRef(E,N)};OsGridRef.osGridToLatLon=function(gridref,datum){if(!(gridref instanceof OsGridRef))throw new TypeError("gridref is not OsGridRef object");if(datum===undefined)datum=LatLon.datum.WGS84;var E=gridref.easting;var N=gridref.northing;var a=6377563.396,b=6356256.909;var F0=.9996012717;var φ0=49..toRadians(),λ0=(-2).toRadians();var N0=-1e5,E0=4e5;var e2=1-b*b/(a*a);var n=(a-b)/(a+b),n2=n*n,n3=n*n*n;var φ=φ0,M=0;do{φ=(N-N0-M)/(a*F0)+φ;var Ma=(1+n+5/4*n2+5/4*n3)*(φ-φ0);var Mb=(3*n+3*n*n+21/8*n3)*Math.sin(φ-φ0)*Math.cos(φ+φ0);var Mc=(15/8*n2+15/8*n3)*Math.sin(2*(φ-φ0))*Math.cos(2*(φ+φ0));var Md=35/24*n3*Math.sin(3*(φ-φ0))*Math.cos(3*(φ+φ0));M=b*F0*(Ma-Mb+Mc-Md)}while(N-N0-M>=1e-5);var cosφ=Math.cos(φ),sinφ=Math.sin(φ);var ν=a*F0/Math.sqrt(1-e2*sinφ*sinφ);var ρ=a*F0*(1-e2)/Math.pow(1-e2*sinφ*sinφ,1.5);var η2=ν/ρ-1;var tanφ=Math.tan(φ);var tan2φ=tanφ*tanφ,tan4φ=tan2φ*tan2φ,tan6φ=tan4φ*tan2φ;var secφ=1/cosφ;var ν3=ν*ν*ν,ν5=ν3*ν*ν,ν7=ν5*ν*ν;var VII=tanφ/(2*ρ*ν);var VIII=tanφ/(24*ρ*ν3)*(5+3*tan2φ+η2-9*tan2φ*η2);var IX=tanφ/(720*ρ*ν5)*(61+90*tan2φ+45*tan4φ);var X=secφ/ν;var XI=secφ/(6*ν3)*(ν/ρ+2*tan2φ);var XII=secφ/(120*ν5)*(5+28*tan2φ+24*tan4φ);var XIIA=secφ/(5040*ν7)*(61+662*tan2φ+1320*tan4φ+720*tan6φ);var dE=E-E0,dE2=dE*dE,dE3=dE2*dE,dE4=dE2*dE2,dE5=dE3*dE2,dE6=dE4*dE2,dE7=dE5*dE2;φ=φ-VII*dE2+VIII*dE4-IX*dE6;var λ=λ0+X*dE-XI*dE3+XII*dE5-XIIA*dE7;var point=new LatLon(φ.toDegrees(),λ.toDegrees(),LatLon.datum.OSGB36);if(datum!=LatLon.datum.OSGB36)point=point.convertDatum(datum);return point};OsGridRef.parse=function(gridref){gridref=String(gridref).trim();var match=gridref.match(/^(\d+),\s*(\d+)$/);if(match)return new OsGridRef(match[1],match[2]);match=gridref.match(/^[A-Z]{2}\s*[0-9]+\s*[0-9]+$/i);if(!match)throw new Error("Invalid grid reference");var l1=gridref.toUpperCase().charCodeAt(0)-"A".charCodeAt(0);var l2=gridref.toUpperCase().charCodeAt(1)-"A".charCodeAt(0);if(l1>7)l1--;if(l2>7)l2--;var e100km=(l1-2)%5*5+l2%5;var n100km=19-Math.floor(l1/5)*5-Math.floor(l2/5);var en=gridref.slice(2).trim().split(/\s+/);if(en.length==1)en=[en[0].slice(0,en[0].length/2),en[0].slice(en[0].length/2)];if(e100km<0||e100km>6||n100km<0||n100km>12)throw new Error("Invalid grid reference");if(en.length!=2)throw new Error("Invalid grid reference");if(en[0].length!=en[1].length)throw new Error("Invalid grid reference");en[0]=(en[0]+"00000").slice(0,5);en[1]=(en[1]+"00000").slice(0,5);var e=e100km+en[0];var n=n100km+en[1];return new OsGridRef(e,n)};OsGridRef.prototype.toString=function(digits){digits=digits===undefined?10:Number(digits);if(isNaN(digits)||digits%2!=0||digits>16)throw new RangeError("Invalid precision ‘"+digits+"’");var e=this.easting;var n=this.northing;if(isNaN(e)||isNaN(n))throw new Error("Invalid grid reference");if(digits==0){var eInt=Math.floor(e),eDec=e-eInt;var nInt=Math.floor(n),nDec=n-nInt;var ePad=("000000"+eInt).slice(-6)+(eDec>0?eDec.toFixed(3).slice(1):"");var nPad=(nInt<1e6?("000000"+nInt).slice(-6):nInt)+(nDec>0?nDec.toFixed(3).slice(1):"");return ePad+","+nPad}var e100k=Math.floor(e/1e5),n100k=Math.floor(n/1e5);if(e100k<0||e100k>6||n100k<0||n100k>12)return"";var l1=19-n100k-(19-n100k)%5+Math.floor((e100k+10)/5);var l2=(19-n100k)*5%25+e100k%5;if(l1>7)l1++;if(l2>7)l2++;var letterPair=String.fromCharCode(l1+"A".charCodeAt(0),l2+"A".charCodeAt(0));e=Math.floor(e%1e5/Math.pow(10,5-digits/2));n=Math.floor(n%1e5/Math.pow(10,5-digits/2));e=("00000000"+e).slice(-digits/2);n=("00000000"+n).slice(-digits/2);return letterPair+" "+e+" "+n};if(typeof module!="undefined"&&module.exports)module.exports=OsGridRef},{"./latlon-ellipsoidal.js":168}],175:[function(require,module,exports){"use strict";if(typeof module!="undefined"&&module.exports)var LatLon=require("./latlon-ellipsoidal.js");function Utm(zone,hemisphere,easting,northing,datum,convergence,scale){if(!(this instanceof Utm)){return new Utm(zone,hemisphere,easting,northing,datum,convergence,scale)}if(datum===undefined)datum=LatLon.datum.WGS84;if(convergence===undefined)convergence=null;if(scale===undefined)scale=null;if(!(1<=zone&&zone<=60))throw new Error("Invalid UTM zone "+zone);if(!hemisphere.match(/[NS]/i))throw new Error("Invalid UTM hemisphere "+hemisphere);this.zone=Number(zone);this.hemisphere=hemisphere.toUpperCase();this.easting=Number(easting);this.northing=Number(northing);this.datum=datum;this.convergence=convergence===null?null:Number(convergence);this.scale=scale===null?null:Number(scale)}LatLon.prototype.toUtm=function(){if(isNaN(this.lat)||isNaN(this.lon))throw new Error("Invalid point");if(!(-80<=this.lat&&this.lat<=84))throw new Error("Outside UTM limits");var falseEasting=5e5,falseNorthing=1e7;var zone=Math.floor((this.lon+180)/6)+1;var λ0=((zone-1)*6-180+3).toRadians();var mgrsLatBands="CDEFGHJKLMNPQRSTUVWXX";var latBand=mgrsLatBands.charAt(Math.floor(this.lat/8+10));if(zone==31&&latBand=="V"&&this.lon>=3){zone++;λ0+=6..toRadians()}if(zone==32&&latBand=="X"&&this.lon<9){zone--;λ0-=6..toRadians()}if(zone==32&&latBand=="X"&&this.lon>=9){zone++;λ0+=6..toRadians()}if(zone==34&&latBand=="X"&&this.lon<21){zone--;λ0-=6..toRadians()}if(zone==34&&latBand=="X"&&this.lon>=21){zone++;λ0+=6..toRadians()}if(zone==36&&latBand=="X"&&this.lon<33){zone--;λ0-=6..toRadians()}if(zone==36&&latBand=="X"&&this.lon>=33){zone++;λ0+=6..toRadians()}var φ=this.lat.toRadians();var λ=this.lon.toRadians()-λ0;var a=this.datum.ellipsoid.a,f=this.datum.ellipsoid.f;var k0=.9996;var e=Math.sqrt(f*(2-f));var n=f/(2-f);var n2=n*n,n3=n*n2,n4=n*n3,n5=n*n4,n6=n*n5;var cosλ=Math.cos(λ),sinλ=Math.sin(λ),tanλ=Math.tan(λ);var τ=Math.tan(φ);var σ=Math.sinh(e*Math.atanh(e*τ/Math.sqrt(1+τ*τ)));var τʹ=τ*Math.sqrt(1+σ*σ)-σ*Math.sqrt(1+τ*τ);var ξʹ=Math.atan2(τʹ,cosλ);var ηʹ=Math.asinh(sinλ/Math.sqrt(τʹ*τʹ+cosλ*cosλ));var A=a/(1+n)*(1+1/4*n2+1/64*n4+1/256*n6);var α=[null,1/2*n-2/3*n2+5/16*n3+41/180*n4-127/288*n5+7891/37800*n6,13/48*n2-3/5*n3+557/1440*n4+281/630*n5-1983433/1935360*n6,61/240*n3-103/140*n4+15061/26880*n5+167603/181440*n6,49561/161280*n4-179/168*n5+6601661/7257600*n6,34729/80640*n5-3418889/1995840*n6,212378941/319334400*n6];var ξ=ξʹ;for(var j=1;j<=6;j++)ξ+=α[j]*Math.sin(2*j*ξʹ)*Math.cosh(2*j*ηʹ);var η=ηʹ;for(var j=1;j<=6;j++)η+=α[j]*Math.cos(2*j*ξʹ)*Math.sinh(2*j*ηʹ);var x=k0*A*η;var y=k0*A*ξ;var pʹ=1;for(var j=1;j<=6;j++)pʹ+=2*j*α[j]*Math.cos(2*j*ξʹ)*Math.cosh(2*j*ηʹ);var qʹ=0;for(var j=1;j<=6;j++)qʹ+=2*j*α[j]*Math.sin(2*j*ξʹ)*Math.sinh(2*j*ηʹ);var γʹ=Math.atan(τʹ/Math.sqrt(1+τʹ*τʹ)*tanλ);var γʺ=Math.atan2(qʹ,pʹ);var γ=γʹ+γʺ;var sinφ=Math.sin(φ);var kʹ=Math.sqrt(1-e*e*sinφ*sinφ)*Math.sqrt(1+τ*τ)/Math.sqrt(τʹ*τʹ+cosλ*cosλ);var kʺ=A/a*Math.sqrt(pʹ*pʹ+qʹ*qʹ);var k=k0*kʹ*kʺ;x=x+falseEasting;if(y<0)y=y+falseNorthing;x=Number(x.toFixed(6));y=Number(y.toFixed(6));var convergence=Number(γ.toDegrees().toFixed(9));var scale=Number(k.toFixed(12));var h=this.lat>=0?"N":"S";return new Utm(zone,h,x,y,this.datum,convergence,scale)};Utm.prototype.toLatLonE=function(){var z=this.zone;var h=this.hemisphere;var x=this.easting;var y=this.northing;if(isNaN(z)||isNaN(x)||isNaN(y))throw new Error("Invalid coordinate");var falseEasting=5e5,falseNorthing=1e7;var a=this.datum.ellipsoid.a,f=this.datum.ellipsoid.f;var k0=.9996;x=x-falseEasting;y=h=="S"?y-falseNorthing:y;var e=Math.sqrt(f*(2-f));var n=f/(2-f);var n2=n*n,n3=n*n2,n4=n*n3,n5=n*n4,n6=n*n5;var A=a/(1+n)*(1+1/4*n2+1/64*n4+1/256*n6);var η=x/(k0*A);var ξ=y/(k0*A);var β=[null,1/2*n-2/3*n2+37/96*n3-1/360*n4-81/512*n5+96199/604800*n6,1/48*n2+1/15*n3-437/1440*n4+46/105*n5-1118711/3870720*n6,17/480*n3-37/840*n4-209/4480*n5+5569/90720*n6,4397/161280*n4-11/504*n5-830251/7257600*n6,4583/161280*n5-108847/3991680*n6,20648693/638668800*n6];var ξʹ=ξ;for(var j=1;j<=6;j++)ξʹ-=β[j]*Math.sin(2*j*ξ)*Math.cosh(2*j*η);var ηʹ=η;for(var j=1;j<=6;j++)ηʹ-=β[j]*Math.cos(2*j*ξ)*Math.sinh(2*j*η);var sinhηʹ=Math.sinh(ηʹ);var sinξʹ=Math.sin(ξʹ),cosξʹ=Math.cos(ξʹ);var τʹ=sinξʹ/Math.sqrt(sinhηʹ*sinhηʹ+cosξʹ*cosξʹ);var τi=τʹ;do{var σi=Math.sinh(e*Math.atanh(e*τi/Math.sqrt(1+τi*τi)));var τiʹ=τi*Math.sqrt(1+σi*σi)-σi*Math.sqrt(1+τi*τi);var δτi=(τʹ-τiʹ)/Math.sqrt(1+τiʹ*τiʹ)*(1+(1-e*e)*τi*τi)/((1-e*e)*Math.sqrt(1+τi*τi));τi+=δτi}while(Math.abs(δτi)>1e-12);var τ=τi;var φ=Math.atan(τ);var λ=Math.atan2(sinhηʹ,cosξʹ);var p=1;for(var j=1;j<=6;j++)p-=2*j*β[j]*Math.cos(2*j*ξ)*Math.cosh(2*j*η);var q=0;for(var j=1;j<=6;j++)q+=2*j*β[j]*Math.sin(2*j*ξ)*Math.sinh(2*j*η);var γʹ=Math.atan(Math.tan(ξʹ)*Math.tanh(ηʹ));var γʺ=Math.atan2(q,p);var γ=γʹ+γʺ;var sinφ=Math.sin(φ);var kʹ=Math.sqrt(1-e*e*sinφ*sinφ)*Math.sqrt(1+τ*τ)*Math.sqrt(sinhηʹ*sinhηʹ+cosξʹ*cosξʹ);var kʺ=A/a/Math.sqrt(p*p+q*q);var k=k0*kʹ*kʺ;var λ0=((z-1)*6-180+3).toRadians();λ+=λ0;var lat=Number(φ.toDegrees().toFixed(11));var lon=Number(λ.toDegrees().toFixed(11));var convergence=Number(γ.toDegrees().toFixed(9));var scale=Number(k.toFixed(12));var latLong=new LatLon(lat,lon,this.datum);latLong.convergence=convergence;latLong.scale=scale;return latLong};Utm.parse=function(utmCoord,datum){if(datum===undefined)datum=LatLon.datum.WGS84;utmCoord=utmCoord.trim().match(/\S+/g);if(utmCoord==null||utmCoord.length!=4)throw new Error("Invalid UTM coordinate ‘"+utmCoord+"’");var zone=utmCoord[0],hemisphere=utmCoord[1],easting=utmCoord[2],northing=utmCoord[3];return new Utm(zone,hemisphere,easting,northing,datum)};Utm.prototype.toString=function(digits){digits=Number(digits||0);var z=this.zone<10?"0"+this.zone:this.zone;var h=this.hemisphere;var e=this.easting;var n=this.northing;if(isNaN(z)||!h.match(/[NS]/)||isNaN(e)||isNaN(n))return"";return z+" "+h+" "+e.toFixed(digits)+" "+n.toFixed(digits)};if(Math.sinh===undefined){Math.sinh=function(x){return(Math.exp(x)-Math.exp(-x))/2}}if(Math.cosh===undefined){Math.cosh=function(x){return(Math.exp(x)+Math.exp(-x))/2}}if(Math.tanh===undefined){Math.tanh=function(x){return(Math.exp(x)-Math.exp(-x))/(Math.exp(x)+Math.exp(-x))}}if(Math.asinh===undefined){Math.asinh=function(x){return Math.log(x+Math.sqrt(1+x*x))}}if(Math.atanh===undefined){Math.atanh=function(x){return Math.log((1+x)/(1-x))/2}}if(typeof module!="undefined"&&module.exports)module.exports=Utm},{"./latlon-ellipsoidal.js":168}],176:[function(require,module,exports){"use strict";function Vector3d(x,y,z){if(!(this instanceof Vector3d))return new Vector3d(x,y,z);this.x=Number(x);this.y=Number(y);this.z=Number(z)}Vector3d.prototype.plus=function(v){if(!(v instanceof Vector3d))throw new TypeError("v is not Vector3d object");return new Vector3d(this.x+v.x,this.y+v.y,this.z+v.z)};Vector3d.prototype.minus=function(v){if(!(v instanceof Vector3d))throw new TypeError("v is not Vector3d object");return new Vector3d(this.x-v.x,this.y-v.y,this.z-v.z)};Vector3d.prototype.times=function(x){x=Number(x);return new Vector3d(this.x*x,this.y*x,this.z*x)};Vector3d.prototype.dividedBy=function(x){x=Number(x);return new Vector3d(this.x/x,this.y/x,this.z/x)};Vector3d.prototype.dot=function(v){if(!(v instanceof Vector3d))throw new TypeError("v is not Vector3d object");return this.x*v.x+this.y*v.y+this.z*v.z};Vector3d.prototype.cross=function(v){if(!(v instanceof Vector3d))throw new TypeError("v is not Vector3d object");var x=this.y*v.z-this.z*v.y;var y=this.z*v.x-this.x*v.z;var z=this.x*v.y-this.y*v.x;return new Vector3d(x,y,z)};Vector3d.prototype.negate=function(){return new Vector3d(-this.x,-this.y,-this.z)};Vector3d.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};Vector3d.prototype.unit=function(){var norm=this.length();if(norm==1)return this;if(norm==0)return this;var x=this.x/norm;var y=this.y/norm;var z=this.z/norm;return new Vector3d(x,y,z)};Vector3d.prototype.angleTo=function(v,n){if(!(v instanceof Vector3d))throw new TypeError("v is not Vector3d object");if(!(n instanceof Vector3d||n==undefined))throw new TypeError("n is not Vector3d object");var sign=n==undefined?1:Math.sign(this.cross(v).dot(n));var sinθ=this.cross(v).length()*sign;var cosθ=this.dot(v);return Math.atan2(sinθ,cosθ)};Vector3d.prototype.rotateAround=function(axis,theta){if(!(axis instanceof Vector3d))throw new TypeError("axis is not Vector3d object");var p1=this.unit();var p=[p1.x,p1.y,p1.z];var a=axis.unit();var s=Math.sin(theta);var c=Math.cos(theta);var q=[[a.x*a.x*(1-c)+c,a.x*a.y*(1-c)-a.z*s,a.x*a.z*(1-c)+a.y*s],[a.y*a.x*(1-c)+a.z*s,a.y*a.y*(1-c)+c,a.y*a.z*(1-c)-a.x*s],[a.z*a.x*(1-c)-a.y*s,a.z*a.y*(1-c)+a.x*s,a.z*a.z*(1-c)+c]];var qp=[0,0,0];for(var i=0;i<3;i++){for(var j=0;j<3;j++){qp[i]+=q[i][j]*p[j]}}var p2=new Vector3d(qp[0],qp[1],qp[2]);return p2};Vector3d.prototype.toString=function(precision){var p=precision===undefined?3:Number(precision);var str="["+this.x.toFixed(p)+","+this.y.toFixed(p)+","+this.z.toFixed(p)+"]";return str};if(Math.sign===undefined){Math.sign=function(x){x=+x;if(x===0||isNaN(x))return x;return x>0?1:-1}}if(typeof module!="undefined"&&module.exports)module.exports=Vector3d},{}],177:[function(require,module,exports){(function(global){var win;if(typeof window!=="undefined"){win=window}else if(typeof global!=="undefined"){win=global}else if(typeof self!=="undefined"){win=self}else{win={}}module.exports=win}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],178:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],179:[function(require,module,exports){"use strict";var keysShim;if(!Object.keys){var has=Object.prototype.hasOwnProperty;var toStr=Object.prototype.toString;var isArgs=require("./isArguments");var isEnumerable=Object.prototype.propertyIsEnumerable;var hasDontEnumBug=!isEnumerable.call({toString:null},"toString");var hasProtoEnumBug=isEnumerable.call(function(){},"prototype");var dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];var equalsConstructorPrototype=function(o){var ctor=o.constructor;return ctor&&ctor.prototype===o};var excludedKeys={$applicationCache:true,$console:true,$external:true,$frame:true,$frameElement:true,$frames:true,$innerHeight:true,$innerWidth:true,$onmozfullscreenchange:true,$onmozfullscreenerror:true,$outerHeight:true,$outerWidth:true,$pageXOffset:true,$pageYOffset:true,$parent:true,$scrollLeft:true,$scrollTop:true,$scrollX:true,$scrollY:true,$self:true,$webkitIndexedDB:true,$webkitStorageInfo:true,$window:true};var hasAutomationEqualityBug=function(){if(typeof window==="undefined"){return false}for(var k in window){try{if(!excludedKeys["$"+k]&&has.call(window,k)&&window[k]!==null&&typeof window[k]==="object"){try{equalsConstructorPrototype(window[k])}catch(e){return true}}}catch(e){return true}}return false}();var equalsConstructorPrototypeIfNotBuggy=function(o){if(typeof window==="undefined"||!hasAutomationEqualityBug){return equalsConstructorPrototype(o)}try{return equalsConstructorPrototype(o)}catch(e){return false}};keysShim=function keys(object){var isObject=object!==null&&typeof object==="object";var isFunction=toStr.call(object)==="[object Function]";var isArguments=isArgs(object);var isString=isObject&&toStr.call(object)==="[object String]";var theKeys=[];if(!isObject&&!isFunction&&!isArguments){throw new TypeError("Object.keys called on a non-object")}var skipProto=hasProtoEnumBug&&isFunction;if(isString&&object.length>0&&!has.call(object,0)){for(var i=0;i<object.length;++i){theKeys.push(String(i))}}if(isArguments&&object.length>0){for(var j=0;j<object.length;++j){theKeys.push(String(j))}}else{for(var name in object){if(!(skipProto&&name==="prototype")&&has.call(object,name)){theKeys.push(String(name))}}}if(hasDontEnumBug){var skipConstructor=equalsConstructorPrototypeIfNotBuggy(object);for(var k=0;k<dontEnums.length;++k){if(!(skipConstructor&&dontEnums[k]==="constructor")&&has.call(object,dontEnums[k])){theKeys.push(dontEnums[k])}}}return theKeys}}module.exports=keysShim},{"./isArguments":181}],180:[function(require,module,exports){"use strict";var slice=Array.prototype.slice;var isArgs=require("./isArguments");var origKeys=Object.keys;var keysShim=origKeys?function keys(o){return origKeys(o)}:require("./implementation");var originalKeys=Object.keys;keysShim.shim=function shimObjectKeys(){if(Object.keys){var keysWorksWithArguments=function(){var args=Object.keys(arguments);return args&&args.length===arguments.length}(1,2);if(!keysWorksWithArguments){Object.keys=function keys(object){if(isArgs(object)){return originalKeys(slice.call(object))}return originalKeys(object)}}}else{Object.keys=keysShim}return Object.keys||keysShim};module.exports=keysShim},{"./implementation":179,"./isArguments":181}],181:[function(require,module,exports){"use strict";var toStr=Object.prototype.toString;module.exports=function isArguments(value){var str=toStr.call(value);var isArgs=str==="[object Arguments]";if(!isArgs){isArgs=str!=="[object Array]"&&value!==null&&typeof value==="object"&&typeof value.length==="number"&&value.length>=0&&toStr.call(value.callee)==="[object Function]"}return isArgs}},{}],182:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],183:[function(require,module,exports){(function(global,setImmediate){"use strict";function finallyConstructor(callback){var constructor=this.constructor;return this.then(function(value){return constructor.resolve(callback()).then(function(){return value})},function(reason){return constructor.resolve(callback()).then(function(){return constructor.reject(reason)})})}var setTimeoutFunc=setTimeout;function noop(){}function bind(fn,thisArg){return function(){fn.apply(thisArg,arguments)}}function Promise(fn){if(!(this instanceof Promise))throw new TypeError("Promises must be constructed via new");if(typeof fn!=="function")throw new TypeError("not a function");this._state=0;this._handled=false;this._value=undefined;this._deferreds=[];doResolve(fn,this)}function handle(self,deferred){while(self._state===3){self=self._value}if(self._state===0){self._deferreds.push(deferred);return}self._handled=true;Promise._immediateFn(function(){var cb=self._state===1?deferred.onFulfilled:deferred.onRejected;if(cb===null){(self._state===1?resolve:reject)(deferred.promise,self._value);return}var ret;try{ret=cb(self._value)}catch(e){reject(deferred.promise,e);return}resolve(deferred.promise,ret)})}function resolve(self,newValue){try{if(newValue===self)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&(typeof newValue==="object"||typeof newValue==="function")){var then=newValue.then;if(newValue instanceof Promise){self._state=3;self._value=newValue;finale(self);return}else if(typeof then==="function"){doResolve(bind(then,newValue),self);return}}self._state=1;self._value=newValue;finale(self)}catch(e){reject(self,e)}}function reject(self,newValue){self._state=2;self._value=newValue;finale(self)}function finale(self){if(self._state===2&&self._deferreds.length===0){Promise._immediateFn(function(){if(!self._handled){Promise._unhandledRejectionFn(self._value)}})}for(var i=0,len=self._deferreds.length;i<len;i++){handle(self,self._deferreds[i])}self._deferreds=null}function Handler(onFulfilled,onRejected,promise){this.onFulfilled=typeof onFulfilled==="function"?onFulfilled:null;this.onRejected=typeof onRejected==="function"?onRejected:null;this.promise=promise}function doResolve(fn,self){var done=false;try{fn(function(value){if(done)return;done=true;resolve(self,value)},function(reason){if(done)return;done=true;reject(self,reason)})}catch(ex){if(done)return;done=true;reject(self,ex)}}Promise.prototype["catch"]=function(onRejected){return this.then(null,onRejected)};Promise.prototype.then=function(onFulfilled,onRejected){var prom=new this.constructor(noop);handle(this,new Handler(onFulfilled,onRejected,prom));return prom};Promise.prototype["finally"]=finallyConstructor;Promise.all=function(arr){return new Promise(function(resolve,reject){if(!arr||typeof arr.length==="undefined")throw new TypeError("Promise.all accepts an array");var args=Array.prototype.slice.call(arr);if(args.length===0)return resolve([]);var remaining=args.length;function res(i,val){try{if(val&&(typeof val==="object"||typeof val==="function")){var then=val.then;if(typeof then==="function"){then.call(val,function(val){res(i,val)},reject);return}}args[i]=val;if(--remaining===0){resolve(args)}}catch(ex){reject(ex)}}for(var i=0;i<args.length;i++){res(i,args[i])}})};Promise.resolve=function(value){if(value&&typeof value==="object"&&value.constructor===Promise){return value}return new Promise(function(resolve){resolve(value)})};Promise.reject=function(value){return new Promise(function(resolve,reject){reject(value)})};Promise.race=function(values){return new Promise(function(resolve,reject){for(var i=0,len=values.length;i<len;i++){values[i].then(resolve,reject)}})};Promise._immediateFn=typeof setImmediate==="function"&&function(fn){setImmediate(fn)}||function(fn){setTimeoutFunc(fn,0)};Promise._unhandledRejectionFn=function _unhandledRejectionFn(err){if(typeof console!=="undefined"&&console){console.warn("Possible Unhandled Promise Rejection:",err)}};var globalNS=function(){if(typeof self!=="undefined"){return self}if(typeof window!=="undefined"){return window}if(typeof global!=="undefined"){return global}throw new Error("unable to locate global object")}();if(!("Promise"in globalNS)){globalNS["Promise"]=Promise}else if(!globalNS.Promise.prototype["finally"]){globalNS.Promise.prototype["finally"]=finallyConstructor}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{},require("timers").setImmediate)},{timers:187}],184:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],185:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],186:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":184,"./encode":185}],187:[function(require,module,exports){(function(setImmediate,clearImmediate){var nextTick=require("process/browser.js").nextTick;var apply=Function.prototype.apply;var slice=Array.prototype.slice;var immediateIds={};var nextImmediateId=0;exports.setTimeout=function(){return new Timeout(apply.call(setTimeout,window,arguments),clearTimeout)};exports.setInterval=function(){return new Timeout(apply.call(setInterval,window,arguments),clearInterval)};exports.clearTimeout=exports.clearInterval=function(timeout){timeout.close()};function Timeout(id,clearFn){this._id=id;this._clearFn=clearFn}Timeout.prototype.unref=Timeout.prototype.ref=function(){};Timeout.prototype.close=function(){this._clearFn.call(window,this._id)};exports.enroll=function(item,msecs){clearTimeout(item._idleTimeoutId);item._idleTimeout=msecs};exports.unenroll=function(item){clearTimeout(item._idleTimeoutId);item._idleTimeout=-1};exports._unrefActive=exports.active=function(item){clearTimeout(item._idleTimeoutId);var msecs=item._idleTimeout;if(msecs>=0){item._idleTimeoutId=setTimeout(function onTimeout(){if(item._onTimeout)item._onTimeout()},msecs)}};exports.setImmediate=typeof setImmediate==="function"?setImmediate:function(fn){var id=nextImmediateId++;var args=arguments.length<2?false:slice.call(arguments,1);immediateIds[id]=true;nextTick(function onNextTick(){if(immediateIds[id]){if(args){fn.apply(null,args)}else{fn.call(null)}exports.clearImmediate(id)}});return id};exports.clearImmediate=typeof clearImmediate==="function"?clearImmediate:function(id){delete immediateIds[id]}}).call(this,require("timers").setImmediate,require("timers").clearImmediate)},{"process/browser.js":182,timers:187}],188:[function(require,module,exports){(function(global){var __extends;var __assign;var __rest;var __decorate;var __param;var __metadata;var __awaiter;var __generator;var __exportStar;var __values;var __read;var __spread;var __await;var __asyncGenerator;var __asyncDelegator;var __asyncValues;var __makeTemplateObject;var __importStar;var __importDefault;(function(factory){var root=typeof global==="object"?global:typeof self==="object"?self:typeof this==="object"?this:{};if(typeof define==="function"&&define.amd){define("tslib",["exports"],function(exports){factory(createExporter(root,createExporter(exports)))})}else if(typeof module==="object"&&typeof module.exports==="object"){factory(createExporter(root,createExporter(module.exports)))}else{factory(createExporter(root))}function createExporter(exports,previous){if(exports!==root){if(typeof Object.create==="function"){Object.defineProperty(exports,"__esModule",{value:true})}else{exports.__esModule=true}}return function(id,v){return exports[id]=previous?previous(id,v):v}}})(function(exporter){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};__extends=function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};__rest=function(s,e){var t={};for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0)t[p]=s[p];if(s!=null&&typeof Object.getOwnPropertySymbols==="function")for(var i=0,p=Object.getOwnPropertySymbols(s);i<p.length;i++)if(e.indexOf(p[i])<0)t[p[i]]=s[p[i]];return t};__decorate=function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};__param=function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};__metadata=function(metadataKey,metadataValue){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(metadataKey,metadataValue)};__awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};__generator=function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};__exportStar=function(m,exports){for(var p in m)if(!exports.hasOwnProperty(p))exports[p]=m[p]};__values=function(o){var m=typeof Symbol==="function"&&o[Symbol.iterator],i=0;if(m)return m.call(o);return{next:function(){if(o&&i>=o.length)o=void 0;return{value:o&&o[i++],done:!o}}}};__read=function(o,n){var m=typeof Symbol==="function"&&o[Symbol.iterator];if(!m)return o;var i=m.call(o),r,ar=[],e;try{while((n===void 0||n-- >0)&&!(r=i.next()).done)ar.push(r.value)}catch(error){e={error:error}}finally{try{if(r&&!r.done&&(m=i["return"]))m.call(i)}finally{if(e)throw e.error}}return ar};__spread=function(){for(var ar=[],i=0;i<arguments.length;i++)ar=ar.concat(__read(arguments[i]));return ar};__await=function(v){return this instanceof __await?(this.v=v,this):new __await(v)};__asyncGenerator=function(thisArg,_arguments,generator){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var g=generator.apply(thisArg,_arguments||[]),i,q=[];return i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i;function verb(n){if(g[n])i[n]=function(v){return new Promise(function(a,b){q.push([n,v,a,b])>1||resume(n,v)})}}function resume(n,v){try{step(g[n](v))}catch(e){settle(q[0][3],e)}}function step(r){r.value instanceof __await?Promise.resolve(r.value.v).then(fulfill,reject):settle(q[0][2],r)}function fulfill(value){resume("next",value)}function reject(value){resume("throw",value)}function settle(f,v){if(f(v),q.shift(),q.length)resume(q[0][0],q[0][1])}};__asyncDelegator=function(o){var i,p;return i={},verb("next"),verb("throw",function(e){throw e}),verb("return"),i[Symbol.iterator]=function(){return this},i;function verb(n,f){i[n]=o[n]?function(v){return(p=!p)?{value:__await(o[n](v)),done:n==="return"}:f?f(v):v}:f}};__asyncValues=function(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var m=o[Symbol.asyncIterator],i;return m?m.call(o):(o=typeof __values==="function"?__values(o):o[Symbol.iterator](),i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i);function verb(n){i[n]=o[n]&&function(v){return new Promise(function(resolve,reject){v=o[n](v),settle(resolve,reject,v.done,v.value)})}}function settle(resolve,reject,d,v){Promise.resolve(v).then(function(v){resolve({value:v,done:d})},reject)}};__makeTemplateObject=function(cooked,raw){if(Object.defineProperty){Object.defineProperty(cooked,"raw",{value:raw})}else{cooked.raw=raw}return cooked};__importStar=function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(Object.hasOwnProperty.call(mod,k))result[k]=mod[k];result["default"]=mod;return result};__importDefault=function(mod){return mod&&mod.__esModule?mod:{default:mod}};exporter("__extends",__extends);exporter("__assign",__assign);exporter("__rest",__rest);exporter("__decorate",__decorate);exporter("__param",__param);exporter("__metadata",__metadata);exporter("__awaiter",__awaiter);exporter("__generator",__generator);exporter("__exportStar",__exportStar);exporter("__values",__values);exporter("__read",__read);exporter("__spread",__spread);exporter("__await",__await);exporter("__asyncGenerator",__asyncGenerator);exporter("__asyncDelegator",__asyncDelegator);exporter("__asyncValues",__asyncValues);exporter("__makeTemplateObject",__makeTemplateObject);exporter("__importStar",__importStar);exporter("__importDefault",__importDefault)})}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}]},{},[3]);